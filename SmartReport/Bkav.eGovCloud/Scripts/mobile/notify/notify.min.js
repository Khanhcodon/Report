function openDocument(n,t){egov.mobile.$ddlNotification.hide();require(["tabView"],function(i){var r=new i({model:{id:n,name:"",title:"",href:"notifyDocument_"+n}});$(".documents-dataList #documentCopy_"+n).removeClass("documentUnread");egov.mobile.hideModal();egov.callback(t)})}function openMail(n){egov.mobile.$ddlNotification.hide();require(["bmailViewDetail"],function(t){var i=new t;i.openWithId(n)})}function showMobileNotify(n){var t=notifyOpen.isshowmail?appType.bmail:appType.documents;egov.mobile.changeApp(t,function(){egov.mobile.notification.showNotification(n)})}var regexUtcDate=/\d{4}-[0-1]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-6]\d$/;(function(n,t,i){"use strict";if(typeof n===undefined)throw"Chưa có thư viện jquery.";if(typeof i===undefined)throw"Chưa có thư viện backbone.";var u={documents:"documents",bmail:"bmail",chat:"chat",calendar:"calendar",contacts:"contacts"},f={eGov:"eGovNotifications",mail:"MailNotifications",chat:"ChatNotifications"},e={gets:"/Notification/GetsByType?type={0}&lastId={1}",setViewed:"/Notification/SetViewed?type=",hideNotify:"/Notification/HideNotify/",addNotify:"/Notification/AddNotify"};egov.notifyType={eGov:1,mail:2,chat:3,calendar:4};var r=egov.notifyType,s=i.Model.extend({defaults:{NotificationId:0,NotificationType:0,Title:"",Content:"",SenderAvatar:"",SenderUserName:"",SenderFullName:"",Date:"",DateFormat:"",ReceiveDate:"",ViewdDate:"",IsViewed:!1,DocumentCopyId:0,MailId:0,folderId:0,ChatId:"",chatterJid:"",messageId:""}}),h=i.Collection.extend({model:s}),c=i.View.extend({el:"#btnNotification",$notifyEl:n("#ddlNotification"),currentNotify:null,$icon:null,$btnClear:null,notifyNumber:0,total:0,events:{click:"openNotification"},initialize:function(){var n=this;this.$icon=this.$(".material-icons");this.$btnClear=egov.mobile.$btnClearNotify;egov.mobile.activeApps.indexOf("documents")>=0&&(this.eGovNotify=new o({type:r.eGov,notifyUrl:e,oneOnly:!1,hasAlert:!0,useCache:!0,cacheName:f.eGov,parent:n}));egov.mobile.activeApps.indexOf("mail")>=0&&bmail.makeRequest.preAuthen(function(){bmail.makeRequest.noOption(function(){});n.MailNotify=new o({type:r.mail,notifyUrl:e,oneOnly:!1,hasAlert:!0,useCache:!0,cacheName:f.mail,parent:n})});egov.mobile.activeApps.indexOf("chat")>=0&&(this.ChatNotify=new o({type:r.chat,notifyUrl:e,oneOnly:!0,hasAlert:!0,useCache:!0,cacheName:f.mail,parent:n}));egov.mobile.notification=this},callBack:function(){this.updateNotifyInMenu()},changeCurrentNotify:function(){switch(egov.mobile.currentApp){case u.documents:this.currentNotify=this.eGovNotify;break;case u.bmail:this.currentNotify=this.MailNotify}},changeApp:function(){this.changeCurrentNotify();this.$notifyEl.hide();this.showingNotification=!1;this.$el.removeClass("active");this.updateBell()},updateBell:function(){var n=this.currentNotify;n&&(n.model&&(this.total=n.model.length),this.notifyNumber=n.unreads);this._updateBell()},updateNotifyInMenu:function(){this.eGovNotify&&n(".menulayout #documents").attr("data-badge",this.getUnreadLabel(this.eGovNotify.unreads));this.MailNotify&&n(".menulayout #mail").attr("data-badge",this.getUnreadLabel(this.MailNotify.unreads))},_updateBell:function(){this.total>0?this.$icon.text("notifications"):this.$icon.text("notifications_none");this.$el.attr("data-badge",this.getUnreadLabel(this.notifyNumber))},getUnreadLabel:function(n){return n>99?n="99+":n<0&&(n=0),n},clearNotifies:function(){this.currentNotify.closeAll()},openNotification:function(n){egov.helper.destroyClickEvent(n);this.currentNotify&&this.currentNotify.getNotificationsFromServer();n&&this.$el.toggleClass("active");this.$el.hasClass("active")?this.showNotification(n):this.hideNotification(n);this.checkData()},showNotification:function(n){this.isFocusing=!0;this.$el.addClass("active");egov.mobile.isTablet?egov.mobile.showModal():egov.mobile.$dataList.hide();this.$notifyEl.show();this.total>0?this.$btnClear.show():this.$btnClear.hide();egov.mobile.$mainPage.addClass("showNotify");this.showingNotification=!0;egov.mobile.iseGovApp&&eGovApp.clearAllNotifications();this.checkData();egov.callback(n)},hideNotification:function(n){n&&(this.$el.removeClass("active"),this.isFocusing=!1,egov.mobile.isTablet?egov.mobile.hideModal():egov.mobile.$dataList.show(),this.$btnClear.hide(),this.$notifyEl.hide(),egov.mobile.$mainPage.removeClass("showNotify"),this.showingNotification=!1)},checkData:function(){this.currentNotify.open()}}),o=i.View.extend({el:"#ddlNotification",hasAlert:!1,hasAlertNotify:!1,useCache:!0,cacheName:"",oneOnly:!1,notificationManager:undefined,currentNotify:undefined,listAlertNotify:[],unreads:0,lastId:0,template:"",notifyUrl:{gets:"",setViewed:"",hideNotify:"",addNotify:""},events:{},initialize:function(n){var t=this;return this.parent=n.parent,this.type=n.type||r.eGov,this.notifyUrl=n.notifyUrl,this.hasAlert=n.hasAlert||this.hasAlert,this.useCache=n.useCache||this.useCache,this.cacheName=n.cacheName||"notify_"+this.type,this.oneOnly=n.oneOnly||this.oneOnly,require([egov.template.mobile.notifyItem],function(n){t.template=n;t.init()}),this.initNotificationManager(),this._bindEvent(),this},init:function(){var n=this.getFromCache();this.model=new h(n);this._eventProps();this.render(!1);this.getNotificationsFromServer()},getFromCache:function(){var n=[],t;if(this.useCache&&window.localStorage&&(t=localStorage.getItem(this.cacheName),t))try{n=JSON.parse(hashBase64.decode(t));n&&(n=n.filter(function(n){return n.UserId==egov.userId}));n.length>0&&(this.lastId=n[n.length-1].NotificationId)}catch(i){}return n},getNotificationsFromServer:function(){var i=this,t=[];return},saveLocache:function(){if(this.useCache&&window.localStorage){localStorage.removeItem(this.cacheName);this.model.models=this.model.models.sort(function(n,t){return n.get("NotificationId")>t.get("NotificationId")});var n=hashBase64.encode(JSON.stringify(this.model.models));localStorage.setItem(this.cacheName,n)}this.parent.updateBell();this.checkEmptyData()},open:function(){this.setViewAll();this.refreshNotifyTime();this.checkEmptyData();this.parent.updateBell();this._hideAlertNotifies()},_bindEvent:function(){var t=this;n(window).bind("beforeunload",function(){t._hideAlertNotifies()})},_hideAlertNotifies:function(){this.listAlertNotify&&t.each(this.listAlertNotify,function(n){n.close()});this.currentNotify&&this.currentNotify.close()},_eventProps:function(){var n=this;this.model.on("add",function(t){n.bindItem(t,!0)});this.model.on("remove",function(t){t.get("IsViewed")||n.unreads--;n.saveLocache();n.hideNotify(t.get("NotificationId"))})},render:function(t){var i=this;this.model.length>0&&n.each(this.model.models,function(){i.bindItem(this,t)})},bindItem:function(n,t){var u=this,i,r=new l({model:n,id:"notify_"+n.get("NotificationId"),type:this.type,parent:this});i=!n.get("IsViewed");i&&this.unreads++;this.$el.prepend(r.$el);t&&i&&(this.parent.$el.buzz(),this.alertNotify(r.model,function(){u.openNotifyById(r.model.get("NotificationId"))}))},renderEmptyItems:function(){this.$(".no-notify").show()},addToModel:function(n){var t=this.model.find(function(t){return t.get("NotificationId")==n.NotificationId});t||(this.model.add(n),this.saveLocache())},initNotificationManager:function(){var n=this,t;this.hasAlert&&(this.notificationManager=window.Notification||window.mozNotification||window.webkitNotification,this.notificationManager&&(t=localStorage.getItem("hasRequestedNotify"),t?n.hasAlertNotify=t:this.notificationManager.permission!=="granted"?this.notificationManager.requestPermission(function(t){localStorage.setItem("hasRequestedNotify",t);n.hasAlertNotify=n.notificationManager.permission!==t}):n.hasAlertNotify=!0))},setViewAll:function(){var r=this,i,t;if(this.unreads>0){for(n.ajax({url:r.notifyUrl.setViewed+r.type,type:"POST",dataType:"JSON"}),i=this.model.models.filter(function(n){return n.get("IsViewed")==!1}),t=0;t<i.length;t++)i[t].set("IsViewed",!0);this.saveLocache()}else this.$(".unview-notify").removeClass("unview-notify");this.unreads=0},refreshNotifyTime:function(){n.each(this.model.models,function(){this.set("DateFormat",new Date)})},checkEmptyData:function(){this.model.length>0?this.$(".no-notify").hide():this.renderEmptyItems()},hideNotify:function(t){n.ajax({url:this.notifyUrl.hideNotify+t,type:"POST",dataType:"JSON"})},alertNotify:function(n,t){var u,i,r;this.hasAlertNotify&&n!==undefined&&(u=this,i=null,this.oneOnly&&(i=this.currentNotify,i&&i.close()),r="",i=new this.notificationManager(this._getTitleAlert(),{body:n.get("SenderFullName")+"\r\n"+n.get("Title")+"\r\n"+r,icon:n.get("SenderAvatar")}),typeof t=="function"&&(i.onclick=function(){i.close();t()}),this.oneOnly?this.currentNotify=i:this.listAlertNotify.push(i))},_getMessageNotifyEmpty:function(){var n=null;switch(this.type){case r.eGov:n=egov.resources.notify.nodocumentnotify;break;case r.mail:n=egov.resources.notify.nomailnotify;break;case r.chat:n=egov.resources.notify.nochatnotify}return n},_getStringOpenAll:function(){var n=null;switch(this.type){case r.eGov:n=egov.resources.openAllDocument;break;case r.mail:n=egov.resources.openAllMail;break;case r.chat:n=egov.resources.openAllChat}return n},_getTitleAlert:function(){var n=null;switch(this.type){case r.eGov:n=egov.resources.main.haveNewDocument;break;case r.mail:n=egov.resources.main.haveNewMail;break;case r.chat:n=egov.resources.main.haveNewChat}return n},_getPropKey:function(){var n=null;switch(this.type){case r.eGov:n="DocumentCopyId";break;case r.mail:n="MailId";break;case r.chat:n="ChatId"}return n},openNotifyById:function(n){var i=this.model.select(function(t){return t.get("NotificationId")==n});if(i&&i.length>0){var u=this._getPropKey(),r=i[0],t=r.get(u);r.view.open();this.arrAlertNotify&&t&&this.arrAlertNotify[t]&&(this.arrAlertNotify[t].close(),delete this.arrAlertNotify[t])}},removeModelById:function(n){var t=this.model.select(function(t){return t.get("DocumentCopyId")==n});t&&t.length>0&&(t=t[0],t.view._removeView())},setAlert:function(n){this.hasAlertNotify=n},openAll:function(){!this.model||this.model.length<=0||(this.model.at(0).view.open(this.model.length===1),this.openAll())},closeAll:function(){!this.model||this.model.length<=0||(this.model.at(0).view.remove(!0),this.closeAll())}}),l=i.View.extend({className:"list-group-item two-line",type:0,events:{click:"open"},initialize:function(n){this.parent=n.parent;this.type=n.type;var t=this.model.get("SenderUserName").split("@")[0],i=this.model.get("SenderAvatar");return i||(i=String.format(egov.resources.avatar.path,t),this.model.set("SenderAvatar",i)),this.model.set("alphabet",t[0]),this.model.set("alphabetCode",getColorCode(t[0])),this.render(),this._eventProps(),this.model.set("DateFormat",new Date),this.model.view=this,this},render:function(){this.setType();this.model.get("IsViewed")||this.$el.addClass("unview-notify");this.$el.html(this._parseHtml(this.model))},setType:function(){var n="";switch(this.type){case r.eGov:n=u.documents;break;case r.mail:n=u.bmail;break;case r.chat:n=u.chat}this.$el.attr("data-app",n)},_eventProps:function(){var n=this;this.model.on("change:DateFormat",function(){n.$(".notify-date").text(egov.commonFn.util.getCommonTime(n.model.get("ReceiveDate")))})},open:function(){window.focus();var n=this.type;this.remove();egov.mobile.$ddlNotification.hide();switch(n){case r.eGov:this._openDocument(!0);break;case r.mail:this._openMail();break;case r.chat:this._openChat();break;case r.calendar:break;default:console.log("Notification type not exist!.")}},touchstart:function(n){this.startX=getPositionEventTouch(n).clientX},touch:function(n){var t=this,i=getPositionEventTouch(n).clientX-this.startX;Math.abs(i)>this.listWidth/3&&!this.removing&&(this.removing=!0,this.$el.fadeOut(300),window.setTimeout(function(){t.remove()},200))},close:function(n){egov.helper.destroyEvent(n);this.remove()},_parseHtml:function(t){return t?(t instanceof s&&(t=t.toJSON()),n.tmpl(this.parent.template,t)):null},_openDocument:function(){openDocument(this.model.get("DocumentCopyId"))},_openMail:function(){openMail(this.model.get("MailId"))},_openChat:function(){var n=this},_removeView:function(){this.$el.remove();this.parent.model.remove(this.model)},_closeAlertNotify:function(){if(this.parent&&this.parent.arrAlertNotify){var n=this.parent,t=n._getPropKey();n.arrAlertNotify[this.model.get(t)]&&(n.arrAlertNotify[this.model.get(t)].close(),delete n.arrAlertNotify[this.model.get(t)])}},remove:function(){this._removeView();this._closeAlertNotify()}});return n.fn.buzz=function(t,i){var r=n(this),u;r.find(".material-icons").text("notifications_active");r.addClass("buzz");egov.mobile.notification.isPlayAudio&&(u=new Audio("/Content/Sound/notification_alert.mp3"),u.play());window.setTimeout(function(){r.find(".material-icons").text("notifications");r.removeClass("buzz")},t||820,egov.callback(i))},new c})(window.jQuery,window._,window.Backbone,window.notify);