function showDocumentNotify(){egov.mobile.changeApp(appType.documents,function(){egov.mobile.notification.show()})}function showMailNotify(){egov.mobile.changeApp(appType.bmail,function(){egov.mobile.notification.show()})}define(["bmailmakeRequest","bmailResponse",],function(){"use strict";function s(n,t){$.post("/Mobile/RemoveNotify",{docCopyId:n},function(n){egov.callback(t(n))})}function h(n,i){bmail.locache.removeNotify(t.mail,n);egov.callback(i())}function c(n,t){$.ajax({type:"POST",url:"/Mobile/RemoveAllNotify",traditional:!0,data:{docCopyIds:n},success:function(n){egov.callback(t(n))}})}function u(n,t){$.ajax({type:"POST",url:"/Mobile/SetNotified",traditional:!0,data:{docCopyIds:n},success:function(n){egov.callback(t(n))}})}function f(n){var t=n.split(/[^0-9]/),i="";return i=egov.mobile.isIOS?t[4]+"/"+t[3]+"/"+t[5]+" "+t[0]+":"+t[1]+":"+t[2]:t[0]+":"+t[1]+":"+t[2]+" "+t[4]+"/"+t[3]+"/"+t[5],egov.commonFn.util.getCommonTime(new Date(i))}function n(n){return n.originalEvent.changedTouches[0]}function e(n){var t={a:"unknown",d:"unknown",p:"unknown"};return n.e&&(t=n.e.filter(function(n){return n.t=="f"})[0]),t}var t={eGov:"eGovNotify",mail:"MailNotify",chat:"ChatNotify",calendar:"CalendarNotify"},o=Backbone.View.extend({el:"#btnNotification",mdlMenuClass:"mdl-menu mdl-menu--bottom-right mdl-js-menu",$notifyEl:$("#ddlNotification"),$notifyId:"notify_",$btnClear:null,unViewClass:"unview-notify",unReadLabel:egov.mobile.getTotalUnreadLabel,isPlayAudio:!0,isOpen:!1,notificationBrowser:null,currentNotify:null,listNotify:[],total:0,template:"",mailNotifies:[],isFocusing:!1,events:{click:"show"},initialize:function(){egov.mobile.notification=this;this.$btnClear=egov.mobile.$btnClearNotify;this.documentModels=new egov.models.notificationList;this.bmailModels=new egov.models.notificationList;this.bmailList=new egov.models.layoutNotify;this.documentsList=new egov.models.layoutNotify;this.check();egov.mobile.isTablet&&(this.$notifyEl.addClass(this.mdlMenuClass),this.$notifyEl.materialMenu());this.initNotificationManager();this._eventOfProp()},initNotificationManager:function(){if(!egov.mobile.iseGovApp){var n=this;this.notificationBrowser=window.Notification||window.mozNotification||window.webkitNotification;this.notificationBrowser&&this.notificationBrowser.permission!=="granted"&&this.notificationBrowser.requestPermission(function(t){n.notificationBrowser.permission!==t&&(n.notificationBrowser.permission=t)})}},notifyOuter:function(n,t,i,r,u,f,e){var c=this,h=String.format(egov.resources.avatar.path,t),o,s;if(egov.mobile.iseGovApp)eGovApp.showNotify(n,r,u,h,f);else{o=null;s=!1;switch(parseInt(egov.mobile.notifyType)){case 1:o=this.currentNotify;o&&o.close();s=!0;break;case 2:break;default:return}o=new this.notificationBrowser(r,{body:u+"\r\n"+t+" - "+i,icon:h});typeof e=="function"&&(o.onclick=function(){o.close();egov.callback(e)});s?this.currentNotify=o:this.listNotify.push(o)}},check:function(){this.checkMail();this.checkDocuments()},getFullNotifications:function(n,t){var i=this;require([egov.template.mobile.notifyItem],function(r){i.template=r;switch(n){case appType.bmail:i.getBmailNotification(t);return;case appType.documents:i.getDocumentNotification(t);return;case appType.chat:return;case appType.calendar:return;case appType.contacts:return;default:return}})},_eventOfProp:function(){var n=this},refreshTime:function(){var n=this;egov.mobile.currentApp==appType.documents&&_.each(n.documentModels.models,function(n){n.set("dateFormated",f(n.get("date")))});egov.mobile.currentApp==appType.bmail&&_.each(n.bmailModels.models,function(n){n.set("dateFormated",egov.commonFn.util.getCommonTime(n.get("date")))})},show:function(n){egov.helper.destroyClickEvent(n);n?this.$el.toggleClass("active"):this.$el.addClass("active");this.$el.hasClass("active")?this.showNotification(n):this.hideNotification(n);this.updateBell()},showNotification:function(){this.isFocusing=!0;egov.mobile.isTablet?egov.mobile.showModal():egov.mobile.$dataList.hide();this.$notifyEl.show();this.total>0?this.$btnClear.show():this.$btnClear.hide();egov.mobile.currentApp==appType.documents&&this.setDocumentNotified();egov.mobile.currentApp==appType.bmail&&this.setBmailNotified();egov.mobile.$mainPage.addClass("showNotify");this.showingNotification=!0},hideNotification:function(n){n&&(this.isFocusing=!1,egov.mobile.isTablet?egov.mobile.hideModal():egov.mobile.$dataList.show(),this.$btnClear.hide(),this[egov.mobile.currentApp+"List"].set("unreadTotal",0),this.updateBell(),this.$notifyEl.find("."+this.unViewClass).removeClass(this.unViewClass),this.$notifyEl.hide(),egov.mobile.$mainPage.removeClass("showNotify"),this.showingNotification=!1)},clear:function(){},clearNotifies:function(){var n=[],t=this.$notifyEl.children(".list-group-item");egov.mobile.currentApp==appType.documents?(t.filter(function(){n.push(parseInt($(this).attr("doccopyid")))}),n.length>0&&c(n,function(n){n!=!0&&console.log(n)}),this.documentModels.reset(),this.documentsList=new egov.models.layoutNotify):egov.mobile.currentApp==appType.bmail&&(this.mailNotifies=[],this.bmailModels.reset(),this.bmailList=new egov.models.layoutNotify);t.remove();this.show()},updateNumber:function(n,t,i){n||(n=egov.mobile.currentApp);var u=0,r=this[n+"List"];r&&(u=parseInt(r.get("unreadTotal")),i&&(u+=t),this.total=r.get("total")+t,r.set("total",this.total),r.set("unreadTotal",u));this.updateBell(n,u,!0)},updateBell:function(n,t,i){var r,u;i||(t=0,n||(n=egov.mobile.currentApp),r=this[n+"List"],r&&(t=r.get("unreadTotal"),this.total=r.get("total")));t<0&&(t=0);this.$el.attr("data-badge",t);u=this.$notifyEl.children(".no-notify");this.total>0?(this.$(".material-icons").text("notifications"),u.hide()):(this.$(".material-icons").text("notifications_none"),u.show())},checkDocuments:function(){var n=this;egov.request.notificationsCount({success:function(t){n.documentsList.set({total:t,unreadTotal:t,enable:!1,model:[]});n.docNotify(t)},error:function(n){new Error(n)}})},docNotify:function(n){$(".menulayout #documents").attr("data-badge",this.unReadLabel(n))},getDocumentNotification:function(n){var t=this;$.get("/Notification/GetsByType?type=1&lastId=1",function(r){var f,u,e,o;if(r){if(t.documentsList.set("total",r.length),f=t.$notifyId+"documents_",r.length>0)for(u=0;u<r.length;u++)t.$notifyEl.find("#"+f+r[u].id).length==0&&(e=new egov.models.notification(r[u]),o=new i({parent:t,model:e,template:t.template,id:f+r[u].id}),o.$el.attr("data-app","documents"),t.$notifyEl.append(o.$el),t.documentModels.push(e));egov.callback(n)}})},notifyDocument:function(n){var t=this,e,f,r,o;this.refreshTime();this.updateNumber("documents",1,!0);this.$el.buzz();e=t.$notifyId+"documents_";n.isNew=!0;f=new egov.models.notification(n);r=new i({parent:t,model:f,template:t.template,id:e+n.id});r.$el.addClass(t.unViewClass);r.$el.attr("data-app","documents");t.$notifyEl.prepend(r.$el);egov.mobile.showingDetail||egov.mobile.currentApp!=appType.documents||egov.views.home.tree.reloadSelectedNode();t.documentModels.push(f);this.notifyOuter(1,n.userName,n.date,n.title,n.content,this.documentsList.get("unreadTotal"),function(){egov.mobile.changeApp("documents",function(){r.select();removeDataBadge(egov.mobile.$('.menu-items[data-ng-app="documents"]'))})});this.isFocusing&&u([n.docCopyId],function(n){n!=!0&&console.log(n)});egov.mobile.currentApp!=appType.documents&&(o=parseInt($(".menulayout #documents").attr("data-badge")),this.docNotify(++o))},setDocumentNotified:function(){var n=[];this.$notifyEl.children("."+this.unViewClass).filter(function(){n.push(parseInt($(this).attr("doccopyid")))});n.length>0&&u(n,function(n){n!=!0&&console.log(n)});egov.mobile.iseGovApp&&eGovApp.clearAllNotifications()},openDocumentNotify:function(n){$.get("/Mobile/GetNotify",{notifyId:n},function(n){n?require(["tabView"],function(t){var i=n.docCopyId,r=n.title,u=new t({model:{id:i,name:r,title:r,href:"notifyDocument_"+i}});$(".documents-dataList #documentCopy_"+i).removeClass("documentUnread")}):egov.pubsub.publish(egov.events.status.warning,egov.resources.mobile.notify.documentNotFound)})},checkMail:function(){var n=this;this.mailNotifies=bmail.locache.readAllNotify(t.mail);bmail.makeRequest.preAuthen(function(){bmail.makeRequest.noOption(function(){});var t=n.mailNotifies.filter(function(n){return n.isNew==!0});n.bmailList.set({total:n.mailNotifies.length,unreadTotal:t.length,enable:!1});n.mailNotify(t.length)})},mailNotify:function(n){$(".menulayout #mail").attr("data-badge",this.unReadLabel(n))},getBmailNotification:function(n){var t=this;this.mailHasRedered||(_.each(this.mailNotifies,function(n){var f=t.$notifyId+"mail_",u=t.toModel(n),i=new r({parent:t,model:u,template:t.template,id:f+n.id,mail:n});n.isNew&&i.$el.addClass(t.unViewClass);i.$el.attr("data-app","bmail");t.$notifyEl.prepend(i.$el);t.bmailModels.push(u)}),this.mailHasRedered=!0);egov.callback(n)},notifyMail:function(n){var i=this,u=0;this.refreshTime();_.each(n,function(n){var f,o,e,s;n.isNew=!0;f=i.toModel(n);f.get("title").indexOf("[Spam]")==-1&&bmail.folderUtil.isSendToMyFolder(n.l)&&f.get("userName").toLowerCase()!=username.toLowerCase()&&(i.$el.buzz(),o=i.$notifyId+"mail_",n.d=new Date,bmail.locache.addNotify(t.mail,n),i.mailNotifies.push(n),i.mailHasRedered&&(e=new r({parent:i,model:f,template:i.template,id:o+n.id,mail:n}),e.$el.addClass(i.unViewClass),e.$el.attr("data-app","bmail"),i.$notifyEl.prepend(e.$el)),egov.mobile.currentApp!=appType.bmail&&(s=parseInt($(".menulayout #mail").attr("data-badge")),i.mailNotify(++s)),i.bmailModels.push(f),i.notifyOuter(2,f.get("userName"),f.get("dateString"),f.get("title"),f.get("content"),i.bmailList.get("unreadTotal"),function(){egov.mobile.changeApp("bmail",function(){e?e.select():i.show();removeDataBadge(egov.mobile.$('.menu-items[data-ng-app="bmail"]'))})}),u++)});this.updateNumber("bmail",u,!0);this.isFocusing&&i.setBmailNotified();bmail.current&&bmail.current.maillist&&!egov.mobile.showingDetail&&egov.mobile.currentApp==appType.bmail&&bmail.current.maillist.refresh()},setBmailNotified:function(){_.each(this.mailNotifies,function(n){n.isNew=!1});bmail.locache.updateNotifies(t.mail,this.mailNotifies)},toModel:function(n){var i=e(n),t=i.a;return t.indexOf("@")>0&&(t=i.a.substr(0,i.a.indexOf("@"))),new egov.models.notification({title:Util.getSubject(n.su),content:n.fr,date:n.d,dateString:new Date(n.d).format("HH:mm dd/MM/yyyy"),id:n.id,docCopyId:0,avatar:t,userName:t,fullName:t,type:0,isViewed:!1,isNew:n.isNew,hasAttach:n.f==undefined?!1:n.f.indexOf("a")!=-1})}}),i=Backbone.View.extend({startX:0,listWidth:0,className:"list-group-item two-line",isNew:!1,docCopyId:0,events:{click:"select",touchstart:"touchstart",touchmove:"touch"},initialize:function(n){this.parent=n.parent;this.template=n.template;this.isNew=this.model.get("isNew");this.docCopyId=this.model.get("docCopyId");this.username=this.model.get("userName");this.listWidth=egov.mobile.$ddlNotification.width();this.initData();this._eventOfProp();this.render()},initData:function(){this.model.set("avatar",egov.mobile.showUserAvatar?String.format(egov.setting.avatarPath,this.model.get("avatar")):getUserAvatar(this.model.get("userName")));this.model.set("dateFormated",f(this.model.get("date")));this.model.set("alphabet",this.username[0]);this.model.set("alphabetCode",getColorCode(this.username[0]))},_eventOfProp:function(){var n=this;this.model.on("change:dateFormated",function(t,i){n.$(".lblNotifyTime").text(i)})},render:function(){this.isNew&&this.$el.addClass(this.parent.unViewClass);this.$el.attr("doccopyid",this.docCopyId);this.$el.append($.tmpl(this.template,this.model.toJSON()))},select:function(){var n=this;egov.mobile.$ddlNotification.hide();require(["tabView"],function(t){var i=n.docCopyId,r=n.model.title,u=new t({model:{id:i,name:r,title:r,href:"notifyDocument_"+i}});$(".documents-dataList #documentCopy_"+i).removeClass("documentUnread");n.remove();egov.mobile.hideModal()})},touchstart:function(t){this.startX=n(t).clientX},touch:function(t){var i=this,r=n(t).clientX-this.startX;Math.abs(r)>this.listWidth/3&&!this.removing&&(this.removing=!0,this.$el.fadeOut(300),window.setTimeout(function(){i.remove()},200))},touchend:function(t){var r=this,i=n(t).clientX-this.startX;this.$el.css({left:i});Math.abs(i)<=this.listWidth/3&&this.$el.animate({left:0},300)},removeleft:function(){this.remove()},removeright:function(){this.remove()},remove:function(){var n=this;n.parent.updateNumber("documents",-1,this.isNew);s(this.docCopyId,function(t){t&&n.$el.remove()})}}),r=Backbone.View.extend({startX:0,listWidth:0,className:"list-group-item two-line",isNew:!1,mailId:0,username:"",events:{click:"select",touchstart:"touchstart",touchmove:"touch"},initialize:function(n){this.parent=n.parent;this.template=n.template;this.mail=n.mail;this.mailId=this.mail.id;this.isNew=this.model.get("isNew");this.username=this.model.get("userName");this.listWidth=egov.mobile.$ddlNotification.width();this.initData();this._eventOfProp();this.render()},initData:function(){this.model.set("avatar",egov.mobile.showUserAvatar?String.format(egov.setting.avatarPath,this.model.get("avatar")):getUserAvatar());this.model.set("alphabet",this.username[0]);this.model.set("alphabetCode",getColorCode(this.username[0]));this.model.set("dateFormated",egov.commonFn.util.getCommonTime(this.model.get("date")))},_eventOfProp:function(){var n=this;this.model.on("change:dateFormated",function(t,i){n.$(".lblNotifyTime").text(i)})},render:function(){this.isNew&&this.$el.addClass(this.parent.unViewClass);this.$el.attr("doccopyid",this.docCopyId);this.$el.append($.tmpl(this.template,this.model.toJSON()))},select:function(){var t=this,n;egov.mobile.$ddlNotification.hide();n=this.mail;require(["bmailViewDetail"],function(i){var u=n.id.replace(/:/gi,""),r=e(n),f;t.bmailModel=new bmail.models.mail({d:n.d,date:egov.commonFn.util.getCustomTime(n.d),detailDate:new Date(n.d).format("HH:mm dd/MM/yyyy"),location:n.l,conversationId:n.cid,id:n.id,trimId:u,domId:"maillist_"+u,mailDetailId:"mailDetail_"+u,sender:{fulladdress:r.a,address:r.a?r.a.substr(0,r.a.indexOf("@")):"",name:r.d?r.d:"",fullname:r.p},subject:Util.getSubject(n.su)});f=new i({model:t.bmailModel,id:t.model.get("mailDetailId")});$("#mail-detail").children().hide();$("#mail-detail").append(f.$el);egov.mobile.showDetailPage();t.markAsRead();egov.mobile.hideModal()})},touchstart:function(t){this.startX=n(t).clientX},touch:function(t){var i=this,r=n(t).clientX-this.startX;Math.abs(r)>this.listWidth/3&&!this.removing&&(this.removing=!0,this.$el.fadeOut(300),window.setTimeout(function(){i.remove()},200))},remove:function(){var n=this;n.parent.updateNumber("bmail",-1,this.isNew);h(this.mailId,function(){n.$el.remove()})},markAsRead:function(){var n=this;bmail.makeRequest.msgAction("read",this.mailId,function(){if(bmail.current&&bmail.current.folder){var n=bmail.current.folder.model.get("totalUnread");n>0&&bmail.current.folder.model.set("totalUnread",n-1)}});$(".bmail-dataList #mail-list-"+n.mailId).removeClass("unread");this.remove()}});return $.fn.buzz=function(n,t){var i=$(this),r;i.find(".material-icons").text("notifications_active");i.addClass("buzz");egov.mobile.notification.isPlayAudio&&(r=new Audio("/Content/Sound/notification_alert.mp3"),r.play());window.setTimeout(function(){i.find(".material-icons").text("notifications");i.removeClass("buzz")},n||820,egov.callback(t))},new o});