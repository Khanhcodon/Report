define(["bmailEvent","bmailUtil","bmailMsgUtil","bmailDetail"],function(){"use strict";return Backbone.View.extend({mailInfo:{},isShowInPopup:egov.showPageInPopup,isReply:!1,isCreate:!0,to:"",subject:"",content:"",idnt:null,caret:[],$content:null,el:"#mail-compose",className:"mail-detail createmail autoscroll trans trans-right",dataChanged:!1,hasRender:!1,events:{"touchend #btnCloseCompose":"_closeCompose","click #sendMail":"sendMail","click #saveDraft":"saveDraft","click #Content":"focusContent","focus #Content":"focusContent","keyup #Content":"focusContent","touchend .viewOldMail":"_showOldMail"},initialize:function(n){var t=this;n&&(this.mail=n.mail);this.render(n)},render:function(n){var t=this;this.idMailDraft=n.idMailDraft?n.idMailDraft:null;this.idnt=null;this.irt=null;this.midPart=[];n||(n={to:"",subject:"",oldContentMail:""});n.serverUpload=egov.connections.BmailLink+"/service/upload";this.isReply=n.isReply==!0;this.isEdit=n.isEdit==!0;this.isForward=n.isForward==!0;(this.isReply||this.isEdit||this.isForward)&&(this.$el.parent().children().hide(),this.isCreate=!1);this.mail=n.mail;require([egov.template.bmail.createOrReply],function(i){t.$el.html($.tmpl(i,n));t.$el.show();t.addEventForPage();t.bindDataContent(n.oldContentMail,n.sendInfo);t.$content=t.$("#Content");t.$content.css("min-height",t.$content[0].scrollHeight);t.$content.focus()})},sendMail:function(){var t=this,n,i;this.validForm()&&(n=null,egov.mobile.showProcessBar(),i=this.createMailData(this.to),$("#mailAttachDetail").children().length>0&&(n=[],_.each($("#mailAttachDetail").children(),function(t){n.push($(t).attr("midpart"))})),bmail.makeRequest.sendMail(i,this.idMailDraft,n,function(n){n==0?(t.idMailDraft&&bmail.makeRequest.msgAction("delete",t.idMailDraft,function(){}),egov.mobile.showStatus("Gửi mail thành công."),bmail.views.maillist.folderRefresh()):(egov.mobile.hideProcessBar(),egov.mobile.showStatus("Gửi mail lỗi."))}))},saveDraft:function(n,t,i){var r=this,o=bmail.userCookie,v=bmail.authenCookie,u,f,a,s;if(this.hasChange()||t){var h=i!=undefined,c="",e="",l="";l="<e t='f' a='"+o+"' p='"+o+"' /><e t='t' a='"+this.to+"'/>";c=Util.getSubject(this.subject);e=this.content.replace(/</gi,"&lt;");e=e.replace(/>/gi,"&gt;");e.indexOf("&nbsp")!=-1&&(e=e.replace(/&nbsp;/gi,"&#160;"));e="<mp ct='text/html'><content>"+e+"<\/content><\/mp>";u=Util.saveDraft(o,v,l,c,e,i,r.idMailDraft,r.idnt,r.irt,r.midPart,h);u.Body.SaveDraftResponse&&u.Body.SaveDraftResponse.m&&u.Body.SaveDraftResponse.m[0]?h?(r=this,u.Body.SaveDraftResponse.m[0].mp&&u.Body.SaveDraftResponse.m[0].mp[0].mp?(f=u.Body.SaveDraftResponse.m[0],a=f.id,r.idMailDraft=a,f.idnt&&(r.idnt=f.idnt),f.mid&&(r.irt=f.mid,r.irt!=""&&(r.irt=r.irt.substring(1,r.irt.length-1))),s=f.mp[0].mp.length,s>0&&(r.$("#mailAttach").removeClass("hidden"),r.$("#mailAttach #mailAttachDetail").html(""),r.midPart=[]),require([egov.template.bmail.attachmentItem],function(n){for(var i,u,e,t=0;t<s;t++)f.mp[0].mp[t].cd&&f.mp[0].mp[t].cd=="attachment"&&(i=f.mp[0].mp[t].part,r.midPart.push(i),u=new bmail.models.attachment({part:i,fileName:f.mp[0].mp[t].filename,isCreate:!0}),e=new AttachmentItem({mail:r,model:u,template:n}),r.$("#mailAttachDetail").append(e.$el))})):u.Body&&u.Body.Fault&&u.Body.Fault.Detail&&u.Body.Fault.Detail.Error&&u.Body.Fault.Detail.Error.Code=="mail.MESSAGE_TOO_BIG"?egov.mobile.showStatus(bmail.resources.detail.file.toolarge):egov.mobile.showStatus(bmail.resources.detail.file.tryagain)):egov.mobile.showStatus(bmail.resources.savedraft.success):egov.mobile.showStatus(bmail.resources.savedraft.error)}},hasChange:function(){return this.dataChanged},validForm:function(){return(this.setDataInfo(),this.to=="")?(this.$("#mailTo").focus(),!1):this.subject==""?(this.$("#mailSubject").focus(),!1):this.content==""?(this.$("#Content").focus(),!1):!0},bindDataContent:function(n,t){this.isReply&&(this.$(".oldSenderInfo").html(t),this.$(".oldMailContent").html(n));this.$("#mailAttach").addClass("hidden");this.$("#mailAttach #mailAttachDetail").html("");bmail.user&&bmail.user.signature.useSignature&&this.$("#signal").html(bmail.user.signature.content);this.$el.addClass("display")},addEventForPage:function(){var n=this;PageEvents.AddressInputKeyEvent("#mailTo","keyup","#suggestions-To","#To");this.$("#uploadFileForm").fileupload({xhrFields:{withCredentials:!0},progressall:function(n,t){var i=parseInt(t.loaded/t.total*100,10);console.log("uploaded: "+i+"%")},done:function(t,i){for(var f=$(i.result).text(),e=f.replace("function doit() { window.parent._uploadManager.loaded(200,'null','","").replace("'); }",""),o=[],u=e.split(","),s=u.length,r=0;r<s;r++)o.push(u[r]);n.dataChanged=!0},error:function(n,t){console.error(t)}})},focusContent:function(n){n&&this.caret.push(getCaretPosition(n.target))},setDataInfo:function(){this.to=this.$("#mailTo").val().trim();this.subject=this.$("#mailSubject").html().trim();this.content=this.isReply?this.$("#mailBody").html().trim():this.$("#Content").html().trim()},createMailData:function(n){var r=[],u=[],f=this.content,o=f.replace(/<br>/,"\n").replace(/<style([\s\S]*?)<\/style>/gi," ").replace(/<script([\s\S]*?)<\/script>/gi," ").replace(/\s+/gm," "),i,t,e;return u.push({ct:"text/plain",content:o},{ct:"text/html",content:f}),i=[],i.push({ct:"multipart/alternative",mp:u}),t=n,t=t.replace(/;$/,""),e={from:bmail.user.email,from_displayName:bmail.user.displayName,to:t,cc:$("#mailCc").val(),bcc:$("#mailBcc").val(),subject:Util.getSubject(this.subject),mp:i},r.push(e),r},_showOldMail:function(){this.$(".viewOldMail").hide();this.$("#oldMailContent").show()},_closeCompose:function(n){egov.mobile.showDetailPage("bmail");this.$el.empty();n.preventDefault()}})});