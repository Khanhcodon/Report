define(function(){"use strict";function i(n){return _.find(egov.setting.allUsers,function(t){return t.username===n})}var n=Backbone.View.extend({folderId:"",folderPath:"",el:"mailList",className:"mail-list mdl-list ",idName:"mail-list-",searchClass:"search-list-item",isLoading:!1,isSwipeDown:!1,loadCount:0,events:{swipeup:"swipeUp",scroll:"loadMoreEvent","click #btnHideSearchResult":"hideSearchResult"},initialize:function(n){this.folderNode=n.folder;this.folderId=n.folderId;this.folderPath=n.folderPath;bmail.views.maillist=this;this.$el.empty()},initPropForModel:function(){var n=this;this.model.on("remove",function(){egov.mobile.isTablet||(egov.commonFn.event.showNavbar(),bmail.current.folder.showMailList())})},render:function(n,t,i,r){bmail.current.maillist=this;var u=this;n&&n.length>0?(u.$el.empty(),require([bmail.templates.mailList],function(t){bmail.templates.store.maillist=t;u.model=new bmail.models.mailList(u.renderData(n));u.initPropForModel();egov.callback(r)})):require([bmail.templates.mailListNoData],function(n){bmail.templates.store.maillistnodata=n;var f="Bạn không có thư nào trong mục này.";t?f="Không tìm thấy kết quả phù hợp.":i&&(f="Đang kiểm tra, vui lòng đợi...");u.$el.html($.tmpl(n,{message:f}));u.isLoading=!1;egov.callback(r)})},reRender:function(n){this.$el.empty();this.render(n)},renderData:function(n,i){var r=this,u=[];return console.log(n),n instanceof Array?$.each(n,function(n){var f=new t({parent:r,model:this,id:r.idName+this.id,mailId:this.id});u[n]=f.model;!i&&n===0&&egov.mobile.isTablet;r.$el.append(f.$el)}):egov.pubsub.publish(egov.events.status.error,n),r.isLoading=!1,u},swipeUp:function(){this.isSwipeDown=!1},swipeRefresh:function(n){this.isSwipeDown=!0;egov.helper.destroyClickEvent(n);$(n.currentTarget).scrollTop()==0&&this.refresh(n)},folderRefresh:function(){egov.mobile.hideDetailPage();this.refresh()},refresh:function(n){egov.helper.destroyClickEvent(n);var t=this;bmail.views.maillist.isShowingMultiSelectionBar||(egov.pubsub.publish(egov.events.status.processing,egov.resources.common.processing),bmail.makeRequest.getFolderMailList(0,this.folderPath,firstLoadMailNumber,!1,t.folderNode.isSentBox,function(n){t.$el.empty();t.render(n);egov.pubsub.publish(egov.events.status.destroy)}))},loadMore:function(n){var t=this;egov.pubsub.publish(egov.events.status.processing,egov.resources.common.processing);bmail.makeRequest.getFolderMailList(this.model.length+1,this.folderPath,firstLoadMailNumber,!1,t.folderNode.isSentBox,function(i){t.model.add(t.renderData(i,!0));egov.callback(n);egov.pubsub.publish(egov.events.status.destroy)})},loadMoreEvent:function(){window.innerHeight+document.body.scrollTop+300>document.body.scrollHeight&&!this.isLoading&&!this.isSwipeDown&&this.loadMore()},search:function(t){var i=this;egov.pubsub.publish(egov.events.status.processing,egov.resources.common.processing);bmail.makeRequest.getFolderMailList(0,t,1e4,!0,function(t){var r,u;i.$el.parent().children().hide();i.$el.parent().children("#mailSearchList").remove();r=new n({folder:i.folderNode,model:t,id:"mailSearchList"});r.isSearch||(bmail.views.maillist.currentList=i,r.isSearch=!0);$("#mailListWrap").append(r.$el);u="Có "+t.length+" kết quả.";require([bmail.templates.mailListSearchRow],function(n){r.$el.prepend($.tmpl(n,{message:u}))});egov.pubsub.publish(egov.events.status.destroy)})},hideSearchResult:function(n){egov.helper.destroyClickEvent(n);egov.mobile.isTablet||egov.mobile.removeSearch();this.$el.remove();bmail.current.folder.select()},markAsRead:function(n){var t=this;bmail.makeRequest.msgAction("read",n,function(){var i=n.split(",");_.each(i,function(n){var i=bmail.current.folder.model.get("totalUnread");i>0&&bmail.current.folder.model.set("totalUnread",i-1);t.model.get(n).set("unread",!1)})})},markUnRead:function(n){var t=this;bmail.makeRequest.msgAction("!read",n,function(){var i=n.split(",");_.each(i,function(n){bmail.current.folder.model.set("totalUnread",bmail.current.folder.model.get("totalUnread")+1);t.model.get(n).set("unread",!0)})})},markSpam:function(n){var t=this;bmail.makeRequest.msgAction("spam",n,function(){var i=n.split(",");_.each(i,function(n){t.model.remove(t.model.get(n))})})},unMarkSpam:function(n){var t=this;bmail.makeRequest.msgAction("!spam",n,function(){var i=n.split(",");_.each(i,function(n){t.model.remove(t.model.get(n))})})},deleteMail:function(n){var t=this;bmail.makeRequest.msgAction("trash",n,function(){var i=n.split(",");_.each(i,function(n){t.model.remove(t.model.get(n))})})},deleteMailPer:function(n){var t=this;bmail.makeRequest.msgAction("delete",n,function(){var i=n.split(",");_.each(i,function(n){t.model.remove(t.model.get(n))})})},restore:function(n){var t=this;bmail.makeRequest.msgAction("!trash",n,function(){var i=n.split(",");_.each(i,function(n){t.model.remove(t.model.get(n))})})},removeAllSelected:function(){_.each(this.model.models,function(n){n.get("isSelected")&&n.set("isSelected",!1)})}}),t=Backbone.View.extend({mailId:"",tagName:"li",className:"mdl-list__item mdl-list__item--two-line",mailDetailClass:".mail-detail",mailDetailId:"mailDetail_",$detailWrap:$("#mail-detail"),numberSelected:0,events:{click:"select",taphold:"multiSelection"},initialize:function(n){this.parent=n.parent;this.isSentBox=this.parent.folderNode.isSentBox;this.mailId=n.mailId;this.initData(n.model);this.setEventOfModel();this.render()},initData:function(n){var r=this,t={a:"unknown",d:"unknown",p:"unknown"},f,s=!1,o,e,u;n.e&&(o="f",this.isSentBox&&(o="t"),t=n.e.filter(function(n){return n.t==o})[0]);n.f&&n.f=="u"&&(s=!0);f=n.id.replace(/:/gi,"");e=t.a?t.a.indexOf("@")==-1?t.a:t.a.substr(0,t.a.indexOf("@")):"?";u=i(e);r.model=new bmail.models.mail({d:n.d,date:egov.commonFn.util.getCommonTime(n.d),detailDate:new Date(n.d).format("HH:mm dd/MM/yyyy"),location:n.l,conversationId:n.cid,id:n.id,trimId:f,domId:"maillist_"+f,mailDetailId:r.mailDetailId+f,sender:{fulladdress:t.a,address:e,name:u==null?e:u.fullname,fullname:u==null?t.a:u.fullname},hasAttach:n.f==undefined?!1:n.f.indexOf("a")!=-1,subject:Util.getSubject(n.su),unread:s,isSelected:!1});r.model.set("avatar",u==null?"../AvatarProfile/noavatar.jpg":u.avatar);r.model.set("alphabet",r.model.get("sender").address[0]);r.model.set("alphabetCode",getColorCode(r.model.get("sender").address[0]))},setEventOfModel:function(){var n=this;this.model.on("remove",function(){n.$el.remove()});this.model.on("change:unread",function(){n.$el.toggleClass("unread")});this.model.on("change:isSelected",function(t,i){var r,u;i?n.$el.addClass("rowSelected"):n.$el.removeClass("rowSelected");bmail.views.maillist.isShowingMultiSelectionBar&&(n.$el.toggleClass("showMultiselectCheckBox"),n.$el.hasClass("showMultiselectCheckBox")?(r=!0,n.$el.find(".checkbox").addClass("checked")):(r=!1,n.$el.find(".checkbox").removeClass("checked")),u=n.parent.$el.find(".showMultiselectCheckBox").length,n.parent.multiselectionbar&&(u==0&&n.parent.multiselectionbar.hideMultiSelectionBar(),n.parent.multiselectionbar.add(r,t,u+"/"+n.parent.model.length)))})},render:function(){var t=this,n=$.tmpl(bmail.templates.store.maillist,this.model.toJSON());this.$el.append(n);this.model.get("unread")&&this.$el.addClass("unread")},select:function(n){egov.helper.destroyClickEvent(n);var t=this;if(bmail.views.maillist.isShowingMultiSelectionBar){this.parent.multiselectionbar&&this.parent.multiselectionbar.hideDropDown();this.toggleSelected();return}if(egov.mobile.showingSearchBox&&!egov.mobile.isTablet){egov.mobile.hideSearchBox();return}egov.mobile.isTablet&&$(".dataDetail").removeClass("display");this.model.hasBind?(t.removeAllSelected(),t.addSelected(),egov.mobile.showDetailPage()):require(["bmailViewDetail"],function(n){var i=new n({mailItem:t,model:t.model,id:t.model.get("mailDetailId")});t.$detailWrap.empty();t.$detailWrap.append(i.$el);egov.mobile.showDetailPage();t.removeAllSelected();t.markAsRead()});bmail.current.mail=this},multiSelection:function(n){var t=this;egov.helper.destroyClickEvent(n);this.removeAllSelected();bmail.views.maillist.isShowingMultiSelectionBar||(bmail.views.multiSelectionBar?t.parent.multiselectionbar.showMultiSelectionBar():require(["bmailViewMultiSelectionBar"],function(n){t.parent.multiselectionbar=new n({mailList:t.parent})}),bmail.views.maillist.isShowingMultiSelectionBar=!0)},removeAllSelected:function(){$(this.mailDetailClass).hide();this.parent.removeAllSelected()},addSelected:function(){$("#"+this.model.get("mailDetailId")).show();this.model.set("isSelected",!0)},toggleSelected:function(){this.model.get("isSelected")?this.model.set("isSelected",!1):this.model.set("isSelected",!0)},markAsRead:function(){this.model.get("unread")&&this.parent.markAsRead(this.mailId)},markUnRead:function(){this.model.get("unread")||(this.parent.markUnRead(this.mailId),this.model.set("unread",!1))},markSpam:function(){this.parent.folderRefresh();this.parent.markSpam(this.mailId)},unMarkSpam:function(){this.parent.folderRefresh();this.parent.unMarkSpam(this.mailId)},deleteMail:function(){this.parent.folderRefresh();this.parent.deleteMail(this.mailId)},deleteMailPer:function(){this.parent.folderRefresh();this.parent.deleteMailPer(this.mailId)},restore:function(){this.parent.restore(this.mailId)}});return n});