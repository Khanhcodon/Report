(function(){var n={extension:null,signatureConfig:[],appendPlugin:function(n){(egov.extension||(egov.extension=PluginFactory.getInstance()),egov.extension)&&egov.extension.isReady(function(t){t?this.checkNativeAppVersion(n):egov.extension.isPluginExist(function(t){t?egov.extension.injectPlugin("egovPlugin",function(){this.appendPlugin(n)}.bind(this)):this.showDialogDownloadPlugin(function(){this.appendPlugin(n)}.bind(this))}.bind(this))}.bind(this))},checkNativeAppVersion:function(n){egov.extension.hasAppendMode!=null||egov.hasPluginAppendMode!=null||setTimeout(function(){egov.extension.hasAppendWriteMode(function(t){egov.extension.hasAppendMode=t;egov.hasPluginAppendMode=t;egov.callback(n)})},2e3);egov.callback(n);return},showDialogDownloadPlugin:function(n){var i,t;i=this;t=$('<div><p style="font-size:16px;font-weight:bold;">'+egov.resources.plugin.noplugin+"<\/p><p>"+egov.resources.plugin.pluginrequire+'<\/p><p style="color:red">'+egov.resources.plugin.needrestartbrowser+'<\/p><center><div style="text-align:center;width:180px"><input type="button" value="'+egov.resources.plugin.downloadtosetup+'" /><\/div><\/center><\/div>');t.find("input").bind("click",function(){i._startDownload();i._dowloadingPlugin(t,n)});t.dialog({width:"800px",resizable:!1,title:egov.resources.common.alert,buttons:[{text:egov.resources.common.closeButton,click:function(){t.dialog("destroy")}}]})},_startDownload:function(){document.location="/Download/EOfficePlusPlugin"},_dowloadingPlugin:function(n){var i,t;i=this;t=$('<a class="retry">'+egov.resources.main.installPlugin.reDownload+"<\/a>");t.on("click",function(){i._startDownload()});n.empty();n.append(t)},sign:function(n,t){var i,u,f,r,e;if(i=this,i.hasDeleteOldFile=!1,i.signatureConfig=egov.signatureConfig||[],r=egov.setting.signerConfig,r.length===0){egov.pubsub.publish(egov.events.status.error,"Bạn chưa cấu hình chữ ký số, vui lòng vào Thiết lập cá nhân/Cấu hình chữ ký để tạo mới.");egov.callback(t,!1);return}e=$.isArray(r)?r.slice(0,r.length):$.extend(!0,{},r);i.document=n;i._writeImageSignature(e,function(){u=[];f=n.attachments.model.models;f.length>0&&$.each(f,function(n,t){egov.fileExtension.isForSign(t.get("Name"))&&t.get("hasRemoved")!==!0&&t.get("isRemoved")!==!0&&u.push(t)});u.length>0?(i.confirmSignFiles=u,i._displaySignDialog(u,n,t)):egov.callback(t,!1)})},_displaySignDialog:function(n,t,i){var r,f,u;r=this;r.isPreviewing=!1;require([egov.template.document.signer],function(t){f=$("<div><\/div>");f.append(t);f.find(".sign-list").append($.tmpl('<li class="list-group-item"><div><label><input type="checkbox" data-id="${Id}"> ${Title}<\/label><\/div><\/li>',r.signatureConfig));r.signatureConfig.length===1&&f.find(".sign-list :checkbox").attr("checked","checked");var e=_.map(n,function(n){return n.toJSON()});f.find(".att-list").append($.tmpl('<li class="list-group-item"><div><label><input type="checkbox" data-id="${Id}" checked> ${Name}<\/label><\/div><\/li>',e));f.appendTo("body");r.$confirmDialog=f;u={};u.width=500;u.height="auto";u.autoResize=!0;u.title="Ký số điện tử";u.buttons=[{text:"Xem trước",className:"btn-warning",click:function(){r._signPreview(i)}},{text:"Chuyển",className:"btn-primary",click:function(){r._signAndSend(i)}},{text:"Bỏ qua",className:"btn-default",click:function(){r.isPreviewing=!1;r.$confirmDialog.dialog("destroy");egov.callback(i,!1)}}];u.confirm={text:"Xóa tệp cũ sau khi ký",id:"deleleOldFile",style:{float:"left","font-weight":"normal","font-size":"13px"},click:function(n){r.hasDeleteOldFile=n},hasAutoClick:!1,disabled:!1};r.$confirmDialog.dialog(u)})},_getSelectedFiles:function(n){var r=this,i=r.$confirmDialog.find(".att-list input:checked"),t;return i.length<=0?[]:(t=[],i.each(function(n,i){t.push($(i).attr("data-id"))}),_.filter(n,function(n){return _.contains(t,n.get("Id").toString())}))},_getSelectedSignerConfig:function(n){var r=this,i=r.$confirmDialog.find(".sign-list input:checked"),t;return i.length<=0?[]:(t=[],i.each(function(n,i){t.push($(i).attr("data-id"))}),_.filter(n,function(n){return _.contains(t,n.Id.toString())}))},_writeFileBase64:function(n,t,i){var s=this,f,u;if(!n){i();return}if(f=Object.keys(n),f.length===0){i();return}var e=f[0],h=n[e],r=t.filter(function(n){return n.get("Id")==e});r=r[0];u=r.get("Extension");u.indexOf(".")!=0&&(u="."+u);var c=r.get("Id")+u,l=(new Date).getTime().toString(),o=l+"\\"+c;egov.extension.writeFileBase64(o,h,!0,function(u){var f=u.returnCode===1;if(f)r.set("fileData",o),r.set("md5",u.md5),delete n[e],s._writeFileBase64(n,t,i);else{egov.pubsub.publish(egov.events.status.error,egov.resources.common.errorMessage);return}})},_writeImageSignature:function(n,t){var r=this,i,f;if(n.length===0||egov.isWriteSigner){egov.isWriteSigner=!0;egov.signatureConfig=r.signatureConfig;_.each(egov.signatureConfig,function(n){if(n.SignType!==0){var t=r.document.model.get("DocCode");n.ReplaceText=t.split("/")[0]}});t(r.signatureConfig);return}if(i=n.pop(),i==undefined){t(r.signatureConfig);return}if(f=i.ImagePath&&i.SignType===0,f)var e=""+(new Date).getTime()+i.Ext,o=(new Date).getTime().toString(),u=o+"\\"+e,s=egov.extension.writeFileBase64(u,i.ImagePath,!0,function(f){if(f.returnCode==1)u=u.replace(/\//g,"\\"),i.ImagePath=u,r.signatureConfig.push(i),r._writeImageSignature(n,t);else{egov.pubsub.publish(egov.events.status.error,egov.resources.common.errorMessage);return}});else i.ImagePath="",i.ReplaceText=r.document.model.get("DocCode"),r.signatureConfig.push(i),r._writeImageSignature(n,t)},_signAndSend:function(n){var t=this,i=function(i,r){if(!i||r.length===0){t.$confirmDialog.dialog("destroy");egov.callback(n,!1);return}egov.pubsub.publish(egov.events.status.success,"Kí file thành công!");t._uploadAndSend(r,n)};this._doSign(i)},_signPreview:function(n){var t=this,i;t.isPreviewing||(t.isPreviewing=!0,i=function(i,r){if(!i||r.length===0){t.$confirmDialog.dialog("destroy");egov.callback(n,!1);return}t._openPreviewSinged(r,n)},this._doSign(i))},_openPreviewSinged:function(n,t){for(var e,r,o,f=this,i=$("<div>"),u=0;u<n.length;u++)e=n[u],r=$("<object>"),r.css({width:"100%",height:"350px",border:"none"}),r.attr("data","data:application/pdf;base64,"+e.value),i.append(r);i.appendTo("body");o={width:1e3,height:400,autoResize:!0,title:"Ký số điện tử",buttons:[{text:"Chuyển",className:"btn-primary",click:function(){i.dialog("destroy");f._uploadAndSend(n,t)}},{text:"Bỏ qua",className:"btn-default",click:function(){f.isPreviewing=!1;i.dialog("destroy")}}]};i.dialog(o)},_doSign:function(n){var i,r,u=[],f=[],t=this,e;if(i=t._getSelectedFiles(t.confirmSignFiles),r=t._getSelectedSignerConfig(t.signatureConfig),i.length<=0||r.length<=0){egov.pubsub.publish(egov.events.status.warning,"Bạn chưa chọn tệp hoặc chữ ký để ký số. Vui lòng thử lại.");t.$confirmDialog.dialog("destroy");n(!1,[]);return}e=i.filter(function(n){return!n.get("fileData")});$.each(e,function(n,t){t.get("isNew")?egov.isMobile?u.push(t.get("Id")+"."+t.get("Extension")):u.push(t.get("Id")):f.push(t.get("Id"))});egov.pubsub.publish(egov.events.status.processing,egov.resources.common.processing);egov.request.downloadAttachmentForSignBase64({data:{fileIds:f,fileTempIds:u,convertWordTopdf:!1},success:function(u){var f=$.extend(!0,{},u.files);t._writeFileBase64(f,i,function(){var u={ConfigSignPDFList:r},f=function(r){var f=parseInt(r.idxCert),e,o;if(isNaN(f)||f<=-1){t.isPreviewing=!1;egov.pubsub.publish(egov.events.status.error,"Vui lòng kiểm tra lại chữ kí số đã sẵn sàng trước khi kí!");return}e=[];o=i;t._signFile(o,e,u,f,function(){n(!0,e)})};egov.extension.getCertIndex(f)})},error:function(){t.isPreviewing=!1;egov.pubsub.publish(egov.events.status.error,egov.resources.common.errorMessage)}})},_signFile:function(n,t,i,r,u){if(n.length===0){u();return}var o=n.pop(),f=o.get("fileData"),l=egov.fileExtension.isForSign(f),h=i.ConfigSignPDFList.slice(0);if(l){var e=h.pop(),s=$.extend(!0,{SignAuthor:egov.setting.userName,SignReason:"Bkav eGov sign"},e),c=function(l){if(e=h.pop(),l.returnCode==1){if(e!=undefined){egov.fileExtension.isMsOfficeFile(f)&&(f=egov.fileExtension.getFileName(f)+".pdf");s=$.extend(!0,{SignAuthor:egov.setting.userName,SignReason:"Bkav eGov - Ký số điện tử"},e);this._signSelectFile(f,s,r,c);return}var a=egov.fileExtension.getFileName(o.get("Name"));a.match(/_Signed$/)||(a=a+"_Signed");a=a+".pdf";t.push({id:""+o.get("Id"),name:a,originName:l.fileName,value:l.base64});this._signFile(n,t,i,r,u)}else{egov.pubsub.publish(egov.events.status.error,egov.resources.common.errorMessage);return}}.bind(this);this._signSelectFile(f,s,r,c)}},_signSelectFile:function(n,t,i,r){egov.extension.signFile(n,t,parseInt(i),function(n){r(n)}.bind(this))},_uploadAndSend:function(n,t){var i=this;this._uploadSignedFile(n,this.document,function(){i.$confirmDialog.dialog("destroy");egov.callback(t,!0);egov.pubsub.publish(egov.events.status.success,"Đính kèm file đã kí vào văn bản thành công!")})},_uploadSignedFile:function(n,t,i){var u=this,r=[];if(_.each(n,function(n){var i=t.attachments.model.find(function(t){return String(t.get("Id"))===String(n.id)}),u=i.get("Name"),f=u.endWith("_Signed.pdf",!0);!f||i.get("isNew")?r.push(n):t.attachments.modifiedFiles[n.id]=n.value}),r.length===0){egov.callback(i);return}egov.request.uploadTempScan({data:{files:JSON.stringify(r)},success:function(n){$.each(n,function(n,i){if(i.error!=="")egov.pubsub.publish(egov.events.status.error,i.name+": "+i.error);else{var r=new egov.models.attachment({Id:i.key,Name:i.name,Size:i.size,Extension:i.extension,Versions:[{Version:1,User:egov.setting.fullName+" ("+egov.setting.userName+")"}],isNew:!0});t.attachments.model.add(r)}});egov.callback(i)},error:function(){egov.pubsub.publish(egov.events.status.error,"Lỗi trong quá trình upload file đã kí lên server! Vui lòng thử lại.")}})},openAttachment:function(n,t){var r,u,i;r=n.model.get("Id");u=n.parent.storePrivateId;n.model.get("isNew")?n.model.get("isOpen")&&n.model.get("fileData")?egov.extension.openFile(n.model.get("fileData")):egov.request.downloadAttachmentTemp({data:{id:r},success:function(t){var r=JSON.parse(t),i,u,f;r&&(r.error?egov.pubsub.publish(egov.events.status.error,r.error):(i=n.model.get("Extension"),i.indexOf(".")!=0&&(i="."+i),u=n.model.get("Name").toLowerCase()+i,f=(new Date).getTime().toString(),filePath=f+"\\"+u,egov.extension.writeFileBase64(filePath,r.content,!0,function(t){t.returnCode==1&&(n.model.set("fileData",filePath),n.model.set("md5",t.md5),egov.extension.openFile(filePath,function(){n.model.set("isOpen",!0)}))}.bind(this))))}.bind(this),error:function(){egov.pubsub.publish(egov.events.status.error,egov.resources.document.attachment.errorDownload)},complete:function(){egov.pubsub.publish(egov.events.status.destroy)}}):(i=t==n.model.get("LastestVesion"),n.model.get("isOpen")&&(!t||i)?egov.extension.openFile(n.model.get("fileData")):(egov.pubsub.publish(egov.events.status.processing,egov.resources.common.processing),egov.request.downloadAttachment({data:{id:r,storePrivateId:u,version:t?i?null:t:null},success:function(r){var f=JSON.parse(r),u,e,o;f&&(f.error?egov.pubsub.publish(egov.events.status.error,f.error):(u=n.model.get("Extension"),u.indexOf(".")!=0&&(u="."+u),e=n.model.get("Name").toLowerCase()+u,o=(new Date).getTime().toString(),filePath=o+"\\"+e,egov.extension.writeFileBase64(filePath,f.content,!0,function(r){r.returnCode==1&&((i||!t)&&n.model.set("fileData",filePath),n.model.set("md5",r.md5),egov.extension.openFile(filePath,function(){(i||!t)&&n.model.set("isOpen",!0)}))}.bind(this))))}.bind(this),error:function(){egov.pubsub.publish(egov.events.status.error,_resource.errorDownload)},complete:function(){egov.pubsub.publish(egov.events.status.destroy)}})))},openStoreAttachment:function(n){egov.request.storePrivateOpenFile({data:{id:n},success:function(n){var t=JSON.parse(n),i,r;t&&(t.error?egov.pubsub.publish(egov.events.status.error,t.error):(i=t.fileName,r=(new Date).getTime().toString(),filePath=r+"\\"+i,egov.extension.writeFileBase64(filePath,t.content,!0,function(n){n.returnCode==1&&egov.extension.openFile(filePath,function(){})}.bind(this))))},error:function(){egov.pubsub.publish(egov.events.status.error,_resource.errorDownload)},complete:function(){egov.pubsub.publish(egov.events.status.destroy)}})},confirmAttachments:function(n,t){var r=this,i=n.model.select(function(n){return!n.get("isRemoved")&&n.get("isOpen")&&!egov.fileExtension.isReadonly(n.get("Name"))});if(i.length===0)egov.callback(t);else{$(document).on("checkModifySuccess",function(n){$(document).off("checkModifySuccess");egov.callback(t);egov.helper.destroyClickEvent(n)});this._confirmSaveAttachment(i,n)}},_confirmSaveAttachment:function(n,t){if(n.length===0){$(document).trigger("checkModifySuccess");return}var r=this,i=n[0],u=n.splice(1,n.length-1);egov.extension.closeFile(i.get("fileData"),function(n){n.returnCode==1||n.returnCode==2?(n.returnCode=="2"&&console.log("egov.extension.closeFile: "+i.get("Name")+" đã đóng trước đó"),egov.extension.readFileBase64(i.get("fileData"),function(n){if(n.returnCode==1)if(i.get("md5")!=n.md5){var f=i.get("Name");egov.message.show(String.format(egov.resources.document.attachment.fileChanged,f),null,egov.message.messageButtons.YesNo,function(){t.modifiedFiles[i.get("Id")]=n.base64;r._confirmSaveAttachment(u,t)},function(){r._confirmSaveAttachment(u,t)})}else r._confirmSaveAttachment(u,t);else n.returnCode==2?console.log("egov.plugin::_confirmSaveAttachment::warning: Đọc nội dung file không tồn tại!!! Cần check lại code."):console.log("egov.plugin::_confirmSaveAttachment::Error: lỗi không thể lưu nội dung file")})):console.log("egov.plugin::_confirmSaveAttachment::Error: lỗi không thể đóng file")})},getMAC:function(n){if(egov.extension||(egov.extension=PluginFactory.getInstance()),!egov.extension){egov.callback(n,"");return}egov.extension.getMAC(function(t){egov.callback(n,t.mac)})}};return window.Plugin=n,n})();