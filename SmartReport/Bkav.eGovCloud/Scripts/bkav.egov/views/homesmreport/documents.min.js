define(["contextMenuView","documentContextmenu"],function(n,t){"use strict";function d(n,t){t.find("colgroup").empty();$.each(n,function(n,i){i.Width&&i.Width>0?t.find("colgroup").append('<col style="width: '+i.Width+'px"/>'):t.find("colgroup").append("<col/>")})}function g(n,t,i,r){t=t==!0;egov.request.setDocumentViewed({data:{id:n,viewed:t},success:function(n){n&&(n.error?(egov.pubsub.publish(egov.events.status.error,n.error),egov.callback(r)):egov.callback(i))},error:function(){egov.callback(r)}})}function nt(n,t,i,r,u,f){egov.request.finish({data:{documentCopyId:n,storePrivateId:t,comment:i,isThongBao:r},success:function(n){n.error?(egov.pubsub.publish(egov.events.status.error,egov.resources.document.finish.error),egov.callback(f)):egov.callback(u)},error:function(){egov.callback(f)}})}function r(n,t,i){require([n],function(n){$(".document-preview").html($.tmpl(n,t));$(".document-preview").bindResources();egov.callback(i)})}function u(n){try{var t;t=egov.isMobile?egov.mobile.notification.eGovNotify:window.parent.eGovNotify;t.removeModelById(n,!0)}catch(i){console.log(i.message)}}function o(n){if(String.isNullOrEmpty(n))return null;n=new Date(n);var t=new Date,i=(n.getTime()-t.getTime())/1e3;return Math.ceil(i/86400)}function tt(n,t){var i=n.toLowerCase();return(t=t.toLowerCase(),i.contains(t))?!0:!1}function it(){return egov.enum.quickViewType.below===egov.setting.user.userSetting.quickView?egov.template.documentList.quickViewBelow:egov.template.documentList.quickViewRight}function rt(n){egov.pubsub.publish(egov.events.status.processing,egov.resources.common.processing);require(["filedownload"],function(){var t="/StorePrivate/DownloadAttachment/"+n;$.fileDownload(t,{successCallback:function(){egov.pubsub.publish(egov.events.status.destroy)},failCallback:function(n){var i=$(n),t;try{t=JSON.parse(i.text());egov.pubsub.publish(egov.events.status.error,t.error)}catch(r){egov.pubsub.publish(egov.events.status.error,egov.resources.file.errorDownload)}}})})}function c(n){Plugin&&window.Plugin.appendPlugin(function(){Plugin.openStoreAttachment(n)})}function ut(n,t,i,r,u,f,e,s,h,c,l){if(e==4||e==1||e==8||h||!r)return u==2||u==4?2:l===2?8:1;if(s&&!h)return 9;if(n==3)return 6;if(n==2)return 5;var v=o(i),a=o(r),y=o(t);return e==16?f!=null?7:c?8:1:a<=0?4:a<=2&&a>0?3:u==2||u==4?2:l===2?8:1}var s=/\d{4}-[0-1]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-6]\d$/,h=[{ColumnName:"Compendium",DisplayName:"Trích yếu",SortName:"",Width:"300",EnableSort:!0,Order:1},{ColumnName:"UserCurrentFullName",DisplayName:"Người tạo",SortName:null,Width:"120",EnableSort:!1,Order:2},{ColumnName:"DateCreated",DisplayName:"Ngày tạo",SortName:"DateCreated",Width:"80",EnableSort:!0,Order:3},{ColumnName:"DateReceived",DisplayName:"Ngày nhận",SortName:"DateReceived1",Width:"80",EnableSort:!0,Order:4},{ColumnName:"DocCode",DisplayName:"Số ký hiệu",SortName:null,Width:100,EnableSort:!0,Order:5},{ColumnName:"InOutCode",DisplayName:"Số đến đi",SortName:null,Width:100,EnableSort:!0,Order:6}],l=[{ColumnName:"STT",DisplayName:getResource("egov.resources.document.table.stt"),Width:"50",EnableSort:!1,Order:0},{ColumnName:"Compendium",DisplayName:getResource("egov.resources.document.Compendium"),SortName:"",Width:"300",EnableSort:!0,Order:2},{ColumnName:"Email",DisplayName:getResource("egov.resources.document.table.creater"),SortName:null,Width:100,EnableSort:!0,Order:3},{ColumnName:"IdCard",DisplayName:getResource("egov.resources.document.table.idCard"),SortName:"",Width:"100",EnableSort:!0,Order:4},{ColumnName:"DateReceivedFormat",DisplayName:getResource("egov.resources.document.table.dateRecieved"),SortName:"",Width:"150",EnableSort:!0,Order:5},{ColumnName:"DocCode",DisplayName:getResource("egov.resources.document.table.docCode"),SortName:null,Width:null,EnableSort:!0,Order:6}],a=[{ColumnName:"STT",DisplayName:getResource("egov.resources.document.table.stt"),Width:"50",EnableSort:!1,Order:0},{ColumnName:"Date",DisplayName:getResource("egov.resources.question.date"),SortName:"",Width:"150",EnableSort:!0,Order:2},{ColumnName:"Name",DisplayName:getResource("egov.resources.question.name"),SortName:"",Width:null,EnableSort:!0,Order:3},{ColumnName:"AskPeople",DisplayName:getResource("egov.resources.question.citizenname"),SortName:null,Width:200,EnableSort:!0,Order:4},{ColumnName:"Compendium",DisplayName:getResource("egov.resources.question.Compendium"),SortName:null,Width:200,EnableSort:!0,Order:6}],v={egov:1,egovOnline:2},ft=egov.enum.urgents,y,i=egov.resources.documents,p=Backbone.View.extend({tagName:egov.isMobile?"ul":"div",className:egov.isMobile?"mdl-list":"grid",parent:$("#documentList"),defaultSorting:[{columnName:"DateReceived1",isDesc:{asc:!1,desc:!0}.desc,index:0}],lastSelected:null,isMultiSelecting:!1,isQuestionTree:!1,keyCode:{enter:13,a:65},documentListAdd:[],documentListRemove:[],tmpCallback:null,events:{"click #checkAll":"checkAll"},initialize:function(n){var t=this;return egov.views.home.documents=this,egov.setting.isScrollPaging=!0,t.node=n.node,t.tree=n.tree,t.treeCallback=n.treeCallback,t.isStoreTree=n.isStoreTree,t.isQuestionTree=n.isQuestionTree,t.isOnlineRegistration=n.isOnlineRegistration,t.DocumentOnlineType=n.DocumentOnlineType,t.hasExportFile=t.node.model.get("hasExportFile"),t.isGeneralFAQTree=t.node.model.get("generalFAQTree")==!0,t.docfieldIds=n.docfieldIds||null,t.storePrivate=egov.views.home.tree.storeTree,t.nodeId=t.isStoreTree?t.node.model.get("storePrivateId"):t.node.model.get("funtionIdNote")?t.node.model.get("funtionIdNote"):t.node.model.get("funtionId"),t.total||(t.total=parseInt(t.node.model.get("totalDocument"))),t.unread||(t.unread=parseInt(t.node.model.get("totalDocumentUnread"))),t.data={id:t.nodeId,paramsQuery:t.node.model.get("params")},t.node.model.get("defaultSort")&&(t.defaultSorting=egov.toJSON(t.node.model.get("defaultSort")),t.defaultSorting=_.sortBy(t.defaultSorting,function(n){return n.index})),t.sorting=t.defaultSorting,t._initData(),t.bindView(),t.renderFunction=t.isQuestionTree?t._getQuestionList:t.isOnlineRegistration?t._getDocumentOnlineRegistration:t.isStoreTree?t._getDocumentStore:t._getDocuments,t._showProcessing(),t.renderFunction(function(n){t.isQuestionTree||t.isOnlineRegistration||t.isStoreTree?(t.renderStore(),t.isStoreTree||egov.callback(t.treeCallback,n)):t.render();t._hideProcessing()}),this},render:function(){if(egov.isMobile){this._initForMobile();return}this._initForDesktop()},_showProcessing:function(){if(egov.isMobile){egov.mobile.showProcessBar();return}egov.pubsub.publish(egov.events.status.processing,egov.resources.common.processing)},_hideProcessing:function(){if(egov.isMobile){egov.mobile.hideProcessBar();return}egov.pubsub.publish(egov.events.status.destroy)},_initData:function(){this.$el.attr("id","documentList"+this.nodeId);this.isImportantFiltering=!1;this.isUnreadFiltering=!1;this.dateFiltering=null;this.overdueFiltering=null;this.doctypeFiltering=null;this.allDataIsLoaded=!1;this.pageCurrent=1;this.sorting=this.defaultSorting;this.hasChanged=!1},_initForMobile:function(){var n=this;require(["tabView","documentView",egov.template.document.mobileInfo]);n.$el.addClass("list-group list-document");n.renderDocumentsMobile(n.model,null,null,n.treeCallback);require(["toolbarView"],function(t){n.renderToolbar(t)})},_initForDesktop:function(){var n=this;(this.reloadColumnWidth(),this.columnSetting)&&require([egov.template.documentList.desktop],function(t){n.$el.html(t);var i=function(t){n.renDocumentsHeader();n.renderDocumentCommon(t);n.enableResize();n.layout()};n.isFirstload?(i(!0),egov.callback(n.treeCallback)):(i(!1),n.loadNewerDocuments(n.treeCallback));n.isFirstload=!1;n._bindEventScroll();n.appendBodyEventKey()})},renderStore:function(){var n=this;if(egov.isMobile){this.renderStoreMobile();return}(this.reloadColumnWidth(),this.columnSetting)&&require([egov.template.documentList.desktop],function(t){n.$el.html(t);n.renDocumentsHeader();n.renderDocumentCommon(!0);n.enableResize();n.layout();n._bindEventScroll();n.appendBodyEventKey()})},renderStoreMobile:function(){var n=this;this.isQuestionTree&&require(["questionMobile"],function(t){var i=new t({parent:n,model:new egov.models.questionList(n.model.models)});n.$el.html(i.$el)})},bindView:function(){this.hideAllContextmenu();egov.isMobile?this.bindViewMobile():(this.parent.find(".grid").hide(),this.parent.has(this.$el).length>0?this.$el.show():this.parent.append(this.$el))},bindViewMobile:function(){var n=egov.views.home.tree;n.$documentListId.children().hide();$(n.nameGroupDocument).text(this.node.model.get("name"));this.parent.find(".list-document").not(this.$el).removeClass("display");this.parent.has(this.$el).length>0?this.$el.show():this.parent.append(this.$el)},layout:function(){egov.views.home.documentLayout=this.$el.layout({resizable:!0,closable:!1,spacing_closed:0,spacing_open:0,north__spacing_open:0,north__size:32,north__paneSelector:".grid-header",center__paneSelector:".grid-content"})},renderDocuments:function(n,t,i,r,u,e){var o=this.$("tbody"),l=this,s=0,h,c;if(t=t||!1,t&&(this.removeAllSelected(),o.empty()),this._hideDocuments(u),!e&&(!n||n.length<=0)){h=this.columnSetting.length;o.empty().append("<tr><td colspan="+h+">"+egov.resources.documents.noDocumentCopyItem+"<\/td><\/tr>");return}c=_.filter(this.columnSetting,function(n){return n.ColumnName!="STT"&&n.ColumnName!="Checkmask"&&n.ColumnName!="Color"});n.forEach(function(n){var t=new f({parent:l,model:n,config:c});s===0&&i&&t.selected();r?o.prepend(t.$el):o.append(t.$el);s=s+1});this._hideProcessing()},_hideDocuments:function(n){if(n&&n.length>0){var t=this;_.each(n,function(n){var i="tr#documentCopy"+n;t.$el.find("tbody").find(i).fadeOut(600).remove()})}},renderDocumentsMobile:function(n,t,i,r){var u=this,e;this.removeAllSelected();e=this.$el;egov.dataManager.getAllUsers({success:function(t){if(e.empty(),!n||n.length<=0){u.$el.append("<li class='two-line no-data'>"+egov.resources.documents.noDocumentCopyItem+"<\/li>");return}var s,o=i||0;o>=n.length?o=n.length-1:o<0&&(o=0);u.allUsers=t;egov.currentUser=_.find(t,function(n){return n.value===egov.userId});n.each(function(n,t){var i=new f({parent:u,model:n});o==t&&(s=i);e.append(i.$el)});s.selected();egov.mobile.isTablet;egov.callback(r)}})},renderSearchMobileDocuments:function(n){var i,r=this,t="#searchListDocument";$(t).remove();$("#documentList").append("<div id='searchListDocument' class='grid list-group list-document'><\/ul>");$(t).append("<div class='list-group-item'><b id='totalSearchResult'>"+egov.resources.searching.result+" (<span style='color: blue'>"+n.length+"<\/span>)<\/b><\/li>");i=$(t);n.each(function(n,t){var u=new f({parent:r,model:n});i.append(u.$el);t===0&&u.selected()})},mobileSearch:function(n,t){typeof this.searching!="undefined"&&window.clearTimeout(this.searching);var i=this;this.searching=window.setTimeout(function(){i.mobileSearchFilter(n,t);i._hideProcessing()},300)},mobileSearchFilter:function(n,t){var u=this,i,r;t=t==!0;t?(i=[],this._showProcessing(),$("#documentList .list-document").hide(),egov.request.quickSearch({data:{query:n,isGetAll:!0},success:function(n){for(var f,e,r=n.Items,t=0;t<r.length;t++)f={Address:r[t].ExtendInfo.Address,Compendium:r[t].DocumentCompendium,DateCreated:r[t].ExtendInfo.DateCreate,DateReceived:r[t].DateReceived,DocCode:r[t].ExtendInfo.DocCode,DocumentCopyId:r[t].DocumentCopyId,DocumentId:r[t].DocumentId,UserCurrentFullName:r[t].ExtendInfo.CurrentUsername,Status:r[t].ExtendInfo.Status,IsViewed:r[t].IsViewed},i.push(f);e=new egov.models.documentList(i);u.renderSearchMobileDocuments(e);u._hideProcessing()}})):(n=egov.utilities.string.stripVietnameseChars(n.toLowerCase()),this.$el.children().hide(),r=this.$el.find(".compendium").filter(function(){return this.textContent.contains(n)}),r.length>0&&_.each(r,function(n){$(n).closest(".list-group-item").show()}))},renderDocumentCommon:function(n){if(this.isClientFilter=!1,!this.model||this.model.length===0){var t=this.columnSetting.length;this.$el.find("tbody").empty().append("<tr><td colspan="+t+">"+egov.resources.documents.noDocumentCopyItem+"<\/td><\/tr>");this._noDocumentSelectedQuickview();egov.pubsub.publish(egov.events.status.destroy);return}this.renderDocuments(this.model,!1,n)},renderClientFilter:function(n){var t=this,u=this.leng,r=function(){var n=t.columnSetting.length;t.$el.find("tbody").empty().append("<tr><td colspan="+n+">"+egov.resources.documents.noDocumentCopyItem+"<\/td><\/tr>");t._noDocumentSelectedQuickview();t._hideProcessing()},i;if(!this.model||this.model.length<=0){r();return}if(this._sortBy(),i=this.model.select(function(t){var r=!0,i;return n&&n!=""&&(i="",t.get("Compendium2")&&(i=t.get("Compendium2")),t.get("DocCode")&&(i+=" "+t.get("DocCode")),t.get("InOutCode")&&(i+=" "+t.get("InOutCode")),t.get("UserCurrentFullName")&&(i+=" "+t.get("UserCurrentFullName")),t.get("UserCurrentFirstName")&&(i+=" "+t.get("UserCurrentFirstName")),r&=tt(egov.utilities.string.stripVietnameseChars(i),n)),r}),i.length===0){r();return}this.isClientFilter=!0;this.filterTerm=n;this.renderDocuments(new egov.models.documentList(i),!0,!0);t._hideProcessing()},loadNewerDocuments:function(n,t){var i=this;$("#toolbar-important, #toolbar-unread").removeClass("active");this.isImportantFiltering=!1;this.isUnreadFiltering=!1;this.pageCurrent=1;this.isClientFilter&&this.filterTerm!=""?this.renderClientFilter(this.filterTerm):this._getLastestDocumentsInTree(n,t)},loadNewerDocumentsStore:function(){var n=this;if(egov.isMobile){this.model.models.length>0&&this.$el.children().first().tap();return}$("#toolbar-important, #toolbar-unread").removeClass("active");this.isImportantFiltering=!1;this.isUnreadFiltering=!1;this.pageCurrent=1;this._getDocumentStore(function(){n.renderDocuments(n.model,!0,!0)})},_getLastestDocumentsInTree:function(n,t){var i=this;this._reloadDocumentTree();this._getLastestDocuments(function(t,r,u,f,e,o){i.hasChanged=!1;var s;t?(s=!1,i.renderDocuments(r,s,e,f,u,t)):(s=!0,i.renderDocuments(i.model,s,e));egov.callback(n,o);i._hideProcessing()},t)},_reloadDocumentTree:function(){egov.pubsub.publish(egov.events.tree.reload,this.node.parentNode?this.node.parentNode.model.id:this.node.model.id)},getTotalDocuments:function(){return this.model.length||0},enableResize:function(){var n=this;this.$el.find("#tblListDocument").grid({isUsingCustomScroll:!1,isResizeColumn:!0,isFixHeightContent:!0,isAddHoverRow:!1,isUseCookie:!0,isRenderPanelGrid:!1,onresizefinish:function(){var i={},t=[],u=0,s=n.$el.find(".grid-header th"),h=n.$el.find(".grid-header colgroup col"),c=n.$el.find(".grid-content table"),f,e,o,r;if(h.each(function(n,r){var f=s.eq(n);$(r).width()==0?t.push(f.attr("data-column")):u+=$(r).width();i[f.attr("data-column")]=$(r).width()}),f=c.width(),t.length>0)for(e=f-u,o=e/t.length,r=0;r<t.length;r++)i[t[r]]=o;egov.locache.hasSupportLocalStorage?egov.localStorage.addDocumentHeaderWidth(n.nodeId,i):egov.cookie.addDocumentHeaderWidth(n.nodeId,i)}});$(".document-preview").bind("mousedown, mousemove",function(){var t=n.$el.find(".grid-content").scrollLeft();n.$el.find(".grid-header-wrap").css({"margin-left":-t})})},renderToolbar:function(n){var u=new egov.models.toolbarList,t,f,r;egov.isMobile?$(".documentlist-filter > li:not(.search, .user-option, .bell)").remove():(t=this,u.add({id:"toolbar-unread",text:i.toolbar.controlName.documentUnread,className:egov.isMobile?"unread":"pull-right",showSelected:!0,icon:"icon-mail5",isImageButton:!0,callback:function(n){t.isUnreadFiltering=n.$el.hasClass("active");t.renderClientFilter()}}),u.add({id:"toolbar-important",text:i.toolbar.controlName.documentImportant,className:egov.isMobile?"important":"pull-right",showSelected:!0,icon:"icon-flag",isImageButton:!0,callback:function(n){t.isImportantFiltering=n.$el.hasClass("active");t.renderClientFilter()}}),u.add({text:i.toolbar.controlName.refresh,className:egov.isMobile?"refresh ":"pull-right",showSelected:!0,icon:egov.isMobile?"icon-cw":"icon-cw",isImageButton:!0,callback:function(n){t._showProcessing();t.isImportantFiltering=!1;t.isUnreadFiltering=!1;t.pageCurrent=1;t.sorting=t.defaultSorting;t._getLastestDocuments(function(){t.renderClientFilter();n.$el.removeClass("active");$("#toolbar-important,#toolbar-unread").removeClass("active");t._hideProcessing()})}}),u.add({id:"toolbar-quickview",text:i.toolbar.controlName.preview,className:egov.isMobile?"xs-hidden":"pull-right",icon:"icon-info4",isDropdownMenu:!1,selected:egov.enum.quickViewType.hide!==egov.setting.userSetting.quickView,isImageButton:!0,callback:function(n){var r=n.$el.hasClass("active"),i;r?(i=egov.locache.hasSupportLocalStorage?egov.localStorage.getQuickView():egov.cookie.getQuickView(),i?(i=parseInt(i),(isNaN(i)||egov.enum.quickViewType.hide===i)&&(i=egov.enum.quickViewType.below),egov.views.home.showPreview(i)):(i=egov.enum.quickViewType.below,egov.views.home.showPreview(i)),t._reQuickView()):egov.views.home.showPreview(egov.enum.quickViewType.hide);egov.request.setUserConfig({data:{QuickView:egov.setting.userSetting.quickView}})}}),u.add({text:i.toolbar.controlName.setting,className:egov.isMobile?"xs-hidden":"pull-right",icon:"icon-cog",isDropdownMenu:!0,isImageButton:!0,data:[{text:"Xem cỡ nhỏ",value:0},{text:"Xem cỡ vừa",value:1},{text:"Xem cỡ lớn",value:2},{text:"---"},{text:"Xem trước bên phải",value:4},{text:"Xem trước bên dưới",value:5}],callback:function(n,i){if(n.value===egov.enum.fontSizeType.nho||n.value===egov.enum.fontSizeType.vua||n.value===egov.enum.fontSizeType.lon)i.parents(".dropdown-menu").find('li[value="0"], li[value="1"], li[value="2"]').parent().removeClass("active"),egov.views.home.changeSize(n.value),egov.request.setUserConfig({data:{FontSize:n.value}});else if(n.value===4||n.value===5){i.parents(".dropdown-menu").find('li [value="4"], li [value="5"]').parent().removeClass("active");var r=n.value===4?egov.enum.quickViewType.right:egov.enum.quickViewType.below;egov.views.home.showPreview(r);t._reQuickView();egov.request.setUserConfig({data:{QuickView:r},success:function(){egov.locache.hasSupportLocalStorage?egov.localStorage.setQuickView(r):egov.cookie.setQuickView(r)}})}i.parent().addClass("active");$("#toolbar-quickview").addClass("active")}}),this.isDoctypeFilter&&(t=this,t.model.length>0&&(f=t.model.at(0).has("DocTypeName"),f&&u.add({text:i.toolbar.controlName.docTypeName,className:"pull-left",callback:function(n){t.doctypeFiltering=n.value;t.renderClientFilter()},isDropdownMenu:!0,showSelected:!0,isImageButton:!1,data:function(){var r=_.uniq(t.model.models,function(n){return n.get("DocTypeId")}),n=[{text:i.toolbar.controlName.all,value:0,selected:!0}];return r.forEach(function(t){n.push({text:t.get("DocTypeName"),value:t.get("DocTypeId")})}),n}}))),this.isOverdueFilter&&(r=i.toolbar.controlName.day,u.add({text:i.toolbar.controlName.dateAppointed,className:"pull-left",callback:function(n){n.value!==0?(t._showProcessing(),egov.request.getDateAppointed({data:{days:n.value},success:function(n){t.overdueFiltering=new Date(n.year,n.month-1,n.day,23,59,59);t.renderClientFilter()},complete:function(){t._hideProcessing()}})):(t.overdueFiltering=null,t.renderClientFilter())},isDropdownMenu:!0,isImageButton:!1,showSelected:!0,data:[{text:i.toolbar.controlName.all,value:0,selected:!0},{text:"1 "+r,value:1},{text:"2 "+r,value:2},{text:"3 "+r,value:3},{text:"4 "+r,value:4},{text:"5 "+r,value:5},{text:"6 "+r,value:6},{text:"7 "+r,value:7},{text:"10 "+r,value:8},{text:"15 "+r,value:15},{text:"20 "+r,value:20},{text:"30 "+r,value:30},]})),$(".documentlist-filter li:not(#quickSearch)").remove());this.toolbar=new n({el:".documentlist-filter",model:u,documents:this})},renDocumentsHeader:function(){d(this.columnSetting,this.$el);var t=[],n=this;_.each(this.columnSetting,function(i){t.push({text:i.DisplayName,value:i.SortName==undefined||i.SortName==""?i.ColumnName:i.SortName,isDesc:!1,enableSort:i.EnableSort,callback:function(t){t.enableSort&&(n.sorting=[{columnName:t.value,isDesc:t.isDesc,index:0}],n.renderClientFilter(),n._hideProcessing())}})});this.gridHeader=new b({model:new e(t),parent:n});this.$el.find("table thead").empty().append(this.gridHeader.$el)},setAllSelected:function(){this.model&&this.model.length>0&&this.model.each(function(n){n.get("Selected")==!1&&n.set("Selected",!0)})},removeAllSelected:function(){this.model&&this.model.length>0&&this.model.each(function(n){n.get("Selected")==!0&&n.set("Selected",!1)})},reloadColumnWidth:function(){var n=egov.locache.hasSupportLocalStorage?egov.localStorage.getDocumentHeaderWidth(this.nodeId):egov.cookie.getDocumentHeaderWidth(this.nodeId),t;n&&n.length>0&&(t=this,$.each(n,function(n,i){var r=_.find(t.columnSetting,function(t){return t.ColumnName==n});r&&(r.Width=i)}))},rebindUnreadForNode:function(){this.tree.reloadUnread(this.node,this.unread?this.unread:0,this.model?this.model.length:0)},clientQuickSearch:function(n){typeof this.searching!="undefined"&&window.clearTimeout(this.searching);n&&(n=egov.utilities.string.stripVietnameseChars(n.toLowerCase()));var t=this;this.searching=window.setTimeout(function(){t.$el.find("tbody").empty();t.renderClientFilter(n);t._hideProcessing()},300)},contextmenu:function(n,t){var i;if(this.hideAllContextmenu(),i=this.model.select(function(n){return n.get("Selected")==!0}),!i||i.length<=0){egov.pubsub.publish(egov.events.status.error,"Không lấy được contextmenu.");return}var u=[],r=[],f=_.map(i,function(n){return u.push(n.get("DocTypeId")),n.get("IsFile")==1&&r.push(n),n.get("DocumentCopyId")});if(r.length>0){if(i.length>r.length){egov.pubsub.publish(egov.events.status.error,"Danh sách chọn không cùng loai. Vui lòng xem lại.");return}this._contextmenuInFile(n,t,f);return}this._contextmenuInDoc(n,t,f,i,u)},_contextmenuInDoc:function(n,r,u,f,e){var s=this,h,c,o,p,l,w,v,a,y;this.context=r.$el.contextmenu({isShowLoading:!0,style:{"min-width":"150px",width:"auto"},position:{my:"left top",of:n},trigger:"right"});h=$('<img class="loading" src="../Content/Images/ajax-loader.gif" width="20" height="20" style="position:fixed; z-index:100; top:'+(n.clientY-10)+"px; left: "+(n.clientX-10)+'px;" />');h.css({position:"absolute"}).appendTo("body");c=function(){h.remove();s.hideAllContextmenu()};y=this._isChoXuLyOrDuThao(u);egov.dataManager.getDocumentPermission(u,{success:function(n){if(n.error){egov.pubsub.publish(egov.events.status.error,n.error);c();return}o=new egov.models.contextMenuList;p=_.uniq(n);l=new egov.models.documentPermissionList;p.forEach(function(n){l.add({value:n})});s.isStoreTree&&l.add({value:egov.enum.permission.xoavanbankhoihoso});w=new t({collection:l,parent:s});w.getContextmenu(u,f,r,function(n){var t=function(n,t){var l,y,p;if(n.length<=0&&t.length<=0){c();return}if(n.length>0&&n.forEach(function(n){n==="---"||n==null||typeof n!="object"?o.add({name:"---"}):o.add({key:n.commandName,text:n.name,callback:n.callback,iconClass:n.iconClass})}),t.length>0){for(n.length>0&&o.add({name:"---"}),v=e[0],a=egov.enum.actionSpecial,l=[],y=0;y<f.length;y++)p=f[y].toJSON(),p.CategoryId&&l.push(p.CategoryId);l.length>0&&(l=_.uniq(l));o.add({key:a.transferMultiple.name,text:"Duyệt và chuyển theo lô",iconClass:"icon-archive",callback:function(){s.transferMultiple(u,t)}});t.forEach(function(n,i){var r=n.id,f;r===a.luuSoVaPhatHanhNoiBo.name?l.length===1&&o.add({key:r,text:n.name,iconClass:"icon-archive",callback:function(){s.privatePublishTheoLo(u,v,l[0])}}):r===a.luuSoVaPhatHanhRaNgoai.name?l.length===1&&o.add({key:r,text:n.name,iconClass:"icon-archive",callback:function(){s.publishTheoLo(u,v,l[0])}}):o.add({key:r,text:n.name,iconClass:"icon-forward4",callback:function(){s.transferTheoLo(n,u)}});i!==t.length-1&&(f=t[i+1],n.priority!==f.priority&&o.add({name:"---"}))})}o.add({name:"---"});o.add({key:"printTransferHistory",text:i.contextmenu.printTransferHistory,iconClass:"icon-printer",callback:function(){require(["print"],function(n){new n({docCopyId:u,commonTemplate:egov.enum.commonTemplate.InBienNhanBanGiao})})}});u.length==1&&o.add({key:"duplicateDocument",text:i.contextmenu.duplicateDocument,iconClass:"icon-copy",callback:function(){egov.views.home.tab.duplicateDocument(r.model,!0)}});o&&o.length>0?(h.remove(),s.context.model.set("data",o),s.context.render()):c()};y?(h.css({position:"absolute"}).appendTo("body"),s._getActionTheoLoVanBan(u,function(i){h.remove();t(n,i)},function(){c()})):t(n,[])});s._hideProcessing()},error:function(){c();s._hideProcessing()}})},_contextmenuInFile:function(n,t,i){this.context=t.$el.contextmenu({isShowLoading:!0,style:{"min-width":"150px",width:"auto"},position:{my:"left top",of:n},trigger:"right"});this.context.model.set("data",this._getContextFileItems(i));this.context.render()},_getContextFileItems:function(n){var i=egov.resources.document.attachment,t=new egov.models.contextMenuList,r=this;return t.add({text:i.openFile,value:"openattach",iconClass:"icon-eye3",callback:function(){for(var t=0;t<n.length;t++)c(n[t])}}),t.add({text:i.download,value:"download",iconClass:"icon-download4",callback:function(){for(var t=0;t<n.length;t++)rt(n[t])}}),t.add({name:"---"}),t},removeDocumentsAndSetSelected:function(n,t){var i=this,r=function(r){i.removeDocuments(n,t,!0);r&&r.set("Selected",!0)};i.selectedNextCurrent(function(n){r(n)})},removeDocuments:function(n,t,i){var u,e,r,f;!n||n.length<=0||(n instanceof Array||(n=n.toArray()),i&&(u=[],_.each(n,function(n){u.push(n.get("DocumentCopyId"))}),this._hideDocuments(u)),this.model.remove(n),this.model.length===0&&(e=this.columnSetting.length,this.$el.find("tbody").empty().append("<tr><td colspan="+e+">"+egov.resources.documents.noDocumentCopyItem+"<\/td><\/tr>")),r=_.filter(n,function(n){return n.get("IsViewed")==!1}),this.unread||(this.unread=parseInt(this.node.model.get("totalDocumentUnread"))),r&&r.length>0&&(f=this.unread-r.length,this.unread=f>0?f:0),this.rebindUnreadForNode(),this._updateDocumentsToCache(this.model.toJSON(),this.columnSetting,t))},removeDocumentByIds:function(n,t){if(n&&!(n.length<=0)){if(!this.model||this.model.length<=0){this.rebindUnreadForNode();return}var i=this.model.select(function(t){return _.contains(n,t.get("DocumentCopyId"))});this._hideDocuments(n);this.removeDocuments(i,t)}},removeDocumentByIdsAndSetSelected:function(n,t){if(n&&!(n.length<=0)){if(!this.model||this.model.length<=0){this.rebindUnreadForNode();return}var i=this,r=this.model.select(function(t){return _.contains(n,t.get("DocumentCopyId"))}),u=function(u){i._hideDocuments(n);i.removeDocuments(r,t);u&&u.set("Selected",!0)};this.selectedNextCurrent(function(n){u(n)})}},setViewed:function(n,t,i){var r=this;this.setViewedInCache(n,t,function(){var u=[];r._setViewed(n,t,u,function(){var f,n;if(u&&u.length>0){for(f=u.length,n=0;n<f;n++)u[n].set("IsViewed",!t),r.model.findWhere({DocumentCopyId:u[n].get("DocumentCopyId")}).set("IsViewed",!t);r.unread||(r.unread=parseInt(r.node.model.get("totalDocumentUnread")));t==!0?r.unread+=f:r.unread-=f;r.rebindUnreadForNode();r._updateDocumentsToCache(r.model.toJSON(),r.columnSetting,i)}else egov.callback(i);r._hideProcessing()})})},setViewedInCache:function(n,t,i){var r,f,u;if(n instanceof Array&&!(n.length<=0)){for(r=n.length,f=this,u=0;u<r;u++)this.model.findWhere({DocumentCopyId:n[u].get("DocumentCopyId")}).set("IsViewed",t);this.unread||(this.unread=parseInt(this.node.model.get("totalDocumentUnread")));t==!0?this.unread>=r?this.unread-=r:this.unread=0:this.unread+=r;this.rebindUnreadForNode();this._updateDocumentsToCache(this.model.toJSON(),this.columnSetting,i)}},_setViewed:function(n,t,i,r){if(!n||n.length<=0){egov.callback(r);return}var u=this,f=n[0];g(f.get("DocumentCopyId"),t,function(){n.shift();u._setViewed(n,t,i,r)},function(){n.shift();i.push(f);u._setViewed(n,t,i,r)})},finishs:function(n,t,i,r){if(n&&Array.isArray(n)&&!(n.length<=0)){var u=this,f=[];egov.pubsub.publish(egov.events.status.processing,egov.resources.document.finish.processing);u.selectedNextCurrent(function(e){u.removeDocuments(n);require(["docStoreView"],function(o){u.storePrivate||(u.storePrivate=new o);var s=egov.setting.hasHideLuuSo;if(s)return u._finishs(n,null,t,f,function(){f&&f.length>0?(u.model.add(f),u._updateDocumentsToCache(u.model.toJSON(),u.columnSetting,function(){egov.pubsub.publish(egov.events.status.error,egov.resources.document.finish.error);u.renderClientFilter();egov.callback(i)})):(egov.pubsub.publish(egov.events.status.success,egov.resources.document.finish.success),e&&e.set("Selected",!0),egov.callback(i));u._hideProcessing()}),!1;u.storePrivate.renderDialog(function(o){egov.pubsub.publish(egov.events.status.processing,egov.resources.document.finish.processing);var s=function(){u._finishs(n,o,t,f,function(){f&&f.length>0?(u.model.add(f),u._updateDocumentsToCache(u.model.toJSON(),u.columnSetting,function(){egov.pubsub.publish(egov.events.status.error,egov.resources.document.finish.error);u.renderClientFilter();egov.callback(i)})):(egov.pubsub.publish(egov.events.status.success,egov.resources.document.finish.success),e&&e.set("Selected",!0),egov.callback(i));u._hideProcessing()})};r!=undefined&&r.transferType==egov.enum.documentTransferType.banGiaoKhiPhanLoai?r.updateDocument(function(){s()}):s()})})})}},_finishs:function(n,t,i,r,u){if(!n||n.length<=0){egov.callback(u);return}var f=this,e=n[0],o=e.get("DocumentCopyId"),s=e.get("isThongBao")==1?!0:!1;this.$el.find("#documentCopy"+o).fadeOut(500).remove();nt(o,t,i,s,function(){n.shift();f._finishs(n,t,i,r,function(){f.storePrivate&&f.storePrivate.$el.dialog("hide");egov.callback(u)})},function(){n.shift();r.push(e);f._finishs(n,t,r,u)})},reQuickView:function(n){var i=this,t;this.isOnlineRegistration?(t=this.model.findWhere({Id:n}),t&&i._renQuickView(t.toJSON())):egov.request.quickViewDocument({data:{id:n},success:function(n){n&&(n.compendium=unescape(n.compendium),i._renQuickView(n))},error:function(){$(".document-preview").html(egov.resources.documents.message.error.quickView)}})},_reQuickViewQuestionTree:function(n){var t=this;r(egov.template.question.quickView,n.toJSON(),function(){$(".document-preview:visible").find(".btnQuickAnswer").click(function(){var n=$(this).attr("questionId"),t=$(this).closest(".formanswer"),i=t.find(".txtAnswer").val(),r=t.find("#chkIsActive").is(":checked");egov.request.answerQuestion({data:{questionId:n,answer:i,isActive:r},success:function(){$("tr#question-"+n).next().click();$("tr#question-"+n).remove()},error:function(){}})});$(".document-preview:visible").find(".btnShowQuickAnswer").click(function(){$(this).next().slideToggle()})})},_renQuickView:function(n){var t,i=it();if(egov.enum.quickViewType.below===egov.setting.user.userSetting.quickView?t=".document-preview-below":egov.enum.quickViewType.right===egov.setting.user.userSetting.quickView&&(t=".document-preview-right"),n&&i&&t){if(this.isOnlineRegistration){r(egov.template.documentList.quickViewOnlineRegistration,n);return}if(n.type==v.egovOnline){r(egov.template.documentList.quickViewDocumentOnline,n);return}if(egov.setting.user.userSetting.isFullQuickView){require(["documentView"],function(i){$(".document-preview").empty();var r=new i({id:n.id,el:t,tab:null,isCreateDocument:!1,documentViewType:egov.enum.documentViewType.preView});$(".document-preview").bindResources()});return}r(i,n)}},_sortBy:function(){var n=this.sorting;this.model.comparator=function(t,i){for(var u=0,o=0,s=n.length,r,f,e;o<s&&u===0;)r=n[o].columnName,r==="DateReceived1"?(f=Date.parse(t.get(r)),e=Date.parse(i.get(r))):r==="DateCreated"?(f=Date.parse(t.get(r),"dd/MM/yyyy"),e=Date.parse(i.get(r),"dd/MM/yyyy")):r==="InOutCode"?(f=parseInt(t.get(r)),e=parseInt(i.get(r))):(f=t.get(r),e=i.get(r)),f===null||f==""?u=1:e===null||e==""?u=-1:f>e?u=-1:f<e&&(u=1),u=n[o].isDesc?u:-u,o++;return u};this.model.sort()},_getLastestDocuments:function(n,t){var u,r,f,e;this.sorting=this.sorting||this.defaultSorting;u=this.data;r=this;this.model&&this.model.length>0&&(f=this.model.sortBy(function(n){return n.get("DateReceived")}).reverse()[0],f&&(e=f.get("DateReceived1"),e==undefined&&(e=f.get("DateReceived")),u.lastDate=e),u.currentDocCopyIds=this.model.pluck("DocumentCopyId"));egov.request.getLastestDocuments({data:u,success:function(i){var f,u,e;if(i&&i.documents&&typeof i.documents=="object"){if((!r.model||r.model.length<=0)&&(t=!1),t){r.tmpCallback=n;i.documents&&i.documents.length>0&&(r.documentListAdd=r.documentListAdd.concat(i.documents));i.removeds&&i.removeds.length>0&&(r.documentListRemove=r.documentListRemove.concat(i.removeds));f=function(n){(r.documentListAdd&&r.documentListAdd.length>0||r.documentListRemove&&r.documentListRemove.length>0)&&r._addOrRemove(!0,r.documentListAdd,r.documentListRemove,function(n,t,i,u,f){if(typeof r.tmpCallback=="function"){u&&(t=t.reverse());var e=_.pluck(t,"DocumentCopyId"),o=r.model.select(function(n){return _.contains(e,n.get("DocumentCopyId"))});r.tmpCallback(n,o,i,u,f,!0)}r._resetTempDocIsAutoGetNews()},!1,n)};u=!1;f(u);return}r._resetTempDocIsAutoGetNews();u=!0;e=!0;r._addOrRemove(t,i.documents,i.removeds,n,u,e);r._hideProcessing()}},error:function(){n(null,null,null,null,null,!1);egov.pubsub.publish(egov.events.status.error,i.message.error.loadNewerDocuments)}})},_addOrRemove:function(n,t,i,r,u,f){var e=this,h=[],c=[],s=n?!1:!0,o,l,a;i&&i.length>0&&(e.hasChanged=!0,e.model&&e.model.length>0&&(o=e.model.select(function(n){return n.get("Selected")==!0}),o&&o.length>0&&(l=_.filter(o,function(n){return _.contains(i,n.get("DocumentCopyId"))}),s=l.length>0&&o.length===l.length),e.model.remove(i),n&&s&&e.model.length>0&&e.model.at(0).set("Selected",!0)),c=i);t&&t.length>0&&_.each(t,function(n){var t=null;e.model&&e.model.length>0&&(t=e.model.detect(function(t){return t.get("DocumentCopyId")==n.DocumentCopyId}));t?t.set(n):(h.push(n),e.hasChanged=!0,n=new egov.models.document(n),(!e.model||e.model.length<=0)&&(e.model=new egov.models.documentList),e.model.add(n))});(t&&t.length>0||i&&i.length>0)&&u&&e._sortBy();e.hasChanged?(a=e.model.toJSON(),e._updateDocumentsToCache(a,e.columnSetting,function(){typeof r=="function"&&r(n,h,c,f,s,!0)})):typeof r=="function"&&r(n,h,c,f,s,!0)},_getDocuments:function(n,t){var i=this,r=function(){i._getDocumentsFromServer(function(){i._getDocuments(n,!0)})};egov.dataManager.getDocumentsCache({success:function(u){var c,e,o,f;if(!u){r();return}if(u.userId!==egov.setting.userId){r();return}i.cacheDocuments=u;var s=u.localCache,h=s.documentTrees,l=i.nodeId;if(i.isStoreTree&&(h=s.documentStore),c=i.node.model.get("params"),e=_.find(h,function(n){return n.nodeId===l&&n.nodeParams==c}),!e){r();return}if(o=e.documents,(!y||o.length<=0)&&!t){r();return}f=e.settings;i.columnSetting=_.sortBy(f.columnSetting,function(n){return n.Order});i.doctypeColumnSettings=f.doctypeColumnSettings;i.isDoctypeFilter=f.isFilterByDocFieldDocType;i.isOverdueFilter=f.isOverdueFilter;i.isDateFilter=f.isDateFilter;i.dateFilterView=f.dateFilterView;i.dateFilter=f.dateFilter;i.currentPage=f.currentPage;i.pageSize=f.pageSize;i.enablePaging=f.enablePaging;i.model=new egov.models.documentList(o);i._sortBy();egov.callback(n,i.documents)}})},_getDocumentStore:function(n){var t=this,i=this.data;egov.dataManager.getStorePrivateDocuments(i,{success:function(i){var u=JSON.parse(i.documents),r;t.model=new egov.models.documentList(u);t._sortBy();egov.isMobile||(r=h,r||(r=[]),_.find(r,function(n){return n.ColumnName=="STT"})||r.push({ColumnName:"STT",DisplayName:"",Width:30,EnableSort:!1,Order:-1}),t.columnSetting=_.sortBy(r,function(n){return n.Order}));egov.callback(n);t._hideProcessing()}})},reloadQuestionList:function(){var n=this;this._getQuestionList(function(t){n.$el.parent().children().hide();n.renderStore();egov.callback(n.treeCallback,t);n._hideProcessing();n.$el.show()})},_getQuestionList:function(n){var t=this,i=function(i){var u,e,r,f;if(t.docfieldIds){for(u=i.questionListModel,e=[],r=0;r<u.length;r++)u[r].Document&&u[r].Document.ListDocFieldId&&_.contains(u[r].Document.ListDocFieldId,t.docfieldIds)&&e.push(u[r]);i.questionListModel=e}t.model=new egov.models.questionList(i.questionListModel);t._sortBy();f=a;f||(f=[]);t.columnSetting=_.sortBy(f,function(n){return n.Order});t.isGeneralFAQTree&&t.columnSetting.pop();egov.callback(n,t.model?t.model.length:0);t._hideProcessing()};egov.request.getsQuestion({data:{isGetGeneral:t.isGeneralFAQTree},success:function(n){i(n)}})},_getDocumentOnlineRegistration:function(n){var t=this,i=function(i){var u,r;t.node.model.get("isOnlineRegistrationChildren")==!0&&(u=t.node.model.get("functionId"),i=_.filter(i,function(n){return n.DoctypeId==u}));t.model=new egov.models.documentList(i);t._sortBy();r=l;r||(r=[]);egov.isMobile||_.find(r,function(n){return n.ColumnName=="STT"})||r.push({ColumnName:"STT",DisplayName:"",Width:30,EnableSort:!1,Order:-1});t.columnSetting=_.sortBy(r,function(n){return n.Order});egov.callback(n,t.model?t.model.length:0);t._hideProcessing()},r=function(i){if(t.node.model.get("isOnlineRegistrationChildren")==!0){var r=t.node.model.get("functionId");i=_.filter(i,function(n){return n.DoctypeId==r})}t.model=new egov.models.documentList(i);egov.callback(n,t.model?t.model.length:0);t._hideProcessing()};t.DocumentOnlineType==2?egov.request.getDocumentOnlineRegistration({success:function(n){var u=t._processingDataDocumentOnline(n);egov.isMobile?r(u):i(u)}}):egov.request.getDocumentOnlineCancel({success:function(n){var u=t._processingDataDocumentOnline(n);egov.isMobile?r(u):i(u)}})},_processingDataDocumentOnline:function(n){var i=[],t,r;if(n)for(t=0;t<n.length;t++)r=n[t],i.push(r);else return[];return i},_getDocumentsFromServer:function(n){var t=this,i=this.data;egov.dataManager.getDocuments(i,{success:function(i){var u=t.isStoreTree?JSON.parse(i.documents):i.documents,r;t.model=new egov.models.documentList(u);t._sortBy();r=t.isStoreTree?h:i.columnSetting;r||(r=[]);egov.isMobile||_.find(r,function(n){return n.ColumnName=="STT"})||r.push({ColumnName:"STT",DisplayName:"",Width:30,EnableSort:!1,Order:-1});r=_.sortBy(r,function(n){return n.Order});t.isFirstload=!0;u=t.model.toJSON();t._updateDocumentsToCache(u,r,n);t._hideProcessing()}})},_updateDocumentsToCache:function(n,t,i){var r=this.isStoreTree?"documentStore":"documentTrees",e=this.nodeId,o=this,s,u=this.data.paramsQuery,h={columnSetting:t,doctypeColumnSettings:this.doctypeColumnSettings,isDoctypeFilter:this.isDoctypeFilter,isOverdueFilter:this.isOverdueFilter,isDateFilter:this.isDateFilter,dateFilterView:this.dateFilterView,dateFilter:this.dateFilter,currentPage:this.currentPage,pageSize:this.pageSize,enablePaging:this.enablePaging},f=function(){s=o._getNewDocumentCache(n,t,e,u);egov.dataManager.updateDocuments(s,i)};egov.dataManager.getDocumentsCache({success:function(t){var a,s,l,c;if(!t){f();return}if(!t.userId||t.userId!==egov.setting.userId){f();return}if(!t.localCache||t.localCache.length<=0){f();return}if(!t.localCache[r]||t.localCache[r].length<=0){f();return}a=t.localCache;s=a[r];s||(l=o._getNewDocumentCache());c=_.find(s,function(n){return n.nodeId===e&&n.nodeParams==u});c?(n=o.model.toJSON(),c.documents=n,u,c.settings=h):(l={nodeId:e,nodeParams:u,settings:h,documents:n},s.push(l),t.localCache[r]=s);t=$.extend({},t);egov.dataManager.updateDocuments(t,i)}})},_getNewDocumentCache:function(n,t,i,r){var f=this.isStoreTree?"documentStore":"documentTrees",u={userId:egov.setting.userId,localCache:{}},e={nodeId:i,nodeParams:r,settings:{columnSetting:t,doctypeColumnSettings:this.doctypeColumnSettings,isDoctypeFilter:this.isDoctypeFilter,isOverdueFilter:this.isOverdueFilter,isDateFilter:this.isDateFilter,dateFilterView:this.dateFilterView,dateFilter:this.dateFilter,currentPage:this.currentPage,pageSize:this.pageSize,enablePaging:this.enablePaging},documents:n};return u.localCache[f]=[e],u},_getActionTheoLoVanBan:function(n,t,i){if(!n||n.length<=0){egov.callback(t,[]);return}var r=[];egov.request.getActionTheoLoVanBan({data:{documentCopyIds:n},success:function(n){n&&n.error||(r=n);egov.callback(t,r)},error:function(n){egov.callback(i);console.log(n.message)}})},transferTheoLo:function(n,t){if(!t||t.length<=0){egov.pubsub.publish(egov.events.status.error,egov.resources.documents.transfer.notSelectedDocument);return}if(!n){egov.pubsub.publish(egov.events.status.error,egov.resources.documents.transfer.noAction);return}var i=this,u=egov.locache.hasSupportLocalStorage?egov.localStorage.displayPopupTransferTheoLo():egov.cookie.displayPopupTransferTheoLo(),r=function(r){require(["transfer"],function(u){egov.transferForm===undefined&&(egov.transferForm=new u);egov.transferForm.renderTheoLo({action:n,documentCopyIds:t,comment:r,callback:function(){i._removeNotify(t);i.hasPopup=!1},documents:i,callbackCloseForm:function(){i.hasPopup=!1}})})};this.hasPopup=!0;u?this.promptConfirmTransfer({title:egov.resources.documents.transfer.confirmTitle,confirmTitleName:egov.resources.documents.transfer.confirmCheckName,primaryButtonName:egov.resources.documents.transfer.primaryButtonName,callbackPrimary:function(n){r(n)},isCheckNullOrEmpty:!1,callbackConfirm:function(n){egov.request.setUserConfig({data:{DisplayPopupTransferTheoLo:n},success:function(){egov.locache.hasSupportLocalStorage?egov.localStorage.displayPopupTransferTheoLo(n):egov.cookie.displayPopupTransferTheoLo(n)}})},hasAutoComplete:!0,addTemplateButtonName:egov.resources.documents.transfer.addTemplateButtonName,callbackCloseForm:function(){i.hasPopup=!1}}):r(null)},publishTheoLo:function(n,t,i){if(!n||n.length<=0){egov.pubsub.publish(egov.events.status.error,egov.resources.documents.transfer.notSelectedDocument);return}var r=this;require(["publishmentView"],function(u){egov.publishment===undefined&&(egov.publishment=new u);r.hasPopup=!0;egov.publishment.renderTheoLo({docTypeId:t,documentCopyIds:n,parent:r,categoryId:i,callback:function(){r.hasPopup=!1}})})},transferMultiple:function(n,t){if(!n||n.length<=0){egov.pubsub.publish(egov.events.status.error,egov.resources.documents.transfer.notSelectedDocument);return}require(["documentMultipleView"],function(i){new i({ids:n,actions:t})})},showBmm:function(){$("<div style='width: 100%; height: 100%;'><iframe style='width: 100%; height: 100%; border:none;' src='http://quanlynhiemvu.langson.gov.vn/Views/CreateMission.aspx?callBackSuccessful=GetListMissions'><\/iframe><div>").dialog({title:"Tạo nhiệm vụ",height:450,width:1024})},privatePublishTheoLo:function(n,t,i){if(!n||n.length<=0){egov.pubsub.publish(egov.events.status.error,egov.resources.documents.transfer.notSelectedDocument);return}var r=this;require(["privatePublishmentView"],function(u){egov.privatePublishment===undefined&&(egov.privatePublishment=new u);r.hasPopup=!0;egov.privatePublishment.renderTheoLo({docTypeId:t,documentCopyIds:n,parent:r,categoryId:i,callback:function(){r.hasPopup=!1}})})},_noDocumentSelectedQuickview:function(){$(".document-preview").html('<div style="margin-left:10px">'+egov.resources.documentQuickView.noDocumentSelected+"<\/div>")},selectFirstDocumentInList:function(){this.$("tbody tr:first").trigger("click")},setSelected:function(n){var r=this.model.indexOf(this.lastSelected),u=this.model.indexOf(n),f=Math.min(u,r),e=Math.max(u,r)+1,t,i;for(this.removeAllSelected(),t=f;t<e;t++)i=this.model.at(t),i.get("Selected")==!1&&i.set("Selected",!0)},selectAll:function(){!this.model||this.model.length<=0||this.model.each(function(n){n.get("Selected")==!1&&n.set("Selected",!0)})},openDocuments:function(n){if(n&&!(n.length<=0)){egov.helper.hideAllContext();var i=this,t=n[0],e=t.get("DocumentCopyId"),o=t.get("Compendium"),r=n.length===1,f=function(){(n.shift(),i.openDocuments(n),t.get("UserCurrentId")===egov.setting.userId||t.get("Status")!==2&&t.get("Status")!==16)&&(t.get("IsViewed")==!1&&i.setViewedInCache([t],!0),i._hideProcessing())};this.isStoreTree&&t.set("StorePrivateId",this.nodeId);typeof t.get("DocumentCopyId")=="number"?egov.views.home.tab.openDocumentInfo(t,r,function(){u(e);f()}):egov.views.home.tab.openDocumentOnline(t.get("id"),t.get("DocTypeName")+" - "+t.get("PersonInfo"),r,function(){f()})}},_bindEventScroll:function(){var n=this,t=egov.isMobile?this.$el:this.$el.find(".grid-content");t.off("scroll").on("scroll",function(){n.hideAllContextmenu()})},_resetTempDocIsAutoGetNews:function(){this.documentListAdd=[];this.documentListRemove=[];this.tmpCallback=null},hideAllContextmenu:function(){$("img.loading").length>0&&$("img.loading").remove();egov.request&&egov.request.aborts&&(egov.request.aborts.getDocumentPermission&&egov.request.aborts.getDocumentPermission.abort(),egov.request.aborts.getContextItemForUndoTransfering&&egov.request.aborts.getContextItemForUndoTransfering.abort());this.context&&this.context.hide();this._hideProcessing()},_eventKeyboard:function(n,t){var r,i;n&&!egov.isMobile&&(t instanceof jQuery||(t=$(t)),r=egov.views.home.tab.getActiveTab().index(),this.hasPopup||r!==0||(n.keyCode===this.keyCode.enter&&(i=this.model.select(function(n){return n.get("Selected")==!0}),i&&i.length>0&&this.openDocuments(i)),n.ctrlKey&&this.keyCode.a===n.keyCode&&this.selectAll()))},appendBodyEventKey:function(){},_removeNotify:function(n){!n||n.length<=0||(u(n[0]),n.shift(),this._removeNotify(n))},getActionsTheoLo:function(n,t){this._getActionTheoLoVanBan(n,t)},reloadDocuments:function(n,t){this.bindView();this.isStoreTree?this.loadNewerDocumentsStore(n):this.loadNewerDocuments(n,t)},promptConfirmTransfer:function(n){var t={title:"",primaryButtonName:"",callbackPrimary:function(){},isCheckNullOrEmpty:!0,callbackConfirm:function(){},addTemplateButtonName:"",callbackCloseForm:function(){}};t=$.extend(t,n);var u=this,r=$('<div><textarea class="form-control" row="5" style="height: 120px"><\/textarea><\/div>'),i=r.find("textarea");r.dialog({title:t.title,width:"500px",height:"150px",draggable:!0,keyboard:!0,confirm:{id:"confirmTransfer",name:"confirmTransfer",text:t.confirmTitleName,style:{float:"left",display:"inline-block","font-size":"13px","font-weight":"normal"},callback:function(n){typeof t.callbackConfirm=="function"&&t.callbackConfirm(n)}},buttons:[{text:t.primaryButtonName,className:"btn-primary",click:function(){var n=$(i).val();if(t.isCheckNullOrEmpty&&(n===""||n==null)){$(i).addClass("input-validation-error").first().focus();return}typeof t.callbackPrimary=="function"&&t.callbackPrimary(n);r.dialog("destroy")}},{text:t.addTemplateButtonName,click:function(){u._openDialogCommon($(i))}},{text:egov.resources.common.closeButton,className:"btn-close",click:function(){typeof t.callbackCloseForm=="function"&&t.callbackCloseForm();r.dialog("destroy")}}]});this._renderCommonComments($(i));i.focus()},_renderCommonComments:function(n){var t=this;egov.isMobile||egov.dataManager.getCommonComment({success:function(i){egov.dataManager.getTemplateComments({success:function(r){r=_.pluck(r,"Content");r=_.filter(r,function(n){return i.indexOf(n)==-1});r.length>0&&(_.each(r,function(n){i.push(n)}),egov.dataManager.addCommonComment(i,!0));t._renderAutocomplete(n,i)}})}})},_renderAutocomplete:function(n,t){n.length>0&&(n.autocomplete({source:function(n,i){for(var f,e=egov.utilities.string.stripVietnameseChars(n.term).toLowerCase(),u=[],r=0;r<t.length;r++)f=egov.utilities.string.stripVietnameseChars(t[r]).toLowerCase(),f.indexOf(e)!=-1&&u.push(t[r]);i(u)},autoFocus:!0,autoSelectFirst:!0}).data("autocomplete")._renderItem=function(n,t){return n.addClass("dropdown-menu"),$("<li>").data("item.autocomplete",t).append("<a href='#'>"+t.value+"<\/a>").appendTo(n)})},_openDialogCommon:function(n){require(["templateComment"],function(t){new t({callbackInsertComments:function(t){var i=n.val();i?i+="\n"+t:i=t;n.val(i)}})})},exportToExcel:function(){this.exportToFile(1)},exportToWord:function(){this.exportToFile(2)},exportToXML:function(){this.exportToFile(3)},exportToFile:function(n){var t=this.model.select(function(n){return n.get("Selected")==!0}),i=_.map(t,function(n){return n.get("DocumentCopyId")}),r={id:this.data.id,docCopyIds:JSON.stringify(i),paramsQuery:this.data.paramsQuery};require(["filedownload"],function(){var t=n==1?"/Home/ExportDocumentListToExcel/":n==2?"/Home/ExportDocumentListToWord/":"/Home/ExportDocumentListToXML";$.fileDownload(t,{data:r,successCallback:function(){that._hideProcessing()},failCallback:function(n){var i=$(n),t;try{t=JSON.parse(i.text());egov.pubsub.publish(egov.events.status.error,t.error)}catch(r){egov.pubsub.publish(egov.events.status.error,egov.resources.file.errorDownload)}}})})},selectedNextCurrent:function(n){var i,t,r,f,u;!this.model||this.model.length<=0||(i=this.model.select(function(n){return n.get("Selected")==!0}),!i||i.length<=0)||(t=null,r=this.model.indexOf(i[i.length-1]),r<this.model.length-1?t=this.model.at(r+1):(r>0&&r==this.model.length-1&&i.length===1&&this.model.at(r-1).get("Selected")==!1&&(t=this.model.at(r-1)),t||(f=this.model.indexOf(i[0]),f==0?(u=this.model.select(function(n){return n.get("Selected")==!1}),u&&u.length>0?t=u[0]:t==this.model.at(0)):t=this.model.at(f-1))),egov.callback(n,t))},_isChoXuLyOrDuThao:function(n){var i,t;if(!n||n.length<=0||!this.model||this.model.length<=0)return!1;for(typeof n=="object"||n instanceof Array||(n=[n]),i=this.model.select(function(t){return _.contains(n,t.get("DocumentCopyId"))}),t=0;t<i.length;t++)if(i[t].view.isChoXuLyOrDuthao()==!1)return!1;return!0}}),f=Backbone.View.extend({tagName:egov.isMobile?"li":"tr",selectedClass:"rowSelected",documentImportantClass:"document-important",importantClass:"important",unreadClass:"documentUnread",unescapeList:["Compendium"],events:{contextmenu:"contextmenu",click:"selected",dblclick:"dbclick",tap:"openDocument","tap .checkbox":"selected",taphold:"openMultiSelectFunction"},initialize:function(n){var i=this,t;if(this.parent=n.parent,this.columnConfig=n.config,this.unescapeList&&this.unescapeList.length>0)for(t=0;t<this.unescapeList.length;t++)this.model.set(this.unescapeList[t],unescape(this.model.get(this.unescapeList[t])));return this._eventOfProps(),this.render(),this._rebindOverdueAndAppointed(),this.model.view=this,this},_eventOfProps:function(){var n=this;this.model.on("change",function(){});this.model.on("change:IsViewed",function(t,i){i?n.$el.removeClass(n.unreadClass):n.$el.addClass(n.unreadClass)});this.model.on("change:Selected",function(t,i){if(i?n.$el.addClass(n.selectedClass):n.$el.removeClass(n.selectedClass),egov.isMobile&&egov.views.home.documents.isMultiSelecting){i?(n.$el.addClass("showMultiselectCheckBox"),n.$el.find(".checkbox").addClass("checked")):(n.$el.removeClass("showMultiselectCheckBox"),n.$el.find(".checkbox").removeClass("checked"));var r=0,u=n.parent.model.filter(function(n){return n.get("Selected")==!0});if(u&&u.length>0&&(r=u.length),r==0){egov.views.home.multiselectionbar.hideSelectionBar();return}egov.views.home.multiselectionbar.add(t,i,r+"/"+n.parent.model.length)}else n.$el.find(".checkbox").toggleClass("checked"),n.$el.find('.checkbox input[type="checkbox"]').prop("checked",i?!0:!1)})},_rebindOverdueAndAppointed:function(){var n;if(this._setColor(),egov.isMobile){var t=this.model.get("Status"),i=this.model.get("DateOverdue"),r=this.model.get("DateAppointed");t!=2&&i!=""&&(n=egov.commonFn.util.getCustomTime(r,!0),this.model.set("MobileDate",n))}},render:function(){egov.isMobile?this.renderMobile():this.renderDefault()},renderDefault:function(){var i=this,f=this.model.get("Color"),e="document-color-"+f,r="",n;r=this.parent.isQuestionTree?"question-"+this.model.get("QuestionId"):"documentCopy"+this.model.get("DocumentCopyId");this.$el.attr("id",r).addClass(e);this.model.get("IsViewed")||this.$el.addClass("documentUnread");var t=this.model.get("Organization"),u=this.model.get("DocCode"),o=u&&u.indexOf("VPCP")>=0||t&&(t.equals("văn phòng chính phủ",!0)||t.startWith("Bộ"));o&&this.$el.addClass("danger");n=$("<td>");n.append('<div class="icon-color"><\/div>');this.$el.append(n);n.etip();$.each(this.columnConfig,function(n,t){var r=i.model.get(t.ColumnName),u=$("<td>");s.test(r)||r instanceof Date?u.text(Globalize.format(Globalize.parseDate(r),"dd/MM/yyyy HH:mm:ss")):u.text(r?r:"");u.attr("data-column",t.ColumnName);i.$el.append(u)})},renderMobile:function(){var n=this,t;this.$el.addClass("mdl-list__item mdl-list__item--two-line").attr("id","documentCopy_"+this.model.get("DocumentCopyId"));this.$el.addClass(this.model.get("IsViewed")?"":this.unreadClass);require([egov.template.documentList.mobileDocumentItem],function(t){var r,u,f;if(n.parent.isOnlineRegistration)n.model.set("UserCurrentFullName",n.model.get("FullName"));else if(n.parent.isQuestionTree)n.model.set("UserCurrentFullName",n.model.get("AskPeople")),n.model.set("Compendium",n.model.get("Name")),n.model.set("UserAvatar",String.format(egov.setting.avatarPath,n.model.get("Email")));else{var h=n.model.get("UserSendId"),e=n.model.get("UserCurrentFullName"),i=n.model.get("UserCurrentFirstName"),o="../AvatarProfile/noavatar.jpg";h!=undefined?(r=_.find(egov.views.home.documents.allUsers,function(n){return n.value==h}),r==undefined?(e=username,i=username):(e=r.username,i=r.fullname,o=r.avatar)):(u=_.find(egov.views.home.documents.allUsers,function(t){return t.value==n.model.get("UserCurrentId")}),u==undefined?(e=username,i=username):(e=u.username,i=u.fullname,o=u.avatar));n.model.set("UserCurrentFullName",i);n.model.set("UserAvatar",o)}f=n.model.toJSON();Object.getOwnPropertyNames(f).forEach(function(n){var t=f[n];s.test(t)&&(t=Globalize.format(Globalize.parseDate(t),"dd/MM/yyyy HH:mm"));f[n]=t});n.$el.html($.tmpl(t,f));n._setColor()});t=this.$el.find(".document-important");this.model.get("IsDocumentImportant")==!0?t.attr("title",egov.resources.documents.title.documentNotImportant):t.addClass("important").attr("title",egov.resources.documents.title.documentImportant);t.etip()},selected:function(n){egov.helper.hideAllContext();var t=!1;n?(egov.helper.destroyClickEvent(n),n.shiftKey?this.parent.setSelected(this.model):(t=n.ctrlKey||(egov.isMobile?egov.views.home.documents.isMultiSelecting:$(n.target).parents(".checkbox").length>0),t?this.$el.hasClass(this.selectedClass)||this.$el.find(".chkCheck .checkbox").hasClass("checked")?this.unSetSelected():this.setSelected():(this.parent.removeAllSelected(),this.setSelected()))):(this.parent.removeAllSelected(),this.setSelected());egov.isMobile||egov.setting.user.userSetting.quickView===egov.enum.quickViewType.hide||this.showQuickView();(t||n!==undefined&&$(n.target).is(".select-row"))&&n.stopPropagation()},selectedRow:function(n){if(egov.helper.hideAllContext(),!n){this.parent.removeAllSelected();this.setSelected();return}if(n.shiftKey){this.parent.setSelected(this.model);return}var t=n.ctrlKey||(egov.isMobile?$(n.target).is(".select-row"):$(n.target).parents(".checkbox").length>0);t?this.$el.hasClass(this.selectedClass)?this.unSetSelected():this.setSelected():(this.parent.removeAllSelected(),this.setSelected())},dbclick:function(){this.parent.hideAllContextmenu();this.model.get("IsFile")?this.openFile():this.openDocument()},setSelected:function(){this.model.set("Selected",!0);this.draggableSelected();this.parent.lastSelected=this.model},unSetSelected:function(){this.model.set("Selected",!1);this.parent.lastSelected=this.model},toggleSelected:function(){this.model.get("Selected")?this.unSetSelected():this.setSelected()},draggableSelected:function(){var n=this.model.view.$el,t=n.attr("id").replace("documentCopy",""),i=n.find("td[data-column='CitizenName'], td[data-column='Compendium']");i.draggable({helper:"clone",appendTo:"body",zIndex:100,cursor:"move",start:function(){egov.draggingDocumentCopyId=t},stop:function(){}})},openDocument:function(){if(egov.helper.hideAllContext(),egov.mobile&&egov.views.home.documents.isMultiSelecting){this.toggleSelected();return}if(this.parent.isQuestionTree){this._openQuestion();return}if(this.parent.isOnlineRegistration){this._openOnlineRegistration();return}var n=this.model.get("IsDocumentOnline")==1;if(n){this._openDocumentOnLine();return}if(egov.mobile){this._openDocInMobile();return}this._openDocument()},openMultiSelectFunction:function(){if(!egov.views.home.documents.isMultiSelecting){var n=this;egov.views.home.multiselectionbar?egov.views.home.multiselectionbar.showMultiSelectionBar():require(["multiselection"],function(t){egov.views.home.multiselectionbar=new t({documentList:n.parent})});egov.views.home.documents.removeAllSelected();egov.views.home.documents.isMultiSelecting=!0}},openFile:function(){c(this.model.get("DocumentCopyId"))},setImportant:function(n){var t=this.model.get("IsDocumentImportant");this.model.set("IsDocumentImportant",!t);egov.helper.destroyClickEvent(n)},showQuickView:function(n){if(egov.helper.destroyClickEvent(n),this.parent.isOnlineRegistration){this.parent.reQuickView(this.model.get("Id"));return}if(this.parent.isQuestionTree){this.parent._reQuickViewQuestionTree(this.model);return}this.parent.reQuickView(this.model.get("DocumentCopyId"))},finish:function(n){egov.helper.destroyClickEvent(n);this.parent.finishs([this.model])},contextmenu:function(n){(egov.helper.destroyClickEvent(n),egov.isMobile||this.parent.isOnlineRegistration)||(this.model.get("Selected")||this.parent.removeAllSelected(),this.setSelected(),this.parent.contextmenu(n,this))},_openDocInMobile:function(){var t=this.model.get("DocumentCopyId"),i=this.model.get("Compendium"),n=this;egov.mobile.isTablet&&$(".dataDetail").removeClass("display");this.parent.removeAllSelected();require(["tabView"],function(r){var f=new r({model:{id:t,name:i,title:i,href:"tabDocument_"+t,documentInfo:n.model}});u(t);n.setSelected();n.model.get("IsViewed")==!1&&(n.$el.removeClass("unread"),n.parent.setViewed([n.model],!0))})},_openDocument:function(){var n=this,t=this.model.get("DocumentCopyId");this.parent.isStoreTree&&n.model.set("StorePrivateId",this.parent.nodeId);egov.views.home.tab.openDocumentNew(n.model,function(){u(t);n._hasUpdateViewed()&&n.model.get("IsViewed")==!1&&n.parent.setViewed([n.model],!0)})},_openDocumentOnLine:function(){var n=this,t=this.model.get("Status")===2?this.model.get("DocumentCopyId"):this.model.get("Id");egov.views.home.tab.openDocumentOnline(this.model.get("Id"),this.model.get("DocTypeName")+" - "+this.model.get("PersonInfo"),!0,function(){(n.model.get("UserCurrentId")===egov.setting.userId||n.model.get("Status")!==2&&n.model.get("Status")!==16)&&n.model.get("IsViewed")==!1&&n.parent.setViewedInCache([n.model],!0)})},_openOnlineRegistration:function(){egov.views.home.tab.openDocumentOnline(this.model.get("Id"),this.model.get("DocCode"),!0,null,!1,!0)},_openQuestion:function(){egov.views.home.tab.openQuestion(this.model)},_isChoXuLy:function(){var t=this.model.get("Status"),i=this.model.get("UserCurrentId"),r=this.model.get("DocumentCopyType"),n;return t===2&&i===egov.setting.userId&&_.contains([1,2,4,32,64],r)?!0:(n=this.parent.node.model,n.get("hasUyQuyen")&&t===2&&_.contains(n.get("userUyQuyen"),i)&&_.contains([1,2,4,32,64],r))?!0:!1},_hasUpdateViewed:function(){return this.model.get("hasUpdateViewed")==1},_setColor:function(){var f=ut(this.model.get("UrgentId"),this.model.get("DateResponse"),this.model.get("DateOverdue"),this.model.get("DateAppointed"),this.model.get("DocumentCopyType"),this.model.get("IsSupplemented"),this.model.get("Status"),this.model.get("IsSuccess"),this.model.get("IsReturned"),this.model.get("IsGettingOut"),this.model.get("Original")),e=this.model.get("CategoryBusinessId"),r=$("<span>"),u;this.model.set("Color",f);var t="document-color label ",n="",i="";switch(f){case 2:t+="label-success";n+="Đồng XL";i+="Văn bản đồng xử lý, xin ý kiến";break;case 3:t+="label-warning";n="Tới Hạn";i+="Văn bản tới hạn";break;case 4:t+="label-danger";n="Quá Hạn";i+="Văn bản quá hạn";break;case 5:t+="label-warning";n="Khẩn";i+="Văn bản khẩn";break;case 6:t+="label-danger";n="Hỏa tốc";i+="Văn bản Hỏa tốc";break;case 7:t+="label-warning";n="Bổ sung";i+="Hồ sơ chờ bổ sung";break;case 8:t+="label-primary";n="Liên Thông";i+="Hồ sơ / Văn bản đang liên thông";break;case 9:t+="label-default";n="Đã Duyệt";i+="Văn bản đã ký duyệt"}if(n!==""){if(r.addClass(t),r.text(n),r.attr("title",i),egov.isMobile){u=this.$el.find(".document-tags");u.prepend(r);return}u=this.$el.find("td[data-column='Compendium']");e==4&&(u=this.$el.find("td[data-column='CitizenName']"));u.prepend(r);r.etip()}},isChoXuLyOrDuthao:function(){if((this.model.get("Status")===2||this.model.get("Status")===1||this.model.get("Status")===16)&&this.model.get("UserCurrentId")===egov.userId&&_.contains([1,2,4,32,64],this.model.get("DocumentCopyType")))return!0;var n=this.parent.node.model;return n.get("hasUyQuyen")&&(this.model.get("Status")===2||this.model.get("Status")===1)&&_.contains(n.get("userUyQuyen"),this.model.get("UserCurrentId"))&&_.contains([1,2,4,32,64],this.model.get("DocumentCopyType"))?!0:!1}}),w=Backbone.Model.extend({defaults:{text:"",value:"",selected:!1,isDesc:!0,enableSort:!1,callback:null},initialize:function(){}}),e=Backbone.Collection.extend({model:w,initialize:function(){}}),b=Backbone.View.extend({tagName:"tr",initialize:function(n){return n.model instanceof e||(n.model=new e(n.model)),this.model=n.model,this.parent=n.parent,this.render(),this},render:function(){var n=this;this.sortting=!1;this.itemSelected=null;this.model.each(function(t){var i=new k({model:t,parent:n,callback:function(){n.sortting=!1}});n.$el.append(i.$el)})},removeSelected:function(){this.$el.find("a").removeClass("asc desc")}}),k=Backbone.View.extend({tagName:"th",events:{click:"selected"},initialize:function(n){this.model=n.model;this.parent=n.parent;this.callback=n.callback;this.render()},render:function(){this.$el.attr("data-column",this.model.get("value"));this.model.get("enableSort")==!1?this.model.get("value")==="STT"?this.$el.append('<div class="icon-color document-color"><\/div>'):this.model.get("value")==="Color"?this.$el.append('<div class="icon-flag"><\/div>'):this.$el.append(this.model.get("text")):this.$el.append('<a href="#" data-column="'+this.model.get("value")+'" class="sort">'+this.model.get("text")+"<\/a>")},selected:function(n){if(egov.helper.destroyClickEvent(n),!this.parent.sortting&&this.model.get("enableSort")!=!1){if(this.parent.sortting=!0,typeof this.model.get("callback")=="function"){this.parent.removeSelected();var t=this.$el.find("a.sort");this.model.get("isDesc")==!0?(this.model.set("isDesc",!1),t.removeClass("asc desc").addClass("asc")):(this.model.set("isDesc",!0),t.removeClass("asc desc").addClass("desc"));this.model.get("callback")(this.model.toJSON())}egov.callback(this.callback)}}});return p});