(function(n,t,i){"use strict";function c(){window.document.isFocused=!1}function l(){window.document.isFocused=!0}function a(){var n=!1;try{n=typeof window.external.CB_ShowNotify=="function"}catch(t){console.log(t)}return n}function v(n){return typeof n=="function"}function b(n){var i,t;try{i=this;n||(n="../Content/Sound/notify.wav");t=new Audio(n);t.play()}catch(r){}}function k(n){return typeof n=="string"?new Date(n.replace(/T/i," ")):new Date(n)}function d(n,i){if(i==undefined||i==="")return n;var r=t.last(i.split("/"));return n+" đã gửi vào "+g(r)}function g(n){return(n=n.toLowerCase(),n==="inbox")?"Hộp thư đến":n==="sent"?"Hộp thư đi":n==="junk"?"Thư đã xóa":n==="drafts"?"Thư rác":n}var r={getConfig:"/Notification/GetConfig",fetch:"/Parallel/Notification_GetNotSents",getData:"/Notification/GetData",pulling:"/Notification/GetLastestMails",update:"/Notification/Update",removeAll:"/Notification/RemoveAll",remove:"/Notification/Remove",oldAll:"/Notification/OldAll",readAll:"/Notification/ReadAll",read:"/Notification/Read",setBmailFolder:"/Notification/SetMailFolderNotify"},e=function(){this._hasWebNotification=!1;this._instance=null;this._notification=null;this._chromeNotificationTemplateType={basic:"basic",image:"image",list:"list",progress:"progress"};this._chromeNotificationOptions={type:"basic",iconUrl:"",appIconMaskUrl:"",title:"",message:"",contextMessage:"",priority:0,eventTime:0,buttons:[],imageUrl:"",items:[],progress:0,isClickable:!1,requireInteraction:!1};this.Instance=function(){return this._instance||(this._instance=new e,this._checkBrowserNotification()),this};this.show=function(n){if(this._hasWebNotification){var n=this._create(n);return n}};this.showList=function(){};this._create=function(n){var f=n.get("Title"),r=n.get("Body"),e=n.get("Avatar"),u=n.Callback,i=n.get("alternateContent"),t;return i!=undefined&&i!=""&&(r=i),t=new this._notification(f,{body:r,icon:e,silent:!1,sound:"../Content/Sound/notify.wav",requireInteraction:!0}),t.onclick=function(){t.close();v(u)&&u(n)},t};this._checkBrowserNotification=function(){var t=this,n;this._notification=chrome.notifications||window.Notification||window.mozNotification||window.webkitNotification;this._notification||(this._hasWebNotification=!1);n=this._notification.permission;n=="default"?this._notification.requestPermission(function(n){t._hasWebNotification=t.notificationManager.permission!==n}):this._hasWebNotification=n=="granted"}},o=function(){this._isDesktop=!1;this._instance=null;this.type=3;this.Instance=function(){return this._instance||(this._instance=new o,this._isDesktop=this.checkDesktopApp()),this._instance};this.show=function(n){var t=this,r=n.get("Title"),u=n.get("Body"),e=window.location.origin+"/logo.png",o=n.Callback,s=n.get("JsonData"),c=s.SenderUserName,i=n.get("alternateContent"),f;i!=undefined&&i!=""&&(u=i);try{f=[{info:{title:r,content:u,account:"egov",avatar:e,fullname:r,duration:t.type==3?5:0,type:t.type},callback:o,callbackdata:{notificationId:n.get("NotificationId"),type:t.type}}];window.external.CB_ShowNotify(JSON.stringify(f))}catch(h){this._isDesktop=!1;console.log(h)}};this.checkDesktopApp=function(){return a()}},u={mail:{name:"bmail",isActive:!1,displayName:"Thông báo mail",el:".div-bmail-notify",icon:"../Content/bkav.egov/icon egov/egov-11.png",announIcon:"../Content/bkav.egov/icon egov/egov-16.png",total:0,model:[],callback:{frameName:"",api:"readNewMail"},isValidData:function(n){var u=n.title,i=n.folderLocation,r=!1,f=this.followFolders;return u.indexOf("[Spam]")>=0?r:(i.indexOf("/")!=0&&(i="/"+i),t.indexOf(f,i)<0)?r:!0},isFocus:function(){return n(".menu-items .bmail").is(".active")}},egov:{name:"documents",isActive:!1,displayName:"Thông báo xử lý văn bản",el:".div-eGov-notify",icon:"../Content/bkav.egov/icon egov/egov-01.png",announIcon:"../Content/bkav.egov/icon egov/egov-14.png",total:0,model:[],callback:{frameName:"documents",api:"openNotify"},isFocus:function(){return n(".menu-items .egov").is(".active")}},chat:{name:"chat",frameName:"",isActive:!1,displayName:"Thông báo chat",el:".div-chat-notify",icon:"../Content/bkav.egov/icon egov/egov-10.png",announIcon:"../Content/bkav.egov/icon egov/egov-10.png",total:0,model:[],callback:{frameName:"",api:"openChat"},isFocus:function(){return n(".menu-items .chat").is(".active")}}},f=i.Model.extend({defaults:{NotificationId:0,UserId:0,Title:"",Body:"",alternateContent:"",Avatar:"",DateCreated:"",AppName:"",IsNew:!0,IsReaded:!1,OnlyAnnoun:!1,IsCreatedByClient:!1,JsonData:{}}}),s=i.Collection.extend({model:f}),y='<li id="${NotificationId}" app="${AppName}" class="list-group-item {{if IsReaded == false}} unview {{/if}}">  <a href="#" class="open-notify row">    <div class="col-md-3">        <img src="${Avatar}" class="avatar"/>    <\/div>    <div class="col-md-13">         <div>            <div class="notify-usersend">${Title}<\/div>            <div class="notify-content">{{html Body}}<\/div>            <div class="notify-date">${DateCreated}<\/div>         <\/div>    <\/div>    <span class="close-notify" title="Xóa thông báo">x<\/span>    <\/a><\/li>',h=0,p=10,w=i.View.extend({el:"#notificationCenter",events:{"click .notifyBell":"_setOlds"},_isDesktop:!1,_registedApps:{},template:' <a href="#" class="ripple-ef dropdown-toggle" data-toggle="dropdown">     <img src="${icon}" />     <span class="notify-count" data-count="0"><\/span><\/a><div class="dropdown-menu" role="menu">     <div class="headerrow text-right">         <a href="#" class="btnReadAll">Đánh dấu tất cả là đã đọc<\/a>         <a href="#" class="btnCloseAll">Xóa tất cả<\/a>     <\/div>     <ul class="notification list-group"><\/ul>     <div class="text-center loading-image"><\/div><\/div>',model:new s,initialize:function(n){var t=this;t.lastId=0;t.settings=n.settings;t._getNotificationConfig(function(n){t._registedApps=n;t._isDesktop=a()});t.render()},render:function(){var i=this,r,t;i.$(".notifyBell").remove();for(r in i._registedApps)t=i._registedApps[r],t.$el=n(t.el),t.$el.length===0&&(t.$el=n("<li>").addClass("pull-left hidden notifyBell").addClass(t.el).attr("app",r),i.$el.prepend(t.$el)),t.isActive&&t.$el.removeClass("hidden"),t.$el.html(n.tmpl(i.template,{icon:t.icon})),t.$count=t.$el.find(".notify-count"),t.$notificationList=t.$el.find(".notification"),t.model=new s,i._bindNotificationItems(t);this.fetch();this._bindEvents();this._registerApiToGlobal();this._registerTriggers()},fetch:function(){var i=this,u;n.ajax({url:r.fetch,success:function(n){u(n)}});u=function(n){n.length>0&&(i.lastId=t.last(n).NotificationId,i.model.add(n))}},_pulling:function(){var t=this;setInterval(function(){n.ajax({url:r.pulling})},6e4);setInterval(function(){t.fetch()},6e4)},_getNotificationConfig:function(n){var f=this,t=f.settings,i,e,r,o;if(!t){n(null);return}i=[];t.hasshowdocumentnotify&&(e=u.egov,e.isActive=!0,i[e.name]=e);t.hasshowmailnotify&&(r=u.mail,r.isActive=!0,r.followFolders=t.mailfoldernotify===undefined?[]:t.mailfoldernotify.toLowerCase().split(","),i[r.name]=r);t.hasshowchatnotify&&(o=u.chat,o.isActive=!0,i[o.name]=o);f.RemoveRead=t.removeread;f.HasShowDesktop=t.hasshowdesktop;f.HasPlaySound=t.hasplaysound;n(i);return},_bindNotificationItems:function(n){var i=this,t=[];n.$notificationList.empty();this._changeNotifyTotal(n);this.model.each(function(i){i.get("AppName")==n.name&&t.push(i.toJSON())});t=t.reverse();n.$notificationList.html(i._parseNotifyItems(t))},_showNotificationLists:function(n){n.$el.click();n.$el.addClass("open")},_parseNotifyItems:function(t){var r=this,i;return t.defaultAvatar="/AvatarProfile/noavatar.jpg",i=n.tmpl(y,t),i.click(function(n){r._openNotifyInBell(n)}),i.find(".close-notify").click(function(n){r._remove(n)}),i.find(".avatar").error(function(){r.imageError(this)}),i},_bindListAndShowDesktop:function(n,t){var i;if(i=this._getApp(n.get("AppName")),!i)throw"App name không đúng.";this._bindNotificationItems(i);t&&n.get("IsNew")&&this._showDesktop(n)},_changeNotifyTotal:function(n){var t=this.model.where({IsNew:!0,AppName:n.name}).length;n.$count.text(t>99?"99+":t);t>0?n.$count.show():n.$count.hide()},_removeNotify:function(n){var t=n.get("AppName"),i=this._getApp(t);n.view&&n.view.close();this._bindNotificationItems(i)},_registerApiToGlobal:function(){var n=this;window.openNotifyFromExternal=function(t){var i,r;(typeof t=="string"&&(t=JSON.parse(t)),i=n.model.detect(function(n){return n.get("NotificationId")==t.notificationId}),i.length!=0)&&(r=n._getApp(i.get("AppName")),n._openNotify(r,i))};window.registerNotificationApp=function(t){var i=t.AppName,r=n._getApp(i);if(r!=undefined)throw"AppName đã có trong hệ thống";n._registedApps[i]=t;n.render()};window.pushNotifyFromClient=function(t){var i=[];i.push(t);n._postToServer(i);t.IsReaded&&(n._removeSimilarBeforeAdd(t),typeof t!="NotifyModel"&&(t=new f(t)),n.model.add(t))};window.pushNotifyFromServer=function(t){n._removeSimilarBeforeAdd(t);typeof t!="NotifyModel"&&(t=new f(t));n.model.add(t)};window.addBmailNotify=function(t){var i=n._getApp("bmail");if(i!=undefined&&i.isValidData(t)){var u={NotificationType:2,Title:t.fullName,Content:t.title,SenderAvatar:t.avatar,SenderUserName:t.userName,SenderFullName:t.fullName,Date:t.date,ReceiveDate:new Date,MailId:t.mailId,FolderId:t.folderId,FolderLocation:t.folderLocation},f={NotificationId:0,Title:d(t.fullName,t.folderLocation),GroupId:t.mailId,Body:t.title,Avatar:t.avatar,DateCreated:new Date,IsNew:!0,AppName:"bmail",JsonData:JSON.stringify(u)},r=[];r.push(f);n._postToServer(r)}};window.setMailRead=function(t){var i=n.model.detect(function(n){return n.get("GroupId")===t});i!=undefined&&i.set("IsReaded",!0)};window.addChatNotify=function(n){var t={NotificationType:3,Title:n.title,Content:n.content.split("\r\n")[0],SenderAvatar:n.avatar,SenderUserName:n.userName,SenderFullName:n.title,Date:n.date,ReceiveDate:new Date,ChatId:n.messageId,ChatterJid:n.chatterJid,messageId:n.messageId,IsNewChat:!0};t.Content.indexOf("&amp;message=")>=0&&(t.Content=t.Content.split("&amp;message=")[1]);t.Content=escape(t.Content);var i=n.isRead|!1,r=!(n.isMe|i),u=t.Content,f={NotificationId:0,Title:t.Title,Body:u,alternateContent:t.originalContent,Avatar:n.avatar,DateCreated:n.date,AppName:"chat",GroupId:n.chatterJid,IsViewed:!1,IsReaded:i==!0?!0:!1,IsNew:r==!0?!0:!1,JsonData:JSON.stringify(t)};pushNotifyFromClient(f)};window.eGovReadChat=function(t){n.model.each(function(n){n.get("AppName")=="chat"&&n.get("GroupId")==t&&n.set("IsReaded",!0)})};/*@cc_on!@*/!1?(document.onfocusin=l,document.onfocusout=c):(window.onfocus=l,window.onblur=c)},_registerTriggers:function(){var i=this;this.model.on("update",function(f,e){var o=e.changes.added,h,s,l,a,c;o.length>0&&(h=i.HasShowDesktop,s=t.filter(o,function(n){return n.get("IsNew")}),s.length>2&&(l=s[0].get("AppName"),i._showAnnounMessage(l,"Bạn có "+s.length+" thông báo mới."),h=!1),o.forEach(function(n){n.set("DateCreated",k(n.get("DateCreated")).relativeDate());var t=n.get("NotificationId");i.lastId<t&&(i.lastId=t);n.set("Body",unescape(n.get("Body")));i._bindListAndShowDesktop(n,h)}),a=t.find(o,function(n){return n.get("AppName")===u.egov.name}),a&&i._reloadDocumentTree());c=e.changes.removed;c.length>0&&c.forEach(function(t){i._removeNotify(t);var u=t.get("NotificationId");u>0&&n.ajax({url:r.remove,type:"Post",data:{id:t.get("NotificationId")}})})});this.model.on("change:IsReaded",function(t){if(i.RemoveRead){i.model.remove(t);n.ajax({url:r.remove,type:"Post",data:{id:t.get("NotificationId")}});return}var u=i._findNotificationElement(t);u.length>0&&u.removeClass("unview");t.view&&t.view.close();t.get("IsNew")&&(t.set("IsNew",!1),n.ajax({url:r.read,type:"Post",data:{id:t.get("NotificationId")}}))});this.model.on("change:IsNew",function(n){var t=i._getApp(n.get("AppName"));i._changeNotifyTotal(t)})},_reloadDocumentTree:function(){var n,i=this._getApp(u.egov.name),t,r;if(!i||i.isActive===!1)throw"App name không đúng.";(t=window.document.getElementsByName(i.callback.frameName),t!=null&&t.length!=0)&&(n=t[0].contentWindow,n&&n.egov&&n.egov.pubsub&&(r="tree.reload",n.egov.pubsub.publish(r),n.egov.pubsub.publish("tree.reloadSelected")))},_bindEvents:function(){var n=this;n.$(".btnCloseAll").click(function(t){n._removeAll(t)});n.$(".btnReadAll").click(function(t){n._readAll(t)});n.$("ul").scroll(function(t){n._scrollToGetData(t)})},_scrollToGetData:function(t){var r=this,i=n(t.target);i.scrollTop()+i.innerHeight()>=t.target.scrollHeight&&r.getData()},getData:function(){var t=this,i=n("<img/>").attr("src","/Content/Images/ajax-loader-small.gif"),u;n.ajax({url:r.getData,data:{pageIndex:h,pageSize:p},success:function(n){u(n)},beforeSend:function(){t.$(".loading-image").append(i)},complete:function(){i.remove()}});u=function(n){n.length>0&&(t.model.add(n),h++)}},_setOlds:function(t){var f=n(t.target).closest("li"),i=f.attr("app"),u;this.model.each(function(n){n.get("AppName")===i&&n.get("IsNew")==!0&&n.set("IsNew",!1)});u=this._getApp(i);this._changeNotifyTotal(u);n.ajax({url:r.oldAll,type:"Post",data:{appName:i,lastId:this.lastId}})},_removeAll:function(t){var u=n(t.target).closest("li"),i=u.attr("app"),f=this.model.where({AppName:i});this.model.remove(f);n.ajax({url:r.removeAll,type:"Post",data:{appName:i,lastId:this.lastId}})},_readAll:function(t){var u=n(t.target).closest("li"),i=u.attr("app");this.model.each(function(n){n.get("AppName")===i&&n.get("IsReaded")==!1&&n.set("IsReaded",!0)});n.ajax({url:r.readAll,type:"Post",data:{appName:i,lastId:this.lastId}})},_remove:function(t){var u=n(t.target).closest("li"),i=u.attr("id"),f=this.model.detect(function(n){return n.get("NotificationId")==i});this.model.remove(f);n.ajax({url:r.remove,type:"Post",data:{id:i}})},_showAnnounMessage:function(n,t){var i=this._getApp(n),r=new f({NotificationId:0,Title:"Thông báo",Body:t,AppName:n,Avatar:i.AnnounIcon,OnlyAnnoun:!0,JsonData:{}});this._showDesktop(r)},_showDesktop:function(n){if(n.get("IsNew")!=!1){var t=this;if(this._isDesktop){n.Callback="openNotifyFromExternal";n.view=this._showNotifyInDesktop(n);return}if(this._egovTabIsActive(n.get("AppName"))){n.view=this._showNotifyInBrowserTab(n);return}n.Callback=function(n){t._openNotifyDesktop(n)};n.view=(new e).Instance().show(n)}},_showNotifyInBrowserTab:function(){this.HasPlaySound&&b()},_showNotifyInDesktop:function(n){return(new o).show(n)},_openNotifyDesktop:function(n){var t;if(n!=null){if(t=this._getApp(n.get("AppName")),!t||t.isActive===!1)throw"App name không đúng.";if(n.get("OnlyAnnoun")){this._activeTab();return}if(t=this._getApp(n.get("AppName")),!t||t.isActive===!1)throw"App name không đúng.";this._openNotify(t,n)}},_openNotifyInBell:function(t){var i=n(t.target).closest("li"),r=i.attr("app"),u=i.attr("id"),f=this._getApp(r),e=this.model.detect(function(n){return n.get("NotificationId")==u});this._openNotify(f,e)},_openNotify:function(n,t){t&&(this._activeTab(),t.set("IsReaded",!0),this._notifyCallback(n,t))},_notifyCallback:function(n,t){var i,r,u;n.callback&&n.callback.api&&n.callback.api!==""&&(u=function(i){i!==undefined&&(r=i[n.callback.api],v(r)&&r(t.get("JsonData")))},n.callback.frameName==""?(i=window,u(i)):mainApps.openApp(n.name,function(){var t=window.document.getElementsByName(n.callback.frameName);t!=null&&t.length!=0&&(i=t[0].contentWindow,u(i))}))},_postToServer:function(t){t.length!==0&&n.ajax({url:r.update,type:"POST",data:{addeds:JSON.stringify(t)},success:function(){},error:function(){}})},_egovTabIsActive:function(n){var i=window.document.isFocused===!0,t;return i?(t=this._getApp(n),t&&!t.isFocus())?!1:!0:!1},_activeTab:function(){window.focus()},_getApp:function(n){return this._registedApps[n]},_findNotificationElement:function(n){var t=n.get("AppName"),i=n.get("NotificationId"),r=this._getApp(t);return r.$notificationList.find("#"+i)},_removeSimilarBeforeAdd:function(n){var t=this.model.select(function(t){return t.get("AppName")==n.AppName&&t.get("GroupId")==n.GroupId});t.length>0&&this.model.remove(t)},imageError:function(t){n(t).attr("src","/AvatarProfile/noavatar.jpg")},test:function(){this.testInterval;var r=this,n=["tienbv","dambv","tamdn","dunghv","dungnvl","phucnhb","cuongnt","taimv"],i=["Nghẹn ngào giây phút ta chấp nhận sống không cần nhau","Chẳng khác chi trái đất này làm sao tồn tại không có mặt trời","Chỉ biết lặng nhìn em quay lưng bước đi lòng anh thắt lại","Nghĩ đến mình sẽ không gặp lại.","Tình yêu đâu phải ai cũng may mắn tìm được nhau","Chẳng giống như chúng ta tìm được nhau rồi lại hoang phí duyên trời","Lắng Nghe Nước Mắt lyrics on ChiaSeNhac.vn","Tại sao phải rời xa nhau mãi mãi, biết đến khi nào chúng ta","Nhận ra chẳng thể quên được nhau."];this.testInterval=setInterval(function(){var r=t.sample(n),u=t.sample(i);window.pushNotifyFromClient({NotificationId:0,Title:r,GroupId:r,Body:u,Avatar:"https://danhba.bkav.com/avatars/"+r+".bmp",DateCreated:new Date,AppName:"chat",IsNew:!0,JsonData:'{DocumentCopyId: 1778,Compendium: "Phạm Quang Ba (Phòng Khám Nha khoa Sài Gòn Colgate 2) "}'})},5e3)},stopTest:function(){clearInterval(this.testInterval)}});window.eGovNotification=w})(window.jQuery,window._,window.Backbone,window.notify);