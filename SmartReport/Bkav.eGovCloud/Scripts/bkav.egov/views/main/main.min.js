(function(){function w(){for(var e,r,f=document.cookie.split(";"),u=0;u<f.length;u++)e=f[u].indexOf("="),r=e>-1?f[u].substr(0,e):f[u],r=r.trim(),r==="bkavAuthen"&&($.cookie(r,"",{domain:document.domain,path:"/",expires:-1}),$.cookie(r,"",{expires:-1}));logoutDesktop();$(window).on("unload",function(){var i=t.getContentWindow(n);i&&i.egov&&i.egov.dataManager&&i.egov.dataManager.reset({success:function(){window.location.reload(!0)}});t.deleteAllLocalStorage()});i.currentUserName!=undefined&&$.get(i.eGovSso+"/User/Logout?userName="+i.currentUserName,{});window.document.location.href="/account/logout"}function b(){var n=$(".panel-container").layout({resizable:!1,closable:!0,spacing_closed:0,spacing_open:0,west__spacing_open:0,west__size:40,west__zIndex:1,west__paneSelector:".west-panel",center__paneSelector:".center-panel"});$(".center-panel").layout({resizable:!1,closable:!0,spacing_closed:0,spacing_open:0,north__spacing_open:0,north__size:45,north__zIndex:1,north__paneSelector:".site-header",center__paneSelector:".site-center"})}function k(i){var f=t.getContentWindow(n),u;f&&f.egov.views.home.changeSize(i);et("ViewSize",i,365);u=t.getContentWindow(r);u&&(i===0?$("#layout-doc",u.document).removeClass("medium-size large-size"):($("#layout-doc",u.document).removeClass("medium-size large-size"),$("#layout-doc",u.document).addClass(i==1?"medium-size":"large-size")))}function h(){t.openApp(r,function(){window.currentApp.$("#composeMailTab").click()})}function c(i,r,u,f){t.openApp(n,function(){var n=currentApp,e=n.egov.setting.userName,t=[];if(f==undefined||f.length===0){n.egov.views.home.tab.addDocument(i,r,null,!1,null,u);return}$.each(f,function(n,i){t.push({FileName:i.filename,Url:i.filepart})});$.ajax({type:"POST",url:"Attachment/UploadAttachmentInLink",data:{urls:JSON.stringify(t)},success:function(t){var f=[];$.each(t,function(n,t){if(t.error!=="")$(data.id).remove(),egov.message.error(t.name+": "+t.error);else{var i={Id:t.key,Name:t.name,Size:t.size,Extension:t.extension,Versions:[{Version:1,User:e}],isNew:!0};f.push(i)}});n.egov.views.home.tab.addDocument(i,r,null,!1,f,u)},error:function(){}})})}function d(i){t.destroyEvent(i);var r=t.getContentWindow(n);$(window).on("unload",function(){t.deleteAllLocalStorage()});r&&r.egov&&r.egov.dataManager?r.egov.dataManager.reset({success:function(){window.location.reload(!0)}}):window.location.reload(!0)}function g(t){var i=$(".menu-items a.active");i.length!==0&&i.attr("data-ng-app")===n&&currentApp&&currentApp.egov&&currentApp.egov.views.home.documents.clientQuickSearch(t)}function f(){var i=$("#MainSearchQuery").val(),f=parseInt($("#MainSearchType").val()),u=$(".menu-items a.active"),t;if(u.length!==0)if(t=u.attr("data-ng-app"),t===n){if(!currentApp||!currentApp.egov)return;currentApp.egov.views.home.tab.addSearch(i,f)}else t.indexOf(r)>=0&&currentApp.EgovLibrary.doSearch(i)}function e(t,i){var u=!1,r=mainApps.getContentWindow(n);if(r){if(u=r.egov.views.home.tab.hasChangeContent(),u){r.egov.views.home.tab.closeAll(function(){i()});t.preventDefault();return}i()}else i()}function nt(){var t=document.getElementById(n).contentWindow;t.showInstallPlugin()}function tt(n){var h=$(".new-doctypes"),f,t,i,r,e,u,s;if(h.find(".newDocument").remove(),i=$(".pinnedDocTypes"),r=$(".commonDocTypes"),n!==null&&n.length!==0){if(f=_.filter(n,function(n){return n.Pinned}),o(f,i,!0),i.append("<li class='divider'><\/li>"),t=n,e=_.uniq(_.pluck(t,"DocFieldId")),e.length<2||t.length<10){u=$("<ul class='subDoctype'><\/ul>");r.append(u);t=_.reject(n,function(n){return n.Pinned});o(t,u,!1);return}s=_.groupBy(t,function(n){return n.DocFieldName});_.each(s,function(n,t){var u=$.tmpl(p,{DocFieldName:t,Count:n.length}),i;r.append(u);i=u.find(".subDoctype");o(n,i,!1);i.append("<li class='divider'><\/li>");i.hide()});ut()}}function o(n,t,i){(t.empty(),n.length!==0)&&(n=_.sortBy(n,function(n){return n.DocTypeName}),t.html(l(n,i)))}function it(){var n=$(".commonDocTypes");n.find(".docfield-groups > a").click(function(){return $(this).siblings("ul").toggle(),$(this).find(".icon-arrow-down7").length>0?$(this).find(".icon-arrow").removeClass("icon-arrow-down7").addClass("icon-arrow-right7"):$(this).find(".icon-arrow").removeClass("icon-arrow-right7").addClass("icon-arrow-down7"),!1});$(".li-create-new").hover(function(){$(".li-create-new").removeClass("unactive")},function(){$(".li-create-new").addClass("unactive")});$(".doctypesFilter").click(function(n){return n.preventDefault(),n.stopPropagation(),!1});$("#doctypesSearch").keyup(function(){var n=$(this).val();n.length>0?($(".newDocument[name *= '"+n+"']").removeClass("hidden").show(),$(".newDocument").not("[name *= '"+n+"']").hide().addClass("hidden")):$(".newDocument").show().removeClass("hidden");$(".docfieldCount").each(function(){var n=$(this).parents("li.docfield-groups"),t=n.find("ul.subDoctype li.newDocument:not('.hidden')").length;$(this).text(" ("+t+")")})})}function l(n,t){var u=t?v:y,r=$.tmpl(u,n);return r.find(".create-new-document").click(function(){var n=$(this).attr("id"),t=$(this).attr("name");c(n,t);$(".li-create-new").addClass("unactive")}),r.find(".pinDocType").click(function(n){var r,t,u;(n.stopPropagation(),r=$(this).attr("id"),t=_.find(i.doctypes,function(n){return n.DocTypeId==r}),t!=undefined)&&($(this).is(".isPined")||!t.Pinned)&&(rt(r),t.Pinned=!t.Pinned,t.Pinned?(u=l(t,!0),$(".pinnedDocTypes").prepend(u)):$(this).parents(".newDocument").remove())}),r}function rt(n){n!=undefined&&n!==""&&$.ajax({url:"/Account/PinDocType",type:"Post",data:{docTypeId:n}})}function ut(){var n=$(".new-doctypes").find(".divider");n.removeClass("hidden");_.each(n,function(n){$(n).siblings("li").length===0?$(n).addClass("hidden"):$(n).removeClass("hidden")});n.last().addClass("hidden")}function ft(n){if(n===undefined)return null;var t=$(".site-content iframe#"+n);return t===undefined||t.length<=0?null:t[0].contentWindow}function et(n,t,i){var r=new Date,u;r.setTime(r.getTime()+i*864e5);u="expires="+r.toUTCString();document.cookie=n+"="+t+"; "+u}var u=!1,r="bmail",a="chat",n="documents",t=window.mainApps,s={enter:13,f5:116},v='<li class="newDocument" id="${DocTypeId}" name="${DocTypeName}"><a href="#" class="create-new-document" id="${DocTypeId}" name="${DocTypeName}"><span class="icon icon-folder-open"><\/span>${DocTypeName} <img class="pinDocType isPined" src="/Content/Images/Icons/unpin.png" title="Bỏ gắn lên đầu danh sách" id="${DocTypeId}"><\/a><\/li>',y='<li class="newDocument" id="${DocTypeId}" name="${DocTypeName}"><a href="#" class="create-new-document" id="${DocTypeId}" name="${DocTypeName}"><span class="icon icon-folder-open"><\/span>${DocTypeName} <img class="pinDocType" src="/Content/Images/Icons/pin.png" title="Gắn lên trên đầu danh sách" id="${DocTypeId}"><\/a><\/li>',p='<li class="docfield-groups"><a href="#"><span class="icon-arrow icon-arrow-right7"><\/span><span>Lĩnh vực ${DocFieldName}<\/span><span class="docfieldCount"> (${Count})<\/span><\/a><ul class="subDoctype" data-docfieldid="${DocFieldName}" style=""><\/ul><\/li>',i={eGovSso:window.eGovSso,currentUserName:window.currentUserName,init:function(){b();$("#logout, .btnlogout").on("click",function(n){t.destroyEvent(n);w()});$(".avatar").error(function(){$(this).attr("src","/AvatarProfile/noavatar.jpg")});$(".app-size").click(function(){var n=$(this).attr("data-value"),t=n==="small-size"?0:n==="medium-size"?1:2;k(t)});$("li > a.preview").click(function(){var i=$(this).attr("data-value"),t=mainApps.getContentWindow(n);t&&t.egov.views.home.showPreview(i,!0)});$(".create-new").click(function(){h()});$("#resetSystem").on("click",function(n){e(n,function(){d(n)})});$("#MainSearchQuery").on("click",function(){$(this)[0].setSelectionRange(0,$(this).val().length)});$(".form-group .search-btn").click(function(){f()});$("#installPlugin").on("click",function(){nt()});$(".search-type-btn a[role=menuitem]").click(function(){$("#MainSearchType").val(parseInt($(this).data("value")));$("#MainSearchQuery").focus()})},initKeyPress:function(){$(document).keyup(function(n){var t=$("#MainSearchQuery").is(":focus");t&&(n.keyCode===s.enter&&f(),g($("#MainSearchQuery").val()))});$(window.document).keydown(function(n){var t=n.keyCode;t===s.f5&&e(n,function(){window.location.reload()})})},initDoctype:function(n){tt(n);it()},initNotifications:function(n){eGovNotification&&(egov.eGovNotification=new eGovNotification({settings:n}))},registerToGlobal:function(){window.readNewMail=function(n){var i,u;typeof n=="string"&&(n=JSON.parse(n));i=n.MailId;u=n.FolderId;t.openApp(r,function(){var n=$("iframe#bmail")[0].contentWindow;_.isFunction(n.readNewMail)&&n.readNewMail(i,u)})};window.createNewMail=function(){h()};window.openChat=function(n){var i;typeof n=="string"&&(n=JSON.parse(n));i=n.ChatterJid;t.openApp(a,function(){var n=$("iframe#chat")[0].contentWindow;n.btalk&&n.btalk.APPVIEW&&n.btalk.APPVIEW.notificationClick({chatterJid:i})})};window.addDocument=function(n,t,i,r){c(n,t,i,r)};window.openDocument=function(t,i){mainApps.openApp(n,function(){var n=currentApp.egov;n.views.home.tab.openDocument(t,i)})};window.getDeptAndUsers=function(t){var i,r;if(_.isFunction(t)){if(i=mainApps.getContentWindow(n),!i||!i.egov||!i.egov.dataManager){t([]);return}r=function(n,i,r){var u=[];_.each(i,function(t){var f=_.filter(r,function(n){return n.departmentid===t.value}),e=_.filter(n,function(n){return _.pluck(f,"userid").indexOf(n.value)>-1}),i=[];_.each(e,function(n){i.push({Username:n.username,FullName:n.fullname})});u.push({DepartmentId:t.value,ParentId:t.parentid,DepartmentName:t.data,DepartmentIdExt:t.idext,DepartmentPath:t.label,Order:t.order,Level:t.level,Users:i})});t(JSON.stringify(u))};i.egov.dataManager.getAllUsers({success:function(n){i.egov.dataManager.getAllDept({success:function(t){i.egov.dataManager.getAllUserDeptPosition({success:function(i){r(n,t,i)}})}})}})}};window.logoutDesktop=function(){var n,t,i;window.external&&_.isFunction(window.external.CB_LoginSuccess)&&(n=[],t={user:window.currentUserName,password:"",remember:"true"},n.push(t),i=JSON.stringify(n),window.external.CB_LoginSuccess(i))};window.onSearchDocumentBegin=function(){f()};window.saveChangeBeforeUnload=function(n){e(n,function(){window.location.reload()})};window.changeBmailResource=function(){}},showTooltip:function(){var n=function(n){n.qtip({position:{at:"center right",my:"left center"}})},t=$(".setting-items > a");t.each(function(){n($(this))})}};$(function(){i.init();i.registerToGlobal();i.initKeyPress();i.showTooltip();setInterval(function(){$.get("/home/CheckConnection")},3e4);window.egovMain=i});jQuery.fn.editor=function(n,t){if(this){var r=this,i=mainApps.getContentWindow("documents"),u=!1;if(n=="destroy")return;i.Aloha&&i.Aloha.$toolbar&&(u=!0,n.find(i.Aloha.$toolbar).length==0&&n.html(i.Aloha.$toolbar));i.Aloha.ready(function(){i.Aloha.jQuery(r).aloha();$(r).attr("spellcheck",!1);u||(i.Aloha.trigger("aloha-editable-activated",{oldactive:undefined,editable:i.Aloha.editables[0]}),n.html(i.Aloha.$toolbar));typeof t=="function"&&t()})}}})();