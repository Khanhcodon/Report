define([egov.template.tab.desktop],function(n){"use strict";function o(n){var i,t;if(n.length<=r)return n;if(i=n.charAt(r),t=n.substring(0,r),i==" ")return t;var u=r-t.lastIndexOf(" "),e=n.substring(r,n.length),f=e.indexOf(" ");return f<u?n.substring(0,r+f)+"...":n.substring(0,r-u)+"..."}var t={document:0,store:1,search:2,report:4,print:8,addImagePacket:16},u=egov.resources.file,i=egov.setting.user.userSetting,f=Backbone.View.extend({el:egov.isMobile?"#document-detail":"#ulTabs",firstModel:[],events:{},initialize:function(n){egov.isMobile?egov.isMobile&&n.model&&(this.$el=$("#document-detail"),this.initMobile(n)):this.initDefault();egov.views.home.tab=this},initDefault:function(){this.model=new egov.models.TabList;this._eventChange();this.addHome();this.addSearch();this._getTabFomCache();this.$el.bindResources()},_eventChange:function(){var n=this;this.model.on("add",function(t){var i=new e({model:t,tabs:n.model});n.$el.append(i.$el);t.get("hasLoadContent")&&i.active();t.get("isRoot")&&t.get("name")==="home"&&(n.rootTab=i);egov.callback(t.get("callback"),i)});this.model.on("remove",function(t,i){if(t.view.isActivated()){var r;!1||(r=i.at(0));r?r.view.active():$("#documentProcessing").show()}n.resizeTab()})},_getTabFomCache:function(){var n,t,r;if(i.isSaveOpenTab&&(n=[],n=egov.locache.hasSupportLocalStorage?egov.localStorage.getRecentTab(egov.setting.userName):egov.cookie.getRecentTab(egov.setting.userName),n&&n.length>0))for(t=0;t<n.length;t++)r=n[t],r.hasLoadContent=!1,this.model.add(r)},addHome:function(){this.model.add({title:"Báo cáo",name:"home",icon:"home.png",href:"documentProcess",hasTooltip:!1,hasCloseButton:!1,isRoot:!0})},addSearchHome:function(){this.model.add({title:"Tìm kiếm",name:"search",icon:"home.png",href:"searchTab",hasTooltip:!1,hasCloseButton:!1,isRoot:!0,hasLoadContent:!1,type:t.search})},addReportBCTH:function(){var n=this.model.detect(function(n){return n.get("name")==="reportTH"});n?n.view.active():this.model.add({name:"reportTH",title:egov.resources.tab.report.title,icon:"report.png",href:"http://smartnation.bkav.com/reportviewer/ReportGeneral?theme=shine&reportId=255",hasTooltip:!1,hasCloseButton:!1,isRoot:!0,hasLoadContent:!1,type:t.report})},addReport:function(){var n=this.model.detect(function(n){return n.get("name")==="report"});n?n.view.active():this.model.add({name:"report",title:egov.resources.tab.report.title,icon:"report.png",href:"report",url:"/ReportViewer/Index",hasCloseButton:!0,type:t.report})},addPrint:function(){var n=this.model.detect(function(n){return n.get("name")==="print"});n?n.view.active():this.model.add({name:"print",title:egov.resources.tab.print.title,icon:"print.png",href:"printTab",url:"/Print/ExpressPrint",hasCloseButton:!0,type:t.print})},addDocument:function(n,t,i,r,u,f,e,o,s){var l=new egov.models.document({DocTypeId:n,Attachments:u}),h,c;return o&&(l=o),h=new egov.models.TabModel({name:"newDocument"+n,id:n,privateId:n,title:t?t:egov.resources.tab.newDocument,icon:"new-document.png",url:"/Document/Create/"+n,href:"tabContentCreate_"+n,relationId:i,relationType:s,isCreateDocument:!0,hasCloseButton:!0,isPacket:r,attachment:u,contentHTML:f,callback:e,documentInfo:l}),i&&h.set("url",h.get("url")+"&documentCopyRelationId="+i),c=_.filter(this.model.toJSON(),function(n){return n.privateId===h.get("privateId")}),c&&(h.set("href",h.get("href")+"_"+c.length),h.set("id",h.get("id")+"_"+c.length)),this.model.add(h),h},duplicateDocument:function(n,t,i){var h=this,c,r,e,o,u,f,s;if(r=n.get("DocTypeId"),e=n.get("Compendium"),c=n.get("DocumentCopyId"),o=function(){u=new egov.models.TabModel({name:"newDocument"+r,id:r,privateId:r,title:e?e:egov.resources.tab.newDocument,icon:"new-document.png",url:"/Document/Create/"+r,href:"tabContentCreate_"+r,isCreateDocument:!0,hasCloseButton:!0,callback:i,copiedDocument:s,documentInfo:new egov.models.document({DocTypeId:r})});f=_.filter(h.model.toJSON(),function(n){return n.privateId===u.get("privateId")});f&&(u.set("href",u.get("href")+"_"+f.length),u.set("id",u.get("id")+"_"+f.length));h.model.add(u)},!t){s=n;o();return}egov.request.editNew({data:{id:c},success:function(n){if(n){if(n.error){egov.pubsub.publish(egov.events.status.error,n.error);return}s=new egov.models.document(n.document);o()}},error:function(){$(egov.views.home.tree.documentList).addClass("display");egov.pubsub.publish(egov.events.status.error,egov.resources.document.openError)}})},addSearch:function(n,i){var r=this.model.detect(function(n){return n.get("name")==="search"});r&&r.view.close();this.model.add({name:"search",title:"Tìm kiếm",href:"searchTab",type:t.search,hasCloseButton:!0,searchQuery:n,searchType:i})},addImagePacket:function(){var i,n;n=this.model.detect(function(n){return n.get("name")==="addImagePacket"});n&&n.view.active();egov.waitingImagePacket&&(i=_.find(egov.waitingImagePacket,function(n){return!n.opened}));egov.hasImagePacket=i!=null;egov.hasImagePacket&&this.model.add({name:"addImagePacket",title:"Đính kèm ảnh theo lô",href:"imagePacket",type:t.addImagePacket,hasCloseButton:!0})},openDocument:function(n,t){var i=new egov.models.document({DocumentCopyId:n,Compendium:t});this.openDocumentNew(i)},openDocumentNew:function(n,t){var r=n.get("DocumentCopyId"),f=this.model.detect(function(n){return n.get("name")==="document"+r}),u;if(f){f.view.active();typeof t=="function"&&t();return}u={name:"document"+r,id:r,privateId:r,title:n.get("Compendium")?n.get("Compendium"):egov.resources.tab.newDocument,icon:"document.png",hasCloseButton:!0,url:"/Document/Edit/"+r,href:"tabContentEdit_"+r,documentInfo:n,callback:function(){typeof t=="function"&&t()},hasLoadContent:!0,checkSuccessed:!0};this.model.add(u);i.isSaveOpenTab&&this.save(u)},openDocumentInfo:function(n,t,r){var u,f,e;if(i.ViewDocInPopUp){require(["egovPopup"],function(){var t="/Document/EditNew/?id="+n.get("DocumentCopyId")+"&isPopup=true";egov.popup.open(t,n.get("Compendium"))});return}if(u=n.get("DocumentCopyId"),f=this.model.detect(function(n){return n.get("name")==="document"+u}),f){t&&f.view.active();typeof r=="function"&&r();return}e={name:"document"+u,id:u,privateId:u,title:n.get("Compendium"),icon:"document.png",hasCloseButton:!0,url:"/Document/Edit/"+u,href:"tabContentEdit_"+u,documentInfo:n,callback:function(){typeof r=="function"&&r()},checkSuccessed:!0,hasLoadContent:t};this.model.add(e);i.isSaveOpenTab&&this.save(e)},openMultiDocument:function(n,t){var e,u,r,o,f;if(n&&!(n.length<=0)){if(t=t||!1,e=this,t){r=n[0];this.openDocument(r.id,r.title,function(){n=n.shift();e.openMultiDocument(n,t);egov.callback(r.callback)});return}for(u=0;u<n.length;u++)r=n[u],o=this.model.detect(function(n){return n.get("name")==="document"+r.id}),o||(f={name:"document"+r.id,id:r.id,privateId:r.id,title:r.title,icon:"document.png",hasCloseButton:!0,url:"/Document/Edit/"+r.id,href:"tabContentEdit_"+r.id,callback:function(){egov.callback(r.callback)},hasLoadContent:u===n.length-1},this.model.add(f),i.isSaveOpenTab&&this.save(f))}},openQuestion:function(n,t){var u;egov.isMobile&&this.openQuestionMobile(n,t);var i=n.get("QuestionId"),f=n.get("Name"),r=this.model.detect(function(n){return n.get("name")==="question"+i});if(r){r.view.active();return}u={name:"question"+i,id:i,privateId:i,title:f,hasCloseButton:!0,icon:"document.png",href:"tabQuestion_"+i,isQuestionMode:!0,question:n,callback:function(){egov.callback(t)}};this.model.add(u)},openDocumentOnline:function(n,t,r,u,f,e){var s=this.model.detect(function(t){return t.get("name")==="document"+n}),o;if(s){s.view.active();return}o={name:"document"+n,id:n,privateId:n,title:t,hasCloseButton:!0,icon:"document.png",url:"/Document/Edit/"+n,href:"tabContentOnlineEdit_"+n,isDocumentOnline:!0,isOnlineRegistration:e,callback:function(){egov.callback(u)},hasLoadContent:r};this.model.add(o);i.isSaveOpenTab&&f&&this.save(o)},resizeTab:function(){var t=95,r=$(document).outerWidth(),i=this.model.length,u=i-1,f=r-10-u,n=Math.floor(f/i)-12;n>t&&(n=t);this.model.each(function(t){t.view.setWidth(n)})},save:function(n){egov.locache.hasSupportLocalStorage?egov.localStorage.addRecentTab(egov.setting.userName,n):egov.cookie.addRecentTab(egov.setting.userName,n)},initMobile:function(n){if(n.question){this.openQuestionMobile(n.question);return}this.model=new egov.models.TabModel(n.model);this.renderMobile()},renderMobile:function(){var n=this,t=n.model.get("id");n.$(".tabdocument").removeClass("display").hide();this.model.get("isCreate")?(n.$(".addDocument").remove(),require(["documentViewMobile"],function(i){egov.mobile.showDetailPage();var r=new i({id:t,isCreate:!0,parent:n,tab:n,documentInfo:new egov.models.document({DocTypeId:t})});r.$el.addClass("addDocument display");n.$el.append(r.$el);egov.mobile.current.tab=r.$el})):this.hasRenderTab("#tabDocument_"+this.model.get("id"))||(n.$el.append("<div id= "+n.model.get("href")+" class='display tabdocument'><\/div>"),require(["documentViewMobile"],function(i){egov.mobile.showDetailPage();var r=new i({id:t,el:"#"+n.model.get("href"),parent:n,tab:n,documentInfo:n.model.get("documentInfo")});r.$el.addClass("display");n.$el.append(r.$el);egov.mobile.current.tab=r.$el}))},openQuestionMobile:function(n,t){var r=n.get("QuestionId"),i;this.hasRenderTab("#tabQuestion_"+r)||(i=this,require(["documentView"],function(u){var f=new u({id:r,el:"#"+i.model.href,question:n,callback:function(){egov.callback(t)}});i.$el.append("<div id="+i.model.href+" class='display tabdocument'>"+f.$el+"<\/div>")}))},hasRenderTab:function(n){var t=$(n),i;if(egov.mobile.isTablet&&t.hasClass("display")){t.closest(".dataDetail").addClass("display");return}return egov.mobile.isTablet||(egov.commonFn.event.hideNavbar(),$(".dataList").removeClass("display")),$(".dataDetail").addClass("display"),this.$el.find(".display").removeClass("display"),i=t.length>0,i&&(t.siblings().hide(),t.show().addClass("display"),t.children(".document").addClass("display"),egov.mobile.showDetailPage()),i},removeDisplayingDocument_Mobile:function(){this.$el.children().remove()},removeDocument:function(){if(this.model){var n=this.$el.find("#"+this.model.get("href"));n.length>0&&$(n).remove()}},close:function(){var n=this;setTimeout(function(){n.$el.removeClass(n.displayClass);n.removeDocument()},400)},activeTab:function(n){var t=this.model.models[n];t&&t.view.active()},getActiveTab:function(){for(var t=this.$el.children("li"),n=0;n<t.length;n++)if(t.eq(n).hasClass("active"))return t.eq(n)},openDocumentInNotify:function(){var t=$.cookie("documentNotify"),n,i;t&&(n=JSON.parse(t),i=this,n&&this.openDocument(n.DocumentCopyId,n.Compendium,null,function(){$.cookie("documentNotify","",{expires:-1,domain:document.domain,path:"/",secure:!0})}))},createDocInWaitingPacket:function(n){var t,f,e,o,r,i;if(f=this,egov&&egov.waitingPacket&&egov.waitingPacket.length!=0){if(t=_.find(egov.waitingPacket,function(n){return!n.opened}),!t){if(i=_.find(egov.waitingPacket,function(n){return n.saved}),!i){egov.waitingPacket=undefined;return}f.openDocument(i.documentCopyId,i.title,!0,function(){i.saved=!1});return}if(t.opened=!0,!n){f.addDocument(t.docTypeId,t.title,undefined,!0,t.attachment);return}if(n.attachments.model.add(t.attachment),n.attachmentIdInWaitingPacket=t.attachment.get("Id"),e=n.model.get("DocumentContents")[0],t.attachment.get("Extension").toLowerCase()===".pdf"){egov.request.createImagesFromBeginAndLastPdfPages({data:{id:t.attachment.get("Id")},beforeSend:function(){egov.pubsub.publish(egov.events.status.processing,"Đang xử lý...")},success:function(t){var u,i;if(t)if(t.error)egov.pubsub.publish(egov.events.status.error,t.error);else{for(u=t.images,r="",i=0;i<u.length;i++)o='<div><p><img style="width:100%;" src="'+u[i]+'" /><\/p><\/div>',r=r+o;t.documentInfo&&(n.model.set("Compendium",t.documentInfo.Compendium),n.model.set("DocCode",t.documentInfo.DocCode),n.model.set("Organization",t.documentInfo.Organization),n.model.set("DatePublished",t.documentInfo.DatePublished),n.reRenderInfo());n.model.get("DocumentContents")[0].Content=r+e.Content;n._renderForm()}},error:function(){egov.pubsub.publish(egov.events.status.error,u.errorDownload)},complete:function(){egov.pubsub.publish(egov.events.status.destroy)}});return}}},closeTab:function(n){var r,u,t;if(n&&!(n.length<=0)&&!(this.model.length<=1)){var i=[],f=this.model.length,e=n.length;for(t=0;t<f;t++)if(r=this.model.at(t),!r.get("isRoot"))for(u=0;u<e;u++)if(r.get("id")==n[u]){i.push(r);break}if(i.length>=1)for(t=0;t<i.length;t++)i[t].view.close()}},closeAll:function(n){var t=this;egov.message.show(egov.resources.tab.saveChange,egov.resources.common.alert,egov.message.messageButtons.YesNo,function(){var r=t.model.length,i=0;t.model.each(function(t){i++;t.view.close(!1,!0,null,function(){i===r&&egov.callback(n)})})},function(){egov.callback(n)})},hasChangeContent:function(){var n=!1;return this.model.each(function(t){t.view.document&&t.view.document.hasChange(function(t){n=t;return})}),n}}),e=Backbone.View.extend({tagName:"li",activeClass:"active",container:"#tabContents",events:{"click .close":"close3",mousedown:"clickEvent",click:"active"},initialize:function(n){this.tabs=n.tabs;this.documentInfo=n.model.get("documentInfo");this.copiedDocument=n.model.get("copiedDocument");n.model.get("isQuestionMode")&&(this.question=n.model.get("question"));this.render();this.model.view=this;this.isLoadedContent=this.model.get("isRoot")&&this.model.get("name")==="home"?!0:!1;this.model.on("change:title",function(n,t){this.$("a").text(t)},this);return this},render:function(){if(this.$el.append($.tmpl(n,this.model.toJSON())),this.model.get("hasTooltip")){var t=o(this.model.get("title"));this.$el.attr("title",t);this.$el.addClass("qtooltip");this.$el.etip()}$("#"+this.model.get("href")).length>0?this.content=$("#"+this.model.get("href")):(this.content=$("<div>").addClass("tab-content full-height").attr("id",this.model.get("href")),$(this.container).append(this.content));this.model.get("content")!==""&&this.model.get("content")!==undefined&&(this.content.html(this.model.get("content")),this.isLoadedContent=!0)},active:function(n){n!==undefined&&n.which==2&&(n.preventDefault(),this.close());this.isActivated()||(this.$el.siblings().removeClass(this.activeClass),this.$el.addClass(this.activeClass),this.showContent(),this.model.get("isCreateDocument")||this.content.find("#wrapComment textarea").focus())},insertContent:function(){var n=this.model.get("type");n===t.document?this._insertContentDocument():n===t.search?this._insertContentSearch():n===t.report?this._insertContentReport():n===t.print||n===t.addImagePacket&&this._addImagePacket()},_insertContentDocument:function(){var n=this,t=this.model.get("isCreateDocument"),i=this.model.get("isOnlineRegistration"),r=t?this.model.get("privateId"):this.model.get("id"),u=function(u){var f=new u({id:r,el:"#"+n.model.get("href"),tab:n,isCreate:t,question:n.question,isOnlineRegistration:i,documentInfo:n.documentInfo,copiedDocument:n.copiedDocument,callback:function(){egov.callback(n.model.get("callback"))}});n.document=f;n.isLoadedContent=!0};require(["documentView"],function(n){u(n)})},_insertContentReport:function(){var n=this;require(["reportViews"],function(t){var i=new t({el:"#"+n.model.get("href"),tab:n});n.isLoadedContent=!0})},_insertContentSearch:function(){var n=this;egov.request.quickSearch({data:{query:n.model.get("searchQuery"),type:n.model.get("searchType"),isUseCached:!1},success:function(t){if(egov.pubsub.publish(egov.events.status.destroy),t.TotalResult===1){var i=t.Items[0];n.$el.remove();egov.views.home.tab.openDocument(i.DocumentCopyId,i.DocumentCompendium);return}require(["egovSearch"],function(i){var r=new i({el:"#"+n.model.get("href"),model:t,searchQuery:n.model.get("searchQuery"),searchType:n.model.get("searchType"),isRelationDoc:!1});n.isLoadedContent=!0})},error:function(){egov.pubsub.publish(egov.events.status.error,egov.resources.search.error)}})},_addImagePacket:function(){var n=this;require(["insertImagePacket"],function(t){var i=new t({el:"#"+n.model.get("href"),tab:n});n.isLoadedContent=!0})},reloadContent:function(){this.isLoadedContent=!1;$("#"+this.model.get("href")).empty();this.showContent()},showContent:function(){var n=this;this.content.siblings("div:visible").removeClass("active").hide();this.content.show();this.content.addClass("active");this.isLoadedContent||this.insertContent();this.$el.is('[egovtab="print"]')&&this.reloadContent()},removeContent:function(){var n=this.$el.find("a").attr("href");$(n).length>0&&$(n).remove()},isActivated:function(){return this.$el.hasClass(this.activeClass)},clickEvent:function(n){n&&(egov.helper.destroyClickEvent(n),n.which===1?this.active(n):this.close2(!0))},display:function(n){n?this.$el.removeClass("hidden"):this.$el.addClass("hidden")},errorTab:function(){this.$el.attr("title",egov.resources.document.transferError);this.$("a").css({color:"red"})},close:function(n,t,i,r){var u=this;if(u.tabs.length!==1&&u.model.get("name")!=="home"){if(n||!u.document){u._remove();return}u.document.hasChange(function(n){if(!n){u._remove();return}if(t){u.document.saveDocument(function(){u._remove();egov.callback(r)});return}egov.message.show(egov.resources.tab.saveChange,egov.resources.common.alert,egov.message.messageButtons.YesNo,function(){u.document.saveDocument(function(){u._remove();egov.callback(r)})},function(){u._remove();egov.callback(r)});return})}},close2:function(n){var t=this;if(t.tabs.length!==1&&!t.model.get("isRoot")){if(egov.mobile&&egov.mobile.isTablet){$(egov.views.home.tree.documentDetail).addClass("display");t.$el.append("<h3 class='detaildocumenterror'>"+egov.resources.document.notpermission+"<\/h3>");return}if(!n||!t.document)return t._remove();t.document.hasChange(function(n){if(!n)return t._remove();var i=t.document.isCreate?egov.resources.tab.saveDraft:egov.resources.tab.saveChange;egov.message.show(i,egov.resources.common.alert,egov.message.messageButtons.YesNo,function(){t.document.saveDocument(function(){t._remove()})},function(){t._remove()});return})}},close3:function(){this.close2(!0)},setWidth:function(n){this.$el.width(n)},_remove:function(){var t,n;this.removeContent();this.$el.etip("destroy");this.$el.remove();i.isSaveOpenTab&&(egov.locache.hasSupportLocalStorage?egov.localStorage.deleteRecentTab(egov.setting.userName,this.model):egov.cookie.deleteRecentTab(egov.setting.userName,this.model));t=this;this.document&&this.document.isCreate&&this.document.stores&&this.document.stores.length>0&&(n=_.flatten(_.pluck(t.document.stores,"Codes")),n.length>0&&egov.request.cancelCode({data:{inOutCodes:JSON.stringify(n)},success:function(){}}));this.tabs.remove(this.model);egov.views.home.tab.createDocInWaitingPacket()}}),r=100;return f});