define([egov.template.tree.createPrivateStore,"jstree"],function(n){"use strict";var f=Backbone.View.extend({el:"#newPrivateStore",events:{"click .del-joined":"deleteJoined"},initialize:function(){$("body > #newPrivateStore").length==0&&this.$el.appendTo("body");this.$el.empty();$("#StorePrivateFilterDepartment").length>0&&$("#StorePrivateFilterDepartment").remove();this.template=n;var t=this,i=egov.dataManager;i.getAllUsers({success:function(n){t.allUsers=n;i.getAllDept({success:function(n){t.allDepts=n;i.getAllUserDeptPosition({success:function(n){t.allUserDeptPosition=n;t.render()}})}})}})},render:function(){var n=this,r=n.model.get("userCreated")==undefined?egov.userId:n.model.get("userCreated"),u=_.find(n.allUsers,function(n){return n.value==r}),t,i;n.model.set("userCreatedName",u.fullname);t=this.model.toJSON();this.$el.html($.tmpl(this.template,t));this.$joinedUsers=this.$("#userJoined");this.$joinedPanel=this.$("#tblUserJoined");this.$joinedPanel.empty();this.$name=this.$("#storePrivateName");this.$description=this.$("#descStorePrivate");n.$("#dgUsers").customDropdown({css:{width:300,height:"auto"},target:n.$el});i=function(){n.rebindUserJoined()};this.loadedJsTree||(e($("#StorePrivateFilterDepartment"),!0,!0,!1,n.allDepts,n.allUsers,n.allUserDeptPosition,null,i,n),this.loadedJsTree=!0);n.$joinedUsers.autocomplete({minLength:1,source:_.reject(n.allUsers,function(n){return n.username===egov.setting.userName}),focus:function(){return!1},selectFirst:!0,select:function(t,i){var u,f,e,r;return n.$joinedUsers.val(""),u=i.item.value,f=_.find(userJoined,function(n){return n===u}),f||(e="li#user_"+u,r=$("#StorePrivateFilterDepartment "+e),typeof r!="undefined"&&r.length>0&&$("#StorePrivateFilterDepartment").jstree("check_node",r)),!1}}).data("autocomplete")._renderItem=function(n,t){return n.addClass("dropdown-menu"),$("<li><\/li>").data("item.autocomplete",t).append("<a>"+t.label+"<\/a>").appendTo(n)};$("body").unbind("keydown")},rebindUserJoined:function(){var n=this.model.toJSON();n.userIdJoined&&n.userIdJoined.length>0&&_.each(n.userIdJoined,function(n){var i="user_"+n,t=$("#StorePrivateFilterDepartment #"+i);typeof t!="undefined"&&t.length>0&&$("#StorePrivateFilterDepartment").jstree("check_node",t)});n.deptIdJoined&&n.deptIdJoined.length>0&&_.each(n.deptIdJoined,function(n){var i=n,t=$("#StorePrivateFilterDepartment #"+i);typeof t!="undefined"&&t.length>0&&$("#StorePrivateFilterDepartment").jstree("check_node",t)})},addJoined:function(n){var t="<tr><td>${label}<a href='#' value=${value} {{if idext}} isDept='true' {{/if}} class='del-joined' style = 'float:right'>Xóa<\/a><\/td><\/tr>";this.$joinedPanel.empty();this.$joinedPanel.append($.tmpl(t,n.users));this.$joinedPanel.append($.tmpl(t,n.depts))},deleteJoined:function(n){if(n){$(n.target).parents("tr:first").remove();var i=$(n.target).attr("value"),r=$(n.target).attr("isdept"),u=r?i:"user_"+i,t=$("#StorePrivateFilterDepartment #"+u);typeof t!="undefined"&&t.length>0&&$("#StorePrivateFilterDepartment").jstree("uncheck_node",t)}},setFocus:function(){var n=this.$("input[type=text]").first(),t;n&&n.length>0&&(t=n.val(),n.focus(),t!==null&&t!==""&&n[0].setSelectionRange(t.length,t.length))},serialize:function(){var n;return this.$name.val().trim()===""?(this.$name.addClass("input-validation-error").focus().siblings("span").show(),null):(this.$name.removeClass("input-validation-error").siblings("span").hide(),n=this.getDestination(),this.model.set({storePrivateName:this.$name.val(),descStorePrivate:this.$description.val(),userIdJoined:_.pluck(n.users,"value"),deptIdJoined:_.pluck(n.depts,"value")}),this.model)},selectNode:function(){var n=this.getDestination();this.addJoined(n)},getDestination:function(){var n={users:[],depts:[]},t=this;return $("#StorePrivateFilterDepartment").jstree("get_checked",null,!1).each(function(){var f=$(this),u=this.id,e=f.attr("rel")==="dept",i,r;if(e){if(i=_.find(t.allDepts,function(n){return n.value==u}),i){if(i.idext.indexOf(".")<0){n.isAllUser=!0;return}n.depts.push(i)}}else r=_.find(t.allUsers,function(n){return n.value==u.replace("user_","")}),r&&(_.contains(n.users,r)||n.users.push(r))}),n}}),r='<li id="${value}" label="${attr.label}" rel="${attr.rel}" idext="${attr.idext}" class="jstree-${state}"><ins class="jstree-icon">&nbsp;<\/ins><a href="#" class="">',u;r+='<ins class="jstree-icon">&nbsp;<\/ins>${data}<\/a><\/li>';u='<li id="${value}" rel="${attr.rel}" idext="${attr.idext}" class="jstree-${state}"><ins class="jstree-icon">&nbsp;<\/ins><a href="#" class=""><ins class="jstree-checkbox">&nbsp;<\/ins><ins class="jstree-icon">&nbsp;<\/ins>${data}<\/a><\/li>';var t=["themes","json_data","ui","crrm"],e=function(n,r,u,f,e,s,h,c,l,a){var v=_.find(e,function(n){return n.parentid===0}),y;if(v){y=i(v.value,r,e,s,h);u&&t.push("checkbox");f&&t.push("dnd");n.jstree({json_data:{data:[{data:v.data.toString(),metadata:{id:v.value},state:"closed",attr:{id:v.value,rel:"dept",idext:v.idext,label:v.label},children:y}]},crrm:f==!1?{}:{move:{check_move:function(n){var i=_.find(e,function(t){return t.value===parseInt(n.o.attr("id"))}),t;return i?i.level!=1?!1:(t=this._get_parent(n.o),!t)?!1:(t=t==-1?this.get_container():t,t===n.np)?!0:t[0]&&n.np[0]&&t[0]===n.np[0]?!0:!1:!1}}},dnd:f==!1?{}:{drop_target:!1,drag_target:!1},plugins:t}).bind("loaded.jstree",function(t,i){var f=1;i.inst.get_container().find("li").each(function(){i.inst.get_path($(this)).length<=f&&i.inst.open_node($(this))});n.bind("open_node.jstree",function(n,t){t.inst._get_children(t.rslt.obj).length==0&&o(t.rslt.obj,parseInt(t.rslt.obj.attr("id")),r,u,e,s,h)});egov.callback(l)}).on("check_node.jstree",function(){a.selectNode()})}},i=function(n,t,r,u,f){var e=_.filter(r,function(t){return t.parentid==n}),s=_.filter(f,function(t){return t.departmentid===n}),h,c,o,l;if(e.length>0)for(h=0;h<e.length;h++)(i(e[h].value,!1,r,[],[]).length>0||t&&s.length>0)&&(e[h].state="closed");if(t&&s.length>0)for(c=0;c<s.length;c++)o=_.find(u,function(n){return n.value===s[c].userid}),o&&(l={value:"user_"+o.value,data:o.fullname,parentid:n,state:"leaf",metadata:{id:"user_"+o.value},attr:{id:"user_"+o.value,rel:"people",idext:s[c].idext}},e.push(l));return e},o=function(n,t,f,e,o,s,h){var l=i(t,f,o,s,h),c;l.length>0&&(c=$("<ul><\/ul>"),c.appendTo(n),e?($.tmpl(u,l).appendTo(c),$(n).find("li").each(function(t,i){$(i).addClass(n.hasClass("jstree-checked")?"jstree-checked":"jstree-unchecked")})):$.tmpl(r,l).appendTo(c),c.children("li:last").addClass("jstree-last"))};return f});