define([egov.template.search.main,egov.template.search.result,"validateDateTime"],function(n,t){"use strict";var r=Backbone.View.extend({className:"search-form",template:n,url:"/Document/SearchDocuments",keyCode:{s:83,f:70,esc:27,enter:13,tab:9},documentDetails:[],events:{"click .cbxAdvance":"showHideAdvance","click .btnSearch":"search","click input[type='text']":"_reSelected"},initialize:function(n){this.model=new egov.models.search;this.currentDoc=n.currentDoc;this.render()},render:function(){return this.$el.empty().append(this.template),this.$result=this.$(".searchResult table tbody"),this.$("form").submit(function(){return!1}),this.$el.bindResources(),this},openDialog:function(n){var t=this;this.$el.dialog(n);this.$("#Compendium").focus()},showHideAdvance:function(){this.$(".search-advance").toggle();this.$(".search-advance").is(":hidden")||this._parseValue()},serialize:function(){var n,t;for(n in this.model.attributes)t=this.$("#"+n).val(),t!=0&&this.model.set(n,t)},search:function(){var t=this,n,i,r,f,e;if(!this.isValid()){egov.message.error("Trích yếu không được để trống!");this.$("#Compendium").focus();return}this._disable(!0);this.serialize();this.model.searchType=egov.enum.searchType.document;egov.message.processing(egov.resources.common.searching);egov.request.searchAdvance({data:this.model.toJSON(),success:function(o){if(o.error){t.$result.append($("<tr>").append($('<td colspan="9"><\/td>').text(o.error)));t._disable(!1);return}n=o.Items;r=t.currentDoc.relations.model.models;i=[];n=_.filter(n,function(n){for(var i=0;i<r.length;i++)if(n.DocumentCopyId===r[i].get("RelationCopyId"))return!1;return n.DocumentCopyId!=t.currentDoc.model.get("DocumentCopyId")});for(var s=0;s<n.length;s++)e=new egov.models.search({Address:n[s].ExtendInfo.Address,Compendium:n[s].DocumentCompendium,CategoryName:n[s].ExtendInfo.CategoryName,DateAppointed:n[s].ExtendInfo.DateAppointed,DateArrived:n[s].ExtendInfo.DateArrived,DateCreated:n[s].ExtendInfo.DateCreate,DateReceived:n[s].DateReceived,DocCode:n[s].ExtendInfo.DocCode,DocumentCopyId:n[s].DocumentCopyId,DocumentId:n[s].DocumentId,CurrentUsername:n[s].ExtendInfo.CurrentUsername,Status:n[s].ExtendInfo.Status,CitizenName:n[s].DocumentCompendium,InOutCode:n[s].ExtendInfo.InOutCode,LastUserComment:n[s].ExtendInfo.LastUserComment,UserSuccess:n[s].ExtendInfo.UserSuccess}),i.push(e);if(t.model.set("Result",new egov.models.searchResult(i)),t.$result.empty(),i.length===0){t.$result.append($("<tr>").append($('<td colspan="9"><\/td>').text(egov.resources.search.noresult)));return}t.model.get("Result").each(function(n){f=new u({model:n,parent:t});t.$result.append(f.$el)});t.$("table").table({resizable:!0});t.$(".checkAll").on("click",function(n){t.checkAndUnCheckAll(n)});t._disable(!1)},error:function(){t.$result.append($("<tr>").append($('<td colspan="9"><\/td>').text(egov.resources.search.error)))},complete:function(){egov.message.hide();t._disable(!1)}})},getSelected:function(){return this.model.get("Result").select(function(n){return n.get("IsSelected")})},checkAndUnCheckAll:function(n){var t=$(n.target).closest(".checkAll"),i=!t.hasClass("checked");this.model.get("Result").each(function(n){n.set("IsSelected",i)})},unCheckAll:function(n){var t=$(n.target).closest(".checkAll");this.model.get("Result").each(function(n){n.set("IsSelected",!1)})},isValid:function(){var n=this.$("#Compendium").val()+this.$("#DocCode").val()+this.$("#InOutCode").val();return n!==""},_disable:function(n){n?this.$(".btnSearch").attr("disable",n):this.$(".btnSearch").removeAttr("disable")},_parseValue:function(){var n=this,t;if(n.$("#CategoryId").empty(),egov.locache.get("categories",function(t){n.$("#CategoryId").append(' <option value="0">Tất cả<\/option>');t&&t.length>0&&n.$("#CategoryId").append($.tmpl('<option value="${CategoryId}">${CategoryName}<\/option>',t))}),n.$("#KeyWord").empty(),egov.locache.get("allKeyword",function(t){n.$("#KeyWord").append(' <option value="0">Tất cả<\/option>');t&&t.length>0&&n.$("#KeyWord").append($.tmpl('<option value="${KeyWordId}">${KeyWordName}<\/option>',t))}),n.$("#UrgentId").empty(),egov.locache.get("urgents",function(t){n.$("#UrgentId").append(' <option value="0">Tất cả<\/option>');t&&t.length>0&&n.$("#UrgentId").append($.tmpl('<option value="${value}">${name}<\/option>',t))}),n.$("#DocFieldId").empty(),egov.locache.get("allDocField",function(t){n.$("#DocFieldId").append(' <option value="0">Tất cả<\/option>');t&&t.length>0&&n.$("#DocFieldId").append($.tmpl('<option value="${DocFieldId}">${DocFieldName}<\/option>',t))}),t=egov.locache.get("allUsers"),t&&t.length>0)this.$("input[name='UserSuccessId'], input[name='CurrentUserId']").on("keyup",function(){var i="#"+this.name;n.$(i).val(0);$(this).autocomplete({source:t,select:function(t,r){return this.value=r.item.fullname,n.$(i).val(r.item.value),!1}}).data("autocomplete")._renderItem=function(n,t){return n.addClass("dropdown-menu"),$("<li><\/li>").data("item.autocomplete",t).append("<a>"+t.label+"<\/a>").appendTo(n)}});this.$("#FromDateStr,#ToDateStr").datepicker({showOtherMonths:!0,selectOtherMonths:!0,dateFormat:"dd/mm/yy"});this.$("form").validate({errorPlacement:$.datepicker.errorPlacement,rules:{FromDateStr:{dpCompareDate:["before","#ToDateStr"]},ToDateStr:{dpCompareDate:{after:"#FromDateStr"}}},messages:{FromDateStr:"Ngày bắt đầu không được phép lớn hơn ngày đến!",ToDateStr:"Ngày đến không được nhỏ hơn ngày bắt đầu!"}})},_reSelected:function(n){if(n){var t=$(n.target),i=t.val().length;t[0].setSelectionRange(0,i)}}}),u=Backbone.View.extend({tagName:"tr",template:t,selectedClass:"rowSelected",events:{"click .checkbox":"selectMany",click:"selected",dblclick:"showDetailInfo"},initialize:function(n){this.parent=n.parent;this.$el.append($.tmpl(this.template,this.model.toJSON()));var t=this;this.model.on("change:IsSelected",function(n,i){i?(t.$el.addClass(t.selectedClass),t.$el.find('.checkbox, input[type="checkbox"]').addClass("checked")):(t.$el.removeClass(t.selectedClass),t.$el.find('.checkbox, input[type="checkbox"]').removeClass("checked"))});return this},selected:function(n){!n||this.$(n.taget).parents("th").length>0||(egov.helper.destroyClickEvent(n),n.ctrlKey?this.model.set("IsSelected",!this.model.get("IsSelected")):(this.parent.unCheckAll(n),this.model.set("IsSelected",!0)))},selectMany:function(n){this.model.set("IsSelected",!this.model.get("IsSelected"));egov.helper.destroyClickEvent(n)},showDetailInfo:function(n){if(n){var u=this,t,r;if(egov.helper.destroyClickEvent(n),t=this.model.get("DocumentCopyId"),this.parent.documentDetails&&this.parent.documentDetails.length>0&&(r=_.find(this.parent.documentDetails,function(n){return n.DocumentCopyId===t}),r)){i(r);return}egov.dataManager.getDocumentDetail(t,{success:function(n){if(n.error){egov.message.notification("Văn bản không tồn tại",egov.message.messageTypes.error);return}n.DocumentCopyId=t;u.parent.documentDetails.push(n);i(n)}})}}}),i=function(n){require(["documentDetail"],function(t){var i,r;i=new t({model:n});r={width:800,title:egov.resources.documents.title.documentDetail,buttons:[{text:egov.resources.common.closeButton,className:"btn-close",click:function(){i.$el.dialog("destroy")}}],draggable:!0,keyboard:!0};i.$el.dialog(r)})};return r});