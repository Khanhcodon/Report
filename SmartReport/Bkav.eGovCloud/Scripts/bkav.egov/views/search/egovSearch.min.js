define(["text!templates/search/searchTab.html","text!templates/search/searchDocResult.html","text!templates/search/searchFileResult.html","paging","autocomplete"],function(n,t,i,r){"use strict";var o=Backbone.Model.extend({defaults:{Compendium:"",CategoryId:null,KeyWord:"",Content:"",DocCode:"",InOutCode:"",UrgentId:null,CategoryBusinessId:null,StoreId:null,StorePrivateId:null,CurrentUserId:null,InOutPlaceId:null,FromDateStr:"",ToDateStr:"",FromPubDateStr:"",ToPubDateStr:"",BeforeDate:"",AfterDate:"",OrganizationCreate:"",DocFieldId:null,UserSuccessId:null,Page:1,UserCreateId:null,IsMainProcess:!0,IsUseCached:!1,IsRelationDoc:!1}}),u=100,s=Backbone.View.extend({pluginName:"eOfficePlus",keyCode:{s:83,f:70,esc:27,enter:13,tab:9},preRelationDocItems:[],documentDetails:[],initialize:function(n){this.searchModel=new o;this.searchType=egov.enum.searchType.document;this.currentPage=1;this.FindProcessDocument=egov.setting.user.userSetting.FindProcessDocument;n&&(n.isRelationDoc&&(this.isRelationDoc=n.isRelationDoc,this.currentDoc=n.currentDoc),this.searchType=n.searchType?n.searchType:1,this.searchQuery=n.searchQuery?n.searchQuery:1,this.isLoadedSearchAdvance=!1,this.isQuickSearch=!0,n.model&&(this.model=n.model,this.model.SearchQuery=n.searchQuery,this.pageSize=this.model.Items.length));this.render()},events:{"click #btnAdvanceSearch":"searchAdvance","click #btnAdvanceSearchNew":"searchNew","change #advanceSearch":"toggleSearchAdvanceForm","change #fileSearch":"toggleSearchFileForm","click input[type='text']":"_reSelected","keypress #Compendium":"_keypress","click .sort":"_sort"},render:function(){var t=this,i;if(t.isRelationDoc){t.$el.html($.tmpl(n,{isRelationDoc:!0}));t.$(".checkAll").on("click",function(n){t.checkAndUnCheckAll(n)});t.$("#divSearchFile").hide()}else t.$el.html($.tmpl(n,t.model));this.FindProcessDocument&&this.$("#IsMainProcess").attr("checked","checked");i=new Date;i=i.month(i.month()-12).startOf("month");t.$("#FromDateStr").datepicker({changeMonth:!0,dateFormat:"dd/mm/yy",onClose:function(n){t.$("#ToDateStr").datepicker("option","minDate",n)}}).datepicker("setDate",i);t.$("#ToDateStr").datepicker({changeMonth:!0,dateFormat:"dd/mm/yy",onClose:function(n){t.$("#FromDateStr").datepicker("option","maxDate",n)}}).datepicker("setDate",new Date);t.$approvers=t.$("#UserSuccessId");t.$organization=t.$("#OrganizationCreate");t.$stores=t.$("#StoreId");t.$InOutPlaceId=t.$("#InOutPlaceId");t.$category=t.$("#CategoryId");t.searchType==egov.enum.searchType.document?(t.$("#divSearchFile").hide(),t.$("#Compendium").focus(),t.$("#Compendium").setCursorToTextEnd(),t._renderData()):t.searchType==egov.enum.searchType.file&&(t.$("#divSearchDoc").hide(),t.$("#advanceSearch").prop("disabled",!0),t.$("#Keyword").focus(),t.$("#Keyword").setCursorToTextEnd());t.model&&(t.isRelationDoc||t.renderPager(),t.renderResult());t.$("form").submit(function(n){return t.searchAdvance(),n.preventDefault(),!1})},renderPager:function(){var n=this;n.$(".paging").html(new r({total:n.model.TotalResult,pageSize:u,select:function(t){n._changePage(t)}}).$el);return},renderResult:function(){var n=this,e=n.model.Items,s=[],c,v=n.$("#FromDateStr").val(),y=n.$("#ToDateStr").val(),l,a,u,r,o;if(n.$(".dateRange").html(String.format("Dữ liệu lấy từ <b>{0}<\/b> đến <b>{1}<\/b> (thiết lập lại trong tìm kiếm nâng cao).",v,y)),e.length===0){n.$("#docSearchResult tbody").empty();n.$("#docSearchResult tbody").append("<tr><td colspan='9'>Không có kết quả hợp lệ<\/td><\/tr>");return}if(n.searchType==egov.enum.searchType.document?(n.$("#wrapAttachment").hide(),n.$("#docSearchResult").show(),n.$("#docSearchResult tbody").empty()):n.searchType==egov.enum.searchType.file&&(n.$("#wrapAttachment").show(),n.$("#docSearchResult").hide(),n.$("#wrapAttachment tbody").empty()),this.currentSort&&(e=_.sortBy(e,function(t){return n.currentSort.column==="DateReceived"?Date.parse(t[n.currentSort.column]):t[n.currentSort.column]}),this.currentSort.isDesc&&(e=e.reverse())),n.isRelationDoc){for(n.preRelationDocItems=n.model.Items,u=0;u<e.length;u++)r=e[u],r.Index=(n.currentPage-1)*n.pageSize+u+1,r.isSelected=!1,r.isRelationDoc=n.isRelationDoc,o=new egov.models.search(r),s.push(o),c=new h({model:o,parent:n}),n.$("#docSearchResult tbody").append(c.$el);l=n.model.TotalPage;a=n.model.TotalResult;n.model=new egov.models.search;n.model.TotalPage=l;n.model.TotalResult=a;n.model.set("Result",new egov.models.searchResult(s))}else for(u=0;u<e.length;u++)r=e[u],r.Index=(n.currentPage-1)*n.pageSize+u+1,r.isSelected=!1,r.isRelationDoc=n.isRelationDoc,n.searchType==egov.enum.searchType.document?(r.DocumentCompendium=unescape(r.DocumentCompendium),r.Title=r.DocumentCompendium,o=new f({model:r,template:t,parent:n}),n.$("#docSearchResult tbody").append(o.$el)):n.searchType==egov.enum.searchType.file&&(o=new f({model:r,template:i,parent:n}),n.$("#wrapAttachment tbody").append(o.$el));n.$("#docSearchResult").grid({isUsingCustomScroll:!1,isResizeColumn:!0,isFixHeightContent:!1,isAddHoverRow:!1,isUseCookie:!1,isRenderPanelGrid:!1});n.$el.bindResources()},serialize:function(){var n,t;this.$("#CurrentUser").val()==""&&this.$("#CurrentUserId").val("");this.$("#UserCreate").val()==""&&this.$("#UserCreateId").val("");for(n in this.searchModel.attributes)t=this.$("#"+n).val(),t!==0&&this.searchModel.set(n,t);this.searchModel.set("IsMainProcess",this.$("#IsMainProcess").is(":checked"))},searchAdvance:function(n,t){var i=this,r;return egov.pubsub.publish("status.processing",egov.resources.common.searching),this.isQuickSearch=!1,n||(n=1),t==undefined&&(t=!1),t||(this.currentPage=1,i.$("#btnAdvanceSearchNew").removeClass("hidden")),i.searchType===egov.enum.searchType.document?(i.serialize(),i.searchModel.set("Page",n),i.searchModel.set("IsUseCached",t),egov.request.searchAdvance({data:this.searchModel.toJSON(),success:function(f){var e,s,o;i.isRelationDoc&&(e=f.Items,r=i.currentDoc.relations.model.models,e=_.filter(e,function(n){for(var t=0;t<r.length;t++)if(n.DocumentCopyId===r[t].get("RelationCopyId"))return!1;return n.DocumentCopyId!=i.currentDoc.model.get("DocumentCopyId")}),t&&(s=_.union(i.preRelationDocItems,e),f.Items=s));i.model=f;i.pageSize=u;i.$("#totalResult").text(f.TotalResult);i.isRelationDoc||n!==1||i.renderPager();egov.pubsub.publish("status.destroy");i.renderResult();i.isRelationDoc&&(o=$("#scrollSearchResult").parents(".modal-body"),o.unbind("scroll"),o.scroll(_.debounce(function(){i.scrollLoader(o)},100)))}})):i.searchType===egov.enum.searchType.file&&egov.request.quickSearch({data:{query:i.$("#Keyword").val(),type:i.searchType},success:function(t){i.model=t;i.pageSize=u;i.$("#totalResult").text(t.TotalResult);n===1&&i.renderPager();i.renderResult()}}),!1},searchNew:function(){var n=new Date;return n.month((new Date).month()-12),this.$("#Compendium").val(""),this.$("#DocCode").val(""),this.$("#InOutCode").val(""),this.$("#CategoryId").prop("selectedIndex",0),this.$("#UrgentId").prop("selectedIndex",0),this.$("#StorePrivateId").prop("selectedIndex",0),this.$("#CategoryBusinessId").prop("selectedIndex",0),this.$("#StoreId").prop("selectedIndex",0),this.$("#InOutPlaceId").prop("selectedIndex",0),this.$("#FromDateStr").datepicker("setDate",n),this.$("#ToDateStr").datepicker("setDate",new Date),this.$("#CurrentUser").val(""),this.$("#CurrentUserId").val(""),this.$("#FromPubDateStr").datepicker("setDate",""),this.$("#ToPubDateStr").datepicker("setDate",""),this.$("#UserSuccessId").prop("selectedIndex",0),this.$("#OrganizationCreate").prop("selectedIndex",0),this.$("#UserCreate").val(""),this.$("#UserCreateId").val(""),this.$("#DocFieldId").prop("selectedIndex",0),this.isRelationDoc?this.$("#Compendium").focus():this.searchAdvance(),this.$("#btnAdvanceSearchNew").addClass("hidden"),!1},openDialog:function(n){var t=this;this.$el.dialog(n);n&&n.addCallBack&&n.addCallBack(t.$el);this.$("#Compendium").focus()},scrollLoader:function(n){var t=this,i=n.scrollTop()+10,r=n.prop("scrollHeight")-n.outerHeight();i>=r&&t.currentPage<t.model.TotalPage&&(t.currentPage=t.currentPage+1,t.searchAdvance(t.currentPage,!0))},getSelected:function(){return this.model.get("Result").select(function(n){return n.get("IsSelected")})},checkAndUnCheckAll:function(n){var t=this.$(n.target),i=!t.hasClass("checked");i?t.addClass("checked"):t.removeClass("checked");this.model.get("Result").each(function(n){n.set("IsSelected",i)})},unCheckAll:function(n){var t=$(n.target).closest(".checkAll");t.removeClass("checked");this.model.get("Result").each(function(n){n.set("IsSelected",!1)})},isValid:function(){var n=this.$("#Compendium").val()+this.$("#DocCode").val()+this.$("#InOutCode").val();return n!==""},_disable:function(n){n?this.$(".btnSearch").attr("disable",n):this.$(".btnSearch").removeAttr("disable")},toggleSearchAdvanceForm:function(n){this.$("#fileSearch").is(":checked")||($(n.target).is(":checked")?(this.isLoadedSearchAdvance||(this.bindSearchAdvanceForm(),this.isLoadedSearchAdvance=!0),this.$("#divSearchDoc").show(),this.$("#divSearchAdvance").show()):this.$("#divSearchAdvance").hide())},toggleSearchFileForm:function(n){$(n.target).is(":checked")?(this.searchType=egov.enum.searchType.file,this.$("#divSearchDoc").hide(),this.$("#divSearchAdvance").hide(),this.$("#divSearchFile").show(),this.$("#advanceSearch").prop("disabled",!0)):(this.$("#advanceSearch").prop("disabled",!1),this.searchType=egov.enum.searchType.document,this.$("#divSearchFile").hide(),this.$("#divSearchDoc").show(),this.$("#advanceSearch").is(":checked")?this.$("#divSearchAdvance").show():this.$("#divSearchAdvance").hide())},bindSearchAdvanceForm:function(){var n=this;n.$("#FromPubDateStr").datepicker("destroy");n.$("#ToPubDateStr").datepicker("destroy");n.$("#FromPubDateStr").datepicker({changeMonth:!0,dateFormat:"dd/mm/yy",onClose:function(t){n.$("#ToPubDateStr").datepicker("option","minDate",t)}});n.$("#ToPubDateStr").datepicker({changeMonth:!0,dateFormat:"dd/mm/yy",onClose:function(t){n.$("#FromPubDateStr").datepicker("option","maxDate",t)}})},_changePage:function(n){if(n!=0&&n!==this.currentPage){this.currentPage=n;var t=this;t.isQuickSearch?egov.request.quickSearch({beforeSend:function(){egov.pubsub.publish("status.processing",egov.resources.common.searching)},data:{query:t.searchQuery,type:egov.enum.searchType.document,isUseCached:!0,page:n},success:function(n){t.model=n;t.renderResult()},complete:function(){egov.pubsub.publish("status.destroy")}}):t.searchAdvance(n,!0)}},_sort:function(n){this.isRelationDoc&&(this.model.Items=this.preRelationDocItems);var t=$(n.target).closest(".sort"),r=t.attr("data-column"),i=t.is(".desc");i?t.removeClass("desc").addClass("asc"):t.removeClass("asc").addClass("desc");this.currentSort={column:r,isDesc:!i};this.renderResult()},_reSelected:function(n){if(n){var t=$(n.target),i=t.val().length;t[0].setSelectionRange(0,i)}},_keypress:function(n){var t=n.keyCode;if(t===13)return this.searchAdvance(1,!1),n.preventDefault(),!1},_renderData:function(){var n=this,t=function(t,i,r){n.allUsers=t;n.allJobtitle=i;n.allUserDeptPosition=r;var u=n._getApprovers();n.$approvers.append($.tmpl('<option value="${value}">${fullname} - ${username}<\/option>',u))};egov.dataManager.getAllUsers({success:function(i){n.$("#CurrentUser, #UserCreate").each(function(){var n=$(this);$(this).autocomplete({source:i,focus:function(t,i){return n.val(i.item.label),!1},select:function(t,i){return n.siblings("input:hidden").val(i.item.value),!1}}).data("autocomplete")._renderItem=function(n,t){return n.addClass("dropdown-menu"),$("<li><\/li>").data("item.autocomplete",t).append("<a>"+t.label+"<\/a>").appendTo(n)}});egov.dataManager.getAllJobtitle({success:function(n){egov.dataManager.getAllUserDeptPosition({success:function(r){t(i,n,r)}})}})}});egov.dataManager.getAllAddress({success:function(t){t=_.sortBy(t,function(n){return n.Name});n.$(".addressList").html($.tmpl('<li><a href="#">${Name}<\/a><\/li>',t));n.$(".addressList li").click(function(){n.$organization.val($(this).text())});var i=_.map(t,function(n){return{label:n.Name,value:n.Name}});n.$organization.autocomplete({source:i,focus:function(t,i){return n.$organization.val(i.item.value),!1},select:function(){return!1}}).data("autocomplete")._renderItem=function(n,t){return n.addClass("dropdown-menu"),$("<li><\/li>").data("item.autocomplete",t).append("<a>"+t.value+"<\/a>").appendTo(n)}}});egov.request.GetStores({data:{docTypeId:null},success:function(t){t=_.sortBy(t,function(n){return n.StoreName});n.$stores.append($.tmpl('<option value="${StoreId}">${StoreName}<\/option>',t))}});egov.dataManager.getAllDept({success:function(t){n.$InOutPlaceId.append($.tmpl('<option value="${attr.id}">${data}<\/option>',t))}});egov.dataManager.getCategories({success:function(t){t=_.sortBy(t,function(n){return n.CategoryName});n.$category.append($.tmpl('<option value="${CategoryId}">${CategoryName}<\/option>',t))}});egov.dataManager.getStorePrivate({success:function(t){n.$("#StorePrivateId").append($.tmpl('<option value="${id}">${name}<\/option>',t.storePrivate));n.$("#StorePrivateId").append($.tmpl('<option value="${id}">${name}<\/option>',t.storeShare))}})},_getApprovers:function(){var n=[];if(!n||n.length<=0){var t=[],i=this.allUsers,r=this.allJobtitle,u=this.allUserDeptPosition;u.forEach(function(n){var i=n.jobtitleid,u=_.find(r,function(n){return n.value===i&&n.isApprover});u&&t.push(n.userid)});t=_.uniq(t);n=_.filter(i,function(n){return t.indexOf(n.value)>=0})}return n}}),h=Backbone.View.extend({tagName:"tr",template:t,selectedClass:"rowSelected",events:{"click .checkbox":"selectMany",click:"selected",dblclick:"showDetailInfo"},initialize:function(n){this.parent=n.parent;this.$el.append($.tmpl(this.template,this.model.toJSON()));var t=this;this.model.on("change:IsSelected",function(n,i){i?(t.$el.addClass(t.selectedClass),t.$el.find('.checkbox, input[type="checkbox"]').addClass("checked")):(t.$el.removeClass(t.selectedClass),t.$el.find('.checkbox, input[type="checkbox"]').removeClass("checked"))});return this},selected:function(n){!n||this.$(n.taget).parents("th").length>0||(egov.helper.destroyClickEvent(n),n.ctrlKey?this.model.set("IsSelected",!this.model.get("IsSelected")):(this.parent.unCheckAll(n),this.model.set("IsSelected",!0)))},selectMany:function(n){this.model.set("IsSelected",!this.model.get("IsSelected"));egov.helper.destroyClickEvent(n)},showDetailInfo:function(n){if(n){var i=this,t;egov.helper.destroyClickEvent(n);t=this.model.get("DocumentCopyId");egov.views.home.tab.openDocument(t,i.model.get("DocumentCompendium"));return}}}),f=Backbone.View.extend({tagName:"tr",initialize:function(n){this.template=n.template;this.model=n.model;this.parent=n.parent;this.render();var t=this;t.$el.dbclick(function(n){t.selected(n)},function(){egov.views.home.tab.openDocument(t.model.DocumentCopyId,t.model.DocumentCompendium)})},events:{"click .downloadFile":"downloadFile","click .openFile":"openFile"},render:function(){this.$el.html($.tmpl(this.template,this.model))},selected:function(n){n&&(egov.helper.destroyClickEvent(n),this.$el.parent().find("tr").removeClass("rowSelected"),this.$el.addClass("rowSelected"))},downloadFile:function(){var n=this.model.ContentId;n!==0&&c(n)},openFile:function(){var n=this,t;egov.plugin||$("#egovPlugin").length!==0?(t=n.model.ContentId,t!==0&&(n.model.isOpen?egov.plugin.openFile(n.model.fileData,!1):egov.request.downloadAttachment({data:{id:t},success:function(i){var u=JSON.parse(i),r,f;u&&(u.error||(r=t+"."+n.model.Extension,f=egov.plugin.writeFileBase64(r,u.content,!1),egov.plugin.openFile(r,!0),n.model.isOpen=!0,n.model.fileData=r))},error:function(){},complete:function(){}}))):EgovPlugin.appendPlugin(n.parent.pluginName,function(){n.openFile()})}}),c=function(n){require(["filedownload"],function(){var t="/Attachment/DownloadAttachment/"+n;$.fileDownload(t,{successCallback:function(){},failCallback:function(n){var t=$(n),i;try{i=JSON.parse(t.text())}catch(r){}}})})},e=function(n){require(["documentDetail"],function(t){var i,r;i=new t({model:n});r={width:800,title:egov.resources.documents.title.documentDetail,buttons:[{text:egov.resources.common.closeButton,className:"btn-close",click:function(){i.$el.dialog("destroy")}}],draggable:!0,keyboard:!0};i.$el.dialog(r)})};return s});