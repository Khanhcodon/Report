define([egov.template.document.scan],function(n){"use strict";var a=egov.resources,r="",o="",u=0,f=0,i=0,t=[],v=250,e,y,p,w,b,c,l,k={"2":".jpg","13":".png","25":".gif","18":".tif","0":".bmp",PDF:".pdf",DOC:".doc"},h=[],s=function(){require(["jcrop"],function(){e=$.Jcrop("#imageScan",{onChange:d,onSelect:d,bgColor:"black",bgOpacity:.9})})},d=function(n){y=n.x;p=n.y;w=n.x2;b=n.y2;c=n.w;l=n.h},g=Backbone.View.extend({$scan:$.tmpl(n),el:"body",events:{"click #acquire":"acquire","click #removeAllImageScan":"removeAllImageScan","click #removeImageScan":"removeImageScan","click #preImage":"preImage","click #nextImage":"nextImage","click #rotateLeft":"rotateLeft","click #rotateRight":"rotateRight","click #zoomIn":"zoomIn","click #zoomOut":"zoomOut","click #setActualSize":"setActualSize","click #crop":"crop","click #setBrightnessUp":"setBrightnessUp","click #setBrightnessDown":"setBrightnessDown","click #reloadListScanner":"reloadListScannerEvent","click #setContrastUp":"setContrastUp","click #setContrastDown":"setContrastDown","change #addToContent":"addToContent"},initialize:function(n){var t=this;this.isPacket=n.isPacket;this.toolbar=n.parent;this.doc=n.parent.document;this.docModel=n.parent.document.model;this.isLoadedScanner=n.isLoaded;Plugin.appendPlugin(function(){t.render(t.docModel.get("DocumentCopyId"))});egov.views.scanner=this},render:function(n){var s=this;s.isLoadedScanner?s.reloadListScanner(!1):(s.reloadListScanner(!0),s.isLoadedScanner=!0);r="";o="";u=0;f=0;i=0;t=[];$("#imagePreviewPanel").html("");s.toggeScanDialog({height:"450px",width:"800px",draggable:!0,modal:!0,resizable:!0,title:"eGovCloud - Quét tài liệu",buttons:[{text:a.common.addButton,className:"btn-primary",click:function(){if(t&&t.length>0)if(s.isPacket)s.uploadImageScanPacket();else{var n=_.filter(t,function(n){return n.addToContent});n.length>0&&s.insertImageToContent(n);s.uploadImageScan()}s.toggeScanDialog("destroy")}},{text:a.common.closeButton,className:"btn-close",click:function(){s.toggeScanDialog("destroy")}}]});s.$("#filename").val(n?n:"vanbanden");s.$("#pagePosition").text("Trang: 0/0");s.$("#addToContent").prop("checked",!1);s.$("#preImage, #nextImage, #addToContent, #removeImageScan, #removeAllImageScan").attr("disabled","disabled");e&&(e.destroy(),s.$("#imageScan").remove())},uploadImageScanPacket:function(){var i=[],n=this;$.each(t,function(t,r){var u=n.$("#filename").val()+"_"+(n.doc.attachments.model.length+t)+k[n.$("#imageformat").val()];egov.extension.transferImage(r.url,n.$("#imageformat").val(),function(n){n!==""&&i.push({name:u,value:n})})});i.length>0&&n.uploadImageScanPacketBus(i);t=[]},uploadImageScanPacketBus:function(n){var r=this.docModel,i=this,t=0;$.each(n,function(n,i){egov.setting.acceptFileTypes.test(i.name)?(i.id="#temp"+t,t++):egov.message.warning(i.name+": "+egov.resources.file.notAcceptFileTypes)});egov.request.uploadTempScan({data:{files:JSON.stringify(n)},success:function(n){$.each(n,function(n,t){if(t.error!=="")$(data.id).remove(),egov.message.error(t.name+": "+t.error);else{var i=new egov.models.attachment({Id:t.key,Name:t.name,Size:t.size,Extension:t.extension,Versions:[{Version:1,User:egov.setting.fullName+" ("+egov.setting.userName+")"}],isNew:!0,fileData:t.data});h.push(i)}});h.length>0&&i.createDocForScanPacket()}})},createDocForScanPacket:function(){if(h.length>0){var n=this.docModel,t=h[0];egov.views.home.tab.addDocument(n.get("DocTypeId"),n.get("Compendium"),undefined,!0,t);h.splice(0,1)}},uploadImageScan:function(){var i=[],n=this,f=n.$("#imageformat").val()==="PDF",r,u;f?t.length>0&&(r=n.$("#filename").val()+".pdf",u=_.map(_.pluck(t,"fileName"),function(n){return n.replace(".bmp",".jpg")}),egov.extension.convertToPdf(u,function(t){var i=t.fileArr.fileName;egov.extension.readFileBase64(i,function(t){var i=t.base64;n.uploadImageScanBus([{name:r,value:i}])})})):$.each(t,function(t,r){var u=n.$("#filename").val()+"_"+(n.doc.attachments.model.length+t)+k[n.$("#imageformat").val()];egov.extension.transferImage(r.fileName,n.$("#imageformat").val(),function(n){n!==""&&i.push({name:u,value:n})})});i.length>0&&n.uploadImageScanBus(i);t=[]},uploadImageScanBus:function(n){var i=this.toolbar,t=0;egov.message.processing(egov.common.processing);$.each(n,function(n,i){egov.setting.acceptFileTypes.test(i.name)&&(i.id="#temp"+t,t++)});egov.request.uploadTempScan({data:{files:JSON.stringify(n)},success:function(n){$.each(n,function(n,t){if(t.error!=="")$(data.id).remove(),egov.message.error(t.name+": "+t.error);else{var r=new egov.models.attachment({Id:t.key,Name:t.name,Size:t.size,Extension:t.extension,Versions:[{Version:1,User:egov.setting.fullName+" ("+egov.setting.userName+")"}],isNew:!0});i.document.attachments.model.add(r)}})}})},insertImageToContent:function(n){var t=this,r=t.doc.$("#divContent>div"),i="";$.each(n,function(n,t){var f=t.width>800?800:t.width,u;t.addToContent&&(u='<img width="'+f+'" src="data:image/'+t.ext+";base64,"+t.base64+'" />',r.prepend("<div><p>"+u+"<\/p><\/div>"),i+="<div><p>"+u+"<\/p><\/div>")});t.doc.isInsertedImage=!0;t.docModel.get("DocumentContents")[0].Content+=i;t.doc._renderForm()},reloadListScannerEvent:function(){this.reloadListScanner(!0)},reloadListScanner:function(n){var t=this;t.$scan.find("#listScanner").empty();t.$scan.find("#acquire").attr("disabled","disabled");n=egov.extension.isChrome?""+n:n;egov.extension.getAllScanner(!1,function(n){var i=JSON.parse(n.scanners);i&&i.length>0&&(t.$scan.find("#acquire").removeAttr("disabled"),$.each(i,function(n,i){t.$scan.find("#listScanner").append("<option value='"+n+"'>"+i+"<\/option>")}))})},toggeScanDialog:function(n){this.$scan.dialog(n)},acquire:function(){var n=this,r=function(r){if(r.returnCode===-1){n._showMessage("Không thế scan: vui lòng kiểm tra lại thiết bị của bạn.");return}n._parseScanFiles(r.items,function(r){n._hideMessage();t=r;var u=t[0],f=$('<img style="width: 100%;" id="imageScan" src="data:image/'+u.ext+";base64,"+u.base64+'" />');$("#imagePreviewPanel").html(f);i=0;$("#pagePosition").text("Trang: "+(i+1)+"/"+t.length);t.length>1&&($("#nextImage").removeAttr("disabled"),$("#preImage").attr("disabled","disabled"));$("#addToContent, #removeImageScan, #removeAllImageScan").removeAttr("disabled")})},u=$("#showui").prop("checked"),f=$("#listScanner").val(),e=$("#pixeltype").val(),o=$("#resolution").val(),s=$("#duplex").prop("checked");this._showMessage("Đang chờ máy scan.");egov.extension.acquire(u,f,e,o,s,r)},_parseScanFiles:function(n,t){this._showMessage("Đang lấy ảnh.");var u=n.length,i=0;_.each(n,function(f){f.ext=f.fileName.indexOf(".bmp",r.length-4)!==-1?"bmp":"jpg";egov.extension.readFileBase64(f.fileName,function(r){f.base64=r.base64;i===u-1&&t(n);i++})})},removeImageScan:function(){if(t.length>0){var n=t.length;egov.extension.cancelTransferImage(t[i].url);t.splice(i,1);i===n-1?i>0?(i--,this.showImageByCurrentPage()):(e.destroy(),this.$("#imageScan").remove(),this.$("#pagePosition").text("Trang: 0/0")):this.showImageByCurrentPage();i===0?(this.$("#preImage").attr("disabled","disabled"),t.length<=1&&this.$("#nextImage").attr("disabled","disabled")):i===t.length-1&&this.$("#nextImage").attr("disabled","disabled");t.length===0&&(r="",o="",u=0,f=0,i=0,this.$("#removeImageScan, #removeAllImageScan, #addToContent").attr("disabled","disabled"))}},removeAllImageScan:function(){t.length>0&&(e.destroy(),this.$("#imageScan").remove(),this.$("#pagePosition").text("Trang: 0/0"),r="",o="",u=0,f=0,i=0,$.each(t,function(n,t){egov.extension.cancelTransferImage(t.url)}),t=[],this.$("#removeImageScan, #removeAllImageScan, #nextImage, #preImage, #addToContent").attr("disabled","disabled"))},showImageByCurrentPage:function(){var n=t[i],e;r=n.url;o=n.ext;u=n.width;f=n.height;e=$('<img  id="imageScan" style="width: 100%;" src="data:image/'+n.ext+";base64,"+n.base64+'" />');this.$("#imagePreviewPanel").html(e);this.$("#addToContent").prop("checked",n.addToContent);this.$("#pagePosition").text("Trang: "+(i+1)+"/"+t.length)},preImage:function(){i>=1&&(i--,this.showImageByCurrentPage(),this.$("#nextImage").removeAttr("disabled"),i===0&&this.$("#preImage").attr("disabled","disabled"))},nextImage:function(){i<=t.length-2&&(i++,this.showImageByCurrentPage(),this.$("#preImage").removeAttr("disabled"),i===t.length-1&&this.$("#nextImage").attr("disabled","disabled"))},rotateLeft:function(){this._setRotate(90)},rotateRight:function(){this._setRotate(-90)},zoomIn:function(){this._setZoom(100)},zoomOut:function(){this._setZoom(-100)},setActualSize:function(){r!==""&&(e.destroy(),this.$("#imageScan").css({width:u+"px",height:f+"px"}),this.$("#imageScan").attr("width",u+"px").attr("height",f+"px"),s())},crop:function(){if(r!==""){var n=this.$("#imageScan").width(),h=this.$("#imageScan").height(),a=this;egov.extension.imageCrop(r,y,p,w,b,n,h,function(y){y&&(e.destroy(),egov.extension.readFileBase64(r,0,-1,function(r){var y=$('<img width="'+v+'px" height="'+v/c*l+'px" id="imageScan" src="data:image/'+o+";base64,"+r+'" />'),e;a.$("#imagePreviewPanel").html(y);s();u=c/n*u;f=l/h*f;e=t[i];e.width=u;e.height=f;e.data=r},!0))})}},setBrightnessUp:function(){this._setBrightness(10)},setBrightnessDown:function(){this._setBrightness(-10)},setContrastUp:function(){this._setContrast(10)},setContrastDown:function(){this._setContrast(-10)},addToContent:function(){var n=t[i];n.addToContent=this.$("#addToContent").prop("checked")},_showMessage:function(n){this.$(".scan-info").text(n)},_hideMessage:function(){this.$(".scan-info").text("")},_setContrast:function(n){if(r!==""){var u=this;egov.extension.imageAdjustContrast(r,n,function(n){if(n){var f=u.$("#imageScan").width(),h=u.$("#imageScan").height();e.destroy();egov.extension.readFileBase64(r,0,-1,function(n){var r=$('<img width="'+f+'" height="'+h+'px" id="imageScan" src="data:image/'+o+";base64,"+n+'" />');u.$("#imagePreviewPanel").html(r);s();t[i].data=n},!0)}})}},_setZoom:function(n){if(r!==""){var u=$("#imageScan").width(),f=$("#imageScan").height(),t=u+n,i=t/(u/f);t>0&&i>0&&(e.destroy(),this.$("#imageScan").css({width:t+"px",height:i+"px"}),this.$("#imageScan").attr("width",t+"px").attr("height",i+"px"),s())}},_setRotate:function(n){if(r!==""){var h=this;egov.extension.imageRotate(r,n,function(n){if(n){e.destroy();var c=h.$("#imageScan").width(),l=h.$("#imageScan").height();egov.extension.readFileBase64(r,0,-1,function(n){var a=$('<img width="'+l+'px" height="'+c+'px" id="imageScan" src="data:image/'+o+";base64,"+n+'" />'),e,r;h.$("#imageScan").remove();h.$("#imagePreviewPanel").html(a);s();e=f;f=u;u=e;r=t[i];r.width=u;r.height=f;r.data=n},!0)}})}},_setBrightness:function(n){if(r!==""){var u=this;egov.extension.imageAdjustBrightness(r,n,function(){var n=u.$("#imageScan").width(),f=u.$("#imageScan").height();e.destroy();egov.extension.readFileBase64(r,0,-1,function(r){var e=$('<img width="'+n+'" height="'+f+'px" id="imageScan" src="data:image/'+o+";base64,"+r+'" />');u.$("#imagePreviewPanel").html(e);s();t[i].data=r},!0)})}}}),nt=function(n,t){var i=new Image;i.src="data:image/"+t+";base64,"+n;var r=768,u=i.width,f=i.height;return i.width>=r&&(u=r,f=r/i.width*i.height),'<img width="'+u+'px" height="'+f+'px" src="data:image/'+t+";base64,"+n+'" />'};return g});