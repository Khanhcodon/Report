define(["jstree"],function(){"use strict";var n=egov.resources.document.publishment,f=Backbone.View.extend({el:"#PrivatePublishment",events:{"click .code-list > li":"_selectCode","click .ddlApprovers > li":"_selectApprover","click .private-anoun .checkbox":"uncheckPrivateAnoun","blur #Code":"_checkCodeUsed"},initialize:function(){return this.stores=[],this.targetComments=[],this.selectedDeptIds=[],this.$stores=this.$("#StoreId"),this.$codeId=this.$("#Code"),this.$code=this.$(".code-list"),this.$dg=this.$(".dg-view"),this.$approvers=this.$(".ddlApprovers"),this.$depts=this.$("#InPlace"),this.$securities=this.$("#SecurityId"),this.$datePublish=this.$("#DatePublished"),this.$privateAnounc=this.$(".private-anoun ul:first"),this},render:function(n){return this._destroyDg(),this.$privateAnounc.empty(),this.$(".private-receiveds .table-depts tbody").empty(),this.$(".main-address ul").empty(),this.theoLo=!1,this.document=n.document,this.docTypeId=n.docTypeId,this.hasDg=n.hasDg,this.hasPrivateSaveToStore=n.HasPrivateSaveToStore,this.hasDg==undefined&&(this.hasDg=!0),this.callback=n.callback,this.categoryId=this.document.model.get("CategoryId"),this.documentId=this.document.model.get("DocumentId"),this.result=new egov.models.publish,this.$el.show(),this.$stores.off("change"),this.isRePublish=!1,n.isRePublish&&(this.isRePublish=n.isRePublish),this._openDialog(),this},renderTheoLo:function(n){return this._destroyDg(),this.$privateAnounc.empty(),this.$(".private-receiveds .table-depts tbody").empty(),this.documentCopyIds=n.documentCopyIds,this.docTypeId=n.docTypeId,this.parent=n.parent,this.categoryId=n.categoryId,this.hasDg=n.hasDg,this.hasDg==undefined&&(this.hasDg=!0),this.theoLo=!0,this.callback=n.callback,this.result=new egov.models.publish,this.$el.empty().show(),this.$stores.off("change"),this._openDialog(),this},_openDialog:function(){var t=this,i=[];i=t.isRePublish?[{text:"Phát hành tiếp",className:"btn-primary",disableProcess:!0,click:function(){t._rePublish()}},{text:egov.resources.common.closeButton,className:"btn-close",click:function(){egov.callback(t.callback);t.$el.dialog("hide")}}]:[{text:n.publishButton,className:"btn-primary",disableProcess:!0,click:function(n){if(t.hasDg)t.theoLo?t._publishPrivateTheoLo():t._publishPrivate();else{var i=t.$stores.val(),r=t.$codeId.val();t.$el.dialog("hide");egov.callback(t.callback,{storeId:i,code:r,codeId:t.result.get("CodeId")})}n()}},{text:"Ký và phát hành",className:"btn-info",disableProcess:!0,click:function(n){t._signAndPublishPrivate();n()}},{text:egov.resources.common.closeButton,className:"btn-close",click:function(){egov.callback(t.callback);t.$el.dialog("hide")}}];this.$el.attr("help-content-page","privatePublishment");this.$el.dialog({title:n.privateDialogTitle,width:t.hasDg?"780px":"450px",height:t.hasDg?"360px":"180px",draggable:!0,onclose:function(){t.$el.dialog("hide");return},buttons:i});this._renderData();this._changeStore()},uncheckAddress:function(n){var i=$(n.target),r,t;i.is(":checkbox")&&(r=i.val(),t=this.model.detect(function(n){return n.get("AddressId")==r}),t&&t.set("isSelected",!1),egov.helper.destroyClickEvent(n))},uncheckPrivateAnoun:function(n){if(egov.views.dg){var t=$(n.target).parent().find(":checkbox");if(t.length===0)return;egov.views.dg.uncheckPrivateAnoun(t.val());this._dongGui()}},serialize:function(){var t,n,r,i,u;for(t in this.result.attributes)t!=="CodeId"&&this.$("#"+t).length>0&&this.result.set(t,this.$("#"+t).val());return n=this.$("#DatePublished").datepicker("getDate"),n&&(n.hours((new Date).hours()),n.minutes((new Date).minutes())),this.result.set("DatePublished",n==null?null:n.toServerString()),r=this.result.get("CodeId"),i=_.find(this.codies,function(n){return n.CodeId==r}),i&&i.Template.trim()!=this.result.get("Code").trim()&&this.result.set("IsCustomCode",!0),u=this.result.get("InPlace"),this.result.set("Organization",u),this.result},_renderData:function(){var n=this,f=this.docTypeId?this.docTypeId:this.document.model.get("DocTypeId"),r,u;egov.dataManager.getAllUserDeptPosition({success:function(t){n.allUserDepts=t;egov.dataManager.getAllDept({success:function(t){n.allDepts=t;n._bindDepartments()}})}});var n=this,i,t=this.document.model.get("StoreId"),e=this.document.model.get("CategoryId"),f=this.docTypeId?this.docTypeId:this.document.model.get("DocTypeId");egov.request.GetStores({data:{docTypeId:f,categoryId:e},success:function(i){n.stores=i;i.length>0&&(n.$stores.empty(),n.$stores.append($.tmpl('<option value="${StoreId}">${StoreName}<\/option>',i)),n.$stores.find("option[value='"+t+"']").attr("selected","selected"),n.plan?n._showCode(n.plan.publishInfo.StoreId):(t|=i[0].StoreId,n._showCode(t)))}});r=function(t,i,r){if(n.allUsers=t,n.allJobtitle=i,n.allUserDeptPosition=r,n.approvers=n._getApprovers(),n.$approvers.empty(),n.$approvers.append($.tmpl('<li class="list-group-item" value="${value}">${fullname} - ${username}<\/li>',n.approvers)),n.$("#ApproverName").val(n.approvers[0].fullname+" - "+n.approvers[0].username),n.$("#Approvers").val(n.approvers[0].value),n.document&&n.document.model){var u=n.document.model.get("UserSuccessId");u&&n.$approvers.find('option[value="'+u+'"]').attr("selected","selected")}n._autoCompleteApprover()};egov.dataManager.getAllUsers({success:function(n){egov.dataManager.getAllJobtitle({success:function(t){egov.dataManager.getAllUserDeptPosition({success:function(i){r(n,t,i)}})}})}});u=[{name:"Thường",value:1},{name:"Mật",value:2},{name:"Tối mật",value:3},{name:"Tuyệt mật",value:4}];n.$securities.empty();n.$securities.append($.tmpl('<option value="${value}">${name}<\/option>',u));i=Globalize.format(new Date,"dd/MM/yyyy");n.$datePublish.val(i);n.$datePublish.datepicker({gotoCurrent:!0,prevText:"Trước",nextText:"Tiếp",dateFormat:"dd/mm/yy"});n.$("#DateResponse").datepicker({gotoCurrent:!0,prevText:"Trước",nextText:"Tiếp",dateFormat:"dd/mm/yy"});egov.dataManager.getAllDept({success:function(t){var f=t.length,r,i,u;for(n.$depts.empty(),r=egov.setting.currentDepts?egov.setting.currentDepts[0]:"",i=0;i<f;i++)u='<option value="${label}" >${label}<\/option>',r!==""&&r===t[i].label&&(u='<option value="${label}"selected="selected">${label}<\/option>'),n.$depts.append($.tmpl(u,t[i]))}});n._showDg()},_showCode:function(n){var t=this,i;if(t.$code.empty(),t.$codeId.val(""),i={storeId:n},this.theoLo){if(!this.categoryId)return;i.categoryId=this.categoryId}else i.categoryId=this.categoryId,i.documentId=this.documentId;egov.request.GetCodes({data:i,success:function(n){t.codies=n;n&&n.length>0&&(t.$code.append($.tmpl('<li class="list-group-item" value="${CodeId}">${Template}<\/li>',n)),t.$codeId.val(n[0].Template),t.result.set("CodeId",n[0].CodeId))}})},_selectCode:function(n){var t=$(n.target).text(),i=$(n.target).attr("value");this.result.set("CodeId",parseInt(i));this.$codeId.val(t)},_selectApprover:function(n){var t=$(n.target).closest("li"),i=t.attr("value");this.$("#ApproverName").val(t.text());this.$("#Approvers").val(i)},_autoCompleteApprover:function(){var t=this.approvers,n=this;this.$("#ApproverName").autocomplete({source:t,focus:function(){return!1},select:function(t,i){var r=i.item;return n.$("#ApproverName").val(r.fullname+" - "+r.username),n.$("#Approvers").val(r.value),!1}}).data("autocomplete")._renderItem=function(n,t){return n.addClass("dropdown-menu"),n.css("zIndex","2000"),$("<li><\/li>").data("item.autocomplete",t).append("<a>"+t.label+"<\/a>").appendTo(n)}},_showDg:function(){var n=this;!n.$dg.is(":not(:empty)")&&this.hasDg&&require(["transferExtend"],function(t){egov.views.dg=new t;egov.views.dg.render(!1,!1,function(){n._dongGui()},function(){n.$dg.append(egov.views.dg.$el)})});this.hasDg||this.$(".private-receiver").hide()},_dongGui:function(){this.$privateAnounc.empty();egov.views.dg.selectDg(this.$privateAnounc)},_changeStore:function(){var n=this;this.$stores.change(function(){var t=$(this).val();n._showCode(t)})},_signAndPublishPrivate:function(){if(Plugin){var n=this;n.document.model.set("DocCode",n.$("#Code").val());Plugin.appendPlugin(function(){Plugin.sign(n.document,function(t){if(t=t||!1,t)n.document.model.set("HasCA",!0),n._publishPrivate();else return})})}},_rePublish:function(){var o=this.serialize(),s=this.document.serialize(),i=egov.views.dg.getUserConsults(),f=this._getUserReceiveDocument(),r;i=_.difference(i,_.keys(f));r={};this.document.attachments.model.each(function(n){n.get("isNew")&&(r[n.get("Id")]={name:n.get("Name")})});var h=this.document.attachments.model.select(function(n){return n.get("isRemoved")}),t=this,e=parseInt(t.document.model.get("DocumentCopyId")),c=egov.views.dg.getDestination(),u=this.targetComments;u=u.concat(c);egov.pubsub.publish(egov.events.status.processing,egov.resources.common.transfering);egov.request.rePublish({data:{documentCopyId:e,doc:JSON.stringify(s),files:JSON.stringify(r),modifiedFiles:JSON.stringify(this.document.attachments.modifiedFiles),removeAttachmentIds:h,publishinfo:JSON.stringify(o),usersConsult:i,userHasReceiveDocuments:JSON.stringify(f),targetForComments:JSON.stringify(u)},success:function(n){n.error?egov.pubsub.publish(egov.events.status.error,n.error):(t._destroyDg(),t.document.isSaveChanged=!0,t.$el.dialog("hide"),t._closeTab([e]))},error:function(){egov.pubsub.publish(egov.events.status.error,n.error)}})},_publishPrivate:function(){var h=this.serialize(),c=this.document.serialize(),u=egov.views.dg.getUserConsults(),o=this._getUserReceiveDocument(),r,s,i;u=_.difference(u,_.keys(o));r={};this.document.attachments.model.each(function(n){n.get("isNew")&&(r[n.get("Id")]={name:n.get("Name")})});s=this.document.attachments.model.select(function(n){return n.get("isRemoved")});i=this.document.attachments.modifiedFiles;$.each(r,function(n,t){i[n]&&(t.content=i[n],delete i[n])});var t=this,f=parseInt(t.document.model.get("DocumentCopyId")),l=egov.views.dg.getDestination(),e=this.targetComments;e=e.concat(l);egov.pubsub.publish(egov.events.status.processing,egov.resources.common.transfering);egov.request.privatePublish({data:{documentCopyId:f,doc:JSON.stringify(c),files:JSON.stringify(r),modifiedFiles:JSON.stringify(i),removeAttachmentIds:s,publishinfo:JSON.stringify(h),usersConsult:u,userHasReceiveDocuments:JSON.stringify(o),targetForComments:JSON.stringify(e)},success:function(n){n.success?(t._destroyDg(),t.document.isSaveChanged=!0,t._closeTab([f]),t.document&&t.document._reloadDocumentTree([f]),t.$el.dialog("hide")):egov.pubsub.publish(egov.events.status.error,n.error)},error:function(){egov.pubsub.publish(egov.events.status.error,n.error)}})},_publishPrivateTheoLo:function(){var u=this.serialize(),i=_.pluck(egov.views.dg.getUserConsults(),"value"),r=egov.views.dg.getUserReceiveDocument(),t;i=_.difference(i,r);t=this;egov.pubsub.publish(egov.events.status.processing,egov.resources.common.transfering);egov.request.privatePublishTheoLo({data:{documentCopyIds:this.documentCopyIds,publishinfo:JSON.stringify(u),usersConsult:i,userHasReceiveDocuments:r},success:function(n){n.success?(t._destroyDg(),t.document.isSaveChanged=!0,t._closeTab(t.documentCopyIds),t.parent.removeDocumentByIdsAndSetSelected(t.documentCopyIds,function(){}),egov.callback(t.callback),t.$el.dialog("hide")):egov.pubsub.publish(egov.events.status.error,n.error)},error:function(){egov.pubsub.publish(egov.events.status.error,n.error)}})},_destroyDg:function(){egov.views.dg&&egov.views.dg.destroy()},_closeTab:function(n){if(this.document&&this.document.tab)this.document.tab.close();else if(egov.views.home&&egov.views.home.tab){if(!n)return;n instanceof Array||(n=[n]);egov.views.home.tab.closeTab(n)}},_getUserReceiveDocument:function(){var n=this.selectedDeptIds,t={},f=this.allUserDepts,e=this.allDepts,i,r,u;return _.isEmpty(n)?t:(_.each(_.keys(n),function(e){u=n[e];r=_.filter(f,function(n){return(i=e.indexOf(".")<0,i)?n.idext===e&&n.hasReceiveDocument==!0:n.idext.indexOf(e)==0&&n.hasReceiveDocument==!0});_.each(r,function(n){t[n.userid]=u})}),t)},_getApprovers:function(){var n=[];if(!n||n.length<=0){var r=this.allUsers,t=this.allJobtitle,i=this.allUserDeptPosition;i.forEach(function(i){var u=i.jobtitleid,r=_.find(t,function(n){return n.value===u&&n.isApprover}),f=egov.setting.user.primaryDepartment;r&&egov.setting.transfer.showApproverByDepartment&&(r=f.indexOf(i.idext)===0);r&&n.push({value:i.userid,username:i.username,fullname:i.fullname,isMain:!0,label:i.fullname+" - "+i.username})})}return n},_bindDepartments:function(){var n=this,t=n.allDepts,i=this.allUserDepts;_.each(t,function(n){var r=n.value,t=_.find(i,function(n){return n.departmentid===r&&n.hasReceiveDocument});n.hasReceiveDocument=t;t||(n.state="disabled")});o(n.$("#listDepartments"),!1,!0,!1,t,[],[],null,[]);n.$("#listDepartments").bind("change_state.jstree",function(t,i){var r=i.rslt.attr("idext").indexOf(".")<0;r&&i.rslt.is(".jstree-checked")&&i.rslt.find(".jstree-checked").removeClass("jstree-checked").addClass("jstree-unchecked");n._changeDepartmentReceive()})},_changeDepartmentReceive:function(){var n=this,t=this.allDepts;n.$(".main-address ul").empty();n.targetComments=[];n.selectedDeptIds={};this.$("#listDepartments  .jstree-checked").each(function(){var r=$(this),f=r.attr("id"),o=r.is(".jstree-disabled"),s=r.attr("rel")==="dept",i,u;s&&(i=_.find(t,function(n){return n.value==f}),i&&(u=o?i.label+" (không có người nhận)":i.label,n.targetComments.push({label:u,value:"",type:0}),n.selectedDeptIds[i.idext]=i.label,n.$(".main-address ul").append(e(i.value,u))))})}}),e=function(n,t){return $(String.format('<li class="list-group-item">                                <div class="row">                                    <label class="checkbox document-color">                                       <input name="checkbox[]" value="{0}" type="checkbox" checked="checked">                                        <span class="document-color-1"><i class="icon-check"><\/i><\/span>                                    <\/label>                                    <span style="margin-left: 15px;">{1}<\/span>                                <\/div>                            <\/li>',n,t))},t=function(n,i,r,u,f){var e=_.filter(r,function(t){return t.parentid==n}),o=_.filter(f,function(t){return t.departmentid===n}),c,s,h,l;if(e.length>0)for(c=0;c<e.length;c++)(t(e[c].value,!1,r,[],[]).length>0||i&&o.length>0)&&(e[c].state="closed");if(i&&o.length>0)for(s=0;s<o.length;s++)h=_.find(u,function(n){return n.value===o[s].userid}),h&&(l={value:"user_"+h.value,data:h.fullname,parentid:n,state:"leaf",metadata:{id:"user_"+h.value},attr:{id:"user_"+h.value,rel:"people",idext:o[s].idext,hasReceiveDocument:o[s].hasReceiveDocument}},e.push(l));return e},r='<li id="${value}" label="${attr.label}" rel="${attr.rel}" idext="${attr.idext}" class="jstree-${state}"><ins class="jstree-icon">&nbsp;<\/ins><a href="#" class="">',u;r+='<ins class="jstree-icon">&nbsp;<\/ins>${data}<\/a><\/li>';u='<li id="${value}" rel="${attr.rel}" idext="${attr.idext}" hasReceiveDocument="${attr.hasReceiveDocument}" class="jstree-${state}"><ins class="jstree-icon">&nbsp;<\/ins><a href="#" class=""><ins class="jstree-checkbox">&nbsp;<\/ins><ins class="jstree-icon">&nbsp;<\/ins>${data}<\/a><\/li>';var i=["themes","json_data","ui","crrm"],o=function(n,r,u,f,e,o,h){var c=_.find(e,function(n){return n.parentid===0}),l;u&&i.push("checkbox");f&&i.push("dnd");c&&(l=t(c.value,r,e,o,h),n.jstree({json_data:{data:[{data:c.data.toString(),metadata:{id:c.value},state:"closed",attr:{id:c.value,rel:"dept",idext:c.idext,label:c.label},children:l}]},crrm:f==!1?{}:{move:{check_move:function(n){var i=_.find(e,function(t){return t.value===parseInt(n.o.attr("id"))}),t;return i?i.level!=1?!1:(t=this._get_parent(n.o),!t)?!1:(t=t==-1?this.get_container():t,t===n.np)?!0:t[0]&&n.np[0]&&t[0]===n.np[0]?!0:!1:!1}}},dnd:f==!1?{}:{drop_target:!1,drag_target:!1},plugins:i}).bind("loaded.jstree",function(t,i){var f=1;i.inst.get_container().find("li").each(function(){i.inst.get_path($(this)).length<=f&&i.inst.open_node($(this))});n.bind("open_node.jstree",function(n,t){t.inst._get_children(t.rslt.obj).length==0&&s(t.rslt.obj,parseInt(t.rslt.obj.attr("id")),r,u,e,o,h)})}))},s=function(n,i,f,e,o,s,h){var l=t(i,f,o,s,h),c;l.length>0&&(c=$("<ul><\/ul>"),c.appendTo(n),e?($.tmpl(u,l).appendTo(c),$(n).find("li").each(function(t,i){$(i).addClass(n.hasClass("jstree-checked")?"jstree-checked":"jstree-unchecked")})):$.tmpl(r,l).appendTo(c),c.children("li:last").addClass("jstree-last"))};return f});