define([egov.template.document.anticipate],function(n){"use strict";egov.models.userAction=Backbone.Model.extend({defaults:{id:0,value:0,label:"",fullname:"",department:"",username:"",position:"",isMainProcess:!1,isCoProcess:!1},initialize:function(){this.set("id",this.get("value"))}});egov.models.userActionCollection=Backbone.Collection.extend({model:egov.models.userAction});return Backbone.View.extend({tagName:"div",events:{"change #dropdownAction":"_changeAction","change #dropdownUserTransfer":"_changeUserTransfer","change #dropdownActionPlan":"_changeActionPlan"},initialize:function(){return this.destinationPlan=null,this.$el.append(n),this.$el.bindResources(),this},render:function(n){return this._clear(),this.documentCopyId=n.documentCopyId||0,this.doctypeId=n.doctypeId,this.isCreatingDocument=n.documentCopyId<=0,this._openDialog(),this},_openDialog:function(){var n=this,t=this.isCreatingDocument?"getDocumentCreateAction":"getDocumentEditAction",i=this.isCreatingDocument?{documentTypeId:this.doctypeId,isPhanloai:!1}:{documentCopyId:this.documentCopyId,isGetSpecials:!1};egov.request[t]({data:i,success:function(t){if(!t){egov.pubsub.publish(egov.events.status.error,egov.resources.common.error);return}if(t.error){egov.pubsub.publish(egov.events.status.error,t.error);return}n.actions=_.filter(t,function(n){return!n.isspecial});n.actions.length>0&&$.each(n.actions,function(t,i){n.$("#dropdownAction").append('<option value="'+i.id+'">'+i.name+"<\/option>")});n._renderDialog()},error:function(n){console.log(n.message)}})},_renderDialog:function(){var n=this,t={title:egov.resources.document.anticipate.name,width:"790px",height:"275px",draggable:!0,keyboard:!0,buttons:[{id:"addAnticipate",text:egov.resources.document.addAnticipate,className:"btn-primary",disableProcess:!0,click:function(){egov.transferPlanForm&&(n.destinationPlan=egov.transferPlanForm.serialize());n.$el.dialog("destroy")}},{id:"closeAnticipate",text:egov.resources.main.closeBtn,className:"btn-close",click:function(){n.$el.dialog("destroy")}}]};this.$el.dialog(t)},_clear:function(){this.$(".transferplan-form").empty();this.actions=null;this.selectedAction=null;this.userTranfers=null;this.selectedUser=null;this.actionsPlans=null;this.selectedActionsPlan=null;this.$("#dropdownAction").empty().append('<option value="">'+egov.resources.document.anticipate.choosereceive+"<\/option>");this.$("#dropdownUserTransfer").empty().append('<option value="">'+egov.resources.document.anticipate.choosereceiver+"<\/option>");this.$("#dropdownActionPlan").empty().append('<option value="">'+egov.resources.document.anticipate.chooseanticipate+"<\/option>")},_changeAction:function(n){var t,i,r;n&&(this.$(".transfer-form").empty(),t=this,i=this.$("#dropdownAction").val(),i)&&(this.selectedAction=_.find(this.actions,function(n){return n.id===i}),this.selectedAction&&(this.userTranfers=null,this.selectedUser=null,r={actionId:this.selectedAction.id,workflowId:this.selectedAction.workflowId,documentCopyId:this.documentCopyId},egov.request.getUserByAction({data:r,success:function(n){n&&(t.userTranfers=n,t.$("#dropdownUserTransfer").empty().append('<option value="">Chọn người nhận<\/option>'),$.each(n,function(n,i){t.$("#dropdownUserTransfer").append('<option value="'+i.value+'">'+i.label+"<\/option>")}))},error:function(){egov.pubsub.publish(egov.events.status.error,"Bạn không có quyền xử lý văn bản!")}})))},_changeUserTransfer:function(n){if(n&&(this.$(".transfer-form").empty(),this.userTranfers&&this.selectedAction)){var t=this,i=this.$("#dropdownUserTransfer").val();i&&(this.selectedUser=_.find(this.userTranfers,function(n){return n.value==i}),this.selectedUser)&&egov.request.getActionsTransferPlan({data:{workflowId:this.selectedAction.workflowId,userId:this.selectedUser.value,currentNodeId:this.selectedAction.nextNodeId},success:function(n){if(!n){egov.pubsub.publish(egov.events.status.error,"Bạn không có quyền xử lý văn bản!");return}t.actionsPlans=n;t.$("#dropdownActionPlan").empty().append('<option value="">Chọn hướng dự kiến<\/option>');$.each(n,function(n,i){t.$("#dropdownActionPlan").append('<option value="'+i.id+'">'+i.name+"<\/option>")})}})}},_changeActionPlan:function(n){if(n&&(this.$(".transfer-form").empty(),this.actions&&this.selectedAction&&this.userTranfers&&this.selectedUser)){var i=this.$("#dropdownActionPlan").val(),t=this;this.actionsPlan=_.find(this.actionsPlans,function(n){return n.id==i});this.actionsPlan&&egov.request.getUserByAction({data:{actionId:t.actionsPlan.id,workflowId:t.actionsPlan.workflowid,documentCopyId:0,userId:t.selectedUser.value},success:function(n){if(!n){egov.pubsub.publish(egov.events.status.error,"Không có hướng chuyển nào.");return}t.model=new egov.models.actionUserList(n);t._bindView()}})}},_bindView:function(){if(this.$(".transferplan-form").empty(),this.model&&this.model.length>0){var n=this;require(["transfer"],function(t){egov.transferPlanForm=new t;egov.transferPlanForm.renderAnticipate({action:n.actionsPlan,model:n.model,parent:n,callback:function(t){n.$(".transferplan-form").append(t)}})})}},getDestinationPlan:function(){return this.destinationPlan}})});