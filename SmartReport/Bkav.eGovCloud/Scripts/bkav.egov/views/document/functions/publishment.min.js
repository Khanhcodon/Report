define([egov.template.document.publishment,egov.template.document.addressItem],function(n,t){"use strict";var i=egov.resources.document.publishment,f=Backbone.View.extend({tagName:"div",events:{"click .main-address .checkbox":"uncheckAddress","click .private-dept .checkbox":"uncheckDept","click .private-anoun .checkbox":"uncheckPrivateAnoun","blur #Code":"_checkCodeUsed","click .code-list > .list-group-item":"_selectCode","keydown #searchAddress":"filterAddress","keydown #searchEmail":"filterEmail","click #addressDateResponse":"addressResponse","click .ddlApprovers > li":"_selectApprover"},groups:{},noneGroup:"Chưa phân nhóm",allGroup:"Tất cả",filterAddress:function(n){var t,f=this.$(n.target),i=this,u;if(n.keyCode===13){if(t=f.val(),t==="")return;i.$address.append("<tr class='tempAddress'><td><\/td><td>"+t+"<\/td><td><\/td><\/tr>");u=r(0,t);u.find(":checkbox").click(function(){u.remove();$(".tempAddress").remove();i.$("#tempAddress").val("")});i.$("#tempAddress").val(t);i.$mainAddress.append(u);f.val("")}},filterEmail:function(n){var t,f=this.$(n.target),i=this,e,u;if(n.keyCode===13){if(t=f.val(),e=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,t===""||!e.test(String(t).toLowerCase()))return;i.$address.append("<tr class='tempEmail'><td><\/td><td>"+t+"<\/td><td><\/td><\/tr>");u=r("mail",t);u.find(":checkbox").click(function(){u.remove();$(".tempEmail").remove();i.$("#tempEmail").val("")});i.$("#tempEmail").val(t);i.$mailAddress.append(u);f.val("")}},initialize:function(){return this._clear(),this.$el.attr("id","Publishment").addClass("publishment").html(n),this.$el.bindResources(),this.result=new egov.models.publish,this},render:function(n){return this._clear(),this.theoLo=!1,this.document=n.document,this.docTypeId=n.docTypeId,this.categoryId=this.document.model.get("CategoryId"),this.documentId=this.document.model.get("DocumentId"),this.plan=n.plan,this.isPlanning=n.isPlan,this.$el.show(),this.stores=[],this.isRePublish=!1,n.isRePublish&&(this.isRePublish=n.isRePublish),this._renderDialog(),this},renderTheoLo:function(n){return this._clear(),this.docTypeId=n.docTypeId,this.documentCopyIds=n.documentCopyIds,this.parent=n.parent,this.theoLo=!0,this.categoryId=n.categoryId,this.callback=n.callback,this.$el.show(),this.stores=[],this._renderDialog(),this},_clear:function(){this.$el.bindResources();this.$address=this.$(".listAddress");this.$stores=this.$("#StoreId");this.$codeId=this.$("#Code");this.$code=this.$(".code-list");this.$approvers=this.$(".ddlApprovers");this.$depts=this.$("#InPlace");this.$keywords=this.$("#KeyWordId");this.$securities=this.$("#SecurityId");this.$datePublish=this.$("#DatePublished1");this.$dg=this.$(".dg-view");this.$search=this.$("#searchAddress");this.$mainAddress=this.$(".main-address ul:first");this.$mailAddress=this.$(".main-mail ul:first");this.$privateAnounc=this.$(".private-anoun ul:first");this.$mainAddress.empty();this.$mailAddress.empty();this.$privateAnounc.empty();this.$(".private-dept ul").empty();$("#privateDepartments").html("");this.$code.val("");egov.views.dg&&egov.views.dg.destroy()},_renderDialog:function(){var n=this,t=[];this.isRePublish?t=[{text:"Phát hành tiếp",className:"btn-primary",disableProcess:!0,click:function(){n._rePublish()}}]:(n=this,t=[{text:n.isPlanning?i.addpublishment:i.publishButton,className:"btn-primary",disableProcess:!0,click:function(t){n.isPlanning?n._publishPlan():n.theoLo?n._publishTheoLo():n._publish();t()}},{text:"Ký và Phát hành",id:"signAndPublish",className:"btn-info "+(n.isPlanning?"hidden":""),disableProcess:!0,click:function(t){n.theoLo||(n._signAndPublish(),t())}}]);t.push({text:egov.resources.common.closeButton,className:"btn-close",click:function(){var t=n.isPlan?"destroy":"hide";egov.callback(n.callback);n.$el.dialog(t)}});this.$el.attr("help-content-page","publishment");this.$el.dialog({title:i.dialogTitle,width:"850px",height:"450px",draggable:!0,buttons:t});egov.setting.publish.showPlaceInOffice||(this.$("#privateDepts").parents(".form-group").hide(),this.$("#privateDepts").parents(".form-group").prev().hide(),this.$(".private-dept").parent().hide(),this.$(".listAddress").height(158));this._renderData();this._changeStore()},uncheckAddress:function(n){var i=$(n.target),r,t;i.is(":checkbox")&&(r=i.val(),t=this.model.detect(function(n){return n.get("AddressId")==r}),t&&t.set("isSelected",!1),egov.helper.destroyClickEvent(n))},uncheckDept:function(n){var t=$(n.target),i;t.is(":checkbox")&&(i=t.val(),$("#privateDepartments").jstree("uncheck_node",$("#privateDepartments").find("li#"+i)),egov.helper.destroyClickEvent(n))},uncheckPrivateAnoun:function(n){if(egov.views.dg){var t=$(n.target).parent().find(":checkbox");if(t.length===0)return;egov.views.dg.uncheckPrivateAnoun(t.val());this._dongGui()}},serialize:function(){var i,n,t,r,u,e,o,f;for(i in this.result.attributes)i!=="CodeId"&&this.$("#"+i).length>0&&this.result.set(i,this.$("#"+i).val());return n=this.$("#DatePublished1").datepicker("getDate"),t=this.$("#DateResponse").datepicker("getDate"),n&&(n.hours((new Date).hours()),n.minutes((new Date).minutes())),t&&(t.hours((new Date).hours()),t.minutes((new Date).minutes())),this.result.set("DatePublished",n==null?null:n.toServerString()),this.result.set("DateResponse",t==null?null:t.toServerString()),r=this.result.get("CodeId"),r==0&&(r=this.$("#CodeId li[text='"+this.result.get("Code")+"']").attr("value")),u=_.find(this.codies,function(n){return n.CodeId==r}),u&&u.Template.trim()!=this.result.get("Code").trim(),e=_.map(this.model.where({isSelected:!0}),function(n){return n.get("AddressId")}),o=_.uniq(e),this.result.set("Address",o),this.result.set("Organization",this.$("#Organization :selected").text()),this.result.set("OrganizationCode",this.$("#Organization").val()),this.isChangeDateResponse&&(f={},_.each(this.model.where({isSelected:!0}),function(n){f[n.get("AddressId")]=n.get("DateResponse")}),this.result.set("DateResponeAddress",f)),this.result},addressResponse:function(){var n=this,i=this.model.select({isSelected:!0}),t=_.uniq(i,function(n){return n.get("AddressId")});this.result.set("DateResponse",this.$("#DateResponse").datepicker("getDate"));t.length>0&&require(["DateResponseAddresses"],function(i){new i({listAddress:t,dateResponse:n.result.get("DateResponse"),callback:function(){n.isChangeDateResponse=!0}})})},_renderData:function(){var n=this,t,r;if(egov.dataManager.getAllAddress({success:function(t){n.model=new egov.models.addressCollection(t);n._bindAddress();return}}),egov.dataManager.getAllDept({success:function(t){egov.dataManager.getCurrentDepartments({success:function(i){var f=i?i[0]:t[0],e=t.length,r,u;for(n.$depts.empty(),r=0;r<e;r++)u='<option value="${label}" >${label}<\/option>',f&&f==t[r].label&&(u='<option value="${label}"selected="selected">${label}<\/option>'),n.plan&&n.plan.publishInfo&&n.plan.publishInfo.InPlace&&t[r].label==n.plan.publishInfo.InPlace&&(u='<option value="${label}"selected="selected">${label}<\/option>'),n.$depts.append($.tmpl(u,t[r]))}})}}),t=function(t,i,r){if(n.allUsers=t,n.allJobtitle=i,n.allUserDeptPosition=r,n.approvers=n._getApprovers(),n.$approvers.empty(),n.$approvers.append($.tmpl('<li class="list-group-item" value="${value}">${fullname} - ${username}<\/li>',n.approvers)),n.$("#ApproverName").val(n.approvers[0].fullname+" - "+n.approvers[0].username),n.$("#Approvers").val(n.approvers[0].value),n.plan&&n.plan.publishInfo)n.$approvers.find('option[value="'+n.plan.publishInfo.Approvers+'"]').attr("selected","selected");else if(n.document&&n.document.model){var u=n.document.model.get("UserSuccessId");u&&n.$approvers.find('option[value="'+u+'"]').attr("selected","selected")}n._autoCompleteApprover()},egov.dataManager.getAllUsers({success:function(n){var i=egov.setting.typePositionTitleJob;i===undefined&&(i=0);i===0?egov.dataManager.getAllJobtitle({success:function(i){egov.dataManager.getAllUserDeptPosition({success:function(r){t(n,i,r)}})}}):egov.dataManager.getAllPosition({success:function(i){egov.dataManager.getAllUserDeptPosition({success:function(r){t(n,i,r)}})}})}}),r=[{name:"Thường",value:1},{name:"Mật",value:2},{name:"Tối mật",value:3},{name:"Tuyệt mật",value:4}],n.$securities.empty(),n.$securities.append($.tmpl('<option value="${value}">${name}<\/option>',r)),egov.request.getOrganizations({success:function(t){t=_.uniq(t,function(n){return n.OrganId});n.$("#Organization").html($.tmpl('<option value="${OrganId}">${OrganName}<\/option>',t))}}),n.$datePublish.datepicker({onSelect:function(n){$(inst.input).val(n)}}),n.$("#DateResponse").datepicker({onSelect:function(n){$(inst.input).val(n)}}),n._bindPrivateDept(),n._showDg(),!this.isPlanning){var i=this.document.model.get("StoreId"),u=this.docTypeId?this.docTypeId:this.document.model.get("DocTypeId"),f=this.document.model.get("CategoryId");egov.request.GetStores({data:{docTypeId:u,categoryId:f},success:function(t){n.stores=t;t.length>0&&(n.$stores.empty(),n.$stores.append($.tmpl('<option value="${StoreId}">${StoreName}<\/option>',t)),n.$stores.find("option[value='"+i+"']").attr("selected","selected"),i|=t[0].StoreId,n._showCode(i))}})}n.plan?n._renderPublishPlan():n._renderInfo()},_bindAddress:function(){this.addressGroups=this._getAddressGroups();this.$address.empty();var n=this;_.each(this.addressGroups,function(t){n.$address.append(e(t.trim()));var i=n.model.select(function(i){if(t.equals(n.noneGroup)||t.equals(n.allGroup))return String.isNullOrEmpty(i.get("GroupName"));var r=String.format(";{0};",i.get("GroupName"));return r.contains(String.format(";{0};",t))});i.length!==0&&(n.groups[t.trim()]=i)});this._bindAddressToGroup();this._bindGroupEvents();this._searchAddress();this.$address.find(".toggle-address").first().click();this._showAddressByPlan()},_bindAddressToGroup:function(){var n=this,t=function(t,i){var f=new u({model:t,groupName:i,parent:n}),e,o,r;if(n.plan&&n.plan.publishInfo&&n.plan.publishInfo.Address&&n.plan.publishInfo.Address.length>0)for(e=n.plan.publishInfo.Address,o=e.length,r=0;r<o;r++)t.get("value")===e[r]&&f.model.set("isSelected",!0);n.$address.find("tr[group-name='"+i+"']").after(f.$el);t.view=f};_.each(this.groups,function(n,i){_.each(n,function(n){t(n,i)})})},_bindGroupEvents:function(){var n=this;n.$address.find(".group-name").change(function(){var t=$(this).val(),i=$(this).is(":checked"),r=n.groups[t];n.groupSelected=t;_.each(r,function(n){n.set({isSelected:i})})});n.$address.find(".toggle-address").on("click",function(){var t=$(this).data("show"),r=$(this).data("name"),u,f,i;$(this).data("show",!t);u='<i class="icon icon-arrow-left8">';f='<i class="icon icon-arrow-down8">';t?$(this).addClass("icon-arrow-left8").removeClass("icon-arrow-down8"):$(this).addClass("icon-arrow-down8").removeClass("icon-arrow-left8");i=n.groups[r];_.each(i,function(n){n.set({IsShow:!t})})})},_renderPublishPlan:function(){var n=this,t=n.plan.publishInfo,u,e,i,f,r;t&&(u=t.DateResponse==null?Date.parse(n.document.model.get("DateAppointed")):Date.parse(t.DateResponse),u&&n.$("#DateResponse").datepicker("setDate",u),e=t.SecurityId,n.$securities.find('option[value="'+e+'"]').attr("selected","selected"),i=Date.parse(t.DatePublished),i||(i=new Date),n.$datePublish.datepicker("setDate",i),f=t.Approvers,r=_.find(n.allUsers,function(n){return n.value==f}),r&&n.$("#ApproverName").val(r.fullname+" - "+r.username),n.$("#Approvers").val(f),n.$("#TotalCopy").val(n.plan.publishInfo.TotalCopy),n.$("#TotalPage").val(n.plan.publishInfo.TotalPage))},_showAddressByPlan:function(){var t=this,i=t.plan?t.plan.publishInfo:null,n;i&&(n=i.DateResponeAddress,n&&(t.isChangeDateResponse=!0,_.each(_.keys(n),function(i){if(n[i]!=null){var r=t.model.detect(function(n){return n.get("AddressId")==i}),u=new Date(n[i]);r&&(r.set("DateResponse",u),r.set("DateResponseFormat",u.format("dd/MM/yyyy")))}})))},_renderInfo:function(){var n=this,t=Date.parse(n.document.model.get("DateAppointed")),i;t&&n.$("#DateResponse").datepicker("setDate",t);i=new Date;n.$datePublish.datepicker("setDate",i);n.$search.focus()},_getAddressGroups:function(){var t=this.model.pluck("GroupName"),n=[];return _.each(t,function(t){if(t){var i=t.split(";");n=_.union(n,i)}}),n=_.uniq(n),n.length===0?n.push(this.allGroup):n.push(this.noneGroup),n},_dataProcess:function(n){var t=[];return _.each(n,function(n){var i,r;n.GroupName&&(i=!1,n.GroupName&&(i=n.GroupName.indexOf(";")>-1?!0:!1),i?(r=n.GroupName.split(";"),_.each(r,function(i){var r=$.extend(!0,[],n);r.GroupName=i.trim();t.push(r)})):t.push(n))}),t},_showCode:function(n){var t=this,r=t.document.model.get("DocCode"),u=t.document.model.get("CodeId"),i;if(r!=""?t.$codeId.val(r):t.$codeId.val(""),t.$code.empty(""),i={storeId:n},this.theoLo){if(!this.categoryId)return;i.categoryId=this.categoryId}else i.categoryId=this.categoryId,i.documentId=this.documentId;r==""&&egov.request.GetCodes({data:i,success:function(n){t.codies=n;n&&n.length>0&&(t.$code.append($.tmpl('<div class="list-group-item" value="${CodeId}" text="${Template}">${Template}<\/div>',n)),r===""&&t.$codeId.val(n[0].Template),u==0&&(u=n[0].CodeId),t.plan&&t.plan.publishInfo&&(u=t.plan.publishInfo.CodeId),t.result.set("CodeId",u))}})},_selectCode:function(n){var t=$(n.target).closest(".list-group-item").text(),i=$(n.target).attr("value");this.result.set("CodeId",parseInt(i));this.$codeId.val(t)},_checkCodeUsed:function(){var t=this.$("#Code").val(),n=this;t===""},_selectApprover:function(n){var t=$(n.target).closest("li"),i=t.attr("value");this.$("#ApproverName").val(t.text());this.$("#Approvers").val(i)},_autoCompleteApprover:function(){var n=this,t=n.approvers;this.$("#ApproverName").autocomplete({source:t,focus:function(){return!1},select:function(t,i){var r=i.item;return n.$("#ApproverName").val(r.fullname+" - "+r.username),n.$("#Approvers").val(r.value),!1}}).data("autocomplete")._renderItem=function(n,t){return n.addClass("dropdown-menu"),n.css("zIndex","2000"),$("<li><\/li>").data("item.autocomplete",t).append("<a>"+t.label+"<\/a>").appendTo(n)}},_showDepartment:function(n){if(n!==undefined){this.$depts.find('option[value="'+n+'"]').attr("selected","selected");return}var t=this;egov.dataManager.getCurrentDepartments({success:function(i){i.length>0&&(n=i[0].departmentid,t.$depts.find('option[value="'+n+'"]').attr("selected","selected"))}})},_searchAddress:function(){var n=this,t=this.model.collect(function(n){return{value:n.get("id"),label:n.get("label")}});this.$search.autocomplete({source:t,autoFocus:!0,select:function(t,i){var r=n.model.detect(function(n){return n.get("AddressId")===i.item.value}),f;if(r)return r.view==null&&(f=new u({model:r,parent:n}),n.$address.prepend(f.$el),r.view=f),r.set("isSelected",!r.get("isSelected")),n.$search.val(""),!1}}).data("autocomplete")._renderItem=function(n,t){return n.addClass("dropdown-menu"),n.css("zIndex","2000"),$("<li><\/li>").data("item.autocomplete",t).append("<a>"+t.label+"<\/a>").appendTo(n)}},_showDg:function(){var n=this;n.$dg.is(":not(:empty)")||require(["transferExtend"],function(t){egov.views.dg=new t;egov.views.dg.render(!1,!1,function(){n._dongGui()},function(){n.plan&&window.setTimeout(function(){n._bindData()},300);n.$dg.append(egov.views.dg.$el)})})},_getApprovers:function(){var n=[],f=this.allUsers,r=this.allJobtitle,u=this.allUserDeptPosition,t=egov.setting.typePositionTitleJob,i;return t===undefined&&(t=0),i=egov.setting.user.primaryDepartment,t===0?u.forEach(function(t){var f=t.jobtitleid,u=_.find(r,function(n){return n.value===f&&n.isApprover});u&&egov.setting.transfer.showApproverByDepartment&&(u=i.indexOf(t.idext)===0);u&&n.push({value:t.userid,username:t.username,fullname:t.fullname,label:t.fullname+" - "+t.username,isMain:!0})}):u.forEach(function(t){var f=t.positionid,u=_.find(r,function(n){return n.value===f&&n.isApprover});u&&egov.setting.transfer.showApproverByDepartment&&(u=i.indexOf(t.idext)===0);u&&n.push({value:t.userid,username:t.username,fullname:t.fullname,label:t.fullname+" - "+t.username,isMain:!0})}),n},_dongGui:function(){this.$privateAnounc.empty();egov.views.dg.selectDg(this.$privateAnounc)},_changeStore:function(){var n=this;this.$stores.change(function(){var t=$(this).val();n._showCode(t)})},_rePublish:function(){var n=this,l=this.serialize(),y=this.document.serialize(),h=this.$("#tempAddress").val(),t,a,e,c,v,o,u,s,f,r;if(l.get("Address").length===0&&h===""&&egov.pubsub.publish(egov.events.status.warning,i.noAddressSelected),f=n.document.model.get("DocumentCopyId"),t=n.result.get("DateResponeAddress"),t||(a=n.result.get("Address"),t={},_.each(a,function(i){t[i]=n.result.get("DateResponse")})),t.length==0){egov.pubsub.publish(egov.events.status.error,"Chưa chọn đơn vị nhận");return}e=egov.views.dg.getUserConsults();c=this._getUserReceiveVBDen();e=_.difference(e,_.keys(c));v=egov.views.dg.getDestination();o={};this.document.attachments.model.each(function(n){n.get("isNew")&&!n.get("isRemoved")&&(o[n.get("Id")]={name:n.get("Name")})});u=this.document.attachments.modifiedFiles;$.each(o,function(n,t){u[n]&&(t.content=u[n],delete u[n])});s=this.document.attachments.model.select(function(n){return n.get("isRemoved")});s=_.map(s,function(n){return n.get("Id")});n=this;f=parseInt(this.document.model.get("DocumentCopyId"));egov.pubsub.publish(egov.events.status.processing,egov.resources.common.transfering);r=[];_.each(this.model.where({isSelected:!0}),function(n){r.push({label:n.get("Name"),value:"",type:0})});n.$(".address_0").each(function(n,t){r.push({label:$(t).find(".address-name").text(),value:"",type:0})});r=r.concat(v);egov.request.rePublish({data:{documentCopyId:f,addressRepublish:JSON.stringify(t),doc:JSON.stringify(y),files:JSON.stringify(o),modifiedFiles:JSON.stringify(u),removeAttachmentIds:s,userHasReceiveDocuments:JSON.stringify(c),usersConsult:e,searchAddr:h,targetForComments:JSON.stringify(r)},success:function(t){t.error?egov.pubsub.publish(egov.events.status.error,t.message):(n.$el.dialog("hide"),egov.pubsub.publish(egov.events.status.success,"Phát hành tiếp văn bản thành công!"),n._closeTab([f]),l.get("Address").length===0&&h!==""&&egov.dataManager.clearAddress())},error:function(){egov.pubsub.publish(egov.events.status.error,i.error)}})},_publish:function(){var e=this.serialize(),a=this.document.serialize(),o=this.$("#tempAddress").val(),l,u,t,f,r,h,n;if(e.get("Address").length===0&&o===""){egov.pubsub.publish(egov.events.status.warning,i.noAddressSelected);return}var a=this.document.serialize(),s=egov.views.dg.getUserConsults(),c=this._getUserReceiveVBDen();s=_.difference(s,_.keys(c));l=egov.views.dg.getDestination();u={};this.document.attachments.model.each(function(n){n.get("isNew")&&!n.get("isRemoved")&&(u[n.get("Id")]={name:n.get("Name")})});t=this.document.attachments.modifiedFiles;$.each(u,function(n,i){t[n]&&(i.content=t[n],delete t[n])});f=this.document.attachments.model.select(function(n){return n.get("isRemoved")});f=_.map(f,function(n){return n.get("Id")});r=this;h=parseInt(this.document.model.get("DocumentCopyId"));egov.pubsub.publish(egov.events.status.processing,egov.resources.common.transfering);n=[];_.each(this.model.where({isSelected:!0}),function(t){n.push({label:t.get("Name"),value:"",type:0})});r.$(".address_0").each(function(t,i){n.push({label:$(i).find(".address-name").text(),value:"",type:0})});r.$(".address_mail").each(function(t,i){n.push({label:$(i).find(".address-name").text(),value:"",type:4})});this.targetComments!=null&&(n=n.concat(this.targetComments));n=n.concat(l);egov.request.publish({data:{documentCopyId:h,doc:JSON.stringify(a),files:JSON.stringify(u),modifiedFiles:JSON.stringify(t),removeAttachmentIds:f,publishinfo:JSON.stringify(e),usersConsult:s,userHasReceiveDocuments:JSON.stringify(c),searchAddr:o,targetForComments:JSON.stringify(n)},success:function(n){n.success?(r.$el.dialog("hide"),egov.pubsub.publish(egov.events.status.success,"Phát hành văn bản thành công!"),r._closeTab([h]),e.get("Address").length===0&&o!==""&&egov.dataManager.clearAddress()):egov.pubsub.publish(egov.events.status.error,n.error)},error:function(){egov.pubsub.publish(egov.events.status.error,i.error)}})},_publishPlan:function(){var n=this,t=this.serialize(),r=n.$("#tempAddress").val();if(t.get("Address").length===0&&r==="")egov.pubsub.publish(egov.events.status.warning,i.noAddressSelected);else{egov.pubsub.publish(egov.events.status.processing,egov.resources.common.transfering);var f=egov.views.dg.getUserConsults(),e=egov.views.dg.getExtInfo(),o=parseInt(this.document.model.get("DocumentCopyId")),u=JSON.stringify({publishInfo:t,usersConsult:f,searchAddress:r,extInfo:e});egov.request.publishmentPlan({data:{documentCopyId:o,destination:u},success:function(t){t.error?egov.pubsub.publish(egov.events.status.error,t.error):(egov.pubsub.publish(egov.events.status.success,t.success),n.document.publishPlan=u,n.document.publishPlanId=t.id,n.$el.dialog("destroy"))},error:function(n){console.log(n.message)}})}},_publishTheoLo:function(){var r,u,t,f,n;if(this.documentCopyIds&&!(this.documentCopyIds.length<=0)){if(r=this.serialize(),u=this.$("#tempAddress").val(),r.get("Address").length===0&&u===""){egov.pubsub.publish(egov.events.status.warning,i.noAddressSelected);return}t=_.pluck(egov.views.dg.getUserConsults(),"value");f=this._getUserReceiveVBDen();t=_.difference(t,_.keys(f));n=this;egov.pubsub.publish(egov.events.status.processing,egov.resources.common.transfering);egov.request.publishTheoLo({data:{documentCopyIds:this.documentCopyIds,publishinfo:JSON.stringify(r),usersConsult:t,userHasReceiveDocuments:JSON.stringify(f),searchAddr:u},success:function(t){t.success?(n.$el.dialog("hide"),egov.pubsub.publish(egov.events.status.success,t.success),n._closeTab(n.documentCopyIds),n.parent.removeDocumentByIdsAndSetSelected(n.documentCopyIds,function(){}),egov.callback(n.callback)):egov.pubsub.publish(egov.events.status.error,t.error)},error:function(){egov.pubsub.publish(egov.events.status.error,i.error)}})}},_signAndPublish:function(){if(Plugin){var n=this;n.document.model.set("DocCode",n.$("#Code").val());Plugin.appendPlugin(function(){Plugin.sign(n.document,function(t){if(t=t||!1,t)n.document.model.set("HasCA",!0),n._publish();else return})})}},_bindData:function(n){this.plan&&this.plan.extInfo&&egov.views.dg&&egov.views.dg.bindDataView(this.plan.extInfo);typeof n=="function"&&n()},_closeTab:function(n){if(this.document&&this.document.tab)this.document.tab.close2();else if(egov.views.home&&egov.views.home.tab){if(!n)return;n instanceof Array||(n=[n]);egov.views.home.tab.closeTab(n)}},_getUserReceiveVBDen:function(){var n={},t=this.allUserDeptPosition,r=this.allUsers,i=this.allDepts;return $("#privateDepartments").jstree("get_checked",null,!1).each(function(){var u=$(this),o=this.id,h=u.attr("hasreceivedocument")==="true",s=u.attr("rel")==="dept",r,f,e;s&&(r=_.find(i,function(n){return n.value==o}),r&&(f=r.idext.indexOf(".")<0,e=f?_.filter(t,function(n){return n.departmentid==r.idext&&n.hasReceiveDocument==!0}):_.filter(t,function(n){return n.idext.indexOf(r.idext)==0&&n.hasReceiveDocument==!0}),_.each(e,function(t){n[t.userid]=r.label})))}),n},_bindPrivateDept:function(){var n=this;egov.dataManager.getAllUserDeptPosition({success:function(t){n.allUserDepts=t;egov.dataManager.getAllDept({success:function(t){n.allDepts=t;n._bindDepartments()}})}})},_bindDepartments:function(){var n=this,t=n.allDepts;n.$("#privateDepts").customDropdown({css:{width:300,height:"auto"}});_.each(t,function(t){var i=t.value,r=_.find(n.allUserDepts,function(n){return n.departmentid===i&&n.hasReceiveDocument});r||(t.state="disabled")});egov.utils.treeUtil.bindJsTree($("#privateDepartments"),!1,!0,!1,t,[],[],null,[]);$("#privateDepartments").bind("change_state.jstree",function(t,i){var r=i.rslt.attr("idext").indexOf(".")<0;r&&i.rslt.is(".jstree-checked")&&i.rslt.find(".jstree-checked").removeClass("jstree-checked").addClass("jstree-unchecked");n._changeDepartmentReceive()})},_changeDepartmentReceive:function(){var n=this,t=this.allDepts;n.$(".private-dept ul").empty();n.selectedDeptIds=[];n.targetComments=[];$("#privateDepartments .jstree-checked").each(function(){var u=$(this),o=u.attr("id"),e=u.is(".jstree-disabled"),s=u.attr("rel")==="dept",i,f;s&&(i=_.find(t,function(n){return n.value==o}),i&&(n.selectedDeptIds.push(i.idext),f=e?i.data+" (không có người nhận)":i.data,n.$(".private-dept ul").append(r(i.value,f)),n.targetComments.push({label:f,value:"",disabled:e,type:0})))})}}),u=Backbone.View.extend({tagName:"tr",events:{"click .checkbox":"selected"},initialize:function(n){this.parent=n.parent;this.groupName=n.groupName;this.$mainAddress=this.parent.$mainAddress;this.model.set({DateResponse:null});this.model.set({DateResponseFormat:""});this.model.on("change:isSelected",function(n,t){if(t){this.$(":checkbox").prop("checked",!0);var i=n.get("DateResponse")!=null?"- "+n.get("DateResponseFormat"):"";this.$mainAddress.find(':checkbox[value="'+n.get("AddressId")+'"]').length===0&&this.$mainAddress.append(r(n.get("AddressId"),n.get("Name"),i,this.groupName))}else this.$(":checkbox").prop("checked",!1),this.$mainAddress.find(':checkbox[value="'+n.get("AddressId")+'"]').parents("li.list-group-item").remove()},this);this.model.on("change:DateResponseFormat",function(n){var t="[id='dateItem"+n.get("AddressId")+"']";this.parent.$mainAddress.find(t).text("- "+n.get("DateResponseFormat"))},this);this.model.on("change:IsShow",this.toggle,this);this.render()},toggle:function(){this.model.get("IsShow")?this.$el.show():this.$el.hide()},render:function(){return this.$el.append($.tmpl(t,this.model.toJSON())),this.$el.attr("group-by",this.groupName),this.toggle(),this},selected:function(){var n=this.$el.find(":checked").length>0;this.model.set("isSelected",n)}}),r=function(n,t,i,r){var u='<li class="list-group-item address_{0}" group-by="'+r+'">                                <div class="row">                                    <label class="checkbox document-color">                                       <input name="checkbox[]" value="{0}" type="checkbox" checked="checked">                                        <span class="document-color-1"><i class="icon-check"><\/i><\/span>                                    <\/label>                                    <span class="address-name" style="margin-left: 15px;">{1}<\/span>                                     <span id="dateItem{0}" style="color: red">{2}<\/span>                                <\/div>                            <\/li>';return $(String.format(u,n,t,i))},e=function(n){return $(String.format('<tr group-name="{0}"><td>      <label class="checkbox document-color">          <input class="group-name" name="checkbox[]" value="{0}" type="checkbox">          <span class="document-color-1"><i class="icon-check"><\/i><\/span>      <\/label>  <\/td>  <td class="wraptext " style="font-weight: bold; width: 300px;" >      {0} <i class="icon icon-arrow-left8 toggle-address pull-right" data-show="false" data-name="{0}"><\/i><\/td>  <\/tr>',n))};return f});