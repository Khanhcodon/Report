define([egov.template.document.consult],function(n){"use strict";var t=egov.resources.document.consult;return Backbone.View.extend({template:n,events:{"click .private-anoun .checkbox":"uncheckPrivateAnoun"},initialize:function(){return this.$el.html(this.template),this.$el.bindResources(),this.forContext=!1,this.$dg=this.$(".dg-view"),this.$privateAnounc=this.$(".private-anoun ul:first"),this.$comment=this.$(".comment"),this},render:function(n){this._clear();this.document=n.document;this._openDialog()},renderForContext:function(n){this._clear();this.forContext=!0;this.documentCopySelected=n;this._openDialog()},uncheckPrivateAnoun:function(n){if(egov.views.dg){var t=$(n.target).parent().find(":checkbox");if(t.length===0)return;egov.views.dg.uncheckPrivateAnoun(t.val());this._selectDg()}},_openDialog:function(){this._showDg();var n=this;this.$el.dialog({title:t.dialogTitle,width:"780px",height:"290px",draggable:!0,buttons:[{text:t.consultButton,className:"btn-primary",click:function(){n._consult()}},{text:egov.resources.common.closeButton,className:"btn-close",click:function(){n.$el.dialog("hide")}}]});this.$el.bindResources()},_consult:function(){var r=this.$comment.val(),n,i,f,u,e;if(r===""){egov.message.warning(t.noComment);this.$comment.focus();return}if(n=egov.views.dg.getUserConsults(),!n||n.length===0){egov.message.warning(t.noReceiver);return}i=egov.views.dg.getDestination();_.each(i,function(n){n.type=egov.enum.transferType.xyk});this.forContext?this._consultForContext(r,n,i):(f=this.document.serialize(),u={},this.document.attachments&&this.document.attachments.model&&this.document.attachments.model.length>0&&this.document.attachments.model.each(function(n){n.get("isNew")&&(u[n.get("Id")]={name:n.get("Name")})}),e=this.document.attachments.model.select(function(n){return n.get("isRemoved")}),this._consultFortolbar(f,r,n,u,e,i))},_consultFortolbar:function(n,i,r,u,f,e){var o=this;egov.message.processing(egov.resources.common.transfering,!1);egov.request.TransferConsult({data:{doc:JSON.stringify(n),files:JSON.stringify(u),modifiedFiles:JSON.stringify(this.document.attachments.modifiedFiles),removeAttachmentIds:f,usersConsult:r,contentRequest:i,targetForComments:JSON.stringify(e)},success:function(n){n.success?(egov.message.success(t.sendSuccess),o.$el.dialog("hide")):egov.message.error(t.sendFail)},error:function(){egov.message.error(t.sendFail)}})},_consultForContext:function(n,i,r){egov.message.processing(egov.resources.common.transfering,!1);egov.request.TransferConsultContext({data:{documentCopyId:this.documentCopySelected,usersConsult:i,contentRequest:n,targetForComments:JSON.stringify(r)},success:function(n){n.success?egov.message.success(t.sendSuccess):egov.message.error(t.sendFail)},error:function(){egov.message.error(t.sendFail)}})},_showDg:function(){var n=this;n.$dg.is(":not(:empty)")||require(["transferExtend"],function(t){egov.views.dg||(egov.views.dg=new t);egov.views.dg.render(!1,!1,function(){n._selectDg()},function(){n.$dg.append(egov.views.dg.$el)});n.$comment.focus()})},_selectDg:function(){this.$privateAnounc.empty();egov.views.dg&&egov.views.dg.selectDg(this.$privateAnounc)},_clear:function(){this._destroyDg();this.$privateAnounc.empty()},_destroyDg:function(){egov.views.dg&&egov.views.dg.destroy()}})});