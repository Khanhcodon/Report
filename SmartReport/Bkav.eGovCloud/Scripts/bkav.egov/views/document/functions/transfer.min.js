define([egov.mobile?egov.template.transfer.transferMobile:egov.template.transfer.transfer,egov.mobile?egov.template.transfer.transferItemMobile:egov.template.transfer.transferItem],function(n,t){"use strict";var i=egov.resources.document.transfer,e=Backbone.View.extend({className:"transfer-form row",template:n,model:egov.viewModels.actionUserList,keyCode:{s:83,f:70,esc:27,enter:13,tab:9},events:{"click .checkAll":"allCoProcessor","click .result-view .checkbox":"removeUserSelected","click .showCoProcess":"showHideDg","click .annouce-user .checkbox":"uncheckThongBao","click .co-process-user .checkbox":"uncheckPrivateAnoun","click .transfer-tab li":"showMobileTab","change .transfer-filter__position":"_filterUser","change .transfer-filter__dept":"_filterUser"},initialize:function(){var n=this;n.dgSerialize=undefined;n.destination={};n.$el.append(n.template);n.$el.bindResources();n.$listUser=n.$(".listUsers:first");n.$mainUsers=n.$(".main-process-user > ul:first");n.$coUsers=n.$(".co-process-user > ul:first");n.$annouceUsers=n.$(".annouce-user > ul:first");n.$dg=n.$(".dg-view:first");n.$result=n.$(".result-view");n.$filter=n.$(".searchUser");n.storePrivate=egov.views.home.tree.storeTree;n.model.on("reset",function(t){if(n._clear(),t.length===0){n.$listUser.append($("<li>").addClass("list-group-item").text(i.noUserByAction));n.dialogSetting.height="100px";this.$el.attr("help-content-page","transfer");n.$el.dialog(n.dialogSetting);n.$(".listUsers").siblings().hide();return}t.each(function(i){var f=n.allUser,r=new u({model:i,parent:n});n.$listUser.append(r.el);t.length===1?(r.model.set("isMainProcess",!0),r.$el.addClass("selected")):(r.model.set("isMainProcess",!0),r.$el.addClass("selected"))});n._autocompleteUser()});return n.hasContinue=!1,n.requireXlc=egov.setting.transfer.requireXlc,this},render:function(n){this._clear();n.action instanceof egov.models.action||(n.action=new egov.models.action(n.action));this.action=n.action;this.document=n.document;this.isHSMC=this.document.categoryBusinessId==egov.enum.categoryBusiness.hsmc;this.callback=n.callback;this.plan=n.plan;this.theoLo=!1;this.isQuickTransfer=n.isQuickTransfer;!egov.setting.userSetting.ShowTranferFormWhenQuickAction&&this.action.get("isSpecial")?this._transferSpecial():this._open(this.plan?!0:!1);this.$el.bindResources()},renderTransferExtends:function(){if(!this.$dg.is(":not(:empty)")){var n=this;require(["transferExtend"],function(t){egov.views.dg||(egov.views.dg=new t);egov.views.dg.render(!0,!1,function(){n._selectDg()},function(){n.$dg.append(egov.views.dg.$el)})})}},renderTheoLo:function(n){this._clear();n.action instanceof egov.models.action||(n.action=new egov.models.action(n.action));this.action=n.action;this.theoLo=!0;this.documentCopyIds=n.documentCopyIds;this.documents=n.documents;this.document=n.document;this.isHSMC=this.documents&&this.documents.length>0&&this.documents[0].categoryBusinessId==egov.enum.categoryBusiness.hsmc;this.comment=n.comment;this.callback=n.callback;this.callbackCloseForm=n.callbackCloseForm;this._openChuyenTheoLo();this.$el.bindResources()},renderAnticipate:function(n){this._clear();n.action instanceof egov.models.action||(n.action=new egov.models.action(n.action));n.model instanceof egov.models.actionUserList||(n.model=new egov.models.actionUserList(n.model));this.theoLo=!1;this.isHSMC=this.document.categoryBusinessId==egov.enum.categoryBusiness.hsmc;this.action=n.action;this.parent=n.parent;this.model=n.model;this.callback=n.callback;this._renderAnticipate();this.$el.bindResources()},removeUserSelected:function(n){var i=$(n.target).closest(".checkbox"),r=i.find(":checkbox").val(),t=this.model.detect(function(n){return n.id==r});t&&(t.get("isMainProcess")&&t.set("isMainProcess",!1),t.get("isCoProcess")&&t.set("isCoProcess",!1),this.showSelected());egov.helper.destroyClickEvent(n)},uncheckPrivateAnoun:function(n){if(egov.views.dg){var t=$(n.target).closest(":checkbox");if(t.length===0)return;egov.views.dg.uncheckPrivateAnoun(t.val());this._selectDg()}},uncheckThongBao:function(n){egov.views.dg&&(egov.views.dg.uncheckThongBao(n),this._selectDg())},allCoProcessor:function(n){var i=$(n.target).closest(".checkbox"),t;i.toggleClass("checked");t=i.hasClass("checked");this.model.each(function(n){var r=n.get("value"),i=this.$('.listUsers li[userid="'+r+'"]');i.is(":visible")&&(n.set("isCoProcess",t),t?i.find(".co-process").addClass("checked"):i.find(".co-process").removeClass("checked"))}.bind(this));egov.helper.destroyClickEvent(n)},serialize:function(){var t=this.model.detect(function(n){return n.get("isMainProcess")}),n=this.model.select(function(n){return n.get("isCoProcess")}),s,u,h;if(t===undefined){if(n.length===0)return null;n.length===1&&(t=n[0],n.splice(0,1))}var f=egov.enum.transferType,r=[],i=[],e=!1,o=!1;return t?(this.destination.UserIdXlc=t.get("id"),r.push({label:t.get("fullname"),department:t.get("department"),value:"",type:f.xulychinh}),i=_(n).chain().pluck("id").value(),i&&i.length>0&&(i=_.filter(i,function(n){return n!==t.get("value")}))):i=_.pluck(n,"id"),n.length>0&&(s=_.map(n,function(n){return n.get("fullname")}),u=_.map(n,function(n){return n.get("department")}),u=_.uniq(u,function(n){return n}),r.push({label:s.join(", "),department:u.join(", "),value:"",type:f.dongxuly})),egov.views.dg&&(r=r.concat(egov.views.dg.getDestination()),h=egov.views.dg.getExtInfo(),e=egov.views.dg.checkIsDongGui(),o=!e),this.destination.UserIdsDxl=i,this.destination.IsThongbao=o,this.destination.IsDxl=!0,this.destination.IsAttachYk=!1,this.destination.UserIdsDg=egov.views.dg?egov.views.dg.getUserConsults():[],this.destination.UserTb=egov.views.dg?egov.views.dg.getUserThongBao():[],this.destination.NextNodeId=this.action.get("nextNodeId"),this.destination.CurrentNodeId=this.action.get("currentNodeId"),this.destination.WorkflowId=this.action.get("workflowId"),this.destination.NewDocTypeId=this.document?this.document.newDoctype:undefined,this.destination.TargetComment=JSON.stringify(r),this.destination.ActionId=this.action.get("id"),this.destination.ExtInfo=JSON.stringify(h),this.destination.PublishPlanId=this.document?this.document.publishPlanId:0,this.destination},showMobileTab:function(n){var r=this,i=$(n.currentTarget),t;i.siblings().removeClass("active");i.addClass("active");t=i.attr("tab-show");this.$(".transfer-tabs").not("#"+t).hide();this.$(".transfer-tabs#"+t).show();t=="dg-view"&&this.renderTransferExtends()},showHideDg:function(n){var t=this;n?(this.$dg.show(),this.$result.height(320)):(this.$dg.hide(),this.$result.height(175));this.renderTransferExtends()},_unCheckShowHideDg:function(n){n&&(n instanceof jQuery||(n=$(n)),$(n).is(".showCoProcess")&&n.find(".checkbox").hasClass("checked")&&(n.find(".checkbox").removeClass("checked"),n.find('input[name="checkDongGui"]').prop("checked",!1),this.$dg.removeClass("col-md-9"),this.$dg.hide(),this.$result.removeClass("col-md-7 show-dg")))},_clear:function(){this.model=egov.viewModels.actionUserList;this.$listUser.empty();this.$mainUsers.empty().append('<li class="list-group-item ">'+i.noXlc+"<\/li>");this.$coUsers.empty();this.$annouceUsers.empty();this.$result.height(175);this.destination={};this.$dg&&this.$dg.hide();this.mainProcess&&(this.mainProcess=undefined);this.destroyDg()},_open:function(n){var t,r,u,f,i;t=this;r=t.action.get("id");u=t.action.get("workflowId");f=t.document.model.get("DocumentCopyId");t.$filter.empty().focus();t._renderDialog();i=egov.setting.transfer.isfasttransfer;i===!1?($("#titleSimple").addClass("hidden"),$("#left_content").removeClass("hidden"),$("#right_content").removeClass("hidden")):($("#titleSimple").removeClass("hidden"),$("#left_content").addClass("hidden"),$("#right_content").addClass("hidden"));t._bindUsers(n)},_bindUsers:function(n){var t=this,u,f,e,i,r,o,s;if(u=t.action.get("id"),f=t.action.get("workflowId"),e=t.document.model.get("DocumentCopyId"),i=t.action.get("isSpecial"),n=n&&!i,r=function(i){n?t._renderDialogPlan():t._sortUsersByAction(i,function(n){t.model.reset(n)})},i)return o=_.find(egov.setting.allUsers,function(n){return n.value===t.action.get("userIdNext")}),s=[o],r(s);egov.dataManager.getUserByAction(u,f,e,{success:function(n){r(n);$("#nameDepart").text(n[n.length-1].position)}})},_sortUsersByAction:function(n,t){var u,i,r,f;if(n.error){egov.callback(t,[]);return}if(this.$(".transfer-filter__position").empty().html('<option value="">Tất cả<\/option>'),this.$(".transfer-filter__dept").empty().html('<option value="">Tất cả<\/option>'),n.length===1){egov.callback(t,n);return}u=this;i=[];r=_.find(n,function(n){return n.value===egov.setting.userId});u._getSpecialUsers(n,function(u){u=[];f=_.difference(n,u);i=_.union(u,f);r&&i.push(r);egov.callback(t,i)})},_getSpecialUsers:function(n,t){var r,i,o,s,h,c,l,u,e,f;if(r=this,this.theoLo||(o=r.document.model.get("UserCreatedId"),s=r.document.model.get("CommentList")&&r.document.model.get("CommentList").length>0?r.document.model.get("CommentList")[0].UserSendId:undefined),h=egov.setting.userId,c=5,i=_.find(n,function(n){return n.value===s}),i){egov.callback(t,[i]);return}if(i=_.find(n,function(n){return n.value===o}),i){egov.callback(t,[i]);return}if(n.length<=c){egov.callback(t,[]);return}l={success:function(r){if(u=_.pluck(_.filter(r,function(n){return n.userid===h}),"idext"),u.length===0){egov.callback(t,[]);return}if(_.each(n,function(n){n.depts=_.pluck(_.filter(r,function(t){return t.userid===n.value}),"idext")}),i=_.filter(n,function(n){return(e=_.intersection(u,n.depts),e.length>0)?(n.sameDepts=e,!0):!1}),i){i=_.sortBy(i,function(n){return egov.getLevelOfDept(_.max(n.sameDepts,function(n){return egov.getLevelOfDept(n)}))});egov.callback(t,i.reverse());return}if(f=_.map(u,function(n){return n.substr(0,n.lastIndexOf("."))}),i=_.filter(n,function(n){return _.intersection(f,n.depts).length>0}),i){egov.callback(t,i);return}if(i=_.filter(n,function(n){return f=_.map(n.depts,function(n){return n.substr(0,n.lastIndexOf("."))}),_.intersection(u,f).length>0}),i){egov.callback(t,i);return}}};egov.dataManager.getAllUserDeptPosition(l)},_openChuyenTheoLo:function(){if(!this.documentCopyIds||this.documentCopyIds.length<=0){egov.message.error(egov.resources.transfer.HasNoneDocument);egov.pubsub.publish(egov.events.status.error,"Bạn chưa chọn văn bản!");return}var n=this;n.$filter.empty().focus();n._renderDialog();egov.request.getUserByActionTheoLo({data:{actionId:this.action.get("id"),workflowId:this.action.get("workflowId"),documentCopyIds:this.documentCopyIds},success:function(t){n._sortUsersByAction(t,function(t){n.model.reset(t)})}})},_renderAnticipate:function(){var t=this,n,i,r,f;if(this.model&&this.model.length>0)for(n=0;n<this.model.length;n++)i=this.model.at(n),r=new u({model:i,parent:t}),this.$(".listUsers").append(r.$el);$("body").bind("keydown",function(n){t._eventKeyboard(n,this)});this._autocompleteUser();this.$el.bindResources();egov.callback(this.callback,this.$el);this.$("#searchUser").empty().focus();this.$(".listUsers")[0].scrollHeight>this.$(".listUsers").height()?this.$(".checkAll").css({right:"15px"}):(f=this.$(".listUsers")[0].scrollWidth-this.$(".listUsers").width(),this.$(".checkAll").css({right:f+"px"}))},_renderDialog:function(){var n=this,f=egov.setting.transfer.isfasttransfer,t,r,e,u;n.$listUser.empty();t={title:i.dialogTitle,width:"900px",draggable:!0,keyboard:!0,height:"auto",resizable:!0};this.$(".listUsers").siblings(":not(.dg-view)").show();egov.isMobile||(r=egov.setting.userSetting.hasShowDongGui,t.confirm={text:"Nâng cao",id:"transferDg",style:{float:"left","font-weight":"normal","font-size":"13px",color:"blue"},click:function(t){f===!0&&(t?$("#titleSimple").addClass("hidden"):$("#titleSimple").removeClass("hidden"),t?$("#left_content").removeClass("hidden"):$("#left_content").addClass("hidden"),t?$("#right_content").removeClass("hidden"):$("#right_content").addClass("hidden"));n.showHideDg(t)},hasAutoClick:r});e=n.document&&n.document.isCreate;t.buttons=[{id:"sendTransferAndContinue",text:"Chuyển và tiếp tục",className:n.action.get("isAllowSign")?"btn-info":"hidden",disableProcess:!0,click:function(t){n._validXlc()?n._sendAndContinue(t):egov.callback(t)}},{id:"sendTransfer",text:i.transferButton,className:"btn-primary",disableProcess:!0,click:function(t){n._validXlc()?n._send(t):egov.callback(t)}},{id:"sendTransferAndSign",text:"Ký và Chuyển",className:n.action.get("isAllowSign")?"btn-info ":"hidden",disableProcess:!0,click:function(t){n._validXlc()?n._saveInSign(t):egov.callback(t)}},{id:"closeTransfer",text:egov.resources.common.closeButton,className:"btn-close",click:function(){n.theoLo&&egov.callback(n.callbackCloseForm);n.destroyDg();n.$el.dialog("hide")}}];$("body").bind("keydown",function(t){n._eventKeyboard(t,this)});this.dialogSetting=t;this.$el.dialog(t);this._autocompleteUser();this.$("#searchUser").empty().focus();this.$(".listUsers")[0].scrollHeight>this.$(".listUsers").height()?this.$(".checkAll").css({right:"15px"}):(u=this.$(".listUsers")[0].scrollWidth-this.$(".listUsers").width(),this.$(".checkAll").css({right:u+"px"}))},_transferSpecial:function(){var n=this;this.document.isCreate?n._transferTiepNhan():(this.destination.UserIdXlc=this.action.get("userIdNext"),this.destination.UserIdsDxl=[],this.destination.IsThongbao=!1,this.destination.IsDxl=!1,this.destination.IsAttachYk=!1,this.destination.UserIdsDg=[],this.destination.NextNodeId=this.action.get("nextNodeId"),this.destination.CurrentNodeId=this.action.get("currentNodeId"),this.destination.WorkflowId=this.action.get("workflowId"),this.destination.TargetComment="[]",this._transferNormal())},_autocompleteUser:function(){var n=this,t,i=function(i){i&&(i.get("isMainProcess")?i.set("isMainProcess",!1):i.get("isCoProcess")?i.set("isCoProcess",!1):n.mainProcess?i.set("isCoProcess",!0):i.set("isMainProcess",!0),t=null);n.$filter.val("")};this.$filter.autocomplete({source:this.model.toJSON(),focus:function(t,i){return n.$filter.val(i.item.username),!1},select:function(t,r){var u=n.model.detect(function(n){return n.id===r.item.id});return i(u),!1}}).on("keydown",function(r){if(r.keyCode==13&&t){var u=n.model.detect(function(n){return n.id===t.id});return i(u),$(".ui-autocomplete").hide(),!1}}).data("autocomplete")._renderItem=function(n,i){return n.addClass("dropdown-menu"),t=i,$("<li><\/li>").data("item.autocomplete",i).append("<a>"+i.label+"<\/a>").appendTo(n)}},_filterUser:function(){var n=this.$(".transfer-filter__position").val(),t=this.$(".transfer-filter__dept").val();if(n==""&&t==""){this.$(".listUsers li").show();return}this.$(".listUsers li").each(function(){var r=$(this).attr("position"),u=$(this).attr("dept"),i=!0;i=String.isNullOrEmpty(n)?i:r===n;i=String.isNullOrEmpty(t)?i:u===t;i?$(this).show():$(this).hide()})},send:function(n){this._send(n)},_send:function(n){var t=this,r=function(){var r=t.serialize(),u;if(!r){egov.pubsub.publish(egov.events.status.warning,i.noUser);egov.callback(n);return}if(t.isHSMC&&r.UserIdXlc==undefined){egov.pubsub.publish(egov.events.status.error,i.hsmsNoXlc);return}t.theoLo?t._transferTheoLo(n):(u=function(){t.document.isCreate?(t.$el.dialog("hide"),t._transferNormal(0,function(){egov.callback(n)})):t.document.model.get("HasPrivateSaveToStore")==!0?(t.$el.dialog("hide"),require(["savePrivateStore"],function(i){var i=new i;i.render({document:t.document,callback:function(i){i!=undefined&&(t.storeId=i.storeId,t.code=i.code,t.codeId=i.codeId,t._transferNormal(null,function(){egov.callback(n);egov.callback(callback2)}))}})})):t._transferNormal(null,n)},u())};r()},_signAndSend:function(n){var t=this,r;if(t.action.get("isAllowSign")&&Plugin){if(r=t.serialize(),!r){egov.pubsub.publish(egov.events.status.warning,i.noUser);egov.callback(n);return}Plugin.appendPlugin(function(){Plugin.sign(t.document,function(i){(i=i||!1,i)&&(t.document.isTransferTheoLo?t._send(n):(t.document.model.set("HasCA",!0),t.document.attachments.confirmAttachments(function(){t._send(n)})))})})}},_saveInSign:function(n){var t=this;t.document._exportDocToSign(function(i){var r=i.fileName,u=new egov.models.attachment({Id:0,Name:r.fileName,Size:100,Extension:".docx",Versions:[{Version:1,User:egov.setting.fullName+" ("+egov.setting.userName+")"}],isNew:!0,isUploading:!0});u.set("Id",r.key);t.document.attachments.model.add(u);t._signAndSend(n)})},_sendAndContinue:function(n){var t=this;t.action.get("isAllowSign")||(t.hasContinue=!0,t._send(n))},_transferNormal:function(n,t){var r=this,c="Normal",u,f,o,h=r.document.model.get("DocumentCopyId"),l,s,e;egov.pubsub.publish(egov.events.status.processing,egov.resources.common.transfering);var a=function(){if(r.destroyDg(),r.$el.dialog("hide"),r.document.isSaveChanged=!0,c=="TiepNhanHoSoVaTiepTuc")egov.pubsub.publish(egov.events.status.success,"Tiếp nhận hồ sơ thành công.");else{if(r.document.isPopUp)return;r.document.$el.removeClass("display");egov.isMobile||(r.document.tab.display(!1),egov.views.home.tab.activeTab(0));var n;u&&u.TransferTypeInEnum=="TraLoi"&&(n=parseInt(u.relationAnswerId),egov.views.home.tab.closeTab([n]));r._reloadDocumentList(n&&isNaN(n)?[r.document.model.get("DocumentCopyId"),n]:[r.document.model.get("DocumentCopyId")]);egov.callback(r.callback)}},v=function(n){if(n.success){if(egov.pubsub.publish(egov.events.status.success,i.transferSuccess),r._closeTab([h]),r._reloadDocumentList([h]),r.document.cacheCodeNotation(),r.hasContinue){var u=r.document.model.get("DocTypeId"),f=r.document.model.get("DocTypeName");r.hasContinue=!1;egov.views.home.tab.addDocument(u,f,null,null,null,null,null,r.document.model)}}else egov.isMobile||r.document.tab.display(!0),egov.pubsub.publish(egov.events.status.error,n.error),egov.callback(t)},y=function(n){r.document.tab.display(!0);r.document.tab.errorTab();n=n||i.transferError;egov.pubsub.publish(egov.events.status.error,n)};l=this.destination?this.destination.UserIdsDxl.length>1&&!this.destination.UserIdXlc:!1;u=this.document.serialize();this.storeId&&this.code&&(u.StoreId=this.storeId,u.DocCode=this.code,u.CodeId=this.codeId);o={};this.document.attachments.model.each(function(n){n.get("isNew")&&!n.get("isRemoved")&&(o[n.get("Id")]={name:n.get("Name")})});s=this.document.attachments.model.select(function(n){return n.get("isRemoved")});s=_.map(s,function(n){return n.get("Id")});e=this.document.attachments.modifiedFiles;$.each(o,function(n,t){e[n]&&(t.content=e[n],delete e[n])});f=this.document.getDestinationPlan();f&&(f=JSON.stringify(f));egov.request.transfer({data:{doc:JSON.stringify(u),destination:this.destination?JSON.stringify(this.destination):"",files:JSON.stringify(o),modifiedFiles:JSON.stringify(e),removeAttachmentIds:s,storePrivateId:n==null?0:n,destinationPlan:f},success:function(n){v(n)},error:function(n){y(n.statusMessage)}});a()},_transferTheoLo:function(n){var t=this,r;egov.pubsub.publish(egov.events.status.processing,egov.resources.common.transfering);r=this.comment;typeof this.comment=="string"&&(r={},_.each(this.documentCopyIds,function(n){r[n]=r}));egov.request.transferTheoLo({data:{documentCopyIds:this.documentCopyIds,destination:this.destination?JSON.stringify(this.destination):"",comments:JSON.stringify(r),modifyAttachments:t.document?JSON.stringify(t.document.modifyAttachments):null,files:t.document?JSON.stringify(t.document.newFiles):null,removeAttachmentIds:t.document?JSON.stringify(t.document.removeFiles):null},success:function(r){r.success?(egov.callback(n),t._reloadDocumentList(t.documentCopyIds),egov.pubsub.publish(egov.events.status.success,i.transferSuccess)):(egov.pubsub.publish(egov.events.status.error,r.error),egov.callback(n))},error:function(){egov.pubsub.publish(egov.events.status.error,i.transferError);egov.callback(n)}});t.destroyDg();t.$el.dialog("destroy");t.documents.selectedNextCurrent(function(n){var i=function(){n&&n.set("Selected",!0)};t.documents.removeDocumentByIds(t.documentCopyIds,function(){i()})});egov.callback(t.callback)},_transferTiepNhan:function(){var r=this.document.serialize(),t={},n;this.document.attachments.model.each(function(n){n.get("isNew")&&(t[n.get("Id")]={name:n.get("Name")})});n=this;egov.pubsub.publish(egov.events.status.processing,egov.resources.common.transfering);egov.request.TransferTiepNhan({data:{doc:JSON.stringify(r),files:JSON.stringify(t)},success:function(t){t.success?(n._closeTab(),egov.pubsub.publish(egov.events.status.success,"Tiếp nhận hồ sơ thành công."),n.document._reloadDocumentTree()):(egov.isMobile||n.document.tab.display(!0),egov.pubsub.publish(egov.events.status.error,data.error))},error:function(){egov.isMobile||n.document.tab.display(!0);egov.pubsub.publish(egov.events.status.error,i.transferError)}});n.document.$el.removeClass("display");egov.isMobile||(n.document.tab.display(!1),n.action.get("id")===egov.enum.actionSpecial.tiepNhanHoSoVaTiepTuc.name?egov.views.home.tab.addDocument(n.document.model.get("DocTypeId"),n.document.model.get("DocTypeName")):(n.document._reloadDocumentTree(),egov.views.home.tab.activeTab(0)))},_selectDg:function(){var n,t,i=this;this.$(".co-process-user > ul").empty();this.$(".annouce-user > ul").empty();this.$(".giamsat-user > ul").empty();this.showSelected();n=this.$(".co-process-user > ul");t=this.$(".annouce-user > ul");egov.views.dg.selectDg(n,t);return},_getUserConsults:function(){var n,i,u,f,e,t;return egov.views.dg?(n=egov.views.dg.serialize(),i=[],n===undefined)?i:(u=egov.dataManager.getAllUserDeptPosition({success:function(n){return n}}),f=egov.dataManager.getAllUsers({success:function(n){return n}}),n.isAllUser||n.isAllDept&&n.isAllJobtitle)?_.pluck(f,"value"):(n.users.length>0&&(e=_.pluck(n.users,"value"),$.extend(i,e)),n.depts.length>0&&$.extend(i,r(_.pluck(n.depts,"value"))),n.isAllDept?!n.isAllJobtitle&&n.jobtitlies.length>0&&(t=_.filter(u,function(t){return _.find(n.jobtitlies,function(n){return n.value===t.jobtitleid})}),t.length>0&&$.extend(i,r(_.pluck(t,"departmentid")))):n.isAllJobtitle?!n.isAllDept&&select.jobDepts.length>0&&(t=_.filter(u,function(t){return _.find(n.jobDepts,function(n){return n.departmentid===t.departmentid})}),t.length>0&&$.extend(i,r(_.pluck(t,"departmentid")))):n.jobtitlies.length>0&&(t=_.filter(u,function(t){var i=_.find(n.jobDepts,function(n){return n.departmentid===t.departmentid}),r=_.find(n.jobtitlies,function(n){return n.value===t.jobtitleid});return i&&r}),t.length>0&&$.extend(i,r(_.pluck(t,"departmentid")))),_.uniq(i,!1)):[]},_eventKeyboard:function(n,t){if(n){if(t instanceof jQuery||(t=$(t)),n.keyCode===this.keyCode.tab){this.$("#searchUser:focus").length>0?t.find("#sendTransfer").focus():t.find("#sendTransfer:focus").length>0?t.find("#closeTransfer").focus():t.find("#closeTransfer:focus").length>0&&this.$("#searchUser").focus();return}n.keyCode===this.keyCode.esc?this.$el.dialog("destroy"):n.ctrlKey&&n.keyCode===this.keyCode.f?this.$("#searchUser").focus():n.ctrlKey&&n.keyCode===this.keyCode.s&&this._send()}},defaultMainAndCoProcess:function(){this.model&&this.model.length>0&&this.model.forEach(function(n){n.set("isMainProcess",!1);n.set("isCoProcess",!1)})},showSelected:function(){var n=this,t;this.$mainUsers.empty();this.$coUsers.empty();t=0;this.model.each(function(i){var r,u=i.get("fullname")+" - "+i.get("username");n.mainProcess?i.get("isMainProcess")?(r=f(i.get("value"),u,!0),n.$mainUsers.append(r)):i.get("isCoProcess")&&(r=f(i.get("value"),u),n.$coUsers.append(r)):(i.get("isMainProcess")||i.get("isCoProcess"))&&(r=f(i.get("value"),u,!0),n.$mainUsers.append(r));i.get("isCoProcess")&&(t=t+1)});n.$mainUsers.is(":empty")&&n.$mainUsers.append('<li class="list-group-item ">'+i.noXlc+"<\/li>");t===this.model.length?this.$(".checkAll").addClass("checked"):this.$(".checkAll").removeClass("checked")},_renderDialogPlan:function(){var r=this,e,n,f,t;for(this.$listUser.empty(),this.$dg.empty(),e={title:i.dialogTitle,width:"900px",draggable:!0,keyboard:!0,height:"420px",buttons:[{id:"sendTransferPlan",text:i.transferButton,className:"btn-primary",disableProcess:!0,click:function(n){r._send(n)}},{id:"closeTransferPlan",className:"closeDialog",text:egov.resources.common.closeButton,click:function(){egov.views.dg&&egov.views.dg.destroy();r.$el.dialog("hide")}}]},this.$(".listUsers").siblings(":not(.dg-view)").show(),n=0;n<this.model.length;n++)f=this.model.at(n),t=new u({model:f,parent:r}),this.plan.UserIdXlc&&f.get("value")==this.plan.UserIdXlc&&(t.model.set("isMainProcess",!0),t.$el.addClass("selected")),this.$listUser.append(t.$el);this.$el.dialog(e);this._autocompleteUser()},_showHideDgInplan:function(n,t){var i,r=this;i=$(n).is(".showCoProcess")?$(n):$(n).closest(".showCoProcess");i.find(".checkbox").hasClass("checked")?(i.find(".checkbox").removeClass("checked"),i.find('input[name="checkDongGui"]').prop("checked",!1)):(i.find(".checkbox").addClass("checked"),i.find('input[name="checkDongGui"]').prop("checked",!0));this.$dg.addClass("col-md-9");this.$dg.toggle();this.$result.addClass("col-md-7 show-dg");require(["transferExtend"],function(n){egov.views.dg=new n;egov.views.dg.render(!0,!1,function(){r._selectDg()},function(){r.$dg.append(egov.views.dg.$el);typeof t=="function"&&t()})})},_reloadDocumentList:function(n){var t=this;this.document&&this.document.isCreate||egov.views.home.tree.removeDocuments(n)},destroyDg:function(){egov.views.dg&&egov.views.dg.destroy()},_closeTab:function(n){if(this.document)this.document.isSaveChanged=!0,this.document.tab&&this.document.tab.close2(!1);else if(egov.views.home&&egov.views.home.tab){if(!n)return;n instanceof Array||(n=[n]);egov.views.home.tab.closeTab(n)}},_validXlc:function(){if(!this.requireXlc)return!0;var n=this.serialize(),t=n?n.UserIdsDxl.length>1&&!n.UserIdXlc:!1;return t&&egov.pubsub.publish(egov.events.status.warning,"Hệ thống yêu cầu chọn người xử lý chính, vui lòng chọn lại"),!t},_sendSimple:function(){console.log("Nang cao")}}),u=Backbone.View.extend({tagName:"li",className:"list-group-item",template:t,events:{click:"selected2",contextmenu:"selected2","click .checkbox":"selected",dblclick:"selectAndTransfer","tap .chkdoc":"selected"},initialize:function(n){this.parent=n.parent;this.model.set("docId",this.parent.document==null?0:this.parent.document.id);this.render();this.$el.attr({position:this.model.get("position"),dept:this.model.get("department"),userid:this.model.get("value")});this.$checkbox=this.$(".checkbox");this.model.on("change:isMainProcess",function(n,t){this.$(".checkbox.main-process").toggleClass("checked");this.$el.toggleClass("xlc");t?(this.parent.mainProcess&&this.parent.mainProcess.set("isMainProcess",!1),this.parent.mainProcess=this.model,n.set("isCoProcess",!1)):this.parent.mainProcess=undefined;this.parent.showSelected()},this);this.model.on("change:isCoProcess",function(n,t){this.$(".checkbox.co-process").toggleClass("checked");this.$el.toggleClass("dxl");t&&n.set("isMainProcess",!1);this.parent.showSelected()},this)},render:function(){this.$el.append($.tmpl(this.template,this.model.toJSON()));egov.mobile&&(this.$(".mdl-checkbox").materialCheckbox(),this.$(".mdl-js-ripple-effect").materialRipple());this.$el.bindResources();this.$(".qtooltip").etip()},selected:function(n){var i,r,t,u;n&&(egov.helper.destroyClickEvent(n),i=$(n.currentTarget),r=i.closest("li"),r.siblings().removeClass("selected"),r.addClass("selected"),t=egov.isMobile?i.children(".checkbox"):i.closest(".checkbox"),u=t.hasClass("main-process"),u?(this.model.set("isMainProcess",!t.hasClass("checked")),this.parent.$(".checkbox.main-process.checked").not(t).removeClass("checked"),this.$(".checkbox.co-process").removeClass("checked")):(this.model.set("isCoProcess",!t.hasClass("checked")),this.$(".checkbox.main-process").removeClass("checked")))},selected2:function(n){if(n){var t=$(n.target).closest("li");if(n.type==="click"){if(this.parent.model.length===1){this.model.get("isMainProcess")==!0?this.model.set("isMainProcess",!1):this.model.set("isMainProcess",!0);return}if(t.siblings().removeClass("selected"),t.addClass("selected"),n.ctrlKey){if(!this.parent.mainProcess&&this.model.get("isCoProcess")==!1){this.model.set("isMainProcess",!0);return}if(this.model.get("isMainProcess")==!0){this.model.set("isMainProcess",!1);return}this.model.get("isCoProcess")==!1?this.model.set("isCoProcess",!0):this.model.set("isCoProcess",!1)}else this.parent.model.length>1&&(this.model.get("isCoProcess")==!0?this.model.set("isCoProcess",!1):this.model.get("isMainProcess")==!0?this.model.set("isMainProcess",!1):this.model.get("isMainProcess")==!1&&this.model.set("isMainProcess",!0))}else n.type==="contextmenu"&&(t.removeClass("selected"),this.model.set("isCoProcess",!1),this.model.set("isMainProcess",!1))}},selectAndTransfer:function(n){$("#titleSimple").removeClass("hidden");$("#left_content").addClass("hidden");$("#right_content").addClass("hidden");egov.helper.destroyClickEvent(n);this.parent.defaultMainAndCoProcess();this.model.set("isMainProcess",!0);this.parent.send();return}}),f=function(n,t){var i;return i=$(String.format('<li class="list-group-item ">                            <div class="row wraptext">                                <label class="mdl-checkbox mdl-js-checkbox checkbox checked document-color">                                    <input class="mdl-checkbox__input" name="checkbox[]" value="{0}" type="checkbox" checked="checked">                                    <span class="{2}"><i class="icon-check"><\/i><\/span>                                <\/label>                                <span style="margin-left: 15px;">{1}<\/span>                            <\/div>                        <\/li>',n,t,"document-color-1")),egov.isMobile&&$(i).find(".mdl-checkbox").materialCheckbox(),i},r=function(n){var t=[];egov.dataManager.getAllUserDeptPosition(function(i){return n.forEach(function(n){var r=_.filter(i,function(t){return t.departmentid===n||t.idext.indexOf("."+n+".")>0});r.length>0&&$.extend(t,_.pluck(r,"userid"))}),t=_.uniq(t,!1)})};return e});