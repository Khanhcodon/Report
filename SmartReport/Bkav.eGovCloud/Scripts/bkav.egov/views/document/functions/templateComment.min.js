define(function(){"use strict";var n=Backbone.Model.extend({defaults:{id:0,CommonCommentId:0,Content:"",UserId:0,Selected:!1},initialize:function(){this.set("id",this.get("CommonCommentId"))}}),t=Backbone.Collection.extend({model:n}),i=Backbone.View.extend({tagName:"div",initialize:function(n){return this.callbackInsertComments=n.callbackInsertComments,this.callbackEnableButton=n.callbackEnableButton,this.render(),this},render:function(){var n=this;require([egov.template.document.templateComment],function(t){n.$el.empty().append(t);n.$el.bindResources();n._open()})},unSelectedAll:function(){this.model.each(function(n){n.get("Selected")==!0&&n.set("Selected",!1)})},_open:function(){var n=this;egov.dataManager.getTemplateComments({success:function(i){n.model=new t(i);n._renderDialog();egov.callback(n.callbackEnableButton)}})},_bindView:function(){var n=this;this.$("table tbody").empty();this.model.each(function(t){var i=new r({model:t,parent:n});n.$("table tbody").append(i.$el)})},_renderDialog:function(){var n=this,t={title:egov.resources.templateComment.titleDialog,width:"650px",draggable:!0,keyboard:!0,height:"250px",buttons:[{id:"addTemplateComment",text:egov.resources.templateComment.btnAddTemplateComment,className:"btn-info",style:{left:"10px",position:"absolute"},click:function(t){n._add(t)}},{id:"selectedTemplateComment",text:egov.resources.templateComment.btnSelected,className:"btn-primary",click:function(){var t=n.model.where({Selected:!0}),r,i;if(t&&t.length>0){if(r=t[0].get("Content"),t.length>1)for(i=1;i<t.length;i++)r+="\n"+t[i].get("Content");n.callbackInsertComments(r)}n.$el.dialog("hide")}},{id:"closeTemplateComment",className:"btn-close",text:egov.resources.common.closeButton,click:function(){n.$el.dialog("hide")}}]};this._bindView();this.$el.dialog(t)},_add:function(n){var t=this;egov.message.prompt(egov.resources.templateComment.addDialog.title,egov.resources.templateComment.addDialog.btnCreate,function(i){if(i==null||i===""){egov.pubsub.publish(egov.events.status.error,egov.resources.templateComment.addDialog.errorMessage);typeof n=="function"&&n();return}egov.pubsub.publish(egov.events.status.processing,egov.resources.common.transfering);egov.request.createTemplateComments({data:{content:i},success:function(i){i.success?(egov.pubsub.publish(egov.events.status.success,i.message),t.model.add(i.data),t._bindView(),egov.dataManager.updateTemplateComments(i.data,!1)):(egov.pubsub.publish(egov.events.status.error,i.message),egov.callback(n))},error:function(){egov.pubsub.publish(egov.events.status.error,egov.resources.document.sendComment.sendFail);egov.callback(n)}})},!0)}}),r=Backbone.View.extend({tagName:"tr",selectedClass:"rowSelected",events:{dblclick:"_append",click:"_selected","click .tempComment-update":"_edit","click .tempComment-remove":"_remove",contextmenu:"_contextmenu"},initialize:function(n){this.parent=n.parent;var t=this;this.model.on("change:Selected",function(){t.$el.toggleClass(t.selectedClass)});this.model.on("change:Content",function(){t.parent._bindView()});return require([egov.template.document.templateCommentItem],function(n){t.$el.append($.tmpl(n,t.model.toJSON()))}),this},_append:function(n){n&&(egov.helper.destroyClickEvent(n),typeof this.parent.callbackInsertComments=="function"&&(this.parent.callbackInsertComments(this.model.get("Content")),this.parent.$el.dialog("hide")))},_edit:function(n){if(n){egov.helper.destroyClickEvent(n);egov.helper.hideAllContext();var t=this;egov.message.prompt(egov.resources.templateComment.editDialog.title,egov.resources.templateComment.editDialog.btnEdit,function(n){if(n==null||n===""){egov.pubsub.publish(egov.events.status.error,egov.resources.templateComment.editDialog.errorMessage);egov.callback(callback);return}egov.pubsub.publish(egov.events.status.processing,egov.resources.common.transfering);egov.request.updateTemplateComments({data:{id:t.model.get("id"),content:n},success:function(i){i.success?(egov.pubsub.publish(egov.events.status.success,i.message),t.model.set("Content",n),egov.dataManager.updateTemplateComments(t.parent.model.toJSON(),!0)):(egov.message.error(i.message),egov.pubsub.publish(egov.events.status.error,i.message),egov.callback(callback))},error:function(){egov.pubsub.publish(egov.events.status.error,egov.resources.document.sendComment.sendFail);egov.callback(callback)}})},!0,t.model.get("Content"))}},_remove:function(n){if(n){egov.helper.destroyClickEvent(n);egov.helper.hideAllContext();this._selected();var t=this;egov.request.deleteTemplateComments({data:{id:t.model.get("id")},success:function(n){n.success==!0?(egov.pubsub.publish(egov.events.status.success,n.message),t.parent.model.remove(t.model),t.parent._bindView(),egov.dataManager.updateTemplateComments(t.parent.model.toJSON(),!0)):(egov.pubsub.publish(egov.events.status.error,n.message),egov.callback(callback))},error:function(){egov.pubsub.publish(egov.events.status.error,egov.resources.document.sendComment.sendFail)}})}},_selected:function(n){n&&(n.ctrlKey?this.model.get("Selected")?this._unSetSelected():this._setSelected():(this.model.get("Selected")||this.parent.unSelectedAll(),this._setSelected()))},_setSelected:function(){this.model.set("Selected",!0)},_unSetSelected:function(){this.model.set("Selected",!1)},_contextmenu:function(n){if(n){egov.helper.destroyClickEvent(n);egov.helper.hideAllContext();this._selected(n);var t=this,i=new egov.models.contextMenu({trigger:"right",data:t._getContextItems(n),style:{"z-index":99999},position:{my:"left top",at:"left bottom",of:"event"},hasCache:!1,isShowLoading:!1});this.$el.contextmenu(i,n)}},_getContextItems:function(n){var i=new egov.models.contextMenuList,t=this;return i.add([{text:egov.resources.templateComment.contextmenu.selected,value:"selected",iconClass:"icon-eye3",callback:function(){t._append(n)}},{text:egov.resources.templateComment.contextmenu.edit,value:"edit",iconClass:"icon-info2",callback:function(){t._edit(n)}},{text:egov.resources.templateComment.contextmenu.delete,value:"remove",iconClass:"icon-cross",callback:function(){t._remove(n)}}]),i}});return i});