define([egov.template.renewals],function(n){"use strict";var t=egov.resources.document.renewals;return Backbone.View.extend({events:{"change [name='renewalsType']":"_changeRenewalsType"},initialize:function(t){return this.document=t.document,this.template=n,this.documentCopyId=this.document.model.get("DocumentCopyId"),this.render(),this},render:function(){var n=this,r=n.document.model.get("DateAppointed"),t=r==null?new Date:new Date(n.document.model.get("DateAppointed")),i;return n.model={dateAppointed:t.format("dd/MM/yyyy"),timeAppointed:t.toLocaleTimeString()},i=function(i){n.model.printTemplates=JSON.parse(i.success);n.$el.html($.tmpl(n.template,n.model));n.$el.bindResources();n.$comment=n.$(".renewalsComment");n.$date=n.$(".renewalsDate");n.$time=n.$(".renewalsTime");n.$comment.focus();n.$date.datepicker();n.$date.datepicker("setDate",t);n.$time.timepicker({timeFormat:"H:i:s"});n._openDialog()},egov.request.getPrintTemplates({data:{processType:egov.enum.printProcessType.GiaHan},success:i}),this},_openDialog:function(){var n=this;this.$el.dialog({title:"Thay đổi hạn xử lý",width:"450px",height:"auto",draggable:!0,buttons:[{text:t.renewalsAndPrintButton,className:"btn-primary hidden"+(n.model.printTemplates.length===0?"hidden":""),click:function(){n._renewalsAndPrint();n.$el.dialog("hide")}},{text:t.renewalsButton,className:"btn-primary",click:function(){n._renewals()}},{text:egov.resources.common.closeButton,click:function(){n.$el.dialog("hide")}}]})},_renewals:function(n){var t=this,r,u,f,i,e=t.document.model.get("DateAppointed");if(t.$comment.val()===""&&e&&e!=""){egov.pubsub.publish(egov.events.status.error,"Vui lòng nhập lý do thay đổi hạn xử lý.");return}f=t.$date.val()+"T"+t.$time.val();u=Globalize.parseDate(f,"dd/MM/yyyyTHH:mm:ss");i=t.$("[name='renewalsType']").val();r=function(r){r.success?(egov.pubsub.publish(egov.events.status.success,"Thay đổi hạn xử lý thành công."),t.$el.dialog("hide"),i==1&&t.document.changeDateAppointed(r.success),egov.callback(n)):egov.pubsub.publish(egov.events.status.error,egov.resources.document.renewals.error)};egov.request.renewals({data:{documentCopyId:t.documentCopyId,comment:t.$comment.val(),newDate:u.toISOString(),renewalsType:i},success:r})},_renewalsAndPrint:function(){if(this.model.printTemplates.length!==0){var n=this.$(".ddlPrintTemplate").val(),t=this.document.model.get("DocumentId"),i=this;this._renewals(function(){require(["print"],function(r){var r=new r({docCopyId:[i.documentCopyId],docId:t,paperAddIds:"",feeAddIds:"",printId:n})})})}},_changeRenewalsType:function(){this.$("#printers").toggle()}})});