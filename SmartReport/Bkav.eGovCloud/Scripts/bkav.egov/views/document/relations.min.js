define([egov.template.document.relation],function(n){"use strict";var r=Backbone.View.extend({className:".document-relation",initialize:function(n){this.$(".relation-list").empty();this.document=n.document;var i=this;this.hasPermission=n.hasPermission;this.model.on("add",function(n){n.set("IsNew",!0);var r=new t({model:n,parent:i});i.$el.closest(i.className).is(":hidden")&&i.$el.closest(i.className).show();i.$el.find(".relation-list").append(r.$el);i.hasChangeRelation=!0},this);this.model.on("remove",function(){i.hasChangeRelation=!0},this);this.model.on("reset",function(){i.hasPermission&&i.$el.find("ul").html("")},this);this.render()},render:function(){var n=this,i;return this.model.length>0&&(this.$el.parents(".document-relation").show(),this.model.each(function(r){i=new t({model:r,parent:n});n.$el.find(".relation-list").append(i.$el)})),this},confirmRelations:function(n){if(this.model.length>0){this.confirmView=new u({model:this.model,callback:n});return}egov.callback(n)}}),t=Backbone.View.extend({tagName:"tr",template:n,selectedClass:"rowSelected",relationModels:[],events:{click:"selected","click .relation-open":"_openDocument","click .relation-info":"_infoDetail","click .relation-remove":"_remove",dblclick:"_openDocument",contextmenu:"contextmenu",tap:"_openDocument"},initialize:function(n){this.parent=n.parent;this.render()},render:function(){return this.$el.append($.tmpl(this.template,this.model.toJSON())),this.parent.hasPermission||this.model.get("IsNew")||this.$(".relation-remove").hide(),this},selected:function(){egov.helper.hideAllContext();this.$el.contextobj&&this.$el.contextobj.hide();this.$el.addClass(this.selectedClass);this.$el.siblings("."+this.selectedClass).removeClass(this.selectedClass)},_openDocument:function(){var r=this,n=this.model.get("RelationCopyId"),t=this.model.get("Compendium"),i="#tabDocument_"+n;egov.helper.hideAllContext();egov.isMobile?$(this.documentView).find(i).length>0?($(r.documentView).children().removeClass("active"),$(i).addClass("active")):require(["views/home/tablet-mobile/tab-tablet-mobile"],function(i){new i({model:{id:"tabDocument_"+n,name:t,title:t,href:href},relationTab:!0})}):egov.views.home.tab.openDocument(n,t)},_remove:function(){egov.helper.hideAllContext();this.model.set("IsRemoved",!0);var n=this.parent.model.filter(function(n){return!n.get("IsRemoved")});n.length==0&&this.$el.parents(".document-relation").hide();this.$el.remove()},contextmenu:function(n){if(n){var i=this,t,r;egov.helper.destroyClickEvent(n);this.$el.hasClass(this.selectedClass)||this.selected();t=new egov.models.contextMenuList;t.add({text:egov.resources.document.relation.contextmenu.open,value:"openRelation",iconClass:"icon-enter",callback:function(){i._openDocument()}});this.parent.hasPermission&&t.add({text:egov.resources.document.relation.contextmenu.delete,value:"deleteRelation",iconClass:"icon-close",callback:function(){i._remove()}});r=new egov.models.contextMenu({trigger:"right",data:t,style:{},position:{my:"left top",at:"left bottom",of:"event"},isShowLoading:!1});this.$el.contextmenu(r,n)}},_infoDetail:function(){egov.helper.hideAllContext();var r=this,t,n=this.model.get("RelationCopyId"),u;if(this.relationModels.length>0&&(t=_.find(this.relationModels,function(t){return t.DocumentCopyId===n}),t)){i(t);return}egov.request.getDocumentDetail({data:{id:n},success:function(t){if(t.error){egov.pubsub.publish(egov.events.status.error,egov.resources.document.relation.documentNotExist);return}i(t);u=_.contains(r.relationModels,function(t){return t.DocumentCopyId===n});u||(t.DocumentCopyId=n,r.relationModels.push(t))}})}}),u=Backbone.View.extend({events:{"change .checkAll>input[type=checkbox]":"checkAll",click:"select"},initialize:function(n){this.callback=n.callback;var t=!1;this.model.each(function(n){n.get("IsRemoved")||(t=!0)});t?this.render():egov.callback(this.callback)},select:function(n){if(!this.$(n.target).is("input[type=checkbox]")){var t=this.$(n.target).closest("tr").find("input[type=checkbox]");if(t.closest("tr").find(".checkAll").length>0)return;t.attr("checked",!t.is(":checked"))}},render:function(){var n=this,t=egov.setting.userSetting.IgnoreConfirmRelation;if(t){this.model.each(function(n){n.set("Compendium",n.get("Compendium"));n.set("IsAddNext",!0)});egov.callback(n.callback);return}if(this.$el.modalView){this.$el.dialog("show");return}require([egov.template.document.confirmRelation],function(i){return n.model.each(function(n){n.set("Compendium",unescape(n.get("Compendium")))}),n.$el.append($.tmpl(i,{relations:n.model.toJSON()})),n.$el.dialog({draggable:!0,width:"600px",ignoreText:egov.resources.document.relation.ignoreConfirm,title:egov.resources.document.relation.confirmRelationTitle,confirm:{text:egov.resources.document.ignoreConfirmRelation,className:"ignoreConfirmRelation",style:{float:"left"},click:function(i){i?n.$(".ignoreConfirmRelationWarning").show():n.$(".ignoreConfirmRelationWarning").hide();t=i}},buttons:[{text:egov.resources.common.confirmButton,className:"btn-primary",click:function(){n.$("tr .checkbox").each(function(){var i=parseInt($(this).find('input[type="checkbox"]').val()),t=n.model.detect(function(n){return n.get("RelationCopyId")===i});t&&(t.set("IsAddNext",$(this).children("input[type=checkbox]").is(":checked")),t.set("Compendium",escape(t.get("Compendium"))))});n.$el.modalView.isIgnore()&&(egov.locache.hasSupportLocalStorage?egov.localStorage.setIgnoreConfirmRelation(!0):egov.cookie.setIgnoreConfirmRelation(!0));t&&(egov.setting.userSetting.IgnoreConfirmRelation=t,egov.request.setUserConfig({dat:{IgnoreConfirmRelation:t}}));n.$el.dialog("hide");egov.callback(n.callback)}}]}),this})},checkAll:function(n){var t=this.$("tbody").find("input[type=checkbox]");t.attr("checked",this.$(n.target).is(":checked"))}}),i=function(n){require(["documentDetail"],function(t){var i=new t({model:n}),r={width:800,height:310,title:egov.resources.documents.title.documentDetail,buttons:[{text:egov.resources.common.cancelButton,className:"btn-primary",click:function(){i.$el.dialog("destroy")}}],draggable:!0,keyboard:!0};i.$el.dialog(r)})};return r});