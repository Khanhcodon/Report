$(function(){function r(){if(localStorage){var n=localStorage.getItem("inputedAccount");if(n)return JSON.parse(n)}return[]}function t(n){localStorage&&localStorage.setItem("inputedAccount",JSON.stringify(n))}function u(){localStorage&&localStorage.removeItem("inputedAccount")}var n={Bmail:1,Gmail:2,Yahoo:3,MailExchange:4,MDaemon:5},i={$el:$("body"),element:{password:$("#Password"),userName:$("#Username"),remember:$("#RememberMe"),forget:$(),notMe:$(".otherAccount"),submitForm:$("form:first"),processBar:$("#loginProcess")},loginUrl:{current:"/account/login",notAllowedDevice:"/account/notAllowedDevice"},loginOtherEmailSystemConfig:loginOtherEmailSystemConfig,returnUrl:returnUrl,defaultDomain:defaultDomain,maximumUserInput:maximumUserInput,limitByMac:limitByMac,initialize:function(){try{this._loginDesktopVersion()}catch(t){}this._checkMAC();this._initEvents();this.inputedAccount=r();var n=this;setTimeout(function(){n.element.userName.is(":hidden")?n.element.password.focus():n.element.userName.focus()},200)},reload:function(){if(this.returnUrl){document.location.href=this.returnUrl;return}window.document.location.reload()},_checkMAC:function(){if(this.limitByMac){this.checkingMac=!0;var n=this;window.Plugin&&window.Plugin.appendPlugin(function(){Plugin.getMAC(function(t){n.MAC=t})})}},_initEvents:function(){var n=this;this.$el.keydown(function(t){var i=t.which;i===27&&n._useOtherAccount();return});this.element.password.keypress(function(t){n._checkCaplookIsOn(t)});this.element.notMe.click(function(){n._useOtherAccount()});this.element.submitForm.submit(function(t){t.preventDefault();t.stopPropagation();var i=n._validForm();return i?(n._login(),!1):!1})},_validForm:function(){var i=!0,n,t,u,r;return this.element.userName.removeClass("input-validation-error valid"),this.element.password.removeClass("input-validation-error valid"),n=this.element.userName.parent().find("span"),t=this.element.password.parent().find("span"),n.html(""),t.html(""),u=this.element.userName.val(),r=this.element.password.val(),u==""&&(n.html("<span>Bạn chưa nhập tài khoản.<\/span>"),n.attr("class","field-validation-error"),this.element.userName.addClass("input-validation-error"),i=!1),r==""&&(t.html("<span>Bạn chưa nhập mật khẩu.<\/span>"),t.attr("class","field-validation-error"),r.addClass("input-validation-error"),i=!1),$("input.input-validation-error").first().focus(),i},_login:function(){var t=this.element.userName.val(),i=this.element.password.val(),r=this.element.remember.prop("checked"),n=this,f=this.loginUrl.current;$.post({url:f,data:{Username:t,Password:i,RememberMe:r,UseCaptcha:$("#captchaWrap").is(":visible"),CaptchaDeText:$("#CaptchaDeText").val(),CaptchaInputText:$("#CaptchaInputText").val(),MAC:n.MAC},beforeSend:function(){$(".mesage-login-error").addClass("mesage-login-error-hide");$("#error").empty();n._processing(!0)},success:function(f){if(f){var e=f.success;if(e){n._setDesktopInfo(t,i,r);u();n.loginOtherEmailSystemConfig&&n.loginOtherEmailSystemConfig.enable?n._loginOtherMailSystem(n.returnUrl,t,i):n.reload();return}n._loginFail(f.error,f.deviceNotAllowed)}},error:function(){$(".mesage-login-error").removeClass("mesage-login-error-hide").addClass("mesage-login-error-show").text("Không thể đăng nhập lúc này, Vui lòng đăng nhập lại hoặc báo với quản trị để được xử lý!")},complete:function(){n._processing(!1)}})},_getSsoTokenSuccess:function(n){var r,i,u;if(!n.Success||n.Token==""){showLoading(!1);r=!1;maximumUserInput>0&&(inputedAccount=inputedAccount.filter(function(n){return(new Date-new Date(n.lastDate))/1e3<30}),t(inputedAccount),r=inputedAccount.length>maximumUserInput);r?($("#error").hide(),$("#captchaWrap").show(),$("#captcha a").click()):$("#error").text(n.error||n.Message).show();return}if(n.Success){loginExteralMail(username,password);return}i=!1;$(".login").find("input[type='checkbox']").length&&(i=$("#RememberMe").attr("checked")=="checked");u=n.Token;$.get(ssoDomain+"/User/LoginToken?callback=?",{token:u,domain:"",remember:i},function(n){var t=n.LoginTokenResult.Status=="SUCCESS";if(!t){showLoading(!1);$("#error").text("Đăng nhập không thành công!").show();return}setDesktopInfo(username,password,i);loginExteralMail(username,password)},"jsonp").fail(function(n){console.log("Login token");console.log(n)})},_loginFail:function(n,i){if(i){this._redirectNotAllowedDevice();return}var r=!1;this.maximumUserInput>0&&(inputedAccount=inputedAccount.filter(function(n){return(new Date-new Date(n.lastDate))/1e3<30}),t(inputedAccount),r=inputedAccount.length>this.maximumUserInput);n=="EnableCaptcha"||r?($("#error").hide(),$("#captchaWrap").show(),$("#captcha a").click()):$("#error").text(n).show()},_redirectNotAllowedDevice:function(){document.location.href=this.loginUrl.notAllowedDevice+"?u="+this.element.userName.val()},_checkCaplookIsOn:function(n){var t=String.fromCharCode(n.which);t.toUpperCase()===t&&!n.shiftKey||t.toLowerCase()===t&&n.shiftKey?n.keyCode>64&&n.keyCode<91&&$(".capslockalert").show():$(".capslockalert").hide()},_useOtherAccount:function(){$.cookie("eGovUserInfo","",{expires:-1});$.cookie("eGovUserInfo","",{domain:document.domain,path:"/",expires:-1});this.reload()},_processing:function(n){n?this.element.processBar.show():this.element.processBar.hide()},_loginDesktopVersion:function(){var n,r;if(window.external!=undefined&&typeof window.external.CB_GetLoginInfo=="function"){n=window.external.CB_GetLoginInfo();n=n.replace("&user=","");n=n.replace("password=","");var u=n.split("&"),o=u[0],f=u[1];if($("#Username").val(o),f){$("#Password").val(f);$("#RememberMe").prop("checked",!0);var s="https://"+location.host+"?egov=1&client=tool",h=$("#Username").val(),c=$("#Password").val(),l=function(){loginNormal($("form:first").attr("action"),h,c,$("#RememberMe").prop("checked"),s)},t=5,e=$("#expireLoginTime"),i=$("#auto-login-desktop");i.removeClass("hidden");e.text(t);r=window.setInterval(function(){t--;e.text(t);t==0&&(l(),i.addClass("hidden"),clearInterval(r))},1e3);$(document).one("keypress",function(){i.addClass("hidden");clearInterval(r)})}}},_setDesktopInfo:function(n,t,i){var u;if(window.external&&typeof window.external.CB_LoginSuccess=="function"){var e=i?t:"",r=[],f={user:n,password:i?t:"",remember:"true"};r.push(f);u=JSON.stringify(r);window.external.CB_LoginSuccess(u)}},_loginOtherMailSystem:function(n,t,i){loginExternalSystem(t,i,function(){reloadPage(n)})},loginExternalSystem:function(t,i,r){var f=this.loginOtherEmailSystemConfig.mailUrl,u;this.loginOtherEmailSystemConfig.type!=n.Bmail&&(u=$("<iframe class='hidden' />"),u.load(function(){this.loginOtherEmailSystemConfig.type==n.MailExchange?loginToMSExchange(this,f,t,i,r):this.loginOtherEmailSystemConfig.type==n.MDaemon&&LoginToMdaemon(this,f,t,i,r)}),$("body").append(u))}};i.initialize()});