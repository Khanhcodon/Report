define(["text!templates/tree/tree-template.html","text!templates/tree/treeStorePrivate-template.html"],function(n,t){"use strict";function i(n,t){!n||n<=0||((!t||t<0)&&(t=0),egov.locache.get("treeOfUsers",function(i){var r,u;if(i)for(r=0;r<i.length;r++)if(egov.setting.userId===i[r].userId){if(!i[r].value||i[r].value.length<=0)return;for(u=0;u<i[r].value.length;u++)if(i[r].value[u].id===n){i[r].value[u].totalDocumentUnread=t;break}egov.locache.update("treeOfUsers",i);break}}))}return egov.views.base.Tree=Backbone.View.extend({initialize:function(n){this.options=n;this.el=n.container;this.isDocumentTree=n.isDocumentTree;this.isSelectFirst=n.isSelectFirst;this.callback={select:n.select,open:n.open,reload:n.reload,contextmenu:n.contextmenu};this.render()},render:function(){var n=this,i,t,r=0;return n.model.each(function(u){t=n._addNode(u);r===0&&(i=t,r=1);u.view=t}),n.isSelectFirst&&i.select(),n._handleModelTrigger(),n},_handleModelTrigger:function(){this.model.on("add",function(n){n.view=this._addNode(n)},this)},_addNode:function(n){var t,r,u,i=this;return r=n.get("parentId"),r!==0?(u=i.model.detect(function(n){return n.get("functionId")===r}),u&&(t=u.view.add(n))):(t=new egov.views.base.TreeItem({model:n,callback:i.callback,isDocumentTree:i.isDocumentTree}),i.$el.append(t.el)),t}}),egov.views.base.TreeItem=Backbone.View.extend({openClass:"in",selectClass:"active",tagName:"li",events:{"click .closed":"open","click .open":"close","touchend a":"select","touchend .closed":"open","touchend .open":"close","contextmenu a":"contextMenu"},initialize:function(n){var t;this.options=n;this.callback=n.callback;this.isDocumentTree=n.isDocumentTree;t=this.isDocumentTree?"functionId":"storePrivateId";this.$el.attr("id",this.model.get(t));this.render();this.contextMenu();this._handleTrigger();this._handleClick()},add:function(n){var t=this,i;return t.$("ul.panel-collapse:first").length===0?(t.$children=$('<ul class="nav panel-collapse collapse in">'),t.$el.append(t.$children)):(t.$children=t.$("ul.panel-collapse:first"),t.$children.addClass("in")),this.isDocumentTree?n.set("parentId",this.model.get("functionId")):n.set("parentId",this.model.get("storePrivateId")),i=new egov.views.base.TreeItem({model:n,isDocumentTree:this.isDocumentTree,callback:this.callback,publish:egov.pubsub.publish}),t.$children.append(i.el),i},remove:function(){this.$el.remove()},render:function(){var i,u,r;if(this.$children=this.$("ul.collapse:first"),this.isDocumentTree?(this.$el.html($.tmpl(n,this.model.toJSON())),this.$el.find(".qtooltip").etip()):this.$el.html($.tmpl(t,this.model.toJSON())),i=this.model.get("children"),i.length>0){for(u=i.length,r=0;r<u;r++)this.isDocumentTree?this.add(new egov.models.TreeModel(i[r])):this.add(new egov.models.StorePrivateModel(i[r]));this.$children.removeClass("in")}return this},isActive:function(){return this.$("a:first").hasClass(this.selectClass)},select:function(n){egov.pubsub.publish(egov.events.hideAllContext);egov.pubsub.publish(egov.events.destroyClickEvent,n);this.trigger("select")},selectNew:function(n){egov.pubsub.publish(egov.events.hideAllContext);this.isActive()?this.isActivated=!0:(this.isActivated=!1,this.removeOtherSelected(),this.$("a:first").addClass(this.selectClass));egov.pubsub.publish(egov.events.destroyClickEvent,n)},displayDocList:function(){this.trigger("select")},open:function(n){egov.pubsub.publish(egov.events.hideAllContext);var t=$(n.target);t.closest("a").attr("data-open","true");t.removeClass("closed").addClass("open");this.$(".panel-collapse:first").addClass("in");egov.pubsub.publish(egov.events.destroyClickEvent,n);this.trigger("open")},close:function(n){egov.pubsub.publish(egov.events.hideAllContext);var t=$(n.target);t.closest("a").attr("data-open","false");t.removeClass("open").addClass("closed");this.$(".panel-collapse.in:first").removeClass("in",200);egov.pubsub.publish(egov.events.destroyClickEvent,n)},contextMenu:function(n){egov.pubsub.publish(egov.events.destroyClickEvent,n);this.trigger("contextmenu")},removeOtherSelected:function(){$("#menu-document ."+this.selectClass).removeClass(this.selectClass)},removeOtherSelectednew:function(){this.$el.parent().find("."+this.selectClass).removeClass(this.selectClass)},setTotalUnread:function(n){typeof n=="number"&&(this.$el.find(".totalUnread").text(n>99?"99+":n).attr("data-totalunread",n).attr("title",n+" chưa đọc / "+this.model.get("totalDocument")+" văn bản"),i(this.model.get("id"),n))},toggle:function(n){var t,i,r;n&&(egov.pubsub.publish(egov.events.hideAllContext),t=$(n.target),t.attr("data-open")&&t.attr("data-open")!=="false"?(t.attr("data-open","false"),r=t.parent("a.list-group-item").find(".open"),r.removeClass("icon-arrow-down9 open").addClass("icon-arrow-right9 closed"),this.$(".panel-collapse.in:first").removeClass("in"),egov.pubsub.publish(egov.events.destroyClickEvent,n)):(t.attr("data-open","true"),i=t.parent("a.list-group-item").find(".closed"),i.removeClass("icon-arrow-right9 closed").addClass("icon-arrow-down9 open"),this.$(".panel-collapse:first").addClass("in"),egov.pubsub.publish(egov.events.destroyClickEvent,n),this.trigger("open"),egov.message.notification("hide")))},_handleClick:function(){var n=this,t;n.$(".node-name").dbclick({preclick:function(t){n.selectNew(t)},click:function(t){n.select(t)},dblclick:function(i){t=$(i.target);t.attr("data-open")&&t.attr("data-open")!=="false"?n.close(i):n.open(i)}})},_handleTrigger:function(){var n=this;this.on("open",function(){egov.callback(n.callback.open,n);n.isOpened=!0});this.on("select",function(){egov.callback(n.callback.select,{node:n,isActivated:n.isActivated})});this.on("reload",function(){egov.callback(n.callback.reload)});this.on("contextmenu",function(){egov.callback(n.callback.contextmenu,n)});this.model.on("change:name",function(){n.render()},this);this.model.on("change:children",function(t,i){i.each(function(t){n.add(t)})},this);this.model.on("change:totalDocumentUnread",function(t,i){n.setTotalUnread(i)},this);this.model.on("remove",function(){this.$el.remove()},this)}}),egov.views.base.Tree});