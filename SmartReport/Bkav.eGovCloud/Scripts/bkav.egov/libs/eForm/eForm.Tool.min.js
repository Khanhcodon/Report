(function(n,t,i){n.cfgId={rootPanel:"pnl_root",propertyPanel:"pnl_root_prop"};n.cfgPrefixId={divRowId:"row_",divControlId:"pnl_",divLabelId:"lbl_",controlId:"ctrl_",divErrorId:"err_",divPropertyId:"prop_",divContainPropertyId:"pnlpr_"};n.efTools=new function(){var r=this,w=null,f=0,o=5,h=0,b=0,k=0,d=0,s="0.0",g=!1,u=i,c=-1,v=-1,e="",nt=!0,tt,l,it,y,p,rt,ut;this._formId_="";this.formId="";this.init=function(n,t,u){(u===i||u===null)&&(u="");f=0;e=t;r._formId_="_"+u+"_";r.formId=u}.bind(this);this.setDdlLibs=function(n){w=n}.bind(this);this.getDdlLibs=function(){return w}.bind(this);var a=function(n){u!=n&&(u=n,h=t(n).children().size())},ft=function(i,u){var f=n.database.Get(i,r.formId),l,o,e,a,h;if(f!=null){t("#"+u).html("");l=n.CreateFormObject(f.getTypeId());o=n.getPropertyByControlType(f.getTypeId());t('<div class="basicGroup" style="clear: both;"><\/div>').appendTo("#"+u);t("<h4>▼ Cơ bản<\/h4>").click(function(){t(".basicGroup > div").css("display")=="none"?(t(".basicGroup > div").show(),t.cookie("basicG","1")):(t(".basicGroup > div").hide(),t.cookie("basicG","0"))}).appendTo(".basicGroup");t('<div class="styleGroup" style="clear: both;"><\/div>').appendTo("#"+u);t("<h4>▼ Định dạng, kích thước, màu sắc<\/h4>").click(function(){t(".styleGroup > div").css("display")=="none"?(t(".styleGroup > div").show(),t.cookie("styleG","1")):(t(".styleGroup > div").hide(),t.cookie("styleG","0"))}).appendTo(".styleGroup");t('<div class="advanceGroup" style="clear: both;"><\/div>').appendTo("#"+u);t("<h4>▼ Nâng cao<\/h4>").click(function(){t(".advanceGroup > div").css("display")=="none"?(t(".advanceGroup > div").show(),t.cookie("advanceG","1")):(t(".advanceGroup > div").hide(),t.cookie("advanceG","0"))}).appendTo(".advanceGroup");var v=["p1","p13","p14","p15","p17","p19","p22","p23","p24"],y=["p2","p3","p4","p5","p6","p7","p8","p9","p10","p18","p20"],p=["p11","p12","p16","p21","p25","p26","p27","p28","p29","p30","p31"];for(e=0,a=o.length;e<a;e++){var w=n.propertylib[o[e].getId()],c=n.cfgPrefixId.divContainPropertyId+o[e].getId(),s="";jQuery.inArray(o[e].getId(),v)>-1?s="#"+u+" .basicGroup":jQuery.inArray(o[e].getId(),y)>-1?s="#"+u+" .styleGroup":jQuery.inArray(o[e].getId(),p)>-1&&(s="#"+u+" .advanceGroup");t("<div><\/div>").attr("id",c).css({float:"left",clear:"both",width:"280px","margin-top":"5px","margin-left":"10px"}).appendTo(s);t("<div><\/div>").html("<b>"+w[0].getUIName()+":<\/b> ").css({float:"left","min-width":"100px"}).appendTo("#"+c);h=f.getProperty(o[e].getId());h||(h=o[e]);l.LoadProperty(f,h,c)}t("#pnlprp15").css("display","none");t("#"+u).show("slow");t.cookie("basicG")=="0"?t(".basicGroup > div").hide():t(".basicGroup > div").show();t.cookie("styleG")=="0"?t(".styleGroup > div").hide():t(".styleGroup > div").show();t.cookie("advanceG")=="0"?t(".advanceGroup > div").hide():t(".advanceGroup > div").show();t("#divEdit").length==0||f.getTypeId()=="c1"?(t("#btnRemove").length>0&&t("#btnRemove").remove(),t("<input />").attr("id","btnRemove").attr("type","button").val("Xóa control").insertAfter("#btnSave").click(function(){t("#"+n.cfgPrefixId.divControlId+f.getId()).remove();n.database.RemoveControl(f.getId(),r.formId);t("#"+u).html("").css({border:"solid 0px gray",padding:"0px"});t(this).remove();var i=f.getTypeId();i=="c9"?t("#ddlExtendField option[value='"+f.getControlId()+"']").removeAttr("disabled"):t("#Catalogs option[value='"+f.getControlId()+"']").removeAttr("disabled")})):t("#btnRemove").remove()}},et=function(t){var c=n.database.Get(t,r.formId),o=n.database.Get(v,r.formId),s,w,e,i;if(c!=null&&o!=-1){var y=o.getPosOrder(),p=o.getPosRow(),f=c.getPosOrder(),l=c.getPosRow(),a=!1;for(p==l&&y<f&&(f--,a=!0),s=0,w=n.database.Count(r.formId);s<w;s++)e=n.database.GetAll(r.formId)[s],i=e.getPosOrder(),e.getPosRow()==l&&(i>f+1&&a||i>=f&&!a)?e.setPosOrder(i+1):e.getPosRow()==p&&i>y&&i<=f&&e.setPosOrder(i-1);o.setPosOrder(f);o.setPosRow(l);h=u.children().size()}},ot=function(i){var c=t("[rid='"+i+"']"),f=n.database.Get(v,r.formId),o,y,e;if(f!=null&&c!=null){var l=f.getPosOrder(),a=f.getPosRow(),s=t(c).children(".css_NestedElement").length;if(i!=a||(s--,s!=l)){for(o=0,y=n.database.Count(r.formId);o<y;o++)e=n.database.GetAll(r.formId)[o],e.getPosRow()==a&&e.getPosOrder()>l&&e.setPosOrder(e.getPosOrder()-1);f.setPosOrder(s);f.setPosRow(i);h=u.children(".css_NestedElement").length}}},st=function(i,u){var f=n.database.Get(i,r.formId),o,v,a;if(f!=null){var h=-1,l=-1,e=parseInt(t(u).css("width")),s=parseInt(t(u).css("height"));for(o=0,v=f.getProperties().length;o<v;o++)f.getProperties()[o].getId()=="p6"?e>0&&(h=o):f.getProperties()[o].getId()=="p7"&&s>0&&(l=o);e=e+"px";s=s+"px";h>-1&&(f.getProperties()[h].setValue(e),c==i&&(t("#prop_p6").val(e),t(u).css("width",e)));l>-1&&(f.getProperties()[l].setValue(s),c==i&&(t("#prop_p7").val(s),t(u).css("height",s)));a=parseInt(t("#"+n.cfgPrefixId.divLabelId+f.getKey()).css("width"));a>0&&t("#"+f.getKey()).css("width",parseInt(e)-a-15+"px")}};this.bindRowEvent=function(){t(".icontainer").click(function(){t(".icontainer").removeClass("css_SelectedRow");t(this).addClass("css_SelectedRow");a(t(this))}).hover(function(){t(this).children(".btnDeleteRow").css("visibility","visible")},function(){t(this).children(".btnDeleteRow").css("visibility","hidden")}).droppable({accept:".css_NestedElement",drop:function(n,i){t(this).append(t(i.draggable));ot(t(this).attr("rid"))}})}.bind(this);this.getNextRow=function(){return o++,o}.bind(this);this.deleteRow=function(f){var h=t("[rid='"+f+"']"),a=h.children('div[id^="pnl"]').length,c,e,l,s;if(a>0){alert("Không thể xóa dòng chứa control.");return}for(t(".icontainer ").each(function(){var i=t(this).attr("rid");i>f&&(t(this).attr("rid",i-1),t(this).children(".iRowNumber").text(i-1),t(this).children(".btnDeleteRow").unbind("click").click(function(){n.efTools.deleteRow(i-1)}))}),h.remove(),o--,u=i,c=n.database.GetAll(r.formId),e=0,l=n.database.Count(r.formId);e<l;e++)s=c[e],s.getPosRow()>f&&s.setPosRow(s.getPosRow()-1)}.bind(this);tt=function(i){o=i;f=n.database.Count(r.formId);t("#"+e).html("");for(var u=1;u<=o;u++)t("<div><\/div>").addClass("icontainer").attr("rid",u).appendTo(t("#"+e)),t("<span>"+u+"<\/span>").addClass("iRowNumber").appendTo(t('.icontainer[rid="'+u+'"]')),t('<a class="btnDeleteRow"><b>Χ<\/b><\/a>').click(function(){var i=t(this).parent().attr("rid");n.efTools.deleteRow(i)}).appendTo(t('.icontainer[rid="'+u+'"]'))};l=function(f){var e,o,s;u!=i&&(e=n.cfgPrefixId.divControlId+f,t("<div><\/div>").attr("id",e).addClass("css_NestedElement").css({position:"",top:"",left:""}).appendTo(u).draggable({helper:"clone",opacity:.65,refreshPositions:!0,revert:"invalid",revertDuration:300,scroll:!0,cursor:"pointer",delay:100,distance:10,zIndex:4e3,start:function(){v=f}}).droppable({accept:".css_NestedElement",drop:function(n,i){t(this).before(t(i.draggable));et(f)}}).resizable({grid:[10,10],resize:function(){var u,o,i,s;t(this).css({position:"",top:"",left:""});c==f&&(u=parseInt(t(this).css("width")),o=parseInt(t(this).css("height")),u>0&&t("#prop_p6")&&t("#prop_p6").val(u+"px"),o>0&&t("#p7prop")&&t("#prop_p7").val(o+"px"));i=n.database.Get(f,r.formId);i!=null&&(s=parseInt(t("#"+n.cfgPrefixId.divLabelId+i.getKey()).css("width")),s>0&&t("#"+i.getKey()).css("width",parseInt(t("#"+e).css("width"))-s-15+"px"))},stop:function(){st(f,t(this))}}).click(function(){c!=f&&(ft(f,n.cfgId.propertyPanel),c=f,t(".css_NestedElementActiving").removeClass("css_NestedElementActiving"),t(this).addClass("css_NestedElementActiving"),t(".controlId").css("visibility","hidden"),t("#divEdit").length&&t("select#prop_p19").attr("disabled","disabled"))}),o=n.database.Get(f,r.formId),o!=null&&(s=o.getControlId(),t("#"+e).attr("controlId",s),s!=""&&t('<span class="controlId" style="position: absolute; top: 0pt; right: 0pt; color: red; border: 1px solid gray; padding: 3px; background-color: yellow; visibility: hidden; opacity: 0.8;">Id = '+o.getKey()+"<\/span>").appendTo(t("#"+e))))};this.LoadEditForm=function(i,u){var f,o,e;if(n.database.JsonDeserialize(i,r.formId))for(tt(u),f=0,o=n.database.Count(r.formId);f<o;f++)e=n.database.GetAll(r.formId)[f],a(t("[rid='"+e.getPosRow()+"']")),it(e)}.bind(this);it=function(t){if(!(parseInt(t.getTypeId())<1)){l(t.getId());var i=n.CreateFormObject(t.getTypeId());i.Add(t,n.cfgPrefixId.divControlId+t.getId())}}.bind(this);this.Create=function(t){var i,o,s,e;if(!(parseInt(t)<1)){if(i=++f,t=="c1")do o=n.database.GetByControlId(i,"c1",r.formId),o!=null&&(i=++f);while(o!=null);l(i);s=n.CreateFormObject(t);e=s.Create(i,t,n.cfgPrefixId.divControlId+i);e!=!1?(e.setPosRow(u.attr("rid")),e.setPosOrder(++h),n.database.Add(e,r.formId)):f--}}.bind(this);this.CreateCat=function(t,i){var s,o,c,e;parseInt(t)<1||(s=n.database.GetByControlId(t,"c10",r.formId),s==null)&&(o=++f,l(o),c=n.CreateFormObject("c10"),e=c.CreateCat(o,n.cfgPrefixId.divControlId+o,t,i),e!=!1?(e.setPosRow(u.attr("rid")),e.setPosOrder(++h),n.database.Add(e,r.formId)):f--)}.bind(this);this.CreateExtend=function(t,i){var s,o,c,e;parseInt(t)<1||(s=n.database.GetByControlId(t,"c9",r.formId),s==null)&&(o=++f,l(o),c=n.CreateFormObject("c9"),e=c.CreateExtend(o,n.cfgPrefixId.divControlId+o,t,i),e!=!1?(e.setPosRow(u.attr("rid")),e.setPosOrder(++h),n.database.Add(e,r.formId)):f--)}.bind(this);y=function(i){o=i;f=n.database.Count(r.formId);t("#"+e).html("");for(var u=1;u<=o;u++)t("<div><\/div>").addClass("icontainer").attr("rid",r._formId_+u).appendTo(t("#"+e))};p=function(f){if(u!=i){var o=e+r._formId_+n.cfgPrefixId.divControlId+f;t("<div><\/div>").attr("id",o).addClass("css_NestedInputForm").appendTo(u).click(function(){var i=n.database.Get(f,r.formId);k=i.getPosOrder();b=i.getPosRow();d=t("#"+o).parents(".sub_pnl_root").attr("formid");s=t(this).attr("matrix")})}};this.LoadForm=function(i,u){var o,f,h,s;if(n.database.JsonDeserialize(i,r.formId))for(y(u),o=n.database.GetAll(r.formId),f=0,h=o.length;f<h;f++)s=o[f],a(t("#"+e).find("[rid='"+r._formId_+s.getPosRow()+"']")),rt(s)}.bind(this);rt=function(t){p(t.getId());var i=n.CreateFormObject(t.getTypeId());i.Load(t,e+r._formId_+n.cfgPrefixId.divControlId+t.getId())};this.ViewForm=function(i,u){var f,o,e;if(n.database.JsonDeserialize(i,r.formId))for(y(u),f=0,o=n.database.Count(r.formId);f<o;f++)e=n.database.GetAll(r.formId)[f],a(t("[rid='"+r._formId_+e.getPosRow()+"']")),ut(e)}.bind(this);ut=function(t){if(!(parseInt(t.getTypeId())<1)){p(t.getId());var i=n.CreateFormObject(t.getTypeId());i.View(t,r._formId_+n.cfgPrefixId.divControlId+t.getId())}}.bind(this);this.ArrowKeys={init:function(){var i,n,r;return k=0,b=1,d=t(".sub_pnl_root").first().attr("formid"),s="0.0",i=1,n=1,t(".icontainer").each(function(){n=1;t(this).children(".css_NestedInputForm").each(function(){t(this).attr("matrix",i+"."+n);n++});i++}),t(".css_NestedInputForm input").focus(function(){s=t(this).parent().attr("matrix")}),t(".css_NestedInputForm select").focus(function(){s=t(this).parent().attr("matrix")}),r=this,t("#pnl_root").click(function(n){nt||(r.start(n),nt=!0)}),!0},start:function(){t("#"+e).keydown(function(i){var r=n.efTools.ArrowKeys.FindNextControlId(i);t("#"+r).is("input")?(t("#"+r).focus(),g=!1):t("#"+r).is("select")&&(t("#"+r).focus(),g=!0);s=t("#"+r).parent().attr("matrix")})},FindNextControlId:function(i){var v,c,f,r,e,u;if(s=="0.0")return n.efTools.ArrowKeys.ReturnFisrtControlId();var a=s.split("."),o=parseInt(a[0]),h=parseInt(a[1]),l=t(".icontainer").length;switch(i.keyCode){case 37:for(f=o,r=h,e=o;e>0;e--){if(r--,u=n.efTools.ArrowKeys.FindControlIdByMatrix(f,r),u!="")return u;f--;v=t(t(".icontainer")[f]).children(".css_NestedInputForm").length;r=v+1}return n.efTools.ArrowKeys.ReturnFisrtControlId();case 38:for(f=o,r=h,e=o;e>0;e--){if(f--,u=n.efTools.ArrowKeys.FindControlIdByMatrix(f,r),u!="")return u;for(c=r;c>0;c--)if(r--,u=n.efTools.ArrowKeys.FindControlIdByMatrix(f,r),u!="")return u;r=h}return n.efTools.ArrowKeys.ReturnFisrtControlId();case 39:for(f=o,r=h,e=o;e<=l;e++){if(r++,u=n.efTools.ArrowKeys.FindControlIdByMatrix(f,r),u!="")return u;f++;r=0}return n.efTools.ArrowKeys.ReturnFisrtControlId();case 40:for(f=o,r=h,e=o;e<=l;e++){if(f++,u=n.efTools.ArrowKeys.FindControlIdByMatrix(f,r),u!="")return u;for(c=r;c>0;c--)if(r--,u=n.efTools.ArrowKeys.FindControlIdByMatrix(f,r),u!="")return u;r=h}return n.efTools.ArrowKeys.ReturnLastControlId();case 13:for(i.preventDefault(),f=o,r=h,e=o;e<l;e++)if(f++,u=n.efTools.ArrowKeys.ReturnFirstControlIdInRow(f),u!="")return u;return n.efTools.ArrowKeys.FindControlIdByMatrix(o,h);case 35:return n.efTools.ArrowKeys.ReturnLastControlIdInRow(o);case 36:return n.efTools.ArrowKeys.ReturnFirstControlIdInRow(o)}},ReturnFisrtControlId:function(){for(var f=t(".css_NestedInputForm").length,n=0;n<f;n++){var i=t(".css_NestedInputForm")[n],r=t(i).children("input"),u=t(i).children("select");if(t(r).length>0)return t(r).attr("id");if(t(u).length>0)return t(u).attr("id")}},ReturnLastControlId:function(){for(var e=t(".css_NestedInputForm").length,n="",i=0;i<e;i++){var r=t(".css_NestedInputForm")[i],u=t(r).children("input"),f=t(r).children("select");t(u).length>0&&(n=t(u).attr("id"));t(f).length>0&&(n=t(f).attr("id"))}return n},ReturnFirstControlIdInRow:function(n){for(var o=t(".css_NestedInputForm").length,i=[],u=0;u<o;u++){var r=t(".css_NestedInputForm")[u],f=t(r).children("input"),e=t(r).children("select");if(t(f).length>0&&(i=t(r).attr("matrix").split("."),i[0]==n.toString()))return t(f).attr("id");if(t(e).length>0&&(i=t(r).attr("matrix").split("."),i[0]==n.toString()))return t(e).attr("id")}return""},ReturnLastControlIdInRow:function(n){for(var s=t(".css_NestedInputForm").length,u="",i=[],f=0;f<s;f++){var r=t(".css_NestedInputForm")[f],e=t(r).children("input"),o=t(r).children("select");t(e).length>0&&(i=t(r).attr("matrix").split("."),i[0]==n.toString()&&(u=t(e).attr("id")));t(o).length>0&&(i=t(r).attr("matrix").split("."),i[0]==n.toString()&&(u=t(o).attr("id")))}return u},FindControlIdByMatrix:function(n,i){var e=n+"."+i,r=t(".css_NestedInputForm[matrix = '"+e+"']"),u,f;return r.length==0?"":(u=t(r).children("input"),f=t(r).children("select"),t(u).length>0)?t(u).attr("id"):t(f).length>0?t(f).attr("id"):""}}}})(window.eForm=window.eForm||{},jQuery);