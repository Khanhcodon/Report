define(function(){"use strict";function n(n,t,i){i?egov.mobile.download(n,t):egov.mobile.onlyDownload(n,t)}return Backbone.View.extend({el:"#mail-detail",allFilePart:"",events:{"click .attachment-download":"_downloadAttachment"},initialize:function(n){this.model=new bmail.models.maildetail(n.model);this.mailId=n.id;this.$el.show();this.render()},render:function(){var n=this;egov.mobile.showProcessBar();require(["bmailViewToolbar",egov.template.bmail.detail],function(t,i){n.$el.html($.tmpl(i,n.model.toJSON()));n.mailItem&&(n.mailItem.parent.folderPath.indexOf("drafts")==0||n.mailItem.isSentBox)&&n.$el.find("#mailSender").hide();var r=new t({mailId:n.model.id,mail:n});r.$el.appendTo(n.$(".mail-header"));n.getMoreData(n.mailId);n.mailItem&&n.mailItem.addSelected();egov.mobile.hideProcessBar()})},getMoreData:function(n){var t=this;bmail.request.readMail(n,function(i){var r=new MsgUtil(i);t.model.set({content:r.body,receivers:r.getMsgTo(),receiversLabel:r.getMsgTo().join("; "),bcc:r.getMsgBcc(),cc:r.getMsgBcc(),images:r.inlineImages,attachments:r.attach,id:n});t.reRender()})},reRender:function(){var t=this,n=this.$el.find("#mailBody");n.html(this.model.get("content"));this.$el.find(".mailsenderaccount").html(this.model.get("receiversLabel"));this.model.get("receivers").length>2&&this.$el.find(".btnshowallaccount").removeClass("hidden");this.renderImages();this.renderBase64Images();this.renderAttachments();egov.mobile.hideProcessBar()},renderImages:function(){var n=this,t=this.model.get("images");t&&_.each(t,function(t){var i=$("img[dfsrc='cid:"+t.ci+"']"),r=homeService+"~/"+t.filename+"?id="+n.model.id+"&part="+t.part+"&authToken="+readAuthenCookie();i.attr("src",n.makeDownloadUrl({filename:t.filename,part:t.part}));i.removeAttr("dfsrc")})},renderBase64Images:function(){var n=this.$("img[dfsrc]");_.each(n,function(n){var t=$(n).attr("dfsrc");$(n).removeAttr("dfsrc");n.src=t})},showImage:function(n){var t=$(n.currentTarget).attr("src");window.open(t)},renderAttachments:function(){var t=this,n=this.model.get("attachments"),i,r;if(!n||n.length===0){t.$("#wrapAttachment").hide();return}i="";r=0;this.$("#mailAttach").removeClass("hidden");this.$("#mailAttach #mailAttachDetail").html("");require([egov.template.bmail.attachmentItem],function(i){_.each(n,function(n){var i="",r=t.makeDownloadUrl({filename:n.fileName,part:n.part,disp:"a"});i=egov.mobile.iseGovApp?"javascript:egov.mobile.onlyDownload('"+r+"','"+n.fileName+"');":r;n.downloadUrl=i});t.$("#mailAttachDetail").append($.tmpl(i,n))})},_downloadAttachment:function(t){var i=$(t.target).closest(".attachment-download"),u=i.attr("data-url"),f=i.attr("data-size"),r=i.attr("data-name");egov.dialog.confirmActions({title:r,message:"Dung lượng file: "+f,buttons:[{text:"Mở",callback:function(){n(u,r,!0)}},{text:"Tải về",callback:function(){n(u,r,!1)}}]})},showAllAccount:function(n){$(n.currentTarget).toggleClass("wraptext")},sendMailTo:function(n){window.open("mailto:"+$(n.currentTarget).text())},scrollContent:function(n){$(n.currentTarget).scrollTop()>200?$("#btnmailuptotop").addClass("display"):$("#btnmailuptotop").removeClass("display")},makeDownloadUrl:function(n){var i=new URL(egov.connections.BmailLink),r=i.origin+"/service/home/",t=r+"~/";return n.filename&&(t+=n.filename),t+="?id="+this.model.id,n.part&&(t+="&part="+n.part),n.disp&&(t+="&disp="+n.disp),n.fmt&&(t+="&fmt="+n.fmt),t+("&authToken="+bmail.authenCookie)}})});