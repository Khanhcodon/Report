define([],
function () {

    "use strict";

    //Đối tượng Context menu (fix cứng)
    var objContextmenu = {
        'xemvanban': {
            className: 'xemvanbanClass',
            name: egov.resources.documents.contextmenu.name.xemvanban,
            iconClass: 'icon-xemvanban',
            commandName: 'xemvanban'
        },
        'suavanban': {
            className: 'suavanbanClass',
            name: egov.resources.documents.contextmenu.name.suavanban,
            iconClass: 'icon-pencil3',
            commandName: 'suavanban'
        },
        'guiykien': {
            className: 'guiykienClass',
            name: egov.resources.documents.contextmenu.name.guiykien,
            iconClass: 'icon-comment',
            commandName: 'guiykien'
        },
        'xinykien': {
            className: 'xinykienClass',
            name: egov.resources.documents.contextmenu.name.xinykien,
            iconClass: 'icon-chat',
            commandName: 'xinykien'
        },
        'bangiao': {
            className: 'bangiaoClass',
            name: egov.resources.documents.contextmenu.name.bangiao,
            iconClass: 'icon-forward4',
            commandName: 'bangiao'
        },
        'thongbao': {
            className: 'thongbaoClass',
            name: egov.resources.documents.contextmenu.name.thongbao,
            iconClass: 'icon-users3',
            commandName: 'thongbao'
        },
        'laylaivanban': {
            className: 'laylaivanbanClass',
            name: egov.resources.documents.contextmenu.name.laylaivanban,
            iconClass: 'icon-back',
            commandName: 'laylaivanban'
        },
        'xacnhanbangiao': {
            className: 'xacnhanbangiaoClass',
            name: egov.resources.documents.contextmenu.name.xacnhanbangiao,
            iconClass: 'icon-xacnhanbangiao',
            commandName: 'xacnhanbangiao'
        },
        'xacnhanxuly': {
            className: 'xacnhanxulyClass',
            name: egov.resources.documents.contextmenu.name.xacnhanxuly,
            iconClass: '',
            commandName: 'xacnhanxuly',
        },
        'yeucaubosung': {
            className: 'yeucaubosungClass',
            name: egov.resources.documents.contextmenu.name.yeucaubosung,
            iconClass: 'icon-yeucaubosung',
            commandName: 'yeucaubosung'
        },
        'tiepnhanbosung': {
            className: 'tiepnhanbosungClass',
            name: egov.resources.documents.contextmenu.name.tiepnhanbosung,
            iconClass: 'icon-tiepnhanbosung',
            commandName: 'tiepnhanbosung'
        },
        'kyduyet': {
            className: 'kyduyetClass',
            name: egov.resources.documents.contextmenu.name.kyduyet,
            iconClass: 'icon-signup',
            commandName: 'kyduyet'
        },
        'ketthucxuly': {
            className: 'ketthucxulyClass',
            name: egov.resources.documents.contextmenu.name.ketthucxuly,
            iconClass: 'icon-checkmark3',
            commandName: 'ketthucxuly'
        },
        'huyvanban': {
            className: 'huyvanbanClass',
            name: egov.resources.documents.contextmenu.name.huyvanban,
            iconClass: 'icon-remove',
            commandName: 'huyvanban'
        },
        'capnhatketquaxulycuoi': {
            className: 'capnhatketquaxulycuoiClass',
            name: egov.resources.documents.contextmenu.name.capnhatketquaxulycuoi,
            iconClass: 'icon-capnhatketquaxulycuoi',
            commandName: 'capnhatketquaxulycuoi'
        },
        'inphieutrinh': {
            className: 'inphieutrinhClass',
            name: egov.resources.documents.contextmenu.name.inphieutrinh,
            iconClass: 'icon-inphieutrinh',
            commandName: 'inphieutrinh'
        },
        'intomtat': {
            className: 'intomtatClass',
            name: egov.resources.documents.contextmenu.name.intomtat,
            iconClass: 'icon-intomtat',
            commandName: 'intomtat'
        },
        'capnhattiendo': {
            className: 'capnhattiendoClass',
            name: egov.resources.documents.contextmenu.name.capnhattiendo,
            iconClass: 'icon-capnhattiendo',
            commandName: 'capnhattiendo'
        },
        'xoakhoiduthao': {
            className: 'xoakhoiduthaoClass',
            name: egov.resources.documents.contextmenu.name.xoakhoiduthao,
            iconClass: 'icon-remove',
            commandName: 'xoakhoiduthao'
        },
        'contextheodoi': {
            className: 'contextheodoiClass',
            name: egov.resources.documents.contextmenu.name.contextheodoi,
            iconClass: 'icon-contextheodoi',
            commandName: 'contextheodoi'
        },
        'dungxuly': {
            className: 'dungxulyClass',
            name: egov.resources.documents.contextmenu.name.dungxuly,
            iconClass: 'icon-dungxuly',
            commandName: 'dungxuly'
        },
        'giahanxuly': {
            className: 'giahanxulyClass',
            name: egov.resources.documents.contextmenu.name.giahanxuly,
            iconClass: 'icon-giahanxuly',
            commandName: 'giahanxuly'
        },
        'chitietvanban': {
            className: 'chitietvanbanClass',
            name: egov.resources.documents.contextmenu.name.chitietvanban,
            iconClass: 'icon-info4',
            commandName: 'chitietvanban'
        },
        'danhdauchuadoc': {
            className: 'chitietvanbanClass',
            name: egov.resources.documents.contextmenu.name.danhdauchuadoc,
            iconClass: 'icon-danhdauchuadoc',
            commandName: 'danhdauchuadoc'
        },
        'danhdaudadoc': {
            className: 'chitietvanbanClass',
            name: egov.resources.documents.contextmenu.name.danhdaudadoc,
            iconClass: 'icon-danhdaudadoc',
            commandName: 'danhdaudadoc'
        },
        'molaivanban': {
            className: 'molaivanbanClass',
            name: egov.resources.documents.contextmenu.name.molaivanban,
            iconClass: 'icon-molaivanban',
            commandName: 'molaivanban'
        },
        'exportToXML': {
        className: 'exportToXML',
        name: 'Xuất danh sách ra tệp XML',
        iconClass: 'icon-file-xml',
        commandName: 'exportToXML'
        }
    };

    //<sumary>================ </sumary>
    //<sumary>Lấy quyền hạn xử lý văn bản hồ sơ của người dùng </sumary>
    //<sumary>Lấy quyền hạn xử lý văn bản hồ sơ của người dùng </sumary>
    var DocumentContextmenu = Backbone.View.extend({
        //Khởi tạo
        initialize: function (options) {
            this.parent = options.parent;
        },

        //Trả về danh sách contextmenu của người dung theo van bản
        getContextmenu: function (docCopyIdSelected, selectedModels, clickModel, success) {
            this.selectedModels = selectedModels;
            this.clickModel = clickModel;
            this.docCopyIdSelected = docCopyIdSelected;
            this.docCopyIdClick = this.clickModel.model.get('DocumentCopyId');
            var _this = this,
                result = [],
                leng = this.collection.length;

            _this.collection.each(function (permission, idx) {
                _this._getItemContext(permission.get('value'), function (contextMenu) {
                    $.each(contextMenu, function (key, value) {
                        result.push(value);
                    });
                    if (idx === leng - 1) {
                        if (typeof success === 'function') {
                            success(result);
                        }
                    }
                });
            });
        },

        //Lây quyền của người dùng xem có các chức năng nào hiển thị trên contextmenu
        _getItemContext: function (permissionValue, success) {
            var _this = this,
                docCopyIdSelectedLeng = this.docCopyIdSelected.length;

            var itemsContext = {};
            // mở văn bản
            $.extend(itemsContext, { 'movanban': objContextmenu['movanban'] });
            objContextmenu.movanban.callback = function () {
                _this.parent.openDocuments(_this.selectedModels);
            };

            

            if (permissionValue & egov.enum.permission.suavanban) {
                $.extend(itemsContext, { 'suavanban': objContextmenu['suavanban'] });
            }

            // Gửi ý kiến
            if (docCopyIdSelectedLeng === 1) {
                if (permissionValue & egov.enum.permission.guiykien) {
                    // TienBV: bỏ chức năng gửi ý kiến trên context menu
                    // $.extend(itemsContext, { 'guiykien': objContextmenu['guiykien'] });
                    objContextmenu.guiykien.callback = function () {
                        egov.message.prompt(egov.resources.document.sendComment.dialogTitle,
                             egov.resources.document.sendComment.dialogButton,
                             function (comment) {
                                 if (comment == null || comment === '') {
                                     egov.message.error('Bạn chưa nhập ý kiến!.');
                                     return;
                                 }
                                 egov.message.processing(egov.resources.common.transfering, false);
                                 egov.request.sendComment({
                                     data: {
                                         documentCopyId: _this.docCopyIdClick,
                                         comment: comment
                                     },
                                     success: function (result) {
                                         if (result.error) {
                                             egov.message.error(result.error);
                                         } else {
                                             egov.message.success(egov.resources.document.sendComment.sendSuccess);
                                         }
                                     },
                                     error: function () {
                                         egov.message.error(egov.resources.document.sendComment.sendFail);
                                     }
                                 });
                             }, true
                        );
                    };
                }
            }

            // Bàn giao
            if (permissionValue & egov.enum.permission.bangiao) {
                $.extend(itemsContext, { 'bangiao': objContextmenu['bangiao'] });
            }

            // Thông báo
            if (docCopyIdSelectedLeng === 1) {
                if (permissionValue & egov.enum.permission.thongbao) {
                    // TienBV: bỏ chức năng thông báo trên context menu
                    // $.extend(itemsContext, { 'thongbao': objContextmenu['thongbao'] });
                    objContextmenu.thongbao.callback = function () {
                        require(['announcementView'], function (announcementView) {
                            if (egov.announcementForm === undefined) {
                                egov.announcementForm = new announcementView;
                            }
                            egov.announcementForm.render(_this.docCopyIdClick);
                        });
                    };
                }
            }
            // Xin ý kiến
            if (permissionValue & egov.enum.permission.xinykien) {
                // TienBV: Bỏ chức năng xin ý kiến trên context menu
                // $.extend(itemsContext, { 'xinykien': objContextmenu['xinykien'] });
                objContextmenu.xinykien.callback = function () {
                    require(['consultView'], function (consultView) {
                        if (egov.consultView === undefined) {
                            egov.consultView = new consultView;
                        }
                        egov.consultView.renderForContext(_this.docCopyIdClick);
                    });
                };
            }

            // Xác nhận bàn giao
            if (docCopyIdSelectedLeng === 1) {
                // TienBV: bỏ chức năng xác nhận xử lý và xác nhận bàn giao trên context menu
                if (permissionValue & egov.enum.permission.xacnhanbangiao) {
                    // $.extend(itemsContext, { 'xacnhanbangiao': objContextmenu['xacnhanbangiao'] });
                    objContextmenu.xacnhanbangiao.callback = function () {
                        require(['views/document/functions/ConfirmTransferOrProcess'], function (ConfirmTransferOrProcessView) {
                            new ConfirmTransferOrProcessView({
                                docCopyId: _this.docCopyIdClick,
                                isTransfer: true
                            });
                        });
                    };
                }
                if (permissionValue & egov.enum.permission.xacnhanxuly) {
                    // $.extend(itemsContext, { 'xacnhanxuly': objContextmenu['xacnhanxuly'] });
                    objContextmenu.xacnhanxuly.callback = function () {
                        require(['views/document/functions/ConfirmTransferOrProcess'], function (ConfirmTransferOrProcessView) {
                            new ConfirmTransferOrProcessView({
                                docCopyId: _this.docCopyIdClick,
                                isTransfer: false
                            });
                        });
                    };
                }
            }

            // Yêu cầu bổ sung
            if (permissionValue & egov.enum.permission.yeucaubosung) {
                // TienBV: bỏ trên contextmenu
                // $.extend(itemsContext, { 'yeucaubosung': objContextmenu['yeucaubosung'] });
            }

            // Tiếp nhận bổ sung
            if (permissionValue & egov.enum.permission.tiepnhanbosung) {
                // TienBV: bỏ trên contextmenu
                // $.extend(itemsContext, { 'tiepnhanbosung': objContextmenu['tiepnhanbosung'] });
            }

            // Ký duyệt
            if (docCopyIdSelectedLeng === 1) {
                if (permissionValue & egov.enum.permission.kyduyet) {
                    $.extend(itemsContext, { 'kyduyet': objContextmenu['kyduyet'] });
                    objContextmenu.kyduyet.callback = function () {
                        require(['views/document/functions/approver'], function (ApproverView) {
                            new ApproverView({
                                docCopyId: _this.docCopyIdClick
                            });
                        });
                    };
                }
            }
            // Trả kết quả
            if (permissionValue & egov.enum.permission.traketqua) {
                // right flag is set
            }

            // Gia hạn xử lý
            if (docCopyIdSelectedLeng === 1) {
                if (permissionValue & egov.enum.permission.giahanxuly) {
                    $.extend(itemsContext, { 'giahanxuly': objContextmenu['giahanxuly'] });
                    objContextmenu.giahanxuly.callback = function () {
                        require(['jquery', 'libs/jquery/jquery.validate.min'],
                            function () {
                                require(['libs/jquery/jquery.validate.unobtrusive.min'],
                                    function () {
                                        require(['views/document/functions/addtime'],
                                            function (AddTimeView) {
                                                new AddTimeView({
                                                    docCopyId: _this.docCopyIdClick
                                                });
                                            }
                                        );
                                    }
                                );
                            }
                        );
                    };
                }
            }

            // Dừng xử lý
            if (permissionValue & egov.enum.permission.dungxuly) {
                $.extend(itemsContext, { 'dungxuly': objContextmenu['dungxuly'] });
            }

            // Kết thúc xử lý
            if (permissionValue & egov.enum.permission.ketthucxuly) {
                $.extend(itemsContext, { 'ketthucxuly': objContextmenu['ketthucxuly'] });
                objContextmenu.ketthucxuly.callback = function () {
                    _this.parent.finishs(_this.selectedModels);
                };
            }

            // Hủy văn bản
            if (permissionValue & egov.enum.permission.huyvanban) {
                $.extend(itemsContext, { 'huyvanban': objContextmenu['huyvanban'] });
                objContextmenu.huyvanban.callback = function () {
                    egov.message.show(
                    'Bạn có đồng ý loại bỏ văn bản/hồ sơ này không?',
                    null,
                    egov.message.messageButtons.YesNo,
                    function () {
                        egov.request.removeDocument({
                            data: { documentCopyIds: _this.docCopyIdSelected },
                            success: function (data) {
                                if (data.success) {
                                    _this.parent.removeDocuments(_this.selectedModels);
                                    egov.message.notification(data.success, egov.message.messageTypes.success);
                                } else {
                                    egov.message.show(data.error);
                                }
                            },
                            error: function () {
                                egov.message.notification("Có lỗi trong quá trình loại bỏ văn bản/hồ sơ.", egov.message.messageTypes.error);
                            }
                        });
                    });
                };
            }

            // Cập nhật kết quả xử lý cuối
            if (permissionValue & egov.enum.permission.capnhatketquaxulycuoi) {
                $.extend(itemsContext, { 'capnhatketquaxulycuoi': objContextmenu['capnhatketquaxulycuoi'] });
            }

            ///Thêm xem chi tiết văn bản/hồ sơ
            if (docCopyIdSelectedLeng === 1) {
                $.extend(itemsContext, { 'chitietvanban': objContextmenu['chitietvanban'] });
                objContextmenu.chitietvanban.callback = function () {
                    getDocumentDetail(_this.clickModel.model.toJSON());
                };
            }

            //Note: Chức năng đánh dấu văn băn chưa đọc và văn bản đã đọc thì chỉ có ở mục văn bản chờ xử lý
            ///Văn bản chờ xử lý
            var document = _.filter(_this.parent.model.toArray(), function (item) {
                return item.get('Status') === 2 && item.get('UserCurrentId') === egov.setting.userId;
            });
            if (document.length > 0) {
                var read = [], unread = [],
                    leng = _this.selectedModels.length;
                for (var i = 0; i < leng; i++) {
                    if (_this.selectedModels[i].get('IsViewed') == true) {
                        read.push(_this.selectedModels[i]);
                    }
                    else {
                        unread.push(_this.selectedModels[i]);
                    }
                }

                // Note: Nếu số lượng văn bản chọn mà chưa đọc >= đã đọc thì ưu tiên chưa đọc
                if (unread.length >= read.length) {
                    //Đánh dấu văn bản đã đọc
                    $.extend(itemsContext, { 'danhdaudadoc': objContextmenu['danhdaudadoc'] });
                    objContextmenu.danhdaudadoc.callback = function () {
                        _this.parent.setViewed(unread, true);
                    };
                }
                else {
                    //Đánh dấu văn bản chưa đọc
                    $.extend(itemsContext, { 'danhdauchuadoc': objContextmenu['danhdauchuadoc'] });
                    objContextmenu.danhdauchuadoc.callback = function () {
                        _this.parent.setViewed(read, false);
                    };
                }
            }
            

            //Lấy lại văn bản
            //Note: Chức năng lấy lại văn bản chỉ có ở mục văn bản theoo dõi và có trạng thái chưa đọc
            //  trạng thái văn bản chưa đọc => chứa chắc vì notify trạng thái văn bản xuống thì chưa set IsViewed  của model ngay được
            var checkUndo = //this.clickModel.model.get("IsViewed") == false &&
                this.clickModel.model.get("UserCurrentId") !== egov.setting.userId
                && (this.clickModel.model.get("Status") === 2
                || this.clickModel.model.get("Status") === 16);

            if (checkUndo) {
                if (permissionValue & egov.enum.permission.laylaivanban) {
                    egov.request.getContextItemForUndoTransfering({
                        data: { documentCopyId: _this.docCopyIdClick },
                        success: function (data) {
                            if (data.error) {
                                return;
                            } else {
                                if (!$.isEmptyObject(itemsContext) && data.length > 0) {
                                    $.extend(itemsContext, { name: "---" });
                                }

                                for (var i = 0; i < data.length; i++) {
                                    var dateCreated = data[i].DateCreated;
                                    var contextItem = {
                                        className: 'laylaivanbanClass',
                                        name: data[i].Name,
                                        dateCreated: dateCreated,
                                        iconClass: 'icon-undo2',
                                        commandName: 'laylaivanban' + i,
                                        callback: function (key) {
                                            var dateCreated1 = itemsContext[key.get('key')].dateCreated;
                                            var dateCreatedStr = Globalize.format(dateCreated1, "F");
                                            require(['views/document/functions/retrieve'], function (RetrieveView) {
                                                new RetrieveView({
                                                    docCopyId: _this.docCopyIdClick,
                                                    dateCreated: dateCreatedStr,
                                                    callback: function (value) {
                                                        _this.clickModel.$el.remove();
                                                        var model = _this.clickModel.model.toJSON();
                                                        _this.parent.removeDocuments([_this.clickModel.model]);

                                                        egov.locache.get("documentOfUsers", function (documentOfUsers) {
                                                            if (!documentOfUsers || documentOfUsers.length <= 0) {
                                                                return;
                                                            }

                                                            var documentOfUserCurrent, index;
                                                            for (var i = 0; i < documentOfUsers.length; i++) {
                                                                if (documentOfUsers[i]["userId"] === egov.setting.userId) {
                                                                    documentOfUserCurrent = documentOfUsers[i];
                                                                    index = i;
                                                                    break;
                                                                }
                                                            }

                                                            if (!documentOfUserCurrent || !documentOfUserCurrent["localCache"]) {
                                                                return;
                                                            }

                                                            var localCache = documentOfUserCurrent["localCache"];
                                                            var caches = localCache["documentTrees"];

                                                            if (!caches || caches.length <= 0) {
                                                                return;
                                                            }

                                                            for (var i = 0; i < caches.length; i++) {
                                                                var documents = caches[i]["documents"];
                                                                if (documents && documents.length > 0) {
                                                                    //Văn bản chờ xử lý
                                                                    if (documents[0]["Status"] === 2
                                                                        && documents[0]["UserCurrentId"] === egov.setting.userId) {
                                                                        //set lại trạng thái văn bản và người giữ
                                                                        model["Status"] = 2;
                                                                        model["IsDocumentImportant"] = false;
                                                                        model["UserCurrentId"] = egov.setting.userId;
                                                                        model["UserCurrentFullName"] = egov.setting.fullName;
                                                                        var tmp = egov.setting.fullName.split(" ");
                                                                        var firstName = tmp[tmp.length - 1];
                                                                        model["UserCurrentFirstName"] = firstName;
                                                                        documents.push(model);
                                                                        caches[i]["documents"] = documents;
                                                                        break;
                                                                    }
                                                                    else {
                                                                        continue;
                                                                    }
                                                                }
                                                            }

                                                            localCache["documentTrees"] = caches;
                                                            documentOfUserCurrent["localCache"] = localCache;
                                                            documentOfUsers[index] = documentOfUserCurrent;
                                                            egov.locache.update('documentOfUsers', documentOfUsers);
                                                        });
                                                    }
                                                });
                                            });
                                        }
                                    };
                                    var contextItemInsert = {};
                                    contextItemInsert['laylaivanban' + i] = contextItem;
                                    $.extend(itemsContext, contextItemInsert);
                                }
                            }
                            success(itemsContext);
                        }
                    });
                }
            }
            else {
                success(itemsContext);
            }
        }
    });

    ///Parse thông tin văn bản và show lên dialog
    var getDocumentDetail = function (document) {
        require(['documentDetail'], function (DocumentDetail) {

            //render thông tin chi tiết văn bản
            var documentDetail = new DocumentDetail({ model: document });
            //Thiết lập dialog
            var settings = {
                width: 900,
                height: 450,
                title: egov.resources.documents.title.documentDetail,
                buttons: [{
                    text: egov.resources.common.closeButton,
                    className: 'btn-default',
                    click: function () {
                        documentDetail.$el.dialog('destroy');
                    }
                }],
                draggable: true,
                keyboard: true,
            };

            ///show dialog
            documentDetail.$el.dialog(settings);
        });
    }

    return DocumentContextmenu;
});