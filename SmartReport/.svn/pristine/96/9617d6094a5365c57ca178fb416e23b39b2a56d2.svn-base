define([egov.template.deptUser],function(n){"use strict";var l=egov.resources.document.transfer,r,i,a=Backbone.View.extend({className:"dropdown-userDeptVote",template:n,initialize:function(){return this},render:function(n,t,i,r){var u,f;if($("body .dropdown-userDeptVote").length>0&&$("body .dropdown-userDeptVote").remove(),this.$el.html(this.template),this.$el.bindResources(),this.$el.appendTo("body"),this.$dgOption=this.$(".dg-option"),this.$relationOption=this.$(".relation-option"),this.callbackFunc=i,this.hasDg=n,this.showRelation=t,u=this,egov.dataManager)return f=egov.dataManager,f.getAllUsers({success:function(n){u.allUsers=n;f.getAllJobtitle({success:function(n){u.allJobtitle=n;f.getAllDept({success:function(n){u.allDepts=n;f.getAllUserDeptPosition({success:function(n){u.allUserDeptPosition=n;u._bind(r)}})}})}})}}),egov.isMobile&&(this.$(".mdl-checkbox").materialCheckbox(),this.$(".mdl-button").materialButton(),this.$(".mdl-radio").materialRadio(),this.$(".mdl-textfield").materialTextfield()),this},reRender:function(n,t,i){this.callbackFunc=i;this.hasDg=n;this.showRelation=t;this._show();this._bindCallback();that.$("#dgUserVote").focus()},destroy:function(){this.$("#dgUsersVote").each(function(){$(this).customDropdown("destroy")});this.$el.remove()},callback:function(){typeof this.callbackFunc=="function"&&this.callbackFunc()},serialize:function(){return this.result={isDg:this.$('[name="isDg"]:checked').val()==="1",isAllUser:!1,isAllDept:!1,isAllJobtitle:!1,users:[],depts:[],jobDepts:[],jobtitlies:[],userGs:[],deptGs:[]},this._getUsersDept(),this._processResult()},getDestination:function(){var n=this.serialize(),i=[],t=egov.enum.transferType,r,u;return n.isAllUser||n.isAllDept&&n.isAllJobtitle?(i.push({label:l.sendAll,value:"all",type:n.isDg?t.dongxuly:t.thongbao}),i):(n.depts.forEach(function(r){i.push({label:r.data,value:"FilterDepartmentVote-"+r.value,type:n.isDg?t.dongxuly:t.thongbao})}),n.users.forEach(function(r){i.push({label:r.fullname+" - "+r.username,value:"FilterDepartmentVote-user_"+r.value,type:n.isDg?t.dongxuly:t.thongbao})}),n.isAllDept?!n.isAllJobtitle&&n.jobtitlies.length>0&&(r=" thuộc "+n.jobDepts[0].data,u=_.pluck(n.jobtitlies,"label").join(", ")+r,i.push({label:u,value:"JobtitleForDept",type:n.isDg?t.dongxuly:t.thongbao})):n.isAllJobtitle?n.isAllDept||n.jobDepts.forEach(function(r){i.push({label:r.data,value:"",type:n.isDg?t.dongxuly:t.thongbao})}):n.jobtitlies.length>0&&n.jobDepts.forEach(function(r){var u=_.pluck(n.jobtitlies,"label").join(", ")+" thuộc "+r.data;i.push({label:u,value:"DeptForJobtitle-"+r.value,type:n.isDg?t.dongxuly:t.thongbao})}),n.deptGs.forEach(function(n){i.push({label:n.data,value:"FilterDepartmentVote-"+n.value,type:t.giamsat})}),n.userGs.forEach(function(n){i.push({label:n.fullname+" - "+n.username,value:"FilterDepartmentVote-user_"+n.value,type:t.giamsat})}),i)},getUserConsults:function(){var n=this.result,t=[],r,f,i;return n===undefined?t:(r=this.allUserDeptPosition,f=this.allUsers,n.isAllUser||n.isAllDept&&n.isAllJobtitle)?_.pluck(f,"value"):(n.users.length>0&&(t=_.union(t,_.pluck(n.users,"value"))),n.depts.length>0&&(t=_.union(t,u(_.pluck(n.depts,"value"),r))),n.isAllDept?!n.isAllJobtitle&&n.jobtitlies.length>0&&(i=_.filter(r,function(t){return _.find(n.jobtitlies,function(n){return n.value===t.jobtitleid})}),i.length>0&&(t=_.union(t,u(_.pluck(i,"departmentid"),r)))):n.isAllJobtitle?!n.isAllDept&&n.jobDepts.length>0&&(i=_.filter(r,function(t){return _.find(n.jobDepts,function(n){return n.departmentid===t.departmentid})}),i.length>0&&(t=_.union(t,u(_.pluck(i,"departmentid"),r)))):n.jobtitlies.length>0&&(i=_.filter(r,function(t){var i=_.find(n.jobDepts,function(n){return n.value===t.departmentid}),r=_.find(n.jobtitlies,function(n){return n.value===t.jobtitleid});return i&&r}),i.length>0&&(t=_.union(t,u(_.pluck(i,"departmentid"),r)))),_.uniq(t,!1))},getUserGiamSat:function(){var t=this.result,n=[],i,r;return t===undefined?n:(i=this.allUserDeptPosition,r=this.allUsers,t.userGs.length>0&&(n=_.union(n,_.pluck(t.userGs,"value"))),t.deptGs.length>0&&(n=_.union(n,u(_.pluck(t.deptGs,"value"),i))),_.uniq(n,!1))},getUserReceiveDocument:function(){var n=[],t=this.allUserDeptPosition,i=this.allUsers,r=this.allDepts;return $("#FilterDepartmentVote").jstree("get_checked",null,!1).each(function(){var o=$(this),u=this.id,c=o.attr("hasreceivedocument")==="true",l=o.attr("rel")==="dept",f,s,h,e;l?(f=_.find(r,function(n){return n.value==u}),f&&(f.idext.indexOf(".")<0?(s=_.filter(t,function(n){return n.hasReceiveDocument==!0}),n=_.union(n,_.pluck(s,"userid"))):(h=_.filter(t,function(n){return n.departmentid==f.value&&n.hasReceiveDocument==!0}),n=_.union(n,_.pluck(h,"userid"))))):c&&(u=u.replace("user_",""),e=_.find(i,function(n){return n.value==u}),e&&(_.contains(n,e)||n.push(e)))}),n},getExtInfo:function(){if(!this.result)return null;var n={isAllUser:!1,isAllDept:!1,isAllJobtitle:!1,users:[],jobtitlies:[],jobDepts:[],depts:[]};return this.result.isAllUser?(n.isAllUser=!0,n):this.result.isAllJobtitle?(n.isAllJobtitle=!0,this.result.isAllDept&&(n.isAllDept=!0),n):(this.result.users&&this.result.users.length>0&&(n.users=_.pluck(this.result.users,"value")),this.result.jobtitlies&&this.result.jobtitlies.length>0&&(n.jobtitlies=_.pluck(this.result.jobtitlies,"value")),this.result.jobDepts&&this.result.jobDepts.length>0&&(n.jobDepts=_.pluck(this.result.jobDepts,"value")),this.result.depts&&this.result.depts.length>0&&(n.depts=_.pluck(this.result.depts,"value")),n)},checkIsDongGui:function(){return this.$('[name="isDg"]:checked').val()==="1"},selectDg:function(n,t){var u=this.getDestination(),f,i,e,r;if(u&&!(u.length<=0))for(f=0;f<u.length;f++){if(i=u[f].value,e=u[f].type,t&&e==egov.enum.transferType.giamsat){t.append(c(i,u[f].label,"user"));continue}r="user";i==="all"?r="all":i===""?r="allJobtitle":i.indexOf("FilterDepartmentVote-user_")!==-1?r="dept-user":i.indexOf("FilterDepartmentVote-")!==-1?r="dept":i==="JobtitleForDept"?r="jobtitleForDept":i.indexOf("DeptForJobtitle-")!==-1&&(r="deptForJobtitle");n.append(c(i,u[f].label,r))}},uncheckPrivateAnoun:function(n){var f=$(n.target),t,r,u,i;if(f.is(":checkbox"))if(t=f.val().split("-"),t[0]==="all"){for(r=$("#JobtitleForDept").find("input[type=checkbox]"),i=0;i<r.length;i++)$(r[i]).attr("checked")!==undefined&&$(r[i]).removeAttr("checked");$("#FilterDepartmentVote").jstree("uncheck_node",$("#FilterDepartmentVote").find("li"))}else if(t[0]==="FilterDepartmentVote"||t[0]==="DeptForJobtitle"){if($("#"+t[0]).jstree("uncheck_node",$("#"+t[0]).find("li#"+t[1])),t[0]==="DeptForJobtitle")for(u=egov.views.dg.getDestination(),i=0;i<u.length;i++)u[i].value==="JobtitleForDept"&&$("#JobtitleForDept").find("input[type=checkbox]").removeAttr("checked")}else t[0]==="JobtitleForDept"&&$("#"+t[0]).find("input[type=checkbox]").removeAttr("checked")},uncheckGiamsat:function(n){var i=$(n.target),t;i.is(":checkbox")&&(t=i.val().split("-"),t[0]==="FilterDepartmentVote"&&$("#FilterDepartmentVoteGiamSat").jstree("uncheck_node",$("#FilterDepartmentVoteGiamSat").find("li#"+t[1])))},_bind:function(n){var t=this,i=this.$("#dgUserVote"),r=this.$(".filterDeparmentVote#FilterDepartmentVote");t._bindUsers(i,r);t._bindDepartments(function(){t._bindJobtitlies(function(){t._show();t._bindCallback();egov.callback(n);t.$el.bindResources();t.$("#dgUserVote").focus()})})},_bindUsers:function(n,u){var o=n,f=this,u=u,e=f.allUserDeptPosition;o.autocomplete({source:f.allUsers,focus:function(n,t){return o.val(t.item.username),!1},select:function(n,s){var p=_.filter(e,function(n){return n.userid===s.item.value}),v,c,k,y,h,l,a,w,b;if(p){for(v=0;r=p.length,v<r;v++)if(c=p[v].idext.split("."),c)for(k="li#user_"+s.item.value,y=u.find(k),typeof y!="undefined"&&y.length>0&&u.jstree("check_node",y),h=0;i=c.length,h<i;h++){if(l=c[h],a=u.find("li[id="+l+"]"),a.length>0){a.hasClass("jstree-closed")&&a.children("ul").length===0&&t(a,parseInt(l),!0,!0,f.allDepts,f.allUsers,e);continue}w=$("");b=0;h>0&&(w=u.find("li[id="+c[h-1]+"]"),b=parseInt(c[h-1]));t(w,b,!0,!0,f.allDepts,f.allUsers,e);h===i-1&&t(u.find("li[id="+l+"]"),parseInt(l),!0,!0,f.allDepts,f.allUsers,e)}u.jstree("check_node",u.jstree("get_unchecked",null,!0).find("li[rel!=dept][id=user_"+s.item.value+"]"))}return o.val(""),!1}}).data("autocomplete")._renderItem=function(n,t){return n.addClass("dropdown-menu"),$("<li><\/li>").data("item.autocomplete",t).append("<a>"+t.label+"<\/a>").appendTo(n)}},_bindDepartments:function(n){var t=this,i=t.allDepts;require(["jstree"],function(){h(t.$el.find("#FilterDepartmentVote"),!0,!0,!1,i,t.allUsers,t.allUserDeptPosition,null,[]);h(t.$el.find("#DeptForJobtitle"),!1,!0,!1,i,[],[],null,[]);typeof n=="function"&&n()})},_bindJobtitlies:function(n){var t,r,e,i,u,f;for(this.$jobtitlies=this.$(".dgJobtitlies"),t=this,r=t.allJobtitle,i=0;e=r.length,i<e;i++)u=r[i],f=$("<li>").addClass("list-group-item"),f.append('<label class="mdl-checkbox mdl-js-checkbox checkbox"><input class="mdl-checkbox__input" type="checkbox" value="'+u.value+'"/> '+u.label+"<\/label>"),t.$jobtitlies.append(f);egov.isMobile&&t.$jobtitlies.find(".mdl-checkbox").materialCheckbox();$("#JobtitleForDept #allJobsForDept").checkAll($("#JobtitleForDept :checkbox").not(":first"));t.$(".jobtitlies #allJobs").checkAll(t.$(".jobtitlies :checkbox").not(":first"));typeof n=="function"&&n()},_bindCallback:function(){var n=this;$("#FilterDepartmentVote, #DeptForJobtitle, #FilterDepartmentVoteGiamSat").bind("change_state.jstree",function(){n.callback()});$("#JobtitleForDept :checkbox").on("click",function(){n.callback()});n.$('[name="isDg"]').on("click",function(){n.callback()})},_getUsersDept:function(){var n=this.result,t=this,i=t.allDepts,r=t.allUsers;$("#FilterDepartmentVote").jstree("get_checked",null,!1).each(function(){var e=$(this),t=this.id,o=e.attr("rel")==="dept",u,f;if(o){if(u=_.find(i,function(n){return n.value==t}),u){if(u.idext.indexOf(".")<0){n.isAllUser=!0;return}n.depts.push(u)}}else t=t.replace("user_",""),f=_.find(r,function(n){return n.value==t}),f&&(_.contains(n.users,f)||n.users.push(f))})},_processResult:function(){var n=this;return this.result.depts.forEach(function(t){n.result.jobDepts=_.reject(n.result.jobDepts,function(n){return n.idext.split(".").indexOf(""+t.value)>=0})}),this.result},_resetForm:function(){$("#FilterDepartmentVote").jstree("uncheck_node",$("#FilterDepartmentVote").find("li"))},_show:function(){var n=this;n.$("#dgUsersVote").each(function(){$(this).customDropdown({css:{width:300,height:"auto"}})});n._resetForm()},bindDataInTransferView:function(n,t){n?this.$('input[name="isDg"][value="1"]').prop("checked",!0):this.$('input[name="isDg"][value="0"]').prop("checked",!0);this.bindDataView(t)},bindDataView:function(n){if(n&&typeof n=="object"){if(n.isAllUser){this._showAllUser();return}if(n.isAllJobtitle){if(this._showAllJobtitle(),n.isAllDept){this._showAllJobDepts();return}}else this._showJobtitle(n.jobtitlies);n.isAllDept?this._showAllJobDepts():this._showJobDepts(n.jobDepts);this._showDepts(n.depts);this._showUsers(n.users)}},_showUsers:function(n){var u,o,l,s,a,e,w,v,f,h,c,y,p;if(n&&!(n.length<=0)&&(u=this,this.$filterDept=this.$(".filterDeparmentVote"),o=u.allUserDeptPosition,l=_.filter(o,function(t){return _.contains(n,t.userid)}),l))for(s=0;s<n.length;s++){for(a=0;r=l.length,a<r;a++)if(e=l[a].idext.split("."),e)for(w="li#user_"+n[s],v=u.$filterDept.find(w),typeof v!="undefined"&&v.length>0&&u.$filterDept.jstree("check_node",v),f=0;i=e.length,f<i;f++){if(h=e[f],c=u.$filterDept.find("li[id="+h+"]"),c.length>0){c.hasClass("jstree-closed")&&c.children("ul").length===0&&t(c,parseInt(h),!0,!0,u.allDepts,u.allUsers,o);continue}y=$("");p=0;f>0&&(y=u.$filterDept.find("li[id="+e[f-1]+"]"),p=parseInt(e[f-1]));t(y,p,!0,!0,u.allDepts,u.allUsers,o);f===i-1&&t(u.$filterDept.find("li[id="+h+"]"),parseInt(h),!0,!0,u.allDepts,u.allUsers,o)}u.$filterDept.jstree("check_node",u.$filterDept.jstree("get_unchecked",null,!0).find("li[rel!=dept][id=user_"+n[s]+"]"))}},_showAllUser:function(){this.$(".filterDeparmentVote").jstree("check_all")},_showAllJobtitle:function(){this.$(".jobtitleForDept :checkbox").prop("checked",!0)},_showJobtitle:function(n){if(n)for(var t=0;t<n.length;t++)this.$('.jobtitleForDept :checkbox[value="'+n[t]+'"]').prop("checked",!0)},_showAllJobDepts:function(){this.$(".deptForJobtitle").jstree("check_all")},_showJobDepts:function(n){var u,o,l,s,a,e,w,v,f,h,c,y,p;if(n&&!(n.length<=0)&&(u=this,this.$deptForJobtitle=this.$(".deptForJobtitle"),o=u.allDepts,l=_.filter(o,function(t){return _.contains(n,t.value)}),l))for(s=0;s<n.length;s++){for(a=0;r=l.length,a<r;a++)if(e=l[a].idext.split("."),e)for(w="li#"+n[s],v=u.$deptForJobtitle.find(w),typeof v!="undefined"&&v.length>0&&u.$deptForJobtitle.jstree("check_node",v),f=0;i=e.length,f<i;f++){if(h=e[f],c=u.$deptForJobtitle.find("li[id="+h+"]"),c.length>0){c.hasClass("jstree-closed")&&c.children("ul").length===0&&t(c,parseInt(h),!0,!0,o,[],[]);continue}y=$("");p=0;f>0&&(y=u.$deptForJobtitle.find("li[id="+e[f-1]+"]"),p=parseInt(e[f-1]));t(y,p,!0,!0,o,[],[]);f===i-1&&t(u.$deptForJobtitle.find("li[id="+h+"]"),parseInt(h),!0,!0,o,[],[])}u.$deptForJobtitle.jstree("check_node",u.$deptForJobtitle.jstree("get_unchecked",null,!0).find("li[rel=dept][id="+n[s]+"]"))}},_showDepts:function(n){var u,o,l,s,a,e,w,v,f,h,c,y,p;if(n&&!(n.length<=0)&&(u=this,this.$filterDept=this.$(".filterDeparmentVote"),o=u.allUserDeptPosition,l=_.filter(o,function(t){return _.contains(n,t.departmentid)}),l))for(s=0;s<n.length;s++){for(a=0;r=l.length,a<r;a++)if(e=l[a].idext.split("."),e)for(w="li#"+n[s],v=u.$filterDept.find(w),typeof v!="undefined"&&v.length>0&&u.$filterDept.jstree("check_node",v),f=0;i=e.length,f<i;f++){if(h=e[f],c=u.$filterDept.find("li[id="+h+"]"),c.length>0){c.hasClass("jstree-closed")&&c.children("ul").length===0&&t(c,parseInt(h),!0,!0,u.allDepts,u.allUsers,o);continue}y=$("");p=0;f>0&&(y=u.$filterDept.find("li[id="+e[f-1]+"]"),p=parseInt(e[f-1]));t(y,p,!0,!0,u.allDepts,u.allUsers,o);f===i-1&&t(u.$filterDept.find("li[id="+h+"]"),parseInt(h),!0,!0,u.allDepts,u.allUsers,o)}u.$filterDept.jstree("check_node",u.$filterDept.jstree("get_unchecked",null,!0).find("li[rel=dept][id="+n[s]+"]"))}}}),o='<li id="${value}" label="${attr.label}" rel="${attr.rel}" idext="${attr.idext}" class="jstree-${state}"><ins class="jstree-icon">&nbsp;<\/ins><a href="#" class="">',s;o+='<ins class="jstree-icon">&nbsp;<\/ins>${data}<\/a><\/li>';s='<li id="${value}" rel="${attr.rel}" idext="${attr.idext}" hasReceiveDocument="${attr.hasReceiveDocument}" class="jstree-${state}"><ins class="jstree-icon">&nbsp;<\/ins><a href="#" class=""><ins class="jstree-checkbox">&nbsp;<\/ins><ins class="jstree-icon">&nbsp;<\/ins>${data}<\/a><\/li>';var f=["themes","json_data","ui","crrm"],e=function(n,t,i,r,u){var f=_.filter(i,function(t){return t.parentid==n}),o=_.filter(u,function(t){return t.departmentid===n}),c,s,h,l;if(f.length>0)for(c=0;c<f.length;c++)(e(f[c].value,!1,i,[],[]).length>0||t&&o.length>0)&&(f[c].state="closed");if(t&&o.length>0)for(s=0;s<o.length;s++)h=_.find(r,function(n){return n.value===o[s].userid}),h&&(l={value:"user_"+h.value,data:h.fullname,parentid:n,state:"leaf",metadata:{id:"user_"+h.value},attr:{id:"user_"+h.value,rel:"people",idext:o[s].idext,hasReceiveDocument:o[s].hasReceiveDocument}},f.push(l));return f},h=function(n,i,r,u,o,s,h){var c=_.find(o,function(n){return n.parentid===0}),l;r&&f.push("checkbox");u&&f.push("dnd");c&&(l=e(c.value,i,o,s,h),n.jstree({json_data:{data:[{data:c.data.toString(),metadata:{id:c.value},state:"closed",attr:{id:c.value,rel:"dept",idext:c.idext,label:c.label},children:l}]},crrm:u==!1?{}:{move:{check_move:function(n){var i=_.find(o,function(t){return t.value===parseInt(n.o.attr("id"))}),t;return i?i.level!=1?!1:(t=this._get_parent(n.o),!t)?!1:(t=t==-1?this.get_container():t,t===n.np)?!0:t[0]&&n.np[0]&&t[0]===n.np[0]?!0:!1:!1}}},dnd:u==!1?{}:{drop_target:!1,drag_target:!1},plugins:f}).bind("loaded.jstree",function(u,f){var e=1;f.inst.get_container().find("li").each(function(){f.inst.get_path($(this)).length<=e&&f.inst.open_node($(this))});n.bind("open_node.jstree",function(n,u){u.inst._get_children(u.rslt.obj).length==0&&t(u.rslt.obj,parseInt(u.rslt.obj.attr("id")),i,r,o,s,h)})}))},t=function(n,t,i,r,u,f,h){var l=e(t,i,u,f,h),c;l.length>0&&(c=$("<ul><\/ul>"),c.appendTo(n),r?($.tmpl(s,l).appendTo(c),$(n).find("li").each(function(t,i){$(i).addClass(n.hasClass("jstree-checked")?"jstree-checked":"jstree-unchecked")})):$.tmpl(o,l).appendTo(c),c.children("li:last").addClass("jstree-last"))},u=function(n,t){var i=[];return n.forEach(function(n){var r=_.filter(t,function(t){return t.departmentid===n||t.idext.indexOf("."+n+".")>0});r.length>0&&(i=_.union(i,_.pluck(r,"userid")))}),i=_.uniq(i,!1)},c=function(n,t,i){var r;return r=$(String.format('<li class="list-group-item {2}">                                <div class="row">                                    <label class="mdl-checkbox mdl-js-checkbox checkbox document-color">                                       <input class="mdl-checkbox__input" name="checkbox[]" value="{0}" type="checkbox" checked="checked">                                        <span class="document-color-1"><i class="icon-check"><\/i><\/span>                                    <\/label>                                    <span style="margin-left: 15px;">{1}<\/span>                                <\/div>                            <\/li>',n,t,i)),egov.isMobile&&$(r).find(".mdl-checkbox").materialCheckbox(),r};return a});define([egov.template.referendum,"referendumModel"],function(n){var t=Backbone.View.extend({template:n,listVote:new ListVote,events:{},initialize:function(){return this.listenTo(this.listVote,"add",this.addVote),this.listenTo(this.listVote,"reset",this.resetVote),this.render(),this.getVotes(),this},render:function(){var n=this,t;return $("#ListVoteBody").remove(),installElement=$("<div id='ListVoteBody'>"),installElement.appendTo("body"),this.$el=$("#ListVoteBody"),this.$el.html($.tmpl(this.template)),n=this,t={width:900,height:"auto",draggable:!0,title:"Danh sách các cuộc thăm dò ý kiến",buttons:[{text:"Tạo mới",className:"btn-success",click:function(){n._create()}},{text:"Đóng",click:function(){n.$el.dialog("hide");n.$el.remove()}}]},n.$el.dialog(t),n},addVote:function(n){this.empty&&(this.listVote.reset(),this.empty=!1);var t=new i({model:n});this.$(".listVote").append(t.render().el)},getVotes:function(){var n=this;n.listVote.reset();egov.request.getVotes({data:{},success:function(t){var i,r;if(t.length==0){n.empty=!0;this.$(".listVote").html("<tr><td colspan='4'>Không có cuộc trưng cầu nào<\/td><\/tr>");return}for(i=0;i<t.length;i++)r=new VoteModel(t[i]),n.listVote.add(r);n.listVote.comparator=function(n){return n.get("IsNow")};n.listVote.sort()},error:function(){}})},resetVote:function(){this.$(".listVote").html("")},_create:function(){that=this;require(["referendumCreate"],function(n){var t=new n({vote:that})})}}),i=Backbone.View.extend({tagName:"tr",events:{"dblclick td":"getShowView","click .editVote":"editVote","click .deleteVote":"deleteVote","click .viewVote":"getShowView"},template:'<td class="wraptext">${Title}<\/td><td class="second-color time-begin-vote" style="text-align:right;width: 150px"> ${TimeBeginFormat} <\/td><td class="second-color wraptext" style="width: 100px">${UsernameCreate}<\/td><td style="text-align:center;width: 100px">      <label class="checkbox document-color">          <input name="checkbox[]" value="2378" type="checkbox"{{if IsNow}}checked{{/if}} disabled>          <span class="document-color-1"><i class="icon-check"><\/i><\/span>      <\/label>  <\/td><td class="second-color wraptext" style="width: 100px">{{if IsCreate}}<a class="editVote"href="#" style="color: blue">Chi tiết<\/a> <a href="#" class="deleteVote" style="color: red">Xóa<\/a>{{else}}<a class="viewVote"href="#">Xem<\/a>{{/if}}<\/td>',model:VoteModel,initialize:function(){var t=function(n){n instanceof Date||(n=n.match(/\d+/)[0]);var t=new Date(Number(n));return t.getHours()+":"+("0"+t.getMinutes()).slice(-2)+"   "+t.getDate()+"-"+Number(t.getMonth()+1)+"-"+t.getFullYear()},n=function(n){n instanceof Date||(n=n.match(/\d+/)[0]);return new Date(Number(n))};this.listenTo(this.model,"add",this.render);this.listenTo(this.model,"change",this.render);this.model.set({TimeBeginFormat:t(this.model.get("TimeBegin"))});(new Date).getTime()>n(this.model.get("TimeBegin")).getTime()&&(new Date).getTime()<n(this.model.get("TimeEnd")).getTime()&&this.model.set({IsNow:!0})},render:function(){var n=this;return n.$el.html($.tmpl(n.template,n.model.toJSON())),n},getShowView:function(){this.showView(4)},editVote:function(){var n=this;egov.request.getVoteDetail({data:{voteId:n.model.get("VoteId")},success:function(n){require(["referendumCreate"],function(t){var i=new t({vote:n,isEdit:!0})})},error:function(){}})},deleteVote:function(){var n=this,t=confirm("Bạn có muốn xóa cuộc trưng cầu này");if(t==!1)return!1;egov.request.deleteVote({data:{voteId:n.model.get("VoteId")},success:function(){n.model.destroy();n.$el.remove()},error:function(){}})},showView:function(n){var t=this;egov.request.getVoteDetail({data:{voteId:t.model.get("VoteId")},success:function(t){require(["referendumVote"],function(i){var r=new VoteModel(t),u=new i({model:r,view:n});u.render()})},error:function(){}})},_create:function(){}});return t});define([egov.template.deptUserView],function(n){"use strict";var c=egov.resources.document.transfer,r,i,l=Backbone.View.extend({className:"dropdown-userDept",template:n,initialize:function(){return this},render:function(n,t,i,r){var u,f;if($("body .dropdown-userDept").length>0&&$("body .dropdown-userDept").remove(),this.$el.html(this.template),this.$el.bindResources(),this.$el.appendTo("body"),this.callbackFunc=i,this.hasDg=n,this.showRelation=t,u=this,egov.dataManager)return f=egov.dataManager,f.getAllUsers({success:function(n){u.allUsers=n;f.getAllJobtitle({success:function(n){u.allJobtitle=n;f.getAllDept({success:function(n){u.allDepts=n;f.getAllUserDeptPosition({success:function(n){u.allUserDeptPosition=n;u._bind(r)}})}})}})}}),egov.isMobile&&(this.$(".mdl-checkbox").materialCheckbox(),this.$(".mdl-button").materialButton(),this.$(".mdl-radio").materialRadio(),this.$(".mdl-textfield").materialTextfield()),$(".filterDeparmentView").hide(),this},reRender:function(n,t,i){this.callbackFunc=i;this.hasDg=n;this.showRelation=t;this._show();this._bindCallback();$(".filterDeparmentView").hide();that.$("#dgUserView").focus()},destroy:function(){this.$("#dgUsersView").each(function(){$(this).customDropdown("destroy")});this.$el.remove()},callback:function(){typeof this.callbackFunc=="function"&&this.callbackFunc()},serialize:function(){return this.result={isDg:this.$('[name="isDg"]:checked').val()==="1",isAllUser:!1,isAllDept:!1,isAllJobtitle:!1,users:[],depts:[],jobDepts:[],jobtitlies:[],userGs:[],deptGs:[]},this._getUsersDept(),this._processResult()},getDestination:function(){var n=this.serialize(),i=[],t=egov.enum.transferType,r,u;return n.isAllUser||n.isAllDept&&n.isAllJobtitle?(i.push({label:c.sendAll,value:"all",type:n.isDg?t.dongxuly:t.thongbao}),i):(n.depts.forEach(function(r){i.push({label:r.data,value:"FilterDepartmentView-"+r.value,type:n.isDg?t.dongxuly:t.thongbao})}),n.users.forEach(function(r){i.push({label:r.fullname+" - "+r.username,value:"FilterDepartmentView-user_"+r.value,type:n.isDg?t.dongxuly:t.thongbao})}),n.isAllDept?!n.isAllJobtitle&&n.jobtitlies.length>0&&(r=" thuộc "+n.jobDepts[0].data,u=_.pluck(n.jobtitlies,"label").join(", ")+r,i.push({label:u,value:"JobtitleForDept",type:n.isDg?t.dongxuly:t.thongbao})):n.isAllJobtitle?n.isAllDept||n.jobDepts.forEach(function(r){i.push({label:r.data,value:"",type:n.isDg?t.dongxuly:t.thongbao})}):n.jobtitlies.length>0&&n.jobDepts.forEach(function(r){var u=_.pluck(n.jobtitlies,"label").join(", ")+" thuộc "+r.data;i.push({label:u,value:"DeptForJobtitle-"+r.value,type:n.isDg?t.dongxuly:t.thongbao})}),n.deptGs.forEach(function(n){i.push({label:n.data,value:"FilterDepartmentView-"+n.value,type:t.giamsat})}),n.userGs.forEach(function(n){i.push({label:n.fullname+" - "+n.username,value:"FilterDepartmentView-user_"+n.value,type:t.giamsat})}),i)},getUserConsults:function(){var n=this.result,t=[],r,f,i;return n===undefined?t:(r=this.allUserDeptPosition,f=this.allUsers,n.isAllUser||n.isAllDept&&n.isAllJobtitle)?_.pluck(f,"value"):(n.users.length>0&&(t=_.union(t,_.pluck(n.users,"value"))),n.depts.length>0&&(t=_.union(t,u(_.pluck(n.depts,"value"),r))),n.isAllDept?!n.isAllJobtitle&&n.jobtitlies.length>0&&(i=_.filter(r,function(t){return _.find(n.jobtitlies,function(n){return n.value===t.jobtitleid})}),i.length>0&&(t=_.union(t,u(_.pluck(i,"departmentid"),r)))):n.isAllJobtitle?!n.isAllDept&&n.jobDepts.length>0&&(i=_.filter(r,function(t){return _.find(n.jobDepts,function(n){return n.departmentid===t.departmentid})}),i.length>0&&(t=_.union(t,u(_.pluck(i,"departmentid"),r)))):n.jobtitlies.length>0&&(i=_.filter(r,function(t){var i=_.find(n.jobDepts,function(n){return n.value===t.departmentid}),r=_.find(n.jobtitlies,function(n){return n.value===t.jobtitleid});return i&&r}),i.length>0&&(t=_.union(t,u(_.pluck(i,"departmentid"),r)))),_.uniq(t,!1))},getUserGiamSat:function(){var t=this.result,n=[],i,r;return t===undefined?n:(i=this.allUserDeptPosition,r=this.allUsers,t.userGs.length>0&&(n=_.union(n,_.pluck(t.userGs,"value"))),t.deptGs.length>0&&(n=_.union(n,u(_.pluck(t.deptGs,"value"),i))),_.uniq(n,!1))},getUserReceiveDocument:function(){var n=[],t=this.allUserDeptPosition,i=this.allUsers,r=this.allDepts;return $("#FilterDepartmentView").jstree("get_checked",null,!1).each(function(){var o=$(this),u=this.id,c=o.attr("hasreceivedocument")==="true",l=o.attr("rel")==="dept",f,s,h,e;l?(f=_.find(r,function(n){return n.value==u}),f&&(f.idext.indexOf(".")<0?(s=_.filter(t,function(n){return n.hasReceiveDocument==!0}),n=_.union(n,_.pluck(s,"userid"))):(h=_.filter(t,function(n){return n.departmentid==f.value&&n.hasReceiveDocument==!0}),n=_.union(n,_.pluck(h,"userid"))))):c&&(u=u.replace("user_",""),e=_.find(i,function(n){return n.value==u}),e&&(_.contains(n,e)||n.push(e)))}),n},getExtInfo:function(){if(!this.result)return null;var n={isAllUser:!1,isAllDept:!1,isAllJobtitle:!1,users:[],jobtitlies:[],jobDepts:[],depts:[]};return this.result.isAllUser?(n.isAllUser=!0,n):this.result.isAllJobtitle?(n.isAllJobtitle=!0,this.result.isAllDept&&(n.isAllDept=!0),n):(this.result.users&&this.result.users.length>0&&(n.users=_.pluck(this.result.users,"value")),this.result.jobtitlies&&this.result.jobtitlies.length>0&&(n.jobtitlies=_.pluck(this.result.jobtitlies,"value")),this.result.jobDepts&&this.result.jobDepts.length>0&&(n.jobDepts=_.pluck(this.result.jobDepts,"value")),this.result.depts&&this.result.depts.length>0&&(n.depts=_.pluck(this.result.depts,"value")),n)},checkIsDongGui:function(){return this.$('[name="isDg"]:checked').val()==="1"},selectDg:function(n,t){var u=this.getDestination(),f,i,e,r;if(u&&!(u.length<=0))for(f=0;f<u.length;f++){if(i=u[f].value,e=u[f].type,t&&e==egov.enum.transferType.giamsat){t.append(h(i,u[f].label,"user"));continue}r="user";i==="all"?r="all":i===""?r="allJobtitle":i.indexOf("FilterDepartmentView-user_")!==-1?r="dept-user":i.indexOf("FilterDepartmentView-")!==-1?r="dept":i==="JobtitleForDept"?r="jobtitleForDept":i.indexOf("DeptForJobtitle-")!==-1&&(r="deptForJobtitle");n.append(h(i,u[f].label,r))}},uncheckPrivateAnoun:function(n){var e=this,f=$(n.target),t,r,u,i;if(f.is(":checkbox"))if(t=f.val().split("-"),t[0]==="all"){for(r=$("#JobtitleForDept").find("input[type=checkbox]"),i=0;i<r.length;i++)$(r[i]).attr("checked")!==undefined&&$(r[i]).removeAttr("checked");$("#FilterDepartmentView").jstree("uncheck_node",$("#FilterDepartmentView").find("li"))}else if(t[0]==="FilterDepartmentView"||t[0]==="DeptForJobtitle"){if($("#"+t[0]).jstree("uncheck_node",$("#"+t[0]).find("li#"+t[1])),t[0]==="DeptForJobtitle")for(u=egov.views.dg.getDestination(),i=0;i<u.length;i++)u[i].value==="JobtitleForDept"&&$("#JobtitleForDept").find("input[type=checkbox]").removeAttr("checked")}else t[0]==="JobtitleForDept"&&$("#"+t[0]).find("input[type=checkbox]").removeAttr("checked")},uncheckGiamsat:function(n){var i=$(n.target),t;i.is(":checkbox")&&(t=i.val().split("-"),t[0]==="FilterDepartmentView"&&$("#FilterDepartmentGiamSat").jstree("uncheck_node",$("#FilterDepartmentGiamSat").find("li#"+t[1])))},_bind:function(n){var t=this,i=this.$("#dgUserView"),r=this.$(".filterDeparmentView#FilterDepartmentView");t._bindUsers(i,r);t._bindDepartments(function(){t._bindJobtitlies(function(){t._show();t._bindCallback();egov.callback(n);t.$el.bindResources();t.$("#dgUserView").focus()})})},_bindUsers:function(n,u){var o=n,f=this,u=u,e=f.allUserDeptPosition;o.autocomplete({source:f.allUsers,focus:function(n,t){return o.val(t.item.username),!1},select:function(n,s){var p=_.filter(e,function(n){return n.userid===s.item.value}),v,c,k,y,h,l,a,w,b;if(p){for(v=0;r=p.length,v<r;v++)if(c=p[v].idext.split("."),c)for(k="li#user_"+s.item.value,y=u.find(k),typeof y!="undefined"&&y.length>0&&u.jstree("check_node",y),h=0;i=c.length,h<i;h++){if(l=c[h],a=u.find("li[id="+l+"]"),a.length>0){a.hasClass("jstree-closed")&&a.children("ul").length===0&&t(a,parseInt(l),!0,!0,f.allDepts,f.allUsers,e);continue}w=$("");b=0;h>0&&(w=u.find("li[id="+c[h-1]+"]"),b=parseInt(c[h-1]));t(w,b,!0,!0,f.allDepts,f.allUsers,e);h===i-1&&t(u.find("li[id="+l+"]"),parseInt(l),!0,!0,f.allDepts,f.allUsers,e)}u.jstree("check_node",u.jstree("get_unchecked",null,!0).find("li[rel!=dept][id=user_"+s.item.value+"]"))}return o.val(""),!1}}).data("autocomplete")._renderItem=function(n,t){return n.addClass("dropdown-menu"),$("<li><\/li>").data("item.autocomplete",t).append("<a>"+t.label+"<\/a>").appendTo(n)}},_bindDepartments:function(n){var t=this,i=t.allDepts;require(["jstree"],function(){a(t.$el.find("#FilterDepartmentView"),!0,!0,!1,i,t.allUsers,t.allUserDeptPosition,null,[]);typeof n=="function"&&n()})},_bindJobtitlies:function(n){var t,r,e,i,u,f;for(this.$jobtitlies=this.$(".dgJobtitlies"),t=this,r=t.allJobtitle,i=0;e=r.length,i<e;i++)u=r[i],f=$("<li>").addClass("list-group-item"),f.append('<label class="mdl-checkbox mdl-js-checkbox checkbox"><input class="mdl-checkbox__input" type="checkbox" value="'+u.value+'"/> '+u.label+"<\/label>"),t.$jobtitlies.append(f);egov.isMobile&&t.$jobtitlies.find(".mdl-checkbox").materialCheckbox();$("#JobtitleForDept #allJobsForDept").checkAll($("#JobtitleForDept :checkbox").not(":first"));t.$(".jobtitlies #allJobs").checkAll(t.$(".jobtitlies :checkbox").not(":first"));typeof n=="function"&&n()},_bindCallback:function(){var n=this;$("#FilterDepartmentView, #DeptForJobtitle, #FilterDepartmentGiamSat").bind("change_state.jstree",function(){n.callback()});$("#JobtitleForDept :checkbox").on("click",function(){n.callback()});n.$('[name="isDg"]').on("click",function(){n.callback()})},_getUsersDept:function(){var n=this.result,t=this,i=t.allDepts,r=t.allUsers;$("#FilterDepartmentView").jstree("get_checked",null,!1).each(function(){var e=$(this),t=this.id,o=e.attr("rel")==="dept",u,f;if(o){if(u=_.find(i,function(n){return n.value==t}),u){if(u.idext.indexOf(".")<0){n.isAllUser=!0;return}n.depts.push(u)}}else t=t.replace("user_",""),f=_.find(r,function(n){return n.value==t}),f&&(_.contains(n.users,f)||n.users.push(f))})},_processResult:function(){var n=this;return this.result.depts.forEach(function(t){n.result.jobDepts=_.reject(n.result.jobDepts,function(n){return n.idext.split(".").indexOf(""+t.value)>=0})}),this.result},_resetForm:function(){$("#FilterDepartmentView").jstree("uncheck_node",$("#FilterDepartmentView").find("li"));$("#DeptForJobtitle").jstree("uncheck_node",$("#DeptForJobtitle").find("li"));$("#JobtitleForDept").find("input[type=checkbox]").removeAttr("checked")},_show:function(){var n=this;n.$("#dgUsersView").each(function(){$(this).customDropdown({css:{width:300,height:"auto"}})});n._resetForm()},bindDataInTransferView:function(n,t){n?this.$('input[name="isDg"][value="1"]').prop("checked",!0):this.$('input[name="isDg"][value="0"]').prop("checked",!0);this.bindDataView(t)},bindDataView:function(n){if(n&&typeof n=="object"){if(n.isAllUser){this._showAllUser();return}if(n.isAllJobtitle){if(this._showAllJobtitle(),n.isAllDept){this._showAllJobDepts();return}}else this._showJobtitle(n.jobtitlies);n.isAllDept?this._showAllJobDepts():this._showJobDepts(n.jobDepts);this._showDepts(n.depts);this._showUsers(n.users)}},_showUsers:function(n){var u,o,l,s,a,e,w,v,f,h,c,y,p;if(n&&!(n.length<=0)&&(u=this,this.$filterDept=this.$(".filterDeparmentView"),o=u.allUserDeptPosition,l=_.filter(o,function(t){return _.contains(n,t.userid)}),l))for(s=0;s<n.length;s++){for(a=0;r=l.length,a<r;a++)if(e=l[a].idext.split("."),e)for(w="li#user_"+n[s],v=u.$filterDept.find(w),typeof v!="undefined"&&v.length>0&&u.$filterDept.jstree("check_node",v),f=0;i=e.length,f<i;f++){if(h=e[f],c=u.$filterDept.find("li[id="+h+"]"),c.length>0){c.hasClass("jstree-closed")&&c.children("ul").length===0&&t(c,parseInt(h),!0,!0,u.allDepts,u.allUsers,o);continue}y=$("");p=0;f>0&&(y=u.$filterDept.find("li[id="+e[f-1]+"]"),p=parseInt(e[f-1]));t(y,p,!0,!0,u.allDepts,u.allUsers,o);f===i-1&&t(u.$filterDept.find("li[id="+h+"]"),parseInt(h),!0,!0,u.allDepts,u.allUsers,o)}u.$filterDept.jstree("check_node",u.$filterDept.jstree("get_unchecked",null,!0).find("li[rel!=dept][id=user_"+n[s]+"]"))}},_showAllUser:function(){this.$(".filterDeparmentView").jstree("check_all")},_showAllJobtitle:function(){this.$(".jobtitleForDept :checkbox").prop("checked",!0)},_showJobtitle:function(n){if(n)for(var t=0;t<n.length;t++)this.$('.jobtitleForDept :checkbox[value="'+n[t]+'"]').prop("checked",!0)},_showAllJobDepts:function(){this.$(".deptForJobtitle").jstree("check_all")},_showJobDepts:function(n){var u,o,l,s,a,e,w,v,f,h,c,y,p;if(n&&!(n.length<=0)&&(u=this,this.$deptForJobtitle=this.$(".deptForJobtitle"),o=u.allDepts,l=_.filter(o,function(t){return _.contains(n,t.value)}),l))for(s=0;s<n.length;s++){for(a=0;r=l.length,a<r;a++)if(e=l[a].idext.split("."),e)for(w="li#"+n[s],v=u.$deptForJobtitle.find(w),typeof v!="undefined"&&v.length>0&&u.$deptForJobtitle.jstree("check_node",v),f=0;i=e.length,f<i;f++){if(h=e[f],c=u.$deptForJobtitle.find("li[id="+h+"]"),c.length>0){c.hasClass("jstree-closed")&&c.children("ul").length===0&&t(c,parseInt(h),!0,!0,o,[],[]);continue}y=$("");p=0;f>0&&(y=u.$deptForJobtitle.find("li[id="+e[f-1]+"]"),p=parseInt(e[f-1]));t(y,p,!0,!0,o,[],[]);f===i-1&&t(u.$deptForJobtitle.find("li[id="+h+"]"),parseInt(h),!0,!0,o,[],[])}u.$deptForJobtitle.jstree("check_node",u.$deptForJobtitle.jstree("get_unchecked",null,!0).find("li[rel=dept][id="+n[s]+"]"))}},_showDepts:function(n){var u,o,l,s,a,e,w,v,f,h,c,y,p;if(n&&!(n.length<=0)&&(u=this,this.$filterDept=this.$(".filterDeparmentView"),o=u.allUserDeptPosition,l=_.filter(o,function(t){return _.contains(n,t.departmentid)}),l))for(s=0;s<n.length;s++){for(a=0;r=l.length,a<r;a++)if(e=l[a].idext.split("."),e)for(w="li#"+n[s],v=u.$filterDept.find(w),typeof v!="undefined"&&v.length>0&&u.$filterDept.jstree("check_node",v),f=0;i=e.length,f<i;f++){if(h=e[f],c=u.$filterDept.find("li[id="+h+"]"),c.length>0){c.hasClass("jstree-closed")&&c.children("ul").length===0&&t(c,parseInt(h),!0,!0,u.allDepts,u.allUsers,o);continue}y=$("");p=0;f>0&&(y=u.$filterDept.find("li[id="+e[f-1]+"]"),p=parseInt(e[f-1]));t(y,p,!0,!0,u.allDepts,u.allUsers,o);f===i-1&&t(u.$filterDept.find("li[id="+h+"]"),parseInt(h),!0,!0,u.allDepts,u.allUsers,o)}u.$filterDept.jstree("check_node",u.$filterDept.jstree("get_unchecked",null,!0).find("li[rel=dept][id="+n[s]+"]"))}}}),o='<li id="${value}" label="${attr.label}" rel="${attr.rel}" idext="${attr.idext}" class="jstree-${state}"><ins class="jstree-icon">&nbsp;<\/ins><a href="#" class="">',s;o+='<ins class="jstree-icon">&nbsp;<\/ins>${data}<\/a><\/li>';s='<li id="${value}" rel="${attr.rel}" idext="${attr.idext}" hasReceiveDocument="${attr.hasReceiveDocument}" class="jstree-${state}"><ins class="jstree-icon">&nbsp;<\/ins><a href="#" class=""><ins class="jstree-checkbox">&nbsp;<\/ins><ins class="jstree-icon">&nbsp;<\/ins>${data}<\/a><\/li>';var f=["themes","json_data","ui","crrm"],e=function(n,t,i,r,u){var f=_.filter(i,function(t){return t.parentid==n}),o=_.filter(u,function(t){return t.departmentid===n}),c,s,h,l;if(f.length>0)for(c=0;c<f.length;c++)(e(f[c].value,!1,i,[],[]).length>0||t&&o.length>0)&&(f[c].state="closed");if(t&&o.length>0)for(s=0;s<o.length;s++)h=_.find(r,function(n){return n.value===o[s].userid}),h&&(l={value:"user_"+h.value,data:h.fullname,parentid:n,state:"leaf",metadata:{id:"user_"+h.value},attr:{id:"user_"+h.value,rel:"people",idext:o[s].idext,hasReceiveDocument:o[s].hasReceiveDocument}},f.push(l));return f},a=function(n,i,r,u,o,s,h){var c=_.find(o,function(n){return n.parentid===0}),l;r&&f.push("checkbox");u&&f.push("dnd");c&&(l=e(c.value,i,o,s,h),n.jstree({json_data:{data:[{data:c.data.toString(),metadata:{id:c.value},state:"closed",attr:{id:c.value,rel:"dept",idext:c.idext,label:c.label},children:l}]},crrm:u==!1?{}:{move:{check_move:function(n){var i=_.find(o,function(t){return t.value===parseInt(n.o.attr("id"))}),t;return i?i.level!=1?!1:(t=this._get_parent(n.o),!t)?!1:(t=t==-1?this.get_container():t,t===n.np)?!0:t[0]&&n.np[0]&&t[0]===n.np[0]?!0:!1:!1}}},dnd:u==!1?{}:{drop_target:!1,drag_target:!1},plugins:f}).bind("loaded.jstree",function(u,f){var e=1;f.inst.get_container().find("li").each(function(){f.inst.get_path($(this)).length<=e&&f.inst.open_node($(this))});n.bind("open_node.jstree",function(n,u){u.inst._get_children(u.rslt.obj).length==0&&t(u.rslt.obj,parseInt(u.rslt.obj.attr("id")),i,r,o,s,h)})}))},t=function(n,t,i,r,u,f,h){var l=e(t,i,u,f,h),c;l.length>0&&(c=$("<ul><\/ul>"),c.appendTo(n),r?($.tmpl(s,l).appendTo(c),$(n).find("li").each(function(t,i){$(i).addClass(n.hasClass("jstree-checked")?"jstree-checked":"jstree-unchecked")})):$.tmpl(o,l).appendTo(c),c.children("li:last").addClass("jstree-last"))},u=function(n,t){var i=[];return n.forEach(function(n){var r=_.filter(t,function(t){return t.departmentid===n||t.idext.indexOf("."+n+".")>0});r.length>0&&(i=_.union(i,_.pluck(r,"userid")))}),i=_.uniq(i,!1)},h=function(n,t,i){var r;return r=$(String.format('<li class="list-group-item {2}">                                <div class="row">                                    <label class="mdl-checkbox mdl-js-checkbox checkbox document-color">                                       <input class="mdl-checkbox__input" name="checkbox[]" value="{0}" type="checkbox" checked="checked">                                        <span class="document-color-1"><i class="icon-check"><\/i><\/span>                                    <\/label>                                    <span style="margin-left: 15px;">{1}<\/span>                                <\/div>                            <\/li>',n,t,i)),egov.isMobile&&$(r).find(".mdl-checkbox").materialCheckbox(),r};return l});define([egov.template.createReferendum,"referendumModel"],function(n){function i(n){for(var i=[],t=0;t<n.length;t++)n[t]&&i.push(n[t]);return i}var r=Backbone.View.extend({template:n,model:VoteModel,initialize:function(n){this.IsEdit=n.isEdit?!0:!1;this.vote=n.vote;this.model=new VoteModel;var t=this;return this.IsEdit&&(t.listDetail=JSON.parse(t.vote.ListOpinion),t.model=new VoteModel(t.vote)),this.templateVoteDetail='<tr><td> <input name="text" value="${TitleDetail}" type="text" class="form-control vote-detail-title" style="border:none" placeholder="+ Thêm ý kiến"> <\/td><\/tr>',this.render(),this},render:function(){var f,o,r,n,s;$("#Referendum").length===0&&(f=$("<div id='Referendum'>"),f.appendTo("body"));this.$el=$("#Referendum");this.$el.html($.tmpl(this.template,this.model.toJSON()));this.$dg=this.$(".dg-view");this.$dg1=this.$(".dg-view1");this.$privateAnounc=this.$(".private-anoun ul:first");this.$privateAnounc1=this.$(".private-anoun1 ul:first");var i=[],e="Thêm cuộc trưng cầu ý kiến",u="Tạo mới";return this.IsEdit?(e="Sửa cuộc trưng cầu",u="Sửa",o=t(this.model.get("TimeBegin")),o.getTime()<(new Date).getTime()?$("#validateError").html("Đã hết thời gian sửa"):(r={text:u,className:"btn-success",click:function(){n._create()}},i.push(r))):(r={text:u,className:"btn-success",click:function(){n._create()}},i.push(r)),i.push({text:"Đóng",click:function(){n.$el.dialog("hide")}}),n=this,s={width:900,height:"auto",draggable:!0,title:e,buttons:i},n.$el.dialog(s),n._destroyDg(),n._destroyDg1(),n.renderTitleDetail(n.listDetail),n.renderDatePicker(),n._showDg1(),n.renderEdit(),$("#IsSyncUser").click(function(){var t=n.$el.find("#IsSyncUser").is(":checked");t?(n._destroyDg(),n.$el.find(".private-anoun > ul").html(""),n.$el.find(".private-anoun").parent().hide(),n.$el.find("#titleVote").text("Danh sách tham gia bỏ phiếu và xem kết quả")):(n.$el.find("#titleVote").text("Danh sách tham gia bỏ phiếu"),n.$el.find(".private-anoun").parent().show(),n._showDg())}),n},renderEdit:function(){var n=this;n.IsEdit&&(n._showDg(),setTimeout(function(){var r=n.vote.UsersVote.split(";"),u=n.vote.UsersView.split(";"),t,f;if(r=i(r),u=i(u),t=r.map(function(n){return parseInt(n,10)}),f=u.map(function(n){return parseInt(n,10)}),t.length==f.length){egov.views.dg1._showUsers(t);return}$("#IsSyncUser").click();n.$el.find("#titleVote").text("Danh sách tham gia bỏ phiếu");n.$el.find(".private-anoun").parent().show();egov.views.dg1._showUsers(t);egov.views.dg._showUsers(f)},1e3))},renderTitleDetail:function(n){var r=this,u=[],t,i;if(n==null)for(t=0;t<5;t++)i=new VoteDetailModel,u.push(i.toJSON());else{for(t=0;t<n.length;t++)i=new VoteDetailModel(n[t]),u.push(i.toJSON());i=new VoteDetailModel;u.push(i.toJSON())}r.$el.find(".listVoteDetail").html($.tmpl(r.templateVoteDetail,u));$(document).on("blur",".vote-detail-title",function(){var n=0,t;$(".vote-detail-title").each(function(){var t=$(this).val();t==""&&n++});n<2&&(t=new VoteDetailModel,r.$el.find(".listVoteDetail").append($.tmpl(r.templateVoteDetail,t.toJSON())))});$(document).on("keyup",".vote-detail-title",function(n){var t=$(n.target).closest("tr"),i,r;n.keyCode==40&&(i=t.next(),i.find(".vote-detail-title").focus());n.keyCode==38&&(r=t.prev(),r.find(".vote-detail-title").focus())})},renderDatePicker:function(){var n=this,f,i,r,u,e;$.datepicker.regional["vi-VN"]={closeText:"Đóng",prevText:"Trước",nextText:"Sau",currentText:"Hôm nay",monthNames:["Tháng một","Tháng hai","Tháng ba","Tháng tư","Tháng năm","Tháng sáu","Tháng bảy","Tháng tám","Tháng chín","Tháng mười","Tháng mười một","Tháng mười hai"],monthNamesShort:["Một","Hai","Ba","Bốn","Năm","Sáu","Bảy","Tám","Chín","Mười","Mười một","Mười hai"],dayNames:["Chủ nhật","Thứ hai","Thứ ba","Thứ tư","Thứ năm","Thứ sáu","Thứ bảy"],dayNamesShort:["CN","Hai","Ba","Tư","Năm","Sáu","Bảy"],dayNamesMin:["CN","T2","T3","T4","T5","T6","T7"],weekHeader:"Tuần",dateFormat:"dd/mm/yy",firstDay:1,isRTL:!1,showMonthAfterYear:!1,yearSuffix:""};$.datepicker.setDefaults($.datepicker.regional["vi-VN"]);f=n.$el.find("#beginDate,#endDate").datepicker({changeMonth:!0,changeYear:!0,dateFormat:"dd/mm/yy",defaultDate:new Date,onSelect:function(){var t=$(this).datepicker("getDate");$(this).attr("id")=="beginDate"&&n.model.set({TimeBegin:t});$(this).attr("id")=="endDate"&&n.model.set({TimeEnd:t})}});i=function(n){return n.getHours()+":"+("0"+n.getMinutes()).slice(-2)};n.IsEdit?(r=t(n.model.get("TimeBegin")),u=t(n.model.get("TimeEnd")),$("#beginDate").datepicker("setDate",r),$("#endDate").datepicker("setDate",u),$("#timeBegin").val(i(r)),$("#timeEnd").val(i(u))):$("#beginDate,#endDate").datepicker("setDate",new Date);e=n.$el.find("#timeBegin,#timeEnd").timepicker({timeFormat:"H:i",durationTime:new Date})},uncheckPrivateAnoun:function(n){egov.views.dg.uncheckPrivateAnoun(n);this._selectDg()},uncheckPrivateAnoun1:function(n){egov.views.dg1.uncheckPrivateAnoun(n);this._selectDg1()},_showDg:function(){var n=this;n.$dg.is(":not(:empty)")||(egov.views.dg?(egov.views.dg.render(!1,!1,function(){n._selectDg()}),n.$dg.html(egov.views.dg.$el)):require(["referendumDropdownUserView"],function(t){egov.views.dg=new t;egov.views.dg.render(!1,!1,function(){n._selectDg()},function(){n.$dg.html(egov.views.dg.$el)})}))},_showDg1:function(){var n=this;n.$dg1.is(":not(:empty)")||(egov.views.dg1?(egov.views.dg1.render(!1,!1,function(){n._selectDg1()}),n.$dg1.html(egov.views.dg1.$el)):require(["referendumDropdownUser"],function(t){egov.views.dg1=new t;egov.views.dg1.render(!1,!1,function(){n._selectDg1()},function(){n.$dg1.html(egov.views.dg1.$el)},!0)}))},_selectDg:function(){var n=this;n.$privateAnounc.empty();egov.views.dg.selectDg(this.$privateAnounc);n.$privateAnounc.find(".checkbox").on("click",function(t){n.uncheckPrivateAnoun(t)})},_selectDg1:function(){var n=this;n.$privateAnounc1.empty();egov.views.dg1.selectDg(this.$privateAnounc1);n.$privateAnounc1.find(".checkbox").on("click",function(t){n.uncheckPrivateAnoun1(t)})},_destroyDg:function(){egov.views.dg&&egov.views.dg.destroy()},_destroyDg1:function(){egov.views.dg1&&egov.views.dg1.destroy()},setTime:function(n,i){var e=this,u=$(n).val(),s=$(n).attr("id"),f;if(u){var o=u.split(":")[0],h=u.split(":")[1],r=e.model.get(i);r instanceof Date||(r=t(r));r.setHours(Number(o));r.setMinutes(Number(o));f={};f[i]=r;e.model.set(f)}},_validate:function(){var n=this,i=n.$el.find("#IsSyncUser").is(":checked"),r=n.$el.find(".comment").val(),t=[];return($(".vote-detail-title").each(function(){var n=$(this).val();n!=""&&t.push(n)}),r=="")?"Chưa có tiêu đề":t.length==0?"Chưa có ý kiến nào được ghi":egov.views.dg1.getUserConsults().length==0?"Chưa có người nào được tham gia trưng cầu":(egov.views.dg&&egov.views.dg.getUserConsults().length)==0&&!i?"Chưa có người nào được xem kết quả":n.model.get("TimeEnd").getTime()<n.model.get("TimeBegin").getTime()?"Thời gian bắt đầu không được lơn hơn thời gian kết thúc":!1},_create:function(){var n=this,t,f,e;if(n.setTime("#timeBegin","TimeBegin"),n.setTime("#timeEnd","TimeEnd"),t=n._validate(),t)return $("#validateError").html(t),!1;var o=n.$el.find("#IsSyncUser").is(":checked"),r=egov.views.dg1.getUserConsults(),i=[];i=o?r:i=egov.views.dg.getUserConsults();var s=n.$el.find(".comment").val(),h=n.$el.find("#IsMultiSelect").is(":checked"),c=n.$el.find("#IsPublic").is(":checked"),l=n.$el.find("#IsCommentDiff").is(":checked"),a=n.$el.find("#IsViewResultImmediately").is(":checked"),v=n.$el.find("#IsNotify").is(":checked"),u=[];if($(".vote-detail-title").each(function(){var n=$(this).val(),t;n!=""&&(t=new VoteDetailModel({VoteId:0,VoteDetailId:0,UserIdCreate:0,UserIdVote:"",TitleDetail:n}),u.push(t.toJSON()))}),f=JSON.stringify(r).replace(/[^a-zA-Z0-9]/g,";"),e=JSON.stringify(i).replace(/[^a-zA-Z0-9]/g,";"),n.model.set({Title:s,UsersView:e,UsersVote:f,IsMultiSelect:h,IsPublic:c,IsCommentDiff:l,IsViewResultImmediately:a,IsNotify:v,VoteDetailId:JSON.stringify(u)}),n.IsEdit){egov.request.updateVote({data:{voteStr:JSON.stringify(n.model.toJSON())},success:function(t){if(t.error){$("#validateError").html(t.content);return}var i=new VoteModel(t.content);n.$el.dialog("hide")},error:function(){$("#validateError").html("Có lỗi khi gửi lên server")}});return}egov.request.createVote({data:{vote:JSON.stringify(n.model.toJSON())},success:function(t){if(t.error){$("#validateError").html(t.content);return}var i=new VoteModel(t.content);i.set("IsCreate",!0);n.vote.listVote.add(i);n.$el.dialog("hide")},error:function(){$("#validateError").html("Có lỗi khi gửi lên server")}})}}),t=function(n){n instanceof Date||(n=n.match(/\d+/)[0]);return new Date(Number(n))};return r});define([egov.template.voteReferendum,egov.template.voteItemReferendum,egov.template.voteOnlyItemReferendum,egov.template.viewOnlyItemReferendum,"referendumModel"],function(n,t,i,r){function u(n){for(var i=[],t=0;t<n.length;t++)n[t]&&i.push(n[t]);return i}var f,e,o;return window.intervalVote=function(){},f=Backbone.View.extend({template:n,view:3,events:{"keydown .oppinionDiff":"commentDiff"},initialize:function(n){this.listenTo(listVoteDetail,"add",this.addVote);this.listenTo(listVoteDetail,"reset",this.resetVote);var i=this.model.get("UsersVote").split(";"),t=[];return this.model.get("UsersVoted")!=null&&(t=this.model.get("UsersVoted").split(";")),i=u(i),t=u(t),this.model.set("TimeBeginFormat",o(this.model.get("TimeBegin"))),this.model.set("CountUserVote",i.length),this.model.set("CountUserVoted",t.length),this.model=n.model,this.view=n.view,this.checkView(),this},checkView:function(){var r=new Date,n=this,t=n.model.get("TimeEnd"),i=n.model.get("TimeBegin");if(t&&(t=t.match(/\d+/)[0]),i&&(i=i.match(/\d+/)[0]),n.model.get("IsView")&&!n.model.get("IsVote")&&n.view==4){n.view=3;return}if(Number(t)<r.getTime()||Number(i)>r.getTime()){n.view=3;return}},renderData:function(){listVoteDetail.reset();var n=this;egov.request.getVoteDetail({data:{voteId:n.model.get("VoteId")},success:function(t){var f,i,r,e;for(this.model=new VoteModel(t),f=t.UsersVote.split(";"),f=u(f),i=JSON.parse(this.model.get("ListOpinion")),currentUserId=this.model.get("CurrentUserId"),i=n.voteDetailCount(i,currentUserId,f.length),i.IsMultiSelect=n.model.get("IsMultiSelect"),r=0;r<i.length;r++)i[r].Option={IsMultiSelect:n.model.get("IsMultiSelect"),IsPublic:n.model.get("IsPublic"),IsCommentDiff:n.model.get("IsCommentDiff"),IsViewResultImmediately:n.model.get("IsViewResultImmediately"),IsNotify:n.model.get("IsNotify")},e=new VoteDetailModel(i[r]),listVoteDetail.add(e)},error:function(){}})},voteDetailCount:function(n,t,i){for(var f,r=0;r<n.length;r++)n[r].UserIdsVote?(f=n[r].UserIdsVote.split(";"),f=u(f),n[r].TotalVote=f.length,f.includes(t.toString())&&(n[r].IsChecked=!0)):n[r].TotalVote=0;for(r=0;r<n.length;r++)n[r].MaxVote=i;return n},addVote:function(n){var t=new e({model:n,view:this.view});this.$(".list-vote-detail").append(t.render().el);this.view!=4&&this.$el.find(".progress .progress-bar").css("width",function(){return $(this).attr("aria-valuenow")+"%"})},resetVote:function(){this.$(".list-vote-detail").html("")},render:function(){var n=this,i,t,r,u;this.$el.html($.tmpl(this.template,n.model.toJSON()));i=700;n.view==4&&(i=600);n.view==3&&n.$el.find(".notifyContent").length>0&&n.$el.find(".notifyContent").hide();t=[];n.model.get("IsView")&&n.view==4&&(r="Gửi kết quả",u=n.model.get("IsVoted"),u&&(r="Xem kết quả"),t.push({text:r,className:"btn-success",click:function(){var i=listVoteDetail.where({IsChecked:!0}),t=[];if(i.forEach(function(n){t.push(n.get("VoteDetailId"))}),n.model.get("IsVoted")){n.view=3;n.$el.closest(".modal-content").find("h4.modal-title").text("Xem kết quả trưng cầu");n._viewResult();return}egov.request.checkVoteResult({data:{voteId:n.model.get("VoteId"),voteDetailIds:JSON.stringify(t)},success:function(t){t==!0?(n.view=3,n.$el.closest(".modal-content").find("h4.modal-title").text("Xem kết quả trưng cầu"),n._viewResult()):n.$el.find(".errorContent").text(t)},error:function(){}})}}));t.push({text:"Đóng",click:function(){n.$el.dialog("hide")}});var e={text:"Xem kết quả",className:"btn-success",click:function(){n.view=3;n._viewResult()}},n=this,f={width:i,height:"auto",draggable:!0,title:"Thực hiện trưng cầu",buttons:t};return n.view==3&&n.$el.find(".oppinionDiff").hide(),n.$el.dialog(f),n.renderData(),n.view==3&&n.$el.find("h4.modal-title").text("Xem kết quả trưng cầu"),n},reloadData:function(){var n=this,t=listVoteDetail.length;egov.request.getVoteDetailReload({data:{voteId:n.model.get("VoteId"),voteDetailCount:t},success:function(t){if(t.IsDiff){n.renderData();return}var i=t.List;listVoteDetail.forEach(function(n){for(var t=0;t<i.length;t++)n.get("VoteDetailId")==i[t].VoteDetailId&&n.get("TotalVote")!=i[t].TotalVote&&n.set("TotalVote",i[t].TotalVote)})},error:function(){}})},commentDiff:function(n){if(!this.model.get("IsCommentDiff"))return!1;if(n.keyCode==13&&i!=""){var t=this,i=t.$el.find(".oppinionDiff").val();egov.request.createCommentDiff({data:{voteId:t.model.get("VoteId"),commentDiff:i},success:function(n){if(n.error){$(".errorContent").text(n.content);return}listVoteDetail.reset();t.renderData();t.$el.find(".oppinionDiff").val("")},error:function(){$(".errorContent").text("Lỗi kết nối đến server")}})}},_viewResult:function(){this.render()}}),e=Backbone.View.extend({tagName:"div",template:t,events:{"click .checkbox":"chooseOpinion"},model:VoteDetailModel,initialize:function(n){this.listenTo(this.model,"add",this.render);this.listenTo(this.model,"change:IsChecked",this.renderAfterChange);this.listenTo(this.model,"change:TotalVote",this.renderAfterChange);this.listenTo(this.model,"change:Percent",this.renderAfterChange);this.listenTo(this.model,"change:UserIdsVote",this.renderAfterChange);var t=n.view;t==4&&(this.template=i);t==3&&(this.template=r)},chooseOpinion:function(n){n.preventDefault();n.stopPropagation();var t=this,i=t.model.get("IsChecked");if(t.model.get("Option").IsMultiSelect)i?t.model.set("IsChecked",!1):t.model.set("IsChecked",!0);else{if(i)return;listVoteDetail.forEach(function(n){n.get("IsChecked")==!0&&n.set("IsChecked",!1)});t.model.set("IsChecked",!0)}},render:function(){var n=this,t;return n.model.get("MaxVote")==0?n.model.set("Percent",0):(t=parseInt(parseFloat(n.model.get("TotalVote")/n.model.get("MaxVote")).toFixed(2)*100),n.model.set("Percent",t)),n.$el.addClass("row"),n.$el.html($.tmpl(n.template,n.model.toJSON())),n.renderUserInfo(),n},renderAfterChange:function(){var n=this.model.get("Percent");this.render();this.$el.find(".progress .progress-bar").css("width",function(){return n+"%"})},renderUserInfo:function(){var n=this;n.$el.find(".btnUserVote").customDropdown({css:{width:300,height:300},callback:function(){n.model.get("UserIdsVote")!=";;"&&n.model.get("UserIdsVote")?egov.request.getUserInfos({data:{userIds:n.model.get("UserIdsVote")},success:function(n){$("#ListUserVote").html($.tmpl('<li><a href="#">${UserName}<\/a><\/li>',n))},error:function(){}}):$("#ListUserVote").html("")}})},getTotalVote:function(n){var t=n.split(";");return t=u(t),t.length}}),o=function(n){n instanceof Date||(n=n.match(/\d+/)[0]);var i=new Date(Number(n)),t="";switch(i.getDay()){case 0:t="Chủ nhật";break;case 1:t="Thứ hai";break;case 2:t="Thứ ba";break;case 3:t="Thứ tư";break;case 4:t="Thứ năm";break;case 5:t="Thứ sáu";break;case 6:t="Thứ bảy"}return t+","+("0"+i.getDate()).slice(-2)+"-"+("0"+Number(i.getMonth()+1)).slice(-2)+"-"+i.getFullYear()+" "+i.getHours()+":"+("0"+i.getMinutes()).slice(-2)},f});var VoteModel=Backbone.Model.extend({defaults:function(){var n=new Date;return n.setHours(23),{VoteId:0,TimeBegin:new Date,TimeEnd:n,TimeBeginFormat:"",VoteDetailId:1,Title:"",IsMultiSelect:!0,IsPublic:!0,IsCommentDiff:!0,IsViewResultImmediately:!0,IsNotify:!0,DepartmentsView:"",UsersView:"",DepartmentsVote:"",UsersVote:"",UsersVoted:"",UserIdCreate:1,CurrentUserId:0,UsernameCreate:"",CountUserVote:0,IsNow:!1,IsVoted:!1,IsCreate:!1}}}),VoteDetailModel=Backbone.Model.extend({defaults:function(){return{VoteId:0,VoteDetailId:0,UserIdCreate:0,UserIdsVote:"",TitleDetail:"",IsChecked:!1,TotalVote:0,Percent:0,MaxVote:0,IsMultiSelect:!0,Option:{IsMultiSelect:!0,IsPublic:!0,IsCommentDiff:!0,IsViewResultImmediately:!0,IsNotify:!0}}},toggle:function(){this.save({IsChecked:!this.get("IsChecked")})},setNotCheck:function(){this.save({IsChecked:!1})}}),ListVote=Backbone.Collection.extend({model:VoteModel}),ListVoteDetail=Backbone.Collection.extend({model:VoteDetailModel,comparator:function(n){return n.get("TotalVote")},remaining:function(){return this.where({IsChecked:!1})}}),listVoteDetail=new ListVoteDetail;