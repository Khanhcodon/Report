define([],function(){"use strict";var t,n,i;return t=egov.resources.document,n=egov.models.document,i=egov.template.document,Backbone.View.extend({events:{"input #InOutCode":"_disableToolbar"},initialize:function(t){var i,r;egov.waitingImagePacket&&(i=_.find(egov.waitingImagePacket,function(n){return!n.opened}));i&&(i.opened=!0);r=new egov.models.attachment({Id:i.file.key,Name:i.file.name,Size:i.file.size,Extension:"."+i.file.name.split(".").pop(),Versions:[{Version:1,User:egov.setting.fullName+" ("+egov.setting.userName+")"}],isNew:!0});this.tab=t.tab;this.model=new n;this.scanFile=r;this.documentViewType=egov.enum.documentViewType.default;this.isInsertImagePacket=!0;this.render()},render:function(){var n=this;require([egov.template.document.insertImagePacket],function(t){n.$el.html($.tmpl(t));n._renderToolbar(!0);n._renderAttachment();n._renderForm();n._autocomplete();n.$("#InOutCode").focus()})},_renderForm:function(){var n=this;require(["htmlForm"],function(t){var r={Content:"",ContentName:"",DocumentContentDetails:Array[0],DocumentContentId:0,DocumentId:"00000000-0000-0000-0000-000000000000",FormId:0,FormTypeId:1,IsMain:!0,Version:0},i=new t({model:r,document:n,scanFile:n.scanFile,contentHTML:"<div><\/div>"});n.$("#divContent").append(i.$el);n.form=i})},_renderToolbar:function(n){var t=this;if(this.isQuickToolbar=n,t.toolbar){t.toolbar.reRender(n?egov.enum.defaultToolbar.InsertImagePacket:!1,t.model.get("DocumentPermissions"));return}require(["documentToolbar"],function(i){t.toolbar=new i({el:t.$(".toolbar"),model:t.model.get("DocumentPermissions"),document:t,defaultToolbarType:n?egov.enum.defaultToolbar.InsertImagePacket:undefined})})},_renderAttachment:function(){var n=this;require(["docAttachment"],function(t){var i=new egov.models.attachmentCollection(n.scanFile);n.model.set("Attachments",i);n.attachments=new t({hasPermission:!0,model:i,el:n.$("#wrapAttachment"),documentId:n.model.get("DocumentId")})})},_renderRelation:function(){var n=this;require(["docRelation"],function(t){var i=new egov.models.relationList(n.model.get("RelationModels"));n.model.set("Relations",i);n.relations=new t({document:n.model,hasPermission:!0,model:i,el:egov.isMobile?n.$("#tblDocRelations"):n.$("#wrapDocumentRelation")})})},isValid:function(){return this.$("#InOutCode").val()&&this.$("#Compendium").val()?!0:!1},_autocomplete:function(){var n=this,t=n.$("#InOutCode"),i=n.$("#Compendium"),r={minLength:2,source:function(n,r){$.ajax({url:"/document/FilterInOutCode/",data:{code:t.val(),compendium:i.val()},dataType:"json",type:"POST",success:function(n){r($.map(n,function(n){return{label:n.InOutCode,value:n.DocCode+" - "+n.InOutCode,compendium:n.Compendium,docCode:n.DocCode,inOutCode:n.InOutCode,documentCopyId:n.DocumentCopyId}}))}})},autoFocus:!0,autoSelectFirst:!0,select:function(r,u){t.val(u.item.value);i.val(u.item.compendium);var f=u.item.documentCopyId;n.model.set("Compendium",u.item.compendium);n.model.set("DocumentCopyId",f);egov.dataManager.getDocumentEditInfo(f,{success:function(t){if(t){if(t.error){egov.pubsub.publish(egov.events.status.error,t.error);return}n.model.set(t);n._renderToolbar();n._renderRelation()}},error:function(){egov.pubsub.publish(egov.events.status.error,egov.resources.document.openError)},complete:function(){egov.pubsub.publish(egov.events.status.destroy)}})}};t.length!==0&&(t.autocomplete(r).data("autocomplete")._renderItem=function(n,t){return n.addClass("dropdown-menu"),$("<li>").data("item.autocomplete",t).append("<a href='#'>"+t.label+"<\/a>").appendTo(n)},i.autocomplete(r).data("autocomplete")._renderItem=function(n,t){return n.addClass("dropdown-menu"),$("<li>").data("item.autocomplete",t).append("<a href='#'>"+t.compendium+"<\/a>").appendTo(n)})},_autoCompleteComment:function(){egov.dataManager.getCommonComment({success:function(n){egov.dataManager.getTemplateComments({success:function(t){t=_.pluck(t,"Content");t=_.filter(t,function(t){return n.indexOf(t)==-1});t.length>0&&(_.each(t,function(t){n.push(t)}),egov.dataManager.addCommonComment(n,!0));this.$Comment=this.$("[name='Comment']");var i=this;this.$Comment.length>0&&(i.$Comment.autocomplete({source:function(t,i){for(var f,e=egov.utilities.string.stripVietnameseChars(t.term).toLowerCase(),u=[],r=0;r<n.length;r++)f=egov.utilities.string.stripVietnameseChars(n[r]).toLowerCase(),f.indexOf(e)!=-1&&u.push(n[r]);i(u)},autoFocus:!0,autoSelectFirst:!0}).data("autocomplete")._renderItem=function(n,t){return n.addClass("dropdown-menu"),$("<li>").data("item.autocomplete",t).append("<a href='#'>"+t.value+"<\/a>").appendTo(n)})}})}})},transfer:function(n){var i=this,r,t;r=this.$("#Comment").val();t=n;require(["transfer"],function(n){egov.transferForm===undefined&&(egov.transferForm=new n);egov.transferForm.render({action:t,document:i,isQuickTransfer:!0,callback:function(){}})})},_disableToolbar:function(){this.isQuickToolbar||this._renderToolbar(!0)},RemoveDocument:function(){var n,t;n=this;t=parseInt(n.model.get("DocumentCopyId"));egov.request.removeDocument({data:{documentCopyIds:[t]},success:function(){n.tab.close()}})}})});