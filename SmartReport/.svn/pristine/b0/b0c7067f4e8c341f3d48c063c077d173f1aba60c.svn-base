define(["bmailCustomToolbar",],function(){"use strict";var n=egov.template.bmail,t=Backbone.View.extend({el:"#folderlist",$mailListWrap:$("#mailListWrap"),cache:bmail.locache,childs:[],events:{"click .mail-folder-item":"_selectFolder"},initialize:function(n){this.model=new bmail.models.folderList(n);this.render()},render:function(){var t=this,i=this.model;require([n.folderItem],function(n){t.$el.html($.tmpl(n,t.model.toJSON()))})},_selectFolder:function(n){var u=$(n.target).closest(".mail-folder-item"),f=u.attr("id"),i=this.model.detect(function(n){return n.get("id")===f}),t,r;if(i!=undefined){egov.mobile.showProcessBar();t=this;t.isSentBox=!1;r=i.get("path");bmail.request.getFolderMailList(0,r,25,!1,t.isSentBox,function(n){t._renderMailList(n)});return}},_renderMailList:function(){},changeFolderStructure:function(n){n&&this.model.get(n.id)&&this.model.get(n.id).set("isOpen",n.get("isOpen"));this.cache.setFolderList(JSON.stringify(this.model.toJSON()));bmail.makeRequest.changeFolderStructure(this.model,function(){})},getPath:function(n){var t=this.model.models.find(function(t){return t.get("id")==n});if(t)return t.get("path")},isCommonBox:function(n){var t=this.getPath(n);return t!=null?["drafts","sent","junk","trash"].indexOf(t.indexOf("/")>0?t.substr(0,t.indexOf("/")):t)>-1:!1},rebindTotalUnread:function(){_.each(bmail.views.folderlist.childs,function(n){var t=getFolderInfo(n.folderId);t&&n.model.set("totalUnread",t.unread)});console.log("folder's struct has updated!")}}),i=Backbone.View.extend({className:"mdl-list",tagName:"ul",$mailListWrap:$("#mailListWrap"),idForMailList:"withFolderId_",maillistClass:".mail-list",domId:"foldermail_",folderId:0,events:{click:"select","click .collapsableMinus":"close","click .collapsablePlus":"open"},initialize:function(n){this.parent=n.parent;this.index=n.folderIndex;this.isSentBox=n.model.isSentBox;this.initData(n.model);this.initToolbar(!0);this.setEventOfModel();this.render()},initData:function(n){var i=this,r=n.path,t=n.path.split("/").length;this.folderId=n.id;this.model=new bmail.models.folder({path:r,pathName:n.name,id:n.id,visible:n.visible,link:n.link,parentid:n.parentid,totalUnread:n.totalUnread,isPublicFolder:n.isPublicFolder,hasChildren:n.hasChildren,isOpen:0,isSentBox:n.isSentBox,perm:n.perm,className:getClassName(n.hasChildren,t,n.isOpen,n.visible,n.isPublicFolder),domId:i.domId+n.id,folderId:n.id.replace(/:/gi,""),level:t})},setEventOfModel:function(){var n=this;this.model.on("change:totalUnread",function(t,i){i>0?n.$(".mdl-badge").first().attr("data-badge",egov.mobile.getTotalUnreadLabel(i)):n.$(".mdl-badge").first().removeAttr("data-badge")})},initToolbar:function(n){var i=this,r,u,t;if(this.model.get("level")==1){var f=[],e=this.model.get("path").split("/")[0];for(this.isTextOnly=n==!0,u=bmail.customToolbar.getToolbar(e).split(","),t=0;t<u.length;t++)f.push(u[t].trim());r=f}else r=bmail.toolbarList.filter(function(n){return n.folderId==i.model.get("parentid")})[0].model;i.toolbar={folderId:this.model.get("id"),folderPath:this.model.get("path"),model:r};bmail.toolbarList.push(i.toolbar)},render:function(){var i=this,n,t;this.$el.attr("folderId",this.model.get("id"));this.$el.attr("id",this.model.get("domId"));this.$el.attr("parentId",this.model.get("parentid"));this.$el.addClass(this.model.get("className"));n=$.tmpl(bmail.templates.store.folder,i.model.toJSON());t=this.model.get("totalUnread");t>0&&n.find(".mdl-badge").attr("data-badge",egov.mobile.getTotalUnreadLabel(t));this.$el.html(n)},select:function(n){var t,i;egov.helper.destroyClickEvent(n);egov.mobile.hidePanel(n);egov.mobile.hideMainMenu();t=this;bmail.current.folder=this;bmail.current.folder.isPublicFolder=this.model.get("isPublicFolder");bmail.current.folder.folderId=this.model.get("folderId");this.hasBind?(this.mailList.folderRefresh(),this.$el.hasClass("select")?this.showMailList(n):(t.removeAllSelected(),t.addSelected(n)),egov.mobile.hideMainMenu()):(t.$mailListWrap.children().hide(),egov.pubsub.publish(egov.events.status.processing,egov.resources.common.processing),require(["bmailViewMailList"],function(i){var f,r=t.parent.cache.getLastMailList(),e,u;r&&(r=JSON.parse(r),r&&r instanceof Array&&r.length>0&&r[0].l==t.folderId&&(f=r));e=t.idForMailList+t.model.get("folderId");u=new i({folder:t,model:f,id:e,folderPath:t.model.get("path"),folderId:t.model.get("id")});t.mailList=u;t.$mailListWrap.append(u.$el);t.removeAllSelected();t.addSelected(n);$("#btnNewMail").show();u.render(f,!1,!0,function(){bmail.makeRequest.getFolderMailList(0,t.model.get("path"),firstLoadMailNumber,!1,t.isSentBox,function(n){u.reRender(n);t.parent.cache.setLastMailList(JSON.stringify(n));egov.pubsub.publish(egov.events.status.destroy)})})}),t.hasBind=!0);this.parent.cache.setLastFolderIndex(t.index);i=parseInt(t.model.get("folderId"));(!i||i>6)&&egov.mobile.setNofifyFolder(t.model.get("path"));egov.mobile.elements.mainPage.hasClass("showNotify")||egov.commonFn.event.changeTitleForMobile("bmail",t.model.get("pathName"))},changeTitleApp:function(n){egov.commonFn.event.changeTitleForMobile("bmail",n)},open:function(n){egov.helper.destroyClickEvent(n);var t=$(n.currentTarget).closest(".parentFolder");t.addClass("showChildren");this.model.set("isOpen","1");bmail.views.folderlist.changeFolderStructure(this.model)},close:function(n){egov.helper.destroyClickEvent(n);var t=$(n.currentTarget).closest(".parentFolder");t.removeClass("showChildren");this.model.set("isOpen","0");bmail.views.folderlist.changeFolderStructure(this.model)},removeAllSelected:function(){$(this.maillistClass).hide();this.parent.$(".list-group-item").removeClass("select")},addSelected:function(n){this.showMailList(n);$("#"+this.idForMailList+this.model.get("id")).show();egov.mobile.notification&&egov.mobile.notification.hideNotification();this.$el.addClass("select")},showMailList:function(n){bmail.views.main.showListMail(n);this.mailList.$el.show()},emptyFolder:function(){this.model.set("totalUnread",0)}});return t});