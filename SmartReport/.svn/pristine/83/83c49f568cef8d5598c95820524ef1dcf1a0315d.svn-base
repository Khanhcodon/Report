define(["storeTree","documentsView","treeBase","contextMenuView"],function(n,t,i){"use strict";function f(n){egov.request.getTotalOnlineRegistration({success:function(t){typeof n=="function"&&n(t)},error:function(){typeof n=="function"&&n(0)}})}function e(n){egov.request.getTotalOnlineCancel({success:function(t){typeof n=="function"&&n(t)},error:function(){typeof n=="function"&&n(0)}})}function o(n){egov.request.getTotalGeneralQuestion({success:function(t){typeof n=="function"&&n(t)},error:function(){typeof n=="function"&&n(0)}})}function s(n){egov.request.getTotalDocumentQuestion({success:function(t){typeof n=="function"&&n(t)},error:function(){typeof n=="function"&&n(0)}})}function u(n){s(function(t){t&&n.at(1).view.rebindTotal(t.total)});o(function(t){t&&n.at(0).view.rebindTotal(t.total)})}function h(n){for(var r,i=[],t=n.length-1;t>=0;t--)r={id:n[t].id,name:n[t].name,state:"in",children:null,showTotalInTreeType:3,status:0,isGetGeneral:!0,totalDocument:10},i.push(r);return i}var r=Backbone.View.extend({el:"#menu-document",documentDetail:"#document-detail",documentList:".document-list",$documentListId:$("#documentList"),nameGroupDocument:"#nameGroupDocument",rootChildren:"#menu-document",totalUnread:".totalunread",systemTree:".system-tree",rootId:0,isShowDocumentList:!1,hasFocusHome:!0,autogetNew:null,initialize:function(){egov.views.home.tree=this;this.isLoadedStoreTree=!1;this.render()},render:function(){return this._registertGlobalApi(),this._initInterval(),this.processFunctions=this.parseFunctions(egov.setting.processFunction),this.renderDocumentTree(),this},parseFunctions:function(n){var t=[];return _.each(n,function(i){if(i.parentId===0){var r=_.filter(n,function(n){return n.parentId==i.id});i.children=r;t.push(i)}}),t},reloadDocumentTree:function(n){var t,u,i,r;egov.isMobile||(t=this,n?(i=t.documentTree.model.detect(function(t){return t.get("id")===n}),r=i.get("children"),r&&r.length>0&&(u=r.pluck("id"))):u=this.documentTree.model.pluck("functionId"),egov.request.getTotalDocumentUnreadMultiFunction({data:{ids:JSON.stringify(u)},success:function(r){if(!r){egov.log(egov.events.status.error,egov.resources.treeDocument.message.error.syncData);return}r.forEach(function(r){var u;n?(i=t.documentTree.model.detect(function(t){return t.get("id")===n}),u=i.get("children").detect(function(n){return n.get("id")==r.id})):u=t.documentTree.model.detect(function(n){return n.get("id")===r.id});u&&(u.set("totalDocumentUnread",r.totalUnread),u.set("totalDocument",r.total))})}}))},reloadUnread:function(n,t,i,r){if(n||n.model instanceof egov.models.TreeModel){t=t||0;i=i||0;n.model.set("totalDocumentUnread",t);n.model.set("totalDocument",i);var u=n.model.get("parentId");u&&parseInt(u)>0&&i<=0&&n.model.get("hasTransferTheoLo")==!0&&n.$el.hide();egov.callback(r)}},renderDocumentTree:function(){var n=this;if(!this.processFunctions||this.processFunctions.length===0){egov.pubsub.publish(egov.events.status.warning,egov.resources.treeDocument.noTreeNode);return}n.model=new egov.models.TreeList(this.processFunctions);n._sortBy();n._documentTree()},_registertGlobalApi:function(){egov.pubsub.subscribe(egov.events.tree.reload,this.reloadDocumentTree,this);egov.pubsub.subscribe("tree.reloadSelected",this._reloadSelectedNode,this)},_initInterval:function(){this._interval&&clearInterval(this._interval);this._interval=setInterval(function(){egov.pubsub.publish(egov.events.tree.reload);egov.pubsub.publish("tree.reloadSelected")},12e4)},_sortBy:function(){var n=[],t=this.model.groupBy(function(n){return n.get("treeGroupOrder")});_.each(t,function(t){t=_(t).sortBy(function(n){return n.get("order")});n.push(t)});this.model=new egov.models.TreeList(_.flatten(n))},removeDocuments:function(n){var t,i;!n||n.length<=0||(typeof n=="object"||n instanceof Array||(n=[n]),this.selectedNode)&&(t=this.selectedNode.model.documentsView,n&&n.length>0&&(i=function(i){var r=t.model.select(function(t){return t.get("Selected")==!0&&!_.contains(n,t.get("DocumentCopyId"))});i&&r.length==0&&i.set("Selected",!0);t.removeDocumentByIds(n)},t.selectedNextCurrent(function(n){i(n)})),this._reloadSelectedNode(),this.reloadDocumentTree())},_documentTree:function(){var n=this;n.documentTree=new i({el:n.rootChildren,model:n.model,isDocumentTree:!0,open:function(t){n._openDocumentTreeNode(t)},select:function(t){n._renderDocumentsView(t,function(){if(t.model.get("isOpen")){var i=t.model.get("children");i&&i.length>0}else t.$el.find(".pull-left:first").removeClass("open closed"),t.$el.find("a.list-group-item:first").attr("data-open","false"),t.$("ul.collapse:first").removeClass("in"),t.model.get("totalDocument")>0&&t.model.get("parentId")<=0&&(t.model.set("isOpen",!1),t.$el.find(".pull-left:first").addClass("closed"));n.isAuto=!1;n.hasFocusHome=!0;n.documentTree.updateToCache();egov.pubsub.publish(egov.events.status.destroy)},n.isAuto)},contextmenu:function(t){n._renderDocumentsView(t,function(){if(t.model.get("isOpen")){var i=t.model.get("children");i&&i.length>0}else t.$el.find(".pull-left:first").removeClass("open closed"),t.$el.find("a.list-group-item:first").attr("data-open","false"),t.$("ul.collapse:first").removeClass("in"),t.model.get("totalDocument")>0&&t.model.get("parentId")<=0&&(t.model.set("isOpen",!1),t.$el.find(".pull-left:first").addClass("closed"));n.documentTree.updateToCache()})},close:function(){n.documentTree.updateToCache()}});egov.pubsub.publish("tree.reloadSelected");egov.pubsub.publish(egov.events.tree.reload)},_renderDocumentsView:function(n,i,r){var u=this;u.selectedNode=n;egov.isMobile||this.hasFocusHome&&egov.views.home.tab.rootTab.active();n.model.documentsView?n.model.documentsView.reloadDocuments(i,r):n.model.documentsView=new t({node:n,tree:u,isStoreTree:!1,treeCallback:i})},_selectNode:function(n){var i=this;i.selectedNode=n;n.model.documentsView?n.model.documentsView.$el.show():n.model.documentsView=new t({node:n,tree:i,isStoreTree:!1})},_reloadSelectedNode:function(){var n=this.documentTree.selectedNode;if(!n){if(!this.model||this.model.length<=0)return;n=this.model.findWhere({isSelected:!0});n||(n=this.model.at(0))}this.hasFocusHome=!1;this.isAuto=!0;n.view.select()},destroyAutoGetDocNews:function(){this.autogetNew&&window.clearInterval(this.autogetNew)},_openDocumentTreeNode:function(n){if(!n.model.get("isLoadChildren")){var i,u,t,r;i=this;u=$('<img src="../Content/Images/ajax-loader.gif" class="loading" width="20" height="20" style="position:fixed; z-index:100; " />');r=n.model.get("functionId");t=n.$el.find("#child"+r);t.append(u);egov.request.getDocumentTree({data:{id:r},success:function(r){n.model.set("isLoadChildren",!0);t.find(".loading").remove();r&&r.length>0?(n.$children.empty(),i._renderChildren(n,r)):n.model.set("isOpen",!1);i.documentTree.updateToCache()},error:function(){t.find(".loading").remove()}})}},_renderChildren:function(n,t){var r,e,i,f,u;if(n.model.get("totalDocument")<=0&&n.model.get("hasTransferTheoLo")==!0){n.model.set("isOpen",!1);n.$el.find(".pull-left:first").removeClass("open closed");n.$el.find("a.list-group-item:first").attr("data-open","false");n.$("ul.collapse:first").removeClass("in");return}for(t=t.sort(function(n,t){return t.order==n.order?t.name>=n.name?-1:1:t.order>n.order?-1:1}),r=new egov.models.TreeList([]),e=0,f=t.length,i=0;i<f;i++)t[i].id=t[i].functionId+t[i].params,t[i].isLoadChildren=!1,u=new egov.models.TreeModel(t[i]),n.add(u,!1),r.add(u);n.model.set("children",r);this.reloadDocumentTree(n.model.get("id"))},_rebindChildrenView:function(n,t,i){var h,c,r,l,f,a,e,s,o,v,y,p,w,u;for(t=t.sort(function(n,t){return t.order===n.order?t.name>=n.name?-1:1:t.order>n.order?-1:1}),h=[],c=0,l=t.length,a=n.model&&n.model.documentsView&&n.model.documentsView.model?n.model.documentsView.model.toJSON():[],r=0;r<l;r++){if(a.length>0&&(e=t[r].params?JSON.parse(t[r].params):null,e&&e.length>0)){for(s=0,o=a;s<e.length&&o.length>0;)v=e[s].Value,y=e[s].CompareName,o=_.filter(o,function(n){return n[y]==v}),s++;p=0;o.length>0&&(p=_.filter(o,function(n){return n.IsViewed==!1}).length)}t[r].id=t[r].functionId+t[r].params;t[r].isLoadChildren=!1;t[r].totalDocument<=0&&c++;w=t[r].params+"_"+t[r].functionId;u=n.nodeChildren[w];u?(u.model.get("totalDocument")<=0?u.model.get("hasTransferTheoLo")==!0&&(u.$el.hide(),this._selectNode(n)):(u.$el.show(),u.$el.find(".pull-left").removeClass("open closed"),u.$el.find("a.list-group-item").attr("data-open","false"),u.$("ul.collapse:first").removeClass("in")),t[r]=u.model.toJSON()):i&&(f=new egov.models.TreeModel(t[r]),n.add(f,!1),f.get("totalDocument")<=0&&f.get("hasTransferTheoLo")==!0&&(f.view.$el.hide(),this._selectNode(n)),t[r]=f.toJSON());h.push(t[r])}n.model.set("children",h);n.model.get("hasTransferTheoLo")==!0&&(l==c?(n.$el.find(".pull-left:first").removeClass("open closed"),n.$el.find("a.list-group-item:first").attr("data-open","false"),n.$("ul.collapse:first").removeClass("in")):(n.$el.find(".pull-left:first").removeClass("open closed").addClass("open"),n.$el.find("a.list-group-item:first").attr("data-open","true"),n.$("ul.collapse:first").addClass("in")))},renderStoreTree:function(){var i=this;this.storeTree=new n({eGovTree:this,callback:function(n){(i.destroyAutoGetDocNews(),i._destroyReloadOnlineRegistration(),egov.isMobile||egov.views.home.tab.rootTab.active(),n.model.get("isStorePrivateRoot")||n.model.get("isStoreShareRoot"))||(n.model.documentsView?n.model.documentsView.reloadDocuments():n.model.documentsView=new t({node:n,tree:i,isStoreTree:!0}),egov.currentTree.documentViews=n.model.documentsView)}})},renderFAQTree:function(){var n=this,n=this;$("#questionNode").show();egov.dataManager.getNodeQuestion({success:function(t){t&&n._faqTree(t);n.isLoadedFAQTree=!0},error:function(){egov.pubsub.publish(egov.events.status.error,egov.resources.treeStore.message.error.selectStore)}});egov.views.isLoadedFAQTree=!0},_faqTree:function(n){var r=this,e=h(n.documentNode),o=[{id:"generalFAQTree",name:egov.resources.tree.question.general,generalFAQTree:!0,state:"in",children:null,showTotalInTreeType:3,status:0,isGetGeneral:!0,totalDocument:10},{id:"documentFAQTree",name:egov.resources.tree.question.document,documentFAQTree:!0,state:"in",children:e,showTotalInTreeType:3,status:0,totalDocument:10}],f=new egov.models.QuestionTreeList(o);this.faqTree=new i({el:"#faqList",model:f,isDocumentTree:!1,isFAQ:!0,open:function(){r.destroyAutoGetDocNews()},select:function(n){if(egov.isMobile||egov.views.home.tab.rootTab.active(),n.model.documentsView)n.model.documentsView.reloadQuestionList();else{var i=n.model.toJSON();n.model.documentsView=new t({node:n,tree:r,isQuestionTree:!0,docfieldIds:Number(i.id)||null})}u(r.faqTree.model);egov.currentTree.documentViews=n.model.documentsView}});window.setTimeout(function(){u(f)},1e3)},renderOnlineRegistration:function(){var n=this;if(egov.setting&&egov.setting.onlineRegistration&&egov.setting.onlineRegistration.Active){n.isRenderOnlineRegistrationFirst=!0;var u=new egov.models.TreeList([{functionId:"onlineRegistration_0",parentId:0,name:egov.setting.onlineRegistration.Name,paramId:0,state:"closed",children:[],isLoadChildren:!1,showTotalInTreeType:3,isOnlineRegistration:!0,isOnlineRegistrationChildren:!1,nodeModel:null,totalDocument:0},{functionId:"onlineRegistration_1",parentId:0,name:"Hồ sơ đăng ký bị hủy",paramId:0,state:"closed",children:[],isLoadChildren:!1,showTotalInTreeType:3,isOnlineRegistration:!0,isOnlineRegistrationChildren:!1,nodeModel:null,totalDocument:0}]),r=function(i,r){n.destroyAutoGetDocNews();n.hasFocusHome&&!egov.isMobile&&egov.views.home.tab.rootTab.active();var u=2,f=i.model.toJSON().functionId;f=="onlineRegistration_1"||i.model.toJSON().parentId=="onlineRegistration_1"?u=8:(f=="onlineRegistration_0"||i.model.toJSON().parentId=="onlineRegistration_0")&&(u=2);i.model.documentsView=new t({node:i,tree:n,isOnlineRegistration:!0,DocumentOnlineType:u,treeCallback:function(t){var f,u,t;if(n.isRenderOnlineRegistrationFirst){n.isRenderOnlineRegistrationFirst=!1;egov.callback(r,i);return}if(i.rebindTotal(t),i.model.get("isOnlineRegistrationChildren")==!1&&i.model.get("isOpen")==!0&&_.isNull(i.nodeChildren)){f=i.model.documentsView.model.toJSON();for(u in i.nodeChildren)t=_.filter(f,function(n){return n.DoctypeId==u}).length,t>0?i.nodeChildren[u].model.view.rebindTotal(t):i.nodeChildren[u].model.view.remove()}egov.callback(r,i)}});egov.currentTree.documentViews=i.model.documentsView;n._autoReloadOnlineRegistration();egov.pubsub.publish(egov.events.status.destroy)},o=function(n){var i,f,e;if(n.model.set("isLoadChildren",!0),n&&n.model&&n.model.documentsView&&n.model.documentsView.model&&n.model.documentsView.model.length>0){var u=n.model.documentsView.model.toJSON(),t=[],r=[];if(u.forEach(function(n){if(n.Doctype){var i=n.Doctype,u=!1,f={DocTypeName:i.DocTypeName,DoctypeId:i.DoctypeId};r.length>0&&(u=_.contains(r,i.DoctypeId));u||(t.push(f),r.push(i.DoctypeId))}}),t&&t.length>0)for(i=0;i<t.length;i++)f=_.filter(u,function(n){return n.DoctypeId==t[i].DoctypeId}).length,e=new egov.models.TreeModel({functionId:t[i].DoctypeId,parentId:0,state:"",name:t[i].DocTypeName,totalDocument:f,isLoadChildren:!1,showTotalInTreeType:3,isOnlineRegistration:!0,isOnlineRegistrationChildren:!0}),n.add(e)}};n.onlineRegistrationTree=new i({el:"#onlineRegistration",model:u,isDocumentTree:!1,isOnlineRegistration:!0,select:function(n){r(n)},open:function(n){n.model.get("isLoadChildren")!=!0&&n.model.get("isOnlineRegistrationChildren")!=!0&&(n&&n.model&&n.model.documentsView&&n.model.documentsView.model&&n.model.documentsView.model.length>0?o(n):r(n,function(n){n&&n.model.view.open()}))}});window.setTimeout(function(){f(function(t){n.onlineRegistrationTree&&t&&n.onlineRegistrationTree.model.at(0).view.rebindTotal(t)});e(function(t){n.onlineRegistrationTree&&t&&n.onlineRegistrationTree.model.at(1).view.rebindTotal(t)})},1e3)}},reloadOnlineRegistration:function(n){this.onlineRegistrationTree&&this.onlineRegistrationTree.selectedNode.view.select();egov.callback(n)},_autoReloadOnlineRegistration:function(){if(!egov.isMobile){this._destroyReloadOnlineRegistration();var n=this;this.autoReloadOnlineRegistration=window.setInterval(function(){n.hasFocusHome=!1;n.reloadOnlineRegistration();n.hasFocusHome=!0},2e4)}},_destroyReloadOnlineRegistration:function(){this.autoReloadOnlineRegistration&&window.clearInterval(this.autoReloadOnlineRegistration)}});return Array.prototype.remove=function(n){var t=this.indexOf(n);return t!=-1?this.splice(t,1):!1},window.eGovTree=r,r});