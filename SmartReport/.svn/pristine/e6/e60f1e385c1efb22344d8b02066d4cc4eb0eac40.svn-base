function getVNDay(n){switch(n.getDay()){case 1:return getResource("egov.resources.time.mon");case 2:return getResource("egov.resources.time.tue");case 3:return getResource("egov.resources.time.wed");case 4:return getResource("egov.resources.time.thi");case 5:return getResource("egov.resources.time.fri");case 6:return getResource("egov.resources.time.sat");default:return getResource("egov.resources.time.sun")}}function playAudio(n){var t,i;try{t=this;t.isPlayAudio||(n||(n="../Content/Sound/notify.wav"),i=new Audio(n),i.play(),t.isPlayAudio=!0,window.setTimeout(function(){t.isPlayAudio=!1},t.timeShowSoundNotify))}catch(r){}}function getNotificationTime(n){var t;if(n==null||n=="")return"";regexUtcDate.test(n)||n instanceof Date?regexUtcDate.test(n)?(t=n.split(/[^0-9]/),n=new Date(t[0],t[1]-1,t[2],t[3],t[4],t[5])):n=new Date(n):n=new Date(n);var i=new Date,r=(i.getTime()-n.getTime())/1e3,u=Math.floor(r/86400);return u<0?egov.resources.time.justnow:u===0&&n.getDate()===i.getDate()?r<120?String.format(egov.resources.time.minbefore,1):r<3600?String.format(egov.resources.time.minbefore,Math.floor(r/60)):n.format("HH:mm"):i.getDate()-n.getDate()==1&&i.getMonth()==n.getMonth()?egov.resources.time.yesterday+", "+n.format("HH:mm"):n.weekOfYear()===i.weekOfYear()?n.format("HH:mm")+", "+getVNDay(n):n.getFullYear()===i.getFullYear()?n.format("HH:mm dd/MM"):n.format("HH:mm dd/MM/yyyy")}function callbackfunc(n){if(n){n=JSON.parse(n);var t=n.notifyId,i=n.type;i==1?eGovNotify.openNotifyById(t):i==2&&bmailNotify.openNotifyById(t);i==3&&chatNotify.openNotifyById(t)}}function getBase64Image(n){n||window.external.CB_SetBase64Avatar({account:n,base64Image:""});var t="";$.ajax({url:"/Notification/GetBase64FromImageUrl",type:"GET",data:{account:n},success:function(n){t=n},error:function(){},complete:function(){var i={account:n,base64Image:t};window.external.CB_SetBase64Avatar(i)}})}var regexUtcDate=/\d{4}-[0-1]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-6]\d$/,isDesktopApp=!1;try{isDesktopApp=typeof window.external.CB_ShowNotify=="function"}catch(e){console.log(e)}(function(n,t,i){"use strict";if(typeof n===undefined)throw"Chưa có thư viện jquery.";if(typeof i===undefined)throw"Chưa có thư viện backbone.";egov.notifyType={eGov:1,mail:2,chat:3,calendar:4};var r=egov.notifyType,u=document.title,o=i.Model.extend({defaults:{NotificationId:0,NotificationType:0,Title:"",Content:"",SenderAvatar:"",SenderUserName:"",SenderFullName:"",Date:"",DateFormat:"",ReceiveDate:"",ViewdDate:"",IsViewed:!1,DocumentCopyId:0,MailId:0,FolderId:0,ChatId:"",ChatterJid:"",messageId:""}}),s=i.Collection.extend({model:o}),f=i.View.extend({icon:"",hasAlert:!1,hasAlertNotify:!1,useCache:!0,oneOnly:!1,notificationManager:undefined,currentNotify:undefined,listAlertNotify:[],unreads:0,lastId:0,notifyUrl:{gets:"",setViewed:"",hideNotify:"",addNotify:""},events:{"click .btnCloseAll":"closeAll"},initialize:function(n){return this.el=n.el,this.notifyUrl=n.notifyUrl,this.icon=n.icon||this.icon,this.hasAlert=n.hasAlert||this.hasAlert,this.useCache=n.useCache||this.useCache,this.oneOnly=n.oneOnly||this.oneOnly,this.type=n.type||r.eGov,this.init(),this.initNotificationManager(),this._bindEvent(),this},init:function(){this.$el.html(n.tmpl(c,{icon:this.icon}));var t=this.getFromCache();this.model=new s(t);this._eventProps();this.render(!1);this.getNotificationsFromServer();this.type==2&&this.getMailNotifications()},getFromCache:function(){var n=[],t;if(this.useCache&&window.localStorage&&(t=localStorage.getItem(this.el),t))try{n=JSON.parse(hashBase64.decode(t));n&&(n=n.filter(function(){return n.UserId==currentUserId}));n.length>0&&(this.lastId=n[n.length-1].NotificationId)}catch(i){}return n},saveLocache:function(){if(this.useCache&&window.localStorage){localStorage.removeItem(this.el);this.model.models=this.model.models.sort(function(n,t){return n.get("NotificationId")>t.get("NotificationId")});var n=hashBase64.encode(JSON.stringify(this.model.models));localStorage.setItem(this.el,n)}},_bindEvent:function(){var t=this;n(window).bind("beforeunload",function(){t._hideAlertNotifies()});this.$el.hover(function(){t._hideAlertNotifies();t.setViewAll();t.checkNotEmptyData()&&t.refreshNotifyTime()})},_hideAlertNotifies:function(){this.listAlertNotify&&t.each(this.listAlertNotify,function(n){n.close()})},_eventProps:function(){var n=this;this.model.on("add",function(t){n.bindItem(t,!0);n._showNumberNotify()});this.model.on("remove",function(t){t.get("IsViewed")||(n.unreads--,n._showNumberNotify());n.saveLocache();n.hideNotify(t.get("NotificationId"))})},getNotificationsFromServer:function(){var i=this,t=[];n.ajax({url:String.format(this.notifyUrl.gets,this.type,this.lastId),type:"GET",dataType:"JSON",success:function(n){t=n},error:function(){},complete:function(){for(var n=0;n<t.length;n++)i.addToModel(t[n],!0)}})},getMailNotifications:function(){var i=this,t=[];n.ajax({url:"/Notification/GetLastestMails",type:"GET",dataType:"JSON",success:function(n){t=n},error:function(){},complete:function(){for(var n=0;n<t.length;n++)i.addToModel(t[n],!0)}})},render:function(t){var i=this;this.model.length>0&&(n.each(this.model.models,function(){i.bindItem(this,t)}),this._showNumberNotify())},bindItem:function(n,t){var u=this,f,i=new h({model:n,id:"notify_"+n.get("NotificationId"),className:"notify_"+this.type,type:this.type,parent:this}),r,e,o;f=!n.get("IsViewed");f&&this.unreads++;r=this.$(".notification");u.oneOnly?(e="u_"+n.get("SenderUserName").split("@")[0],o=r.children("."+e),o.length>0&&o.remove(),i.$el.addClass(e),r.prepend(i.$el)):r.prepend(i.$el);t&&f&&this.alertNotify(i.model,function(){u.openNotifyById(i.model.get("NotificationId"));u._chatSetViewChatter(i.model.get("ChatterJid"))})},renderEmptyItems:function(){var n='<li class="notify-empty"><b>'+this._getMessageNotifyEmpty()+"<\/b><\/li>";this.$(".notification").empty().append(n)},addToModel:function(t,i){var u=this,r;if(!i&&t.NotificationType!=1&&(n.ajax({url:"/Notification/AddNotify",type:"POST",data:JSON.stringify(t),contentType:"application/json"}),t.IsNewChat&&u.oneOnly&&(r=this.model.find(function(n){return n.get("ChatterJid")==t.ChatterJid}),r&&(r.get("IsViewed")&&(this.unreads++,this._showNumberNotify(),r.set("ViewdDate",""),r.set("IsViewed",!1)),t.Title&&t.Title.length>0&&(r.set("Title",t.Title),r.set("SenderFullName",t.Title)),r.set("Date",t.Date),r.set("SenderAvatar",t.SenderAvatar),r.set("SenderUserName",t.SenderUserName),r.set("ReceiveDate",t.Date),r.set("Content",t.Content),this.hasAlert)))){this.alertNotify(r,function(){mainApps.openApp("chat",function(){window.focus();currentApp.btalk&&currentApp.btalk.APPVIEW&&(currentApp.btalk.APPVIEW.notificationClick({chatterJid:t.ChatterJid}),u._chatSetViewChatter(t.ChatterJid))})});return}t.Content==""&&(t.Content=t.Title);u.type==2&&t.FolderLocation=="inbox"&&(t.FolderLocation="");this.model.add(t);this.saveLocache()},initNotificationManager:function(){var n=this,t;this.hasAlert&&(this.notificationManager=window.Notification||window.mozNotification||window.webkitNotification,this.notificationManager&&(t=this.notificationManager.permission,t=="default"?this.notificationManager.requestPermission(function(t){n.hasAlertNotify=n.notificationManager.permission!==t}):n.hasAlertNotify=t=="granted"))},_showNumberNotify:function(){var n=this.unreads;n>0?this.$(".notify-count").text(n>99?"99+":n).addClass("notify-count-avaiable").attr("data-count",n):this.$(".notify-count").text("").attr("data-count",0)},setViewAll:function(){var r=this,i,t;if(this.unreads>0){for(i=this.model.models.filter(function(n){return n.get("IsViewed")==!1}),t=0;t<i.length;t++)i[t].set("IsViewed",!0);this.saveLocache();n.ajax({url:r.notifyUrl.setViewed+r.type,type:"POST",dataType:"JSON"})}else this.$(".unview").removeClass("unview");this.unreads=0;this._showNumberNotify()},setCurrentChatterJId:function(n){this.type==3&&(this.chatterjId=n,this._closeChatAlert(n),this._chatSetViewChatter(n))},_chatSetViewChatter:function(t){var i=this.model.find(function(n){return n.get("ChatterJid")==t}),r;i&&!i.get("IsViewed")&&(r=this,n.ajax({url:"/Notification/SetChatView?chatterJId="+t,type:"POST",dataType:"JSON",success:function(n){n.success&&(i.view.$el.children("a").removeClass("unview"),r.unreads--,r._showNumberNotify())}}))},refreshNotifyTime:function(){n.each(this.model.models,function(){this.set("DateFormat",new Date)})},checkNotEmptyData:function(){var n=!1;return n=this.model.length>0,n?(this.$(".headerrow").removeClass("hidden"),this.$(".notification .notify-empty").remove()):(this.$(".headerrow").addClass("hidden"),this.renderEmptyItems()),n},hideNotify:function(t){t!=0&&n.ajax({url:this.notifyUrl.hideNotify+t,type:"POST",dataType:"JSON"})},alertNotify:function(n,t){var i,u,o,f,e,h,c;if(n!==undefined){if(console.log(n),isDesktopApp){i=this;u=n.get("SenderUserName");u=u.split("@")[0];try{o=[{info:{title:n.get("Title"),content:n.get("Content"),account:u,avatar:n.get("SenderAvatar"),fullname:n.get("SenderFullName"),chaterJId:n.get("ChatterJid"),duration:i.type==3?5:0,type:i.type},callback:"callbackfunc",callbackdata:{notifyId:n.get("NotificationId"),type:i.type}}];window.external.CB_ShowNotify(JSON.stringify(o))}catch(l){isDesktopApp=!1;console.log(l)}return}if(this.hasAlertNotify){var i=this,r=null,s=n.get("ChatterJid");this.oneOnly&&this._closeChatAlert(s);f="";e=this._getTitleAlert();this._flashTitleBar(e);h=n.get("SenderFullName")+"\r\n"+n.get("Content")+"\r\n"+f;c=n.get("FolderLocation");i.type==2&&(h+="\r\n"+c);r=new this.notificationManager(e,{body:n.get("SenderFullName")+"\r\n"+n.get("Content")+"\r\n"+f,icon:n.get("SenderAvatar")});playAudio();r.chatterjId=s;typeof t=="function"&&(r.onclick=function(){r.close();t()});this.listAlertNotify.push(r)}}},_closeChatAlert:function(n){n&&(notify=this.listAlertNotify.filter(function(t){return t.chatterjId=n})[0],notify&&(this.listAlertNotify.splice(this.listAlertNotify.indexOf(notify),1),notify.close()))},_flashTitleBar:function(t){var i=this;this.flashTitleBarTimmer=window.setInterval(function(){document.title=document.title==u?t:u;n(window.currentApp).on("click",function(){clearInterval(i.flashTitleBarTimmer);document.title=u})},1e3)},_getMessageNotifyEmpty:function(){var n=null;switch(this.type){case r.eGov:n=egov.resources.notify.nodocumentnotify;break;case r.mail:n=egov.resources.notify.nomailnotify;break;case r.chat:n=egov.resources.notify.nochatnotify}return n},_getStringOpenAll:function(){var n=null;switch(this.type){case r.eGov:n=egov.resources.openAllDocument;break;case r.mail:n=egov.resources.openAllMail;break;case r.chat:n=egov.resources.openAllChat}return n},_getTitleAlert:function(){var n=null;switch(this.type){case r.eGov:n=egov.resources.main.haveNewDocument;break;case r.mail:n=egov.resources.main.haveNewMail;break;case r.chat:n=egov.resources.main.haveNewChat}return n},_getPropKey:function(){var n=null;switch(this.type){case r.eGov:n="DocumentCopyId";break;case r.mail:n="MailId";break;case r.chat:n="ChatId"}return n},openNotifyById:function(n){var i=this.model.select(function(t){return t.get("NotificationId")==n});if(i&&i.length>0){var u=this._getPropKey(),r=i[0],t=r.get(u);r.view.open();this.arrAlertNotify&&t&&this.arrAlertNotify[t]&&(this.arrAlertNotify[t].close(),delete this.arrAlertNotify[t])}},removeModelById:function(n){var t=this.model.select(function(t){return t.get("DocumentCopyId")==n});t&&t.length>0&&(t=t[0],t.view._removeView())},setAlert:function(n){this.hasAlertNotify=n},openAll:function(){!this.model||this.model.length<=0||(this.model.at(0).view.open(this.model.length===1),this.openAll())},closeAll:function(){if(this.model&&!(this.model.length<=0)){var t=this,r=t.$(".notification").children().first(),i=function(n){n&&n.length>0&&n.slideUp(50,function(){i(n.next())})};i(r);n.ajax({url:"/Notification/HideAllNotify?type="+this.type,type:"POST",success:function(n){n&&(t.model=new s([]),t.checkNotEmptyData(),t.saveLocache())}})}}}),h=i.View.extend({tagName:"li",type:0,events:{"click .open-notify":"open","click .close-notify":"close"},initialize:function(n){var t,i;return this.parent=n.parent,this.type=n.type,t=this.model.get("SenderAvatar"),t||(i=this.model.get("SenderUserName").split("@")[0],t=String.format(egov.resources.avatar.path,i),this.model.set("SenderAvatar",t)),this.render(),this._eventProps(),this.model.set("DateFormat",new Date),this.model.view=this,this},render:function(){this.$el.html(this._parseHtml(this.model))},_eventProps:function(){var n=this;this.model.on("change:DateFormat",function(){n.$(".notify-date").text(getNotificationTime(n.model.get("ReceiveDate")))});this.model.on("change:Content",function(){n.$(".lblContent").text(n.model.get("Content"))});this.model.on("change:IsViewed",function(){n.model.get("IsViewed")||n.$el.children("a").addClass("unview")});this.model.on("change:SenderAvatar",function(){n.$(".img-circle").attr("src",n.model.get("SenderAvatar"))});this.model.on("change:Title",function(){n.$(".notify-usersend").text(n.model.get("Title"));n.$("a.open-notify").attr("title",n.model.get("Title")+" - "+n.model.get("SenderUserName"))})},open:function(){window.focus();var n=this.type;this.remove();switch(n){case r.eGov:this._openDocument(!0);break;case r.mail:this._openMail();break;case r.chat:this._openChat();break;case r.calendar:break;default:console.log("Notification type not exist!.")}},close:function(n){n&&(n.preventDefault?n.preventDefault():n.returnValue=!1,n.stopPropagation());this.remove()},_parseHtml:function(t){return t?(t instanceof o&&(t=t.toJSON()),t.defaultAvatar="'../../AvatarProfile/noavatar.jpg'",n.tmpl(l,t)):null},_openDocument:function(t){var i=this,r=this.model.get("DocumentCopyId");(t==null||t===undefined)&&(t=!0);mainApps.openApp("documents",function(){var u,f;try{u=currentApp.egov;navigator.isMobile?(u.views&&u.views.home&&u.views.home.tab&&u.views.home.tab.removeDocument(),u.require(["tabView"],function(n){var t=new n({model:{id:r,name:i.model.get("title"),title:i.model.get("title"),href:"tabDocument_"+r}})})):u.views.home.tab.openDocument(r,i.model.get("title"),t)}catch(e){f={DocumentCopyId:r,title:i.model.get("title")};n.cookie("documentNotify",JSON.stringify(f),{expires:1,domain:window.document.domain,path:"/",secure:!0})}})},_openMail:function(){var n=this;mainApps.openApp("bmail",function(){currentApp.readNewMail(n.model.get("MailId"),n.model.get("FolderId"))})},_openChat:function(){var t=this,n=t.model.get("ChatterJid");this.parent.setCurrentChatterJId(n);mainApps.openApp("chat",function(){currentApp.btalk&&currentApp.btalk.APPVIEW&&currentApp.btalk.APPVIEW.notificationClick({chatterJid:n})})},_removeView:function(){this.$el.remove();this.parent.model.remove(this.model)},_closeAlertNotify:function(){if(this.parent&&this.parent.arrAlertNotify){var n=this.parent,t=n._getPropKey();n.arrAlertNotify[this.model.get(t)]&&(n.arrAlertNotify[this.model.get(t)].close(),delete n.arrAlertNotify[this.model.get(t)])}},remove:function(){this.type!=3&&this._removeView();this._closeAlertNotify()}}),c='<a href="#" class="ripple-ef dropdown-toggle" data-toggle="dropdown"><img src="${icon}" /><span class="notify-count" data-count="0"><\/span><\/a><div class="dropdown-menu" role="menu"><div class="headerrow text-right hidden"><a href="#" class="btnCloseAll">Đóng tất cả<\/a><\/div><ul class="notification"><\/ul><\/div>',l='<a href="#" class="open-notify{{if IsViewed == false}} unview{{/if}}" title="{{if SenderFullName != null}}${SenderFullName} -{{/if}} ${SenderUserName}">    <div class="col-xs-2 col-md-2 col-sm-3">         <img class="img-circle" src="${SenderAvatar}" onerror="this.src=${defaultAvatar}">    <\/div>    <div class="col-xs-14 col-md-14 col-sm-13 textalert">         <div class="col-xs-15 col-md-15 col-sm-15" style="padding:0px">            <div class="notify-usersend wraptext">${SenderFullName}<\/div>            <div class="notify-content wraptext lblContent">${Content}<\/div>            <div class="row"><div class="col-sm-8"><span class="notify-date">${DateFormat}<\/span><\/div>            <div class="col-sm-8"><div class="full-width text-right wraptext notify-location">${FolderLocation}<\/div><\/div><\/div>         <\/div>       <div class="close-notify col-xs-1 col-md-1 col-sm-1">X<\/div>    <\/div><\/a>',e={gets:"/Notification/GetsByType?type={0}&lastId={1}",setViewed:"/Notification/SetViewed?type=",hideNotify:"/Notification/HideNotify/",addNotify:"/Notification/AddNotify"};window.bmailNotify=undefined;window.eGovNotify=undefined;window.chatNotify=undefined;n.ajax({url:"/Notification/GetConfig",type:"GET",success:function(n){if(n){var t=JSON.parse(n);t.DocumentActived&&(window.eGovNotify=new f({el:".div-eGov-notify",type:r.eGov,notifyUrl:e,icon:"../Content/bkav.egov/icon egov/egov-01.png",oneOnly:!1,hasAlert:!0,useCache:!0}));t.MailActived&&(window.bmailNotify=new f({el:".div-bmail-notify",type:r.mail,notifyUrl:e,icon:"../Content/bkav.egov/icon egov/egov-11.png",oneOnly:!1,hasAlert:!0,useCache:!0}));t.ChatActived&&(window.chatNotify=new f({el:".div-chat-notify",type:r.chat,notifyUrl:e,icon:"../Content/bkav.egov/icon egov/egov-10.png",oneOnly:!0,hasAlert:!0,useCache:!0}))}}})})(window.jQuery,window._,window.Backbone,window.notify);