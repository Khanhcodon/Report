define(function(){"use strict";return Backbone.View.extend({editFieldClass:"field-edit",editButtonId:"editPrint",printButtonId:"printContent",saveButtonId:"savePrint",initialize:function(n){if(this.docCopyId=n.docCopyId,this.docId=n.docId,this.paperAddIds=n.paperAddIds?n.paperAddIds:"",this.feeAddIds=n.feeAddIds?n.feeAddIds:"",this.suppId=n.suppId||0,this.displayPreview=n.displayPreview,this.printId=n.printId?n.printId:0,this.commonTemplate=n.commonTemplate?n.commonTemplate:0,this.displayPreview){this.open();return}this._print()},events:{"click #quickPrint":"_quickPrint","click #printContent":"_printOnClient","click .btn-close":"_close"},_quickPrint:function(){var n,t,i;n=parseInt(this.$(".printerId").val());t=this.$(".copies").val();i=this.$(".landscape").val();egov.setting.userSetting.PrinterId!==n&&(egov.setting.userSetting.PrinterId=n,egov.request.setUserConfig({data:{PrinterId:n}}));this._print(n,t,i)},_close:function(){this.$el.dialog("destroy")},_print:function(n,t,i){var r=this;egov.request.quickPrint({data:{docCopyIds:JSON.stringify(r.docCopyId),templateId:r.printId?r.printId:0,printerId:n?n:0,copies:t?t:1,landscape:i==!1?i:!0,commonTemplate:r.commonTemplate},success:function(n){if(n.error){egov.pubsub.publish(egov.events.status.error,egov.resources.document.print.error+n.message);return}egov.pubsub.publish(egov.events.status.success,egov.resources.document.print.success+n.printerName)},error:function(){egov.pubsub.publish(egov.events.status.error,egov.resources.document.print.error)}})},_getPrinters:function(n){var t=this;egov.request.getPrinters({success:function(t){egov.printers=t;egov.callback(n)}})},getPrints:function(n){var i=this,t;if(i.docCopyId==null)return[];t={};egov.request.getPrints({data:{docCopyId:i.docCopyId},success:function(i){for(var u=JSON.parse(i.success),f=u.length,r=0;r<f;r++)t[u[r].TemplateId]={name:u[r].Name,icon:"print"};egov.callback(n,t)}})},open:function(){var n,f,t,i,e,r,u;n=this;f=egov.views.base.dialog;t={width:"95%",height:550,title:"eGov Printer",draggable:!0};n.$el.addClass("printDialog");egov.log(JSON.stringify(n.docCopyId));e={id:n.printId,docCopyIds:JSON.stringify(n.docCopyId),suppId:n.suppId};r=$("<div class='col-md-3 printLeftPanel' style='display:none'><\/div>").appendTo(n.$el);u=$("<div class='col-md-16 printRightPanel' style='padding-right:0;'><\/div>").appendTo(n.$el);i=function(){n.$el.dialog(t);require([egov.template.document.printLeftPanel],function(i){r.html($.tmpl(i,{printers:egov.printers}));var f="/Print/PreviewPrint?docCopyIds="+JSON.stringify(n.docCopyId)+"&templateId="+(n.printId?n.printId:0)+"&suppId="+n.suppId;u.html('<embed id="pdfviewer" width="100%" height="510px" name="plugin" src="'+f+'" type="application/pdf" internalinstanceid="224">');n.$el.dialog(t)})};egov.printers?i():n._getPrinters(function(){i()})},edit:function(){var n=this,t=$("."+n.editFieldClass);if(t.length===0){egov.message.show("Mẫu phiếu in này không cho phép sửa nội dung nào.");return}t.each(function(){var t=$(this).text(),i=$(this).attr("id"),r=$(this).attr("onkeyup");$(this).replaceWith("<input type='text' id = '"+i+"' class='"+n.editFieldClass+"' value='"+t+"' onkeyup='"+r+"'/>")});$("#"+n.editButtonId).hide();$("#"+n.printButtonId).hide();$("#"+n.saveButtonId).show()},save:function(n){for(var r,t=this,u=$("."+t.editFieldClass),f={},e=u.length,i=0;i<e;i++)r=u[i],f[$(r).attr("id")]=$(r).val();$.ajax({url:"/Print/SaveChange",data:{docId:t.docId,changes:JSON.stringify(f)},success:function(){t.open(n)},error:function(n){egov.message.notification(n.statusText,egov.message.messageTypes.error)}})},_printOnClient:function(){$(".pdfviewer").jqprint()},openPrintEmbryonicForm:function(n){var t=egov.views.base.dialog,i=this,r={width:350,height:150,title:"eGov Printer",buttons:[{text:"In",click:function(){i.printEmbryonicForm(i.docId,n)}},{text:"Đóng",click:function(){t.close()}}]};$.ajax({url:"/Print/GetPrinters",beforeSend:function(){t.open('<img src="../../Content/Images/ajax-loader.gif" />',r)},success:function(n){t.close();t.open(n,r)}})},printEmbryonicForm:function(n,t){var r=egov.views.base.dialog,i=$("#printer").val();i==null?window.parent.egov.message.show("Bạn chưa chọn máy in!",null,null,null,null):$.ajax({url:"/Print/PrintReport",data:{embryonicId:t,documentId:n,printerName:i},success:function(n){egov.message.show(n.message,null,null,null,null);n.success&&r.close()}})},preViewEmbryonicForm:function(n,t){window.open("/Print/PreView?id="+t+"&&docId="+n,"mywindow","fullscreen=yes, scrollbars=auto")}})});