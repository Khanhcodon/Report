(function(){"use strict";if(btalk.model=btalk.model||{},btalk.model.message!==!0){btalk.model.message=!0;var n=Backbone.Model.extend({members:null,defaults:{historyDay:""},initialize:function(){this.members=new i;this.members.on("reset",this.updateCounts)},updateCounts:function(){}}),o=Backbone.Collection.extend({model:n,getDay:function(n){var t=new Date,i;return typeof n=="object"&&typeof n.getFullYear=="function"?t=n:typeof n=="string"&&(t=new Date(n)),i=t.getFullYear()+"/"+(t.getMonth()+1)+"/"+t.getDate(),this.where({historyDay:i})},counts:function(){var n=0;return this.each(function(t){t.members.each(function(t){n=n+t.messages.length})}),n},files:function(){var n=[];return this.each(function(t){t.members.each(function(t){t.messages.each(function(t){t.get("filename")&&t.get("filename").length>0&&n.push(t)})})}),n},findMessage:function(n){for(var f,r,u,t,i=0;i<this.length;i++)for(f=this.models[i],r=0;r<f.members.length;r++)for(u=f.members.models[r].messages,t=0;t<u.length;t++)if(u.models[t].get("id")==n)return u.models[t]},readall:function(){for(var u,i,r,n,t=0;t<this.length;t++)for(u=this.models[t],i=0;i<u.members.length;i++)for(r=u.members.models[i].messages,n=r.length-1;n>=0;n--)r.models[n].get("unread")==!0&&r.models[n].set({unread:!1})},updateStatus:function(n,t){for(var i=n,r=this.findMessage(t);i;){if(i.get("isme")==!0&&i.status!=null&&(i.status(""),i.get("id")==t))break;i=i.newer}},updateModelsViewed:function(n,t,i){var r,u;n&&(r=this.findMessage(n),r&&typeof r.addViewedBy=="function"&&(r.removeViewedBy(i),this.updateStatus(r,t)));t&&(u=this.findMessage(t),u&&typeof u.addViewedBy=="function"&&u.addViewedBy(i))}}),t=Backbone.Model.extend({messages:null,defaults:{account:"",timestamp:"",append:!1,online:!1},initialize:function(){this.messages=new u;this.messages.on("reset",this.updateCounts)},updateCounts:function(){}}),i=Backbone.Collection.extend({model:t}),r=Backbone.Model.extend({older:null,newer:null,attachments:null,statusMap:{client:0,server:1,success:2,viewed:3,"":4},defaults:{id:"",state:"",message:"",status:null,_status:-1,unread:!1,append:!1,imageColumn:0,imageCount:0,otherCount:0,receiverJid:"",senderJid:"",account:"",isMsgGroup:!1,contentmsg_quote:null,sendermsg_quote:null,timemsg_quote:null,viewedBy:[]},addViewedBy:function(n){var t=_.clone(this.get("viewedBy"));t.push(n);this.set({viewedBy:t})},removeViewedBy:function(n){var t=_.clone(this.get("viewedBy")),i=t.indexOf(n);t.splice(i,1);this.set({viewedBy:t})},status:function(n){if(n!=null){if(!this.statusMap[n])return;this.get("_status")<this.statusMap[n]?this.set({status:n,_status:this.statusMap[n]}):console.log("WARNING: this.get('_status') < this.statusMap[value]: "+this.get("_status")<this.statusMap[n])}else return this.get("status")},findAttachment:function(n){for(var t=0;t<this.attachments.length;t++)if(this.attachments.models[t].get("id")==n)return this.attachments.models[t]},initialize:function(){if(arguments&&!(arguments.length<=0)){var n=arguments[0];if(typeof n.imageCount=="number"&&typeof n.otherCount=="number"&&n.imageCount+n.otherCount>0){this.attachments=new e;this.attachments.on("reset",this.updateCounts)}}},updateCounts:function(){}}),u=Backbone.Collection.extend({model:r}),f=Backbone.Model.extend({defaults:{name:"",type:"",percentage:100,url:"",id:"",statusText:"",status:0,from:"",to:"",tenantid:""},percentage:function(n){if(n=parseInt(n),n!=null&&(n==-1||n>this.get("percentage")))this.set({percentage:n});else return this.get("percentage")}}),e=Backbone.Collection.extend({model:f}),s=Backbone.Model.extend({defaults:{textloading:"Đang tải...",state:2,currentChatter:null},startLoading:function(){this.set({state:2,textloading:"Đang tải..."})},stopLoading:function(){this.set({state:1,textloading:""})},hidden:function(){this.set({state:0,textloading:""})},currentChatter:function(n){if(n instanceof Backbone.Model)this.set({currentChatter:n});else return this.get("currentChatter")}}),h=new o;btalk.model=$.extend(btalk.model,{ConversationDay:n,Member:t,MemberList:i,Message:r,MessageList:u,Attachment:f,AttachmentList:e,MessageNext:s});btalk=$.extend(btalk,{CONVERSATIONDAYS:h})}})();