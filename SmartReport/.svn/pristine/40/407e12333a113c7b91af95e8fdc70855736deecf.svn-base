define(function(){"use strict";function s(n,t,i){for(var r,u,l,e,a,h={CoProcessor:[],Processor:[]},s,o=f,c=0;c<n.length;c++){if(r=n[c],typeof r.Content=="string"&&(r.Content=r.Content.replace(/[\n]/gi,"").split("\\n").join("<br />"),s=JSON.parse(r.Content)),r.Description="",r.CommentType==o.Common){if(u=s.Transfers,u=_.sortBy(u,function(n){return n.type}),r.Content=s,r.Content.Transfers.length==1&&r.Content.Transfers[0].type=="2"&&(r.Content.Transfers[0].type="1"),r.Content.Transfers.length>0){if(r.Description=String.format("Chuyển tới <span class='comment-received'>{0}<\/span>",u[0].label),u.length>1){for(l=0,e=1;e<u.length;e++)a=u[e].label,l+=a.split(",").length,r.Content.Transfers[e].type=i?o.ReleasedSurvey:r.Content.Transfers[e].type;r.Description+=String.format(" và <span class='comment-received'>{0} người khác<\/span>",l)}}else r.Description="Gửi ý kiến";h.Processor.push(r)}if(r.CommentType==o.ReleasedSurvey){if(u=s.Transfers,u=_.sortBy(u,function(n){return n.type}),r.Content=s,r.Content.Transfers[0].type=o.ReleasedSurvey,r.Content.Transfers.length>0&&(r.Description=String.format("Phát hành tới <span class='comment-received'>{0}<\/span>",u[0].label),u.length>1)){for(l=0,e=1;e<u.length;e++)a=u[e].label,l+=a.split(",").length,r.Content.Transfers[e].type=o.ReleasedSurvey;r.Description+=String.format(" và <span class='comment-received'>{0} người khác<\/span>",l)}h.Processor.push(r)}r.CommentType==o.CompletedSurvey&&(s=JSON.parse(r.Content),r.Content=s,r.Content.Transfers=[],r.Description="Hoàn thành phiếu khảo sát",h.CoProcessor.push(r));r.CommentType==o.Consulted&&(s=JSON.parse(r.Content),r.Content=s,r.Content.Transfers=[],r.Description="Gửi ý kiến đồng xử lý",h.CoProcessor.push(r));r.CommentType==o.Contribution&&(r.Content=JSON.parse(r.Content),r.Content.Transfers=[],r.Description="",h.CoProcessor.push(r));(r.CommentType==o.Finished||r.CommentType==o.Reopen)&&(r.Content=JSON.parse(r.Content),r.Content.Transfers=[],h.Processor.push(r));r.UserSend=_.find(t,function(n){return n.value===r.UserSendId});r.UserSend==undefined&&(r.UserSend={});r.avatar=r.UserSend.avatar;r.Children&&_.each(r.Children,function(n){n.UserSend=_.find(t,function(t){return t.value===n.UserSendId});n.UserSend==undefined&&(n.UserSend={});n.Content=JSON.parse(n.Content);n.Content.Transfers=[];n.avatar=r.UserSend.avatar});n[c].prev_commentId=c!=n.length-1?n[c+1].CommentId:0;r.compare="../AvatarProfile/compare.png";r.compare_first="../AvatarProfile/compare_first.png"}return h}function i(n,t){for(var r=$.tmpl(n,t),i=0;i<r.length;i++)(r.eq(i).html(_.unescape(r[i].innerHTML)),i<=2)||(egov.isMobile?r.eq(i).hide():r.eq(i).addClass("dynamicComment").hide());return r}function a(n,t,i){var r=$.tmpl("<tr><td class='wraptext' nowrap><span>${name}<\/span><\/td><td class='wraptext' title='Xem'><a href='#' value='${value}' style='color:blue;'><span class='icon-file-openoffice'><\/span><\/a><\/td><\/tr>",{value:n,name:t});return r.find("a").click(function(){typeof i=="function"&&i(n)}),r}function v(n){var r,i;if(n.length<=t)return n;if(r=n.charAt(t),i=n.substring(0,t),r==" ")return i;var u=t-i.lastIndexOf(" "),e=n.substring(t,n.length),f=e.indexOf(" ");return f<u?n.substring(0,t+f):n.substring(0,t-u)}function h(n){return $.each(n,function(t,i){i===""||i===null?delete n[t]:typeof i=="object"&&(n[t]=h(i))}),n}function y(n){var t=document.createElement("DIV");return t.innerHTML=n,t.textContent||t.innerText||""}function p(n){var u=n.length||0,f=n[0]instanceof Array?n[0].length:0,t,i,r;if(f===0||u===0)return[];for(r=[],t=0;t<f;t++)for(r[t]=[],i=0;i<u;i++)r[t][i]=n[i][t];return r}var n,r,u,f,t;n=egov.resources.document;r=egov.models.document;u=egov.template.document;var e=egov.documentTemplates,w=egov.doctypes,c=Backbone.View.extend({documentViewType:egov.enum.documentViewType.default,isCreate:!1,categoryBusinessId:0,heightChange:0,docFieldIds:null,isAcknowledged:!1,keyword:null,dataFormTable:null,xoayObject:null,globalColumns:null,events:{"click #openDialogCommon":"_openDialogCommon",'change [name="cbDetail"]':"checkDetail",click:"removeRowSelected","change .new-paper .paper-name":"_changePaper","input input.paper-name":"_addPaper","input input.fee-name":"_addFee","input input.fee-price,input.fee-name":"_calPrice","change input.fee-id":"_calPrice","change #ddlDateAppointRange":"_changeDateAppoint","click .changeDateCreated":"_changeDateCreated","click .attachment-download-all":"_downloadAllAttachment","click .changeWorkflowType":"_changeWorkflowType","click #viewDocFee":"_openDocFee","click #viewDocPaper":"_openDocPaper","click .deletePaper":"_deleteDocPaper","click .deleteFee":"_deleteDocFee","click .delete-paper":"_deleteDocTypePaper","click .delete-fee":"_deleteDocTypeFee","click .doc-online-btn":"_docOnlineActions","click .btnCheckCitizenInfo":"checkCitizenInfo","click .file_attachments .attachment-download":"dowloadDocOnlineAttachment","click .file_attachments .attachment-open":"openDocOnlineAttachment","click .delApprover":"_delApprover","click .delUpdateResult":"_delUpdateResult","click .deleteDelayReason":"_deleteDelayReason","click .btnResendLt":"_ReSendLienThong","click .btnRecalled":"_recalledLienThong","click .recalledList li":"_recalledAllLienThong","click #btnToggleForm":"_changeDocumentFormView","change #StoreId":"_changeStoreId","change #CategoryId":"_changeCategory","click .ddlDocCodes a":"_selectDocCode","blur #DocCode":"_checkDocCodeIsUsed","keyup #DocCode":"suggesOrgan","click #checkDocCode":"_seachDocCode","change #IsCustomCode":"_allowUsingCustomCode","click .docPaperManager":"_managerDoctypePaperFee","click .changeDateAppointed":"renewals","click .btnAcceptThuHoi":"_acceptThuHoi","click #btnAddRow":"addRow_HT","click #btnMerge":"merge_HT","click #btnViewBCTH":"viewBCTH_HT","click #btnViewLeaf":"showLeaf","change #ddlYearReport, #bctuan, #bcthang, #bcquy, #bcnuanam, .bcngayplus":"changePeriod","click #btnImportData":"_importDataFromExcel","click .compare":"_showCompareData"},initialize:function(n){var t=this,f,i;this.el=n.el;this.id=n.id;this.isOnlineRegistration=n.isOnlineRegistration;this.question=n.question;this.callback=n.callback;this.documentInfo=n.documentInfo;this.documentInfo?(this.documentInfo instanceof Backbone.Model||(this.documentInfo=new Backbone.Model(this.documentInfo)),this.model=new r(this.documentInfo.toJSON())):this.model=new r;this.isPopUp=n.isPopUp;this.contentHTML=n.contentHTML;n.tab&&(t.tab=n.tab,t.relationAnswerId=t.tab.model.get("relationId"),t.relationType=t.tab.model.get("relationType")||1);t.isCreate=t.isCreate||n.isCreate;t.documentViewType=n.documentViewType||egov.enum.documentViewType.default;t.isPreView=t.isPreView||n.isPreView;t.isShowingPreview=!1;t.hasMinTemplate=!1;t.survey=n.survey||t.model.get("CategoryBusinessId")==32;t.supplements=[];t.isFullView=t.documentViewType!==egov.enum.documentViewType.preView||egov.setting.userSetting.quickView===egov.enum.quickViewType.below;f=t.survey?u.desktopSurvey:u.desktop;egov.pubsub.publish(egov.events.status.processing,egov.resources.common.processing,2);n.copiedDocument&&(this.copiedDocument=!0,this.model=n.copiedDocument,i=this.model.get("Attachments"),i&&_.each(i,function(n){n.isNew=!0}));this.registerToGlobal();require([f],function(i){if(t.template=i,t.isOnlineRegistration){t._openOnlineRegistration(n.id);return}if(t.question){t._openQuestion();return}if(t.isPopUp=!1,t.isPopUp){t._openDocumentInPopUp(n.model,n.templateCfg);return}if(t.isCreate){t.survey?t._openCreateSurveyDocument(n.id):t._openCreateDocument(n.id);return}t.survey?t._openEditSurveyDocument(n.id):t._openEditDocument(n.id)})},registerToGlobal:function(){var n,i,t=window.parent;_.isFunction(t.openFilePreview)||(t.openFilePreview=function(r,u){(n=$("#filePreviewDialog",t.document),i=$("#openFilePreview",t.document),n.length!==0)&&(n.find("iframe").length>0&&n.find("iframe").remove(),n.find(".modal-content").append('<iframe src="/AttachmentPreview/Index?id='+r+"&currentId="+u+'" style="width: 100%; height: 100%; border: none;"><\/iframe>'),i.click())})},checkDetail:function(n){var t=$(n.target);t.is(":checked")?$("#wrapUrgent, #wrapDateArrived, #wrapDocField, #wrapKeyword, #wrapDatePublished, #wrapSecurity").show():$("#wrapUrgent, #wrapDateArrived, #wrapDocField, #wrapKeyword, #wrapDatePublished, #wrapSecurity").hide()},selected:function(t){var f=this,i,r,u=f.$(t.target);require(["contextMenuView"],function(){r=new egov.models.contextMenu({trigger:"right",data:null,style:{},position:{my:"left top",at:"left bottom",of:"event"},hasCache:!1,isShowLoading:!1});i=new egov.models.contextMenuList;i.add({text:n.contextmenu.copyText,value:"copyText",iconClass:"icon-eye3",preFunction:function(n){ZeroClipboard.setMoviePath("/Scripts/bkav.egov/libs/zeroclipboard/ZeroClipboard.swf");var t=new ZeroClipboard.Client;t.setText(u.val());t.glue(n)}});i.add({text:n.contextmenu.selectAll,value:"selectAll",iconClass:"icon-eye3",callback:function(){u.select()}});r.set("data",i);u.contextmenu(r,t)})},removeRowSelected:function(n){this.$(".document-relation").find(n.target).length==0&&this.$(".document-relation").find(".rowSelected").removeClass("rowSelected");this.$(".document-attachment").find(n.target).length==0&&this.$(".document-attachment").find(".rowSelected").removeClass("rowSelected")},_changeStoreId:function(){var n=this.isHsmc&&this.isCreate;n?this._getDocCodes():this._getInOutCode()},_changeCategory:function(n){var t=$(n.target).closest("#CategoryId"),i=t.val();this.model.set("CategoryId",i);this.model.get("CategoryBusinessId")!=1?this._getDocCodes():this._getInOutCode()},_selectDocCode:function(n){var t=$(n.target).closest("a"),i;this.$codeElement=this.isVanBanDen?this.$("input[name='InOutCode']"):this.$("input[name='DocCode']");this.$codeElement.val(t.text());i=t.attr("codeid");this.model.set("CodeId",i)},_checkDocCodeIsUsed:function(){var t=this.$("#DocCode").val(),n,i;t!=""&&(n=this,i=n.isCreate?null:n.model.get("DocumentId"),egov.request.checkDocCodeIsUsed({data:{doccode:t,organization:"",documentId:i},success:function(t){t.isUsed?(n.$("label.warning[for='DocCode']").show(),n.$("#checkDocCode").show(),n.$("#codeUsedList tbody").html($.tmpl("<tr><td>${DateCreated}<\/td><td>${Organization}<\/td><td>${Compendium}<\/td><\/tr>",t.codes))):(n.$("label.warning[for='DocCode']").hide(),n.$("#checkDocCode").hide())}}))},sucgesOrgan:function(){},_seachDocCode:function(){var n=this.$("#DocCode").val();n!=""&&egov.views.home.tab.addSearch(n,1)},_allowUsingCustomCode:function(n){var t=$(n.target).closest("#IsCustomCode");t.is(":checked")?(this.$("#InOutCode").removeAttr("readonly"),this.model.set("IsCustomCode",!0)):(this.$("#InOutCode").attr("readonly","readonly"),this.model.set("IsCustomCode",!1))},_getInOutCode:function(){this._showDocCodes(!0)},_getDocCodes:function(){this._showDocCodes(!1)},_showDocCodes:function(n){var t=this,u=t.$("#StoreId").val(),e=t.$("#CategoryId").val(),f,i,o,r;if(f=n?t.$("input[name='InOutCode']"):t.$("input[name='DocCode']"),o=n?egov.request.GetInOutCode:egov.request.GetDocCodes,i=t.$(".ddlDocCodes"),t.$codeElement=f,u!=""&&u!=null){if(i.empty(),t.stores&&(r=_.find(t.stores,function(n){return n.StoreId==u&&n.CategoryId==e}),r&&r.Codes!=null&&r.Codes.length>0)){f.val(r.Codes[0]);_.each(r.Codes,function(n){i.append($('<li><a href="#">'+n+"<\/a><\/li>"))});return}i.html(egov.helper.loading);o({data:{storeId:u,categoryId:e},success:function(n){t.stores||(t.stores=[]);t.stores.push({StoreId:u,CategoryId:e,Codes:n});i.empty();var r=0;_.each(_.keys(n),function(u){r==0&&(f.val(n[u]),t.model.set("CodeId",u),r=1);i.append($('<li><a href="#" codeid="'+u+'">'+n[u]+"<\/a><\/li>"))})}})}},reload:function(){this.tab.reloadContent()},editContent:function(n){var t=_.find(this.model.get("DocumentContents"),function(t){return t.DocumentContentId===n});t&&this.forms[t.DocumentContentId]&&this.forms[t.DocumentContentId].renderDialog()},isValid:function(){var n=this,t,i;if(this.$("label.error[for='DocCode']").hide(),n.$("#ListDocField").val()?(t="",$("#tblDocField input[type='checkbox']:checked").each(function(){t+=$(n).attr("value")+","}),t=t.substr(0,t.length-1),n.$("#DocFieldIds").val(t)):n.$("#DocFieldIds").val(""),n.isAcknowledged=n.$("#IsAcknowledged").is(":checked")?!0:!1,egov.setting&&egov.setting.requirePublishPlan&&this.model.get("CategoryBusinessId")==egov.enum.categoryBusiness.vbdi&&n.publishPlan==null){egov.pubsub.publish(egov.events.status.error,"Văn bản yêu cầu dự kiến phát hành trước khi chuyển.");return}if(i=n.warningCompilation==undefined?!0:!1,!1&&!n.warningCompilation.ValidCompilation){egov.pubsub.publish(egov.events.status.warning,"Các đơn vị cấp dưới chưa báo cáo lên đủ, cần đôn đốc để tổng hợp dữ liệu");return}if(n.model.attributes.CategoryBusinessId==4,this.isVanBanDen&&(this.$("#InOutCode").val()===""||this.$("#StoreId").val()==="")){egov.pubsub.publish(egov.events.status.error,"Bạn chưa nhập Sổ hoặc Số đến cho văn bản.");return}return n.$("#CreateForm").length>0?n.$("#CreateForm").valid():n.$("#EditForm").length>0?n.$("#EditForm").valid():void 0},setOriginContent:function(){var t=this.model.get("DocumentContents"),n;_.each(t,function(t){var i=$("<div><\/div>");i.html(t.Content);n=i.find(".errorSpell");$.each(n,function(){$(this)[0].outerHTML=$(this).html()});t.Content=i.html()})},setSigned:function(){this.model.set("HasCA",!0)},DataAnalysisHandson:function(n,t){var i=[];return $.each(n,function(n,r){var u=0,f={};Object.keys(r).forEach(function(n){if(u!=t.GiaTriIndex)if(u==t.CatalogIndex)for(var i=0;i<t.CatalogCount;i++)f[t.CatalogValuesAscii[i]]=r[t.GiaTriNameAscii];else _.contains([t.GiaTriNameAscii,t.CatalogNameAscii,"pos"],n)||(f[n]=r[n]);u++});i.push(f)}),i},serialize:function(){var t=this,l,tt,n,u,it,rt,yt=t.findKyBaoCao(t.model.get("DocTypeId")),a,ut,r,h,f,s,w,d,ft,g,b,et,ct,at,ot,c,st,vt;for(a in t.model.attributes)if(a!=="IsCustomCode"&&a!=="IsActivated"&&(l=t.$el.find('[name="'+a+'"]'),!(l.parents(".formTmp").length>0))&&l.length>0&&(l.is("input")||l.is("select")||l.is("textarea"))){if(tt=l.val(),tt===""&&t.model.get(a)==null)continue;t.model.set(a,y(tt))}if(t.model.set("TypeReturned",Number(t.$el.find('[name="TypeReturned"]:checked').val())),ut=t.model.get("IsSuccess"),ut!==!0&&ut!==!1&&t.model.set("IsSuccess",null),t.model.set("IsAcknowledged",this.isAcknowledged),n=t.model.toJSON(),n.CommentList=[],n.Contents=[],t.model.attributes.CategoryBusinessId==4){var i=JSON.parse(JSON.stringify(t.dataFormTable.getSourceData())),ht=t.dataFormTable.getData(),pt=JSON.parse(JSON.stringify(t.dataFormTable.getSourceData()));t.xoayObject&&(i=t.DataAnalysisHandson(i,t.xoayObject));var wt=JSON.parse(t.configHandsontable),ct=[];for(r=0;r<i.length;r++)h=i[r],f=0,Object.keys(h).forEach(function(n){i[r][n]!=ht[r][f]&&(i[r][n]=ht[r][f]);f++});if(t.xoayObject!=null){var v=t.xoayObject,lt=[],p=[],k=[];for(r=0;r<i.length;r++)h=i[r],$.each(v.CatalogValues,function(n,i){p={};Object.keys(h).forEach(function(n){v.CatalogValuesAscii.includes(n)||(p[n]=h[n])});k=t.allCatalogValues.filter(function(n){return n.Value==i});p[v.CatalogNameAscii]=k==undefined||k.length==0?i:k[0].CatalogKey;p[v.GiaTriNameAscii]=h[v.CatalogValuesAscii[n]];lt.push(p)});i=lt}for(r=0;r<i.length;r++)for(h=i[r],i[r].pos=r+1,s=Object.keys(h),f=0;f<s.length;f++);if(_.each(i,function(n){f=0;Object.keys(n).forEach(function(i){if(t.dataFormTable.getDataType(0,f,0,f)=="dropdown"){var r=t.allCatalogValues.filter(t=>t.Value==n[i]);r.length>0&&r[0].CatalogKey!=null&&r[0].CatalogKey!=""&&(n[i]=r[0].CatalogKey)}f++})}),n.Note=JSON.stringify(i),i.length>0&&(s=Object.keys(i[0]),n.NoteCSV=s.join(",")+"\n",i.forEach(t=>{for(var i=0;i<s.length;i++)i>0&&(n.NoteCSV+=","),n.NoteCSV+=typeof t[s[i]]=="string"&&t[s[i]].includes(",")?`"${t[s[i]]}"`:t[s[i]];n.NoteCSV+="\n"})),w=t.configHandsontable?JSON.parse(t.configHandsontable):{},w.xoayData=JSON.stringify(pt),w.xoayObject=t.xoayObject,d=t.model.get("ProcessInfo"),c={},d!=undefined&&JSON.parse(d).headerFooter!=undefined)ft=JSON.parse(JSON.parse(d).headerFooter),c.FormHeader=ft.FormHeader,c.FormFooter=ft.FormFooter;else if(t.model.attributes!=null&&t.model.attributes.DocumentContents.length>0&&(g=t.model.attributes.DocumentContents[0],g!=undefined)){var e=g.FormHeader,o=g.FormFooter,nt=[];e!=undefined&&(nt=e.match(/@@(.*?)@@/gm)?e.match(/@@(.*?)@@/gm):[],_.each(e.match(/##(.*?)##/gm),function(n){nt.push(n)}));b=[];o!=undefined&&(b=o.match(/@@(.*?)@@/gm)?o.match(/@@(.*?)@@/gm):[],_.each(o.match(/##(.*?)##/gm),function(n){b.push(n)}));et=$("#ddlYearReport option:selected").val();nt.length>0&&_.each(nt,function(n){$.ajax({type:"POST",async:!1,url:"/Document/GetDataTemplateKeys",traditional:!0,data:{templateKeyCode:n,formId:t.FormId,timeKey:et},success:function(t){e=t.Success?t.Type&&(t.Type==4||t.Type=="default")?e.replace(n,t.NewValue||""):e.replace(n,""):e.replace(n,"")}})});b.length>0&&_.each(b,function(n){$.ajax({type:"POST",async:!1,url:"/Document/GetDataTemplateKeys",traditional:!0,data:{templateKeyCode:n,formId:t.FormId,timeKey:et},success:function(t){o=t.Success?t.Type&&(t.Type==4||t.Type=="default")?o.replace(n,t.NewValue||""):o.replace(n,""):o.replace(n,"")}})});c.FormHeader=e;c.FormFooter=o}w.headerFooter=JSON.stringify(c);n.ProcessInfo=JSON.stringify(w)}else t.model.attributes.CategoryBusinessId==8?(ct=CKEDITOR.instances[t.cid+"_explicit_template"].getData(),n.Note=ct):t.model.get("CategoryBusinessId")==32&&(ot=t.$el.find("textarea[id$=SurveyReport]").attr("id"),ot&&t.model.set("SurveyReport",CKEDITOR.instances[ot].getData()),egov.views.survey&&(at=egov.views.survey.getDestination()),c={SurveyConfig:JSON.stringify(egov.views.survey.surveyDesLogic.JSON).replace(/&quot;/g,'\\"')||"",SurveyCriteria:t.model.get("SurveyCriteria")||"",SurveyReport:t.model.get("SurveyReport")||"",DonViNhan:JSON.stringify(at)},n.ProcessInfo=JSON.stringify(c));return n.OrganizationCode=t.$el.find("#InOutPlace").val(),n.InOutPlace=t.$el.find("#InOutPlace").text().trim(),_.each(n.DocumentContents,function(r){if(t.model.attributes.CategoryBusinessId==4)r.Content=JSON.stringify(i);else{var u=CKEDITOR.instances[t.cid+"_explicit_template"].getData();r.Content=u}r.ContentUrl=String.format("{0}{1}_saved.xlsx",egov.setting.eform.forderReport,r.Url);n.Contents.push(JSON.stringify(r))}),n.DocumentContents=[],n.RelationModels=n.Relations,this.relationType==4&&n.RelationModels&&n.RelationModels.length>0&&_.each(n.RelationModels,function(n){n.RelationType=4}),n.Compendium=escape(n.Compendium),n.Comments.Content=n.Comment,t.model.attributes.CategoryBusinessId==4?n.Comments.Diff={Data:JSON.stringify(t.dataFormTable.getSourceData())}:t.model.attributes.CategoryBusinessId==8&&(n.Comments.Diff={Data:CKEDITOR.instances[t.cid+"_explicit_template"].getData()}),n.DocPapers=[],n.DocFees=[],this.$(".papers .doc-paper").each(function(){if(u=$(this).find(":checked"),u.length===1){if(it=u.siblings(".paper-name").is("input")?u.siblings(".paper-name").val():u.siblings(".paper-name").text(),!it)return;n.DocPapers.push({PaperName:it,Amount:u.siblings(".paper-amount").val(),Type:egov.enum.paperType.TiepNhan})}}),this.$(".fees .doc-fee").each(function(){if(u=$(this).find(":checked"),u.length===1){if(rt=u.siblings(".fee-name").is("input")?u.siblings(".fee-name").val():u.siblings(".fee-name").text(),!rt)return;n.DocFees.push({FeeName:rt,Price:u.siblings(".fee-price").val().split(".").join(""),Type:egov.enum.feeType.TiepNhan})}}),n.Fees=[],n.Papers=[],this.relationAnswerId&&(n.relationAnswerId=this.relationAnswerId,n.TransferTypeInEnum=this.relationType==4?"ThuHoi":"TraLoi"),n.Supplementary=this.supplements.join("\n"),n.HasDateOverdue=this.$("#HasDateOverdue").prop("checked"),n.HasDateAppointed=this.$("#HasDateAppointed").prop("checked"),n.IsCustomCode=this.$("#IsCustomCode").prop("checked"),n.ExpireProcess=this.$("#ddlDateAppointRange").val(),n.DateOverdue=n.HasDateOverdue?this._getDate("DateOverdue"):null,n.DateReceived=null,n.DatePublished=t.serializeDatePublished(yt),n.TimeKey=t.TimeKey,n.DateResponse=this._getDate("DateResponse"),n.DateArrived=this._getDate("DateArrived"),n.DateAppointed=this.isHsmc||n.HasDateAppointed?this._getDate("DateAppointed"):null,n.DateCreated=this._getDate("DateCreated"),n.FormId=t.FormId,n.DateModified==""&&(n.DateModified=null),n.DateResult&&(n.DateResult=null),n.Attachments=null,n.DocTypeId==""&&(n.DocTypeId=null),st={},vt=$(".catalog-name"),vt.each(function(){var n=$(this).val(),t=$(this).attr("data-name");st[t]=n}),t.model.get("CategoryBusinessId")==32&&(n.CategoryId=5),n.Address=JSON.stringify(st),n},_compilationData:function(n,t,i){var r=this;return _.mapObject(t,function(t){return r.funtioncompilationData(n,i,t)})},funtioncompilationData:function(n,t,i){var n;return i.type=="Sum"?Enumerable.from(n).sum(i.query):i.type=="Average"?Enumerable.from(n).average(i.query):i.type=="Count"?Enumerable.from(n).count(i.query):i.type=="Max"?Enumerable.from(n).max(i.query):i.type=="Min"?Enumerable.from(n).min(i.query):i.type=="None"?t:null},_serializeDynamicForm:function(n){var t="{",i=n.FormId.replace(/[\-&]+/g,""),r=eForm.database.JsonSerialize3(i);return t+='"FormId": "'+i+'",',t+='"GlobalCode":"'+n.GlobalCode+'",',t+='"Description":"'+n.Description+'",',t+='"DocFieldJson":'+r,t+="}",n.Content=t,n},_getDate:function(n){var i=this.$("[name='"+n+"']"),u=Date.parse(i.val(),"HH:mm dd/MM/yyyy"),t,r;return u!=undefined?u.toServerString():(t=i.datepicker("getDate"),t==undefined&&i.val()!=""&&(t=Date.parse(i.val())),t==undefined||t.length===0)?(r=this.model.get(n),r==null||r==""?null:new Date(r).toServerString()):(t.hours((new Date).hours()),t.minutes((new Date).minutes()),n=="DateAppointed"&&this.isHsmc&&(t.hours(this.defaultHour==null?(new Date).hours():this.defaultHour),t.minutes(this.defaultMinute==null?(new Date).minutes():this.defaultMinute)),t.toServerString())},_getReturnResultTimeDefault:function(){var t=this.model.get("DateAppointed"),n=Date.parse(t);n&&(this.defaultHour=n.hours(),this.defaultMinute=n.minutes())},hasInputChange:function(){var n,i,t;if(!this.hasChangeInfo){if(this.supplements&&this.supplements.length>0){this.hasChangeInfo=!0;return}for(t in this.model.attributes)if(n=this.$el.find('[name="'+t+'"]'),n.length!==0){if(n.is("input[type=checkbox]")){if(n.is(":checked")&&this.model.get(t)=="0"||!n.is(":checked")&&this.model.get(t)=="1"){this.hasChangeInfo=!0;return}continue}if((n.is("input[type=text]:not([readonly])")||n.is("select:not([disabled])")||n.is("textarea:not([readonly])")||n.is("input[type=radio]"))&&(i=n.val(),i!==null&&this.model.get(t)!==null)){if(i===""||t==="Comment")continue;if(t==="DateArrived"||t==="DatePublished"||t==="DateAppointed")continue;if(this.model.get(t).toString()!==i.toString()){this.hasChangeInfo=!0;return}}}}},hasChange:function(n){var t=this,i,r;if(typeof n!="undefined"){if(!this.model||this.isSaveChanged||this.model.get("Status")!==2&&this.model.get("Status")!==1||this.model.get("UserCurrentId")!==egov.setting.user.userId)return n(!1);if(this.isCreate||(this.hasInputChange(),this.hasChangeInfo)||t.hasChangeContent||t.relations&&t.relations.hasChangeRelation)return n(!0);if(!t.attachments)return n(!1);t.attachments.confirmAttachments(function(){return(i=t.attachments.model.select(function(n){return n.get("hasRemoved")}),r=t.attachments.modifiedFiles,i.length>0||Object.getOwnPropertyNames(r).length>0)?n(!0):n(!1)})}},transfer:function(n){var t=this,i,r;this.$Comment=this.$Comment||$();i=this.$Comment.val();r=n;egov.pubsub.publish("status.processing","Đang lưu báo cáo");setTimeout(function(){require(["transfer"],function(n){egov.transferForm===undefined&&(egov.transferForm=new n);egov.transferForm.render({action:r,document:t,callback:function(){t._addCommentCommon(i)}})})},100)},transferSpecialCreate:function(n){var t=this,i=this.$Comment.val();t.attachments.confirmAttachments(function(){require(["transfer"],function(r){egov.transferForm===undefined&&(egov.transferForm=new r);egov.transferForm.render({action:n,document:t,callback:function(){t._addCommentCommon(i)}})})})},cacheCodeNotation:function(){var r=this.model.get("Organization"),n=this.model.get("DocCode"),t,i;n!=""&&(t=_.last(n.split("/")),i=egov.setting.codeNotations[r]||[],i.push(t))},sendAnswer:function(t){var i=this,o=this.$Comment.val(),u,f,e,r,s=function(t){t&&(egov.pubsub.publish(egov.events.status.processing,n.docStore.processing),egov.request.SaveDocumentToStorePrivate({data:{storePrivateId:t,documentCopyId:i.model.get("DocumentCopyId")},success:function(){egov.pubsub.publish(egov.events.status.success,n.docStore.success);i.storePrivate.$el.dialog("hide")},error:function(){egov.pubsub.publish(egov.events.status.error,n.docStore.error)}}))};i.relations.confirmRelations(function(){i.attachments.confirmAttachments(function(){(u=i.serialize(),u!=undefined)&&((f={},i.attachments.model.each(function(n){n.get("isNew")&&(f[n.get("Id")]={name:n.get("Name")})}),e=i.attachments.model.select(function(n){return n.get("isRemoved")}),r=i.model.get("DocumentCopyId"),r=parseInt(r),isNaN(r))||(egov.pubsub.publish(egov.events.status.processing,egov.resources.common.transfering),egov.request.TransferYKienDongGop({data:{doc:JSON.stringify(u),files:JSON.stringify(f),modifiedFiles:JSON.stringify(i.attachments.modifiedFiles),removeAttachmentIds:e,documentCopyId:r,actionSpecial:t},success:function(t){t.success?(egov.pubsub.publish(egov.events.status.success,n.transfer.answerSuccess),egov.views.home.tree.storeTree.renderDialog(function(n){n&&s(n);i._reloadDocumentTree();i.tab.close()}),i._addCommentCommon(o)):egov.pubsub.publish(egov.events.status.error,t.error)}})))})})},publishment:function(){var n=this;n.attachments.confirmAttachments(function(){require(["publishmentView"],function(t){egov.publishment===undefined&&(egov.publishment=new t);egov.publishment.render({document:n,docTypeId:n.newDoctype})})},!0)},publishmentGov:function(){var n=this;n.attachments.confirmAttachments(function(){require(["publishmentGovView"],function(t){egov.publishmentGov===undefined&&(egov.publishmentGov=new t);egov.publishmentGov.render({document:n,docTypeId:n.newDoctype})})},!0)},transferSurvey:function(n){var t=this,i,r;this.$Comment=this.$Comment||$();i=this.$Comment.val();r=n;egov.pubsub.publish("status.processing","Đang lưu báo cáo");setTimeout(function(){require(["surveyView"],function(n){egov.surveyForm===undefined&&(egov.surveyForm=new n);egov.surveyForm.render({action:r,document:t,callback:function(){t._addCommentCommon(i)}})})},100)},publishmentSurvey:function(){var n=this;n.attachments.confirmAttachments(function(){require(["surveyView"],function(t){egov.surveyView===undefined&&(egov.surveyView=new t);egov.surveyView.render({document:n,docTypeId:n.newDoctype})})},!0)},rePublish:function(){var n=this;egov.request.GetIsTransferPublish({data:{documentCopyId:n.model.get("DocumentCopyId")},success:function(t){if(!t.error){var i=t.data;if(i){require(["publishmentView"],function(t){egov.publishment===undefined&&(egov.publishment=new t);egov.publishment.render({document:n,isRePublish:!0})});return}require(["privatePublishmentView"],function(t){egov.privatePublishment===undefined&&(egov.privatePublishment=new t);egov.privatePublishment.render({document:n,isRePublish:!0})})}}})},privatePublishment:function(){var n=this;n.attachments.confirmAttachments(function(){require(["privatePublishmentView"],function(t){egov.privatePublishment===undefined&&(egov.privatePublishment=new t);egov.privatePublishment.render({document:n,docTypeId:n.newDoctype})})})},sendComment:function(t){t===undefined&&(t=n.sendComment.dialogTitle);var i=this,r;egov.message.prompt(t,n.sendComment.dialogButton,function(t){if(t===""){i.sendComment(n.sendComment.enterComment);return}egov.pubsub.publish(egov.events.status.processing,egov.resources.common.transfering);egov.request.sendComment({data:{documentCopyId:i.model.get("DocumentCopyId"),comment:t},success:function(t){t.error?egov.pubsub.publish(egov.events.status.error,t.error):(egov.pubsub.publish(egov.events.status.success,n.sendComment.sendSuccess),egov.dataManager.getAllUsers({success:function(n){require([egov.template.document.comment],function(u){r=s(t,n);i.$("#commentList").prepend($.tmpl(u,r.Processor))})}}))},error:function(){egov.pubsub.publish(egov.events.status.error,n.sendComment.sendFail)}})})},announcement:function(){var n=this;require(["announcementView"],function(t){egov.announcementForm===undefined&&(egov.announcementForm=new t);egov.announcementForm.render(n.model.get("DocumentCopyId"))})},sendQuestion:function(){var n=this;n.attachments.confirmAttachments(function(){require(["consultView"],function(t){egov.consultView===undefined&&(egov.consultView=new t);egov.consultView.render({document:n})})})},answer:function(n,t){var i=this.model.get("DocumentCopyId");t=t||2;egov.dataManager.getCurrentDoctypes({success:function(r){var u=_.find(r,function(t){return t.DocTypeId===n});egov.views.home.tab.addDocument(n,u.DocTypeName,i,null,null,null,null,null,t)}})},answerHSMC:function(n,t){var i=this.model.get("DocumentCopyId");egov.dataManager.getCurrentDoctypes({success:function(r){var u=_.find(r,function(t){return t.DocTypeId===n});egov.views.home.tab.addDocument(n,u.DocTypeName,i,!1,t)}})},_businessLicense:function(){if(this.isHsmc){var n=this;require(["BusinessLicenseView"],function(t){new t({document:n,callback:function(){}})})}},_importInvoice:function(){if(this.isHsmc){var n=this;require(["InvoiceView"],function(t){new t({document:n,callback:function(){}})})}},_exportExcel:function(){var r=this,ot=r.configHandsontable,v=JSON.parse(ot),vi=JSON.stringify(v.headerNested),w=v.extra.headerSetting,st=JSON.stringify(v.extra.headerSetting),fi=JSON.stringify(v.extra.hiddenColumns),ei=r.model.get("ActionLevel"),oi=r.$el.find("#ddlYearReport option:selected").val(),k,hi,y,b,lt,a,g,nt,tt,it,rt,ut,i,s,h,ui;if(ei==1){var si=5,ht=0,ct=0;w[0].forEach(function(n){if(n.charAt(0)=="$"){var t="Năm "+(oi-si+ht);w[0][ct]=t;ht++}ct++});st=JSON.stringify(w)}for(k=[],_.map(v.headerNested,function(n){_.contains(v.extra.hiddenColumns,n.col)||k.push(n)}),hi=null,y=ot==undefined?y=r.nestedHeaders.slice():w,r.dataFormTable.getData().forEach(function(n){y.push(n)}),b=[],i=0;i<y.length;i++)b.push(Object.assign({},y[i]));lt=[];b.forEach(function(n){lt.push(n)});var ci=r.dataFormTable.getPlugin("hiddenColumns"),at=ci.hiddenColumns,d=[];b.forEach(function(n){for(var i,t=0;t<at.length;t++)i=at[t],delete n[i];d.push(n)});var p=d[0],vt=Object.keys(p),yi=vt[0],yt=2;Object.keys(p).forEach(function(n){(p[n]=="STT"||p[n]=="TT"||p[n]=="Đơn vị hành chính")&&(yt=n)});a=screen.width;g=a==1920?1e3:600;tt=a==1920?1500:900;rt=a==1920?1920:1300;ut=a==1920?1600:1e3;nt=a==1920?500:300;it=a==1920?700:500;var pt=[],wt=[],bt=[],kt=[],dt=r.$el.find("#CreateForm .scrollPart .formHeader p"),li=r.$el.find("#EditForm .scrollPart .formHeader p"),ft=dt.length>0?dt:li;for(i=0;i<ft.length;i++)if(s=ft[i].getBoundingClientRect(),h=ft[i].textContent,h!=" "&&h!=""){var u={},f={},e={},o={},n=s.left,t=s.right,c=s.top,l=h,pi=(n+t)/2;n>=0&&t<g?(u.leftTag=n,u.rightTag=t,u.topTag=c,u.nameTag=l,pt.push(u)):n>nt&&t<tt?(e.leftTag=n,e.rightTag=t,e.topTag=c,e.nameTag=l,bt.push(e)):n>it&&t<rt?(f.leftTag=n,f.rightTag=t,f.topTag=c,f.nameTag=l,wt.push(f)):n>0&&t>ut&&(o.leftTag=n,o.rightTag=t,o.topTag=c,o.nameTag=l,kt.push(o))}var gt=[],ni=[],ti=[],ii=[],ri=r.$el.find("#CreateForm .scrollPart .formFooter p"),ai=r.$el.find("#EditForm  .scrollPart .formFooter p"),et=ri.length>0?ri:ai;for(i=0;i<et.length;i++)if(s=et[i].getBoundingClientRect(),h=et[i].textContent,h!=" "&&h!=""){var u={},f={},e={},o={},n=s.left,t=s.right,c=s.top,l=h,pi=(n+t)/2;n>=0&&t<g?(u.leftTag=n,u.rightTag=t,u.topTag=c,u.nameTag=l,gt.push(u)):n>nt&&t<tt?(e.leftTag=n,e.rightTag=t,e.topTag=c,e.nameTag=l,ti.push(e)):n>it&&t<rt?(f.leftTag=n,f.rightTag=t,f.topTag=c,f.nameTag=l,ni.push(f)):n>0&&t>ut&&(o.leftTag=n,o.rightTag=t,o.topTag=c,o.nameTag=l,ii.push(o))}ui=r.$("textarea[name=Compendium]").text();$.ajax({type:"POST",url:"/HomeSMReport/ExportFileExcel",data:{stringRows:JSON.stringify(d),stringFileName:ui,leftHeader:JSON.stringify(pt),rightHeader:JSON.stringify(wt),middleHeader:JSON.stringify(bt),centerHeader:JSON.stringify(kt),leftFooter:JSON.stringify(gt),rightFooter:JSON.stringify(ni),middleFooter:JSON.stringify(ti),centerFooter:JSON.stringify(ii),ct:JSON.stringify(vt),posTextBold:yt,headerNested:JSON.stringify(k),headerSetting:st,hiddenColumns:fi},success:function(n){$("<a>").attr("href",n).attr("target","_blank")[0].click()}})},_exportPdf:function(){var t=this,i=CKEDITOR.instances[t.cid+"_explicit_template"].getData(),n,r;i.trim().length>0&&(n=$(`${t.el} textarea[name=Compendium]`).text(),n==""&&(n="Báo cáo"),r={content:i,name:n},$.ajax({type:"post",url:"/ReportViewer/ExportPdfHtml",data:r,success:function(n){$("<a>").attr("href",n).attr("target","_blank")[0].click()}}))},_exportDoc:function(){var t=this,i=CKEDITOR.instances[t.cid+"_explicit_template"].getData(),n,r;i.trim().length>0&&(n=$(`${t.el} textarea[name=Compendium]`).text(),n==""&&(n="Báo cáo"),r={content:i,name:n},$.ajax({type:"post",url:"/ReportViewer/ExportDocxHtml",data:r,success:function(n){$("<a>").attr("href",n).attr("target","_blank")[0].click()}}))},_exportDocToSign:function(n){var i=this,r=CKEDITOR.instances[i.cid+"_explicit_template"].getData(),t,u;r.trim().length>0&&(t=$(`${i.el} textarea[name=Compendium]`).text(),t==""&&(t="Báo cáo"),u={content:r,name:t},$.ajax({type:"post",url:"/ReportViewer/ExportDocxHtmlSign",data:u,success:function(t){n({fileName:t})}}))},_showCodeTemp:function(){var t=egov.template.document.codetemp,n=$("<div>"),i=this;$.ajax({type:"GET",url:"/document/GetCodeTemp",dataType:"json",contentType:"application/json; charset=utf-8",success:function(r){var u={width:780,height:400,title:"Thông tin các mã đang lưu tạm",position:["center",100],buttons:[{text:"Xóa tất cả",className:"btn-danger",click:function(){$.ajax({type:"POST",url:"/document/DeleteAllCodeTemp",dataType:"json",contentType:"application/json; charset=utf-8",success:function(r){r.success&&i._reloadCodeTemp(t,n)},error:function(){}})}},{text:"Đóng",className:"btn-default",click:function(){n.dialog("destroy");n.remove()}},],close:function(){n.remove()},draggable:!0,keyboard:!0};require([t],function(u){var f={templateCode:r};n.html($.tmpl(u,f));i._deleteCodeTemp(t,n)});n.dialog(u)},error:function(){console.log("No data return")}})},_deleteCodeTemp:function(n,t){var i=this;$(".btn-DeleteCode").click(function(r){var u=$(r.target).closest("a"),f=u.attr("id");$.ajax({type:"POST",url:"/document/DeleteCodeTemp",data:{codeTempId:parseInt(f)},success:function(r){r.success&&i._reloadCodeTemp(n,t)},error:function(){}})})},_reloadCodeTemp:function(n,t){var i=this;$.ajax({type:"GET",url:"/document/GetCodeTemp",dataType:"json",contentType:"application/json; charset=utf-8",success:function(r){require([n],function(u){var f={templateCode:r};t.html($.tmpl(u,f));i._deleteCodeTemp(n,t)})}})},finish:function(){var n=this,i=this.$("#Comment").val(),r=n.model.get("DocumentCopyId"),t=egov.views.home.documents.model.detect(function(n){return n.get("DocumentCopyId")===r}),u=t!=undefined?t.get("isThongBao")==1:!1;this.model.set("isThongBao",u);egov.views.home.documents.finishs([this.model],i,function(){n._reloadDocumentTree();n.tab.close()},this)},finishNotification:function(){var t=this,i=function(){egov.request.removeDocumentAnnouncement({data:{documentCopyId:t.model.get("DocumentCopyId")},success:function(){},error:function(){}})},r=function(r){r&&(egov.pubsub.publish(egov.events.status.processing,n.docStore.processing),egov.request.SaveDocumentToStorePrivate({data:{storePrivateId:r,documentCopyId:t.model.get("DocumentCopyId")},success:function(){i();egov.pubsub.publish(egov.events.status.success,n.docStore.success);t.storePrivate.$el.dialog("hide")},error:function(){egov.pubsub.publish(egov.events.status.error,n.docStore.error)}}))};egov.views.home.tree.storeTree.renderDialog(function(n){n?r(n):i();t._reloadDocumentTree();t.tab.close()})},saveStore:function(){var t=this,i=function(i){i&&(egov.pubsub.publish(egov.events.status.processing,n.docStore.processing),egov.request.SaveDocumentToStorePrivate({data:{storePrivateId:i,documentCopyId:t.model.get("DocumentCopyId")},success:function(){egov.pubsub.publish(egov.events.status.success,n.docStore.success);t.storePrivate.$el.dialog("hide")},error:function(){egov.pubsub.publish(egov.events.status.error,n.docStore.error)}}))};egov.views.home.tree.storeTree.renderDialog(function(n){i(n)})},printReceiptShortKey:function(t,i){var r=this,u,f,e;if(u=r.model.get("DocumentCopyId"),f=r.model.get("Status"),!r.isHsmc||f!==0&&f!==1){egov.pubsub.publish(egov.events.status.error,n.print.isNotCreated);return}if(egov.pubsub.publish(egov.events.status.processing,n.print.processing),e=function(){require(["print"],function(n){new n({docCopyId:[u],displayPreview:t,printId:i})})},u!=0){e();return}r.saveDocument(function(t){t.success?(u=t.documentCopyId,r.model.set("DocumentCopyId",u),e()):egov.pubsub.publish(egov.events.status.error,n.print.error)},!0)},receiveSupplementary:function(n,t,i,r){var u,e,f;if(this.isHsmc){if(u=this,n|=0,n===0&&(e=u.model.get("Supplementary"),e!=undefined&&(f=e.detect(function(n){return!n.get("IsSuccess")}),f!=undefined&&(n=f.get("SupplementaryId"),t=f.view))),u.supplementaryView){u.supplementaryView.open(t,r,i);return}require(["supplementary"],function(n){u.supplementaryView=new n({document:u,message:i,suppItem:t,callback:r})})}},insertReceiveSupplementary:function(n){this.model.get("Supplementary").add(n)},removeCurrentRequiredSupplementary:function(n){this.model.get("Supplementary").remove(n.model)},renewals:function(){var n=this;require(["renewals"],function(t){new t({document:n})})},_acceptThuHoi:function(n){var i=$(n.target).closest(".btnAcceptThuHoi").is(".accept"),u=this,t,r;if(this.$("#Comment").next(".error").remove(),t=this.$("#Comment").val(),!i&&t===""){this.$("#Comment").after('<label class="error">Bạn cần nhập lý do từ chối thu hồi.<\/span>');return}r=this.model.get("DocumentCopyId");egov.request.acceptThuHoi({data:{documentCopyId:r,isAccept:i,comment:t},success:function(n){if(n.success){egov.pubsub.publish("status.success","Đã thu hồi văn bản thành công.");u.closeTabAndReloadTreeNode();return}egov.pubsub.publish("status.error","Lỗi: không thu hồi được văn bản.")}})},changeDateAppointed:function(n){this.model.set("DateAppointed",n);var t=new Date(n);this.$("[name='DateAppointed']").datepicker("setDate",t)},returnResult:function(){var t,u,r,i,o,f,e;if(this.isHsmc){if(t=this,u=this.model.get("IsSupplemented")==!1&&this.model.get("Status")==egov.enum.documentStatus.DungXuLy,f=this.model.get("DocTypePermission"),e=(f&2)==2,r=e?this.model.get("IsSuccess")!=null:!0,i=function(){require(["returnResult"],function(n){new n({document:t,callback:function(n){if(o=parseInt(t.model.get("DocumentCopyId")),n.isFinish){t._reloadDocumentTree();t.tab.close();return}t.returnPapers=n.papers;t.returnFees=n.fees;t._bindSuppPaperAndFee(t.returnPapers,t.returnFees,!0)}})});return},u){this.receiveSupplementary(0,null,n.returnResult.needToUpdateSupplementary,function(){if(!r){t.updateLastResult(n.returnResult.needToUpdateLastResult,i,!0);return}i()});return}if(!r){t.updateLastResult(n.returnResult.needToUpdateLastResult,i,!0);return}i()}},publicResult:function(){if(this.isKNTC){var n=this;require(["publicResult"],function(t){new t({document:n})})}},createNewAppoint:function(){var n=this;require(["appoint"],function(t){new t({document:n})})},updateLastResult:function(n,t,i){var r=this,u=i?!1:!0;require(["updateLastResult"],function(i){new i({document:r,message:n,callback:t,IsNotNeedSign:u})})},saveDocument:function(n,t){var i,o,u,f,r,s,h,e;i=this;i.attachments.confirmAttachments(function(){o=i.serialize();u={};s=i.isCreate?egov.request.saveDocDraft:egov.request.saveDoc;i.attachments.model.each(function(n){n.get("isNew")&&(u[n.get("Id")]={name:n.get("Name")})});h=function(r){r.error&&!t?egov.pubsub.publish(egov.events.status.error,r.error):r.success&&!t&&egov.pubsub.publish(egov.events.status.success,r.success);i.isCreate&&i.tab.close();i.isCreate=!1;egov.callback(n,r)};e={doc:JSON.stringify(o),files:JSON.stringify(u)};i.isCreate||(f=i.attachments.model.select(function(n){return n.get("isRemoved")}),f=_.map(f,function(n){return n.get("Id")}),r=i.attachments.modifiedFiles,$.each(u,function(n,t){r[n]&&(t.content=r[n],delete r[n])}),e.modifiedFiles=JSON.stringify(r),e.removeAttachmentIds=f);s({data:e,success:h})})},updateDocument:function(n){var t,e,r,u,i,o,s,f;t=this;t.attachments.confirmAttachments(function(){e=t.serialize();r={};o=egov.request.saveDoc;t.attachments.model.each(function(n){n.get("isNew")&&(r[n.get("Id")]={name:n.get("Name")})});s=function(t){egov.pubsub.publish(egov.events.status.success,t.success);egov.callback(n,t)};t.transferType==egov.enum.documentTransferType.banGiaoKhiPhanLoai&&(e.DocTypeId=t.newDoctype);f={doc:JSON.stringify(e),files:JSON.stringify(r)};u=t.attachments.model.select(function(n){return n.get("isRemoved")});u=_.map(u,function(n){return n.get("Id")});i=t.attachments.modifiedFiles;$.each(r,function(n,t){i[n]&&(t.content=i[n],delete i[n])});f.modifiedFiles=JSON.stringify(i);f.removeAttachmentIds=u;o({data:f,success:s})})},RemoveDocument:function(){var n,t;n=this;t=parseInt(n.model.get("DocumentCopyId"));egov.request.removeDocument({data:{documentCopyIds:[t]},success:function(){n._reloadDocumentTree();n.tab.close()}})},closeTabAndReloadTreeNode:function(){this.tab.close();this._reloadDocumentTree(this.model.get("DocumentCopyId"))},getAttachmentsForSign:function(){var n=this,t=this.attachments.model.models,i=[];return t.length>0&&$.each(t,function(t,r){egov.fileExtension.isForSign(r.get("Name"))&&r.get("hasRemoved")!==!0&&r.get("isRemoved")!==!0&&(r.set("DocumentCopyId",n.model.get("DocumentCopyId")),r.set("Compendium",n.model.get("Compendium")),i.push(r))}),i},uploadSignFiles:function(n,t){var i=this,r=[];if(_.each(n,function(n){var t=i.attachments.model.find(function(t){return String(t.get("Id"))===String(n.id)}),u=t.get("Name"),f=u.endWith("_Signed.pdf",!0);!f||t.get("isNew")?r.push(n):i.attachments.modifiedFiles[n.id]=n.value}),r.length===0){egov.callback(t);return}egov.request.uploadTempScan({data:{files:JSON.stringify(r)},success:function(n){$.each(n,function(n,t){if(t.error!=="")egov.pubsub.publish(egov.events.status.error,t.name+": "+t.error);else{var r=new egov.models.attachment({Id:t.key,Name:t.name,Size:t.size,Extension:t.extension,Versions:[{Version:1,User:egov.setting.fullName+" ("+egov.setting.userName+")"}],isNew:!0});i.attachments.model.add(r)}});egov.callback(t)},error:function(){egov.pubsub.publish(egov.events.status.error,"Lỗi trong quá trình upload file đã kí lên server! Vui lòng thử lại.")}})},_renderLienthong:function(){var n=this,t=n.model.get("LienThongs");(t==null||t.length===0)&&n.$("#wrapLienThong").remove()},_bindSuppPaperAndFee:function(n,t){this.$(".add-paper, .add-fee").remove();this.$(".doc-paper-supp, .doc-fee-supp").remove();this.$(".papers").append($.tmpl('<li class="doc-paper list-group-item"><input class="paper-id" type="checkbox" value="${DocPaperId}" checked/><span class="paper-name">${PaperName}<\/span><input class="paper-amount form-control pull-right" type="text" value="${Amount}" /><\/li>',n));this.$(".ul-papers").append(this.$newPaper.clone(!0));this.$(".fees").append($.tmpl('<li class="doc-fee list-group-item"><input class="fee-id" type="checkbox" value="${DocFeeId}" checked/><span class="fee-name">${FeeName}<\/span><span class="pull-right currencyUnit" data-res="egov.resources.common.currencyUnit"><\/span><input class="fee-price pull-right form-control" type="text" value="${Price}" /><\/li>',t));this.$(".ul-fees").append(this.$newFee.clone(!0))},_reloadDocumentTree:function(n){this.isOnlineRegistration||this.question?egov.views.home.tree.reloadSelectedNode():egov.views.home.tree.removeDocuments(n)},_unescapeModel:function(){var n=this;_.each(n.model.attributes,function(t){if(typeof n.model.get(t)=="string"){n.model.set(t,unescape(n.model.get(t)));return}if(t==="CommentList"){var i=n.model.get(t);_.each(i,function(n){n.Content=unescape(n.Content);typeof n.Content=="string"&&(n.Content=n.replace(/[\n]/gi,"").Content.split("\\n").join("<br />"))});n.model.set(t,i)}})},_openDocumentInPopUp:function(n,t){var u,i;i=this;u=h(n);i.model=new r(u);i.templateCfg=t;i.render();require(["egovPopup"],function(){egov.popup.autoSaveSize()})},_openCreateDocument:function(n){var t=this,i=_.find(egov.setting.allDoctypes,function(t){return t.DocTypeId==n});t.isHsmc=i.CategoryBusinessId===egov.enum.categoryBusiness.hsmc;t.isVanBanDen=i.CategoryBusinessId==egov.enum.categoryBusiness.vbden;egov.dataManager.getDocumentCreateInfo(t.id,t.relationAnswerId,{success:function(n){var i,r;if(n){if(n.error){t.tab.close(!0);egov.pubsub.publish(egov.events.status.error,n.error);return}t.copiedDocument?(i=["DocCode","InOutCode","DocumentCopyId","DocumentPermissions","DateAppointed","DateCreated","DateResponse","DateModified","DateResult","TransferType","TransferTypeInEnum"],_.each(i,function(i){t.model.set(i,n[i])})):(r="",t.model.get("Organization")?t.model.get("CategoryBusinessId")==1&&(t.model.set("InOutCode",n.InOutCode),t.model.set("DocCode",""),t.model.set("DocumentContents",[]),t.model.set("Compendium",""),t.model.set("Attachments",[]),t.model.set("CategoryId",n.CategoryId),t.model.set("StoreId",n.StoreId),t._getInOutCode()):t.model.set(n));n.Stores&&n.Stores.length>0&&(t.stores||(t.stores=[]),t.stores.push({StoreId:n.Stores[0].StoreId,CategoryId:n.CategoryId,Codes:n.CategoryBusinessId==1?n.InOutCodes:n.DocCodes}));t.render()}},error:function(){t.tab.close();egov.pubsub.publish(egov.events.status.error,egov.resources.document.openError)},complete:function(){egov.pubsub.publish(egov.events.status.destroy)}})},_openEditDocument:function(){var n=this,t=n.documentInfo,r=t?t.get("DocTypeId"):null,u=t?t.get("CategoryBusinessId"):null,f=t?t.get("NodeCurrentId"):null,i=n.model==undefined?null:n.model.get("StorePrivateId");egov.dataManager.getDocumentEditInfo(n.id,i,{success:function(t){if(t.error){n.tab.close();egov.pubsub.publish(egov.events.status.error,t.error);return}n.isHsmc=t.document.CategoryBusinessId===egov.enum.categoryBusiness.hsmc;n.isVanBanDen=t.document.CategoryBusinessId==egov.enum.categoryBusiness.vbden;n.hasMinTemplate=!egov.setting.userSetting.AlwaysDisplayFullDocumentInfo&&(t.hasKhoiTao!=null?!t.hasKhoiTao:!1);n.model.set(t.document);n.model.set("HasPrivateSaveToStore",t.hasPrivateSaveToStore);n.model.set("DocumentPermissions",t.documentPermission);n.model.set("LienThongs",t.lienThongs);n.hasUpdatePermission=t.hasUpdatePermission;n.publishPlan=t.plan.publish;n._renderInfo();n._initDocument()},error:function(){n.tab.close();egov.pubsub.publish(egov.events.status.error,egov.resources.document.openError)},complete:function(){egov.pubsub.publish(egov.events.status.destroy)}})},getDocumentTemplate:function(){var n="";n=this.isHsmc?"hsmc":this.isVanBanDen?"vbden":"vbdi";this.fullTemplate=this.minTemplate=JSON.parse(e[n]);this.isHsmc||(n+="_min",this.minTemplate=e[n])},renderWarningCompilation:function(){var n=this,t=n.$el.find("#ddlYearReport option:selected").val();if(n.findKyBaoCao(n.model.get("DocTypeId"))!=6){const i=n.$el.find(".timeKey").filter(":not(.hidden)");_.each(i,function(i){const r=(n,t)=>String(n).padStart(t,"0");t+=n.findKyBaoCao(n.model.get("DocTypeId"))==2||n.findKyBaoCao(n.model.get("DocTypeId"))==3?i.value:r(n.findKyBaoCao(n.model.get("DocTypeId"))==4?parseInt(i.value)+1:i.value,2)})}else t=n.formatDateTimeKey(n._getDate("DatePublished"));n.warningCompilation?n.warningCompilation.reload(t):require(["warningCompilation"],function(i){i&&(n.warningCompilation=new i({document:n,TimeKey:t}))})},_renderInfo:function(){var n=this,r,t,i,u;if(this.model){if(this.isHsmc){if(egov.views.document&&this.isHsmc&&(this.model.set("DateCreated",egov.views.document.dateCreated),this.model.set("DelayReason",egov.views.document.delayReason)),n.model.get("Approver")&&n.model.get("Approver").length>0?_.each(n.model.get("Approver"),function(n){n.UserSendId==egov.setting.userId&&(n.hasPermission=!0)}):n.model.set("Approver",undefined),this.model.get("DocFees")){for(r=this.model.get("DocFees"),t=0,i=0;i<r.length;i++)u=r[i].Price,t+=u;t=t/1e3;this.model.set("MoneyFormat",egov.setting.moneyFormat)}this.model.get("HasJustCreated")||this.model.set("HasJustCreated",!1);this._getReturnResultTimeDefault()}this.model.get("ExpireProcess")||this.model.set("ExpireProcess",1);this.model.attributes.cid=this.model.cid;this.$el.html($.tmpl(this.template,this.model.toJSON()));this._showDocumentFormByTemplate();this.$("#ddlDateAppointRange option[value='"+this.model.get("ExpireProcess")+"']").attr("selected","selected")}},undoFinish:function(n){var t=this;egov.request.undoFinish({data:{documentCopyId:n},success:function(){t.closeTabAndReloadTreeNode()},error:function(){$(egov.views.home.tree.documentList).addClass("display");egov.pubsub.publish(egov.events.status.error,egov.resources.document.openError)}})},render:function(){if(this._unescapeModel(),this.isShowingPreview){var n=this.model;n.set("Compendium",n.get("Compendium").split("\n").join("<br />"));this.$el.html(i(this.template,n.toJSON()));this._initDocument()}else this._renderInfo(),this._initDocument();this.renderBusinessLicense()},renderDocumentInfo:function(n){var t=this,i;i=egov.template.document.desktopInfo;require([i],function(i){t.$(".document-info-template").html($.tmpl(i,t.model.toJSON()));t._showDocumentFormByTemplate();egov.callback(n)})},renderBusinessLicense:function(){return;var n},renderInvoice:function(){var n=this;!n.isHsmc||n.isCreate||egov.isMobile||require(["InvoiceShowView"],function(t){t&&egov.request.getInvoice({data:{fkey:n.model.get("DocCode")},success:function(i){var u=JSON.parse(i.data),r=u.Data.Item;r&&r.status!=5&&new t({model:r,document:n})},error:function(){}})})},reRenderInfo:function(){if(this.$("[name='Compendium']").val(this.model.get("Compendium")),this.$("[name='DocCode']").val(this.model.get("DocCode")),this.$("[name='Organization']").val(this.model.get("Organization")),this.model.get("DatePublished")){var n=Date.parse(this.model.get("DatePublished"));this.$("[name='DatePublished']").datepicker("setDate",n)}this._checkDocCodeIsUsed()},renderStoreWhenChangeDocType:function(n){var t=this,r,i,u;(t.$("#StoreId").empty(),r=t.model.get("HasChangeInoutCode")||t.model.get("DocTypeId")==null||t.model.get("DocTypeId")=="00000000-0000-0000-0000-000000000000",r)&&(i=_.find(egov.doctypes,function(t){return t.DocTypeId==n}),i)&&(u=i.Stores,$.tmpl("<option value='${StoreId}'>${StoreName}<\/option>",u).appendTo(t.$("#StoreId")),t.hasMinTemplate&&t._changeDocumentFormView(),t._changeStoreId())},_initDocument:function(){var n=this;n.hasUserCreate=n.isCreate||n.model.get("UserCreatedId")==egov.userId?!0:!1;this.$el.parent().addClass("display");this._renderToolbar();this._parseValues();this._unescapeDocument();this._renderDateOverdue();this.isCreate?this.$(".document-extend").hide():this._renderComments();this._renderAttachment();this._renderRelation();this._parseDateControl();this.$el.bindResources();this._renderCommonComments();this._autoResizeCompendium();this.$("form").attr("id",this.isCreate?"CreateForm":"EditForm");require(["documentShortkey"],function(t){t.init(n)});egov.pubsub.publish(egov.events.status.destroy)},_renderQuestionList:function(){var n=this;n.isCreate||require(["documentQuestions"],function(t){new t({documentId:n.model.get("DocumentId"),document:n})})},_autocompleteCitizen:function(){var t=this,h,i,c,r,u,f,e,o,s,l;i={citizenName:"CitizenName",identityCard:"IdentityCard",phone:"Phone",email:"Email",address:"Address"};r=t.$('input[name="CitizenName"]');u=t.$('input[name="IdentityCard"]');f=t.$('input[name="Phone"]');e=t.$('input[name="Email"]');o=t.$('input[name="Address"]');s=t.$("textarea[name=Compendium]");h=function(n){return{minLength:2,source:function(t,i){$.ajax({url:"/document/FilterCitizen/",data:{name:r.val(),identityCard:u.val(),phone:f.val(),email:e.val(),address:o.val()},dataType:"json",type:"POST",success:function(t){i($.map(t,function(t){return{label:t[n],value:t[n],citizenName:t.CitizenName,email:t.Email,identityCard:t.IdentityCard,phone:t.Phone,address:t.Address}}))}})},autoFocus:!0,autoSelectFirst:!0,select:function(n,t){r.val(t.item.citizenName);u.val(t.item.identityCard);f.val(t.item.phone);e.val(t.item.email);o.val(t.item.address);s.focus().val(s.val()+" ")}}};c=function(i){var r,u,f,e;(r=h(i),t.$('input[name="'+i+'"]').length!==0)&&(t.$('input[name="'+i+'"]').autocomplete(r).data("autocomplete")._renderItem=function(t,i){return t.addClass("dropdown-menu"),u=i.citizenName?i.citizenName:n.noCitizenFullName,f=i.email?i.email:n.noCitizenEmail,e=i.identityCard?i.identityCard:n.noCitizenIdCardNumber,$("<li>").data("item.autocomplete",i).append("<a href='#'>"+u+" | "+f+" | "+e+"<\/a>").appendTo(t)})};for(l in i)c(i[l])},_unescapeDocument:function(){var n,t,i;for(n in this.model.attributes)if(typeof this.model.get(n)=="string"&&this.model.set(n,unescape(this.model.get(n))),n==="CommentList"){for(t=this.model.get(n),i=0;i<t.length;i++)t[i].Content=unescape(t[i].Content),t[i].Content=t[i].Content.replace(/[\n]/gi,"").split("\\n").join("<br />");this.model.set(n,t)}},_parseValues:function(){var n=this,t,i;egov.dataManager.getCategories({success:function(t){var u=parseInt(n.model.get("CategoryBusinessId")),r=_.filter(t,function(n){return(n.CategoryBusinessId&u)===u}),i;r=_.sortBy(r,function(n){return n.CategoryName});n.$("#CategoryId").append($.tmpl('<option value="${CategoryId}">${CategoryName}<\/option>',r));i=_.find(t,function(t){return t.CategoryId===n.model.get("CategoryId")});i&&(n.model.set("CategoryName",i.CategoryName),n.$('#CategoryId option[value="'+i.CategoryId+'"]').attr("selected","selected"))}});egov.dataManager.getSendTypes({success:function(t){n.$("#SendTypeId").append($.tmpl('<option value="${Value}">${Text}<\/option>',t));var i=_.find(t,function(t){return t.Value==n.model.get("SendTypeId")});i&&(n.model.set("SendTypeId",parseInt(i.Value)),n.$('#SendTypeId option[value="'+parseInt(i.Value)+'"]').attr("selected","selected"))}});egov.dataManager.getCurrentDoctypes({success:function(t){var u=_.find(t,function(t){return t.DocTypeId===n.model.get("DocTypeId")}),r="",i;u===undefined?r=n.model.get("DocTypeName"):(r=u.DocTypeName,n.model.set("DocTypeName",u.DocTypeName));i=n.$("#DocTypeId");i.is("label")?i.append(r):i.is("input")&&i.val(r)}});i=function(t){egov.dataManager.getDepartmentsCurrent({success:function(i){var r=n.model.get("InOutPlace"),u=n.model.get("OrganizationCode");r&&r!=""?n.isCreate||(i=_.find(i,function(n){return n.EdocId=u})):(r=i?i[0].DepartmentName:t[0],u=i?i[0].EdocId:"");n.hasUserCreate&&$.tmpl("<option value='${EdocId}'>${DepartmentName}<\/option>",i).appendTo(n.$("#InOutPlace"));n.$("#InOutPlace option").each(function(){$(this).val()==u&&$(this).attr("selected","selected")});n.model.set("InOutPlace",r)}})};egov.request.getAllDepartment({success:function(t){n.departmentCached=t;var r=_.pluck(t,"label");i(r)}});t=n.model.get("InOutCodes");t&&_.each(_.keys(t),function(i){n.$(".ddlDocCodes").append($('<li><a href="#" codeid="'+i+'">'+t[i]+"<\/a><\/li>"))})},_renderDateOverdue:function(){var n=this;this.$("#HasDateAppointed").click(function(){$(this).is(":checked")?n.$("[name='DateAppointed']").removeAttr("readonly"):n.$("[name='DateAppointed']").attr("readonly","readonly")});this.$("#HasDateOverdue").click(function(){$(this).is(":checked")?n.$("[name='DateOverdue']").removeAttr("readonly"):n.$("[name='DateOverdue']").attr("readonly","readonly")})},_autoResizeCompendium:function(){var n,t,i;i=this;n=i.$("#wrapCompendium textarea");n&&n.length>0&&(t=n[0].scrollHeight,n.css({"min-height":"36px",height:t+"px","max-height":"none"}),n.keyup(function(){n.height("0px");n.height(t+15+"px");i.heightChange=n.height()-t}))},_showDocumentFormByTemplate:function(){var n=this;require(["formtemplate"],function(){n._renderTemplateByConfig();n.$(".formTmp").hide();return})},_renderComments:function(){var n=this,t,r;if(n.isCreate){n.$(".document-extend").hide();return}this.$("#commentList, #coCommentList").enableTextSelect();t=this.$(".comment-title, #countComment");t.each(function(){$(this).on("click",function(i){egov.helper.destroyClickEvent(i);var r=t.attr("data-open")==="true"?!0:!1;r?(n.$("#commentList").find(".comment-item").addClass("open"),n.$("#commentList").find('.list-group-item[data-display="false"]').show(),n.$("#coCommentList, .synthesis-comments").show()):(n.$("#commentList").find(".comment-item").removeClass("open"),n.$("#coCommentList,.synthesis-comments").hide());t.attr("data-open",!r);n.$(".synthesis-comments-title").attr("data-open",!r)})});this.$(".synthesis-comments-title").on("click",function(t){egov.helper.destroyClickEvent(t);var i=$(this).attr("data-open")==="true"?!0:!1;i?n.$("#coCommentList,.synthesis-comments").show():n.$("#coCommentList,.synthesis-comments").hide();$(this).attr("data-open",!i)});r=function(){n.$("#commentList, #coCommentList").bindResources();n.$(".comment-detail .wraptext").length>0&&n.$(".comment-detail .wraptext").dotdotdot({watch:!0,height:30});n.$("#commentList .comment-item, #coCommentList .comment-item").on("click",function(){$(this).toggleClass("open")});n.$(".displayAllComment").on("click",function(t){n.$("#commentList, #coCommentList").find(".dynamicComment").show();$(this).parents("li.list-group-item").remove();t.stopPropagation()})};egov.dataManager.getAllUsers({success:function(t){var e=n.model.get("CommentList"),u=s(e,t,n.model.get("CategoryBusinessId")==32);require([egov.template.document.comment],function(t){if(n.$("#commentList").html(i(t,u.Processor)),u.Processor.length>3&&n.$("#commentList").append($(String.format('<li class="list-group-item"><div class="comment-item"><span class="displayAllComment">{0}<\/span><\/div><\/li>',egov.resources.document.displayAllComment))),_.each(u.Processor,function(r){var u=r.Children;n.$(".commentChirdren .child"+r.CommentId).html(i(t,u))}),u.CoProcessor.length>0){n.$("#coCommentList").html(i(t,u.CoProcessor));n.$("#coCommentList .comment-item").addClass("open");var e=_.filter(u.CoProcessor,function(n){return n.CommentType==f.Contribution&&n.DocumentCopyTargetId})[0];e&&n.$(".synthesis-comments").text(e.Content.ContentConSult);_.each(u.CoProcessor,function(r){var u=r.Children;n.$(".commentChirdren .child"+r.CommentId).html(i(t,u))})}else n.$("#coCommentList").parent().hide();(u.CoProcessor.length>3||u.Processor.length>3)&&n.$(".displayAllComment").removeClass("hide");r()})}})},_renderToolbar:function(n){this.documentViewType===egov.enum.documentViewType.default?this.$toolbar=this.$(".toolbar"):egov.setting.userSetting.quickView===egov.enum.quickViewType.right?this.$toolbar=this.$(".toolbarQuickView"):egov.setting.userSetting.quickView===egov.enum.quickViewType.below&&(this.$toolbar=this.$(".toolbar"));var t=this;require(["documentToolbar"],function(i){t.toolbar=new i({el:t.$toolbar,model:t.model.get("DocumentPermissions"),document:t,defaultToolbarType:n});egov.toolbar=t.toolbar});setTimeout(function(){t.renderBangiaoName()},500)},renderBangiaoName:function(){var n=this;n.model.get("DocumentContents").length>0&&n.model.get("DocumentContents")[0].FormCategoryId==2?n.$el.find(".btnTransfer span").eq(1).text("Giao kế hoạch"):n.isCreate?n.$el.find(".btnTransfer span").eq(1).text("Gửi báo cáo"):n.$el.find(".btnTransfer span").eq(1).text("Chuyển")},_renderForm:function(){function i(n){for(var t="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",u=i.length,r=0;r<n;r++)t+=i.charAt(Math.floor(Math.random()*u));return t}var n=this.model.get("DocumentContents")[0],t=this.model.get("DocumentCopyId")===0||this.model.get("UserCreatedId")==egov.userId,r={document:{fileType:"xlsx",key:i(10),title:n.ContentName,url:egov.setting.eform.domain+n.ContentUrl,permissions:{comment:!1,download:!1,edit:t,fillForms:!1,print:!1,review:!1}},height:"500px",width:"100%",lang:"vi_VN",documentType:"spreadsheet",editorConfig:{mode:"edit",callbackUrl:egov.setting.eform.domain+"webeditor.ashx?name="+n.Url,customization:{compactToolbar:!0,autosave:!1,forcesave:!1,chat:!1,logo:{image:"/Content/logo.png"},customer:{address:"Dương Đình Nghệ, Yên Hoà, Cầu Giấy, Hà Nội",info:"Công ty Cổ phần Bkav",logo:"https://example.com/logo-big.png",mail:"john@example.com",name:"Bkav Corp",www:"bkav.com"},help:!1},plugins:{pluginsData:[]}}};this.DocEditor=new DocsAPI.DocEditor("divContent",r)},_renderTHDL:function(){var n=this,t=this.findKyBaoCao(this.model.get("DocTypeId")),r=this.serializeDatePublished(t),i=this.TimeKey;egov.request.getDataCompile({data:{timekey:i,doctypeId:this.model.get("DocTypeId")},success:function(t){var u=t.compile,i,r,f;if(u){for(i=[],r=0;r<u.length;r++)i.push(JSON.parse(u[r].CompilationData));i.length&&(f=n.dataFormTable,f.loadData(i))}}})},renderFormTranspose:function(){for(var r,e,v,o,u,t=this,c=this.model.get("DocumentContents")[0],s=JSON.parse(c.FormCode),l=s.dataHeader,i=p(l),h=i[0].length,a=i.length,f=[],n=0;n<h-1;n++)f.push("");for(f.push("Đơn vị","Chỉ tiêu"),n=0;n<a;n++)i[n].push(null);for(r=[],n=0;n<h;n++)r.push({readOnly:!0});r.push({});e=t.$("#divContent");v=e.parentNode;t.hotSettings={data:i,stretchH:"all",width:"100%",colHeaders:f,columns:r,autoWrapRow:!1,manualColumnResize:!0,manualRowResize:!0,className:"htMiddle",dropdownMenu:!0,rowHeaders:!0,contextMenu:!0,licenseKey:"non-commercial-and-evaluation"};t.dataFormTable=new Handsontable(e.get(0),t.hotSettings);o=JSON.parse(s.headerMerge);u=[];o.length>0&&(u=[],o.forEach(function(n){u.push({row:n.col,col:n.row,rowspan:n.colspan,colspan:n.rowspan})}),t.dataFormTable.updateSettings({mergeCells:u}))},_renderFormHandson:function(){var n=this,o=function(n,t){setTimeout(function(){isNaN(n)?t(!1):t(!0)},100)},t=this.model.get("DocumentContents")[0],i,f,p;n.CompilationId=t.CompilationId;n.FormId=t.FormId;n.ChildCompilationId=t.ChildCompilationId;n.ConfigFunction=t.ConfigFunction;i=this.model.get("ProcessInfo");n.isCreate&&(i=t.FormCode);n.configHandsontable=i;var u=JSON.parse(i),e=u.header,s=u.data,h=JSON.parse(u.headerNested),c=n.isCreate?s:JSON.parse(this.model.get("Note")),r=[],l=_.mapObject(e,function(n,t){var i=t.split("!!");return(n=="string"&&(r.push(300),n="text"),(n=="double"||n=="float")&&(r.push(80),n="numeric"),n=="int")?(r.push(80),n="numeric",{data:i[0],type:n,allowInvalid:!0,validator:o}):{data:i[0],type:n,allowInvalid:!0,width:80}}),a=_.mapObject(e,function(n,t){var i=t.split("!!");return i[1]}),v=_.values(l),y=_.values(a);n.fisrt=!0;f=n.$("#divContent");p=f.parentNode;n.hotSettings={data:c,columns:v,stretchH:"all",width:"100%",autoWrapRow:!1,manualColumnResize:!0,manualRowResize:!0,height:500,rowHeaders:!0,contextMenu:!0,colHeaders:y,nestedHeaders:h,licenseKey:"non-commercial-and-evaluation",colWidths:r,beforePaste:function(n){for(var i,r,u,t=0;t<n.length;t++)for(i=0;i<n[t].length;i++)r=n[t][i],n[t][i]=_.unescape(r),u=r.replace(/,/g,""),_.isNumber(u)&&(n[t][i]=u);return n},afterChange:function(){arguments[1]=="edit"&&(n.dataFormTable.updateSettings({height:$(`${n.el} div#divContent .ht_master .wtHider`).height()}),$(`${n.el} div#divContent`).css("height",$(`${n.el} div#divContent .ht_master .wtHider`).height()),$(`${n.el} div#divContent .ht_master .wtHolder`).css("height",$(`${n.el} div#divContent .ht_master .wtHider`).height()+($(`${n.el} div#divContent .ht_master .wtHider`).width()>$(`${n.el} div#divContent`).width()?17:0)))}};n.dataFormTable=new Handsontable(f.get(0),n.hotSettings);n.dataFormTable.updateSettings({height:$(`${n.el} div#divContent .ht_master .wtHider .htCore`).height()});$(`${n.el} div#divContent`).css("height",$(`${n.el} div#divContent .ht_master .wtHider .htCore`).height());$(`${n.el} div#divContent .ht_master .wtHolder`).css("height",$(`${n.el} div#divContent .ht_master .wtHider .htCore`).height()+($(`${n.el} div#divContent .ht_master .wtHider .htCore`).width()>$(`${n.el} div#divContent`).width()?17:0))},_renderHeaderFooterForm:function(){var i=this,s=this.model.get("ProcessInfo"),r,u,e,o;if(i.isCreate||i.model.get("Note")==""){if(r=this.model.get("DocumentContents")[0],r!=undefined){i.FormId=r.FormId;var n=r.FormHeader,t=r.FormFooter,f=[];n!=undefined&&(f=n.match(/@@(.*?)@@/gm)?n.match(/@@(.*?)@@/gm):[],_.each(n.match(/##(.*?)##/gm),function(n){f.push(n)}));u=[];t!=undefined&&(u=t.match(/@@(.*?)@@/gm)?t.match(/@@(.*?)@@/gm):[],_.each(t.match(/##(.*?)##/gm),function(n){u.push(n)}));e=$("#ddlYearReport option:selected").val();f.length>0&&_.each(f,function(t){$.ajax({type:"POST",async:!1,url:"/Document/GetDataTemplateKeys",traditional:!0,data:{templateKeyCode:t,formId:i.FormId,timeKey:e},success:function(i){n=i.Success?i.Type&&(i.Type==4||i.Type=="default")?n.replace(t,i.NewValue||""):n.replace(t,""):n.replace(t,"")}})});u.length>0&&_.each(u,function(n){$.ajax({type:"POST",async:!1,url:"/Document/GetDataTemplateKeys",traditional:!0,data:{templateKeyCode:n,formId:i.FormId,timeKey:e},success:function(i){t=i.Success?i.Type&&(i.Type==4||i.Type=="default")?t.replace(n,i.NewValue||""):t.replace(n,""):t.replace(n,"")}})});$(`${i.el} .formHeader`).html(n);$(`${i.el} .formFooter`).html(t)}}else JSON.parse(s).headerFooter!=undefined&&(o=JSON.parse(JSON.parse(s).headerFooter),$(`${i.el} .formHeader`).html(o.FormHeader),$(`${i.el} .formFooter`).html(o.FormFooter))},_myFormat:function(n,t,i,r,u,f){var e=this;Handsontable.renderers.TextRenderer.apply(this,arguments);f!=""&&(t.innerHTML=new Intl.NumberFormat("de-DE",{currency:"EUR"}).format(Number.parseFloat(f).toFixed(2)))},_coverRenderer:function(n,t,i,r,u,f){var o=Handsontable.helper.stringify(f),e;return o.indexOf("http")===0?(e=document.createElement("IMG"),e.src=f,Handsontable.dom.addEvent(e,"mousedown",function(n){n.preventDefault()}),Handsontable.dom.empty(t),t.appendChild(e)):Handsontable.renderers.TextRenderer.apply(this,arguments),t},removeVietnameseTones:function(n){return n=n.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g,"a"),n=n.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g,"e"),n=n.replace(/ì|í|ị|ỉ|ĩ/g,"i"),n=n.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g,"o"),n=n.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g,"u"),n=n.replace(/ỳ|ý|ỵ|ỷ|ỹ/g,"y"),n=n.replace(/đ/g,"d"),n=n.replace(/À|Á|Ạ|Ả|Ã|Â|Ầ|Ấ|Ậ|Ẩ|Ẫ|Ă|Ằ|Ắ|Ặ|Ẳ|Ẵ/g,"A"),n=n.replace(/È|É|Ẹ|Ẻ|Ẽ|Ê|Ề|Ế|Ệ|Ể|Ễ/g,"E"),n=n.replace(/Ì|Í|Ị|Ỉ|Ĩ/g,"I"),n=n.replace(/Ò|Ó|Ọ|Ỏ|Õ|Ô|Ồ|Ố|Ộ|Ổ|Ỗ|Ơ|Ờ|Ớ|Ợ|Ở|Ỡ/g,"O"),n=n.replace(/Ù|Ú|Ụ|Ủ|Ũ|Ư|Ừ|Ứ|Ự|Ử|Ữ/g,"U"),n=n.replace(/Ỳ|Ý|Ỵ|Ỷ|Ỹ/g,"Y"),n=n.replace(/Đ/g,"D"),n=n.replace(/\u0300|\u0301|\u0303|\u0309|\u0323/g,""),n=n.replace(/\u02C6|\u0306|\u031B/g,""),n=n.replace(/ + /g," "),n=n.trim(),n=n.replace(/!|@|%|\^|\*|\(|\)|\+|\=|\<|\>|\?|\/|,|\.|\:|\;|\'|\"|\&|\#|\[|\]|~|\$|_|`|-|{|}|\||\\/g," "),n.toLowerCase()},_renderFormHandsonPlus:function(){var u=this.model.get("DocumentContents")[0],n,yt,pt,i,c,p,t,s,ni,ft,v,l,g,ti,w,b,e,y,ht,ct,d,ii;if(u!=undefined){n=this;n.CompilationId=u.CompilationId;n.FormId=u.FormId;n.ChildCompilationId=u.ChildCompilationId;n.ConfigFunction=u.ConfigFunction;i=n.model.get("ProcessInfo");n.isCreate&&(i=u.FormCode);n.configHandsontable=i;i=JSON.parse(i);var h=[],vt=[],f=[];if(h=i.extra.columnSetting,f=i.extra.headerSetting,vt=i.data,yt=n.model.get("ActionLevel"),pt=n.$el.find("#ddlYearReport option:selected").val(),yt==1){if(u=this.model.get("DocumentContents")[0],u==undefined)return;i=n.model.get("ProcessInfo");n.isCreate&&(i=u.FormCode);n.configHandsontable=i;i=JSON.parse(i);f=i.extra.headerSetting;var gt=5,wt=0,o=0;f[0].forEach(function(n){if(n.charAt(0)=="$"){var t="Năm "+(pt-gt+wt);f[0][o]=t;wt++}o++})}else f=i.extra.headerSetting;for(c=i.colWidths,p=[],i.extra.hiddenColumns!=undefined&&(p=i.extra.hiddenColumns),l=0;l<f.length;l++)for(e=0;e<f[0].length;e++)f[l][e]==null&&(f[l][e]="");if(t=null,s=null,n.isCreate||n.model.get("Note")==""?(s=vt,i.extra.xoayObject!=null&&(n.xoayObject=i.extra.xoayObject,t=n.xoayObject)):(s=i.xoayData!=null?JSON.parse(i.xoayData):JSON.parse(this.model.get("Note")),i.xoayObject!=null&&(n.xoayObject=i.xoayObject,t=n.xoayObject)),ni=[],t!=null){for(ft=[],v=null,l=0;l<f.length;l++){for(g=[],e=0;e<f[0].length;e++)t.GiaTriIndex!=e&&(t.CatalogIndex==e?(t.CatalogValues==null||t.CatalogValues.length==0?($.ajaxSetup({async:!1}),$.getJSON("/Admin/Form/GetCatalogValues",{catalogName:t.CatalogType,row:e,col:f.length+1,formId:u.FormId,isXoay:!0},function(n){v=JSON.parse(n.catalogValues);t.CatalogValuesAscii=JSON.parse(n.catalogValuesAscii);t.CatalogValues=v}),$.ajaxSetup({async:!0})):t.CatalogValuesAscii==undefined?($.ajaxSetup({async:!1}),$.getJSON("/Admin/Form/GetCatalogValuesAscii",{strCatalogValues:JSON.stringify(t.CatalogValues)},function(n){v=t.CatalogValues;t.CatalogValuesAscii=JSON.parse(n.catalogValuesAscii)}),$.ajaxSetup({async:!0})):v=t.CatalogValues,_.each(v,function(n){g.push(n)}),t.CatalogCount=v.length):g.push(f[l][e]));ft.push(g)}f=ft}n.nestedHeaders=f;var nt=null,tt=[],it=[],et=[],o=0;if(t!=null?(n.allCatalogValues=[],nt=_.mapObject(h,function(t,i){var r=null,f=i.split("!!");t.TypeHandson=="dropdown"&&($.ajaxSetup({async:!1}),$.getJSON("/Admin/Form/GetCatalogValues",{catalogName:t.CatalogName,row:1,col:1,formId:u.FormId,isXoay:!1},function(t){r=JSON.parse(t.catalogValues);var i=JSON.parse(t.catalogInfos);jQuery.each(i,function(t,i){n.allCatalogValues.push(i)});n.allCatalogValues=_.uniq(n.allCatalogValues)}),$.ajaxSetup({async:!0}))}),$.each(h,function(i,r){var s=i.split("!!"),f,e,u;if(o!=t.GiaTriIndex)if(o==t.CatalogIndex)for(f=t.GiaTriNameAscii+"!!"+t.GiaTriName,e=0;e<t.CatalogCount;e++)u={},u.data=t.CatalogValuesAscii[e],u.type=h[f].TypeHandson,u.readOnly=h[f].ReadOnly,u.allowInvalid=!0,u.validator=new RegExp(h[f].RegEx),u.source=null,u.className=h[f].ReadOnly?"htCenter gray":"htCenter",h[f].TypeName=="Số thực"&&h[f].CatalogName!=""?u.renderer=n._myFormat:h[f].TypeName=="Hình ảnh"&&(u.renderer=n._coverRenderer),tt.push(u),it.push(c[t.CatalogIndex]);else u={},u.data=s[0],u.type=r.TypeHandson,u.readOnly=r.ReadOnly,u.allowInvalid=!0,u.validator=new RegExp(r.RegEx),u.source=v,u.className=r.ReadOnly?"htCenter gray":"htCenter",r.TypeName=="Số thực"&&r.CatalogName!=""?u.renderer=n._myFormat:r.TypeName=="Hình ảnh"&&(u.renderer=n._coverRenderer),tt.push(u),it.push(c[o]);o++}),this.isCreate&&$.each(s,function(n,i){o=0;var r={};Object.keys(i).forEach(function(n){if(o!=t.GiaTriIndex)if(o==t.CatalogIndex)for(var u=0;u<t.CatalogCount;u++)r[t.CatalogValuesAscii[u]]=i[t.GiaTriNameAscii];else _.contains([t.GiaTriNameAscii,t.CatalogNameAscii,"pos"],n)||(r[n]=i[n]);o++});et.push(r)}),et.length>0&&(s=et)):(n.allCatalogValues=[],nt=_.mapObject(h,function(t,i){var f=null,e=i.split("!!"),r;return t.TypeHandson=="dropdown"&&($.ajaxSetup({async:!1}),$.getJSON("/Admin/Form/GetCatalogValues",{catalogName:t.CatalogName,row:1,col:1,formId:u.FormId,isXoay:!1},function(t){f=JSON.parse(t.catalogValues);var i=JSON.parse(t.catalogInfos);jQuery.each(i,function(t,i){n.allCatalogValues.push(i)});n.allCatalogValues=_.uniq(n.allCatalogValues)}),$.ajaxSetup({async:!0})),o++,r={},r.data=e[0],r.type=t.TypeHandson,r.readOnly=t.ReadOnly,r.allowInvalid=!0,r.validator=new RegExp(t.RegEx),r.source=f,r.className=t.ReadOnly?"htCenter gray":"htCenter",t.TypeName=="Số thực"&&t.CatalogName!=""?r.renderer=n._myFormat:t.TypeName=="Hình ảnh"&&(r.renderer=n._coverRenderer),r})),tt.length>0&&(nt=tt),it.length>0&&(c=it),ti=_.mapObject(h,function(n,t){var i=t.split("!!");return i[1]}),w=_.values(nt),n.globalColumns=w,n.fisrt=!0,u.Compilation!=null){var ot=JSON.parse(u.Compilation),rt=JSON.parse(ot.data),r=undefined,st=[];n.model.get("DocumentContents")[0].FormCategoryId==3?(r=JSON.parse(ot.code).summaryConfigJsonForm,rt!=undefined&&r!=undefined&&s.forEach(function(t){rt.forEach(function(i){var f,s,u,e,o;if(r.schema.Form_Compilation_Match_Off==undefined){if(t[r.schema.Form_Compilation_Display_Match.default]!=""&&t[r.schema.Form_Compilation_Display_Match.default]==i[r.schema.Form_Compilation_Target_Match.default.trim()])for(f=Object.keys(r.schema),u=3;u<f.length;u++)e=f[u].replace("Form_",""),r.schema[f[u]].default!=""&&(o=i[r.schema[f[u]].default],t[e]=o)}else if(r.schema.Form_Compilation_Match_Off.default==1){if(t[r.schema.Form_Compilation_Display_Match.default]!=undefined&&t[r.schema.Form_Compilation_Display_Match.default.trim()]==i[r.schema.Form_Compilation_Target_Match.default.trim()])if(n.model.get("DocumentContents")[0].FormCategoryId==3)for(f=Object.keys(r.schema),u=4;u<f.length;u++)e=f[u].replace("Form_",""),r.schema[f[u]].default!=""&&(o=i[r.schema[f[u]].default],t[e]=o);else t[r.schema.Form_Compilation_Display.default]=i[r.schema.Form_Compilation_Select.default]}else if(n.model.get("DocumentContents")[0].FormCategoryId==3){for(f=Object.keys(r.schema),s=JSON.parse(JSON.stringify(t)),u=4;u<f.length;u++)e=f[u].replace("Form_",""),r.schema[f[u]].default!=""&&(o=i[r.schema[f[u]].default],s[e]=o);st.push(s)}else t[r.schema.Form_Compilation_Display.default]=i[r.schema.Form_Compilation_Select.default]})})):n.model.get("DocumentContents")[0].FormCategoryId==2&&(r=JSON.parse(ot.code).targetConfigJsonForm,rt!=undefined&&r!=undefined&&s.forEach(function(n){rt.forEach(function(t){n[r.schema.Form_Compilation_Match.default]!=undefined&&n[r.schema.Form_Compilation_Match.default]==t[r.schema.Form_Compilation_Match.default]&&(n[r.schema.Form_Compilation_Display.default]=t[r.schema.Form_Compilation_Select.default])})}));st.length>0&&(s=st)}if(b=n.$("#divContent"),i.extra.autoSizeColumns!=undefined){var bt=i.extra.autoSizeColumns,kt=0,o=0;_.each(c,function(n){bt[0]!=o&&jQuery.inArray(o,p)==-1&&(kt+=n);o++});c!=null&&(c[bt[0]]=$(`${n.el} div#divContent`).width()-kt-50)}if(_.each(s,function(t){e=0;Object.keys(t).forEach(function(i){if(w[e]!=undefined&&w[e].type=="dropdown"){var r=n.allCatalogValues.filter(n=>n.CatalogKey==t[i]);r.length>0&&r[0].Value!=null&&(t[i]=r[0].Value)}e++})}),y=[],u.FormCode===undefined?y=s:(ht=JSON.parse(u.FormCode).data,ct=0,ht.forEach((n,t)=>{var i=s[t];Object.entries(n).forEach(function(n,t){var r=n[0],i=n[1],u=t;i!=""&&i.length>1&&i.charAt(0)=="="&&i.charAt(0)=="="&&ct++})}),ct>0?ht.forEach((n,t)=>{var r=s[t],i={};Object.entries(n).forEach(function(n,t){var f=n[0],u=n[1],e=t;i[f]=u!=""&&u.length>1&&u.charAt(0)=="="?u.charAt(0)=="="?u:r[f]:r[f]});y.push(i)}):y=s),u.DefineConfigJson!=undefined){var dt=0,k=[],lt=JSON.parse(u.DefineConfigJson).data;for(d=0;d<lt.length;d++)lt[d].forEach(function(t){if(t!=""&&t!=null&&t=="Checkbox"){dt++;var i=n.removeVietnameseTones(lt[d][0]);k.push(i)}});dt>0&&y.forEach(function(n){for(var i,t=0;t<k.length;t++)i=n[k[t]],n[k[t]]=i==1?"true":"false"})}if(n.hotSettings={data:y,mergeCells:i.extra.mergedCells.length==0?!0:i.extra.mergedCells,colHeaders:!0,rowHeaders:!0,columns:w,colWidths:c,nestedHeaders:f,filters:!1,dropdownMenu:!1,className:"htLeft",stretchH:"none",width:"100%",height:"100%",hiddenColumns:{columns:p,indicators:!1},comments:!0,afterSelection:function(n,t,i,r,u){u.value=!0},contextMenu:!0,manualColumnResize:!0,viewportColumnRenderingOffset:500,viewportRowRenderingOffset:1e3,formulas:!0,licenseKey:"non-commercial-and-evaluation",afterChange:function(){arguments[1]=="edit"&&n.dataFormTable.updateSettings({height:$(`${n.el} div#divContent .ht_master .wtHider`).height()})}},typeof b.get(0)!="undefined"){b.get(0).innerHTML="";n.dataFormTable!=null&&n.dataFormTable.destroy();n.dataFormTable=new Handsontable(b.get(0),n.hotSettings);n.dataFormTable.updateSettings({height:$(`${n.el} div#divContent .ht_master .wtHider .htCore`).height()});n.dataFormTable.loadData(s);$(`${n.el} div#divContent`).css("height",$(`${n.el} div#divContent .ht_master .wtHider .htCore`).height());$(`${n.el} div#divContent .ht_master .wtHolder`).css("height",$(`${n.el} div#divContent .ht_master .wtHider .htCore`).height()+($(`${n.el} div#divContent .ht_master .wtHider .htCore`).width()>$(`${n.el} div#divContent`).width()?17:0));n.dataFormTable.addHook("beforePaste",function(n){for(var i,r,u,t=0;t<n.length;t++)for(i=0;i<n[t].length;i++)n[t][i]=n[t][i].trim(),r=n[t][i],r!=undefined&&(n[t][i]=_.unescape(r),u=r.replace(/,/g,""),isNaN(u)||(n[t][i]=u));return n});n.dataFormTable.addHook("afterRender",()=>{for(var o,s,h,e,l,a,r,u,i=n.$("#divContent")[0],v=0,t=1;t<=n.dataFormTable.countCols();t++)u=".ht_clone_top  .wtHolder .wtHider .wtSpreader .htCore >colgroup:nth-child(1) col:nth-child("+(t+1)+")",o=".ht_master  .wtHolder .wtHider .wtSpreader .htCore >colgroup:nth-child(1) col:nth-child("+(t+1)+")",i.querySelectorAll(u)[0]!=undefined&&jQuery.inArray(t-1,p)==-1&&(v+=c[t-1],i.querySelectorAll(u)[0].setAttribute("style","width:"+c[t-1]+"px; height: unset !important"),i.querySelectorAll(o)[0]!=undefined&&i.querySelectorAll(o)[0].setAttribute("style","width:"+c[t-1]+"px; height: unset !important"));if(setTimeout(function(){$(`${n.el} div#divContent .ht_master.handsontable .wtHolder .wtHider`).css("width",v);$(`${n.el} div#divContent .ht_master.handsontable .wtHolder`).css("overflow-y","unset");$(`${n.el} div#divContent .ht_master.handsontable .wtHolder`).css("overflow-x","auto")},10),s=JSON.parse(n.configHandsontable),h=s.headerNested,h.length>0){for(e=[],e=s.extra.headerSetting,l=f.length,a=f[0].length,r=0;r<l;r++)for(t=0;t<a;t++)e[r][t]=!1;for(i=b.get(0),h.forEach(n=>{for(var r,u,t=n.row+n.rowspan;t>n.row;t--)for(r=n.col+n.colspan;r>n.col;r--)u=".ht_clone_top  tr:nth-child("+t+") th:nth-child("+(r+1)+")",t!=n.row+1||r!=n.col+1?i.querySelectorAll(u)[0]!=undefined&&(e[t-1][r-1]=!0):i.querySelectorAll(u)[0]!=undefined&&(i.querySelectorAll(u)[0].setAttribute("rowspan",n.rowspan),i.querySelectorAll(u)[0].setAttribute("colspan",n.colspan),i.querySelectorAll(u)[0].setAttribute("style","vertical-align: middle"))}),r=l;r>0;r--)for(t=a;t>0;t--)u=".ht_clone_top  tr:nth-child("+r+") th:nth-child("+(t+1)+")",e[r-1][t-1]&&i.querySelectorAll(u)[0]!=undefined&&i.querySelectorAll(u)[0].remove()}});ii=n.dataFormTable.getPlugin("comments");Handsontable.hooks.add("beforeOnCellMouseDown",handleHotBeforeOnCellMouseDown,n.dataFormTable);var a=i.classCells,at=[],ut=null;t!=null&&($.each(a,function(n,i){ut=[];$.each(i,function(i){var u,r;if(i!=t.GiaTriIndex)if(i==t.CatalogIndex)for(u=t.GiaTriNameAscii+"!!"+t.GiaTriName,r=0;r<t.CatalogCount;r++)ut.push(a[n][t.GiaTriIndex]);else ut.push(a[n][i])});at.push(ut)}),at.length>0&&(a=at));n.dataFormTable.updateSettings({cells:function(n,t){var r={},f,u;if(i.readOnlys)for(f=i.readOnlys,u=0;u<f.length;u++)f[u].row==n&&f[u].col==t&&(r.readOnly=!0);return a?a==undefined||a.length==0||a.length<=n?r:(r.className=a[n][t],r):r}});n.dataFormTable.validateCells(function(){});n.xoayObject=t}}},_importWord:function(){var n=this;require(["ImportWordView"],function(t){var i=new t({document:n,cid:n.cid})})},_importExcel:function(){var n=this;require(["ImportExcelView"],function(t){var i=new t({document:n})})},_importDataFromExcel:function(n){var f=this,o=f.configHandsontable,s=JSON.parse(o),c=JSON.stringify(s.headerNested),h=n.$uploadFile.get(0),t=h.files,e,i,r,u;if(t.length==1)if(e=t[0],i=e.name,i.indexOf(".xlsx",i-5)!==-1&&i.indexOf(".xls",i-4)!==-1){for(r=new FormData,u=0;u<t.length;u++)r.append(t[u].name,t[u]);r.append("key",$("#ddlYearReport option:selected").val());r.append("HeaderAI",n.headerAI);$.ajax({url:"/Form/GetDataFromExcel",type:"POST",contentType:!1,processData:!1,data:r,success:function(n){var u=f.hotSettings.data.length,e=JSON.parse(n.data).length,o,t,r,i;e>u&&(o="Dữ liệu nhập vào thừa "+(e-u)+" dòng so với dữ liệu ban đầu",egov.pubsub.publish(egov.events.status.error,o));t=JSON.parse(n.data);t.length>0&&t[0].length>0&&t[0][0]!=undefined&&(r=[],i=0,_.each(t,function(n){i=0;var t={};_.each(f.globalColumns,function(r){t[r.data]=n[i];i++});r.push(t)}),t=r);f.dataFormTable.updateSettings({data:t})},error:function(n){alert(n.statusText)}})}else eGovMessage.show("Chỉ được up file xls, xlsx","",eGovMessage.messageButtons.Ok)},_importDataFromWord:function(n){var o=this,s=n.$uploadFile.get(0),t=s.files,e,i,u,r,f;if(t.length==1)if(e=t[0],i=e.name,i.indexOf(".docx",i-5)!==-1&&i.indexOf(".doc",i-4)!==-1){for(u=new FormData,r=0;r<t.length;r++)u.append(t[r].name,t[r]);u.append("key",$("#ddlYearReport option:selected").val());u.append("HeaderAI",n.headerAI);console.time();f=new FileReader;f.onloadend=function(){var n=f.result;mammoth.convertToHtml({arrayBuffer:n}).then(function(n){var t=o.cid+"_explicit_template";CKEDITOR.instances[t].setData(n.value);console.log(n.value)});console.timeEnd()};f.readAsArrayBuffer(e)}else eGovMessage.show("Chỉ được up file doc, docx","",eGovMessage.messageButtons.Ok)},_decodeEntities:function(n){var t=document.createElement("textarea");return t.innerHTML=n,t.value},_showCompareData:function(n){var t=this,r=t.model.get("CommentList"),a=$(n.target).closest("img").data("commentid"),e=$(n.target).closest("img").data("prev-commentid"),s,l,f;if(r.length>1){var o=r.filter(function(n){return n.CommentId===a}),u=o[0],i=null;if(e==0?i=r[r.length-1]:(s=r.filter(function(n){return n.CommentId===e}),i=s[0]),o.length>0&&u.Diff!=undefined&&i.Diff.length>0&&i.Diff!=undefined){var v=document.getElementById("afterData"),y=document.getElementById("beforeData"),h=JSON.parse(i.Diff).Data,c=JSON.parse(u.Diff).Data;t.model.attributes.CategoryBusinessId==8?(l=htmldiff(h,c),document.getElementById("outputdiv").innerHTML=l):($(".lblBeforeData").html("{"+i.CommentId+"} "+i.UserSend.fullname+" "+i.Description),$(".lblAfterData").html("{"+u.CommentId+"} "+u.UserSend.fullname+" "+u.Description),f=t.hotSettings,f.height="300px",f.cells=function(){var n={};return n.editor=!1,n},setTimeout(function(){var n,i;f.data=JSON.parse(h);t.compareFormTable=new Handsontable(y,t.hotSettings);f.data=JSON.parse(c);t.currentFormTable=new Handsontable(v,t.hotSettings);var u=t.compareFormTable.getData(),r=t.currentFormTable.getData(),o=[],e=[],s=r.length>u.length?r.length:u.length;for(n=0;n<s;n++)for(i=0;i<r[0].length;i++)u[n]==undefined?e.push([n,i,"htGreen"]):r[n]==undefined?e.push([n,i,"htRed"]):t.isEmptyValue(u[n][i])&&!t.isEmptyValue(r[n][i])?e.push([n,i,"htGreen"]):!t.isEmptyValue(u[n][i])&&t.isEmptyValue(r[n][i])?e.push([n,i,"htRed"]):t.isEmptyValue(u[n][i])||t.isEmptyValue(r[n][i])||u[n][i]==r[n][i]||(e.push([n,i,"htYellow"]),o.push([n,i,"htYellow"]));_.each(o,function(n){t.compareFormTable.setCellMeta(n[0],n[1],"className",t.compareFormTable.getCellMeta(n[0],n[1]).className+" "+n[2])});_.each(e,function(n){t.currentFormTable.setCellMeta(n[0],n[1],"className",t.currentFormTable.getCellMeta(n[0],n[1]).className+" "+n[2])});t.compareFormTable.render();t.currentFormTable.render();$("#left-content").css("height",Math.max($("#beforeData .ht_master .wtHider .htCore").height(),$("#afterData .ht_master .wtHider .htCore").height()));$("#scroll-left").css("height",300);$("#c2-content").css("width",Math.max($("#beforeData .ht_master .wtHider .htCore").width(),$("#afterData .ht_master .wtHider .htCore").width()));$("#scroll-com").css("width",$("#beforeData").width());$("#scroll-com").on("scroll",function(){$("#afterData .ht_master .wtHolder").scrollLeft($(this).scrollLeft());$("#beforeData .ht_master .wtHolder").scrollLeft($(this).scrollLeft())});$("#scroll-left").on("scroll",function(){$("#afterData .ht_master .wtHolder").scrollTop($(this).scrollTop());$("#beforeData .ht_master .wtHolder").scrollTop($(this).scrollTop())})},500));$("#compareModal").modal("toggle")}}},isEmptyValue:function(n){return n==" "||n==undefined?!0:!1},_renderFormReportList:function(){var n=this.model.get("DocumentContents")[0];if(n!=undefined){var t=n.FormHeader,i=n.FormFooter,u=t.match(/@@(.*?)@@/gm),f=i.match(/@@(.*?)@@/gm),e=$("#ddlYearReport option:selected").val(),r=$("a",$("ul#ulTabs li.active")).attr("href");u!=null&&(_.each(u,function(i){$.ajax({type:"POST",async:!1,url:"/Document/GetDataTemplateKeys",traditional:!0,data:{templateKeyCode:i,formId:n.FormId,timeKey:e},success:function(n){var r,u;n.Success&&(n.Type&&n.Type==4?t=t.replace(value,n.NewValue||""):n.Type&&n.Type==8&&n.result&&(r={},r.data=[],_.each(n.result,function(n){r.data.push(n)}),r.data.length>0?(u=$($.tmpl(`<div> ${n.HtmlTemplate} </div>`,r)),u!=null&&u.length>0&&(t=t.replace(i,u.html()))):t=t.replace(i,"")))}})}),$(`${r} .formHeader`).html(t));f!=null&&(_.each(f,function(t){$.ajax({type:"POST",async:!1,url:"/Document/GetDataTemplateKeys",traditional:!0,data:{templateKeyCode:t,formId:n.FormId,timeKey:e},success:function(n){var r,u;n.Success&&(n.Type&&n.Type==4?i=i.replace(value,n.NewValue||""):n.Type&&n.Type==8&&n.result&&(r={},r.data=[],_.each(n.result,function(n){r.data.push(n)}),r.data.length>0?(u=$($.tmpl(`<div> ${n.HtmlTemplate} </div>`,r)),u!=null&&u.length>0&&(i=i.replace(t,u.html()))):i=i.replace(t,"")))}})}),$(`${r} .formFooter`).html(i));n.ExplicitTemplate&&n.ExplicitTemplate.length>2&&this.initPivot(JSON.parse(n.ExplicitTemplate),r)}},initPivot:function(n,t){_.each(n,function(n){$(`${t} #divContent`).append(`<div id='${t.replace("#","")}_formPivot-${n}'></div>`);$(`${t}_formPivot-${n}`).css("margin-bottom","20px");$.ajax({url:"/ReportViewer/GetReportKeyData",async:!1,beforeSend:function(){},data:{ReportId:n,Time:"TuyChon",FromDate:"2017-01-01T00:00:00",ToDate:"2018-03-01T00:00:00",TreeGroupValue:null,TreeGroupName:null,GroupId:0,sortBy:"",isDesc:!1,Page:1,PageSize:500},success:function(i){var r={dataSource:{data:i},options:{grid:{showTotals:"off",showGrandTotals:"off"}},tableSizes:{columns:[{idx:0,width:468}]}},u=new WebDataRocks({container:`${t}_formPivot-${n}`,toolbar:!1,global:{},report:r})}})})},_decodeBase64:function(n){for(var f={},r=0,e,i,u=0,o,s="",c=String.fromCharCode,h=n.length,t=0;t<64;t++)f["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(t)]=t;for(i=0;i<h;i++)for(e=f[n.charAt(i)],r=(r<<6)+e,u+=6;u>=8;)((o=r>>>(u-=8)&255)||i<h-2)&&(s+=c(o));return s},_renderFormExplicit:function(){function o(){var v=$("<div>"),t=$("<ol>"),i,y,h,c,l,a;t.appendTo(v);var p=CKEDITOR.instances[n.cid+"_explicit_template"],s=p.editable().find("h1,h2,h3,h4,h5,h6"),u=1,w=s.count();for(i=0;i<w;++i){var r=s.getItem(i),f=r.getText(),e=parseInt(r.getName().substr(1,1)),o=e-u;if(i===0&&(o=0,u=e),o>0&&(y=t.children().last(),h=$("<ol>"),h.appendTo(y),t=h,u=e),o<0){while(0!=o++)parent=t.parent().parent(),c=parent.prop("tagName"),t=c!=null&&c.toLowerCase()==="ol"?parent:t;u=e}(f==null||f.trim()==="")&&(f="&nbsp;");l=$('<a href="#" data-index="'+i+'">'+f+"<\/a>");l.on("click",function(t){var f,i,u,e,o;t.preventDefault();f=this.dataset.index;r=s.getItem(f);r.scrollIntoView();i=CKEDITOR.instances[n.cid+"_explicit_template"];u=i.getSelection();u.selectElement(r);e=u.getRanges()[0];o=new CKEDITOR.dom.range(e.document);o.moveToPosition(r,CKEDITOR.POSITION_BEFORE_START);i.focus()});a=$("<li>");l.appendTo(a);a.appendTo(t)}return v}var f=this.model.get("DocumentContents")[0],n,t,u,i,e,r;if(f!=undefined){if(n=this,t=f.ExplicitTemplate,n.FormId=f.FormId,n.isCreate){if(u=n.$el.find("#ddlYearReport option:selected").val(),n.findKyBaoCao(n.model.get("DocTypeId"))!=6){const t=n.$el.find(".timeKey").filter(":not(.hidden)");_.each(t,function(t){const i=(n,t)=>String(n).padStart(t,"0");u+=n.findKyBaoCao(n.model.get("DocTypeId"))==2||n.findKyBaoCao(n.model.get("DocTypeId"))==3?t.value:i(n.findKyBaoCao(n.model.get("DocTypeId"))==4?parseInt(t.value)+1:t.value,2)})}else u=n.formatDateTimeKey(n._getDate("DatePublished"));i=t.match(/@@(.*?)@@/gm)?t.match(/@@(.*?)@@/gm):[];i=i||[];_.each(t.match(/##(.*?)##/gm),function(n){i.push(n)});i.length>0&&_.each(i,function(i){$.ajax({type:"POST",async:!1,url:"/Document/GetDataTemplateKeys",traditional:!0,data:{templateKeyCode:i,formId:n.FormId,timeKey:u},success:function(n){var r,u;n.Success?n.Type&&(n.Type==4||n.Type=="default")?t=t.replace(i,n.NewValue||""):n.Type&&n.Type==8&&n.result&&(r={},r.data=[],_.each(n.result,function(n){r.data.push(n)}),r.data.length>0?(u=$($.tmpl("<div>"+n.HtmlTemplate+"<\/div>",r)),u!=null&&u.length>0&&(t=t.replace(i,u.html()))):t=t.replace(i,"")):t=t.replace(i,"")}})})}else t=n.model.get("DocumentContents")[0].Content;e=n.$("#divContent")[0];r=document.createElement("textarea");r.className="aaaa";r.style="width: 100%";r.id=n.cid+"_explicit_template";r.rows="800";e.appendChild(r);CKEDITOR.editorConfig=function(n){n.language="vi-vn";n.uiColor="#F7B42C";n.height=200;n.toolbarCanCollapse=!0;n.removePlugins="image,forms";n.extraPlugins="showborders, ruler, highcharts"};CKEDITOR.replace(n.cid+"_explicit_template",{height:400,allowedContent:!0,extraPlugins:"ruler, showborders, highcharts"});CKEDITOR.config.ruler={values:21,step:.25,sliders:{left:2,right:19},padding:{top:20,bottom:20}};CKEDITOR.instances[n.cid+"_explicit_template"].setData(t);$(n.el+" .document-navigation").show();$(n.el+" .toggle-navigation").css("display","flex");$(n.el+" #divContent").css("min-width","unset");CKEDITOR.instances[n.cid+"_explicit_template"].on("instanceReady",function(t){var i=o();i.appendTo($(n.el+" .document-navigation-content"));t.editor.dataProcessor.htmlFilter.addRules({elements:{p:function(n){var t="font-family:Times New Roman,Times,serif";n.attributes.style?n.attributes.style.indexOf("font-family")<0?n.attributes.style+=";"+t:n.attributes.style=n.attributes.style.replace(/font-family:[^;]*(;?)/,`${t}$1`):n.attributes.style=t}}})});CKEDITOR.instances[n.cid+"_explicit_template"].on("change",function(){var t=o();t.appendTo($(n.el+" .document-navigation-content").empty())});$(n.el+" .toggle-navigation-btn").on("click",function(){$(n.el+" .toggle-navigation").hasClass("show-nav")?($(n.el+" .toggle-navigation").removeClass("show-nav").addClass("hide-nav"),$(n.el+" .document-navigation").css("max-width",0),setTimeout(function(){$(n.el+" .document-navigation").hide()},500)):($(n.el+" .toggle-navigation").removeClass("hide-nav").addClass("show-nav"),$(n.el+" .document-navigation").show(),setTimeout(function(){$(n.el+" .document-navigation").css("max-width","100%")},0))})}},addRow_HT:function(){var n=this,i=n.dataFormTable.countRows(),s=n.dataFormTable.getData(),u=n.model.get("DocumentContents")[0],f=JSON.parse(u.DefineConfigJson),e=JSON.parse(u.DefineFieldJson),o=e.data.length,r={readOnly:!1,className:"htCenter",source:"",type:"text"},t;for(n.dataFormTable.alter("insert_row",i,1),t=0;t<n.dataFormTable.countCols();t++)r.source=n.dataFormTable.getCellMeta(i-1,t).source,r.type=n.dataFormTable.getCellMeta(i-1,t).type,n.dataFormTable.setDataAtCell(i,t,f.data[t][o+2].toString()),n.dataFormTable.setCellMetaObject(i,t,r);n.dataFormTable.render()},showLeaf:function(){var n=this;n._viewLeaf()},_viewLeaf:function(n){var i=this,r=$("#viewLeaf"),t=this.model.get("DocumentId");n&&(t=n);require(["TreeView"],function(n){console.log("doc2"+t);var r=new n({DocumentId:t,document:i})})},merge_HT:function(){var n=this,t=n.dataFormTable.getSelected()},exportCSV_HT:function(){},viewBCTH_HT:function(){var n=this;egov.views.home.tab.addReportBCTH()},changePeriod:function(){for(var t,w,b,k,d,u,l,f,r,o,n=this,a=n.$el.find("#datebykybaocao option"),c=0;c<a.length;c++)a[c].disabled=!1;var i="",v=n.model.get("DocTypeId"),h=n.model.get("ActionLevel"),e=n.$el.find("#ddlYearReport option:selected").val(),s=[];if(h==1){if(f=this.model.get("DocumentContents")[0],f==undefined)return;t=n.model.get("ProcessInfo");n.isCreate&&(t=f.FormCode);n.configHandsontable=t;t=JSON.parse(t);s=t.extra.headerSetting;var g=5,y=0,p=0;s[0].forEach(function(n){if(n.charAt(0)=="$"){var t="Năm "+(e-g+y);s[0][p]=t;y++}p++})}else{if(f=this.model.get("DocumentContents")[0],f==undefined)return;t=n.model.get("ProcessInfo");n.isCreate&&(t=f.FormCode);n.configHandsontable=t;t=JSON.parse(t);s=t.extra.headerSetting}if(egov.setting.transfer.iscreatedform==!0){switch(h){case 1:i=e;e="2";break;case 2:w=n.$el.find("#bcnuanam").val();i=e+""+w;break;case 3:b=n.$el.find("#bcquy").val();i=e+""+b;break;case 4:k=n.$el.find("#bcthang").val();u=Number(k)+1;u<10&&(u="0"+u);i=e+""+u;break;default:d=n.$el.find("#bc9thang").val();u=Number(d);u<10&&(u="0"+u);i=e+""+u}l="";egov.dataManager.getDepartmentsCurrent({success:function(t){var i=n.model.get("InOutPlace");l=t[0].EdocId}});$.ajax({url:"/Document/GetListToDoctype",type:"GET",async:!1,data:{doctypeId:v,organizationCode:l,timeKey:i,year:e},success:function(t){var f,e,o,s,a,c,r,u,v,l,i;if(t!=null){f=n.$el.find("#ddlYearReport option:selected").val();switch(h){case 1:for(f=n.$el.find("#ddlYearReport option"),i=0;i<f.length;i++)for(r=0;r<t.length;r++)f[i].value==t[r].timekey&&(f[i].disabled=!0);break;case 2:for(e=n.$el.find("#bcnuanam option"),i=0;i<e.length;i++)for(r=0;r<t.length;r++)f+""+e[i].value==t[r].timekey&&(e[i].disabled=!0);break;case 3:for(o=n.$el.find("#bcquy option"),i=0;i<o.length;i++)for(r=0;r<t.length;r++)f+""+o[i].value==t[r].timekey&&(o[i].disabled=!0);break;case 4:for(s=n.$el.find("#bcthang option"),i=0;i<s.length;i++)for(r=0;r<t.length;r++)u=Number(s[i].value)+1,u<10&&(u="0"+u),a=f+""+u,a==t[r].timekey&&(s[i].disabled=!0);break;default:for(c=n.$el.find("#bc9thang option"),i=0;i<c.length;i++)for(r=0;r<t.length;r++)u=Number(c[i].value)+1,u<10&&(u="0"+u),v=f+""+u,v==t[r].timekey&&(c[i].disabled=!0)}console.log(JSON.stringify(t))}else{for(l=n.$el.find("#datebykybaocao option"),i=0;i<l.length;i++)l[i].disabled=!1;console.log("Khong co du lieu")}}})}if(h==6)i=n.$el.find(".bcngayplus").first().val().replace(/(\d{2})\/(\d{2})\/(\d{4})/,"$3$2$1");else{i=n.$el.find("#ddlYearReport option:selected").val();const t=n.$el.find(".timeKey").filter(":not(.hidden)");_.each(t,function(t){const r=(n,t)=>String(n).padStart(t,"0");i+=n.findKyBaoCao(n.model.get("DocTypeId"))==2||n.findKyBaoCao(n.model.get("DocTypeId"))==3?t.value:r(n.findKyBaoCao(n.model.get("DocTypeId"))==4?parseInt(t.value)+1:t.value,2)})}if(n.model.attributes.CategoryBusinessId==8){if(f=this.model.get("DocumentContents")[0],f==undefined)return;r=f.ExplicitTemplate;o=r.match(/@@(.*?)@@/gm)?r.match(/@@(.*?)@@/gm):[];o=o||[];_.each(r.match(/##(.*?)##/gm),function(n){o.push(n)});o.length>0&&(_.each(o,function(t){$.ajax({type:"POST",async:!1,url:"/Document/GetDataTemplateKeys",data:{templateKeyCode:t,formId:n.FormId,timeKey:i},success:function(n){var i,u;n.Success?n.Type&&(n.Type==4||n.Type=="default")?r=r.replace(t,n.NewValue||""):n.Type&&n.Type==8&&n.result&&(i={},i.data=[],_.each(n.result,function(n){i.data.push(n)}),u=$($.tmpl("<div>"+n.HtmlTemplate+"<\/div>",i)),u!=null&&u.length>0&&(r=r.replace(t,u.html()))):r=r.replace(t,"")}})}),CKEDITOR.instances[n.cid+"_explicit_template"].setData(r,function(){this.checkDirty()}))}else $.ajax({url:"/Document/GetCompilationData",data:{docTypeId:v,timeKey:i},type:"GET",success:function(t){var r,e,a,v,h;if(t.success&&(r=n.model.get("DocumentContents")[0],r.Compilation!=null)){var u=null,r=n.model.get("DocumentContents")[0],c=r.FormCode;c=JSON.parse(c);u=c.data;var p=JSON.parse(r.Compilation),f=JSON.parse(t.data),i=undefined,l=[];if(n.model.get("DocumentContents")[0].FormCategoryId==3?(i=JSON.parse(p.code).summaryConfigJsonForm,f!=undefined&&i!=undefined&&(i.schema.Form_Compilation_Match_Off!=undefined&&i.schema.Form_Compilation_Match_Off.default!=1?f.forEach(function(n){var r=Object.keys(c.header),u=JSON.parse(JSON.stringify(i.schema)),e=["Form_Compilation_Display_Match","Form_Compilation_Match_Off","Form_Compilation_Target_Match","Form_sql"],f,t;const o=Object.keys(u).filter(n=>!e.includes(n)).reduce((n,t)=>(n[t]=u[t],n),{});for(f={},t=0;t<r.length;t++){const i=Object.keys(u).filter(n=>n=="Form_"+r[t].split("!!")[0]);f[r[t].split("!!")[0]]=i.length>0?n[u[i[0]].default]:""}l.push(f)}):u.forEach(function(n){var r,t,u;if(f.length>0)f.forEach(function(t){var u,r,f,e;if(i.schema.Form_Compilation_Match_Off==undefined){if(n[i.schema.Form_Compilation_Display_Match.default]!=""&&n[i.schema.Form_Compilation_Display_Match.default.trim()]==t[i.schema.Form_Compilation_Target_Match.default.trim()])for(u=Object.keys(i.schema),r=3;r<u.length;r++)f=u[r].replace("Form_",""),i.schema[u[r]].default!=""&&(e=t[i.schema[u[r]].default],n[f]=e)}else if(i.schema.Form_Compilation_Match_Off.default==1&&n[i.schema.Form_Compilation_Display_Match.default]!=""&&n[i.schema.Form_Compilation_Display_Match.default.trim()]==t[i.schema.Form_Compilation_Target_Match.default.trim()])for(u=Object.keys(i.schema),r=4;r<u.length;r++)f=u[r].replace("Form_",""),i.schema[u[r]].default!=""&&(e=t[i.schema[u[r]].default],n[f]=e)});else for(r=Object.keys(i.schema),t=3;t<r.length;t++)u=r[t].replace("Form_",""),i.schema[r[t]].default==""||n[u]==undefined||n[u].toString().startWith("=")||(n[u]=0)}))):n.model.get("DocumentContents")[0].FormCategoryId==2&&(i=JSON.parse(p.code).targetConfigJsonForm,f!=undefined&&i!=undefined&&u.forEach(function(n){f.length>0?f.forEach(function(t){n[i.schema.Form_Compilation_Match.default]!=undefined&&n[i.schema.Form_Compilation_Match.default]==t[i.schema.Form_Compilation_Match.default]&&(n[i.schema.Form_Compilation_Display.default]=t[i.schema.Form_Compilation_Select.default])}):n[i.schema.Form_Compilation_Display.default]=0})),l.length>0&&(u=l),e=[],r.FormCode===undefined?e=u:(a=JSON.parse(r.FormCode).data,v=0,a.forEach((n,t)=>{var i=u[t];Object.entries(n).forEach(function(n,t){var r=n[0],i=n[1],u=t;i!=""&&i.length>1&&i.charAt(0)=="="&&i.charAt(0)=="="&&v++})}),v>0?a.forEach((n,t)=>{var r=u[t],i={};Object.entries(n).forEach(function(n,t){var f=n[0],u=n[1],e=t;i[f]=u!=""&&u.length>1&&u.charAt(0)=="="?u.charAt(0)=="="?u:r[f]:r[f]});e.push(i)}):e=u),r.DefineConfigJson!=undefined){var w=0,o=[],y=JSON.parse(r.DefineConfigJson).data;for(h=0;h<y.length;h++)y[h].forEach(function(t){if(t!=""&&t!=null&&t=="Checkbox"){w++;var i=n.removeVietnameseTones(y[h][0]);o.push(i)}});w>0&&e.forEach(function(n){for(var i,t=0;t<o.length;t++)i=n[o[t]],n[o[t]]=i==1?"true":"false"})}n.dataFormTable.updateSettings({nestedHeaders:s,data:e,formulas:!0})}}});n.renderWarningCompilation()},_renderAttachment:function(){var n=this;(this.isCreate||this.isOnlineRegistration)&&this.$(".attachment-download-all").hide();require(["docAttachment"],function(t){var i=new egov.models.attachmentCollection(n.model.get("Attachments"));n.attachments=new t({hasPermission:n.isCreate||n.model.get("UserCurrentId")==egov.userId||n.hasUpdatePermission,model:i,el:n.$("#wrapAttachment"),documentId:n.model.get("DocumentId"),documentCopyId:n.model.get("DocumentCopyId"),storePrivateId:n.model==undefined?null:n.model.get("StorePrivateId")})})},_downloadAllAttachment:function(n){!n||this.isCreate||this.isOnlineRegistration||(egov.helper.destroyClickEvent(n),this.attachments&&this.attachments.downloadAllAttachment())},_renderSupplementary:function(){var n=this;require(["supplementaryList"],function(t){n.supplementaryList=new t({supplementary:n.model.get("SupplementaryModel"),document:n,el:n.$("#wrapSupplementary")})})},_renderRelation:function(){var n=this;require(["docRelation"],function(t){var i=new egov.models.relationList(n.model.get("RelationModels")),r;n.model.set("Relations",i);r=n.isCreate||n.model.get("UserCurrentId")===egov.userId&&n.model.get("Status")===2;n.relations=new t({document:n.model,hasPermission:r,model:i,el:n.$("#wrapDocumentRelation")})})},_approve:function(n){var t=n?egov.resources.document.hsmc.resultOk:egov.resources.document.hsmc.resultDeny;this.model.set({IsSuccess:n?!0:!1})},_removeApprove:function(){this.$(".documentResult").text(egov.resources.document.hsmc.noResult);this.$(".documentResult").removeClass("yes no");this.$("input[name='IsSuccess']").val(null);this.$(".removeApprove").hide()},_changeDocumentFormView:function(){this.hasMinTemplate=!this.hasMinTemplate;this.$("#btnToggleForm").find("span").last().text(this.hasMinTemplate?"Đầy đủ":"Thu gọn");var n=this.hasMinTemplate?this.minTemplate:this.fullTemplate;egov.formtemplate.view.load(this.$(".document-info-template"),n);this._parseDateControl();return},_renderTemplateByConfig:function(){var n=this,i,t;this.getDocumentTemplate();this.$("#btnToggleForm").find("span").last().text(this.hasMinTemplate?"Đầy đủ":"Thu gọn");i=this.isHsmc?this.fullTemplate:this.hasMinTemplate?this.minTemplate:this.fullTemplate;egov.formtemplate.view.load(this.$(".document-info-template"),i);t=egov.setting.allDoctypes.find(function(t){return t.DocTypeId==n.model.get("DocTypeId")});t&&egov.request.getCatalog({data:{docfieldId:t.DocFieldId},success:function(t){var u,i,r,f;t.error||(u=$.tmpl('<label class="control-label">${CatalogName}<\/label><div class="control-value"><select class="form-control catalog-name" data-name="${CatalogKey}" name="catalog_${CatalogKey}" id="">{{each CatalogValues}}<option value="${Value}">${Value}<\/option>{{/each}}<\/select><\/div>',t.data),n.$("#catalogContent").html(u),i=n.model.get("Address"),i&&(r=JSON.parse(i),f=_.keys(r),_.each(f,function(t){n.$("#catalogContent").find("[data-name='"+t+"']").val(r[t])})))}})},_renderCatalog:function(){},_setFocus:function(){var n=this;setTimeout(function(){if(n.categoryBusinessId===4){n.$("#wrapCitizenName input").focus();return}if(n.isCreate){var t=n.$('table #wrapCompendium textarea, table input[name="Organization"]').first();t&&(t.focus(),t.prop("selectionStart",t.val().length),t[0].setSelectionRange(0,t.val().length))}else n.$("#wrapComment textarea").focus()},300)},_renderCommonComments:function(){var n=this;egov.dataManager.getCommonComment({success:function(t){if(egov.isMobile){var i=n.$("#commonCommentList");i.empty();i.append($.tmpl('<li class="mdl-menu__item">${$data}<\/li>',t));i.find("li").click(function(){n.$("#Comment").val($(this).text())});return}egov.dataManager.getTemplateComments({success:function(i){i=_.pluck(i,"Content");i=_.filter(i,function(n){return t.indexOf(n)==-1});i.length>0&&(_.each(i,function(n){t.push(n)}),egov.dataManager.addCommonComment(t,!0));n._renderAutocomplete(t)}});egov.isMobile&&egov.mobile.materialReset()}})},_renderAutocomplete:function(n){this.$Comment=this.$("[name='Comment']");var t=this,i;this.$Comment.length>0&&(i=this.$Comment[0].offsetWidth,t.$Comment.autocomplete({source:function(t,i){for(var f,e=egov.utilities.string.stripVietnameseChars(t.term).toLowerCase(),u=[],r=0;r<n.length;r++)f=egov.utilities.string.stripVietnameseChars(n[r]).toLowerCase(),f.indexOf(e)!=-1&&u.push(n[r]);i(u)},autoFocus:!0,autoSelectFirst:!0}).data("autocomplete")._renderItem=function(n,t){return n.addClass("dropdown-menu"),$("<li>").data("item.autocomplete",t).append("<a href='#' style='white-space: initial;width:"+i+"px'>"+t.value+"<\/a>").appendTo(n)});t.$("[name='Organization']").length>0&&egov.dataManager.getAllAddress({success:function(n){var i=_.map(n,function(n){return n.Name});t.$("[name='Organization']").autocomplete({source:i,minLength:2,autoFocus:!0,focus:function(){return!1},select:function(n,i){t.$("[name='Organization']").val(i.item.label);n.preventDefault()}}).data("autocomplete")._renderItem=function(n,t){return n.addClass("dropdown-menu"),$("<li>").data("item.autocomplete",t).append("<a href='#' style='white-space: initial;'>"+t.value+"<\/a>").appendTo(n)}}});t.$("[name='DocCode']").length>0&&(t.$("[name='DocCode']").on("keydown",function(n){n.keyCode===$.ui.keyCode.TAB&&$(this).autocomplete("instance").menu.active&&n.preventDefault()}).autocomplete({minLength:0,source:function(n,i){var r=_.last(n.term.split("/")),u=t.$("[name='Organization']").val(),f=egov.setting.codeNotations[u];i($.ui.autocomplete.filter(f,r))},focus:function(){return!1},select:function(n,t){var i=this.value.split("/");return i.pop(),i.push(t.item.value),this.value=i.join("/"),!1}}).data("autocomplete")._renderItem=function(n,t){return n.addClass("dropdown-menu"),$("<li>").data("item.autocomplete",t).append("<a href='#' style='white-space: initial;'>"+t.value+"<\/a>").appendTo(n)})},_renderEventQuickView:function(){var n,t;this.$tabQuickView=this.$(".tabs-quickview");this.$documentInfo=this.$(".document-info");n=this.$documentInfo.find("form .detail-content>ul>li:not(.display)");n.hide();t=this.$documentInfo.find("ul:first").attr("data-tabs");this.$("."+t).show()},_renderTitleContent:function(){var n,r;this.$titleContent=this.$("#titleContent tbody");var t=this.model.get("DocumentContents"),u=t.length,i=this;for(n=0;n<u;n++)r=a(t[n].DocumentContentId,t[n].ContentName,function(n){i.editContent(n)}),i.$titleContent.append(r)},_addCommentCommon:function(n,t){if(n){if(typeof n=="string"){if(n==null||n=="")return}else if(n.length<=0)return;typeof n=="string"&&(n=v(n));egov.dataManager.addCommonComment(n,!1,{success:function(){egov.callback(t)}})}},_openDialogCommon:function(n){if(n){var t=$(n.target),i=this;t.attr("disabled","disabled");this.$Comment=this.$("[name='Comment']");require(["templateComment"],function(n){new n({callbackInsertComments:function(n){var t=i.$Comment.val();t?t+="\n"+n:t=n;i.$Comment.val(t)},callbackEnableButton:function(){t.removeAttr("disabled")}})})}},anticipate:function(){var n=this;require(["anticipate"],function(t){egov.anticipate=new t;egov.anticipate.render({parent:n,documentCopyId:n.model.get("DocumentCopyId"),doctypeId:n.model.get("DocTypeId")})})},finishAndPublishData:function(){},transferPlan:function(n,t){var i=this,r,u;this.$Comment=this.$Comment||$();r=this.$Comment.val();u=n;i.relations.confirmRelations(function(){i.attachments.confirmAttachments(function(){require(["transfer"],function(n){egov.transferForm=new n;egov.transferForm.render({action:u,document:i,plan:t,callback:function(){i._addCommentCommon(r)}})})})})},getDestinationPlan:function(){var n="";return egov.anticipate&&(n=egov.anticipate.getDestinationPlan()),n},comfigPublishmentPlan:function(){var n=this;require(["publishmentView"],function(t){egov.publishmentPlan=new t;egov.publishmentPlan.render({document:n,isPlan:!0})})},publishmentPlan:function(n,t){n&&typeof n=="object"||egov.pubsub.publish(egov.events.status.error,egov.resources.document.configError);var i=this;this.attachments.confirmAttachments(function(){require(["publishmentView"],function(r){egov.publishmentPlan=new r;egov.publishmentPlan.render({document:i,plan:n,isPlan:t})})})},_initHsmc:function(){(this.isHsmc=this.model.get("CategoryBusinessId")===egov.enum.categoryBusiness.hsmc,this.isHsmc)&&((!this.isCreate||!this.model.get("WorkflowTypes")||this.model.get("WorkflowTypes").length<=1)&&this.$(".changeWorkflowType").hide(),this.$("[name='DateAppointed']").datepicker({onSelect:function(n){that.$("[name='DateAppointed']").val(n.format("HH:mm dd/MM/yyyy"))}}),this.$newPaper=this.$(".papers.ul-papers>li:last-child").clone(!0),this.$newFee=this.$(".fees.ul-fees>li:last-child").clone(!0),this._calPrice(),egov.isMobile||(this._autocompleteCitizen(),egov.setting.onlineRegistration&&egov.setting.onlineRegistration.Active&&this._renderQuestionList()))},_parseDateControl:function(){var n=this;setTimeout(function(){var r,u,i,f,e,o,t,s;this.$(".datepicker").not("[name='DateAppointed']").datepicker().datepicker("setDate",null);r=this.isCreate?new Date:Date.parse(this.model.get("DateCreated"));this.$("#tableLayout [name='DateCreated']").datepicker("setDate",r);u=this.isCreate?new Date:Date.parse(this.model.get("DateArrived"));this.$("#tableLayout [name='DateArrived']").datepicker("setDate",u);i=this.isCreate?new Date:Date.parse(this.model.get("DatePublished"));this.$("#tableLayout [name='DatePublished']").datepicker("setDate",i);f=this.isCreate?new Date:Date.parse(this.model.get("DateResponse"));this.$("#tableLayout [name='DateResponse']").datepicker("setDate",f);this.$("#tableLayout [name='DateAppointed']").datepicker({onSelect:function(n,t){t.input.val((new Date).format("HH:mm ")+n)}});e=this.model.get("DateAppointed")==""||this.model.get("DateAppointed")==null?"":Date.parseFromIsoString(this.model.get("DateAppointed")).format("HH:mm dd/MM/yyyy");this.$("#tableLayout [name='DateAppointed']").val(e);o=Date.parse(this.model.get("DateOverdue"));this.$("#tableLayout [name='DateOverdue']").datepicker("setDate",o);this.renderDatePublished(i);this.renderInOutPlace();t=this.model.get("DocumentContents")!=undefined?this.model.get("DocumentContents")[0]:{};s=this.model.get("ProcessInfo");n.isCreate?this.model.get("DocumentContents").length!=0&&(s=t.FormCode):this.model.get("DocumentContents").length!=0&&(t.ExplicitTemplate=this.model.get("DocumentContents")[0].Content);this.model.attributes.CategoryBusinessId==16?this._renderFormReportList():this.model.attributes.CategoryBusinessId==8?this.model.get("DocumentContents").length!=0&&t.ExplicitTemplate!=undefined&&this._renderFormExplicit():this.model.attributes.CategoryBusinessId==4?(this._renderHeaderFooterForm(),this._renderFormHandsonPlus(),this.changePeriod()):this.model.attributes.CategoryBusinessId==32?this._renderSurveyContent():this._renderFormHandson();this.renderWarningCompilation()}.bind(this),500)},findKyBaoCao:function(n){var r=this,n=this.model.get("DocTypeId"),i=egov.setting.allDoctypes,t=_.find(i,function(t){return t.DocTypeId==n});return t?t.ActionLevel:1},renderInOutPlace:function(){var n=this;require(["/scripts/bkav.egov/libs/select2/select2.min.js"],function(){n.$("#InOutPlace").select2()})},renderDatePublished:function(n){var t=this,i=t.findKyBaoCao();t.showDatePublished(i,n);t.isCreate||(t.$el.find("#kybaocao .timeKey").attr("disabled","disabled"),t.$el.find("#ddlYearReport").attr("disabled","disabled"))},showDatePublished:function(n,t){var e=this,f,r,i,u;n!=6&&(f='<option value="${value}">${name}<\/option>',this.$("#tableLayout [name='DatePublished']").hide(),this.$("#datebykybaocao").removeClass("hidden"),this.$("#ddlYearReport").val(t.getFullYear()),n==1?this.$("#ddlYearReport").css({width:"100%"}):(this.$("#kybaocao").removeClass("hidden"),n==2&&(this.$("#bcnuanam").removeClass("hidden"),i=t.getMonth(),r=Math.floor(i/6+1),this.$("#bcnuanam").val(r)),n==3&&(this.$("#bcquy").removeClass("hidden"),i=t.getMonth(),r=Math.floor(i/3+1),this.$("#bcquy").val(r)),n==4&&(this.$("#bcthang").removeClass("hidden"),i=t.getMonth(),this.$("#bcthang").val(i)),n==5&&(this.$("#bctuan").removeClass("hidden"),u=t.weekOfYear(),this.$("#bctuan").val(u)),n==8&&(this.$("#bc9thang").removeClass("hidden"),this.$("#bc9thang").val(9))))},serializeDatePublished:function(n){var i=this,t,u,r,f,s;if(n==6)return i.TimeKey=i.formatDateTimeKey(i._getDate("DatePublished")),i._getDate("DatePublished");if(this.$("#tableLayout [name='DatePublished']").hide(),t=this.$("#ddlYearReport").val(),n==1)return i.TimeKey=t+"",new Date(t,1,1).toServerString();if(n==2)return u=this.$("#bcnuanam").val(),i.TimeKey=t+""+u,r=(Number(u)-1)*6+1,new Date(t,r,1).toServerString();if(n==3)return u=this.$("#bcquy").val(),i.TimeKey=t+""+u,r=(Number(u)-1)*3+1,new Date(t,r,1).toServerString();if(n==4)return this.$("#bcthang").val(),r=this.$("#bcthang").val(),f=Number(r)+1,f<10&&(f="0"+f),i.TimeKey=t+""+f,new Date(t,Number(r),1).toServerString();if(n==5){var o=this.$("#bctuan").val(),h=Number(o)*7+1,e=Number(o);return e<10&&(e="0"+e),i.TimeKey=t+""+e,s=1+(e-1)*7,new Date(t,0,s).toServerString()}if(n==8)return i.TimeKey=t+"09",new Date(t,9,1)},formatDate:function(n){var r=new Date(n),t=""+(r.getMonth()+1),i=""+r.getDate(),u=r.getFullYear();return t.length<2&&(t="0"+t),i.length<2&&(i="0"+i),[u,t,i].join("-")},formatDateTimeKey:function(n){var r=new Date(n),t=""+(r.getMonth()+1),i=""+r.getDate(),u=r.getFullYear();return t.length<2&&(t="0"+t),i.length<2&&(i="0"+i),[u,t,i].join("")},_changeDateAppoint:function(n){var t=$(n.target).closest("#ddlDateAppointRange"),i=t.val();this._getDateAppointed(i,this.model.get("DateCreated"))},_openDocFee:function(){var i;this.$(".ul-fees").toggleClass("hidden");return;var n,t},_openDocPaper:function(){var i;this.$(".ul-papers").toggleClass("hidden");return;var n,t},_deleteDocPaper:function(n){var i=$(n.target).closest("a"),r=i.attr("value"),t=this;egov.request.deleteDocPaper({data:{id:r},beforeSend:function(){i.remove()},success:function(n){if(n.error){egov.pubsub.publish(egov.events.status.error,egov.resources.document.deleteDocPaperError);return}t.docPapers=_.reject(t.docPapers,function(n){return n.DocPaperId==r});t.model.set("DocPapers",t.docPapers)}})},_deleteDocTypePaper:function(n){var t=$(n.target).closest("span.delete-paper"),i=t.attr("value"),r=this.model.get("DocTypeId");egov.request.deleteDoctypePaper({data:{doctypeId:r,paperId:i},beforeSend:function(){t.parents("li.doc-paper").remove()},success:function(n){if(n.error){egov.pubsub.publish(egov.events.status.error,egov.resources.document.deleteDocPaperError);return}}})},_deleteDocFee:function(n){var i=$(n.target).closest("a"),r=i.attr("value"),t=this;egov.request.deleteDocFee({data:{id:r},beforeSend:function(){i.remove()},success:function(n){if(n.error){egov.pubsub.publish(egov.events.status.error,egov.resources.document.deleteDocFeeError);return}t.docFees=_.reject(t.docFees,function(n){return n.DocFeeId==r});t.model.set("DocFees",t.docFees)}})},_deleteDocTypeFee:function(n){var t=$(n.target).closest("span.delete-fee"),i=t.attr("value"),r=this.model.get("DocTypeId");egov.request.deleteDoctypeFee({data:{doctypeId:r,feeId:i},beforeSend:function(){t.parents("li.doc-fee").remove()},success:function(n){if(n.error){egov.pubsub.publish(egov.events.status.error,egov.resources.document.deleteDocFeeError);return}}})},_changePaper:function(n){if(this.isHsmc){var t=$(n.target).closest(".paper-name"),r=t.parents(".new-paper"),i=t.val();String.isNullOrEmpty(i)&&$(".new-paper").not(i).remove()}},_addPaper:function(n){if(this.isHsmc){var t=this.$(n.target),i=t.parent("li");if(i.is(":last-child")){this.$(".ul-papers").append(this.$newPaper.clone(!0));return}t.val()||i.siblings(":last-child").remove()}},_addFee:function(n){if(this.isHsmc){var t=this.$(n.target),i=t.parent("li");if(i.is(":last-child")){this.$(".ul-fees").append(this.$newFee.clone(!0));return}t.val()||i.siblings(":last-child").remove()}},_calPrice:function(){if(this.isHsmc){var i,r,n=0,u,t=0;u=this.$(".fee-price");u.each(function(){i=$(this).siblings(".fee-id").is(":checked");r=$(this).siblings(".fee-name").val()||$(this).siblings(".fee-name").text();t=$(this).val();t&&(n=n+(i&&r?parseInt(t):0))});n=n+egov.setting.moneyFormat;this.$("#totalFee").text(n)}},_changeDateCreated:function(){var n=this,t,f,u,e,i,r,o;u=new Date(n.model.get("DateCreated"));e=n.model.get("DelayReason");o=n.$("#ddlDateAppointRange").val();f={title:egov.resources.document.changeDateCreatedDialog.title,width:"500px",draggable:!0,keyboard:!0,height:"auto",buttons:[{id:"changeDateCreated",text:egov.resources.document.changeDateCreatedDialog.submitBtn,className:"btn-info",click:function(){i=$(".newDateCreatedDate").val()+"T"+$(".newDateCreatedTime").val();r=$(".newDelayReason").val();egov.views.document={dateCreated:i,delayReason:r};n.$("input[name=DateCreated]").val(i);n._getDateAppointed(o,i);n.model.set({DateCreated:i,DelayReason:r});n.$(".wrapDelayReason").removeClass("hidden");n.$(".delayReason").text(r);t.dialog("destroy")}},{id:"closeChangeDateCreated",className:"btn-close",text:egov.resources.document.changeDateCreatedDialog.closeBtn,click:function(){t.dialog("destroy")}}]};require([egov.template.document.changeDateCreated],function(n){t=$.tmpl(n,{dateCreatedDate:u.format("yyyy-MM-dd"),dateCreatedTime:u.format("HH:mm:ss"),delayReason:e});t.dialog(f);t.find(".newDelayReason").focus();t.find(".datepicker").datepicker({dateFormat:"yy-mm-dd"});t.find(".timepicker").timepicker({timeFormat:"H:i:s"})})},_deleteDelayReason:function(){delete egov.views.document;var n=new Date;this.$("input[name=DateCreated]").val(n.format("yyyy-MM-ddTHH:mm:ss"));this.model.set({DateCreated:n.format("yyyy-MM-ddTHH:mm:ss"),DelayReason:""});this.$(".wrapDelayReason").addClass("hidden")},_changeWorkflowType:function(){var t,r,e,i,n,u,f;t=this;r=t.model.get("WorkflowTypes");f=function(){i=_.find(r,function(t){return t.Id==n.find("input[type=radio]:checked").val()});t.model.set("WorkflowTypeId",i.Id);t.$("input[name='WorkflowTypeId']").val(i.Id);t._getDateAppointed(i.ExpireProcess);n.dialog("destroy")};e={title:egov.resources.document.changeWorkflowTypesDialog.title,width:"500px",draggable:!0,keyboard:!0,height:"auto",buttons:[{id:"changeWorkflowTypes",text:egov.resources.document.changeWorkflowTypesDialog.submitBtn,className:"btn-info",click:function(){f()}},{id:"closeWorkflowTypes",className:"btn-close",text:egov.resources.document.changeWorkflowTypesDialog.closeBtn,click:function(){n.dialog("destroy")}}]};require([egov.template.document.changeworkflowTypes],function(t){n=$.tmpl(t,{workflowTypes:r});n.dialog(e);u=n.find(".workflowTypeRow");u.click(function(){$(this).find("input[type=radio]").prop("checked",!0)});u.dblclick(function(){f()});n.find(".datepicker").datepicker({dateFormat:"yy-mm-dd"});n.find(".timepicker").timepicker({timeFormat:"H:i:s"})})},_getDateAppointed:function(n,t){var i=this;egov.request.getDateAppointed({data:{range:n,dateCreated:t},success:function(t){var r=Date.parse(t);i.$("[name='DateAppointed']").datepicker("setDate",r);i.$("#ddlDateAppointRange").val(n)}})},_openOnlineRegistration:function(n){var t=this;egov.request.getDocumentDetailOnlineRegistration({data:{id:n},success:function(n){n?(t.model=n,t.renderDocumentOnlineRegistration()):egov.pubsub.publish(egov.events.status.error,egov.resources.document.openError)},error:function(){t.$el.remove();egov.pubsub.publish(egov.events.status.error,egov.resources.document.openError)},complete:function(){egov.pubsub.publish(egov.events.status.destroy)}})},_openQuestion:function(){var n=this,t=n.question.get("QuestionId");require(["question"],function(i){var r=new i({id:"tabQuestionId_"+t,questionId:t,question:n.question,tab:n.tab});n.$el.append(r.$el);egov.pubsub.publish(egov.events.status.destroy)})},transferLienThong:function(t,i,r){var u=this,e,o,s,f;u.attachments.confirmAttachments(function(){(e=u.serialize(),e!=undefined)&&((o={},u.attachments.model.each(function(n){n.get("isNew")&&(o[n.get("Id")]={name:n.get("Name")})}),s=u.attachments.model.select(function(n){return n.get("isRemoved")}),f=u.model.get("DocumentCopyId"),f=parseInt(f),isNaN(f))||(egov.pubsub.publish(egov.events.status.processing,egov.resources.common.transfering),egov.request.transferLienThong({data:{doc:JSON.stringify(e),files:JSON.stringify(o),modifiedFiles:JSON.stringify(u.attachments.modifiedFiles),removeAttachmentIds:s,documentCopyId:f,addressIds:i,comment:t,dateAppointed:r},success:function(t){t.success?(egov.pubsub.publish(egov.events.status.success,n.lienthong.sendSuccess),u.tab.close(),u._reloadDocumentTree(f)):egov.pubsub.publish(egov.events.status.error,t.error)},error:function(){egov.pubsub.publish(egov.events.status.error,n.lienthong.sendFail)}})))})},_bindEventMobile:function(){this.$(".document-info, #commentListCopy").scroll(function(n){$(n.currentTarget).scrollTop()>200?$("#btndocumentuptotop").addClass("display"):$("#btndocumentuptotop").removeClass("display")})},documentOnlineStatus:[{value:1,text:egov.resources.document.documentOnlineStatus.choDuyet},{value:2,text:egov.resources.document.documentOnlineStatus.dangXuLy},{value:3,text:egov.resources.document.documentOnlineStatus.choBoSung},{value:4,text:egov.resources.document.documentOnlineStatus.choThanhToan},{value:5,text:egov.resources.document.documentOnlineStatus.choTraKetQua},{value:6,text:egov.resources.document.documentOnlineStatus.daTraKetQua},{value:7,text:egov.resources.document.documentOnlineStatus.biTuChoi}],renderDocumentOnlineRegistration:function(){var t=this,r,u,n,i;require([egov.template.document.onlineRegistration],function(f){if(r=_.find(t.documentOnlineStatus,function(n){return n.value=t.model.Status}),t.model.StatusText=r.text,t.$el.append($.tmpl(f,t.model)),t.$("#comment").focus(),t.$(".attachment-download-all").hide(),n=jQuery.parseJSON(t.model.FormJson),!(n instanceof Array)){var e=[];e.push(n);n=$.extend([],e)}u=t.$("#forms-area");n&&n.length>0&&require(["knockout","eFormJqueryGlobal","eFormJsutilt","eFormLibdata","eFormControls","eFormLib","eFormDB","eFormTool","eFormResize","eFormBkavEgateApplet","eFormBkavEgate","eFormBkavEgateCompiler"],function(){$("head").append("<link href='../Scripts/bkav.egov/libs/eForm/css/eformTn.css' rel='stylesheet' /><style>.icontainer:hover {background: none !important;}#pnl_root, .pnl_root {background-color: transparent;}<\/style>");require(["knockout"],function(t){var r,f;for(window.ko=t,r=0;r<n.length;r++)n[r]!=null&&(i={collections:n[r].JssCatalog,schema:n[r].JssForm,formid:n[r].FormId.replace(/-/gi,""),maxRow:n[r].MaxRow},u.addClass("pnl_root sub_pnl_root").append("<div id='div"+i.formid+"'><\/div>"),eForm.Lib.Init(),eForm.efTools.init(null,"div"+i.formid,i.formid),fformModel.fromCatalog(i.collections),eForm.efTools.LoadForm(i.schema,i.maxRow),f=fformModel.fromSchema(eForm.database.GetAll(i.formid),i.formid),$.extend(fformModel,f),t.applyBindings(fformModel,document.getElementById("div"+i.formid)))})});egov.callback(t.callback)})},_docOnlineActions:function(n){var i=this,u,t,f,e,o,r,s;if(this.$("#wrapComment").removeClass("isrequired"),u=i.$(n.target).closest(".doc-online-btn").data("status"),t=$.extend({},i.model),f=JSON.stringify(t.Files),t.Files=undefined,t.Id=undefined,t.DocTypeId=t.DoctypeId,t.Doctype={},t.Comment=i.$("#comment").val(),u=="Accept"){if(t.Comment==""){this.$("#wrapComment").addClass("isrequired");return}e=JSON.stringify(t);o={docId:i.model.Id,doc:e,files:f};egov.pubsub.publish(egov.events.status.processing,egov.resources.common.processing);egov.request.acceptOnline({data:o,success:function(n){if(n.error){egov.pubsub.publish(egov.events.status.error,n.error);return}n.success&&(egov.pubsub.publish(egov.events.status.success,n.success),i.tab&&i.tab.close3(),egov.views.home.tree.reloadOnlineRegistration())}})}else u=="Reject"?(r=$("<textarea id='rejectComment' />"),r.addClass("form-control"),s={title:egov.resources.document.documentOnline.insertRejectComment,width:"1200px",height:"auto",top:"120px",draggable:!0,keyboard:!0,buttons:[{id:"btnConfirm",className:"btn-primary",text:egov.resources.common.confirmButton,click:function(){egov.pubsub.publish(egov.events.status.processing,egov.resources.common.processing);egov.request.rejectOnline({data:{docId:i.model.Id,phone:t.Phone,compendium:t.Compendium,comment:r.val(),mail:t.Email,doctypeId:t.DocTypeId,docFieldId:t.DocfieldId,docCode:t.DocCode,citizenName:t.FullName,dateRegister:t.DateRecieved},success:function(n){if(n.error){egov.pubsub.publish(egov.events.status.error,n.error);return}n.success&&(egov.pubsub.publish(egov.events.status.success,n.success),i.tab&&i.tab.close3(),egov.views.home.tree.reloadOnlineRegistration())}});r.dialog("destroy")}},{id:"closeCheckCitizenInfo",className:"btn-close",text:egov.resources.common.closeButton,click:function(){r.dialog("destroy")}}]},r.dialog(s)):u=="AdditionalRequirements"&&require(["supplementaryOnline"],function(n){new n({docId:i.model.Id,onlineModel:t,document:i})});egov.callback(i.callback)},checkCitizenInfo:function(){var i=this,r=this.model,n=this.$(".staticPart"),t;t={citizenName:n.find("[name='CitizenName']").val(),address:n.find("[name='Address']").val(),idCard:n.find("[name='IdentityCard']").val(),phone:n.find("[name='Phone']").val(),email:n.find("[name='Email']").val(),isCheckExistOnly:!r.IdCard};egov.pubsub.publish(egov.events.status.processing,egov.resources.common.loading);require(["checkCitizenInfo"],function(n){new n({model:t,document:i})})},dowloadDocOnlineAttachment:function(n){var t,i,r,u,f;t=this.$(n.target).closest("li.list-group-item");i=t.data("id");r=t.data("name");egov.pubsub.publish(egov.events.status.processing,egov.resources.common.processing);require(["filedownload"],function(){u="/DocumentOnline/DownLoadFileOnlineRegistration?fileId="+i+"&fileName="+r;$.fileDownload(u,{done:function(){egov.pubsub.publish(egov.events.status.destroy)},fail:function(n){f=$(n);try{var t=JSON.parse(f.text());egov.pubsub.publish(egov.events.status.error,t.error)}catch(i){egov.pubsub.publish(egov.events.status.error,egov.resources.file.errorDownload)}}})})},openDocOnlineAttachment:function(n){var t,i,r,u;t=this.$(n.target).closest("li.list-group-item");i=t.data("id");r=t.data("name");$.ajax({url:"/DocumentOnline/OpenFileOnlineRegistration",data:{fileId:i,fileName:r},type:"GET",success:function(n){n!=""?(u=window.open(n,"_blank"),u.focus()):window.open("/DocumentOnline/DownLoadFileOnlineRegistration?fileId="+i+"&fileName="+r)}})},_delApprover:function(n){var i=this,r=$(n.target).data("approverid"),t=this.model.get("Approver"),u=$(n.target).parent(".approverItem");egov.request.deleteApprover({data:{appId:r},success:function(n){if(n.error){egov.pubsub.publish(egov.events.status.error,n.error);return}t=_.reject(t,function(n){return n.ApproverId==r});i.model.set("Approver",t);u.remove();t.length==0&&i.model.set({IsSuccess:null,UserSuccessId:null,DateSuccess:null})}})},_delUpdateResult:function(n){var t=this,i=t.model.get("DocumentCopyId"),r=$(n.target).parents(".resultItem");egov.request.deleteResult({data:{documentCopyId:i},success:function(){r.remove()}})},_scrollDocument:function(){},_ReSendLienThong:function(n){var i=$(n.target).closest("a.btnResendLt"),t=parseInt(i.attr("data-id"));t&&t!==0&&egov.request.resendLienThong({data:{publishId:t},beforeSend:function(){egov.pubsub.publish(egov.events.status.processing,"Đang gửi lại")},success:function(n){if(n.error){egov.pubsub.publish(egov.events.status.error,n.message);return}egov.pubsub.publish(egov.events.status.success,"Gửi lại thành công")},error:function(){},complete:function(){egov.pubsub.publish(egov.events.status.hide)}})},_recalledLienThong:function(n){var t=$(n.target).closest("a.btnRecalled"),i=parseInt(t.attr("data-id"));i&&i!==0&&egov.message.prompt("Vui lòng nhập lý do lấy lại","Lấy lại",function(n){egov.request.recalledLienThong({data:{publishId:i,comment:n},beforeSend:function(){egov.pubsub.publish(egov.events.status.processing,"Đang thu hồi văn bản.")},success:function(n){if(n.error){egov.pubsub.publish(egov.events.status.error,n.message);return}t.hide();var i=n.status;i==15&&t.parents("tr").find(".lt-status span").text("Đã thu hồi");i==13&&t.parents("tr").find(".lt-status span").text("Đã gửi y/c lấy lại");egov.pubsub.publish(egov.events.status.success,"Gửi thu hồi thành công")},complete:function(){egov.pubsub.publish(egov.events.status.hide)}})})},_recalledAllLienThong:function(n){var t=$(n.target).closest("li"),i=t.attr("data-id");this.answer(i,4)},getTempMailOrSms:function(n,t,i){var u,f,r,e;if(this.isHsmc&&n!=undefined&&n!=null&&!(n<=0)){if(u="00000000-0000-0000-0000-000000000000",f=this.model.get("DocumentId")||u,f===u){egov.pubsub.publish(egov.events.status.error,egov.resources.document.notExist);return}(i===undefined||i===null)&&(i=!0);r=this;e={isMail:i,documentId:this.model.get("DocumentId"),templateId:n};egov.request.editTemplate({data:e,success:function(u){if(u.error){egov.pubsub.publish(egov.events.status.error,u.error);return}var e={templateId:n,documentId:f,isMail:i,templateName:t,content:u.content,email:r.model.get("Email"),phone:r.model.get("Phone"),userNameRecive:r.model.get("CitizenName")};require(["tempMailOrSms"],function(n){egov.editTempMailOrSms===undefined&&(egov.editTempMailOrSms=new n);egov.editTempMailOrSms.render({model:e})})},error:function(n){egov.pubsub.publish(egov.events.status.error,n.message)}})}},_managerDoctypePaperFee:function(){var n=this.model.get("DocTypeId"),t=this.model.get("DocTypeName"),i=1,u=this,r=function(){egov.pubsub.publish(egov.events.status.success,"Cập nhật thành công, vui lòng tiếp nhận lại.")};require(["doctypePaperFee"],function(u){var f=new u({doctypeId:n,doctypeName:t,type:i,callback:r})})},_openEditSurveyDocument:function(){var n=this,t=n.documentInfo,r=t?t.get("DocTypeId"):null,u=t?t.get("CategoryBusinessId"):null,f=t?t.get("NodeCurrentId"):null,i=n.model==undefined?null:n.model.get("StorePrivateId");egov.dataManager.getDocumentEditInfo(n.id,i,{success:function(t){if(t.error){n.tab.close();egov.pubsub.publish(egov.events.status.error,t.error);return}n.isHsmc=t.document.CategoryBusinessId===egov.enum.categoryBusiness.hsmc;n.isVanBanDen=t.document.CategoryBusinessId==egov.enum.categoryBusiness.vbden;n.hasMinTemplate=!egov.setting.userSetting.AlwaysDisplayFullDocumentInfo&&(t.hasKhoiTao!=null?!t.hasKhoiTao:!1);n.model.set(t.document);n.model.set("HasPrivateSaveToStore",t.hasPrivateSaveToStore);n.model.set("DocumentPermissions",t.documentPermission);n.model.set("LienThongs",t.lienThongs);var i=JSON.parse(t.document.ProcessInfo||null);i!=null?(n.model.set("SurveyConfig",i.SurveyConfig||""),n.model.set("SurveyCriteria",i.SurveyCriteria||""),n.model.set("SurveyReport",i.SurveyReport||""),n.model.set("DonViNhan",i.DonViNhan||"")):(n.model.set("SurveyConfig",""),n.model.set("SurveyCriteria",""),n.model.set("SurveyReport",""),n.model.set("DonViNhan",""));n.hasUpdatePermission=t.hasUpdatePermission;n.publishPlan=t.plan.publish;n._renderInfo();n._initDocument()},error:function(){n.tab.close();egov.pubsub.publish(egov.events.status.error,egov.resources.document.openError)},complete:function(){egov.pubsub.publish(egov.events.status.destroy)}})},_openCreateSurveyDocument:function(n){var t=this,i=_.find(egov.setting.allDoctypes,function(t){return t.DocTypeId==n});egov.dataManager.getDocumentCreateInfo(t.id,t.relationAnswerId,{success:function(n){var i,r;if(n){if(n.error){t.tab.close(!0);egov.pubsub.publish(egov.events.status.error,n.error);return}t.copiedDocument?(i=["DocCode","InOutCode","DocumentCopyId","DocumentPermissions","DateAppointed","DateCreated","DateResponse","DateModified","DateResult","TransferType","TransferTypeInEnum"],_.each(i,function(i){t.model.set(i,n[i])})):(r="",t.model.get("Organization")?t.model.get("CategoryBusinessId")==1&&(t.model.set("InOutCode",n.InOutCode),t.model.set("DocCode",""),t.model.set("DocumentContents",[]),t.model.set("Compendium",""),t.model.set("Attachments",[]),t.model.set("CategoryId",n.CategoryId),t.model.set("StoreId",n.StoreId),t._getInOutCode()):t.model.set(n));t.model.get("CategoryId")||t.model.set("CategoryId",5);t._renderSurvey()}},error:function(){t.tab.close();egov.pubsub.publish(egov.events.status.error,egov.resources.document.openError)},complete:function(){egov.pubsub.publish(egov.events.status.destroy)}})},_renderSurvey:function(){var n=this,t;n._unescapeModel();n.isShowingPreview?(t=n.model,n.model.attributes.cid=n.model.cid,t.set("Compendium",t.get("Compendium").split("\n").join("<br />")),n.$el.html(i(n.template,t.toJSON())),n._initDocument()):(n._renderInfo(),n._initDocument());n.renderBusinessLicense()},_renderSurveyContent:function(){var n=this;require(["surveyContentView"],function(t){egov.views.survey=new t;egov.views.survey.render();n.$el.find("#exTab").append(egov.views.survey.$el);var i=JSON.parse(n.$el.find("input[name=SurveyConfig]").val()||"[]"),r=JSON.parse(n.$el.find("input[name=SurveyCriteria]").val()||"[]"),u=n.model.get("DonViNhan"),f=n.$el.find("input[name=SurveyReport]").val()||"",e=n.$el.find("#ddlYearReport option:selected").val();egov.views.survey.renderWarningCompilation(n,e);egov.views.survey.renderFormSurvey(i,r,u,n,f)})}});return f={Common:1,Consulted:2,Contribution:3,Supplementary:4,Signed:5,Success:6,Finished:7,Reopen:8,ReleasedSurvey:9,CompletedSurvey:10},t=100,c});var handleHotBeforeOnCellMouseDown=function(n,t){t.row<0&&n.stopImmediatePropagation()};handleHotAfterChange=function(n,t){n.updateSettings({height:$(`${t} div#divContent .ht_master .wtHider`).height()});$(`${that.el} div#divContent .ht_master .wtHolder`).css("height",$(`${t} div#divContent .ht_master .wtHider`).height()+20)};