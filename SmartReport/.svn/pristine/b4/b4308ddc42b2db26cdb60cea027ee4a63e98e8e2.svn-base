define(function(){"use strict";function r(n,t,i){var r,u;egov.isMobile?(u="/Attachment/DownloadAttachment/"+n,egov.mobile.download(u,i)):(egov.pubsub.publish(egov.events.status.processing,egov.resources.common.processing),r="/Attachment/DownloadAttachment?id="+n+"&storePrivateId="+t,require(["filedownload"],function(){var i=r,n,t;$.fileDownload(i,{successCallback:function(){egov.pubsub.publish(egov.events.status.destroy)},failCallback:function(i){n=$(i);try{t=JSON.parse(n.text());egov.pubsub.publish(egov.events.status.error,t.error)}catch(r){egov.pubsub.publish(egov.events.status.error,egov.resources.file.errorDownload)}}})}))}var n=egov.resources.document.attachment,u=[".jpg",".jpeg",".bmp",".png",".ico",".gif"],i,t;return egov.models.attachment=Backbone.Model.extend({defaults:{Id:0,Name:"",Extension:"",Size:0,Versions:[],fileData:undefined,isRemoved:!1,hasRemoved:!1,isNew:!1,isMofified:!1,isOpen:!1,icon:"",base64:"",isPhatHanhOrKetThuc:!1},initialize:function(){var n=this.get("Extension"),t;n.indexOf(".")!==0&&(n="."+n);t=n===".doc"||n===".docx"?"icon-file-word":n===".xls"||n===".xlsx"?"icon-file-excel":n===".pdf"?"icon-file-pdf":n===".txt"?"icon-text":n===".zip"||n===".rar"||n===".7z"?"icon-file-zip":n===".ppt"||n===".pptx"?"icon-file-powerpoint":n===".html"?"icon-chrome":u.indexOf(n)!=-1?"icon-image2":"icon-file4";this.set("icon",t)}}),egov.models.attachmentCollection=Backbone.Collection.extend({model:egov.models.attachment}),i=Backbone.View.extend({modifiedFiles:{},className:".document-attachment",initialize:function(n){this.$el=n.el;this.hasPermission=n.hasPermission;this.documentId=n.documentId;this.documentCopyId=n.documentCopyId;this.storePrivateId=n.storePrivateId;this.isTheoLo=n.isTheoLo||!1;var i=this,r;this.model.on("add",function(n){r=new t({model:n,parent:i});i.$el.closest(i.className).is(":hidden")&&i.$el.closest(i.className).show();r.$el.addClass("newFile");i.isTheoLo?i.$el.find("ul .btnInsertAttachment").before(r.$el):i.$el.find(".attachment-list").append(r.$el)},this);this.model.on("remove",function(n){n.view.remove()},this);return this.render(),this.hasSupportedFileReader=window.File&&window.FileReader&&window.FileList&&window.Blob,this.registerToGlobal(),this},render:function(){var n=this,i,r;this.model.length>0&&this.$el.parent().show();r=this.model.length>2?"32%":"48%";this.model.each(function(u){i=new t({model:u,parent:n});i.$el.css("maxWidth",r);n.$el.find(".attachment-list").append(i.$el)});n.$(".attachment-item").css("maxWidth",r)},registerToGlobal:function(){var t=this,n;window.top!=undefined&&(window.top.openFileInDesktop=function(i){n=t.model.detect(function(n){return n.get("Id")===i});n!=undefined&&n.view!=undefined&&window.Plugin&&window.Plugin.appendPlugin(function(){window.Plugin.openAttachment(n.view)})})},confirmAttachments:function(n,t){var i=this;if(i.model.length==0||egov.isMobile){egov.callback(n);return}i.isPublishing=t;Plugin&&window.Plugin.appendPlugin(function(){Plugin.confirmAttachments(i,function(){egov.callback(n)})})},downloadAllAttachment:function(){var n=this.documentId,i=this,t;if(n===undefined||n=="00000000-0000-0000-0000-000000000000"){egov.pubsub.publish(egov.events.status.error,egov.resources.file.errorDownload);return}egov.isMobile?(t="/Attachment/DownloadAttachments/"+n,egov.mobile.downloads(t)):(egov.pubsub.publish(egov.events.status.processing,egov.resources.common.processing),require(["filedownload"],function(){var u="/Attachment/DownloadAttachments?id="+n+"&storePrivateId="+i.storePrivateId,t,r;$.fileDownload(u,{successCallback:function(){egov.pubsub.publish(egov.events.status.destroy)},failCallback:function(n){t=$(n);try{r=JSON.parse(t.text());egov.pubsub.publish(egov.events.status.error,r.error)}catch(i){egov.pubsub.publish(egov.events.status.error,egov.resources.file.errorDownload)}}})}))},updateAttachment:function(t,i){var f=this,u,r;this.hasSupportedFileReader?(u="",egov.setting.maxFileSize&&i.size>egov.setting.maxFileSize?u+=i.name+": "+n.file.lenghtIsNotAllow+n.file.maxLength+egov.setting.maxFileSize/1048576+"Mb":egov.setting.acceptFileTypes.test(i.type)||egov.setting.acceptFileTypes.test("."+i.name.split(".").pop())||(u+=i.name+": "+n.file.typeIsNotAllow),u!==""?egov.pubsub.publish(egov.events.status.error,u):(r=new FileReader,r.onloadstart=function(){egov.pubsub.publish(egov.events.status.processing,egov.resources.common.processing)},r.onload=function(n){f.modifiedFiles[t]=btoa(n.target.result)},r.onloadend=function(){egov.pubsub.publish(egov.events.status.destroy)},r.onerror=function(n){console.log(n)},r.readAsBinaryString(i))):console.log("The File APIs are not fully supported in this browser.")}}),t=Backbone.View.extend({tagName:"tr",selectedClass:"rowSelected",fileName:"",fileExtension:"",uploadingTemplate:'<div class="progress"><div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100"><\/div><\/div>',events:{click:"selected",contextmenu:"contextmenu","click .viewAttachment":"open","click .attachment-open":"open",dblclick:"open","click .attachment-view":"view","touchend .attachment-name":"view","click .attachment-remove":"remove","click .attachment-download":"download","tap .attachment-download":"download","tap .attachment-download-all":"downloadAll","click .attachment-download-all":"downloadAll","change .attachment-update .fileupload":"update"},initialize:function(n){this.parent=n.parent;this.fileExtension=this.model.get("Extension");this.fileName=this.model.get("Name");this.render()},render:function(){var n=this;require([n.parent.isTheoLo?egov.template.document.attachmentTheoLo:egov.template.document.attachment],function(t){n.$el.append($.tmpl(t,n.model.toJSON()));n.model.get("isRemoved")&&n.$el.addClass("disabled");n.model.get("isNew")&&n.$(".attachment-view").css("visibility","hidden");n.parent.hasPermission||n.model.get("isPhatHanhOrKetThuc")||n.$(".attachment-remove").hide();n.model.get("isUploading")&&n.$el.find("td:first-child").append(n.uploadingTemplate)});this.model.on("change:Name",function(t,i){n.$(".detail-attachment-name").text(i);n.$el.addClass("updatedfile")});this.model.on("change:icon",function(t,i){n.$(".attachment-name .icon").attr("class","icon "+i)});this.model.on("change:isUploading",function(){n.$(".progress").remove()});return this.$(".attachment-function a").etip(),this.model.view=this,this},selected:function(){if(egov.helper.hideAllContext(),this.$el.contextobj&&this.$el.contextobj.hide(),this.$el.hasClass(this.selectedClass)){this.$el.removeClass(this.selectedClass);return}this.$el.addClass(this.selectedClass);this.$el.siblings("."+this.selectedClass).removeClass(this.selectedClass)},open:function(t,i){if(!egov.isMobile){var r;if(r=this,r.model.get("isRemoved")){egov.pubsub.publish(egov.events.status.error,n.fileIsRemoved);return}Plugin&&window.Plugin.appendPlugin(function(){Plugin.openAttachment(r,i)})}},view:function(){var t;if(t=this,!t.model.get("isNew")){if(t.model.get("isRemoved")){egov.pubsub.publish(egov.events.status.error,n.fileIsRemoved);return}if(window.top!=undefined&&_.isFunction(window.top.openFilePreview)){window.top.openFilePreview(t.parent.documentId,t.model.get("Id"));return}}},update:function(t){var i,u,r;t&&(egov.helper.destroyClickEvent(t),i=t.currentTarget.files[0],u=i.name.substr(i.name.lastIndexOf(".")+1).toLowerCase(),u!=this.fileExtension?(r=$("<span>"+String.format(n.confirmToUploadWithOtherName,i.name,this.fileName)+"<\/span>"),r.dialog({title:n.notEqualName,width:"400px",top:"100px",buttons:[{text:egov.resources.common.closeButton,className:"btn-info",disableProcess:!0,click:function(){r.dialog("hide")}}]})):(this.parent.updateAttachment(this.model.get("Id"),i),this.$el.addClass("updatedfile")))},remove:function(t){var i,r;if(!this.parent.hasPermission&&!this.model.get("isPhatHanhOrKetThuc")){egov.pubsub.publish(egov.events.status.error,egov.resources.attachment.notPermision);return}egov.helper.destroyClickEvent(t);i=this;this.model.get("isNew")?(r=function(){i.parent.model.remove(i.model);i.parent.model.length==0&&i.$el.parents(".document-attachment").hide();i.$el.remove()},this.model.get("isPhatHanhOrKetThuc")?egov.request.removeAttachment({data:{id:this.model.get("Id"),documentCopyId:this.parent.documentCopyId},success:function(n){n&&(n.error?egov.pubsub.publish(egov.events.status.error,n.error):(egov.pubsub.publish(egov.events.status.success,n.success),r()))},error:function(){egov.pubsub.publish(egov.events.status.error,n.errorDownload)},complete:function(){egov.pubsub.publish(egov.events.status.destroy)}}):r()):this.model.get("isRemoved")||(this.$el.find(".attachment-name").text(this.model.get("Name")+n.removed),this.model.set("hasRemoved",!0),this.model.set("isRemoved",!0),this.$el.addClass("disabled"))},download:function(n){n&&(egov.helper.destroyClickEvent(n),this.model.get("Id")!=0&&$.isNumeric(this.model.get("Id")))&&r(this.model.get("Id"),this.parent.storePrivateId,this.model.get("Name"))},contextmenu:function(n){if(n){egov.helper.destroyClickEvent(n);this.$el.hasClass(this.selectedClass)||this.selected();var t=new egov.models.contextMenu({trigger:"right",data:null,style:{},position:{my:"left top",at:"left bottom",of:"event"},hasCache:!1,isShowLoading:!1}),i=this._getContextItems();t.set("data",i);this.$el.contextmenu(t,n)}},_getContextItems:function(){var t=this,i=new egov.models.contextMenuList;return i.add({text:n.openFile,value:"openattach",iconClass:"icon-enter",callback:function(){t.open()}}),t.model.get("isNew")?i.add({text:n.deleteFile,value:"remove",iconClass:t.model.get("isPhatHanhOrKetThuc")?"icon-trash":"icon-close",callback:function(){t.model.get("isPhatHanhOrKetThuc")?t.remove():(t.parent.model.remove(t.model),t.parent.model.length==0&&t.$el.parents(".document-attachment").hide(),t.$el.remove())}}):(i.add({text:n.download,value:"download",iconClass:"icon-download3",callback:function(){r(t.model.get("Id"))}}),t.model.get("isRemoved")?t.parent.hasPermission&&i.add({text:n.restoreFile,value:"undo",iconClass:"icon-arrow",callback:function(){t.$el.find(".attachment-name").text(t.model.get("Name")+"("+n.using+")");t.model.set("hasRemoved",!1);t.model.set("isRemoved",!1);t.$el.removeClass("disabled")}}):t.parent.hasPermission&&i.add({text:n.deleteFile,value:"remove",iconClass:"icon-trash",callback:function(){t.$el.find(".attachment-name").text(t.model.get("Name")+n.removed);t.model.set("hasRemoved",!0);t.model.set("isRemoved",!0);t.$el.addClass("disabled")}}),$.each(t.model.get("Versions"),function(r,u){i.add({name:"---"});i.add({text:String.format(n.version,u.User,u.CreateDate),value:"openattach",iconClass:"icon-stack",callback:function(){t.open(null,u.Version)}})})),i},_isReadableFile:function(){var n=this.fileExtension.toLowerCase();return["pdf","png","jpg","jpeg","bmp","gif","doc","docx","xls","xlsx"].indexOf(n)>=0}}),i});