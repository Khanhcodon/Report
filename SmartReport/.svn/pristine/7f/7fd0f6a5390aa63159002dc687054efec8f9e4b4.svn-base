define(function(){"use strict";function n(n){if(n){var t=n.contentWindow||n.contentDocument.parentWindow;t.document.body&&(n.height=t.document.documentElement.scrollHeight||t.document.body.scrollHeight)}}return Backbone.View.extend({events:{contextmenu:"contextmenu"},initialize:function(n){var t=this;return(this.document=n.document,this.isView=!1,this.scanFile=n.scanFile,n.contentHTML&&(this.model.Content=n.contentHTML),t.isCreate=t.document.isCreate==undefined?!1:t.document.isCreate,t.isCreate=t.document.isInsertImagePacket?!0:t.isCreate,this.model.Content||this.model.ContentUrl)?(this.model.Content=unescape(this.model.Content),t.render()):(egov.request.getFormContent({data:{contentId:t.document.isCreate&&!t.document.copiedDocument?t.model.FormId:t.model.DocumentContentId,isCreate:t.document.isCreate&&!t.document.copiedDocument||!1,doctypeId:t.document.model.get("DocTypeId")},success:function(n){n&&(t.model.Content=unescape(n),t.render())},error:function(n){egov.log(n)}}),this)},render:function(){if(this.model.ContentUrl){var t=$('<iframe class="content-iframe" style="border: 0px; width:100%; min-height: 350px;" src="'+this.model.ContentUrl+'"><\/iframe>');t.load(function(){n(this)}).appendTo(this.$el)}else this.$el.append(unescape(this.model.Content));return egov.mobile&&egov.mobile.niceScrollIOS(this.document.$(".autoscroll")),this.enableEditor(),this},renderDialog:function(){var t=this,i,u,r,f;i=$('<div id="egov-dialog"><\/div>');t.model.Url?(u=$('<iframe id="bwss-iframe" style="border: 0px; min-height: 300px; width:100%" src="'+t.model.Url+'"><\/iframe>'),u.load(function(){n(this)}).appendTo(i),t._openDialog(i,undefined,function(){t._editKqklMrContent();t._editDocContent(function(){i.dialog("destroy");t.document._renderForm(!0)})},function(){u.parents(".modal-dialog").css({position:"absolute",top:"-25px",left:"18%"});u.parents(".modal-body").css({padding:0});$(".modal-header,.modal-footer").css({padding:"5px"});$(".modal-header .close").click(function(){t._editKqklMrContent();t._editDocContent(function(){i.dialog("destroy");t.document._renderForm(!0)})})})):(f=t.$el.height(),r=t.$el.clone(),i.html(r),t._openDialog(i,function(){t.model.Content=r.bmailEditor.getContent();t.model.IsEdited=!0;t.document._renderForm(!0);i.dialog("destroy")},function(){i.dialog("destroy");t.document._renderForm()},function(){var n=i.parent(".modal-body");n.css({"padding-top":0,position:"initial"});r.editor(f,function(n){r.bmailEditor=n})}))},contextmenu:function(n){if(!(this.model.Version<=1)){var t=this,i=new egov.models.contextMenu({trigger:"right",data:null,style:{},position:{my:"left top",at:"left bottom",of:"event"},hasCache:!1,isShowLoading:!1});egov.request.getDocumentContentVersion({data:{documentContentId:t.model.DocumentContentId,version:t.model.Version},success:function(r){if(r){var u=t._getContextItems(r);i.set("data",u);t.$el.contextmenu(i,n)}}})}},openDetail:function(n){var t=$("<div>"),i={width:900,height:600,title:String.format(egov.resources.document.content.version,n.CreatedByUserName,n.CreatedOnDate),buttons:[{text:egov.resources.common.closeButton,click:function(){t.dialog("close");return}}]};t.html(unescape(n.Content));t.dialog(i)},_editKqklMrContent:function(){var t=this,n=document.getElementById("bwss-iframe").contentWindow.GetHtmlContent(),i;n=n.replace(/(\n|\r|\t)/gm,"");i=JSON.parse(n);t.model.Content=_.unescape(i.content);t.model.IsEdited=!0},disableEditor:function(){this.$el.editor("destroy")},enableEditor:function(){if(this.document.isCreate||this.document.model.get("CategoryBusinessId")==1&&this.document.model.get("WorkflowId")==0){var i=this.$el,n=this,t;if(t=350,n.scanFile){if(n.scanFile.get("Extension").toLowerCase()===".pdf"){egov.request.createImagesFromBeginAndLastPdfPages({data:{id:n.scanFile.get("Id")},beforeSend:function(){egov.pubsub.publish(egov.events.status.processing,"Đang xử lý...")},success:function(i){var f,r,u,e;if(i)if(i.error)egov.pubsub.publish(egov.events.status.error,i.error);else{for(f=i.images,i.documentInfo&&(n.document.model.set("Compendium",i.documentInfo.Compendium),n.document.model.set("DocCode",i.documentInfo.DocCode),n.document.model.set("Organization",i.documentInfo.Organization),n.document.model.set("DatePublished",i.documentInfo.DatePublished),n.document.reRenderInfo()),r="",u=0;u<f.length;u++)e='<div><p><img style="width:100%;" src="'+f[u]+'" /><\/p><\/div>',r=r+e;n.model.Content=r+n.model.Content;n.$el.prepend(r);n.$el.editor(t,function(t){n.$el.bmailEditor=t;n.document._setFocus()});n.model.IsEdited=!0}},error:function(){egov.pubsub.publish(egov.events.status.error,_resource.errorDownload)},complete:function(){egov.pubsub.publish(egov.events.status.destroy)}});return}return}egov.isMobile?this.$el.attr("contenteditable",!0):this.$el.editor(t,function(t){n.$el.bmailEditor=t;n.document._setFocus()});this.model.IsEdited=!0}},getContent:function(n){return egov.helper.destroyClickEvent(n),this.model.Content=this.$el.bmailEditor?this.$el.bmailEditor.getContent():this.$el.html(),this.model.Content},_getContextItems:function(n){var t=new egov.models.contextMenuList,i=this;return _.each(n,function(n){n.Content=unescape(n.Content);t.add({text:String.format(egov.resources.document.content.version,n.CreatedByUserName,n.CreatedOnDate),value:n.DocumentContentDetailId,iconClass:"icon-eye3",callback:function(){i.openDetail(n)}})}),t},_editDocContent:function(n){egov.request.editDocumentContent({data:{contentId:that.model.DocumentContentId,content:escape(that.model.Content)},success:function(t){egov.callback(n,t)}})},_openDialog:function(n,t,i,r){var e,f=[],u;e=this;t&&(u={text:window.getResource("egov.resources.main.submitBtn"),className:"btn-primary",click:function(){egov.callback(t)}},f.push(u));i&&(u={text:window.getResource("egov.resources.main.closeBtn"),className:"btn-close",click:function(){egov.callback(i)}},f.push(u));n.dialog({overflow:"visible",height:"520px",width:"900px",draggable:!0,resize:!0,title:e.model.ContentName,buttons:f});egov.callback(r)}})});