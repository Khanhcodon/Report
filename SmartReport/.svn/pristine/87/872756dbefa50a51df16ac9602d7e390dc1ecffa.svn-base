define([egov.template.transfer.transferMobile,egov.template.transfer.transferItemMobile],function(n,t){"use strict";var i=egov.resources.document.transfer;return Backbone.View.extend({el:"#tranfer",className:"transfer-form row",template:n,model:egov.viewModels.actionUserList,events:{"click .user-received-item":"_selectUser","click .result-view":"_focusToFilter","click #btn_transfer_extends":"toggle_transferExt","click .btn-clear-dg-tb":"clearUserExt"},initialize:function(){var n=this;n.allUser=[];n.destination={};n.$(".mdl-dialog__content").append(n.template);n.$listUser=n.$(".listUsers");n.$result=n.$(".result-view");n.$filter=n.$("#searchUser");n.model.on("reset",function(r){if(n._clear(),r.length===0){n.$listUser.append($("<li>").addClass("mdl-list__item").text(i.noUserByAction));return}n.$listUser.append($.tmpl(t,r.toJSON()));egov.mobile.upgradeMaterial(n.$(".mdl-button, .mdl-checkbox"));r.length===1&&(n.$listUser.find(".mdl-checkbox").addClass("is-checked"),r.models[0].set("isSelected",!0));n._filterUser()});n.model.on("change:isSelected",function(t){var i=t.get("isSelected"),r=n.model.where({isSelected:!0}).length;i?(n.mainProcess===undefined&&(n.mainProcess=t,n.mainProcess.set("isMainProcess",!0)),n.$(".searchUser").before("<span class='user-result' id='"+t.get("value")+"'>"+t.get("fullname")+"<\/span>")):(t.get("isMainProcess")&&(t.set("isMainProcess",!1),n.mainProcess=n.model.findWhere({isSelected:!0}),n.mainProcess!=null&&n.mainProcess.set("isMainProcess",!0)),n.$result.find(".user-result#"+t.get("value")).remove())});return this},render:function(n){this.UserIdDxl=[];this.UserIdDg=[];this.UserIdTb=[];this.$("#user_transfer_extends").hide();this._clear();n.action instanceof egov.models.action||(n.action=new egov.models.action(n.action));this.action=n.action;this.document=n.document;this.callback=n.callback;this.action.get("isSpecial")?this._transferSpecial():this._open()},serialize:function(){var n=this.mainProcess,e,i;if(n===undefined)return null;var t=this.model.select(function(n){return n.get("isSelected")&&!n.get("isMainProcess")}),u=egov.enum.transferType,r=[],f=[];return this.destination.UserIdXlc=n.get("id"),r.push({label:n.get("fullname"),department:n.get("department"),value:"",type:u.xulychinh,isMobile:!0}),f=_(t).chain().pluck("id").value(),t.length>0&&(e=_.map(t,function(n){return n.get("fullname")}),i=_.map(t,function(n){return n.get("department")}),i=_.uniq(i,function(n){return n}),r.push({label:e.join(", "),department:i.join(", "),value:"",type:u.dongxuly,isMobile:!0})),this.destination.UserIdsDxl=f,this.destination.CurrentNodeId=this.action.get("currentNodeId"),this.destination.IsAttachYk=!1,this.destination.NextNodeId=this.action.get("nextNodeId"),this.destination.CurrentNodeId=this.action.get("currentNodeId"),this.destination.WorkflowId=this.action.get("workflowId"),this.destination.NewDocTypeId=undefined,this.destination.TargetComment=JSON.stringify(r),this.destination.ActionId=this.action.get("id"),this.destination.IsThongbao=this.UserIdTb.length>0?!0:!1,this.destination.IsDxl=this.UserIdDg.length>0?!0:!1,this.destination.UserTb=_.pluck(this.UserIdTb,"value"),this.destination.UserIdsDxl=_.pluck(this.UserIdDxl,"value"),this.destination.UserIdsDg=_.pluck(this.UserIdDg,"value"),this.destination},_clear:function(){this.model=egov.viewModels.actionUserList;this.$el.css("display","block");this.$listUser.empty();this.destination={};this.mainProcess&&(this.mainProcess=undefined)},_open:function(){var n,t,i,r;n=this;t=n.action.get("id");i=n.action.get("workflowId");r=n.document.model.get("DocumentCopyId");n._renderDialog();n._focusToFilter();egov.request.getUserByAction({data:{actionId:t,workflowId:i,documentCopyId:r},success:function(t){n._sortUsersByAction(t,function(t){n.model.reset(t)})}})},_sortUsersByAction:function(n,t){var u,i,r;if(n.error){egov.callback(t,[]);return}if(n.length===1){egov.callback(t,n);return}u=this;i=[];r=_.find(n,function(n){return n.value===egov.setting.userId});n=_.reject(n,function(n){return n.value===egov.setting.userId});i=n;i=_.sortBy(i,function(n){return n.name});r&&i.push(r);egov.callback(t,i)},_filterUser:function(){var n=this;n.$filter.on("change keyup",function(){var t=n.$filter.val().toLowerCase();if(t===""){n.$listUser.find("li").show();return}n.$listUser.find("li").each(function(){var n=$(this).attr("data").toLowerCase();n.indexOf(t)<0?$(this).hide():$(this).show()})})},_renderDialog:function(){var n=this;dialogPolyfill.registerDialog(n.el);n.el.showModal();n.$(".user-receiveds .user-result").remove();n.$(".btnSend").off("click").click(function(t){t.preventDefault();n.$("button").attr("disabled","disabled");egov.mobile.showProcessBar();n._send(function(){n._transferComplete()});$(".user-result").remove();return});n.$(".close").click(function(){n.$el.css("display","none");$(".user-result").remove();n.el.close();return});return},_transferSpecial:function(){var n=this;this.destination.UserIdXlc=this.action.get("userIdNext");this.destination.UserIdsDxl=[];this.destination.IsThongbao=!1;this.destination.IsDxl=!1;this.destination.IsAttachYk=!1;this.destination.UserIdsDg=[];this.destination.NextNodeId=this.action.get("nextNodeId");this.destination.WorkflowId=this.action.get("workflowId");this.destination.TargetComment="[]";this._transferEdit(function(){n._transferComplete()})},_send:function(n){var t=this,r=t.serialize();if(!r){egov.mobile.showStatus(i.noUser);n();return}t.document.isCreate?t._transferCreate(n):t._transferEdit(n)},_transferCreate:function(n){var i=this.document.serialize(),f=this,r,u,t;this.storeId&&this.code&&(i.StoreId=this.storeId,i.DocCode=this.code,i.CodeId=this.codeId);r={};this.document.attachments.model.each(function(n){n.get("isNew")&&(r[n.get("Id")]={name:n.get("Name")})});u=this.document.attachments.model.select(function(n){return n.get("isRemoved")});u=_.map(u,function(n){return n.get("Id")});t=this.document.attachments.modifiedFiles;$.each(r,function(n,i){t[n]&&(i.content=t[n],delete t[n])});egov.request.transfer({data:{doc:JSON.stringify(i),destination:this.destination?JSON.stringify(this.destination):"",files:JSON.stringify(r),modifiedFiles:JSON.stringify(t),removeAttachmentIds:u,storePrivateId:0,destinationPlan:""},success:function(){},error:function(){},complete:function(){n()}})},_transferEdit:function(n){var r=this,t,e=r.document.model.get("DocumentCopyId"),o,u=this.document.attachments.modifiedFiles,s=function(t){t.success?(egov.mobile.showStatus(i.transferSuccess),r._reloadDocumentList()):egov.mobile.showStatus(t.error);n()},f=function(){egov.mobile.showStatus(i.transferError)};o=!1;t={};this.document.attachments.model.each(function(n){n.get("isNew")&&(t[n.get("Id")]={name:n.get("Name")})});egov.request.lightTransfer({data:{documentCopyId:e,destination:this.destination?JSON.stringify(this.destination):"",comment:this.document.$("textarea[name=Comment]").val(),files:t?JSON.stringify(t):"",newContent:"",newCompendium:"",modifiedFiles:_.isEmpty(u)?"":JSON.stringify(u)},success:function(n){if(n.error){f();return}s(n)},error:function(n){console.log(n);f()},complete:function(){n()}})},_transferComplete:function(){var n=this;n.$("button").removeAttr("disabled");egov.mobile.hideDetailPage();egov.mobile.hideProcessBar();n.document.$el.remove();n.el&&(n.$el.css("display","none"),n.el.close())},_reloadDocumentList:function(){egov.pubsub.publish("tree.reloadSelected")},_selectUser:function(n){var t=$(n.target).closest("li.user-received-item"),u=t.attr("value"),i=this.model.detect(function(n){return n.get("value")==u}),r;i&&(r=i.get("isSelected"),t.parent().find(".mdl-checkbox").removeClass("is-checked"),this.model.each(function(n){n.get("isSelected")&&n.set("isSelected",!1)}),r||(t.find(".mdl-checkbox").addClass("is-checked"),i.set("isSelected",!0)),this._focusToFilter());n.preventDefault()},_focusToFilter:function(n){if(n==undefined){this.$filter.focus();return}var t=$(n.target).find("input");t.focus()},toggle_transferExt:function(){var n=this;n.allUser.length<1&&(n.allUser=egov.setting.allUsers,n._binUserAdvance());$("#user_transfer_extends").slideToggle()},_binUserAdvance:function(){var n=this,t=n.$("#txt_searchdg"),i=n.$("#txt_searchtb"),r=n.$(".txt_filter_allUser");typeof eGovApp!="undefined"&&(r.focus(function(){$(".transfer-dialog").prop("style","display:block; bottom:0;top:inherit;")}),$("#searchUser").focus(function(){$(".transfer-dialog").prop("style","display:block;")}));t.autocomplete({appendTo:".box_donggui",source:n.allUser,select:function(t,i){var r,f,u;return $(this).val(""),r=_.findWhere(n.allUser,{value:i.item.value}),r&&(n.UserIdDxl.length+n.UserIdDg.length<1&&$(".box_donggui .btn-clear-dg-tb").show(),f=n.model.detect(function(n){return n.id===r.value}),f?(u=_.findWhere(n.UserIdDxl,{value:i.item.value}),u||(n.UserIdDxl.push(r),$(this).before("<span class='user-result' id='"+i.item.value+"'>"+i.item.fullname+",<\/span>"))):(u=_.findWhere(n.UserIdDg,{value:i.item.value}),u||(n.UserIdDg.push(r),$(this).before("<span class='user-result' id='"+i.item.value+"'>"+i.item.fullname+",<\/span>")))),!1},open:function(){var n=$("#user_transfer_extends .ui-autocomplete");n.css({height:"100px",top:$(this).position().top+$(this).innerHeight()+"px","overflow-y":"scroll"})}}).data("autocomplete")._renderItem=function(n,t){return n.addClass("dropdown-menu").css("zIndex","1060"),$("<li><\/li>").data("item.autocomplete",t).append("<a>"+t.label+"<\/a>").appendTo(n)};i.autocomplete({appendTo:".box_thongbao",source:n.allUser,select:function(t,i){var r,u;return $(this).val(""),r=_.findWhere(n.allUser,{value:i.item.value}),r&&(n.UserIdTb.length<1&&$(".box_thongbao .btn-clear-dg-tb").show(),u=_.findWhere(n.UserIdTb,{value:i.item.value}),u||(n.UserIdTb.push(r),$(this).before("<span class='user-result' id='"+i.item.value+"'>"+i.item.fullname+",<\/span>"))),!1},open:function(){var n=$("#user_transfer_extends .ui-autocomplete");n.css({height:"100px",top:"-100px",overflow:"scroll"})}}).data("autocomplete")._renderItem=function(n,t){return n.addClass("dropdown-menu").css("zIndex","1060"),$("<li><\/li>").data("item.autocomplete",t).append("<a>"+t.label+"<\/a>").appendTo(n)}},clearUserExt:function(n){var i=$(n.target).closest(".btn-clear-dg-tb"),t=i.data("target");t==="searchUsrDg"?($(".searchUsrDg").find("span").remove(),$(".box_donggui .btn-clear-dg-tb").hide(),this.UserIdDg=[],this.UserIdDxl=[]):t==="searchUsrTb"&&($(".box_thongbao .btn-clear-dg-tb").hide(),$(".searchUsrTb").find("span").remove(),this.UserIdTb=[])}})});