define(function(){"use strict";function i(n,t,i){var r="/Attachment/DownloadAttachment/"+n;return i?egov.mobile.download(r,t):egov.mobile.onlyDownload(r)}var n=egov.resources.document.attachment,u=[".jpg",".jpeg",".bmp",".png",".ico",".gif"],r,t;return egov.models.attachment=Backbone.Model.extend({defaults:{Id:0,Name:"",Extension:"",Size:0,Versions:[],fileData:undefined,isRemoved:!1,hasRemoved:!1,isNew:!1,isMofified:!1,isOpen:!1,icon:"",base64:"",isPhatHanhOrKetThuc:!1},initialize:function(){var n=this.get("Extension"),t;n.indexOf(".")!==0&&(n="."+n);t=n===".doc"||n===".docx"?"icon-file-word":n===".xls"||n===".xlsx"?"icon-file-excel":n===".pdf"?"icon-file-pdf":n===".txt"?"icon-text":n===".zip"||n===".rar"||n===".7z"?"icon-file-zip":n===".ppt"||n===".pptx"?"icon-file-powerpoint":n===".html"?"icon-chrome":u.indexOf(n)!=-1?"icon-image2":"icon-file4";this.set("icon",t)}}),egov.models.attachmentCollection=Backbone.Collection.extend({model:egov.models.attachment}),r=Backbone.View.extend({modifiedFiles:{},className:".document-attachment",initialize:function(n){this.$el=n.el;this.hasPermission=n.hasPermission;this.documentId=n.documentId;this.documentCopyId=n.documentCopyId;this.storePrivateId=n.storePrivateId;var i=this,r;this.model.on("add",function(n){r=new t({model:n,parent:i});i.$el.closest(i.className).is(":hidden")&&i.$el.closest(i.className).show();r.$el.addClass("newFile");i.$el.find("ul").append(r.$el)},this);this.model.on("remove",function(n){n.view.remove()},this);return this.render(),this.hasSupportedFileReader=window.File&&window.FileReader&&window.FileList&&window.Blob,this},render:function(){var n=this,i;this.model.each(function(r){i=new t({model:r,parent:n});n.$el.find("ul").append(i.$el)})},confirmAttachments:function(n){var t=this;if(t.model.length==0||egov.isMobile){egov.callback(n);return}},updateAttachment:function(t,i){var f=this,u,r;this.hasSupportedFileReader?(u="",egov.setting.maxFileSize&&i.size>egov.setting.maxFileSize?u+=i.name+": "+n.file.lenghtIsNotAllow+n.file.maxLength+egov.setting.maxFileSize/1048576+"Mb":egov.setting.acceptFileTypes.test(i.type)||egov.setting.acceptFileTypes.test("."+i.name.split(".").pop())||(u+=i.name+": "+n.file.typeIsNotAllow),u!==""?egov.pubsub.publish(egov.events.status.error,u):(r=new FileReader,r.onloadstart=function(){egov.pubsub.publish(egov.events.status.processing,egov.resources.common.processing)},r.onload=function(n){f.modifiedFiles[t]=btoa(n.target.result)},r.onloadend=function(){egov.pubsub.publish(egov.events.status.destroy)},r.onerror=function(n){console.log(n)},r.readAsBinaryString(i))):console.log("The File APIs are not fully supported in this browser.")}}),t=Backbone.View.extend({tagName:"li",className:"mdl-list__item mdl-list__item--two-line",selectedClass:"rowSelected",fileName:"",fileExtension:"",uploadingTemplate:'<div class="progress"><div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100"><\/div><\/div>',events:{"click .attachment-remove":"remove","click .attachment-download":"_openDownload","change .attachment-update .fileupload":"update"},initialize:function(n){this.parent=n.parent;this.fileExtension=this.model.get("Extension");this.fileName=this.model.get("Name");this.render()},render:function(){this.parent.$el.closest(".document-attachment-mobile").show();var n=this;require([egov.template.document.attachment],function(t){n.$el.append($.tmpl(t,n.model.toJSON()));n.model.get("isRemoved")&&n.$el.addClass("disabled");n.model.get("isNew")&&n.$(".attachment-view").css("visibility","hidden");n.parent.hasPermission||n.model.get("isPhatHanhOrKetThuc")||n.$(".attachment-remove").hide();n.model.get("isUploading")&&n.$el.append(n.uploadingTemplate)});this.model.on("change:Name",function(t,i){n.$(".detail-attachment-name").text(i);n.$el.addClass("updatedfile")});this.model.on("change:icon",function(t,i){n.$(".attachment-name .icon").attr("class","icon "+i)});this.model.on("change:isUploading",function(){n.$(".progress").remove()});return this.model.view=this,this},update:function(t){var i,u,r;t&&(i=t.currentTarget.files[0],u=i.name.substr(i.name.lastIndexOf(".")+1).toLowerCase(),u!=this.fileExtension?(r=$("<span>"+String.format(n.confirmToUploadWithOtherName,i.name,this.fileName)+"<\/span>"),r.dialog({title:n.notEqualName,width:"400px",top:"100px",buttons:[{text:egov.resources.common.closeButton,className:"btn-info",disableProcess:!0,click:function(){r.dialog("hide")}}]})):(this.parent.updateAttachment(this.model.get("Id"),i),this.$el.addClass("updatedfile")),t.preventDefault())},remove:function(t){var i,r;if(!this.parent.hasPermission&&!this.model.get("isPhatHanhOrKetThuc")){egov.pubsub.publish(egov.events.status.error,egov.resources.attachment.notPermision);return}i=this;this.model.get("isNew")?(r=function(){i.parent.model.remove(i.model);i.parent.model.length==0&&i.$el.parents(".document-attachment").hide();i.$el.remove()},this.model.get("isPhatHanhOrKetThuc")?egov.request.removeAttachment({data:{id:this.model.get("Id"),documentCopyId:this.parent.documentCopyId},success:function(n){n&&(n.error?egov.pubsub.publish(egov.events.status.error,n.error):(egov.pubsub.publish(egov.events.status.success,n.success),r()))},error:function(){egov.pubsub.publish(egov.events.status.error,n.errorDownload)},complete:function(){egov.pubsub.publish(egov.events.status.destroy)}}):r()):this.model.get("isRemoved")||(this.$el.find(".attachment-name").text(this.model.get("Name")+n.removed),this.model.set("hasRemoved",!0),this.model.set("isRemoved",!0),this.$el.addClass("disabled"));t.preventDefault()},_openDownload:function(n){var r=this.model.get("Name"),u=this.model.get("Size"),t=this.model.get("Id");t!=0&&$.isNumeric(t)&&(egov.dialog.confirmActions({title:r,message:"Dung lượng file: "+u,buttons:[{text:"Mở",callback:function(){i(t,r,!0)}},{text:"Tải về",callback:function(){i(t,r,!1)}}]}),n.preventDefault())},download:function(){i(fileid,this.model.get("Name"),!0)}}),r});