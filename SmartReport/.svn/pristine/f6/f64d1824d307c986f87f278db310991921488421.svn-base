using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Web.Mvc;
using Bkav.eGovCloud.Business;
using Bkav.eGovCloud.Business.Common;
using Bkav.eGovCloud.Business.Customer;
using Bkav.eGovCloud.Core.Domain.License;
using Bkav.eGovCloud.Core.FileSystem;
using Bkav.eGovCloud.Core.Utils;
using Bkav.eGovCloud.Entities;
using Bkav.eGovCloud.Entities.Admin;
using Bkav.eGovCloud.Entities.Common;
using Bkav.eGovCloud.Entities.Customer;
using Bkav.eGovCloud.Entities.Customer.Settings;
using Bkav.eGovCloud.Entities.Enum;
using Bkav.eGovCloud.Models;
using Bkav.eGovCloud.Search;
using Bkav.eGovCloud.Web.Framework;
using Bkav.eGovOnline.Business.Customer;
using Microsoft.AspNet.SignalR;
using Newtonsoft.Json;
using System.Data;
using System.Xml;
using Bkav.eGovCloud.Business.Utils;
using System.Web;
using System.Net.Http;
using System.Net.Http.Formatting;
using System.Configuration;
using ClosedXML.Excel;
using Newtonsoft.Json.Linq;
using OfficeOpenXml;
using DocumentFormat.OpenXml.Spreadsheet;

namespace Bkav.eGovCloud.Controllers
{
	//[RequireHttps]
	//[EgovAuthorize]
	public class HomeSMReportController : CustomerBaseController
	{
		#region properties

		private readonly AdminGeneralSettings _generalSettings;
		private readonly ImageSettings _insertImageSettings;
		private readonly DocTypeBll _docTypeService;
		private readonly ProcessFunctionBll _processFunctionService;
		private readonly ProcessFunctionGroupBll _processFunctionGroupService;
		private readonly DocumentCopyBll _docCopyService;
		private readonly DocumentBll _docService;
		private readonly EgovSearch _searchService;
		private readonly DocFieldBll _docFieldService;
		private readonly UserBll _userService;
		private readonly JobTitlesBll _jobTitlesService;
		private readonly PositionBll _positionService;
		private readonly DocFinishBll _docFinishService;
		private readonly WorktimeHelper _workTimeHelper;
		private readonly SmsSettings _smsSettings;
		private readonly LuceneBll _luceneService;
		private readonly UserActivityLogBll _userActivityLogService;
		private readonly ResourceBll _resourceService;
		private readonly FileUploadSettings _fileUploadSettings;
		private readonly UserConnectionBll _userConnectionService;
		private readonly DocumentOnlineBll _docOnlineService;
		private readonly Helper.UserSetting _helperUserSetting;
		private readonly ConnectionSettings _connectionSettings;
		private readonly SsoSettings _ssoSettings;
		private readonly LanguageSettings _languageSettings;
		private readonly DepartmentBll _departmentService;
		private readonly PermissionBll _permissionSerice;
		private readonly TreeGroupBll _treeGroupSerice;
		private readonly DocColumnSettingBll _docColumnSettingSerice;
		private readonly InfomationBll _infoService;
		private readonly CategoryBll _categoryService;
		private readonly SignatureBll _signatureService;

		private readonly CodeBll _codeService;
		private readonly StorePrivateBll _storePrivateService;
		private readonly CommonCommentBll _commonCommentService;

		private readonly OnlineRegistrationSettings _onlineRegistrationSettings;
		private readonly FAQSetting _faqSettings;
		private readonly AttachmentBll _attachmentService;
		private readonly SettingBll _settingService;
		private readonly VoteSettings _voteSettings;
		private readonly VersionTreeSetting _versionTreeSettings;
		private readonly AuthenticationSettings _authenSetting;

		private LicenseSettings _license;

		private const string COLUMN_IS_VIEWED = "IsViewed";
		private const string COLUMN_KEY = "DocumentCopyId";
		private const string COLUMN_COMPENDIUM = "Compendium";
		private const string COLUMN_DOCTYPE_ID = "DocTypeId";
		private const string EMOTICONS_PATH = "~/Content/bkav.egov/emoticons";

		#endregion properties

		#region constructor

		public HomeSMReportController(
			DocumentOnlineBll docOnlineService,
			AdminGeneralSettings generalSettings,
			ImageSettings insertImageSettings,
			DocTypeBll docTypeBll,
			DocumentCopyBll documentCopyService,
			DocumentBll documentService,
			ProcessFunctionBll processFunctionService,
			ProcessFunctionGroupBll processFunctionGroupService,
			EgovSearch searchService,
			DocFieldBll docFieldService,
			UserBll userService,
			DocFinishBll docFinishService,
			WorktimeHelper workTimeHelper,
			SmsSettings smsSettings,
			UserActivityLogBll userLogServices,
			LuceneBll luceneService,
			UserActivityLogBll userActivityLogService,
			UserConnectionBll userConnectionService,
			ResourceBll resourceService,
			FileUploadSettings fileUploadSettings,
			Helper.UserSetting helperUserSetting,
			DepartmentBll departmentService,
			PermissionBll permissionSerice,
			LanguageSettings languageSettings,
			OnlineRegistrationSettings onlineRegistrationSettings,
			TreeGroupBll treeGroupSerice,
			DocColumnSettingBll docColumnSettingSerice,
			InfomationBll infoService,
			ConnectionSettings connectionSettings,
			FAQSetting faqSettings,
			CategoryBll categoryService,
			SettingBll settingService, AuthenticationSettings authenSettings,
			VoteSettings voteSetting, StorePrivateBll storePrivateService,
			VersionTreeSetting versionTreeSettings, PositionBll positionService,
			AttachmentBll attachmentService, JobTitlesBll jobTitlesService,
			SignatureBll signatureService, CommonCommentBll commonCommentService,
			CodeBll codeService)
		{
			_docOnlineService = docOnlineService;
			_generalSettings = generalSettings;
			_insertImageSettings = insertImageSettings;
			_docTypeService = docTypeBll;
			_processFunctionService = processFunctionService;
			_searchService = searchService;
			_docCopyService = documentCopyService;
			_docFieldService = docFieldService;
			_userService = userService;
			_docFinishService = docFinishService;
			_workTimeHelper = workTimeHelper;
			_smsSettings = smsSettings;
			_luceneService = luceneService;
			_userActivityLogService = userActivityLogService;
			_userConnectionService = userConnectionService;
			_resourceService = resourceService;
			_fileUploadSettings = fileUploadSettings;
			_processFunctionGroupService = processFunctionGroupService;
			_ssoSettings = SsoSettings.Instance;
			_connectionSettings = connectionSettings;
			_helperUserSetting = helperUserSetting;
			_departmentService = departmentService;
			_permissionSerice = permissionSerice;
			_languageSettings = languageSettings;
			_onlineRegistrationSettings = onlineRegistrationSettings;
			_treeGroupSerice = treeGroupSerice;
			_docColumnSettingSerice = docColumnSettingSerice;
			_infoService = infoService;
			_settingService = settingService;
			_faqSettings = faqSettings;
			_docService = documentService;
			_license = LicenseSettings.Current;
			_categoryService = categoryService;
			_voteSettings = voteSetting;
			_versionTreeSettings = versionTreeSettings;
			_attachmentService = attachmentService;
			_signatureService = signatureService;
			_jobTitlesService = jobTitlesService;
			_positionService = positionService;
			_storePrivateService = storePrivateService;
			_commonCommentService = commonCommentService;
			_authenSetting = authenSettings;
			_codeService = codeService;
		}

		#endregion constructor

		public ActionResult OverView()
		{
			var user = _userService.CurrentUser;
			ViewBag.Avatar = user.Avatar;
			ViewBag.FullName = user.FullName;
			ViewBag.ParentDomain = _ssoSettings.BkavSSOParentDomain;

			// ViewBag.Position = user.UserDepartmentJobTitless.First().DepartmentName;
			return View();
		}

		public ActionResult Statictis()
		{
			return View();
		}

		public ActionResult Main(bool isShowNotify = false)
		{
			var user = _userService.CurrentUser;
			if (user == null)
			{
				return RedirectToAction("LogOut", "Account");
			}

			if (_permissionSerice.HasPemission("WelcomeIndex"))//Nếu có quyền vào WelcomeIndex trong admin
			{
				ViewBag.IsAdmin = true;
				return RedirectToAction("General", "Setting", new { area = "Admin" });
			}

			ViewBag.SystemApps = GetDefaulApps(_connectionSettings);

			ViewBag.Username = user.Username;
			ViewBag.FullName = user.FullName;
			ViewBag.UserId = user.UserId;
			ViewBag.AvatarPath = _helperUserSetting.GetAvaterPath();

			ViewBag.Avatar = user.Avatar;

			var infomation = _infoService.GetCurrentOfficeName();
			ViewBag.OfficeName = infomation;

			var isDevVersion = false;
#if DEBUG
			isDevVersion = true;
#endif

			ViewBag.IsDevVersion = isDevVersion;

			ViewBag.IsCreateVote = _voteSettings.ListUserCreateVote().Contains(user.UserId) ? true : false;
			ViewBag.VersionValue = _versionTreeSettings.CacheVersion == null ? "DefaulValue" : _versionTreeSettings.CacheVersion;

			ViewBag.ParentDomain = _ssoSettings.BkavSSOParentDomain;

			if (Request.IsMobileOrTablet())
			{
				return RedirectToRoute(isShowNotify ? "MobileWithNotify" : "Mobile"); ;
			}

			return View("MainNew");
		}
		
		public ActionResult Index()
		{
			var allTreeGroups = _treeGroupSerice.GetCacheAllTreeGroups(true);
			if (allTreeGroups == null || !allTreeGroups.Any())
			{
				throw new ApplicationException(
					_resourceService.GetResource("Home.Index.NotConfigTreeGroup"));
			}

			ViewBag.AllTreeGroups = allTreeGroups.ToListModel();

			var user = _userService.CurrentUser;
			ViewBag.Avatar = user.Avatar;
			ViewBag.FullName = user.FullName;
			ViewBag.AvatarPath = _helperUserSetting.GetAvaterPath();

			///ViewBag.HasOnlineRegistration = _onlineRegistrationSettings.ToModel().HasPermisson(user.UserId);
			//ViewBag.OnlineRegistrationGroupId = _onlineRegistrationSettings.TreeGroupId;

			//ViewBag.HasFAQ = _faqSettings.ToModel().HasPermisson(user.UserId);
			//ViewBag.FAQGroupId = _faqSettings.TreeGroupId;
			//ViewBag.UserId = user.UserId;
			ViewBag.ParentDomain = _ssoSettings.BkavSSOParentDomain;
			ViewBag.UserId = user.UserId;

            var appSettings = ConfigurationManager.AppSettings;
            var urlOnlyOffice = appSettings["urlOnlyOffice"] ?? "";
            ViewBag.UrlOnlyOffice = urlOnlyOffice;

            return View("Index");
		}
        public string ReplaceInvalidChars(string filename)
        {
            return string.Join("_", filename.Split(Path.GetInvalidFileNameChars()));
        }

        [HttpPost]
        public string ExportFileExcel(string stringRows, string stringFileName,
            string leftHeader, string rightHeader, string middleHeader, string centerHeader,
            string leftFooter, string rightFooter, string middleFooter, string centerFooter,
            string ct, int posTextBold,string headerNested, string headerSetting, string hiddenColumns)
        {
            try
            {
                var memoryStream = new MemoryStream();
                using (var excelPackage = new ExcelPackage(memoryStream))
                {
                    var worksheet = excelPackage.Workbook.Worksheets.Add(stringFileName);

                    //Header
                    JArray lst_middle = (JArray)JsonConvert.DeserializeObject(middleHeader);
                    JArray lst_left = (JArray)JsonConvert.DeserializeObject(leftHeader);
                    JArray lst_right = (JArray)JsonConvert.DeserializeObject(rightHeader);
                    JArray lst_center = (JArray)JsonConvert.DeserializeObject(centerHeader);

                    int countLeft = lst_left.Count;
                    int countRight = lst_right.Count;
                    int countMiddle = lst_middle.Count;
                    int max;

                    max = (countLeft >= countRight) ? countLeft : countRight;

                    if (lst_middle.Count == 0)
                    {
                        for (int i = 0; i < lst_left.Count; i++)
                        {
                            var item = (JObject)lst_left[i];
                            JToken value = item["nameTag"];
                            worksheet.Cells[string.Format("B{0}", (i + 2))].Style.HorizontalAlignment = OfficeOpenXml.Style.ExcelHorizontalAlignment.Center;
                            worksheet.Cells[string.Format("B{0}", (i + 2))].Value = value.ToString();
                        }

                        if (lst_right.Count > 0) {
                            for (int i = 0; i < lst_right.Count; i++)
                            {
                                var item = (JObject)lst_right[i];
                                JToken value = item["nameTag"];
                                worksheet.Cells[string.Format("D{0}", (i + 2))].Style.HorizontalAlignment = OfficeOpenXml.Style.ExcelHorizontalAlignment.Center;
                                worksheet.Cells[string.Format("D{0}", (i + 2))].Value = value.ToString();
                            }
                        }

                        if (lst_center.Count > 0)
                        {
                            for (int i = 1; i < lst_center.Count; i++)
                            {
                                var item = (JObject)lst_center[i];
                                JToken value = item["nameTag"];
                                worksheet.Cells[string.Format("A{0}:F{1}", (max + i + 1), (max + i + 1))].Style.HorizontalAlignment = OfficeOpenXml.Style.ExcelHorizontalAlignment.Center;
                                worksheet.Cells[string.Format("A{0}:F{1}", (max + i + 1), (max + i + 1))].Merge = true;
                                worksheet.Cells[string.Format("A{0}:F{1}", (max + i + 1), (max + i + 1))].Style.Font.Bold = true;
                                worksheet.Cells[string.Format("A{0}:F{1}", (max + i + 1), (max + i + 1))].Value = value.ToString();
                                worksheet.Cells[string.Format("A{0}:F{1}", (max + i + 1), (max + i + 1))].AutoFitColumns();
                            }
                        }
                    }
                    else {
                        int max2 = (max > countMiddle) ? max : countMiddle;
                        if (lst_left.Count > 0) {
                            for (int i = 0; i < lst_left.Count; i++)
                            {
                                var item = (JObject)lst_left[i];
                                JToken value = item["nameTag"];
                                worksheet.Cells[string.Format("B{0}", (i + 2))].Style.HorizontalAlignment = OfficeOpenXml.Style.ExcelHorizontalAlignment.Center;
                                worksheet.Cells[string.Format("B{0}", (i + 2))].Value = value.ToString();
                            }
                        }

                        if (lst_middle.Count > 0) {
                            for (int i = 0; i < lst_middle.Count; i++)
                            {
                                var item = (JObject)lst_middle[i];
                                JToken value = item["nameTag"];
                                worksheet.Cells[string.Format("D{0}", (i + 2))].Style.HorizontalAlignment = OfficeOpenXml.Style.ExcelHorizontalAlignment.Center;
                                worksheet.Cells[string.Format("D{0}", (i + 2))].Value = value.ToString();
                            }
                        }

                        if (lst_right.Count > 0)
                        {
                            for (int i = 0; i < lst_right.Count; i++)
                            {
                                var item = (JObject)lst_right[i];
                                JToken value = item["nameTag"];
                                worksheet.Cells[string.Format("F{0}", (i + 2))].Style.HorizontalAlignment = OfficeOpenXml.Style.ExcelHorizontalAlignment.Center;
                                worksheet.Cells[string.Format("F{0}", (i + 2))].Value = value.ToString();
                            }
                        }

                        if (lst_center.Count >0) {
                            for (int i = 1; i < lst_center.Count; i++)
                            {
                                var item = (JObject)lst_center[i];
                                JToken value = item["nameTag"];
                                worksheet.Cells[string.Format("A{0}:F{1}", (max2 + i + 1), (max2 + i + 1))].Style.HorizontalAlignment = OfficeOpenXml.Style.ExcelHorizontalAlignment.Center;
                                worksheet.Cells[string.Format("A{0}:F{1}", (max2 + i + 1), (max2 + i + 1))].Merge = true;
                                worksheet.Cells[string.Format("A{0}:F{1}", (max2 + i + 1), (max2 + i + 1))].Style.Font.Bold = true;
                                worksheet.Cells[string.Format("A{0}:F{1}", (max2 + i + 1), (max2 + i + 1))].Value = value.ToString();
                                worksheet.Cells[string.Format("A{0}:F{1}", (max2 + i + 1), (max2 + i + 1))].AutoFitColumns();
                            }
                        }
                    }
                    //endHeader

                    //Data
                    int startRowData = lst_left.Count > 0 ? 14 : 1;
                    JArray items = (JArray)JsonConvert.DeserializeObject(stringRows);

                    JArray listMergeHeader = (JArray)JsonConvert.DeserializeObject(headerNested);
                    JArray listHeaderSetting = (JArray)JsonConvert.DeserializeObject(headerSetting);
                    JArray listHiddenColumns = (JArray)JsonConvert.DeserializeObject(hiddenColumns); 

                    if (listMergeHeader.Count > 0)
                    {             
                        if (listHeaderSetting.Count > 1)
                        {
                            for (int _merge = 0; _merge < listMergeHeader.Count; _merge++)
                            {
                                var merge = (JObject)listMergeHeader[_merge];
                                var col = Int32.Parse(merge["col"].ToString());
                                var colspan = Int32.Parse(merge["colspan"].ToString());
                                var row = Int32.Parse(merge["row"].ToString());
                                var rowspan = Int32.Parse(merge["rowspan"].ToString());

                                if (listHiddenColumns.Count > 0)
                                {
                                    for (int hiddenCount = 0; hiddenCount < listHiddenColumns.Count; hiddenCount++)
                                    {
                                        var hiddenCol = listHiddenColumns[hiddenCount];
                                        if (hiddenCol.ToObject<int>() != col)
                                        {
                                            if (row >= listHeaderSetting.Count - 1 && colspan > 1)
                                            {

                                            }
                                            else
                                            {
                                                var cell = worksheet.Cells[row + 1, col, row + rowspan, col + colspan - 1];
                                                cell.Merge = true;
                                            }
                                        }
                                    }
                                }
                                else {
                                    if (row >= listHeaderSetting.Count - 1 && colspan > 1)
                                    {

                                    }
                                    else
                                    {
                                        var cell = worksheet.Cells[row + 1, col +1 , row + rowspan, col + colspan ];
                                        cell.Merge = true;
                                    }
                                }
                                
                            }
                        }
                        //for (int _merge = 0; _merge < listMergeHeader.Count; _merge++)
                        //{
                        //    var merge = (JObject)listMergeHeader[_merge];
                        //    var col = Int32.Parse(merge["col"].ToString() ) +1;
                        //    var colspan = Int32.Parse(merge["colspan"].ToString() ) - 1;          
                        //    var row = Int32.Parse(merge["row"].ToString() ) + 1;
                        //    var rowspan = Int32.Parse(merge["rowspan"].ToString() ) +1;
                        //    worksheet.Cells[row, col, rowspan, colspan].Merge = true;
                        //}
                    }
                    //index header
                    var indexHeader = 0;
                    for (int i = 1; i < items.Count; i++)
                    {
                        var item = (JObject)items[i];
                        JArray arrindex = (JArray)JsonConvert.DeserializeObject(ct);
                        if (item.GetValue((arrindex[0].ToString()).ToString()).ToString().Trim() != "") {
                            indexHeader = i;
                            break;
                        }
                    }
                    //index header

                    for (int i = 0; i < items.Count; i++)
                    {
                        var item = (JObject)items[i];
                        JArray arrindex = (JArray)JsonConvert.DeserializeObject(ct);
                        for (int j = 0; j < arrindex.Count; j++)
                        {
                                int n;
                                string numTextBold = item.GetValue(posTextBold.ToString()).ToString();
                                bool isNumeric = int.TryParse(numTextBold, out n);
                           
                                if (i < indexHeader)
                                {
                                    worksheet.Cells[i + startRowData, j + 1].Style.Font.Bold = true;
                                    worksheet.Cells[i + startRowData, j + 1].Value = ((JObject)items[i]).GetValue((arrindex[j].ToString()).ToString()).ToString();
                                    worksheet.Row(i + startRowData).Height = 60;
                                    worksheet.Cells[i + startRowData, j + 1].Style.WrapText = true;
                                    worksheet.Cells[i + startRowData, j + 1].Style.HorizontalAlignment = OfficeOpenXml.Style.ExcelHorizontalAlignment.Center;
                                    worksheet.Cells[i + startRowData, j + 1].Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
                                }
                                else
                                {
                                    if (j == 1)
                                    {
                                        if (isNumeric)
                                        {
                                            worksheet.Cells[i + startRowData, j + 1].Style.Font.Bold = true;
                                            worksheet.Cells[i + startRowData, j + 1].Value = item.GetValue((arrindex[j].ToString()).ToString()).ToString();
                                            worksheet.Cells[i + startRowData, j + 1].Style.HorizontalAlignment = OfficeOpenXml.Style.ExcelHorizontalAlignment.Left;
                                        }
                                        else
                                        {
                                            worksheet.Cells[i + startRowData, j + 1].Value = item.GetValue((arrindex[j].ToString()).ToString()).ToString();
                                            worksheet.Cells[i + startRowData, j + 1].Style.HorizontalAlignment = OfficeOpenXml.Style.ExcelHorizontalAlignment.Left;
                                        }
                                    }
                                    else
                                    {
                                        if (isNumeric)
                                        {
                                            worksheet.Cells[i + startRowData, j + 1].Style.Font.Bold = true;
                                            worksheet.Cells[i + startRowData, j + 1].Value = item.GetValue((arrindex[j].ToString()).ToString()).ToString();
                                            worksheet.Cells[i + startRowData, j + 1].Style.HorizontalAlignment = OfficeOpenXml.Style.ExcelHorizontalAlignment.Center;
                                            worksheet.Cells[i + startRowData, j + 1].Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
                                        }
                                        else
                                        {
                                            worksheet.Cells[i + startRowData, j + 1].Value = item.GetValue((arrindex[j].ToString()).ToString()).ToString();
                                            worksheet.Cells[i + startRowData, j + 1].Style.HorizontalAlignment = OfficeOpenXml.Style.ExcelHorizontalAlignment.Center;
                                            worksheet.Cells[i + startRowData, j + 1].Style.VerticalAlignment = OfficeOpenXml.Style.ExcelVerticalAlignment.Center;
                                        }
                                    }
                                }
                          
                            
                                worksheet.Cells[i + startRowData, j + 1].Style.Border.Top.Style = OfficeOpenXml.Style.ExcelBorderStyle.Thin;
                                worksheet.Cells[i + startRowData, j + 1].Style.Border.Left.Style = OfficeOpenXml.Style.ExcelBorderStyle.Thin;
                                worksheet.Cells[i + startRowData, j + 1].Style.Border.Right.Style = OfficeOpenXml.Style.ExcelBorderStyle.Thin;
                                worksheet.Cells[i + startRowData, j + 1].Style.Border.Bottom.Style = OfficeOpenXml.Style.ExcelBorderStyle.Thin;
                            }
                    }
                    //End Data

                    //Footer
                    JArray lst_middle_footer = (JArray)JsonConvert.DeserializeObject(middleFooter);
                    JArray lst_left_footer = (JArray)JsonConvert.DeserializeObject(leftFooter);
                    JArray lst_right_footer = (JArray)JsonConvert.DeserializeObject(rightFooter);
                    JArray lst_center_footer = (JArray)JsonConvert.DeserializeObject(centerFooter);

                    int startFooter = items.Count + 16;

                    int countLeftFooter = lst_left_footer.Count;
                    int countRightFooter = lst_right_footer.Count;
                    int countMiddleFooter = lst_middle_footer.Count;
                    int maxFooter;

                    maxFooter = (countLeftFooter >= countRightFooter) ? countLeftFooter : countRightFooter;

                    if (lst_middle_footer.Count == 0)
                    {
                        for (int i = 0; i < lst_left_footer.Count; i++)
                        {
                            var item = (JObject)lst_left_footer[i];
                            JToken value = item["nameTag"];
                            worksheet.Cells[string.Format("B{0}", (startFooter + i) )].Value = value.ToString();
                        }

                        for (int i = 0; i < lst_right_footer.Count; i++)
                        {
                            var item = (JObject)lst_right_footer[i];
                            JToken value = item["nameTag"];
                            worksheet.Cells[string.Format("D{0}", (startFooter + i) )].Value = value.ToString();
                        }
                        if (lst_center_footer.Count > 0) {
                            for (int i = 1; i < lst_center_footer.Count; i++)
                            {
                                var item = (JObject)lst_center_footer[i];
                                JToken value = item["nameTag"];
                                worksheet.Cells[string.Format("A{0}:F{1}", (maxFooter + i + 1), (maxFooter + i + 1))].Merge = true;
                                worksheet.Cells[string.Format("A{0}:F{1}", (maxFooter + i + 1), (maxFooter + i + 1))].Style.Font.Bold = true;
                                worksheet.Cells[string.Format("A{0}:F{1}", (maxFooter + i + 1), (maxFooter + i + 1))].Value = value.ToString();
                                worksheet.Cells[string.Format("A{0}:F{1}", (maxFooter + i + 1), (maxFooter + i + 1))].AutoFitColumns();
                            }
                        }
                       
                    }
                    else
                    {
                        int maxFooter2 = (maxFooter > countMiddleFooter) ? maxFooter : countMiddleFooter;
                        if (lst_left_footer.Count > 0) {
                            for (int i = 0; i < lst_left_footer.Count; i++)
                            {
                                var item = (JObject)lst_left_footer[i];
                                JToken value = item["nameTag"];
                                worksheet.Cells[string.Format("B{0}", (startFooter + i))].Value = value.ToString();
                            }
                        }

                        if (lst_middle_footer.Count > 0) {
                            for (int i = 0; i < lst_middle_footer.Count; i++)
                            {
                                var item = (JObject)lst_middle[i];
                                JToken value = item["nameTag"];
                                worksheet.Cells[string.Format("D{0}", (startFooter + i))].Value = value.ToString();
                            }
                        }

                        if (lst_right_footer.Count > 0) {
                            for (int i = 0; i < lst_right_footer.Count; i++)
                            {
                                var item = (JObject)lst_right_footer[i];
                                JToken value = item["nameTag"];
                                worksheet.Cells[string.Format("F{0}", (startFooter + i))].Value = value.ToString();
                            }
                        }

                        if (lst_center_footer.Count > 0) {
                            for (int i = 1; i < lst_center_footer.Count; i++)
                            {
                                var item = (JObject)lst_center_footer[i];
                                JToken value = item["nameTag"];
                                worksheet.Cells[string.Format("A{0}:F{1}", (maxFooter2 + i + 1), (maxFooter2 + i + 1))].Merge = true;
                                worksheet.Cells[string.Format("A{0}:F{1}", (maxFooter2 + i + 1), (maxFooter2 + i + 1))].Style.Font.Bold = true;
                                worksheet.Cells[string.Format("A{0}:F{1}", (maxFooter2 + i + 1), (maxFooter2 + i + 1))].Value = value.ToString();
                                worksheet.Cells[string.Format("A{0}:F{1}", (maxFooter2 + i + 1), (maxFooter2 + i + 1))].AutoFitColumns();
                            }
                        }
                    }
                    //endFooter                

                   // worksheet.DefaultColWidth = 50;
                    worksheet.Cells["A1:AN1000"].Style.Font.Name = "Times New Roman";
                    worksheet.Cells["A1:AN1000"].Style.Font.Size = 13;
                    worksheet.Cells["A1:AN1000"].AutoFitColumns();
                    string date_now =  DateTime.UtcNow.ToString("yyyy-MM-dd-HH-mm-ss-fffffff");
                    stringFileName += "-" + date_now;
                    string FileName = ReplaceInvalidChars(stringFileName);
                    FileName = FileName.Replace("&", "");
                    FileName = FileName.Replace("!", "");
                    FileName = FileName.Replace("@", "");
                    FileName = FileName.Replace("$", "");
                    FileName = FileName.Replace("%", "");
                    var path = Path.Combine(ResourceLocation.Default.FileTemp, FileName+".xlsx");

                    System.IO.File.WriteAllBytes(path, excelPackage.GetAsByteArray());

                    return "/Temp/" + FileName + ".xlsx";
                }

            } catch (Exception ex) {
                throw;
            }
        }
        public ActionResult Error()
		{
			return View();
		}

		public ActionResult LicenseHasExpired()
		{
			return View();
		}

		public JsonResult GetConnectionSettings()
		{
			var apps = JsonConvert.DeserializeObject<List<Apps>>(_connectionSettings.Apps);
			var bmail = apps.FirstOrDefault(a => a.Name.Equals("bmail", StringComparison.OrdinalIgnoreCase));
			var chat = apps.FirstOrDefault(a => a.Name.Equals("chat", StringComparison.OrdinalIgnoreCase));
			return Json(new
			{
				ParentDomain = _ssoSettings.BkavSSOParentDomain,
				MailType = _connectionSettings.MailType,
				BmailLink = bmail == null ? "" : bmail.AppUrl,
				ChatLink = chat == null ? "" : chat.AppUrl
			}, JsonRequestBehavior.AllowGet);
		}

        public JsonResult GetDoctypePinned()
        {
            var user = _userService.CurrentUser;
            return Json(user.UserSetting, JsonRequestBehavior.AllowGet);
        }

        public JsonResult GetCommonConfigs()
		{
			var user = _userService.CurrentUser;
			var userId = user.UserId;

			var isMobile = Request.Browser.IsMobileDevice;

			// DVC setting
			var onlineRegistrationSettings = _onlineRegistrationSettings.ToModel();
			var faqSettings = _faqSettings.ToModel();

			// User settings
			var avatarPath = _generalSettings.Avatar;
			var userSettingModel = _helperUserSetting.GetUserSetting(user.UserSetting);

			// Notification
			var userNotify = _helperUserSetting.GetNotifyInfo(user.NotifyInfo);

			// Loại văn bản
			var doctypes = _docTypeService.GetsByUserId(userId).Select(dt => new
			{
				dt.DocTypeId,
				dt.DocTypeName,
				dt.DocFieldName,
				dt.DocFieldId,
				dt.CategoryBusinessId,
                dt.ActionLevel,
				Stores = dt.Stores.Where(s => s.ListUserViewIds.Contains(userId)).Select(s => new Store
				{
					StoreId = s.StoreId,
					StoreName = s.StoreName
				})
			});

            var allDoctypes = _docTypeService.Gets(d => d.IsActivated == true).Select(dt => new
            {
                dt.DocTypeId,
                dt.DocTypeName,
                dt.DocFieldName,
                dt.DocFieldId,
                dt.CategoryBusinessId,
                dt.ActionLevel
            }); ;

            var documentTemplates = GetDefaultDocumentTempate();

			// Cây văn bản
			var processFunction = _processFunctionService.GetsFromCache();

			// Cấu hình chữ ký số
			var signerConfig = _signatureService.Gets(s => s.UserId == userId)
									.Select(s => new
									{
										Id = s.SignatureId,
										Title = s.SignatureName,
										FindText = s.SearchWord,
										FindType = s.IsFindType ? 1 : 0,
										SignType = s.IsTypeImage ? 0 : 1,
										PosType = s.SignaturePosition,
										OffsetX = 0,
										OffsetY = 0,
										TextInfor = s.IsDispplayCertificate ? 1 : 0,
										ImagePath = s.Image,
										Ext = s.ImageExtension,
										hasSameToken = true
									});

			//TienNVg them truong cho cau hinh type Chuc vu, chuc danh
			var typePositionTitleJob = _generalSettings.TypePositionTitleJob;

			// Phòng ban hiện tại.
			var currentDepts = _departmentService.GetsPath(userId);
			var primaryDepartment = _departmentService.GetPrimaryDepartment(userId);

			// Danh sách người dùng
			var allUsers = _userService.GetAllCached(true)
				.Select(u => new
				{
					value = u.UserId,
					label = u.Username + " - " + u.FullName,
					fullname = u.FullName,
					username = u.Username,
					avatar = u.Avatar,
					status = u.Status
				})
				.OrderBy(u => u.username);

			// Danh sách phòng ban
			var allDeps = _departmentService
				.GetCacheAllDepartments(true)
				.Select(u => new
				{
					value = u.DepartmentId,
					parentid = u.ParentId.HasValue ? u.ParentId : 0,
					data = u.DepartmentName,
					metadata = new { id = u.DepartmentId },
					idext = u.DepartmentIdExt,
					state = "leaf",
					order = u.Order,
					level = u.Level,
					attr = new { id = u.DepartmentId, rel = "dept", idext = u.DepartmentIdExt, label = u.DepartmentPath },
					label = u.DepartmentLabel
				})
				.OrderBy(u => u.idext);

			// Danh sách chức danh
			var allJobtitles = _jobTitlesService.GetCacheAllJobtitles()
				.Select(u => new
				{
					value = u.JobTitlesId,
					label = u.JobTitlesName,
					isApprover = u.IsApproved
				})
				.OrderBy(u => u.label);

			// Danh sách chức vụ
			var allPositions = _positionService.GetCacheAllPosition()
				.Select(u => new
				{
					value = u.PositionId,
					label = u.PositionName,
					level = u.PriorityLevel,
					isApprover = u.IsApproved
				})
				.OrderBy(u => u.label);

			// Danh sách liên quan người dùng - phòng ban
			var allUserDeps = _departmentService.GetCacheAllUserDepartmentJobTitlesPosition().Select(
								t => new
								{
									departmentid = t.DepartmentId,
									userid = t.UserId,
									username = t.Username,
									fullname = t.UserFullName,
									positionid = t.PositionId,
									idext = t.DepartmentIdExt,
									jobtitleid = t.JobTitlesId,
									hasReceiveDocument = t.HasReceiveDocument
								});

			// Hồ sơ cá nhân
			var storeShare = _storePrivateService.GetsStoreShared(userId, parentId: 0).Select(s => new
			{
				id = s.StorePrivateId,
				storePrivateId = s.StorePrivateId,
				name = s.StorePrivateName,
				descStorePrivate = s.Description,
				parentId = s.ParentId,
				level = s.Level,
				status = s.Status,
				userCreated = s.CreatedByUserId,
				isStoreShared = s.HasShared,
				isPrivate = !s.HasShared,
				userIdJoined = s.UserIdJoined,
				deptIdJoined = s.DeptIdJoined
			});

			var storePrivate = _storePrivateService.GetsStorePrivate(userId, parentId: 0).Select(s => new
			{
				id = s.StorePrivateId,
				storePrivateId = s.StorePrivateId,
				name = s.StorePrivateName,
				descStorePrivate = s.Description,
				parentId = s.ParentId,
				level = s.Level,
				status = s.Status,
				isPrivate = true,
				userCreated = s.CreatedByUserId,
				userIdJoined = s.UserIdJoined,
				deptIdJoined = s.DeptIdJoined,
				isStoreShared = s.HasShared
			});

			var commentComments = _commonCommentService.Gets(c => c.UserId == userId);

			var codeNotations = _codeService.GetCodeNotations(userId);

			var requirePublishPlan = _generalSettings.RequirePublishPlanWhenCreate;
			if (requirePublishPlan && _generalSettings.IgnoreRequirePublishPlanList.Any())
			{
				requirePublishPlan = !_generalSettings.IgnoreRequirePublishPlanList.Any(u => u.Trim().Equals(user.Username, StringComparison.OrdinalIgnoreCase));
			}

			/*
             * Với request này cần trả về tất cả dữ liệu cần thiết để client chạy được luôn.
             * Cũng xem bỏ dần cache dưới client.
             */
			return Json(new
			{
				isMobile = isMobile,
				user = new
				{
					userId = user.UserId,
					fullName = user.FullName,
					userName = user.Username,
					userDomainName = user.UsernameEmailDomain,
					userSetting = userSettingModel,
					avatarPath = avatarPath,
					avatar = user.Avatar,
					signerConfig = signerConfig,
					notifyConfig = userNotify,
					primaryDepartment = primaryDepartment == null ? "" : primaryDepartment.DepartmentIdExt,
					defaultDomain = _authenSetting.DefaultDomain
				},
				commentComments = commentComments,
				moneyFormat = _generalSettings.MoneyFormat,
				isNotAllowFinishDocument = _generalSettings.IsNotAllowFinishDocument,
				isNotAllowRenewal = _generalSettings.IsNotAllowRenewal,
				fileUploadSettings = new
				{
					maxFileSize = _fileUploadSettings.FileUploadMaximumSizeBytes,
					acceptFileTypes = string.Join("|", _fileUploadSettings.FileUploadAllowedExtensions)
				},
				parentDomain = _ssoSettings.BkavSSOParentDomain,
				requirePublishPlan = requirePublishPlan,

				typePositionTitleJob = typePositionTitleJob,

				doctypes = doctypes,
                allDoctypes = allDoctypes,
				documentTemplates = documentTemplates,

				processFunction = processFunction,

				currentDepts = currentDepts,
				allUsers = allUsers,
				allDeps = allDeps,
				allJobtitles = allJobtitles,
				allPositions = allPositions,
				allUserDeps = allUserDeps,

				storeShare = storeShare,
				storePrivate = storePrivate,

				codeNotations = codeNotations,

				transfer = new
				{
					requireXlc = _generalSettings.RequireChooseXlc,
					requireCommentWhenFinish = _generalSettings.RequireCommentWhenFinish,
					showApproverByDepartment = _generalSettings.ShowApproverByDepartment,
					requirePlan = requirePublishPlan
				},

				publish = new
				{
					showPlaceInOffice = _generalSettings.ShowPlaceInOffice,
					detectPdfChangeContent = _generalSettings.DetectPdfChangeContent,
					allowThuHoiLt = _generalSettings.AllowThuHoiVbLienThong
				},

#if HoSoMotCuaEdition
				onlineRegistration = new
				{
					Active = onlineRegistrationSettings.HasPermisson(user.UserId),
					Name = onlineRegistrationSettings.Name,
					TreeGroupId = onlineRegistrationSettings.TreeGroupId,
					onlineApiUrl = onlineRegistrationSettings.ApiUrl,
				},
				faq = new
				{
					Active = faqSettings.HasPermisson(user.UserId),
					Name = faqSettings.Name,
					TreeGroupId = faqSettings.TreeGroupId,
					onlineApiUrl = faqSettings.ApiUrl
				}
#endif
			}, JsonRequestBehavior.AllowGet);
		}

		public void CheckConnection()
		{
			return;
		}

		#region Document Tree

		/// <summary>
		///
		/// </summary>
		/// <param name="id"></param>
		/// <returns></returns>
		public JsonResult GetFunctionByParentId(int id = 0)
		{
			var result = _processFunctionService.GetsFromCache(id);
			return Json(result, JsonRequestBehavior.AllowGet);
		}

		/// <summary>
		///
		/// </summary>
		/// <param name="id"></param>
		/// <returns></returns>
		public JsonResult GetFunctionHasTransferTheoLoByParentId(int id = 0)
		{
			if (id == 0)
			{
				return Json(_processFunctionService.GetsTransferTheoLoByParentId(null, User.GetUserId()), JsonRequestBehavior.AllowGet);
			}
			return Json(_processFunctionService.GetsTransferTheoLoByParentId(id, User.GetUserId()), JsonRequestBehavior.AllowGet);
		}

		[HttpPost]
		public JsonResult GetTotalDocumentUnreadMultiFunction(string ids)
		{
			if (string.IsNullOrEmpty(ids))
			{
				return null;
			}
			var functionIds = Json2.ParseAs<IEnumerable<int>>(ids);
			return Json(_processFunctionService.GetTotalDocumentUnreadMultiFunction(functionIds, User.GetUserId()));
		}

		#endregion

		#region Document List

		[HttpPost]
		public JsonResult GetDocuments(int id, GetDocumentParameters parameters,
			IEnumerable<int> reloadFunctionIds = null, IEnumerable<int> currentDocCopyIds = null, string paramsQuery = null)
		{
			var function = _processFunctionService.GetFromCache(id);
			if (function == null)
			{
				return null;
			}

			IEnumerable<IDictionary<string, object>> documents;

			//lấy kiểu phân trang
			int defaultPageSizeHome = _generalSettings.DefaultPageSizeHome;
			var userSettingModel = _helperUserSetting.GetUserCurrentSetting();
			if (userSettingModel != null)
			{
				defaultPageSizeHome = userSettingModel.DefaultPageSizeHome.HasValue
										? userSettingModel.DefaultPageSizeHome.Value
										: defaultPageSizeHome;
			}

			if (!string.IsNullOrWhiteSpace(paramsQuery) && paramsQuery != "[]")
			{
				var objectParams = Json2.ParseAs<List<ObjectParams>>(paramsQuery);
				if (objectParams != null && objectParams.Any())
				{
					foreach (var item in objectParams)
					{
						parameters.Params.Add(item.Key, item.Value);
					}
				}
			}

			// Mặc định để phân trang dạng scroll.
			IEnumerable<int> removeDocumentCopyIds = null;
			var totalDocuments = 0;
			var pageSize = defaultPageSizeHome;
            documents = _processFunctionService.GetDocumentLatestByFunction(out removeDocumentCopyIds, function, 
                new DateTime(2000,1,1 ), currentDocCopyIds, parameters.Params);
				
			var listSetting = _docColumnSettingSerice.GetAllCaches().FirstOrDefault(p => p.DocColumnSettingId == function.DocColumnSettingId);

			var isFilterByDocFieldDocType = false;
			var functionType = function.ProcessFunctionType;
			if (functionType != null)
			{
				var paramDocField = functionType.ListParam.FirstOrDefault(p => p.ValueField == "DocFieldId");
				if (paramDocField != null)
				{
					isFilterByDocFieldDocType = true;

					if (!parameters.Params.ContainsKey(paramDocField.ParamName))
					{
						throw new Exception("Chuỗi query string không có tham số " + paramDocField.ParamName);
					}
				}
			}

			var columnSetting = listSetting != null
							 ? Json2.ParseAs<List<Bkav.eGovCloud.Entities.Customer.Settings.ColumnSetting>>(listSetting.DisplayColumn)
							 : new List<Bkav.eGovCloud.Entities.Customer.Settings.ColumnSetting>();

			var docTypeColumnSettings = new Dictionary<string, List<Bkav.eGovCloud.Entities.Customer.Settings.ColumnSetting>>();

			if (documents.Any())
			{
				var listColumnNames = documents.First().Keys;
				if (!listColumnNames.Any(n => n.Equals(COLUMN_KEY)))
				{
					throw new Exception("Câu truy vấn không lấy ra cột " + COLUMN_KEY);
				}
				if (!listColumnNames.Any(n => n.Equals(COLUMN_COMPENDIUM)))
				{
					throw new Exception("Câu truy vấn không lấy ra cột trích yếu");
				}
				if (!listColumnNames.Any(n => n.Equals(COLUMN_IS_VIEWED)))
				{
					throw new Exception("Câu truy vấn không lấy ra cột đã đọc");
				}
				if (isFilterByDocFieldDocType)
				{
					if (!listColumnNames.Any(n => n.Equals(COLUMN_DOCTYPE_ID)))
					{
						throw new Exception("Câu truy vấn không lấy ra cột id của loại vb, hs");
					}
				}

				if (columnSetting.Count == 0)
				{
					columnSetting.AddRange(listColumnNames.Select(columnName => new Bkav.eGovCloud.Entities.Customer.Settings.ColumnSetting
					{
						ColumnName = columnName,
						DisplayName = columnName
					}));
				}
			}

			var totalUnread = 0;// _processFunctionService.GetTotalDocumentUnread(function, User.GetUserId(), parameters.Params);

			if (reloadFunctionIds != null && reloadFunctionIds.Any())
			{
				reloadFunctionIds = reloadFunctionIds.Where(i => i != function.ProcessFunctionId).Distinct();
				var reloadFunctions = _processFunctionService.GetTotalDocumentUnreadMultiFunction(reloadFunctionIds, User.GetUserId());
				return Json(new
				{
					listDocuments = new
					{
						totalUnread = totalUnread,
						page = 1,
						pageSize = pageSize,
						totalDocuments = totalDocuments,
						enablePaging = function.IsEnablePaging,
						isFilterByDocFieldDocType = isFilterByDocFieldDocType,
						dateFilter = string.IsNullOrEmpty(function.DateFilter) ? "" : function.DateFilter,
						dateFilterView = string.IsNullOrEmpty(function.DateFilterView) ? "" : function.DateFilterView,
						isOverdueFilter = function.IsOverdueFilter,
						isDateFilter = function.IsDateFilter,
						columnSetting = columnSetting,
						documents = documents.StringifyJs(),
						docTypeColumnSettings = docTypeColumnSettings,
						removeDocumentCopyIds = removeDocumentCopyIds
					},
					reloadFunctions
				});
			}

			return Json(new
			{
				totalUnread = totalUnread,
				page = 1,
				pageSize = defaultPageSizeHome,
				totalDocuments = totalDocuments,
				enablePaging = function.IsEnablePaging,
				isFilterByDocFieldDocType,
				dateFilter = string.IsNullOrEmpty(function.DateFilter) ? "" : function.DateFilter,
				dateFilterView = string.IsNullOrEmpty(function.DateFilterView) ? "" : function.DateFilterView,
				isOverdueFilter = function.IsOverdueFilter,
				isDateFilter = function.IsDateFilter,
				columnSetting = columnSetting,
				documents = documents,
				docTypeColumnSettings,
				removeDocumentCopyIds = removeDocumentCopyIds
			});
		}

		/// <summary>
		/// Trả về json danh sách các văn bản mới được thêm vào node và văn bản mới được xóa khỏi node
		/// </summary>
		/// <remarks>
		/// Sử dụng khi phân trang (cuộn) ở trang 1.
		/// </remarks>
		/// <param name="id">Id của node trên cây văn bản</param>
		/// <param name="parameters">Các tiêu chí phân trang</param>
		/// <param name="currentDocCopyIds">Danh sách các văn bản đã tải</param>
		/// <param name="paramsQuery"></param>
		/// <returns></returns>
		[HttpPost]
		public JsonResult GetLastestDocuments(int id,
			GetDocumentParameters parameters,
			IEnumerable<int> currentDocCopyIds = null,
			string paramsQuery = null)
		{
			var function = _processFunctionService.GetFromCache(id);
			if (function == null)
			{
				return null;
			}

			IEnumerable<int> removeDocumentCopyIds = null;
			IEnumerable<IDictionary<string, object>> documents = null;
			var pageSize = parameters.PageSize.HasValue
					? parameters.PageSize.Value
					: _generalSettings.DefaultPageSizeHome;

			if (!string.IsNullOrWhiteSpace(paramsQuery) && paramsQuery != "[]")
			{
				var objectParams = Json2.ParseAs<List<ObjectParams>>(paramsQuery);
				if (objectParams != null && objectParams.Any())
				{
					foreach (var item in objectParams)
					{
						parameters.Params.Add(item.Key, item.Value);
					}
				}
			}

				documents = _processFunctionService.GetDocumentLatestByFunction(out removeDocumentCopyIds,
																				function,
																				new DateTime(2000,01,01), currentDocCopyIds,
																				parameters.Params);
			return Json(new
			{
				documents = documents,
				removeds = removeDocumentCopyIds
			});
		}

		public JsonResult QuickViewDocument(string id)
		{
			int documentCopyId;
			if (Int32.TryParse(id, out documentCopyId))
			{
				var document = _docCopyService.GetFromCache(documentCopyId, CurrentUserId());
				var urgent = _resourceService.GetEnumDescription<Urgent>((Urgent)document.UrgentId);

				return Json(new
				{
					id = documentCopyId,
					type = 1,
					compendium = document.Compendium,
					lastComment =
						new
						{
							date = !document.LastDateComment.HasValue
									? string.Empty
									: document.LastDateComment.Value.ToString("dd/MM/yyyy hh:mm tt"),
							content = document.LastComment,
							user = document.LastUserComment
						},
					docType = document.DocTypeName,
					department = document.InOutPlace,
					dateCreate = document.DateCreated.ToString("dd/MM/yyyy"),
					lastUser = document.LastUserComment,
					docField = "",
					urgent = urgent,
					docCode = document.DocCode,
					totalPage = document.TotalPage,
					processinfo = document.ProcessInfo,
					approver = document.SuccessNote
				}, JsonRequestBehavior.AllowGet);
			}

			var documentOnline = _docOnlineService.Get(new Guid(id));
			if (documentOnline == null)
			{
				return null;
			}

			return Json(new
			{
				id = new Guid(id),
				type = 2,
				docCode = documentOnline.DocCode,
				docType = documentOnline.Doctype == null ? "" : documentOnline.Doctype.DocTypeName,
				dateReceived = documentOnline.DateReceived,
				dateAppoint = documentOnline.DateAppoint,
				personInfo = documentOnline.PersonInfo,
				email = documentOnline.Email,
				phone = documentOnline.Phone,
				address = documentOnline.Address,
			}, JsonRequestBehavior.AllowGet);
		}

		#endregion

		public ActionResult Setting()
		{
			return View();
		}

		public ActionResult Linkeds()
		{
			return View();
		}

		public void ExportDocumentListToXML(int id, string docCopyIds)
		{
			List<int> docIds = null;
			try
			{
				docIds = Json2.ParseAs<List<int>>(docCopyIds);
			}
			catch
			{
				throw new Exception(_resourceService.GetResource("Function.ExportFile.Error"));
			}

			var documents = _docCopyService.Gets(docIds);
			if (documents != null && documents.Count() > 0)
			{
				ExportToXML(documents);
			}
		}

		/// <summary>
		///
		/// </summary>
		/// <param name="id"></param>
		/// <returns></returns>
		public JsonResult GetVersionValue()
		{
			var version = _versionTreeSettings.CacheVersion == null ? "DefaulValue" : _versionTreeSettings.CacheVersion;
			return Json(version, JsonRequestBehavior.AllowGet);
		}

		/// <summary>
		///
		/// </summary>
		/// <returns></returns>
		public JsonResult SetVersionValue()
		{
			var version = DateTime.Now.ToString();
			_versionTreeSettings.CacheVersion = version;
			_settingService.SaveSetting(_versionTreeSettings);
			return Json(version, JsonRequestBehavior.AllowGet);
		}

		#region Private

		private Dictionary<string, string> GetDefaultDocumentTempate()
		{
			var vbdenTemplate = Business.Utils.DocumentHelper.GetDocumentTemplate(CategoryBusinessTypes.VbDen);
			var vbdiTemplate = Business.Utils.DocumentHelper.GetDocumentTemplate(CategoryBusinessTypes.VbDi);
			var hsmcTemplate = Business.Utils.DocumentHelper.GetDocumentTemplate(CategoryBusinessTypes.Hsmc);
			var result = new Dictionary<string, string>();
			result.Add("vbden", vbdenTemplate);
			result.Add("vbdi", vbdiTemplate);
			result.Add("hsmc", hsmcTemplate);

			return result;
		}

		private void ExportToXML(IEnumerable<DocumentCopy> documents)
		{
			var result = new XmlDocument();
			result.LoadXml("<egov></egov>");

			DocumentsToXml(documents, result);

			var s = result.OuterXml;

			var filename = "eGovExport_" + DateTime.Now.ToString("yyMddHHmmss");
			var attachment = "attachment; filename=" + filename + ".xml";
			Response.ClearContent();
			Response.ContentType = "application/xml";
			Response.AddHeader("content-disposition", attachment);
			Response.Write(s);
			Response.End();
		}

		private void DocumentsToXml(IEnumerable<DocumentCopy> documents, XmlDocument doc)
		{
			var root = doc.GetElementsByTagName("egov")[0];
			foreach (var dc in documents)
			{
				var docElement = doc.CreateElement("document");
				var document = dc.Document;
				if (document.CategoryBusinessIdInEnum == CategoryBusinessTypes.VbDen)
				{
					docElement.AppendChild(CreateNodeFromDocument("Organization", doc, document.Organization == null ? "" : document.Organization));
				}
				else if (document.CategoryBusinessIdInEnum == CategoryBusinessTypes.VbDi)
				{
					docElement.AppendChild(CreateNodeFromDocument("Organization", doc, document.Organization == null ? "" : document.InOutPlace));
				}
				docElement.AppendChild(CreateNodeFromDocument("DocCode", doc, document.DocCode));
				docElement.AppendChild(CreateNodeFromDocument("InOutCode", doc, document.InOutCode));
				docElement.AppendChild(CreateNodeFromDocument("Compendium", doc, document.Compendium));
				docElement.AppendChild(CreateNodeFromDocument("DocTotal", doc, 1));
				docElement.AppendChild(CreateNodeFromDocument("DocPage", doc, document.TotalPage ?? 1));
				docElement.AppendChild(CreateNodeFromDocument("Category", doc, document.CategoryName));
				docElement.AppendChild(CreateNodeFromDocument("DatePublished", doc, document.DatePublished.HasValue ? document.DatePublished.Value.ToString("dd/MM/yyyy") : ""));
				docElement.AppendChild(CreateNodeFromDocument("DateCreated", doc, document.DateCreated.ToString("dd/MM/yyyy")));
				docElement.AppendChild(CreateNodeFromDocument("Security", doc, document.SecurityId == null || document.SecurityId == 1 ? "Thường" : document.SecurityId == 2 ? "Mật" : "Tối mật"));
				docElement.AppendChild(CreateNodeFromDocument("Urgent", doc, _resourceService.GetEnumDescription<Urgent>((Urgent)document.UrgentId)));
				docElement.AppendChild(CreateNodeFromDocument("InOutPlace", doc, document.InOutPlace));
				docElement.AppendChild(CreateNodeFromDocument("Note", doc, ""));
				docElement.AppendChild(CreateNodeFromDocument("Approver", doc, document.SuccessNote));

				if (document.Attachments != null)
				{
					var attachmentsNode = doc.CreateElement("Attachments");
					var attachmentIds = document.Attachments.Select(a => a.AttachmentId).ToList();
					var attachmentFiles = _attachmentService.DownloadAttachmentName(attachmentIds, User.GetUserId());
					if (attachmentFiles != null)
					{
						foreach (var file in attachmentFiles)
						{
							var attachmentNode = doc.CreateElement("Attachment");
							attachmentNode.AppendChild(CreateNodeFromDocument("Name", doc, file.Key));
							attachmentNode.AppendChild(CreateNodeFromDocument("Value", doc, file.Value));

							attachmentsNode.AppendChild(attachmentNode);
						}
						docElement.AppendChild(attachmentsNode);
					}

				}

				root.AppendChild(docElement);
			}
		}

		private XmlElement CreateNodeFromDocument(string name, XmlDocument doc, object value)
		{
			var result = doc.CreateElement(name);
			result.InnerText = value == null ? "" : value.ToString();
			return result;
		}

		private string GetDefaulApps(ConnectionSettings connectionSettings)
		{
			if (string.IsNullOrWhiteSpace(connectionSettings.Apps))
			{
				var settingService = DependencyResolver.Current.GetService<SettingBll>();
				var newApps = new List<Apps>();

				newApps.Add(new Apps
				{
					Id = 1,
					Name = "bmail",
					Title = "Điều hành",
					Order = 1,
					IsDefaultApp = false,
					IsBackgroundApp = false,
					AppUrl = connectionSettings.BmailLink,
					IsActived = !string.IsNullOrWhiteSpace(connectionSettings.BmailLink)
				});

				newApps.Add(new Apps
				{
					Id = 2,
					Name = "documents",
					Title = "Văn bản",
					AppUrl = "/Home/Index",
					Order = 2,
					IsDefaultApp = true,
					IsBackgroundApp = false,
					IsActived = true
				});

				newApps.Add(new Apps
				{
					Id = 3,
					Name = "chat",
					Title = "Trao đổi",
					AppUrl = connectionSettings.ChatLink,
					Order = 3,
					IsDefaultApp = false,
					IsBackgroundApp = false,
					IsActived = !string.IsNullOrWhiteSpace(connectionSettings.ChatLink)
				});
				newApps.Add(new Apps
				{
					Id = 4,
					Name = "calendar",
					Title = "Lịch làm việc",
					AppUrl = connectionSettings.BmailLink,
					Order = 4,
					IsDefaultApp = false,
					IsBackgroundApp = false,
					IsActived = !string.IsNullOrWhiteSpace(connectionSettings.BmailLink)
				});
				newApps.Add(new Apps
				{
					Id = 5,
					Name = "report",
					Title = "Báo cáo",
					AppUrl = "/ReportViewer/Index",
					Order = 5,
					IsDefaultApp = false,
					IsBackgroundApp = false,
					IsActived = true
				});
				newApps.Add(new Apps
				{
					Id = 6,
					Name = "statistics",
					Title = "Giám sát",
					AppUrl = "/statistics/Index",
					Order = 6,
					IsDefaultApp = false,
					IsBackgroundApp = false,
					IsActived = true
				});
				connectionSettings.Apps = newApps.Stringify();
				settingService.SaveSetting(connectionSettings);
			}
			return connectionSettings.Apps;
		}

		private void ExportToFile(ProcessFunction function, System.Data.DataTable documents, string exportKey = "EXCELL")
		{
			string fileName = string.Empty;
			var functionFile = Json2.ParseAs<Entities.Customer.FunctionFile>(function.ExportFileConfig);
			var strPath = LoadCrystalFile(functionFile);
			var rd = new CrystalDecisions.CrystalReports.Engine.ReportDocument();
			rd.Load(strPath);
			rd.SetDataSource(documents);

			if (exportKey == "EXCELL")
			{
				rd.ExportToHttpResponse(CrystalDecisions.Shared.ExportFormatType.Excel,
					System.Web.HttpContext.Current.Response, true, function.Name.StripVietnameseChars() + ".xls");
			}
			else if (exportKey == "WORD")
			{
				rd.ExportToHttpResponse(CrystalDecisions.Shared.ExportFormatType.WordForWindows,
				   System.Web.HttpContext.Current.Response, true, function.Name.StripVietnameseChars() + ".doc");
			}
			rd.Close();
		}

		private string LoadCrystalFile(Entities.Customer.FunctionFile functionFile)
		{
			var stream = _processFunctionService.Download(functionFile);
			var tempPath = ResourceLocation.Default.FileUploadTemp;
			var temp = FileManager.Default.Create(stream, tempPath, null, ".rpt");
			return temp.FullName;
		}

		private int CurrentUserId()
		{
			return _userService.CurrentUser.UserId;
		}

		#endregion

		#region bỏ

		//[HttpPost]
		//public JsonResult GetDocumentPaging(int id, GetDocumentParameters parameters, string paramsQuery = null)
		//{
		//    var function = _processFunctionService.GetFromCache(id);
		//    if (function != null)
		//    {
		//        var totalDocuments = 0;
		//        var pageSize = 0;
		//        var page = 0;
		//        IEnumerable<IDictionary<string, object>> documents;

		//        //lấy kiểu phân trang
		//        bool isLoadPageScroll = _generalSettings.IsLoadPageScroll;
		//        int defaultPageSizeHome = _generalSettings.DefaultPageSizeHome;

		//        var userSettingModel = _helperUserSetting.GetUserCurrentSetting();
		//        if (userSettingModel != null)
		//        {
		//            isLoadPageScroll = userSettingModel.IsLoadPageScroll;
		//            defaultPageSizeHome = userSettingModel.DefaultPageSizeHome.HasValue
		//                                    ? userSettingModel.DefaultPageSizeHome.Value
		//                                    : defaultPageSizeHome;
		//        }

		//        if (!string.IsNullOrWhiteSpace(paramsQuery) && paramsQuery != "[]")
		//        {
		//            var objectParams = Json2.ParseAs<List<ObjectParams>>(paramsQuery);
		//            if (objectParams != null && objectParams.Any())
		//            {
		//                foreach (var item in objectParams)
		//                {
		//                    parameters.Params.Add(item.Key, item.Value);
		//                }
		//            }
		//        }

		//        if (isLoadPageScroll)
		//        {
		//            documents = _processFunctionService.GetDocumentOlderByFunction(function,
		//                                                                           parameters.LastDate.HasValue
		//                                                                           ? parameters.LastDate.Value
		//                                                                           : DateTime.Now,
		//                                                                           defaultPageSizeHome + 1,
		//                                                                           parameters.Params, parameters.QuickSearch);
		//        }
		//        else
		//        {
		//            pageSize = parameters.PageSize.HasValue
		//                       ? parameters.PageSize.Value
		//                       : defaultPageSizeHome;
		//            page = parameters.Page.HasValue
		//                   ? parameters.Page.Value
		//                   : 1;
		//            documents = _processFunctionService.GetDocumentPagingByFunction(out totalDocuments
		//                                                                            , function
		//                                                                            , page
		//                                                                            , pageSize + 1
		//                                                                            , parameters.Params
		//                                                                            , parameters.QuickSearch);
		//        }
		//        return Json(new { documents = documents, totalDocuments, pageSize, page });
		//    }
		//    return null;
		//}

		///// <summary>
		///// HopCV:100914
		///// Hàm lấy văn bản theo node của cầy văn bản trên tablet hoặc mobile
		///// Khi người dung scroll thì sẽ lấy ra văn bản theo node hiện tại và các diều kiện truyền vào để lấy ra các văn bản
		///// </summary>
		///// <param name="id">id cuar node cây văn bản để lấy văn bản</param>
		///// <param name="parameters">Đối tượng tham số truyền vào để lọc lấy văn bản</param>
		///// <param name="paramsQuery"></param>
		///// <returns></returns>
		//[HttpPost]
		//public JsonResult GetDocumentPagingForTabletAndMobile(int id, GetDocumentParameters parameters, string paramsQuery = null)
		//{
		//    var function = _processFunctionService.GetFromCache(id);
		//    if (function == null)
		//    {
		//        return null;
		//    }

		//    IEnumerable<IDictionary<string, object>> documents;
		//    int defaultPageSizeHome = _generalSettings.DefaultPageSizeHome;

		//    var userSettingModel = _helperUserSetting.GetUserCurrentSetting();
		//    if (userSettingModel != null)
		//    {
		//        defaultPageSizeHome = userSettingModel.DefaultPageSizeHome.HasValue
		//                                ? userSettingModel.DefaultPageSizeHome.Value
		//                                : defaultPageSizeHome;
		//    }

		//    if (!string.IsNullOrWhiteSpace(paramsQuery) && paramsQuery != "[]")
		//    {
		//        var objectParams = Json2.ParseAs<List<ObjectParams>>(paramsQuery);
		//        if (objectParams != null && objectParams.Any())
		//        {
		//            foreach (var item in objectParams)
		//            {
		//                parameters.Params.Add(item.Key, item.Value);
		//            }
		//        }
		//    }

		//    documents = _processFunctionService.GetDocumentOlderByFunction(function,
		//                                                                   parameters.LastDate.HasValue
		//                                                                   ? parameters.LastDate.Value
		//                                                                   : DateTime.Now,
		//                                                                   defaultPageSizeHome + 1,
		//                                                                   parameters.Params, parameters.QuickSearch);

		//    return Json(new { documents = documents });
		//}

		//public void ExportToFile(int id, string docCopyIds, string paramsQuery = null, string exportKey = "EXCELL")
		//{
		//    var function = _processFunctionService.GetFromCache(id);
		//    if (function == null)
		//    {
		//        throw new Exception(_resourceService.GetResource("Function.NotFound"));
		//    }

		//    if (!function.HasExportFile)
		//    {
		//        throw new Exception(_resourceService.GetResource("Function.NotSuportExportFile"));
		//    }

		//    var parameters = new Dictionary<string, string>();
		//    if (!string.IsNullOrWhiteSpace(paramsQuery) && paramsQuery != "[]")
		//    {
		//        var objectParams = Json2.ParseAs<List<ObjectParams>>(paramsQuery);
		//        if (objectParams != null && objectParams.Any())
		//        {
		//            foreach (var item in objectParams)
		//            {
		//                parameters.Add(item.Key, item.Value);
		//            }
		//        }
		//    }
		//    List<int> docIds = null;
		//    try
		//    {
		//        docIds = Json2.ParseAs<List<int>>(docCopyIds);
		//    }
		//    catch
		//    {
		//        throw new Exception(_resourceService.GetResource("Function.ExportFile.Error"));
		//    }
		//    var documents = _processFunctionService.GetDataExportToFile(function, docIds, parameters, null);
		//    if (documents == null || documents.Rows.Count <= 0)
		//    {
		//        throw new Exception(_resourceService.GetResource("Function.ExportFile.Documents.IsNull"));
		//    }

		//    try
		//    {
		//        ExportToFile(function, documents, exportKey);
		//    }
		//    catch (Exception ex)
		//    {
		//        LogException(ex);
		//        throw new Exception(_resourceService.GetResource("Function.ExportFile.Error"));
		//    }
		//}

		//public void ExportDocumentListToExcel(int id, string docCopyIds)
		//{
		//    var function = _processFunctionService.GetFromCache(id);
		//    if (function == null)
		//    {
		//        return;
		//    }

		//    var documentCopyIds = Json2.ParseAs<List<int>>(docCopyIds);
		//    var userId = User.GetUserId();
		//    var dataReport = _processFunctionService.GetDataExport(function, documentCopyIds, userId);
		//    ExportToFile(function, dataReport);
		//}

		//public void ExportDocumentListToWord(int id, string docCopyIds)
		//{
		//    var function = _processFunctionService.GetFromCache(id);
		//    if (function == null)
		//    {
		//        return;
		//    }

		//    var documentCopyIds = Json2.ParseAs<List<int>>(docCopyIds);
		//    var userId = User.GetUserId();
		//    var dataReport = _processFunctionService.GetDataExport(function, documentCopyIds, userId);
		//    ExportToFile(function, dataReport, "WORD");
		//}

		//public ActionResult CreateNewApp()
		//{
		//    return View(new Apps());
		//}

		//[HttpPost]
		//public JsonResult CreateNewApp(Apps model)
		//{
		//    bool success = false;
		//    try
		//    {
		//        var currentSetting = _helperUserSetting.GetUserCurrentSetting();

		//        var id = currentSetting.AppCreates.Count + 1;
		//        model.Id = id;
		//        model.Name = "customApp_" + id;
		//        currentSetting.AppCreates.Add(model);
		//        var json = currentSetting.StringifyJs();
		//        _userService.UpdateUserSetting(json);
		//        success = true;
		//        return Json(new { success, name = model.Name, id = model.Id, message = "Success" });
		//    }
		//    catch (Exception)
		//    {
		//    }

		//    return Json(new { success, message = "Error" });
		//}

		//[HttpPost]
		//public JsonResult DeleteApp(int id)
		//{
		//    bool success = false;
		//    try
		//    {
		//        var currentSetting = _helperUserSetting.GetUserCurrentSetting();
		//        var apps = currentSetting.AppCreates;
		//        var deleteApp = apps.FirstOrDefault(x => x.Id == id);
		//        if (deleteApp != null)
		//        {
		//            apps.Remove(deleteApp);
		//        }
		//        for (int i = 0; i < apps.Count; i++)
		//        {
		//            apps[i].Id = i + 1;
		//        }

		//        currentSetting.AppCreates = apps;
		//        var json = currentSetting.StringifyJs();
		//        _userService.UpdateUserSetting(json);
		//        success = true;
		//        return Json(new { success, message = "Success" });
		//    }
		//    catch (Exception)
		//    {
		//    }

		//    return Json(new { success, message = "Error" });
		//}

		//public JsonResult AppIconUpload()
		//{
		//    var file = Request.Files["file"];
		//    bool success = false;
		//    if (file != null && file.ContentLength > 0)
		//    {
		//        if (file.InputStream.Length > _fileUploadSettings.ProfilePictureMaximumSizeBytes)
		//        {
		//            return Json(new { success, message = _resourceService.GetResource("Account.Avartar.Fields.FileUploadMaximumSizeBytes") + " (" + _fileUploadSettings.ProfilePictureMaximumSizeBytes + " KB)" });
		//        }
		//        var ext = Path.GetExtension(file.FileName);
		//        if (!_fileUploadSettings.ProfilePictureAllowedExtensions.Any(t => t.ToLower().Equals(ext.ToLower())))
		//        {
		//            return Json(new { success, message = _resourceService.GetResource("Account.Avartar.Fields.FileUploadAllowedExtensions") });
		//        }

		//        Helper.ResizeAndCropImage.CropAndCropResizeImage(file.InputStream, 25, 25,
		//                                                        Server.MapPath("~/ImagesUpload/") + file.FileName + ".jpg");
		//        success = true;
		//        return Json(new { success, Avatar = "/ImagesUpload/" + file.FileName + ".jpg" });
		//    }

		//    return Json(new { success, message = "Error" });
		//}

		public JsonResult HasHideSaveStore(bool hasHideStore = false)
		{
			var user = _userService.CurrentUser;
			var userSettingModel = _helperUserSetting.GetUserSetting(user.UserSetting);
			if (userSettingModel != null)
			{
				userSettingModel.HasHideLuuSo = hasHideStore;

				var json = userSettingModel.StringifyJs();
				_userService.UpdateUserSetting(json);

				return Json(new { status = true, data = hasHideStore }, JsonRequestBehavior.AllowGet);
			}
			return Json(new { status = false, data = false }, JsonRequestBehavior.AllowGet);
		}

		///// <summary>
		/////
		///// </summary>
		///// <param name="id"></param>
		///// <param name="parameters"></param>
		///// <param name="paramsQuery"></param>
		///// <returns></returns>
		//[HttpPost]
		//public int GetTotalDocumentUnread(int id, GetDocumentParameters parameters, string paramsQuery = null)
		//{
		//    var function = _processFunctionService.GetFromCache(id);

		//    if (!string.IsNullOrWhiteSpace(paramsQuery))
		//    {
		//        var objectParams = Json2.ParseAs<List<ObjectParams>>(paramsQuery);
		//        if (objectParams != null && objectParams.Any())
		//        {
		//            foreach (var item in objectParams)
		//            {
		//                parameters.Params.Add(item.Key, item.Value);
		//            }
		//        }
		//    }
		//    return function == null
		//               ? 0
		//               : _processFunctionService.GetTotalDocumentUnread(function, User.GetUserId(), parameters.Params);
		//}

		//public JsonResult GetDocumentTree()
		//{
		//    return Json(_processFunctionService.GetDocumentTree(), JsonRequestBehavior.AllowGet);
		//}

		//public JsonResult SyncDocumentTree(DateTime lastUpdate)
		//{
		//    return Json(_processFunctionService.SyncDocumentTree(lastUpdate), JsonRequestBehavior.AllowGet);
		//}

		///// <summary>
		///// Trả về danh sách document theo kho.
		///// </summary>
		///// <param name="id">Id của kho</param>
		///// <returns></returns>
		//public JsonResult GetDocumentStore(int id)
		//{
		//    return Json(_processFunctionService.GetDocumentStore(id), JsonRequestBehavior.AllowGet);
		//}

		//public JsonResult SyncDocumentStore(int id, DateTime lastUpdate)
		//{
		//    return Json(_processFunctionService.SyncDocumentStore(id, lastUpdate), JsonRequestBehavior.AllowGet);
		//}

		//public JsonResult GetFunctionGroups()
		//{
		//    return Json(_processFunctionGroupService.Gets().Select(g => new
		//    {
		//        functionGroupId = g.ProcessFunctionGroupId,
		//        clientExpression = g.ClientExpression
		//    }), JsonRequestBehavior.AllowGet);
		//}

		#endregion
	}
}