define(["treeBase","contextMenuView"],function(n){"use strict";function e(n){var r={style:{zIndex:9999},position:{of:"event"}},i;n.model.get("isStorePrivateRoot")||n.model.get("isStoreShareRoot")?r.data=[{text:egov.resources.treeStore.contextmenu.createStore,icon:"add.png",iconClass:"icon-add-to-list",callback:function(){t(n,!0)}}]:(i=n.model.get("status")==0?!0:!1,r.data=n.model.get("isPrivate")==!1?[{text:egov.resources.treeStore.contextmenu.addStorePrivateAttachment,icon:"add.png",iconClass:"icon-add-to-list",callback:function(){u(n.model.get("storePrivateId"))}},{text:"Thông tin hồ sơ",icon:"edit.png",iconClass:"icon-picasa",callback:function(){t(n,!1)}}]:[{text:egov.resources.treeStore.contextmenu.createStore,icon:"add.png",iconClass:"icon-add-to-list",callback:function(){t(n,!0)}},{text:egov.resources.treeStore.contextmenu.addStorePrivateAttachment,icon:"add.png",iconClass:"icon-add-to-list",callback:function(){u(n.model.get("storePrivateId"))}},{text:i?egov.resources.treeStore.contextmenu.closeStore:egov.resources.treeStore.contextmenu.openStore,icon:i?"left_close.png":"right_open.png",iconClass:i?"icon-lock":"icon-lock-open",callback:function(){var t=i?egov.resources.treeStore.contextmenu.messageCloseStore:egov.resources.treeStore.contextmenu.messageOpenStore;egov.message.show(t,null,egov.message.messageButtons.YesNo,function(){s(n,n.model.get("storePrivateId"),i)},null,{width:"400px"})}},{text:egov.resources.treeStore.contextmenu.updateStore,icon:"edit.png",iconClass:"icon-picasa",callback:function(){t(n,!1)}},{name:"---"},{text:egov.resources.treeStore.contextmenu.deleteStore,icon:"cancel.png",iconClass:"icon-trash",callback:function(){egov.message.show(egov.resources.treeStore.message.confirm.deleteStore,null,egov.message.messageButtons.YesNo,function(){h(n,n.model.get("storePrivateId"))},null,{width:"400px"})}}]);n.$("a:first").contextmenu(r)}function t(n,t){var i,r={width:490,height:365,title:t?egov.resources.treeStore.title.createStore:egov.resources.treeStore.title.detailSotore,buttons:[{text:t?egov.resources.common.addButton:egov.resources.common.updateButton,className:"btn-primary"+(n.model.get("isPrivate")==!1?" hidden":""),click:function(){var r=i.serialize().toJSON();r!==null&&(egov.pubsub.publish(egov.events.status.processing,egov.resources.common.processing),o(n,i,t,r))}},{text:egov.resources.common.cancelButton,className:"btn-close",click:function(){i.$el.dialog("hide")}}],draggable:!0,keyboard:!0};require(["newStorePrivateView"],function(u){var f=t?new egov.models.StorePrivateModel:n.model;t&&(f.set("parentId",n.model.get("storePrivateId")),f.set("userIdJoined",[]));t||f.get("isPrivate")!=!1||f.get("userIdJoined").unshift(f.get("userCreatedId"));i=new u({model:f,isCreate:t});egov.pubsub.publish(egov.events.status.destroy);i.$el.dialog(r);i.setFocus()})}function o(n,t,i,r){var u=i?"createStorePrivate":"updateStorePrivate";egov.request[u]({data:r,success:function(u){if(u)if(u.error)egov.pubsub.publish(egov.events.status.error,u.message);else if(u.validateMessage)t.$name.addClass("input-validation-error").focus().siblings("span").show(),egov.pubsub.publish(egov.events.status.error,u.validateMessage);else{if(t.$el.dialog("hide"),i){var e=u.data,f=!0;_.each(e,function(t){var i=new egov.models.StorePrivateModel(t);n.add(i,f);n.$children.addClass("in");f=!1})}else n.model.set("name",r.storePrivateName),n.model.set("userIdJoined",r.userIdJoined),n.model.set("descStorePrivate",r.descStorePrivate),n.model.set("isStoreShared",r.userIdJoined.length>0||r.descStorePrivate.length>0);egov.pubsub.publish(egov.events.status.success,i?"Tạo mới thành công!":"Cập nhật thành công!")}},error:function(){var n=i?egov.resources.treeStore.message.error.createStore:egov.resources.treeStore.message.error.updateStore;egov.pubsub.publish(egov.events.status.error,n)}})}function r(n){for(var i,t=n.length-1;t>=0;t--)i=_.find(n,function(i){return i.id==n[t].parentId}),i?(i.children||(i.children=[]),i.children.unshift(n[t]),i.state="closed"):(n[t].root=!0,n[t].state="");return n=_.filter(n,function(n){return n.root})}function u(n){require(["addStoreAttachment"],function(t){var i=new t({id:n}),r={title:egov.resources.treeStore.title.addStorePrivateAttachment,width:425,height:205,draggable:!0,keyboard:!0,buttons:[{text:egov.resources.common.addButton,className:"btn-primary",click:function(){$("#attachmentName").val()!==""&&$("#uploadStorePrivateAttachment").click()}},{text:egov.resources.common.cancelButton,click:function(){i.$el.dialog("destroy")}}]};i.$el.dialog(r);i.setFocus()})}function s(n,t,i){var r=i?"closeStorePrivate":"openStorePrivate";egov.request[r]({data:{id:t},success:function(t){t&&(t.error?egov.pubsub.publish(egov.events.status.error,t.message):(i?(n.$el.find("a:first").removeClass("active").addClass("disable"),n.model.set("status",1)):(n.$el.find("a:first").removeClass("disable").addClass("active"),n.model.set("status",0)),egov.pubsub.publish(egov.events.status.success,i?egov.resources.treeStore.message.success.closeStore:egov.resources.treeStore.message.success.openStore)))},error:function(){egov.pubsub.publish(egov.events.status.error,i?egov.resources.treeStore.message.error.closeStore:egov.resources.treeStore.message.error.openStore)}})}function h(n,t){egov.request.deleteStorePrivate({data:{id:t},success:function(t){t&&(t.error?egov.pubsub.publish(egov.events.status.error,t.message):(egov.pubsub.publish(egov.events.status.success,egov.resources.treeStore.message.success.deleteStore),n.remove()))},error:function(){egov.pubsub.publish(egov.events.status.error,egov.resources.treeStore.message.error.deleteStore)}})}var i=egov.resources.document,f=Backbone.View.extend({el:"#menu-document",initialize:function(n){this.callback=n.callback;this.parent=n.eGovTree;this.isLoadedStoreTree=!1;this.selected=null;this.render()},render:function(){var n=this;return n.isDialogShowing=!1,egov.dataManager.getStorePrivate({success:function(t){t&&(n.model=t,n._storeTree("#storeList",n.callback));n.isLoadedStoreTree=!0},error:function(){egov.pubsub.publish(egov.events.status.error,egov.resources.treeStore.message.error.selectStore)}}),n.isLoadedStoreTree=!0,this},renderDialog:function(n){var t,i;$("#storeDialog").length>0&&$("#storeDialog").remove();t=this;t.selectFunction=n;t.isDialogShowing=!0;t.storeDialogElement=$("<div id='storeDialog'>").append("<ul class='nav' style='margin: 0 -15px;'><\/ul>");t.storeDialogElement.appendTo("body");t._storeTree("#storeDialog ul",function(n){t.selected=n.model.get("storePrivateId")});t.storeDialogElement.dialog({title:egov.resources.document.docStore.dialogTitle,draggable:!0,width:"400px",height:"250px",buttons:[{text:egov.resources.document.docStore.saveButton,className:"btn-primary",disableProcess:!1,click:function(){if(t.selected==null||t.selected==0){egov.pubsub.publish(egov.events.status.warning,egov.resources.document.docStore.noChooseStore);return}t.closeDialogAndRebind();egov.callback(n,t.selected)}},{text:egov.resources.document.docStore.notSaveButton,className:"btn-info",disableProcess:!1,click:function(){t.closeDialogAndRebind();egov.callback(n,null)}},{text:egov.resources.common.closeButton,className:"",disableProcess:!0,click:function(){t.storeDialogElement.dialog("destroy")}}]});i=egov.setting.userSetting.hasHideLuuSo?"checked":"";$("#storeDialog").parent().next().prepend('<div class="pull-left"><label class="checkbox document-color"><input id="hasHideSaveStore" name="checkbox[]" value="2378" type="checkbox" '+i+'><span class="document-color-1"><i class="icon-check"><\/i><\/span><\/label><span for="hasHideSaveStore">Bỏ hiển thị lưu sổ<\/span><\/div>');$("#hasHideSaveStore").change(function(){t._hasHideLuuSo($(this).is(":checked"))})},_hasHideLuuSo:function(n){egov.request.hasHideSaveStore({data:{hasHideStore:n},success:function(n){n.status&&(egov.setting.userSetting.hasHideLuuSo=n.data)},error:function(){egov.pubsub.publish("Có lỗi trong việc cấu hình lưu sổ")}})},closeDialogAndRebind:function(){this.storeDialogElement&&(this.storeDialogElement.dialog("destroy"),this.render())},_storeTree:function(t,i){var u=this;$(t).empty();var f=r(u.model.storePrivate),o=r(u.model.storeShare),s=[{id:"StorePrivateRoot",name:egov.resources.treeStore.nameStorePrivateRoot,isStorePrivateRoot:!0,state:"in",children:f,isStoreShared:!1,status:0},{id:"StoreShareRoot",name:egov.resources.treeStore.nameStoreShareRoot,isStoreShareRoot:!0,state:"in",children:o,isStoreShared:!0,status:0}],h=new egov.models.StorePrivateList(s);u.storeTree=new n({el:t,model:h,isDocumentTree:!1,isStoreTree:!0,isDroppable:!0,open:function(){},select:function(n){egov.callback(i,n)},dblclick:function(n){u.selected=n.model.get("storePrivateId");typeof u.selectFunction=="function"&&(u.closeDialogAndRebind(),egov.callback(u.selectFunction,u.selected))},contextmenu:function(n){e(n)},droppable:function(n){var t=n.attr("id"),i=egov.draggingDocumentCopyId;u._addDocumentToStore(t,i)}})},_addDocumentToStore:function(n,t){var r=this;n&&n!=0&&t&&egov.request.SaveDocumentToStorePrivate({data:{storePrivateId:n,documentCopyId:t},success:function(){egov.pubsub.publish(egov.events.status.success,i.docStore.success)},error:function(){egov.pubsub.publish(egov.events.status.error,i.docStore.error)}})}});return Array.prototype.remove=function(n){var t=this.indexOf(n);return t!=-1?this.splice(t,1):!1},f});