(function(n,t,i,r,u){"use strict";function s(t,i){n.post("/Home/RemoveNotify",{docCopyId:t},function(){typeof i=="function"&&i()})}if(typeof n===undefined)throw"Chưa có thư viện jquery.";if(typeof t===undefined)throw"Chưa có thư viện underscore.";if(typeof i===undefined)throw"Chưa có thư viện backbone.";if(typeof r===undefined)throw"Chưa có thư viện desktop notify.";if(typeof u===undefined)throw"Chưa có thư viện helper.";var f={eGov:0,bmail:1,chat:2,calendar:3,eTask:4},e=i.Model.extend({defaults:{title:"",content:"",date:"",avatar:"",userName:"",fullName:"",type:0,docCopyId:0,mailId:0,folderId:0,chatterJid:"",messageId:""}}),h=i.Collection.extend({model:e}),o=i.View.extend({events:{"click .ripple-ef":"_setNumberViewEmpty","click .notify-command .notify-openAll":"openAll","click .notify-command .notify-closeAll":"closeAll"},hasAlertNotify:!1,initialize:function(n){if(this.el=n.el,this.type=n.type||f.eGov,this.callback=n.callback,this.model=new h,this.model.length<=0){this.$(".notify-empty, .notify-command").remove();var t='<li class="notify-empty"><b>'+this._getMessageNotifyEmpty()+"<b><\/li>";this.$(".notification").empty().append(t)}return this._eventProps(),typeof this.callback=="function"&&this.callback(),this},_eventProps:function(){var n=this;this.model.on("add",function(t){var r=new c({model:t,parent:n}),i;n.$(".notify-empty, .notify-command").remove();n.$(".notification").prepend(r.$el);navigator.isMobile||(i='<div class="notify-command"><a href="#" class="notify-openAll"><b>'+egov.resources.notify.openall+'<\/b><\/a><a href="#" class="notify-closeAll"><b>'+egov.resources.notify.closeall+"<\/b><\/a><\/div>",n.$(".dropdown-menu").prepend(i));n._showNumberNotify();n.hasAlertNotify&&n.alertNotify(t)});this.model.on("remove",function(t){if(n.model.length<=0){n.$(".notify-empty, .notify-command").remove();var i='<li class="notify-empty"><b>'+n._getMessageNotifyEmpty()+"<\/b><\/li>";n.$(".notification").empty().append(i)}t.view.remove();n._showNumberNotify()})},_showNumberNotify:function(){if(this.model&&this.model.length>0){var n=this.model.select(function(n){return n.get("hasInBell")}).length;n>0?this.$(".notify-count").text(n>99?"99+":n).addClass("notify-count-avaiable").attr("data-count",n):this.$(".notify-count").text("").attr("data-count",0)}else this.$(".notify-count").text("").attr("data-count",0)},_setNumberViewEmpty:function(){this.model&&this.model.length>0&&this._showNumberNotify()},addToModel:function(n){n&&this.model.add(n)},checkExist:function(n){if(!n)throw egov.resources.notify.valuemodelnotnull;n instanceof e||(n=new e(n));var i=this._getPropKey(),t;return(this.model&&this.model.length>0&&(t=this.model.select(function(t){return t.get(i)==n.get(i)})),!t||t.length===0)?!1:!0},removeModel:function(n){n&&this.model.remove(n)},removeModelById:function(n,t){if(this.model&&!(this.model.length<=0)){var r=this._getPropKey(),i=this.model.select(function(t){return t.get(r)==n});i&&(this.removeModel(i),t&&s(n))}},setViewAll:function(){this.model&&this.model.length>0&&(this.model.each(function(n){n.get("hasInBell")&&n.set("hasInBell",!1)}),this._showNumberNotify())},alertNotify:function(n){var s,t,i,e,o,h,c,l;if(n!==undefined){u.playAudio();s=this;try{if(this.type==f.eGov?(t=n.get("docCopyId"),i=n.get("fullName")+" - "+n.get("userName"),e=n.get("content"),o=n.get("avatar"),h="openDocumentAlertInNotifyeGovDesktop",c=JSON.stringify({id:t})):this.type==f.bmail?(t=n.get("mailId"),i=n.get("userName"),e=n.get("content"),o=n.get("avatar"),h="openMailAlertInNotifyeGovDesktop",c=JSON.stringify({id:t})):this.type==f.chat&&(t=n.get("chatterJid"),i=n.get("userName"),e=n.get("content"),o=n.get("avatar"),h="openChatAlertInNotifyeGovDesktop",c=JSON.stringify({id:t})),window.Notification&&window.external&&typeof window.external.createNotification=="function"){if(this.type==f.bmail)return;l=[{title:i,body:e,icon:o,onclick:h,onclick_praram:c}];window.external.createNotification(JSON.stringify(l))}else r.hasNotify()&&(r.requestPermission(),this.arrAlertNotify||(this.arrAlertNotify={}),this.type==f.chat?(this.arrAlertNotify.egovchat_cuongnt&&(this.arrAlertNotify.egovchat_cuongnt.close(),delete this.arrAlertNotify.egovchat_cuongnt),this.arrAlertNotify.egovchat_cuongnt=r.createNotification({title:i,body:e,icon:o,click:function(){s.arrAlertNotify.egovchat_cuongnt.close();s.openNotifyById(t)}})):this.arrAlertNotify[t]=r.createNotification({title:i,body:e,icon:o,click:function(){s.openNotifyById(t)}}))}catch(a){console.log(a.message)}}},rebindAlertNotify:function(){window.Notification&&window.external&&typeof window.external.createNotification=="function"||this.model&&this.model.length>0&&this.alertNotify(this.model.at(0))},openNotifyById:function(n){var u,t,r,f,i;if(this.model&&this.model.length>0&&(u=this._getPropKey(),t=this.model.select(function(t){return t.get(u)==n}),t&&t.length>0))for(r=0;r<t.length;r++)f=t[r],i=f.get(u),f.view.open(),this.arrAlertNotify&&i&&this.arrAlertNotify[i]&&(this.arrAlertNotify[i].close(),delete this.arrAlertNotify[i])},openAlertInNotifyeGovDesktop:function(n){var t=JSON.parse(n);this.openNotifyById(t.id)},setAlert:function(n){this.hasAlertNotify=n},_getPropKey:function(){var n=null;switch(this.type){case f.eGov:n="docCopyId";break;case f.bmail:n="mailId";break;case f.chat:n="chatterJid"}return n},_getMessageNotifyEmpty:function(){var n=null;switch(this.type){case f.eGov:n=egov.resources.notify.nodocumentnotify;break;case f.bmail:n=egov.resources.notify.nomailnotify;break;case f.chat:n=egov.resources.notify.nochatnotify}return n},_getStringOpenAll:function(){var n=null;switch(this.type){case f.eGov:n=egov.resources.openAllDocument;break;case f.bmail:n=egov.resources.openAllMail;break;case f.chat:n=egov.resources.openAllChat}return n},openAll:function(){!this.model||this.model.length<=0||(this.model.at(0).view.open(this.model.length===1),this.openAll())},closeAll:function(){!this.model||this.model.length<=0||(this.model.at(0).view.remove(!0),this.closeAll())}}),c=i.View.extend({tagName:"li",events:{"click .open-notify":"open","click .close-notify":"close"},initialize:function(n){return this.parent=n.parent,this.render(),this.model.view=this,this},render:function(){this.$el.html(this._parseHtml(this.model))},open:function(){window.focus();var n=this.model.get("type");this.remove();switch(n){case f.eGov:s(this.model.get("docCopyId"));this._openDocument(!0);break;case f.bmail:this._openMail();break;case f.calendar:break;case f.chat:this._openChat();break;case f.eTask:break;default:console.log("Notification type not exist!.")}},close:function(n){u.destroyEvent(n);this.remove(!0);u.destroyEvent(n)},_parseHtml:function(t){return t?(t instanceof e&&(t=t.toJSON()),t.defaultAvatar="'../../AvatarProfile/noavatar.jpg'",n.tmpl(l,t)):null},_openDocument:function(t){var i=this,f="documents",r=this.model.get("docCopyId");(t==null||t===undefined)&&(t=!0);u.displayApp(f,function(){var o,e,s;try{o=u.getContentWindow(f);e=o.egov;navigator.isMobile?(e.views&&e.views.home&&e.views.home.tab&&e.views.home.tab.removeDocument(),e.require(["tabView"],function(n){var t=new n({model:{id:r,name:i.model.get("title"),title:i.model.get("title"),href:"tabDocument_"+r}})})):e.views.home.tab.openDocument(r,i.model.get("title"),t)}catch(h){s={DocumentCopyId:r,title:i.model.get("title")};n.cookie("documentNotify",JSON.stringify(s),{expires:1,domain:window.document.domain,path:"/",secure:!0})}})},_openMail:function(){var n=this;u.displayApp("bmail",function(){var t=u.getContentWindow("bmail");t.readNewMail(n.model.get("mailId"),n.model.get("folderId"))})},_openChat:function(){var n=this;u.displayApp("chat",function(){var t=u.getContentWindow("chat");t.btalk.APPVIEW.notificationClick({chatterJid:n.model.get("chatterJid")})})},_removeView:function(){this.$el.remove();this.parent.model.remove(this.model)},_closeAlertNotify:function(){if(this.parent&&this.parent.arrAlertNotify){var n=this.parent,t=n._getPropKey();n.arrAlertNotify[this.model.get(t)]&&(n.arrAlertNotify[this.model.get(t)].close(),delete n.arrAlertNotify[this.model.get(t)])}},remove:function(n){this._removeView();this._closeAlertNotify();n&&this.model.get("type")==f.eGov&&s(this.model.get("docCopyId"))}});var l='<a href="#" class="open-notify" title="${content}">    <div class="col-xs-2 col-md-2 col-sm-3">         <img class="img-circle" src="${avatar}" onerror="this.src=${defaultAvatar}">    <\/div>    <div class="col-xs-14 col-md-14 col-sm-13 textalert">         <div class="col-xs-15 col-md-15 col-sm-15" style="padding:0px">            <div class="notify-usersend wraptext">{{if fullName != null}} ${fullName}-{{/if}} ${userName}<\/div>            <div class="notify-content wraptext"> ${content}<\/div>            <div class="notify-date">${date}<\/div>         <\/div>       <div class="close-notify col-xs-1 col-md-1 col-sm-1">X<\/div>    <\/div><\/a>';window.eGovNotify=new o({el:".div-eGov-notify",type:f.eGov});window.bmailNotify=new o({el:".div-bmail-notify",type:f.bmail});window.chatNotify=new o({el:".div-chat-notify",type:f.chat})})(window.jQuery,window._,window.Backbone,window.notify,window.helper);