define(function(){"use strict";function n(n,t,i){var r=egov.template.tree;return egov.isMobile?n||t?r.mobile:i?r.questionMobile:r.storeTreeMobile:n||t?r.documentTree:i?r.question:r.storeTree}return egov.views.base.Tree=Backbone.View.extend({className:"tree-view-el",initialize:function(n){return this.el=n.el,this.$el.addClass("tree-view-el"),this.isDocumentTree=n.isDocumentTree,this.isOnlineRegistration=n.isOnlineRegistration,this.isStoreTree=n.isStoreTree,this.isFAQ=n.isFAQ,this.hasDroppable=n.isDroppable,this.callback={select:n.select,open:n.open,reload:n.reload,contextmenu:n.contextmenu,close:n.close,droppable:n.droppable,dblclick:n.dblclick},this.render(),this},render:function(){var n=this;n.hasChange=!1;n.isDocumentTree?n.selectedNode=null:n.isOnlineRegistration?(n.onlineRegistrationModel=[],n.onlineRegistrationModelSelected=null):(n.storesModel=[],n.storeModelSelected=null);n._setDefaultNode();n.model.each(function(t){var i=new egov.views.base.TreeItem({model:t,parent:n,callback:n.callback,isDocumentTree:n.isDocumentTree,isOnlineRegistration:n.isOnlineRegistration,isFAQ:n.isFAQ,isStoreTree:n.isStoreTree,hasDroppbale:n.hasDroppable});t.view=i;n.isDocumentTree?n.$el.find("#child"+t.get("treeGroupId")).append(i.$el):(n.isOnlineRegistration?n.onlineRegistrationModel.push(i):n.storesModel.push(i),n.$el.append(i.$el))});n.model.on("change",function(){n.hasChange=!0},n)},unCurrentSelectedNode:function(){var n=this.selectedNode;n&&n.set("isSelected",!1)},_setDefaultNode:function(){if(this.isDocumentTree&&!this.isOnlineRegistration){var n=this.model.findWhere({isSelected:!0});n||(n=this.model.at(0),n.set("isSelected",!0))}},selectCurrentNode:function(){this.selectedNode||(this.selectedNode=this.model.at(0));this.selectedNode.view.select()},updateToCache:function(){if(this.isDocumentTree&&this.hasChange&&!this.isOnlineRegistration){var n=this.model.toJSON();egov.dataManager.updateTree(n);this.hasChange=!1}}}),egov.views.base.TreeItem=Backbone.View.extend({openClass:"in",selectClass:"active",displayClass:"display",tagName:"li",className:"mdl-list__item",events:{"click .closed":"open","click .open":"close","tap .closed":"open","tap .open":"close","contextmenu a":"contextMenu"},initialize:function(n){var t=this,i;return this.parent=n.parent,this.parentNode=n.parentNode,this.callback=n.callback,this.isDocumentTree=n.isDocumentTree,this.isOnlineRegistration=n.isOnlineRegistration,this.isSlected=n.isSlected||!1,this.hasDroppbale=n.hasDroppbale,this.nodeChildren={},n.isDocumentTree?this.model.set("isDocumentTree",!0):n.isOnlineRegistration?this.model.set("isOnlineRegistration",!0):n.isStoreTree?this.model.set("isStoreTree",!0):n.isFAQ&&(this.isFAQ=!0,this.model.set("isFAQ",!0)),this.isDocumentTree||this.isOnlineRegistration?this.$el.attr("id",this.model.get("functionId")):(i=this.model.get("storePrivateId"),this.$el.attr("id",i).attr("data-storeprivateid",i)),this.$el.attr("data-parentid",this.model.get("parentId")),this.render(function(){t.$("a").dbclick(function(n){t.select(n)},function(n){if(typeof t.callback.dblclick=="function"){t.callback.dblclick(t,event);return}var i=$(n.target),r=i.parent("a.list-group-item").find(".closed , .open");r.click()})}),t._eventOfProps(),this},render:function(t){var i,u,r;i=this;u=n(i.isDocumentTree,i.isOnlineRegistration,i.isFAQ);i.$children=i.$("ul.collapse:first");require([u],function(n){if(i.$el.html($.tmpl(n,i.model.toJSON())),i.isDocumentTree||(r=i.model.get("children"),r&&r.length>0&&(r.each(function(n){i.add(n)}),i.$children.removeClass("in")),i.isOnlineRegistration&&i._showTotalInTreeType()),i.model.get("isSelected")){var u=egov.isMobile?i.$el:i.$el.find("a:first");u.toggleClass(i.selectClass);i.parent.selectedNode=i.model}i.isDocumentTree&&(i.$el.children().attr("data-params",i.model.get("params")),i._showTotalInTreeType(),i.model.get("isOpen")&&i.$(".closed").click());egov.isMobile;i.hasDroppbale&&i.setDroppable();i.$el.bindResources();t()})},_eventOfProps:function(){var n=this;this.on("open",function(){egov.helper.hideAllContext();egov.callback(n.callback.open,n);n.hasDroppbale&&n.setDroppable()},this);this.on("close",function(){egov.helper.hideAllContext();egov.callback(n.callback.close,n)},this);this.on("select",function(){egov.helper.hideAllContext();egov.mobile&&egov.mobile.autoHideMainMemu();egov.callback(n.callback.select,n)},this);this.on("reload",function(){egov.callback(n.callback.reload,n)},this);this.on("contextmenu",function(t){egov.helper.hideAllContext();typeof n.callback.contextmenu=="function"&&n.callback.contextmenu(n,t)},this);this.model.on("change:name",function(){n.render()},this);this.model.on("change:totalDocumentUnread",function(t){if(n._showTotalInTreeType(),n.parentNode&&n.parentNode.model){var r=n.parentNode.model.get("children"),i=_.find(r,function(n){return n&&n.params==t.get("params")&&n.functionId==t.get("functionId")});i&&(i.totalDocumentUnread=t.get("totalDocumentUnread"),n.parent.hasChange=!0)}},this);this.model.on("change:totalDocument",function(t){if(n._showTotalInTreeType(),n.parentNode&&n.parentNode.model){var r=n.parentNode.model.get("children"),i=_.find(r,function(n){return n&&n.params==t.get("params")&&n.functionId==t.get("functionId")});i&&(i.totalDocument=t.get("totalDocument"),n.parent.hasChange=!0)}},this);this.model.on("change:isSelected",function(n,t){var i=egov.isMobile?this.$el:this.$el.find("a:first");t?i.addClass(this.selectClass):i.removeClass(this.selectClass)},this)},add:function(n,t){var i,u,r,f;return t=t||!1,i=this,u=this.isDocumentTree||this.isOnlineRegistration?"functionId":"storePrivateId",this.$("ul.collapse:first").length===0?(this.$children=$('<ul class="nav panel-collapse collapse">'),this.$el.append(this.$children)):this.$children=this.$("ul.collapse:first"),n.set("parentId",this.model.get(u)),r=new egov.views.base.TreeItem({model:n,isDocumentTree:i.isDocumentTree,isOnlineRegistration:i.isOnlineRegistration,callback:i.callback,parent:i.parent,parentNode:i}),(this.isDocumentTree||this.isOnlineRegistration)&&(f=this.isOnlineRegistration?n.get("functionId"):n.get("params")+"_"+n.get("functionId"),this.nodeChildren[f]=r),n.view=r,this.$children.append(r.$el),t&&this.$children.parent("li").find("a:first .pull-left").removeClass("open closed").addClass("open"),r},remove:function(){this.$el.remove()},select:function(n){egov.helper.hideAllContext();egov.helper.destroyClickEvent(n);this._removeOtherSelected();egov.isMobile&&(n&&n.originalEvent&&this.selectMobile(),egov.commonFn.event.changeTitleForMobile("documents",this.model.get("name")),egov.mobile.hidePanel());this.isDocumentTree||(this.parent.storeModelSelected=this);this.parent.unCurrentSelectedNode();this.model.set("isSelected",!0);this.parent.selectedNode=this.model;this.triggerSelectNode()},setDroppable:function(){var n=this;n.$("a").droppable({drop:function(t){var i=$(t.target).closest("li");n.callback.droppable(i);$(i).css("border","none")},over:function(n){var t=$(n.target).closest("li"),i=t.attr("id");i&&i!=0&&$(t).css("border","solid 1px #2b2f31")},out:function(n){var t=$(n.target).closest("li");$(t).css("border","none")}})},selectMobile:function(){this._removeOtherSelectedMobbile();this.$el.parent().removeClass(this.displayClass);$(egov.views.home.tree.documentList).addClass(this.displayClass)},triggerSelectNode:function(){this.trigger("select")},open:function(n){if(egov.helper.hideAllContext(),egov.helper.destroyClickEvent(n),n){var t=$(n.target);t.removeClass("open closed").addClass("open").closest("a").attr("data-open","true");egov.isMobile&&t.html("expand_more")}this.$(".panel-collapse:first").addClass("in");this.isDocumentTree&&this.parent&&(this.model.get("isOpen")||this.model.set("isOpen",!0));this.triggerOpenNode()},triggerOpenNode:function(){this.trigger("open")},close:function(n){egov.helper.hideAllContext();var t=$(n.target);this.isDocumentTree&&this.parent&&this.model.get("isOpen")&&this.model.set("isOpen",!1);this.$(".panel-collapse.in:first").removeClass("in");t.removeClass("open closed").addClass("closed").closest("a").attr("data-open","false");egov.isMobile&&t.html("chevron_right");this.triggerCloseNode();egov.helper.destroyClickEvent(n)},triggerCloseNode:function(){this.trigger("close")},contextMenu:function(n){egov.helper.destroyClickEvent(n);this._removeOtherSelected();this.$("a:first").addClass(this.selectClass);this.isDocumentTree||(this.parent.storeModelSelected=this);this.trigger("contextmenu")},_removeOtherSelected:function(){egov.views&&egov.views.home&&egov.views.home.tree&&egov.views.home.tree.$el?egov.views.home.tree.$el.find("."+this.selectClass).removeClass(this.selectClass):$("."+this.selectClass).removeClass(this.selectClass)},_removeOtherSelectedMobbile:function(){this.$el.parent().find("."+this.selectClass).removeClass(this.selectClass)},_showTotalInTreeType:function(){var f=this.model.get("showTotalInTreeType"),n=this.model.get("totalDocumentUnread"),t=this.model.get("totalDocument"),i="",r="",u={none:0,unread:1,unreadOnAll:2,all:3};switch(f){case u.none:break;case u.unreadOnAll:i=(n>=100?"99+":n)+"/"+t;r=String.format(egov.resources.tree.displayUnReadOnAll,n,t);break;case u.all:i=t<=0?"":t;r=String.format(egov.resources.tree.displayAll,t);break;default:i=n<=0?"":n>=100?"99+":n;r=String.format(egov.resources.tree.displayUnRead,n)}egov.isMobile?this.$el.find(".totalUnread:first").attr("data-badge",n>=100?"99+":n):(this.$el.find(".totalUnread:first").text(i).attr("data-totalunread",this.model.get("totalDocumentUnread")).attr("data-total",this.model.get("totalDocument")).attr("title",r),this.$el.find(".qtooltip").etip())},rebindTotal:function(n){this.model.set("totalDocument",n);this._showTotalInTreeType()}}),egov.views.base.Tree});