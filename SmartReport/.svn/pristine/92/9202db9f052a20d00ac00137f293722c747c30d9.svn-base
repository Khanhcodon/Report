function TreeController(n,t){this._model=n||null;this._view=t||null;this.tmpHiddenNode=[]}function TreeDragDrop(){}function DDList(n,t,i){DDList.superclass.constructor.call(this,n,t,i);n=this.getDragEl();YAHOO.util.Dom.setStyle(n,"opacity",.67);this.goingUp=!1;this.lastY=0}function TreeModel(n,t,i){this.bmailFolderStructure=n||[];this.bmailFolderStructureChanged=i||"FALSE";this.accountArray=[];this.inboxAccount=[];this.linkExpires=[];this.linkShare=[];this.folderInfo=[];this.folderIndex=[];this.oTextNodeMap={};this.initObServerEvent();this.sync=!1;this.versionStructure=t||0;this.fistVersionStructure=t||0;this.structureString=this.eOVersion="";this.needSyncFolder=!1;this.getVersionTreeStructure();this.changeFolderStructureXhr=null}function TreeView(n){this._model=n;this.selectedNode=this.serviceNode=this.contactNode=this.calendarNode=this.hiddenServiceNode=null;this.displayHiddenFolder=this.haveRootNode=this.isSubTree=!1;this.expandClick=!0;this.arrInspectNode=[];this.initObserverEvent();this.existNode=[]}TreeController.subTreeId="treeDiv12";TreeController.prototype.setModel=function(n){this._model=n};TreeController.prototype.setView=function(n){this._view=n};TreeController.prototype.init=function(){this.initObserverEvent();this._view.createTree({});mailbox.getInstance().loadFromBpr||(this.createDragDrop(),this._view.createContextMenu())};TreeController.prototype.initObserverEvent=function(){var n=this;this._view.selectFolderEvent.attach(function(t,i){n.handleSelectFolder(i)});this._view.postToThisFolderEvent.attach(function(){n.postToThisFolder()});this._view.createNewFolderEvent.attach(function(t,i){n.createNewFolder(i)});this._model.initCalendarEvent.attach(function(){n._view.initCalendar()});this._model.initContactEvent.attach(function(){n._view.initContact()});this._model.initFacebookEvent.attach(function(){n._view.initFacebook()});this._view.emptyFolderEvent.attach(function(t,i){n.emptyFolder(i)});this._view.deleteFolderEvent.attach(function(t,i){n.deleteFolder(i)});this._view.markAllReadFolderEvent.attach(function(t,i){n.markAllReadFolder(i)});this._view.renameFolderEvent.attach(function(t,i){n.renameFolder(i)});this._view.syncFolderEvent.attach(function(t,i){n.syncFolder(i)});this._view.manageFoldersEvent.attach(function(){n.manageFolders()});this._model.redrawTreeViewEvent.attach(function(){n._view.redrawTreeView()});this._view.createShareFolderEvent.attach(function(t,i){n.createShareFolder(i)});this._view.createPublicFolderEvent.attach(function(t,i){n.createPublicFolder(i)});this._view.editFolderEvent.attach(function(t,i){n.editFolder(i)});this._view.moveFolderEvent.attach(function(t,i){n.moveFolder(i)});this._view.folderStructureChangeEvent.attach(function(t,i){n.folderStructureChange(i)})};TreeController.getInstance=function(){return this._instance||(this._instance=new TreeController),this._instance};TreeController.prototype.handleSelectFolder=function(n){QuickSearch.getInstance().reset();abortConnect();this._model.handleSelectFolder(n)};TreeController.prototype.getRoot=function(){return this._view.getRoot()};TreeController.prototype.getBmailFolderStructure=function(){return this._model.getBmailFolderStructure()};TreeController.prototype.getHighlightedNode=function(){return this._view.selectedNode};TreeController.prototype.getNodeByProperty=function(n,t){return this._view.getNodeByProperty(n,t)};TreeController.prototype.getAccountArray=function(){return this._model.getAccountArray()};TreeController.prototype.isMainFolder=function(n){return"10"!=n&&"2"!=n&&"3"!=n&&"4"!=n&&"5"!=n&&"6"!=n?!1:!0};TreeController.prototype.createDragDrop=function(){(new TreeDragDrop).init()};TreeController.prototype.createShareFolder=function(n){YAHOO.util.Get.script(["js/shareFolder.js"],{onFailure:function(){},onSuccess:function(){var t=n.node,i=Session.getInstance().getUser(),r=Session.getInstance().getAuthen(),i=getAllFolder1(i,r,t.labelElId);i.Body.GetFolderResponse.folder&&i.Body.GetFolderResponse.folder[0].acl&&i.Body.GetFolderResponse.folder[0].acl.grant?i.Body.GetFolderResponse.folder[0].acl.grant[0].publicFolder?new MessageBox(messageBoxMsg,errorNoPermissionMsg):shareFolder(t.label,t.labelElId):shareFolder(t.label,t.labelElId)}})};TreeController.prototype.createPublicFolder=function(n){YAHOO.util.Get.script(["js/shareFolder.js"],{onFailure:function(){},onSuccess:function(){var t=n.node,i=Session.getInstance().getUser(),r=Session.getInstance().getAuthen(),i=getAllFolder1(i,r,t.labelElId);i.Body.GetFolderResponse.folder&&i.Body.GetFolderResponse.folder[0].acl&&i.Body.GetFolderResponse.folder[0].acl.grant?i.Body.GetFolderResponse.folder[0].acl.grant[0].publicFolder?publicFolder(t.label,t.labelElId):new MessageBox(messageBoxMsg,errorNoPermissionMsg):publicFolder(t.label,t.labelElId)}})};TreeController.prototype.editFolder=function(n){YAHOO.util.Get.script(["js/shareFolder.js"],{onFailure:function(){},onSuccess:function(){var t=n.node;editShareFolder(t.label,t.labelElId,n.flag)}})};TreeController.prototype.folderStructureChange=function(n){n=n.rootNode||this._view.getRoot();this.sendFolderStructure(n)};TreeController.prototype.addActiveStyle=function(n){this._view.addActiveStyle(n)};TreeController.prototype.createDialogFolder=function(n){var o=n.node||null,t=n.dialogId||"moveDialog",e="",r,s,h;o&&(e=o.labelElId);var i=n.label||"",c=n.dialogHeader||"",f=document.body.appendChild(document.createElement("div"));f.setAttribute("id",t);f.appendChild(document.createElement("div")).className="hd";t=f.appendChild(document.createElement("div"));t.className="bd";r=document.createElement("div");r.setAttribute("id","divFolder");i&&(s=document.createElement("label"),s.innerHTML=i+": ",r.appendChild(s),i=document.createElement("input"),i.setAttribute("type","text"),i.setAttribute("size","30"),i.setAttribute("id","foldertoMove"),i.setAttribute("readonly","readonly"),r.appendChild(i));i=document.createElement("input");i.setAttribute("type","hidden");i.setAttribute("id","idSubFolder");r.appendChild(i);t.appendChild(r);t=t.appendChild(document.createElement("div"));t.setAttribute("id","bodyMoveDialog");t.style.overflow="auto";t.style.background="none repeat scroll 0 0 #FFFFFF";t.style.height="300px";t.style.width="438px";t.style.border="1px solid #c0c0c0";t.style.marginTop="5px";t.style.bgcolor="#fdfcfa";t=t.appendChild(document.createElement("div"));t.id=TreeController.subTreeId+share.INDEX;share.INDEX++;r=new TreeModel(this._model.bmailFolderStructure);r=new TreeView(r);i=n.argsTree;i.treeId=t.id;r.createTree(i);h=n.handleLabelClick;r.tree.subscribe("labelClick",function(n){h(n)});n.changeRoot&&this.changeExpandRootNode(r);e&&r.addActiveStyle(r.getNodeByProperty("labelElId",e));f.appendChild(document.createElement("div")).className="ft";var u=new YAHOO.widget.SimpleDialog(f,{fixedcenter:!0,modal:!0,width:"480px",constraintoviewport:!0,close:!1,visible:!1}),e=function(){console.log(n);console.log(n.handleOk);n.handleOk();u.cancel()},t=[{text:chooseButtonMsg,handler:e},{text:closeButtonMsg,handler:function(){u.cancel()}}],r=n.addButtons||[];if(0<r.length)for(i=0;i<r.length;i++)t.unshift(r[i]);u.cfg.queueProperty("buttons",t);u.setHeader("<div class = 'rhd'><\/div><div class = 'rft'><\/div>"+c);u.render(document.body);u.bringToTop();u.show();document.getElementById("foldertoMove")&&document.getElementById("foldertoMove").focus();o&&(document.getElementById("idSubFolder").value=o.labelElId);$("#divFolder").css("margin-left","3px");$(f).find("#bodyMoveDialog").css("margin-left","10px");$(f).find("span.button-group").css("padding-right","19px");u.focusEnter(e);mailbox.getInstance().disableOutline()};TreeController.prototype.moveFolder=function(n){function o(){var i=document.getElementById("idSubFolder").value,n=Session.getInstance().getUser(),r=new XMLElement("FolderActionRequest"),t=r.addElement("action");t.addAttribute("op","move");t.addAttribute("id",e);t.addAttribute("l",i);n=new Soap(n,r,"urn:zimbraMail",!0,sessionId,seqNotify);n.isNeedAbort(!1);n.sendRequestCallback(function(n,t){var r,i,o;if(n&&n.Body&&n.Body.FolderActionResponse)if(r=f.children,i=null,"1"==t)oChildNode=new YAHOO.widget.TextNode("<div class='htmlnodelabel'><a>"+getSubfolderLabel(f.label)+"<\/a><\/div>",tree.getRoot(),!1),oChildNode.labelStyle="icon-subfolder",oChildNode.labelElId=e,u._view.removeNode(f),u.draw(),u.sendFolderStructure(tree.getRoot(),1);else{if(i=u._view.getNodeByProperty("labelElId",t),i=new YAHOO.widget.TextNode("<div class='htmlnodelabel'><a>"+getSubfolderLabel(f.label)+"<\/a><\/div>",i,!1),i.labelStyle="icon-subfolder",i.labelElId=e,0<r.length)for(o=0;o<r.length;o++)r[o].appendTo(i);u._view.removeNode(f);u._view.draw();u.sendFolderStructure(tree.getRoot(),2)}else new MessageBox(errorDlgMsg,errorMoveParentFolder)},i);this.cancel()}var f=n.node,e=f.labelElId,r=document.body.appendChild(document.createElement("div")),t,i,u;r.setAttribute("id","moveDialog");r.appendChild(document.createElement("div")).className="hd";n=r.appendChild(document.createElement("div"));n.className="bd";t=document.createElement("div");i=document.createElement("label");i.innerHTML=folderMsg+": ";t.appendChild(i);i=document.createElement("input");i.setAttribute("type","text");i.setAttribute("size","30");i.setAttribute("id","foldertoMove");i.setAttribute("readonly","readonly");t.appendChild(i);i=document.createElement("input");i.setAttribute("type","hidden");i.setAttribute("id","idSubFolder");t.appendChild(i);n.appendChild(t);n=n.appendChild(document.createElement("div"));n.style.overflow="auto";n.style.background="none repeat scroll 0 0 #FFFFFF";n.style.height="300px";n.style.width="424px";n.style.border="1px solid #c0c0c0";n.style.marginTop="5px";n.style.bgcolor="#fdfcfa";n=n.appendChild(document.createElement("div"));n.id=TreeController.subTreeId+share.INDEX;share.INDEX++;t=new TreeModel(this._model.bmailFolderStructure);t=new TreeView(t);n={treeId:n.id,isSubTree:!0,haveRootNode:!0};t.createTree(n);t.tree.subscribe("labelClick",function(n){document.getElementById("idSubFolder").value=n.labelElId;document.getElementById("foldertoMove").value=getSubfolderLabel(n.label)});this.changeExpandRootNode(t);t.addActiveStyle(t.getNodeByProperty("labelElId",e));r.appendChild(document.createElement("div")).className="ft";r=new YAHOO.widget.SimpleDialog(r,{fixedcenter:!0,modal:!0,width:"450px",constraintoviewport:!0,close:!1,visible:!1});u=this;r.cfg.queueProperty("buttons",[{text:chooseButtonMsg,handler:o},{text:closeButtonMsg,handler:function(){YAHOO.util.Dom.removeClass(f.labelElId,"folderRightClick");this.cancel()}}]);r.setHeader("<div class = 'rhd'><\/div><div class = 'rft'><\/div>"+moveFolderMsg);r.render(document.body);r.bringToTop();r.show();document.getElementById("foldertoMove").focus();document.getElementById("idSubFolder").value=tmpNode.labelElId;r.focusEnter(o);mailbox.getInstance().disableOutline()};TreeController.prototype.getFirstParent=function(n){return this._view.getFirstParent(n)};TreeController.prototype.updateFolderStructure=function(){var i=this.tmpHiddenNode.length,n;if(0<i){for(n=0;n<i;n++)for(var r=this.tmpHiddenNode[n].node.labelElId,u=this.tmpHiddenNode[n].hidden,f=this._model.bmailFolderStructure.length,t=0;t<f;t++)if(r==this._model.bmailFolderStructure[t].id){this._model.bmailFolderStructure[t].visible=u;break}this.tmpHiddenNode=[]}};TreeController.prototype.manageFolders=function(){function u(){r.updateFolderStructure();r._view.redrawTreeView(!0);window.setTimeout(function(){r.folderStructureChange({})},200);this.cancel()}var t,f,i,r,n;this.tmpHiddenNode=[];t=document.body.appendChild(document.createElement("div"));t.setAttribute("id","moveDialog");t.appendChild(document.createElement("div")).className="hd";n=t.appendChild(document.createElement("div"));n.className="bd";n=n.appendChild(document.createElement("div"));n.setAttribute("id","bodyMoveDialog");n.style.overflow="auto";n.style.background="none repeat scroll 0 0 #FFFFFF";n.style.height="300px";n.style.width="438px";n.style.border="1px solid #c0c0c0";n.style.marginTop="5px";n.style.bgcolor="#fdfcfa";n=n.appendChild(document.createElement("div"));n.id=TreeController.subTreeId+share.INDEX;share.INDEX++;t.appendChild(document.createElement("div")).className="ft";f=new TreeModel(this._model.bmailFolderStructure);i=new TreeView(f);i.createTree({treeId:n.id,isSubTree:!0,displayHiddenFolder:!0,dynamicLoad:!0});r=this;n=new YAHOO.widget.SimpleDialog(t,{fixedcenter:!0,modal:!0,constraintoviewport:!0,close:!1,width:"480px",visible:!1});n.cfg.queueProperty("buttons",[{text:visibleButtonMsg,handler:function(){var n=i.getSelectedNode();r.appearFolder(n);i.draw()}},{text:hideButtonMsg,handler:function(){var n=i.getSelectedNode();console.log(n);"2"!=n.labelElId&&r.hideFolder(n);i.draw()}},{text:chooseButtonMsg,handler:u},{text:cancelButtonMsg,handler:function(){this.cancel()}}]);n.setHeader("<div class = 'rhd'><\/div><div class = 'rft'><\/div>"+managmentFolderMsg);n.render(document.body);n.bringToTop();n.showEvent.subscribe(function(){});n.show();$(t).find("#bodyMoveDialog").css("margin-left","10px");$(t).find("span.button-group").css("padding-right","19px");n.focusEnter(u);mailbox.getInstance().disableOutline()};TreeController.prototype.updateHiddenNode=function(n,t){var u=this.tmpHiddenNode.length,r,i;if(0<u){for(r=!1,i=0;i<u;i++)if(this.tmpHiddenNode[i].node==n){r=!0;this.tmpHiddenNode[i].hidden=t;break}r||this.tmpHiddenNode.push({node:n,hidden:t})}else this.tmpHiddenNode.push({node:n,hidden:t})};TreeController.prototype.hideFolder=function(n){if("icon-hiddenfolder"!=n.labelStyle&&(n.labelStyle="icon-hiddenfolder",this.updateHiddenNode(n,"0"),n.hasChildren(!0))){n=n.children;for(var i=n.length,t=0;t<i;t++)this.hideFolder(n[t])}};TreeController.prototype.appearFolder=function(n){if("icon-hiddenfolder"==n.labelStyle&&(n.labelStyle="icon-subfolder",this.updateHiddenNode(n,"1"),n.hasChildren(!0))){n=n.children;for(var i=n.length,t=0;t<i;t++)this.appearFolder(n[t])}};TreeController.prototype.syncFolder=function(n){var t=n.node,i;if(n=t.labelStyle,"icon-gtalk"==n||"icon-yahoo"==n){for(n="",t=t.labelElId,i=0;i<inboxAccount.length;i++)if(inboxAccount[i].rootId==t){n=inboxAccount[i].imapId;break}t=new XMLElement("ImportDataRequest");t.addElement("imap").addAttribute("id",n);n=new Soap(Session.getInstance().getUser(),t,"urn:zimbraMail",!0);n.setSimple(!1);n.isNeedAbort(!1);n.sendRequestCallback(function(){})}currentUser.scrollToGetMail?synchronizeInbox(0,!0):(n=paging.getInstance().getStartIndex(),synchronizeInbox(n,!0))};TreeController.prototype.renameFolder=function(n){var t=n.node,i,r;this.isMainFolder(t.labelElId)||(n=getSubfolderLabel(t.label),i=new convertSpecialEntities,i.setInput(n),n=i.convertToHTMLEntity(),r=this,new ConfirmBox(renameFolderMsg,'<div style="margin-left: 10px;float:left;font-size:12px">'+inputFolderNameMsg+': <\/div> <div style="margin-top: 25px"><input type="text" style="font-family: Tahoma;font-size: 12px;width: 200px;" name="txtFolder" id="txtFolder" value ="'+n+'"/>',function(){var i=$("#txtFolder").val();if(""==i)new MessageBox(errorDlgMsg,errorDlgMsg);else if(i&&0<i.length){var n=Session.getInstance().getUser(),f=Session.getInstance().getAuthen(),u=new convertSpecialEntities;u.setInput(i);i=u.convertToHTMLCode();n=folderAction(n,f,"rename",t.labelElId,i);n.Body.FolderActionResponse?(t.label="<div class='htmlnodelabel'><a>"+i+"<\/a><\/div>",t.refresh()):n.Body.Fault&&n.Body.Fault.Detail&&n.Body.Fault.Detail.Error&&"mail.ALREADY_EXISTS"==n.Body.Fault.Detail.Error.Code?new MessageBox(errorDlgMsg,errorFolderExistMsg):n.Body.Fault&&n.Body.Fault.Detail&&n.Body.Fault.Detail.Error&&"mail.INVALID_NAME"==n.Body.Fault.Detail.Error.Code?new MessageBox(errorDlgMsg,errorInvalidNameMsg):new MessageBox(errorDlgMsg,errorRenameFolderMsg);r.sendFolderStructure(r._view.getRoot(),2)}}),$("#txtFolder").focus())};TreeController.prototype.markAllReadFolder=function(n){var t=n.node,r=this,i;n=YAHOO.util.Dom.getX(t.getElId());i=YAHOO.util.Dom.getY(t.getElId());new ConfirmBox(markAllReadMsg,cfmMarkAllReadMsg,function(){var u=t.labelElId,n=r._view.getFirstParent(t),i=t.labelStyle;if(!n&&("icon-gtalk"==i||"icon-yahoo"==i)&&0<inboxAccount.length){for(n=-1,i=0;i<inboxAccount.length;i++)if(inboxAccount[i].rootId==u){n=i;break}u=inboxAccount[n].folderId}n=new XMLElement("FolderActionRequest");i=n.addElement("action");i.addAttribute("op","read");i.addAttribute("id",u);n=new Soap(Session.getInstance().getUser(),n,"urn:zimbraMail",!0);n.isNeedAbort(!1);n.sendRequestCallback(function(n){var r,i,t;if(n.Body&&n.Body.FolderActionResponse&&n.Body.FolderActionResponse.action&&n.Body.FolderActionResponse.action.id==u){if(n=dataTable.getRecordSet(),r=n.getLength(),0<r)for(i=0;i<r;i++)if(t=n.getRecord(i),1==t.getData().unread){var f=t.getData().from.substring(3,t.getData().from.length-4),e=t.getData().subject.substring(3,t.getData().subject.length-4),o=t.getData().date.substring(3,t.getData().date.length-4);dataTable.updateCell(t,"mail",'<img src="giaodien/mail.png" style="margin-top:3px">',!0);dataTable.updateCell(t,"from",f,!0);dataTable.updateCell(t,"date",o,!0);dataTable.updateCell(t,"subject",e,!0);updateFlagMailForCacheFolder(u,"unread",0,t.getData().id)}}else new MessageBox(errorDlgMsg,errorMarkAllReadMsg)})},function(){},chooseButtonMsg,cancelButtonMsg,"300px",n,i+20,!1,!1)};TreeController.prototype.deleteFolder=function(n){var i=n.node,r=i.labelElId,t=this,u;n=YAHOO.util.Dom.getX(i.getElId());u=YAHOO.util.Dom.getY(i.getElId());new ConfirmBox(deleteFolderMsg,cfmDeleteFolderMsg,function(){var n=Session.getInstance().getUser(),u=Session.getInstance().getAuthen(),f;t.isMainFolder(r)||("3"!=i.parent.labelElId?(f=i.labelStyle,"icon-gtalk"==f||"icon-yahoo"==f?(n=YAHOO.util.Dom.getX(i.getElId()),u=YAHOO.util.Dom.getY(i.getElId()),new ConfirmBox(messageBoxMsg,deleteExtFolderMsg,function(){var r="gtalk",u,n;"icon-yahoo"==f&&(r="yahoo");u=getLocation(i);delRegistration(r,u,!0);0==i.depth&&t._model.removeFolderIndex(i);t._view.removeNode(i);t._view.draw();n="";n="gtalk"==r?"gtalk-"+u:"yahoo-"+u;$(".divGroup[name='"+n+"']").find(".divGroup").remove();$(".divGroup[name='"+n+"']").children().find(".txtGroupNameLT").attr("style","background:#fff; padding-right:5px; padding-left:8px; cursor:default; ");$(".divGroup[name='"+n+"']").children().find(".txtGroupNameLT").attr("type",r);"gtalk"==r?$(".divGroup[name='"+n+"']").children().find(".txtGroupNameLT").html(googleAccountMsg):$(".divGroup[name='"+n+"']").children().find(".txtGroupNameLT").html(yahooAccountMsg);$(".divGroup[name='"+n+"']").children().find(".txtGroupNameLT").attr("class","txtGroupNameLTLogin");$(".txtGroupNameLTLogin").bind("click",function(n){showBoxLogin($(this).attr("type"),n)})},function(){},chooseButtonMsg,cancelButtonMsg,"300px",n,u+20,!1,!1)):(n=folderAction(n,u,"trash",r),n.Body.FolderActionResponse?(t._model.removeFolderIndex(i),t._view.removeNode(i),n=t._view.getNodeByProperty("labelElId","3"),u=new YAHOO.widget.TextNode(i.label,n,!1),u.labelElId=r,u.labelStyle="icon-subfolder",n.refresh(),n.expand(),t._view.draw(),t._model.folderIndex.push({path:"trash/"+i.label,index:u.index,node:u}),t.sendFolderStructure(t._view.getRoot())):n&&n.Body&&n.Body.Fault&&n.Body.Fault.Reason&&n.Body.Fault.Reason.Text?-1!=n.Body.Fault.Reason.Text.indexOf("no such folder id")&&(t._view.removeNode(i),t._view.draw(),t.sendFolderStructure(t._view.getRoot(),1)):new MessageBox(errorDlgMsg,errorCannotDeleteMsg))):"3"==i.parent.labelElId&&(n=folderAction(n,u,"delete",r),n.Body.FolderActionResponse?(t._view.removeNode(i),t._model.removeFolderIndex(i),t._view.draw(),t.sendFolderStructure(t._view.getRoot())):n&&n.Body&&n.Body.Fault&&n.Body.Fault.Reason&&n.Body.Fault.Reason.Text?-1!=n.Body.Fault.Reason.Text.indexOf("no such folder id")&&(t._view.removeNode(i),t._view.draw(),t.sendFolderStructure(t._view.getRoot(),1)):new MessageBox(errorDlgMsg,errorCannotDeleteMsg)))},function(){},chooseButtonMsg,cancelButtonMsg,"300px",n,u+20,!1,!1)};TreeController.prototype.createNewFolder=function(n){function e(){var t=document.getElementById("foldertoMove").value,i;if(""!=t){if(i=document.getElementById("idSubFolder").value,""==i&&(i="1"),i){var r=u._view.getNodeByProperty("labelElId",i),n=Session.getInstance().getUser(),e=Session.getInstance().getAuthen(),f=new convertSpecialEntities;f.setInput(t);t=f.convertToHTMLCode();n=createFolder(n,e,i,t);n.Body.CreateFolderResponse?(this.cancel(),"1"==i?(oChildNode=new YAHOO.widget.TextNode("<div class='htmlnodelabel'><a>"+t+"<\/a><\/div>",u._view.getRoot(),!1),oChildNode.labelStyle="icon-subfolder",oChildNode.labelElId=n.Body.CreateFolderResponse.folder[0].id,u._view.draw(),u._model.folderIndex.push({path:t,index:oChildNode.index,node:oChildNode})):(oChildNode=new YAHOO.widget.TextNode("<div class='htmlnodelabel'><a>"+t+"<\/a><\/div>",r,!1),oChildNode.labelStyle="icon-subfolder",oChildNode.labelElId=n.Body.CreateFolderResponse.folder[0].id,r.expand(),r.refresh(),u._view.draw(),u._model.folderIndex.push({path:getLocation(r)+"/"+t,index:oChildNode.index,node:oChildNode})),u.sendFolderStructure(u._view.getRoot())):(n.Body.Fault&&n.Body.Fault.Detail&&n.Body.Fault.Detail.Error&&"mail.ALREADY_EXISTS"==n.Body.Fault.Detail.Error.Code?new MessageBox(errorDlgMsg,errorFolderExistMsg):n.Body.Fault&&n.Body.Fault.Detail&&n.Body.Fault.Detail.Error&&"service.PERM_DENIED"==n.Body.Fault.Detail.Error.Code?new MessageBox(errorDlgMsg,errorNoPermissionMsg):new MessageBox(errorDlgMsg,errorCreateNewFolder),this.cancel())}}else new MessageBox(errorDlgMsg,errorNoInputFolderName);this.cancel()}var f=n.node.labelElId,i,r,u,t;YAHOO.util.Dom.removeClass(f,"folderRightClick");t=document.body.appendChild(document.createElement("div"));t.setAttribute("id","moveDialog");t.appendChild(document.createElement("div")).className="hd";n=t.appendChild(document.createElement("div"));n.className="bd";i=document.createElement("div");r=document.createElement("label");r.innerHTML=folderMsg+": ";i.appendChild(r);r=document.createElement("input");r.setAttribute("type","text");r.setAttribute("size","30");r.setAttribute("id","foldertoMove");i.appendChild(r);r=document.createElement("input");r.setAttribute("type","hidden");r.setAttribute("id","idSubFolder");i.appendChild(r);n.appendChild(i);n=n.appendChild(document.createElement("div"));n.style.overflow="auto";n.style.background="none repeat scroll 0 0 #FFFFFF";n.style.height="200px";n.style.width="400px";n.style.border="1px solid #c0c0c0";n.style.marginTop="5px";n.style.bgcolor="#fdfcfa";n=n.appendChild(document.createElement("div"));n.id=TreeController.subTreeId+share.INDEX;share.INDEX++;i=new TreeModel(this._model.bmailFolderStructure);i=new TreeView(i);n={treeId:n.id,isSubTree:!0,haveRootNode:!0};i.createTree(n);i.addActiveStyle(i.getNodeByProperty("labelElId",f));this.changeExpandRootNode(i);i.tree.subscribe("labelClick",function(n){document.getElementById("idSubFolder").value=n.labelElId});t.appendChild(document.createElement("div")).className="ft";u=this;t=new YAHOO.widget.SimpleDialog(t,{fixedcenter:!0,modal:!0,width:"428px",constraintoviewport:!0,close:!1,visible:!1});t.cfg.queueProperty("buttons",[{text:chooseButtonMsg,handler:e},{text:closeButtonMsg,handler:function(){this.cancel()}}]);t.setHeader("<div class = 'rhd'><\/div><div class = 'rft'><\/div>"+createNewFolderMsg);t.render(document.body);t.bringToTop();t.show();document.getElementById("foldertoMove").focus();document.getElementById("idSubFolder").value=f;t.focusEnter(e);mailbox.getInstance().disableOutline()};TreeController.prototype.postToThisFolder=function(){YAHOO.util.Get.script(["js/editor/js/editor.js.zgz","js/Compose/compose.js.zgz"],{onFailure:function(){},onSuccess:function(){var n=new ComposeModel({composeType:"postfolder"}),t=new ComposeView(n);new ComposeController(t,n).init()}})};TreeController.prototype.emptyFolder=function(n){var i=n.node,t=this,r;n=YAHOO.util.Dom.getX(i.getElId());r=YAHOO.util.Dom.getY(i.getElId());new ConfirmBox(emptyFolderMsg,emptyContentFolderMsg,function(){var u=i.labelElId,n=t._view.getFirstParent(i),r=i.labelStyle;if(!n&&("icon-gtalk"==r||"icon-yahoo"==r)&&0<inboxAccount.length){for(n=-1,r=0;r<inboxAccount.length;r++)if(inboxAccount[r].rootId==u){n=r;break}u=inboxAccount[n].folderId}n=new XMLElement("FolderActionRequest");r=n.addElement("action");r.addAttribute("op","empty");r.addAttribute("id",u);n=new Soap(Session.getInstance().getUser(),n,"urn:zimbraMail",!0);n.isNeedAbort(!1);n.sendRequestCallback(function(n){"3"==u?n.Body&&n.Body.FolderActionResponse&&n.Body.FolderActionResponse.action&&n.Body.FolderActionResponse.action.id==u?(paging.getInstance().setTotalRecords(0,!0),dataTable.deleteRows(0,dataTable.getRecordSet().getLength()),n=YAHOO.widget.LayoutUnit.getLayoutUnitById("bottom5"),n.set("body",""),n=t._view.getNodeByProperty("labelElId","3"),n.refresh(),n.expand(),t._view.removeChildren(n),t._view.draw(),t.sendFolderStructure(t._view.getRoot(),2)):new MessageBox(errorDlgMsg,errorCannotDeleteMsg):n.Body&&n.Body.FolderActionResponse&&n.Body.FolderActionResponse.action&&n.Body.FolderActionResponse.action.id==u?(paging.getInstance().setTotalRecords(0,!0),dataTable.deleteRows(0,dataTable.getRecordSet().getLength()),n=YAHOO.widget.LayoutUnit.getLayoutUnitById("bottom5"),n.set("body","")):new MessageBox(errorDlgMsg,errorCannotDeleteMsg)})},function(){},chooseButtonMsg,cancelButtonMsg,"300px",n,r+20,!1,!1)};TreeController.prototype.draw=function(){this._view.draw()};TreeController.prototype.sendFolderStructure=function(n,t){for(var f=[],e=new convertSpecialEntities,s=this._model.folderIndex.length,i=0;i<s;i++){var u=this._model.folderIndex[i].node,h=u.labelElId,r=getNodeLocation(u);e.setInput(r);var r=e.convertToHTMLCode(),c=u.labelStyle,l=1,a="",a=u.parent&&u.parent.labelElId?u.parent.labelElId:"1",o=0;u.expanded&&(o=1);("icon-gtalk"==c||"icon-yahoo"==c)&&(r="icon-gtalk"==c?r+"@gmail.com":r+"@yahoo.com");f.push({folderId:h,folderPath:r,parentId:a,hidden:l,link:0,expanded:o})}for(Session.getInstance().getUser(),Session.getInstance().getAuthen(),s=this._model.bmailFolderStructure.length,i=0;i<s;i++)"0"==this._model.bmailFolderStructure[i].visible&&(h=this._model.bmailFolderStructure[i].id,r=this._model.bmailFolderStructure[i].path,e.setInput(r),r=e.convertToHTMLCode(),l=0,a=this._model.bmailFolderStructure[i].parentId,o=0,f.push({folderId:h,folderPath:r,parentId:a,hidden:l,link:0,expanded:o}));t?this._model.sendChangeFolderStructureRequest(f,t):this._model.sendChangeFolderStructureRequest(f)};TreeController.prototype.changeExpandRootNode=function(n){var i=n.tree;n=i.getRoot().children[0];var u=n.getElId().substring(4),u=parseInt(u),t="ygtvt"+u,r=location.protocol+"//"+location.hostname;"1"==n.labelElId?(YAHOO.util.Dom.setStyle(t,"background-image",'url("'+r+'/mail/giaodien/collapse.png")'),YAHOO.util.Dom.setStyle(t,"background-position","23px 5px"),i.subscribe("expand",function(n){n==i.getNodeByProperty("labelElId","1")&&(YAHOO.util.Dom.setStyle(t,"background-image",'url("'+r+'/mail/giaodien/collapse.png")'),YAHOO.util.Dom.setStyle(t,"background-position","23px 5px"))}),i.subscribe("collapse",function(n){n==i.getNodeByProperty("labelElId","1")&&(YAHOO.util.Dom.setStyle(t,"background-image",'url("'+r+'/mail/giaodien/expand.png")'),YAHOO.util.Dom.setStyle(t,"background-position","23px 5px"))})):(-1!=YAHOO.util.Dom.getStyle(t,"background-image").indexOf("tp.gif")?YAHOO.util.Dom.setStyle(t,"background-image",'url("'+r+'/mail/yui/build/treeview/assets/skins/sam/tph.gif")'):YAHOO.util.Dom.setStyle(t,"background-image",'url("'+r+'/mail/yui/build/treeview/assets/skins/sam/tmh.gif")'),i.subscribe("collapse",function(){YAHOO.util.Dom.setStyle(t,"background-image",'url("'+r+'/mail/yui/build/treeview/assets/skins/sam/tph.gif")')}),i.subscribe("expand",function(){YAHOO.util.Dom.setStyle(t,"background-image",'url("'+r+'/mail/yui/build/treeview/assets/skins/sam/tmh.gif")')}))};TreeDragDrop.PREFIX_NODE_DRAG="ygtvcontentel";TreeDragDrop.prototype.init=function(){new YAHOO.util.DDTarget(TreeView.treeId)};YAHOO.extend(DDList,YAHOO.util.DDProxy,{destNode:null,sourceNode:null,checkGoingUp:!1,sourceNodeSibling:[],destNodeSibling:[],startDrag:function(){TreeController.getInstance();var n=this.getDragEl(),t=this.getEl();n.innerHTML=t.innerHTML;YAHOO.util.Dom.setStyle(n,"width","auto");YAHOO.util.Dom.setStyle(n,"background-color","#fff");YAHOO.util.Dom.setStyle(n,"border","0px")},endDrag:function(n){var t=TreeController.getInstance()._model.folderIndex,r,i;TreeController.getInstance();r=TreeController.getInstance();i=this.getEl();n=this.getDragEl();YAHOO.util.Dom.setStyle(n,"visibility","");var i=new YAHOO.util.Motion(n,{points:{to:YAHOO.util.Dom.getXY(i)}},.2,YAHOO.util.Easing.easeOut),u=n.id,f=this.id;i.onComplete.subscribe(function(){var i,n;$(".rightFolder").removeClass("rightFolder");YAHOO.util.Dom.setStyle(u,"visibility","hidden");YAHOO.util.Dom.setStyle(f,"visibility","");for(var e=0,o=0,s=t.length,n=0;n<s;n++)t[n].node==destNode&&(e=n),t[n].node==sourceNode&&(o=n);if(i=[],n=!1,e<o&&(n=!0),n){if(0<e)for(n=0;n<e;n++)i.push(t[n]);for(i.push(t[e]),i.push(t[o]),n=e+1;n<o;n++)i.push(t[n]);if(o<s-1)for(n=o+1;n<s;n++)i.push(t[n])}else{if(0<o)for(n=0;n<o;n++)i.push(t[n]);for(n=o+1;n<e;n++)i.push(t[n]);if(i.push(t[e]),i.push(t[o]),e<s-1)for(n=e+1;n<s;n++)i.push(t[n])}console.log("tempFolderIndex:"+i);TreeController.getInstance()._model.folderIndex=i;r.sendFolderStructure(r._view.getRoot(),2);$("#"+labelId).children(".htmlnodelabel").css("color","#000")});i.animate()},onDragDrop:function(n,t){if(1===YAHOO.util.DragDropMgr.interactionInfo.drop.length&&!YAHOO.util.DragDropMgr.interactionInfo.sourceRegion.intersect(YAHOO.util.DragDropMgr.interactionInfo.point)){var r=YAHOO.util.DragDropMgr.getDDById(t),i=t.replace(TreeDragDrop.PREFIX_NODE_DRAG,""),u=YAHOO.util.Dom.get("ygtv"+i),i=this.getEl().id.replace(TreeDragDrop.PREFIX_NODE_DRAG,""),i=YAHOO.util.Dom.get("ygtv"+i);this.getSibling();YAHOO.util.Dom.insertAfter(i,u);this.insertAfter(sourceNode,destNode);this.getSibling();r.isEmpty=!1;this.refreshTree();YAHOO.util.DragDropMgr.refreshCache()}},insertBefore:function(n,t){var i=t.parent,r;i&&(n.tree&&n.tree.popNode(n),r=t.isChildOf(i),i.children.splice(r,0,n),t.previousSibling&&(t.previousSibling.nextSibling=n),n.previousSibling=t.previousSibling,n.nextSibling=t,t.previousSibling=n,n.applyParent(i))},insertAfter:function(n,t){var i=t.parent,r;if(i){if(n.tree&&n.tree.popNode(n),r=t.isChildOf(i),!t.nextSibling)return n.nextSibling=null,n.appendTo(i);i.children.splice(r+1,0,n);t.nextSibling.previousSibling=n;n.previousSibling=t;n.nextSibling=t.nextSibling;t.nextSibling=n;n.applyParent(i)}},getSibling:function(){this.sourceNodeSibling.push(sourceNode.nextSibling);this.sourceNodeSibling.push(sourceNode.previousSibling);this.sourceNodeSibling.push(sourceNode);this.destNodeSibling.push(destNode.nextSibling);this.destNodeSibling.push(destNode.previousSibling);this.destNodeSibling.push(destNode)},refreshTree:function(){for(var t,n=0;n<this.sourceNodeSibling.length;n++)t=this.sourceNodeSibling[n],t&&this.refreshNode(t);for(n=0;n<this.destNodeSibling.length;n++)(t=this.destNodeSibling[n])&&this.refreshNode(t);this.sourceNodeSibling=[];this.destNodeSibling=[]},refreshNode:function(n){var t=n.getElId(),t=t.replace("ygtv",""),t="ygtvt"+t;n.hasChildren()&&!n.nextSibling&&n.previousSibling?(this.refreshClass(t),$("#"+t).addClass("ygtvlp")):0==n.depth&&n.hasChildren()&&n.nextSibling&&!n.previousSibling?(this.refreshClass(t),$("#"+t).addClass("ygtvtph")):0!=n.depth&&n.hasChildren()&&n.nextSibling&&!n.previousSibling?(this.refreshClass(t),$("#"+t).addClass("ygtvtp")):n.hasChildren()&&n.previousSibling&&n.nextSibling?(this.refreshClass(t),$("#"+t).addClass("ygtvtp")):!n.hasChildren()&&n.nextSibling&&n.previousSibling?(this.refreshClass(t),$("#"+t).addClass("ygtvtn")):n.hasChildren()||n.nextSibling||!n.previousSibling?0!=n.depth||n.hasChildren()||!n.nextSibling||n.previousSibling?0==n.depth||n.hasChildren()||!n.nextSibling||n.previousSibling||(this.refreshClass(t),$("#"+t).addClass("ygtvtn")):(this.refreshClass(t),$("#"+t).addClass("ygtvtnh")):(this.refreshClass(t),$("#"+t).addClass("ygtvln"))},refreshClass:function(n){$("#"+n).removeClass();$("#"+n).addClass("ygtvcell")},onDrag:function(n){n=YAHOO.util.Event.getPageY(n);n<this.lastY?this.goingUp=!0:n>this.lastY&&(this.goingUp=!1);this.lastY=n},onDragOver:function(n,t){var u,i,r;TreeController.getInstance();u=TreeController.getInstance()._model.oTextNodeMap;TreeController.getInstance();i=this.getEl();r=YAHOO.util.Dom.get(t);r&&r.id.match(/^ygtvcontentel[0-9]+$/)&&(i=i.id.match(/[0-9]+$/),sourceNode=u["ygtvcontentel"+i[0]],i=r.id.match(/[0-9]+$/),destNode=u["ygtvcontentel"+i[0]],$(".rightFolder").removeClass("rightFolder"),$("#"+r.id).addClass("rightFolder"),YAHOO.util.DragDropMgr.refreshCache())}});TreeModel.SYNC_URL="https://webeoffice.bkav.com/SyncBmail.asmx/SyncFolder";TreeModel.CHECKVERSION_URL="https://webeoffice.bkav.com/SyncBmail.asmx/CheckUpdateFromBmail";TreeModel.prototype.initObServerEvent=function(){this.initCalendarEvent=new Event(this);this.initContactEvent=new Event(this);this.initFacebookEvent=new Event(this);this.redrawTreeViewEvent=new Event(this)};TreeModel.prototype.getBmailFolderStructure=function(){return this.bmailFolderStructure};TreeModel.prototype.set=function(n,t){this[n]=t};TreeModel.prototype.getAccountArray=function(){return this.accountArray};TreeModel.prototype.setBmailFolderStructure=function(n){this.bmailFolderStructure=n};TreeModel.getlastUpdate=function(){var n=new Date,u=n.getMonth()+1,f=n.getFullYear(),e=n.getDate(),i="AM",t=n.getHours(),r;return 12<t&&(i="PM",t-=12),r=n.getMinutes(),n=n.getSeconds(),u+"/"+e+"/"+f+", "+t+":"+r+":"+n+" "+i};TreeModel.prototype.getVersionTreeStructure=function(){if("tool"==mailbox.getInstance().client){var t=this.versionStructure||"12/26/2014, 4:58:33 PM",n=this;"dungha"!=readCookie("bkavUsername")&&"dunghv"!=readCookie("bkavUsername")&&"cuongnt"!=readCookie("bkavUsername")&&"congntb"!=readCookie("bkavUsername")&&"hungpv"!=readCookie("bkavUsername")||$.ajax({url:TreeModel.CHECKVERSION_URL,data:{email:readCookie("bkavUsername"),lastBmailUpdate:t},type:"POST",success:function(t){var i=$("UpdateFromBmail",t),i=i[0],i=i.textContent;"false"==i&&(n.needSyncFolder=!0);i=$("Version",t);i=i[0];i=i.textContent;n.versionStructure=i;console.log("_this.versionStructure: "+n.versionStructure);n.updateVersionStructure();window.setTimeout(function(){console.log("this.needSyncFolder: "+n.needSyncFolder);n.sync||"tool"!=mailbox.getInstance().client||n.syncFolderStructureRequest(n.structureString);n.structureString=null},3e4)},error:function(){}})}};TreeModel.prototype.updateVersionStructure=function(){var n=new XMLElement("ModifyVersionInfoRequest");n.addAttribute("bmailFolderStructureVersion",this.versionStructure);n=new Soap(Session.getInstance().getUser(),n,"urn:zimbraAccount",!0);n.setSimple(!0);n.isNeedAbort(!1);n.sendRequestCallback(function(){})};TreeModel.prototype.syncFolderStructureRequest=function(n){var t=this;"dungha"!=readCookie("bkavUsername")&&"dunghv"!=readCookie("bkavUsername")&&"cuongnt"!=readCookie("bkavUsername")&&"tienbv"!=readCookie("bkavUsername")&&"hopcv"!=readCookie("bkavUsername")&&"tamdn"!=readCookie("bkavUsername")&&"trinhnvd"!=readCookie("bkavUsername")&&"quangp"!=readCookie("bkavUsername")&&"dambv"!=readCookie("bkavUsername")&&"dungnvl"!=readCookie("bkavUsername")||$.ajax({url:TreeModel.SYNC_URL,data:{email:readCookie("bkavUsername"),lastUpdate:t.fistVersionStructure,contentFolderBmail:"<folders>"+n+"<\/folders>"},type:"POST",success:function(n){console.log(n);n=$("string",n);n.text()?(n=Util.toJson(n.text()),t.handleSyncFolderStructureData(n)):t.sync=!0},error:function(){t.sync=!0}})};TreeModel.prototype.getNewFolderSync=function(){};TreeModel.prototype.handleSyncFolderStructureData=function(n){for(var s=n.length,f=[],u=0;u<s;u++){var t=n[u],r=t.BmailFolderId,i=t.BmailFolderPath,e=i.split("/"),h=t.BmailIsLink,o=t.BmailIsClientNotification,c=t.BmailIsServerNotification,l=t.BmailIsVisible,t=t.BmailParentId;r&&"null"!=r||this.getNewFolderSync(i);i={path:i,id:r,link:h,folderName:e[e.length-1],visible:l,parentId:t,isServerConfigNotify:c,isClientConfigNotify:o,isOpen:0};"1"==o?Tool.getInstance().setFolderNotify(r,"0"):Tool.getInstance().setFolderNotify(r,"1");f.push(i);t=new Folder(i);FolderCache.getInstance().push(t)}this.bmailFolderStructure=f;this.redrawTreeViewEvent.notify();"tool"==mailbox.getInstance().client&&Tool.getInstance().getConfigFolder()};TreeModel.prototype.handleLastCacheData=function(n){if(n=this.getLastOfCacheData(n)){var t=n.folderId;checkFolderCache(t)&&(FolderCache.getInstance().set(t,"lastFocus",n.lastFocus),FolderCache.getInstance().set(t,"lastMessage",n.message))}};TreeModel.prototype.handleSelectFolder=function(n){var f=this,t=n.node,r,i;if(n=n.mailId||"",r=t.labelElId,"icon-calendar"==t.labelStyle)f.initCalendarEvent.notify();else if("icon-contact"==t.labelStyle)f.initContactEvent.notify();else if("icon-facebook"==t.labelStyle)t=getindexTabByLabel(facebookMsg),-1!=t&&tabView.set("activeIndex",t),-1==t&&YAHOO.util.Get.script(["js/facebook/facebook.js.zgz"],{onFailure:function(){},onSuccess:function(){f.initFacebookEvent.notify()}}),YAHOO.util.Dom.setStyle(document.body,"cursor","default");else if("icon-gtalk"!=t.labelStyle&&"icon-yahoo"!=t.labelStyle){if(i=!1,"icon-subfolder"==t.labelStyle||"icon-publicfolder"==t.labelStyle||"icon-sharefolder"==t.labelStyle){for(var o=t.depth,u=t,e=0;e<o;e++)u=u.parent;("icon-gtalk"==u.labelStyle||"icon-yahoo"==u.labelStyle)&&(i=!0)}i||(currentFolder=this.getCurrentFolder(t),dataTable.deleteAllRows(),i=!1,mailbox.getInstance().listMailStorage&&mailbox.getInstance().listMailStorage.get(r)&&(i=!0),checkFolderCache(r)||i?this.handleFolderExistCache(t,n):(currentFolderId=r,loadMail(currentFolder,n)))}};TreeModel.prototype.handleFolderExistCache=function(n,t){var r=n.labelElId,u=this.getCurrentFolder(n),i=null;mailbox.getInstance().listMailStorage&&(i=mailbox.getInstance().listMailStorage.getCurrentList(r));var f=[],f=i?i:FolderCache.getInstance().get(r,"Data"),i=!0;currentFolderId==r&&(i=!1);currentFolder=u;currentFolderId=r;dataTable.updateData(f,i,t);updatePaginator(currentFolderId);YAHOO.util.Dom.setStyle(document.body,"cursor","default")};TreeModel.prototype.removeFolderIndex=function(n){var i=[],r=this.folderIndex.length,t;if(0<r){for(t=0;t<r;t++)this.folderIndex[t].node!=n&&i.push(this.folderIndex[t]);this.folderIndex=i}};TreeModel.prototype.getCurrentFolder=function(n){var t="inbox";return"2"==n.labelElId?t="inbox":"5"==n.labelElId?t="sent":"4"==n.labelElId?t="junk":"6"==n.labelElId?t="drafts":"3"==n.labelElId?t="trash":(t=getLocation(n),n=new convertSpecialEntities,n.setInput(t),t=n.convertToHTMLEntity()),t};TreeModel.prototype.sendChangeFolderStructureRequest=function(n){var f,e,o;0!=currentUser.timeoutSession&&window.clearTimeout(mailbox.getInstance().timeout);var s=Session.getInstance().getIpServer(),r=Session.getInstance().getAuthen(),u=Session.getInstance().getUser(),s=location.protocol+"//"+s+"/service/soap",i;i="<soap:Envelope xmlns:soap='http://www.w3.org/2003/05/soap-envelope'><soap:Header><context xmlns='urn:zimbra'>";i+="<format type='js'/>";i+="<account by='name'>"+u+"<\/account>";i+="<authToken >"+r+"<\/authToken>";i+="<\/context>";i+="<\/soap:Header>";i+="<soap:Body>";i+="<FolderStructureChangeRequest xmlns='urn:zimbraMail'>";i+="<account by='name'>"+u+"<\/account>";i+="<authToken >"+r+"<\/authToken>";for(var r=n.length,u="",t=0;t<r;t++)f=-1,e=n[t].folderPath,n[t].expanded&&(f=n[t].expanded),o=Util.getNotify(n[t].folderId),-1==f?(i+="<folder path='"+e+"'  id='"+n[t].folderId+"' visible='"+n[t].hidden+"' link='"+n[t].link+"' parentid ='"+n[t].parentId+"'><\/folder>",u+="<folder path='"+e+"'  id='"+n[t].folderId+"' visible='"+n[t].hidden+"' link='"+n[t].link+"' parentid ='"+n[t].parentId+"' notify ='"+o+"'><\/folder>"):(i+="<folder path='"+e+"'  id='"+n[t].folderId+"' visible='"+n[t].hidden+"' isOpen='"+f+"' link='"+n[t].link+"' parentid ='"+n[t].parentId+"'><\/folder>",u+="<folder path='"+e+"'  id='"+n[t].folderId+"' visible='"+n[t].hidden+"' isOpen='"+f+"' link='"+n[t].link+"' parentid ='"+n[t].parentId+"' notify ='"+o+"'><\/folder>");this.structureString=u;this.sync&&(this.versionStructure=(new Date).getTime(),this.updateVersionStructure());i+="<\/FolderStructureChangeRequest>";i+="<\/soap:Body>";i+="<\/soap:Envelope>";r=getRequest();r.onreadystatechange=this.handleChangeFolderStructureCallback(r);r.open("POST",s,!0,"FolderStructureChangeRequest");r.send(i)};TreeModel.prototype.handleChangeFolderStructureCallback=function(n){if(4==n.readyState&&200==n.status){n=Util.toJson(n.responseText);for(var i=[],u=n.Body.FolderStructureChangeResponse.l.length,t=0;t<u;t++){var f=n.Body.FolderStructureChangeResponse.l[t].path,e=n.Body.FolderStructureChangeResponse.l[t].id,o=n.Body.FolderStructureChangeResponse.l[t].visible,s=n.Body.FolderStructureChangeResponse.l[t].link,h=n.Body.FolderStructureChangeResponse.l[t].parentid,r="0";n.Body.FolderStructureChangeResponse.l[t].isOpen&&(r=n.Body.FolderStructureChangeResponse.l[t].isOpen);i.push({path:f,id:e,visible:o,link:s,parentId:h,isOpen:r});this.bmailFolderStructure=i}}};TreeModel.prototype.abortChangeFolderStructureXhr=function(){this.changeFolderStructureXhr&&this.changeFolderStructureXhr.abort();this.changeFolderStructureXhr=null};TreeModel.prototype.getLastOfCacheData=function(n){var u=null,i=0,t,r;if(currentUser.scrollToGetMail||(i=dataTable.getStartIndex()),0==i){if(i=n.labelElId,("icon-yahoo"==n.labelStyle||"icon-gtalk"==n.labelStyle)&&0<inboxAccount.length){for(t=-1,r=0;r<inboxAccount.length;r++)if(inboxAccount[r].rootId==n.labelElId){t=r;break}-1!=t&&(i=inboxAccount[t].folderId)}n=MailCache.getInstance().getLastFocus();t=MailCache.getInstance().getLastRowId();(t=MailCache.getInstance().getMessageByRowId(t))&&(u={folderId:i,lastFocus:n,message:t})}return u};TreeModel.prototype.updateFolderStructureChanged=function(){var n=Session.getInstance().getUser(),t=new XMLElement("UpdateFolderStructureChangedRequest");t.addElement("account").setText(n);n=new Soap(n,t,"urn:zimbraMail",!0);n.setSimple(!1);n.isNeedAbort(!1);n.sendRequestCallback(function(){})};TreeView.TREE_ID="treeDiv1";TreeView.CONTEXT_MENU_ID="treecontextmenu";TreeView.prototype.initObserverEvent=function(){this.selectFolderEvent=new Event(this);this.postToThisFolderEvent=new Event(this);this.syncFolderEvent=new Event(this);this.createNewFolderEvent=new Event(this);this.deleteFolderEvent=new Event(this);this.moveFolderEvent=new Event(this);this.renameFolderEvent=new Event(this);this.createPublicFolderEvent=new Event(this);this.createShareFolderEvent=new Event(this);this.editFolderEvent=new Event(this);this.markAllReadFolderEvent=new Event(this);this.manageFoldersEvent=new Event(this);this.emptyFolderEvent=new Event(this);this.folderStructureChangeEvent=new Event(this)};TreeView.prototype.createTree=function(n){var t=this;YAHOO.util.Event.onDOMReady(function(){var r=n.treeId||TreeView.TREE_ID,i;t.isSubTree=n.isSubTree||!1;t.haveRootNode=n.haveRootNode||!1;t.displayHiddenFolder=n.displayHiddenFolder||!1;t.dynamicLoad=n.dynamicLoad||!1;t.tree=new YAHOO.widget.TreeView(r);t.dynamicLoad&&t.tree.setDynamicLoad(t.dynamicLoadChildNode,1);i=t.getRoot();t.haveRootNode&&(i=new YAHOO.widget.TextNode("<div class='htmlnodelabel'><a>Root<\/a><\/div>",t.tree.getRoot(),!0),i.labelElId="1",i.labelStyle="icon-subfolder");t.tree.singleNodeHighlight=!0;t.tree.subscribe("clickEvent",function(n){return t.handleSelectFolder(n.node),!1});t.isSubTree||(t.tree.subscribe("expand",function(n){n==t.serviceNode&&(t.expandServiceNode(n),YAHOO.util.Dom.setStyle(t.hiddenServiceNode.getElId(),"display","none"))}),t.tree.subscribe("collapse",function(n){n==t.serviceNode&&(t.collapseServiceNode(n),YAHOO.util.Dom.setStyle(t.hiddenServiceNode.getElId(),"display","none"))}),t.tree.subscribe("collapseComplete",function(n){t.expandClick&&n!=t.serviceNode&&(n={rootNode:t.getRoot()},t.folderStructureChangeEvent.notify(n))}),t.tree.subscribe("expandComplete",function(n){t.expandClick&&n!=t.serviceNode&&(n={rootNode:t.getRoot()},t.folderStructureChangeEvent.notify(n));dataTable.initDragDrop();t.setIEStyle()}));mailbox.getInstance().loadFromBpr||t.buildChildNode(i);t.isSubTree&&$("#"+r).css("width","150%")})};TreeView.prototype.getTreeDefinition=function(){return this.tree.getTreeDefinition()};TreeView.prototype.createOriginalTree=function(){var n=this.tree.getRoot();this.insertNode("inbox","Hộp thư đến","2","icon-inbox",n);this.insertNode("sent","Hộp thư đi","5","icon-send",n);this.insertNode("drafts","Thư đang soạn","6","icon-draft",n);this.insertNode("junk","Thư rác","4","icon-junk",n);this.insertNode("trash","Thư đã xóa","3","icon-trash",n);this.tree.draw()};TreeView.prototype.expandServiceNode=function(n){mailbox.getInstance().isEgov||(n=n.getElId().substring(4),n=parseInt(n),YAHOO.util.Dom.setStyle("ygtvt"+n,"background-image",'url("'+(location.protocol+"//"+location.hostname)+'/mail/yui/build/treeview/assets/skins/sam/tm.gif")'),$("#serviceNode .htmlnodelabel").css("margin-top","5px"),YAHOO.util.Dom.setStyle(this.calendarNode.getElId(),"display","block"),YAHOO.util.Dom.setStyle(this.contactNode.getElId(),"display","block"),this.sendRequestCollapseExpandServiceNode("TRUE"))};TreeView.prototype.collapseServiceNode=function(n){mailbox.getInstance().isEgov||(n=n.getElId().substring(4),n=parseInt(n),YAHOO.util.Dom.setStyle("ygtvt"+n,"background-image",'url("'+(location.protocol+"//"+location.hostname)+'/mail/yui/build/treeview/assets/skins/sam/lp.gif")'),$("#serviceNode .htmlnodelabel").css("margin-top","4px"),YAHOO.util.Dom.setStyle(this.calendarNode.getElId(),"display","none"),YAHOO.util.Dom.setStyle(this.contactNode.getElId(),"display","none"),this.sendRequestCollapseExpandServiceNode("FALSE"))};TreeView.prototype.sendRequestCollapseExpandServiceNode=function(n){var r=Session.getInstance().getUser(),t=new XMLElement("ModifyPrefsRequest"),i=t.addElement("pref");i.addAttribute("name","zimbraPrefFolderTreeOpen");i.setText(n);new Soap(r,t,"urn:zimbraAccount",!0,sessionId,seqNotify).sendRequestCallback(function(n,t){mailbox.getInstance().serviceExpandState=t},n)};TreeView.prototype.setIEStyle=function(){"Microsoft Internet Explorer"==navigator.appName&&($(".activeNode").mouseover(function(){$(this).css("color","#fff")}),$(".activeNode").mouseout(function(){$(this).css("color","#fff")}),$(".htmlnodelabel a").mouseover(function(){$(this).closest(".htmlnodelabel").hasClass("activeNode")||$(this).css("color","#0A54FF")}),$(".htmlnodelabel a").mouseout(function(){$(this).closest(".htmlnodelabel").hasClass("activeNode")||$(this).css("color","#000")}),$(".htmlnodelabel b").mouseover(function(){$(this).css("color","#0A54FF")}),$(".htmlnodelabel b").mouseout(function(){$(this).css("color","#000")}),mailbox.getInstance().disableOutline())};TreeView.prototype.buildChildNode=function(n,t){this.existNode=[];for(var s=this._model.bmailFolderStructure.length,u=[],h=[],i=0;i<s;i++){var r=this._model.bmailFolderStructure[i].path,f=this._model.bmailFolderStructure[i].id,o=this._model.bmailFolderStructure[i].visible,e="0";this._model.bmailFolderStructure[i].isOpen&&(e=this._model.bmailFolderStructure[i].isOpen);-1==r.indexOf("/")?"2"==f?this.insertNode(inboxMsg,"2",r,"icon-inbox",n,i,e,u,!1,o):"5"==f?this.insertNode(sentMsg,"5",r,"icon-send",n,i,e,u,!1,o):"6"==f?this.insertNode(draftMsg,"6",r,"icon-draft",n,i,e,u,!1,o):"4"==f?this.insertNode(junkMsg,"4",r,"icon-junk",n,i,e,u,!1,o):"3"==f?this.insertNode(trashMsg,"3",r,"icon-trash",n,i,e,u,!1,o):-1==r.indexOf("@yahoo.com")&&-1==r.indexOf("@gmail.com")&&this.insertNode(r,f,r,"icon-subfolder",n,i,e,u,!0,o):h.push(this._model.bmailFolderStructure[i])}if(this.arrInspectNode=h,!this.dynamicLoad)for(s=this.getMaxDept(this._model.bmailFolderStructure),i=0;i<s-1;){for(r=[],f=0;f<u.length;f++)this.insertChildNode(u[f],h,i,r);i++;u=r}this.tree.draw();u={rootNode:this.getRoot()};t||this.isSubTree||this.folderStructureChangeEvent.notify(u);this.isSubTree||(this.selectedNode&&this.getNodeByProperty("labelElId",this.selectedNode.labelElId)?this.addActiveStyle(this.getNodeByProperty("labelElId",this.selectedNode.labelElId)):(this.addActiveStyle(this.getNodeByProperty("labelElId","2")),this.selectedNode=this.getNodeByProperty("labelElId","2")),this.handleNotifyFolderStructureChanged())};TreeView.prototype.dynamicLoadChildNode=function(n,t){var r=TreeController.getInstance()._view.arrInspectNode,i,f,e,u;for(getSubfolderLabel(n.label),i=0;i<r.length;i++)f=r[i].visible,r[i].path.split("/"),r[i].parentId==n.labelElId&&(e=r[i].id,u=new YAHOO.widget.TextNode("<div class='htmlnodelabel'><a>"+r[i].folderName+"<\/a><\/div>",n,!1),u.labelStyle="0"==f?"icon-hiddenfolder":"icon-subfolder",u.labelElId=e);t()};TreeView.prototype.updateUnreadForNode=function(n,t,i,r){var u=null;if(this.isSubTree)u=new YAHOO.widget.TextNode("<div class='htmlnodelabel'><a>"+n+"<\/a><\/div>",i,!1);else{if(t=FolderCache.getInstance().getFolder(t),!t)return new YAHOO.widget.TextNode("<div class='htmlnodelabel'><a>"+n+"<\/a><\/div>",i,!0);t=t.u;u=0<t?r&&"1"==r?new YAHOO.widget.TextNode("<div class='htmlnodelabel'><b>"+n+" ("+t+")<\/div>",i,!0):new YAHOO.widget.TextNode("<div class='htmlnodelabel'><b>"+n+" ("+t+")<\/div>",i,!1):r&&"1"==r?new YAHOO.widget.TextNode("<div class='htmlnodelabel'><a>"+n+"<\/a><\/div>",i,!0):new YAHOO.widget.TextNode("<div class='htmlnodelabel'><a>"+n+"<\/a><\/div>",i,!1)}return u};TreeView.prototype.insertNode=function(n,t,i,r,u,f,e,o,s,h){this.isSubTree||-1==getIndexOf(this._model.linkExpires,t)?(this.isSubTree&&(e=!1),"1"==h?(n=this.updateUnreadForNode(n,t,u,e),s&&!this.isSubTree?(r=Util.checkExistLinkShare(t),n.labelStyle=r?r.shareFolder?"icon-sharefolder":"icon-publicfolder":"icon-subfolder"):n.labelStyle=r,n.labelElId=t,n.nowrap=!0,o.push(n),this.isSubTree||(this._model.oTextNodeMap["ygtvcontentel"+n.index]=n,new DDList(TreeDragDrop.PREFIX_NODE_DRAG+n.index,"mainFolder"),this._model.folderIndex.push({path:i,index:n.index,node:n}))):this.displayHiddenFolder&&(n=this.updateUnreadForNode(n,t,u,e),n.labelStyle="icon-hiddenfolder",n.labelElId=t,o.push(n)),this.tree.draw()):(i=Session.getInstance().getUser(),o=Session.getInstance().getAuthen(),folderAction(i,o,"delete",t))};TreeView.prototype.insertChildNode=function(n,t,i,r){for(var o,u,l,e=getSubfolderLabel(n.label),f=0;f<t.length;f++){o=t[f].visible;u="0";t[f].isOpen&&(u=t[f].isOpen);var c=t[f].path,h=c.split("/"),s=t[f].parentId;0==i&&("2"==n.labelElId?e="inbox":"5"==n.labelElId?e="sent":"6"==n.labelElId?e="drafts":"4"==n.labelElId?e="junk":"3"==n.labelElId&&(e="trash"));l=n.labelElId;("1"==o||this.displayHiddenFolder)&&h.length==i+2&&s==l&&h[i].toUpperCase()==e.toUpperCase()&&(s=t[f].id,u=this.updateUnreadForNode(h[i+1],s,n,u),u.labelStyle=this.displayHiddenFolder&&"0"==o?"icon-hiddenfolder":"icon-subfolder",u.labelElId=s,u.nowrap=!0,this.isSubTree||"1"!=o||(this._model.oTextNodeMap["ygtvcontentel"+u.index]=u,new DDList(TreeDragDrop.PREFIX_NODE_DRAG+u.index,n.labelElId),this._model.folderIndex.push({path:c,index:u.index,node:u})),r.push(u),this.tree.draw())}};TreeView.prototype.handleNotifyFolderStructureChanged=function(){if("TRUE"!=this._model.bmailFolderStructureChanged)mailbox.getInstance().sendMailToTool();else{var n=mailbox.getInstance().getFolderStructureByGetInfo(infoResponse,!0),n=TreeView.arr_diff(this._model.bmailFolderStructure,n);0<n.length&&this.handleFolderChange(n)}};TreeView.prototype.handleFolderChange=function(n){var r=n.length,f=[],o=[],e,i,t,u;for(console.log("diff: "+n),e=[],i=0;i<r;i++)t=n[i].isInfo||!1,t&&!n[i].perm&&(t=!1),u=n[i].id,t?(t=n[i].path,-1==t.indexOf("/")?this.insertNode(t,u,t,"icon-subfolder",this.getRoot(),i,"1",f,!0,!0):o.push(n[i])):(t=this.tree.getNodeByProperty("labelElId",u),console.log("node: "+t),t&&(this._model.removeFolderIndex(t),e.push(u)));if(0<e.length)for(r=0;r<e.length;r++)(t=this.tree.getNodeByProperty("labelElId",e[r]))&&this.removeNode(t);if(e=this.getMaxDept(n),r=0,0<o.length)for(;r<e-1;){if(i=[],0<f.length)for(u=0;u<f.length;u++)this.insertChildNode(f[u],o,r,i);r++;f=i}this.draw();f={rootNode:this.getRoot()};console.log("folderStructureChangeEvent");this.folderStructureChangeEvent.notify(f);console.log("notifyFolderStructureChanged");this.notifyFolderStructureChanged(n);mailbox.getInstance().sendMailToTool()};TreeView.arr_diff=function(n,t){for(var f,r=[],u=[],i=0;i<n.length;i++)r[n[i].id]=n[i];for(i=0;i<t.length;i++)r[t[i].id]?delete r[t[i].id]:r[t[i].id]=t[i];for(f in r)u.push(r[f]);return u};TreeView.prototype.notifyFolderStructureChanged=function(n){var r=document.body.appendChild(document.createElement("div")),t,f,e,u,s;if(r.setAttribute("id","moveDialog"),r.appendChild(document.createElement("div")).className="hd",t=r.appendChild(document.createElement("div")),t.className="bd",t=t.appendChild(document.createElement("div")),t.setAttribute("id","bodyMoveDialog"),t.style.overflow="auto",t.style.background="none repeat scroll 0 0 #FFFFFF",t.style.height="300px",t.style.width="454px",t.style.border="1px solid #c0c0c0",t.style.marginTop="5px",t.style.bgcolor="#fdfcfa",t=t.appendChild(document.createElement("div")),t.id=TreeController.subTreeId+share.INDEX,share.INDEX++,r.appendChild(document.createElement("div")).className="ft",f="<table cellpadding='4' cellspacing='4' style='width:400px;margin:20px'><tr><th>Tên mục tin<\/th><th>Loại thay đổi<\/>",console.log("diff: "+n),e=n.length,0<e)for(u=0;u<e;u++){var i=n[u],h=i.path,o=i.isInfo||!1;o&&!i.perm&&(o=!1);i="Xóa";o&&(i="Thêm mới");f+="<tr><td>"+h+"<\/td><td>"+i+"<\/td><\/tr>"}t.innerHTML=f+"<\/table>";s=this;n=new YAHOO.widget.SimpleDialog(r,{fixedcenter:!0,modal:!0,constraintoviewport:!0,close:!1,width:"480px",visible:!1});n.cfg.queueProperty("buttons",[{text:chooseButtonMsg,handler:function(){this.cancel();s._model.updateFolderStructureChanged()}}]);n.setHeader("<div class = 'rhd'><\/div><div class = 'rft'><\/div>Các mục tin thay đổi");n.render(document.body);n.bringToTop();n.show();n.focusEnter(handleOk);mailbox.getInstance().disableOutline()};TreeView.prototype.getTreeViewStructure=function(n,t){var u,s;if(n.children){for(var r=n.children,h=r.length,i=0;i<h;i++)if(u=this.getFirstParent(r[i]),(!u||u&&"icon-contact"!=u.labelStyle&&"icon-calendar"!=u.labelStyle&&"icon-service"!=u.labelStyle&&"icon-facebook"!=u.labelStyle)&&"icon-contact"!=r[i].labelStyle&&"icon-calendar"!=r[i].labelStyle&&"icon-service"!=r[i].labelStyle&&"icon-facebook"!=r[i].labelStyle){var c=r[i].labelElId,f=getLocation(r[i]),e=new convertSpecialEntities;e.setInput(f);var f=e.convertToHTMLCode(),o=r[i].labelStyle,e=1,l="",l=r[i].parent&&r[i].parent.labelElId?r[i].parent.labelElId:"1";if("icon-hiddenFolder"==o&&(e=0),o=0,r[i].expanded&&(o=1),u&&("icon-gtalk"==u.labelStyle||"icon-yahoo"==u.labelStyle)&&(u=f.split("/"),f="",f=u[0]+"@gmail.com",1<u.length))for(s=1;s<u.length;s++)f+="/"+u[s];t.push({folderId:c,folderPath:f,parentId:l,hidden:e,link:0,expanded:o})}for(i=0;i<h;i++)r[i].hasChildren&&this.getTreeViewStructure(r[i],t)}};TreeView.prototype.getMaxDept=function(n){for(var r,t=0,i=0;i<n.length;i++)r=n[i].path.split("/"),t<r.length&&(t=r.length);return t};TreeView.prototype.addFacebookFolder=function(n){mailbox.getInstance().isEgov||(n=new YAHOO.widget.TextNode("<div class='htmlnodelabel'><a>"+facebookWallMsg+"<\/a><\/div>",n,!0),n.labelElId="facebookNode",n.labelStyle="icon-facebook")};TreeView.prototype.removeServiceNode=function(){mailbox.getInstance().isEgov||(this.removeNode(this.serviceNode),this.removeNode(this.contactNode),this.removeNode(this.calendarNode))};TreeView.prototype.addServiceNode=function(n){mailbox.getInstance().isEgov||(this.serviceNode=new YAHOO.widget.TextNode("<div class='htmlnodelabel'><a>"+applicationMsg+"<\/a><\/div>",n,!0),this.serviceNode.labelElId="serviceNode",this.serviceNode.labelStyle="icon-service",this.hiddenServiceNode=new YAHOO.widget.TextNode("<div class='htmlnodelabel'><a>"+addressBookMsg+"<\/a><\/div>",this.serviceNode,!0),this.contactNode=new YAHOO.widget.TextNode("<div class='htmlnodelabel'><a>"+addressBookMsg+"<\/a><\/div>",n,!0),this.contactNode.labelElId="contactNode",this.contactNode.labelStyle="icon-contact",this.calendarNode=new YAHOO.widget.TextNode("<div class='htmlnodelabel'><a>"+calendarMsg+"<\/a><\/div>",n,!0),this.calendarNode.labelElId="calendarNode",this.calendarNode.labelStyle="icon-calendar",this.tree.draw(),this.serviceNode.hideChildren(),this.tree.draw(),YAHOO.util.Dom.setStyle(this.hiddenServiceNode.getElId(),"display","none"),"TRUE"===mailbox.getInstance().serviceExpandState?this.serviceNode&&this.serviceNode.expand():this.serviceNode&&this.serviceNode.collapse())};TreeView.prototype.handleSelectFolder=function(n,t){var i,r;this.oContextMenu&&!this.contextMenuClick&&this.oContextMenu.hide();this.contextMenuClick&&(this.contextMenuClick=!1);this.isSubTree||0==tabView.get("activeIndex")||tabView.set("activeIndex",0);this.selectedNode||(this.selectedNode=this.getNodeByProperty("labelElId","2"));n!=this.selectedNode&&((dataTable.scrollTop=0,EmailDragDrop.getInstance().reset(),-1!=getIndexOf(this._model.linkExpires,n.labelElId))?(i=this,new ConfirmBox(messageBoxMsg,noFolderRoleMsg,function(){var t=Session.getInstance().getUser(),u=Session.getInstance().getAuthen(),r=n.labelElId,t=folderAction(t,u,"delete",r);t.Body.FolderActionResponse&&(t.Body.FolderActionResponse.action&&t.Body.FolderActionResponse.action.id?r==t.Body.FolderActionResponse.action.id?(i.removeNode(n),i._model.removeFolderIndex(n),i.tree.draw(),r={rootNode:i.getRoot()},i.folderStructureChangeEvent.notify(r)):new MessageBox(messageBoxMsg,"Bạn không có quyền xóa thư mục này!"):new MessageBox(messageBoxMsg,"Bạn không có quyền xóa thư mục này!"))})):(this.addActiveStyle(n),currentUser.scrollToGetMail||paging.getInstance().reset(),this.isSubTree)||(toolbar.classifyButton&&(toolbar.resetState(),toolbar.classifyButton.set("label",allListboxMsg)),YAHOO.util.Dom.setStyle(document.body,"cursor","wait"),"icon-send"==n.labelStyle?(dataTable.table.hideColumn("from"),dataTable.table.showColumn("to")):(dataTable.table.hideColumn("to"),dataTable.table.showColumn("from")),FolderCache.getInstance().set(n.labelElId,"lastClickTime",(new Date).getTime()),this._model.handleLastCacheData(this.selectedNode),currentUser.scrollToGetMail&&("MAX"!=FolderCache.getInstance().get(n.labelElId,"lastIndex")||mailbox.getInstance().listMailStorage||FolderCache.getInstance().set(n.labelElId,"lastIndex",0)),this.selectedNode=n,r={node:n},t&&(r.mailId=t),i=this,window.setTimeout(function(){i.selectFolderEvent.notify(r)},300)))};TreeView.prototype.initCalendar=function(){var n=getindexTabByLabel(calendarMsg),t;if(-1!=n&&tabView.set("activeIndex",n),-1==n){n=getindexNewTab(txtSoan);tabView.removeTab(tabView.getTab(n));t="Microsoft Internet Explorer"==navigator.appName?new Tab("calendarTab","<span id='calendarImage' style='margin-left:-45px;margin-top: 10px;'><\/span><span class = 'calendarTabLabel' style='padding-top: 10px;position: absolute;font-style:normal;margin-left:-15px;color :#6FAEEE;font-size:12px;font-family:Tahoma'>"+calendarMsg+"<\/span><span class='closeTabIE' id='closecalendartab'><img src='icon1/Closeinactive.png' class ='closeSubTabIE' id='closecalendartab' name='Calendar'>","",!0):new Tab("calendarTab",'<span id="calendarImage" style=""><\/span><span style="margin-top:5px;"><span style="position:absolute;left:20px;margin-top: 7px;color: #6FAEEE;">'+calendarMsg+'<\/span><div class="closeTab" id="closecalendartab"><img  name="Calendar" style="position:absolute;right:4px;bottom:5px;" src="icon1/Closeinactive.png"><\/span><\/div>',"",!0);t.setDataSrc("calendar/calendar.html");t.init();YAHOO.plugin.Dispatcher.delegate(t.tab,tabView);YAHOO.util.Event.on("closecalendartab","click",function(){$("#CalendarEnterpriseLeft").empty();tabView.removeTab(t.tab);tabView.set("activeIndex",0)});n=new YAHOO.widget.Tab({label:txtSoan,id:"composeMailTab"});tabView.addTab(n);$(".closeTabIE").mouseover(function(){$(this).css("background","url('css/giaodien/bgclose.png') no-repeat")});$(".closeTabIE").mouseout(function(){$(this).css("background","none")});tabManager.openComposeTab()}YAHOO.util.Dom.setStyle(document.body,"cursor","default")};TreeView.prototype.initContact=function(){document.getElementById("treeDiv").style.display="none";var n=new ContactModel,t=new ContactView(n);new ContactController(n,t).init();YAHOO.util.Dom.setStyle(document.body,"cursor","default")};TreeView.prototype.initFacebook=function(){var n=this,t="Microsoft Internet Explorer"==navigator.appName?new YAHOO.widget.Tab({label:"<span class = 'calendarTabLabel' style='padding-top: 10px;position: absolute;font-style:normal;margin-left:-15px;color :#6FAEEE;font-size:12px;font-family:Tahoma'>"+facebookMsg+"<\/span><span class='closeTabIE' id='closefacebookTab'><img src='icon1/Closeinactive.png' class ='closeSubTabIE' id='closecalendartab' name='Facebook'>",content:"",id:"facebookTab",active:!0,cacheData:!0,dataSrc:"js/facebook/dsFacebook.html"}):new YAHOO.widget.Tab({label:'<span style="position:absolute;left:20px;margin-top: 7px;color: #6FAEEE;">'+facebookMsg+'<\/span><div class="closeTab" id="closefacebookTab"><img  name="Facebook" style="position:absolute;right:4px;bottom:4px;" src="icon1/Closeinactive.png"><\/span><\/div>',content:"",id:"facebookTab",active:!0,cacheData:!0,dataSrc:"js/facebook/dsFacebook.html"});tabView._tabManager.addTab(t,1);window.setTimeout(function(){initFBvalue()},300);YAHOO.util.Event.on("closefacebookTab","click",function(){n.addActiveStyle(n.selectedNode);9>browserVersion()&&"Microsoft Internet Explorer"==navigator.appName?(tabView.removeTab(t),tabView.set("activeIndex",0)):($("#facebookTab").addClass("close"),$("#facebookNode .activeNode").removeClass("activeNode"),window.setTimeout(function(){$("#inbox").click()},10))});$(".closeTabIE").mouseover(function(){$(this).css("background","url('css/giaodien/bgclose.png') no-repeat")});$(".closeTabIE").mouseout(function(){$(this).css("background","none")})};TreeView.prototype.addActiveStyle=function(n){var t="activeNode",i;this.isSubTree&&(t="activeSubNode");$("."+t).each(function(){$(this).removeClass(t);$(this).find("b").removeAttr("style");$(this).find("a").removeAttr("style");"Microsoft Internet Explorer"==navigator.appName&&$(this).removeAttr("style")});n&&(n=this.getNodeByProperty("labelElId",n.labelElId))&&(i=n.getElId(),$("#"+i+" .htmlnodelabel").addClass(t),n.hasChildren()&&($("#"+n.getChildrenElId()+" .htmlnodelabel").removeClass(t),$("#"+n.getChildrenElId()+" .htmlnodelabel").find("b").removeAttr("style"),$("#"+n.getChildrenElId()+" .htmlnodelabel").find("a").removeAttr("style")));$("."+t).each(function(){$(this).find("b").css("color","#fff");$(this).find("a").css("color","#fff")});this.isSubTree&&(this.selectedNode=n)};TreeView.prototype.removeNode=function(n){this.tree.removeNode(n)};TreeView.prototype.postToThisFolder=function(){this.postToThisFolderEvent.notify()};TreeView.prototype.syncFolder=function(n){this.syncFolderEvent.notify({node:n})};TreeView.prototype.createNewFolder=function(n){this.createNewFolderEvent.notify({node:n})};TreeView.prototype.deleteFolder=function(n){this.deleteFolderEvent.notify({node:n})};TreeView.prototype.moveFolder=function(n){this.moveFolderEvent.notify({node:n})};TreeView.prototype.renameFolder=function(n){this.renameFolderEvent.notify({node:n})};TreeView.prototype.createPublicFolder=function(n){this.createPublicFolderEvent.notify({node:n})};TreeView.prototype.createShareFolder=function(n){this.createShareFolderEvent.notify({node:n})};TreeView.prototype.editFolder=function(n,t){this.editFolderEvent.notify({node:n,flag:t})};TreeView.prototype.markAllReadFolder=function(n){this.markAllReadFolderEvent.notify({node:n})};TreeView.prototype.emptyFolder=function(n){this.emptyFolderEvent.notify({node:n})};TreeView.prototype.manageFolders=function(){this.manageFoldersEvent.notify()};TreeView.prototype.createContextMenu=function(){var n=this,t=[];t.push([{text:"<img src='treeTable/guivaoday.png' style='margin-bottom:-2px;margin-top: 2px;margin-right:10px'>"+postFolderMsg,onclick:{fn:function(){n.postToThisFolder(n.oCurrentTextNode)}},disabled:!1},{text:"<img src='treeTable/synchonize.png' style='margin-bottom:-2px;margin-top: 2px;margin-right:10px'>"+syncFolderMsg,onclick:{fn:function(){n.syncFolder(n.oCurrentTextNode)}},disabled:!1}]);t.push([{text:"<img src='treeTable/taomoimuctin.png' style='margin-bottom:-2px;margin-top: 2px;margin-right:10px'>"+createFolderMsg,onclick:{fn:function(){n.createNewFolder(n.oCurrentTextNode)}},disabled:!1},{text:"<img src='treeTable/xoamuctin.png' style='margin-bottom:-2px;margin-top: 2px;margin-right:10px'>"+deleteFolderMsg,onclick:{fn:function(){n.deleteFolder(n.oCurrentTextNode)}},disabled:!1},{text:"<img src='menuTable/dichuyen.png' style='margin-bottom:-2px;margin-top: 2px;margin-right:10px'>"+moveFolderMsg,onclick:{fn:function(){n.moveFolder(n.oCurrentTextNode)}},disabled:!1},{text:"<img src='treeTable/doitenmuctin.png' style='margin-bottom:-2px;margin-top: 2px;margin-right:10px'>"+renameFolderMsg,onclick:{fn:function(){n.renameFolder(n.oCurrentTextNode)}},disabled:!1}]);currentUser.canCreatePublicFolder?t.push([{text:"<img src='treeTable/publicFolder.png' style='margin-bottom:-2px;margin-top: 2px;margin-right:10px'>"+publicFolderMsg,submenu:{id:"subPublicFolder_"+TreeView.TREE_ID,itemdata:[[{text:"<img src='treeTable/publicFolder.png' style='margin-bottom:-2px;margin-top: 3px;margin-right: 7px;'>"+createPublicFolderMsg,onclick:{fn:function(){n.createPublicFolder(n.oCurrentTextNode)}}}],[{text:"<img src='treeTable/chinhsuamuctin.png' style='margin-bottom:-2px;margin-top: 3px;margin-right: 7px;'>"+editPublicFolderMsg,onclick:{fn:function(){n.editFolder(n.oCurrentTextNode,"publicfolder")}}}]]},disabled:!1},{text:"<img src='treeTable/chiasemuctin.png' style='margin-bottom:-2px;margin-top: 2px;margin-right:10px'>"+shareFolderMsg,submenu:{id:"subShareFolder_"+TreeView.TREE_ID,itemdata:[[{text:"<img src='treeTable/publicFolder.png' style='margin-bottom:-2px;margin-top: 3px;margin-right: 7px;'>"+createShareFolderMsg,onclick:{fn:function(){n.createShareFolder(n.oCurrentTextNode)}}}],[{text:"<img src='treeTable/chinhsuamuctin.png' style='margin-bottom:-2px;margin-top: 3px;margin-right: 7px;'>"+editShareFolderMsg,onclick:{fn:function(){n.editFolder(n.oCurrentTextNode,"sharefolder")}}}]]},disabled:!1}]):t.push([{text:"<img src='treeTable/chiasemuctin.png' style='margin-bottom:-2px;margin-top: 2px;margin-right:10px'>"+shareFolderMsg,submenu:{id:"subShareFolder_"+TreeView.TREE_ID,itemdata:[[{text:"<img src='treeTable/publicFolder.png' style='margin-bottom:-2px;margin-top: 3px;margin-right: 7px;'>"+createShareFolderMsg,onclick:{fn:function(){n.createShareFolder(n.oCurrentTextNode)}}}],[{text:"<img src='treeTable/chinhsuamuctin.png' style='margin-bottom:-2px;margin-top: 3px;margin-right: 7px;'>"+editShareFolderMsg,onclick:{fn:function(){n.editFolder(n.oCurrentTextNode,"sharefolder")}}}]]},disabled:!1}]);t.push([{text:"<img src='treeTable/tatcadadoc.png' style='margin-bottom:-2px;margin-top: 2px;margin-right:10px'>"+markAllReadMsg,onclick:{fn:function(){n.markAllReadFolder(n.oCurrentTextNode)}},disabled:!1},{text:"<img src='treeTable/xoa.png' style='margin-bottom:-2px;margin-top: 2px;margin-right:10px'>"+emptyFolderMsg,onclick:{fn:function(){n.emptyFolder(n.oCurrentTextNode)}},disabled:!1}],[{text:"<img src='treeTable/quanlymuctin.png' style='margin-bottom:-2px;margin-top: 2px;margin-right:10px'>"+managmentFolderMsg,onclick:{fn:function(){n.manageFolders(n.oCurrentTextNode)}},disabled:!1}]);share.INDEX++;this.oContextMenu=new YAHOO.widget.ContextMenu(TreeView.CONTEXT_MENU_ID+share.INDEX,{trigger:TreeView.TREE_ID,width:"230px",lazyload:!0,itemdata:t});this.oContextMenu.show();this.oContextMenu.hide();"tool"==mailbox.getInstance().client&&this.oContextMenu.subscribe("click",function(t,i){(t=i[1])&&3==t.groupIndex&&2==t.index&&(t=n.oCurrentTextNode.labelElId,-1!=n.oContextMenu.getItem(2,3).cfg.getProperty("text").indexOf("Bỏ theo dõi mục tin")?(console.log("Bỏ theo dõi mục tin"),Tool.getInstance().setFolderNotify(t,"1")):(console.log("theo dõi mục tin"),Tool.getInstance().setFolderNotify(t,"0")))});$("#subShareFolder_"+n.id).addClass("subShareFolder");this.oContextMenu.subscribe("triggerContextMenu",function(){mailbox.getInstance().disableOutline();n.oCurrentTextNode=n.getNodeByElement(this.contextEventTarget);n.oCurrentTextNode||this.cancel();"serviceNode"!=n.oCurrentTextNode.labelElId&&"contactNode"!=n.oCurrentTextNode.labelElId&&"calendarNode"!=n.oCurrentTextNode.labelElId||this.cancel()});this.oContextMenu.subscribe("show",function(){n.contextMenuClick=!0;window.setTimeout(function(){n.handleSelectFolder(n.oCurrentTextNode)},50)});YAHOO.util.Event.on(document,"click",function(t){t=YAHOO.util.Event.getTarget(t);var i=n.oContextMenu.element;t==i||YAHOO.util.Dom.isAncestor(i,t)||n.oContextMenu.hide()});$(window).bind("blur",function(){n.oContextMenu.hide()});this.oContextMenu.subscribe("beforeShow",function(){var i="317px",i=currentUser.canCreatePublicFolder?"317px":"293px",t=n.oCurrentTextNode.labelElId,r;if("tool"==mailbox.getInstance().client&&(n.oContextMenu.getItem(2,3)&&n.oContextMenu.removeItem(2,3),r=getLocation(n.oCurrentTextNode),(-1==in_array(r,Tool.getInstance().notifyFolder)||1==currentUser.lanhdao)&&(console.log("Tool.getInstance().getFolderNotify(folderId): "+Tool.getInstance().getFolderNotify(t)),Tool.getInstance().getFolderNotify(t)?n.oContextMenu.addItem({text:"<img src='menuTable/NotifyFolder.ico' style='margin-bottom:-2px;margin-top: 2px;margin-right:7px;height:16px;height:16px;'> Theo dõi mục tin"},3):n.oContextMenu.addItem({text:"<img src='menuTable/NotifyFolder.ico' style='margin-bottom:-2px;margin-top: 2px;margin-right:7px;height:16px;height:16px;'> Bỏ theo dõi mục tin"},3),i=1==currentUser.canCreatePublicFolder?"342px":"318px")),n.oContextMenu.cfg.setProperty("height",i),$(".menuDrop,.bong,.menuDropChild").css("display","none"),n.addActiveStyle(n.oCurrentTextNode),n.oCurrentTextNode.toggleHighlight(),i=n.getFirstParent(n.oCurrentTextNode),i||(i=n.oCurrentTextNode),"icon-gtalk"==i.labelStyle||"icon-yahoo"==i.labelStyle){for(t=0;t<this.itemData[1].length;t++)this.oContextMenu.getItem(t,1).cfg.setProperty("disabled",!0);for(t=0;t<this.itemData[2].length;t++)this.oContextMenu.getItem(t,2).cfg.setProperty("disabled",!0);for(t=0;t<this.itemData[4].length;t++)this.oContextMenu.getItem(t,4).cfg.setProperty("disabled",!0);("icon-gtalk"==n.oCurrentTextNode.labelStyle||"icon-yahoo"==n.oCurrentTextNode.labelStyle)&&(this.oContextMenu.getItem(1,1).cfg.setProperty("disabled",!1),n.addDeleteAccountItem(this.oContextMenu))}else if("icon-sharefolder"==i.labelStyle||"icon-publicfolder"==i.labelStyle){for(t=0;t<this.itemData[0].length;t++)this.oContextMenu.getItem(t,0).cfg.setProperty("disabled",!1);for(t=0;t<this.itemData[1].length;t++)this.oContextMenu.getItem(t,1).cfg.setProperty("disabled",!1);for(t=0;t<this.itemData[2].length;t++)this.oContextMenu.getItem(t,2).cfg.setProperty("disabled",!1);for(t=0;t<this.itemData[3].length;t++)this.oContextMenu.getItem(t,3).cfg.setProperty("disabled",!1);for(t=0;t<this.itemData[4].length;t++)this.oContextMenu.getItem(t,4).cfg.setProperty("disabled",!1);n.oContextMenu.getItem(0,2).cfg.setProperty("disabled",!0);n.oContextMenu.getItem(1,2).cfg.setProperty("disabled",!0);"icon-publicfolder"==i.labelStyle&&n.oContextMenu.getItem(1,1).cfg.setProperty("disabled",!0)}else if("icon-contactFolder"==n.oCurrentTextNode.labelStyle||"facebookNode"==n.oCurrentTextNode.labelElId||"serviceNode"==n.oCurrentTextNode.labelElId||"contactNode"==n.oCurrentTextNode.labelElId||"calendarNode"==n.oCurrentTextNode.labelElId)this.cancel();else if("2"==n.oCurrentTextNode.labelElId||"5"==n.oCurrentTextNode.labelElId||"6"==n.oCurrentTextNode.labelElId||"4"==n.oCurrentTextNode.labelElId||"3"==n.oCurrentTextNode.labelElId){for(t=0;t<this.itemData[1].length;t++)n.oContextMenu.getItem(t,1).cfg.setProperty("disabled",!0);for(n.oContextMenu.getItem(0,1).cfg.setProperty("disabled",!1),t=0;t<this.itemData[2].length;t++)n.oContextMenu.getItem(t,2).cfg.setProperty("disabled",!1);for("6"!=n.oCurrentTextNode.labelElId&&"4"!=n.oCurrentTextNode.labelElId&&"3"!=n.oCurrentTextNode.labelElId||n.oContextMenu.getItem(0,1).cfg.setProperty("disabled",!0),n.oContextMenu.getItem(0,3).cfg.setProperty("disabled",!1),n.oContextMenu.getItem(1,3).cfg.setProperty("disabled",!1),t=0;t<this.itemData[4].length;t++)n.oContextMenu.getItem(t,4).cfg.setProperty("disabled",!1)}else{for(Util.checkExistLinkId(n.oCurrentTextNode.labelElId,linkFolder)&&n.oContextMenu.getItem(1,1).cfg.setProperty("disabled",!0),t=0;t<this.itemData[0].length;t++)n.oContextMenu.getItem(t,0).cfg.setProperty("disabled",!1);for(t=0;t<this.itemData[1].length;t++)n.oContextMenu.getItem(t,1).cfg.setProperty("disabled",!1);for(t=0;t<this.itemData[2].length;t++)n.oContextMenu.getItem(t,2).cfg.setProperty("disabled",!1);for(t=0;t<this.itemData[2].length;t++)n.oContextMenu.getItem(t,4).cfg.setProperty("disabled",!1)}})};TreeView.prototype.redrawTreeView=function(n){this._model.folderIndex=[];this._model.oTextNodeMap=[];this.expandClick=!1;this.tree.removeChildren(this.tree.getRoot());this.draw();this.buildChildNode(this.tree.getRoot(),!0);this.draw();this._model.sync||n||(this._model.sync=!0,n={rootNode:this.getRoot()},this.folderStructureChangeEvent.notify(n))};TreeView.prototype.removeChildren=function(n){this.expandClick=!1;this.tree.removeChildren(n,!0);this.expandClick=!0};TreeView.prototype.addFolderMailExternal=function(){var t=currentUser.getMailTransport(),i=currentUser.getChatTransport(),n;0<t.length&&0==i.length&&(n=this,YAHOO.util.Get.script(["js/MailExternal/mailExternal.js.zgz"],{onFailure:function(){},onSuccess:function(){MailExternalManager.getInstance().setTree(n);MailExternalManager.getInstance().getAccountExternal(getInfoResponse);MailExternalManager.getInstance().addFolderExternal()}}))};TreeView.prototype.addDeleteAccountItem=function(n){var t,i;0<currentUser.getMailTransport().length&&(t=this,n.getItem(1,4)&&n.removeItem(1,4),n.addItem({text:"<img src='treeTable/xoamuctin.png' style='margin-bottom:-2px;margin-top: 2px;margin-right:7px;'> Xóa tài khoản liên thông",onclick:{fn:function(){t.deleteAccount(t.oCurrentTextNode)}}},4),i="",i=1==currentUser.canCreatePublicFolder?"347px":"323px",n.cfg.setProperty("height",i))};TreeView.prototype.deleteAccount=function(n){var t=n.labelStyle,i="";"icon-gtalk"==t||"icon-gmail"==t?i="gmail":"icon-yahoo"==t&&(i="yahoo");t=n.getElId();n=$("#"+t).offset().left;t=$("#"+t).offset().top;new ConfirmBox(deleteAccountMsg+i,cfDeleteAccountMsg+i,function(){MailExternalManager.getInstance().getMailExternal(i).handleDeleteAccount()},function(){},chooseButtonMsg,!1,"315px",n,t,!0)};TreeView.prototype.getRoot=function(){return this.tree.getRoot()};TreeView.prototype.getSelectedNode=function(){return this.selectedNode};TreeView.prototype.getNodeByElement=function(n){return this.tree.getNodeByElement(n)};TreeView.prototype.getFirstParent=function(n){var t=null;if(n)for(;n&&n.parent!=this.getRoot();)n=t=n.parent;return t};TreeView.prototype.getNodeByProperty=function(n,t){return this.tree.getNodeByProperty(n,t)};TreeView.prototype.draw=function(){this.tree.draw();this.addActiveStyle(this.getSelectedNode())};
//# sourceMappingURL=TreeFolder.min.js.map
