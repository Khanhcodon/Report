define([],function(){"use strict";return Backbone.View.extend({events:{"change #ddlSuppType":"changeType","change #IsUnsuccess":"_insertUnsussessMessage","blur .added":"changeType","input input.paper-name":"_addPaper","input input.fee-name":"_addFee","input #suppComment":"_changeRequire","click .removeRequired":"_removeCurrentRequired","click .doctypeManager":"_openDoctypePaperAndFeeManager"},initialize:function(n){return this.document=n.document,this.success=n.callback,this.hasShowPrintPreview=!0,this.open(n.suppItem,this.success,n.message),this},open:function(n,t,i){var r=this,u,f;r.message=i;r.id=n==undefined?0:n.model.get("SupplementaryId");r.id|=0;r.suppItem=n;r.isReceived=n?n.model.get("UserReceivedId")>0:!1;r.suppData={};u=r.id===0?egov.request.createSupplementary:egov.request.receiveSupplementary;f=r.id===0?{docCopyId:r.document.model.get("DocumentCopyId")}:{supplementaryId:r.id};u({data:f,success:function(n){if(n.error){egov.callback(t);return}n.Supplementary==undefined&&(n.Supplementary={SupplementaryId:0,SupplementaryDetail:[],OffsetDay:1,DocumentCopyId:r.document.model.get("DocumentCopyId"),DocumentId:r.document.model.get("DocumentId")},n.Comment="");r.hasReceiveSupplementary=n.HasReceiveSupplementary;var i=r.isReceived?egov.template.supplementary.receivedSupplementary:egov.template.supplementary.receiveSupplement;require([i],function(t){r.template=t;r.model=new egov.models.supplementaryList(n.Supplementary==undefined?[]:n.Supplementary.SupplementaryDetail);r.suppData=n;r.render()})}})},render:function(){var n=this,i={},t=n.suppData;i.width=800;i.title=egov.resources.document.supplementary.title;i.draggable=!0;i.keyboard=!0;i.buttons=[{text:egov.resources.document.supplementary.cancelReveiced,className:"btn-warning "+(n.isReceived||t.Supplementary.UserReceivedId!=egov.userId?"hidden":""),click:function(){n.cancelReceived()}},{text:egov.resources.document.supplementary.updateAndPrintButton,className:"btn-primary "+(n.message||n.isReceived||!t.PrintTemplates||t.PrintTemplates.length==0||!t.HasReceiveSupplementary?"hidden":""),click:function(){n.sendAndPrint()}},{text:egov.resources.document.supplementary.print,className:"btn-primary "+(!n.isReceived||n.message||!t.PrintTemplates||t.PrintTemplates.length==0?"hidden":""),click:function(){n.print()}},{text:egov.resources.common.updateButton,className:"btn-primary "+(n.isReceived?"hidden":""),click:function(){if(n.hasReceiveSupplementary){n.send(n.success);return}n.sendRequire(n.success)}},{text:egov.resources.common.closeButton,click:function(){n.$el.dialog("hide")}}];n.message||!t.PrintTemplates||t.PrintTemplates.length==0||(i.confirm={className:"pull-left",text:egov.resources.common.showPreviewPrint,checked:!0,click:function(t){n.hasShowPrintPreview=t}});t.message=n.message;t.model=n.model.toJSON();t.currentRequire=n.model.detect(function(n){return n.get("UserSendId")==egov.userId});t.currentRequire=t.currentRequire==undefined?undefined:t.currentRequire.toJSON();n.currentRequire=t.currentRequire;n.$el.empty();t.Comment===undefined&&(t.Comment="");n.$el.html($.tmpl(n.template,t));n.$el.bindResources();n.$el.dialog(i);n.$("#ddlSuppType option[value='"+t.Supplementary.SupplementType+"']").attr("selected","selected");n.changeType();n.$("#suppComment").focus();n.$newPaper=n.$(".ul-papers>li:last-child").clone(!0);n.$newFee=n.$(".ul-fees>li:last-child").clone(!0)},changeType:function(){var t=this,n=this.$("#ddlSuppType").val();n==egov.enum.supplementaryType.add?this.$(".offset-day").show():this.$(".offset-day").hide()},_insertUnsussessMessage:function(n){var t=$(n.target).closest("#IsUnsuccess");t.is(":checked")&&this.$("#suppComment").val()===""&&this.$("#suppComment").val(egov.resources.document.supplementary.noAdditional)},serialize:function(){var t={},n=this,i=0,r=[],u=[];return n.$(".comment-validate").hide(),i=n.$("#currentDetailId").val(),t.comment=n.$("#suppComment").val(),t.detailId=i,t.supplementType=n.$("#ddlSuppType").val(),t.offsetDay=n.$(".added").val(),t.isSuccess=!n.$("#IsUnsuccess").is(":checked"),n.$(".ul-papers > li").each(function(){var i=$(this).find(":checked"),t=$(this).find(".paper-name").is("input")?$(this).find(".paper-name").val():$(this).find(".paper-name").text();i.length>0&&t!==""&&r.push({DocPaperId:$(this).find(".paper-id").val(),PaperName:t,Amount:$(this).find(".paper-amount").val(),Type:egov.enum.feeType.ThuongBosung,IsRequired:!0,DocumentId:n.$("[name='DocumentId']").val()})}),n.$(".ul-fees > li").each(function(){var i=$(this).find(":checked"),t=$(this).find(".fee-name").is("input")?$(this).find(".fee-name").val():$(this).find(".fee-name").text();i.length>0&&t!==""&&$(this).find(".fee-price").val()!=="0"&&u.push({DocFeeId:$(this).find(".fee-id").val(),FeeName:t,Price:$(this).find(".fee-price").val(),Type:egov.enum.paperType.ThuongBosung,IsRequired:!0,DocumentId:n.$("[name='DocumentId']").val()})}),t.papers=JSON.stringify(r),t.fees=JSON.stringify(u),t},send:function(n){var t=this,i=t.serialize();i.suppId=this.id;egov.request.supplementaryReceive({data:i,beforeSend:function(){egov.pubsub.publish(egov.events.status.processing,egov.resources.common.updating)},success:function(i){if(i.error){egov.pubsub.publish(egov.events.status.error,i.error);return}t.suppItem.model.set("UserReceivedId",i.supplementary.UserReceivedId);t.document.changeDateAppointed(i.supplementary.NewDateAppointed);egov.pubsub.publish(egov.events.status.destroy);egov.callback(n)},complete:function(){egov.pubsub.publish(egov.events.status.destroy);t.$el.dialog("hide")}})},sendRequire:function(){var n=this,t=n.serialize();t.supplementaryId=this.id;t.docCopyId=this.document.model.get("DocumentCopyId");egov.request.sendRequiredSupplementary({data:t,beforeSend:function(){egov.pubsub.publish(egov.events.status.processing,egov.resources.common.updating)},success:function(i){if(i.error){egov.pubsub.publish(egov.events.status.error,i.error);return}if(egov.pubsub.publish(egov.events.status.destroy),i.isRemoved){n.document.removeCurrentRequiredSupplementary(n.suppItem);return}i.supplementary&&t.supplementaryId===0&&n.document.insertReceiveSupplementary(i.supplementary)},complete:function(){egov.pubsub.publish(egov.events.status.destroy);n.$el.dialog("hide")}})},cancelReceived:function(){var n=this;egov.request.cancelReceiveSupplementary({data:{suppId:this.id},beforeSend:function(){egov.pubsub.publish(egov.events.status.processing,egov.resources.common.updating)},success:function(t){if(t.error){egov.pubsub.error(egov.events.status.error,t.error);return}n.suppItem.model.set("UserReceivedId",t.supplementary.UserReceivedId);n.document.changeDateAppointed(t.supplementary.OldDateAppointed)},complete:function(){egov.pubsub.publish(egov.events.status.destroy);n.$el.dialog("hide")}})},sendAndPrint:function(){var n=this,t=function(){n.print()};n.send(t)},print:function(){var n=this,t=n.$("#ddlTemplate").val(),i=n.document.model.get("DocumentCopyId");require(["print"],function(r){var r=new r({docCopyId:[i],docId:n.model.get("DocumentId"),suppId:n.id,printId:t,displayPreview:n.hasShowPrintPreview});r.open(t)});n.$el.dialog("hide")},_addPaper:function(n){var t=this.$(n.target),i=t.parent("li");if(i.is(":last-child")){this.$(".ul-papers").append(this.$newPaper.clone(!0));return}t.val()||i.siblings(":last-child").remove()},_addFee:function(n){var t=this.$(n.target),i=t.parent("li");if(i.is(":last-child")){this.$(".ul-fees").append(this.$newFee.clone(!0));return}t.val()||i.siblings(":last-child").remove()},_changeRequire:function(n){var t=this.$(n.target).closest("#suppComment"),i=t.next("input:hidden").val();i!=undefined&&this.$(".comment-"+i).text(t.val())},_removeCurrentRequired:function(){this.$("#suppComment").empty()},_openDoctypePaperAndFeeManager:function(){var t=this.document.model.get("DocTypeId"),i=this.document.model.get("DocTypeName"),r=2,n=this,u=function(t){var i=t.papers,r=t.fees;n.suppData.Papers=JSON.parse(i);n.suppData.Fee=JSON.parse(r);n.suppData.Comment=n.$("#suppComment").val();n.render()};require(["doctypePaperFee"],function(n){var f=new n({doctypeId:t,doctypeName:i,type:r,callback:u})})}})});